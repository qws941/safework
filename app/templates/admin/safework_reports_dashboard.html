{% extends "layout.html" %}

{% block title %}SafeWork 보고서 생성 - SafeWork{% endblock %}

{% block head %}
<style>
.reports-dashboard {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    min-height: 100vh;
    padding-top: 20px;
}

.report-card {
    background: #fff;
    border-radius: 15px;
    box-shadow: 0 10px 30px rgba(0,0,0,0.1);
    padding: 30px;
    margin-bottom: 25px;
    transition: all 0.3s ease;
    border: none;
}

.report-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 20px 40px rgba(0,0,0,0.15);
}

.report-header {
    display: flex;
    align-items: center;
    margin-bottom: 20px;
}

.report-icon {
    width: 60px;
    height: 60px;
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 24px;
    color: white;
    margin-right: 20px;
}

.report-icon.health-check {
    background: linear-gradient(135deg, #667eea, #764ba2);
}

.report-icon.medication {
    background: linear-gradient(135deg, #28a745, #20c997);
}

.report-icon.worker {
    background: linear-gradient(135deg, #ffc107, #fd7e14);
}

.report-icon.comprehensive {
    background: linear-gradient(135deg, #dc3545, #e83e8c);
}

.report-title {
    flex: 1;
}

.report-title h4 {
    color: #2c3e50;
    font-weight: 600;
    margin-bottom: 5px;
}

.report-title p {
    color: #6c757d;
    margin: 0;
    font-size: 14px;
}

.report-options {
    background: #f8f9fa;
    padding: 20px;
    border-radius: 10px;
    margin-bottom: 20px;
}

.btn-generate {
    background: linear-gradient(135deg, #667eea, #764ba2);
    border: none;
    border-radius: 8px;
    padding: 12px 24px;
    color: white;
    font-weight: 600;
    transition: all 0.3s ease;
    width: 100%;
}

.btn-generate:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 20px rgba(0,0,0,0.2);
    color: white;
}

.btn-download {
    background: linear-gradient(135deg, #28a745, #20c997);
    border: none;
    border-radius: 8px;
    padding: 8px 16px;
    color: white;
    font-weight: 500;
    text-decoration: none;
    margin-left: 10px;
    transition: all 0.3s ease;
}

.btn-download:hover {
    transform: translateY(-1px);
    color: white;
    text-decoration: none;
}

.page-header {
    text-align: center;
    margin-bottom: 40px;
    color: white;
}

.page-header h1 {
    font-size: 2.5rem;
    font-weight: 700;
    margin-bottom: 10px;
    color: white;
}

.page-header p {
    font-size: 1.1rem;
    opacity: 0.9;
}

.loading-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.5);
    display: none;
    justify-content: center;
    align-items: center;
    z-index: 9999;
}

.loading-content {
    background: white;
    padding: 40px;
    border-radius: 15px;
    text-align: center;
    box-shadow: 0 20px 60px rgba(0,0,0,0.3);
}

.spinner-border-lg {
    width: 4rem;
    height: 4rem;
}

.worker-search {
    margin-bottom: 15px;
}

.worker-suggestions {
    background: white;
    border: 1px solid #ddd;
    border-radius: 8px;
    max-height: 200px;
    overflow-y: auto;
    display: none;
    position: absolute;
    width: 100%;
    z-index: 1000;
}

.worker-suggestion {
    padding: 10px;
    cursor: pointer;
    border-bottom: 1px solid #eee;
}

.worker-suggestion:hover {
    background: #f8f9fa;
}

.recent-reports {
    background: white;
    border-radius: 15px;
    padding: 25px;
    margin-top: 30px;
}

.alert {
    border-radius: 10px;
    border: none;
    padding: 15px 20px;
}
</style>
{% endblock %}

{% block content %}
<div class="reports-dashboard">
    <div class="container">
        <!-- 페이지 헤더 -->
        <div class="page-header">
            <h1><i class="bi bi-file-earmark-bar-graph"></i> SafeWork 보고서 생성</h1>
            <p>안전보건관리 시스템의 종합적인 보고서를 생성하고 다운로드할 수 있습니다</p>
        </div>

        <!-- 알림 메시지 -->
        <div id="alert-container"></div>

        <div class="row">
            <!-- 건강검진 현황 보고서 -->
            <div class="col-lg-6">
                <div class="report-card">
                    <div class="report-header">
                        <div class="report-icon health-check">
                            <i class="bi bi-clipboard-pulse"></i>
                        </div>
                        <div class="report-title">
                            <h4>건강검진 현황 보고서</h4>
                            <p>연도별 건강검진 실시 현황, 부서별 통계, 판정 결과 분석</p>
                        </div>
                    </div>
                    
                    <div class="report-options">
                        <div class="row">
                            <div class="col-md-6">
                                <label for="health_check_year">보고서 연도</label>
                                <select id="health_check_year" class="form-control">
                                    <option value="2024">2024년</option>
                                    <option value="2023">2023년</option>
                                    <option value="2022">2022년</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label for="health_check_format">출력 형식</label>
                                <select id="health_check_format" class="form-control">
                                    <option value="json">JSON (미리보기)</option>
                                    <option value="excel">Excel 다운로드</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <button class="btn btn-generate" onclick="generateHealthCheckReport()">
                        <i class="bi bi-file-earmark-medical"></i> 건강검진 보고서 생성
                    </button>
                </div>
            </div>

            <!-- 의약품 재고 현황 보고서 -->
            <div class="col-lg-6">
                <div class="report-card">
                    <div class="report-header">
                        <div class="report-icon medication">
                            <i class="bi bi-capsule"></i>
                        </div>
                        <div class="report-title">
                            <h4>의약품 재고 현황 보고서</h4>
                            <p>의약품 재고 현황, 만료 예정 품목, 재고 부족 알림</p>
                        </div>
                    </div>
                    
                    <div class="report-options">
                        <div class="row">
                            <div class="col-md-6">
                                <label for="medication_format">출력 형식</label>
                                <select id="medication_format" class="form-control">
                                    <option value="json">JSON (미리보기)</option>
                                    <option value="excel">Excel 다운로드</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label>포함 내용</label>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="include_expired" checked>
                                    <label class="form-check-label" for="include_expired">만료 품목 포함</label>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <button class="btn btn-generate" onclick="generateMedicationReport()">
                        <i class="bi bi-clipboard2-data"></i> 재고 현황 보고서 생성
                    </button>
                </div>
            </div>
        </div>

        <div class="row">
            <!-- 근로자 개인 건강 프로필 -->
            <div class="col-lg-6">
                <div class="report-card">
                    <div class="report-header">
                        <div class="report-icon worker">
                            <i class="bi bi-person-lines-fill"></i>
                        </div>
                        <div class="report-title">
                            <h4>근로자 개인 건강 프로필</h4>
                            <p>개별 근로자의 건강검진 이력, 의무실 방문 기록</p>
                        </div>
                    </div>
                    
                    <div class="report-options">
                        <div class="worker-search position-relative">
                            <label for="worker_search">근로자 검색</label>
                            <input type="text" id="worker_search" class="form-control" placeholder="근로자명 또는 사번을 입력하세요">
                            <div id="worker_suggestions" class="worker-suggestions"></div>
                            <input type="hidden" id="selected_worker_id">
                        </div>
                        
                        <div id="selected_worker_info" class="alert alert-info" style="display: none;">
                            <strong>선택된 근로자:</strong> <span id="selected_worker_name"></span>
                        </div>
                    </div>
                    
                    <button class="btn btn-generate" onclick="generateWorkerProfile()" disabled id="worker_profile_btn">
                        <i class="bi bi-person-badge"></i> 개인 프로필 생성
                    </button>
                </div>
            </div>

            <!-- 종합 안전보건 보고서 -->
            <div class="col-lg-6">
                <div class="report-card">
                    <div class="report-header">
                        <div class="report-icon comprehensive">
                            <i class="bi bi-clipboard-data"></i>
                        </div>
                        <div class="report-title">
                            <h4>종합 안전보건 보고서</h4>
                            <p>모든 SafeWork 데이터를 포함한 종합 분석 보고서</p>
                        </div>
                    </div>
                    
                    <div class="report-options">
                        <div class="row">
                            <div class="col-md-6">
                                <label for="comprehensive_year">보고서 연도</label>
                                <select id="comprehensive_year" class="form-control">
                                    <option value="2024">2024년</option>
                                    <option value="2023">2023년</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label>포함할 항목</label>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="include_all" checked>
                                    <label class="form-check-label" for="include_all">모든 데이터 포함</label>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <button class="btn btn-generate" onclick="generateComprehensiveReport()" disabled>
                        <i class="bi bi-file-earmark-spreadsheet"></i> 종합 보고서 생성 (준비중)
                    </button>
                </div>
            </div>
        </div>

        <!-- 최근 생성된 보고서 -->
        <div class="recent-reports">
            <h4><i class="bi bi-clock-history"></i> 최근 생성된 보고서</h4>
            <div id="recent_reports_list">
                <p class="text-muted">아직 생성된 보고서가 없습니다.</p>
            </div>
        </div>
    </div>
</div>

<!-- 로딩 오버레이 -->
<div id="loading_overlay" class="loading-overlay">
    <div class="loading-content">
        <div class="spinner-border text-primary spinner-border-lg" role="status">
            <span class="visually-hidden">생성 중...</span>
        </div>
        <h4 class="mt-3">보고서 생성 중</h4>
        <p class="text-muted">잠시만 기다려주세요...</p>
    </div>
</div>

<!-- 보고서 미리보기 모달 -->
<div class="modal fade" id="reportPreviewModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">보고서 미리보기</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <pre id="report_preview_content" style="background: #f8f9fa; padding: 20px; border-radius: 8px; max-height: 500px; overflow-y: auto;"></pre>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">닫기</button>
            </div>
        </div>
    </div>
</div>

<script>
let workers = [];

document.addEventListener('DOMContentLoaded', function() {
    // 근로자 목록 로드
    loadWorkers();
    
    // 근로자 검색 자동완성
    const workerSearch = document.getElementById('worker_search');
    const workerSuggestions = document.getElementById('worker_suggestions');
    
    workerSearch.addEventListener('input', function() {
        const value = this.value.toLowerCase();
        if (value.length > 1) {
            const matches = workers.filter(worker => 
                worker.name.toLowerCase().includes(value) || 
                worker.employee_number.toLowerCase().includes(value)
            );
            showWorkerSuggestions(matches);
        } else {
            workerSuggestions.style.display = 'none';
        }
    });
    
    // 외부 클릭 시 자동완성 숨기기
    document.addEventListener('click', function(e) {
        if (!workerSearch.contains(e.target) && !workerSuggestions.contains(e.target)) {
            workerSuggestions.style.display = 'none';
        }
    });
});

// 근로자 목록 로드
function loadWorkers() {
    fetch('/api/safework/workers')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                workers = data.data;
            }
        })
        .catch(error => {
            console.error('Error loading workers:', error);
        });
}

// 근로자 자동완성 표시
function showWorkerSuggestions(matches) {
    const suggestions = document.getElementById('worker_suggestions');
    suggestions.innerHTML = '';
    
    if (matches.length > 0) {
        matches.slice(0, 5).forEach(worker => {
            const div = document.createElement('div');
            div.className = 'worker-suggestion';
            div.textContent = `${worker.employee_number} - ${worker.name} (${worker.department})`;
            div.addEventListener('click', function() {
                selectWorker(worker);
            });
            suggestions.appendChild(div);
        });
        suggestions.style.display = 'block';
    } else {
        suggestions.style.display = 'none';
    }
}

// 근로자 선택
function selectWorker(worker) {
    document.getElementById('worker_search').value = `${worker.employee_number} - ${worker.name}`;
    document.getElementById('selected_worker_id').value = worker.id;
    document.getElementById('selected_worker_name').textContent = `${worker.employee_number} - ${worker.name} (${worker.department})`;
    document.getElementById('selected_worker_info').style.display = 'block';
    document.getElementById('worker_profile_btn').disabled = false;
    document.getElementById('worker_suggestions').style.display = 'none';
}

// 건강검진 보고서 생성
function generateHealthCheckReport() {
    const year = document.getElementById('health_check_year').value;
    const format = document.getElementById('health_check_format').value;
    
    showLoading();
    
    fetch(`/reports/safework/health-check-summary?year=${year}&format=${format}`)
        .then(response => {
            if (format === 'excel') {
                return response.blob().then(blob => {
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `SafeWork_건강검진보고서_${year}년.xlsx`;
                    a.click();
                    window.URL.revokeObjectURL(url);
                    showAlert('건강검진 보고서가 다운로드되었습니다.', 'success');
                });
            } else {
                return response.json().then(data => {
                    if (data.success) {
                        showReportPreview(JSON.stringify(data, null, 2));
                        showAlert('건강검진 보고서가 생성되었습니다.', 'success');
                    } else {
                        showAlert('보고서 생성 중 오류가 발생했습니다: ' + data.error, 'danger');
                    }
                });
            }
        })
        .catch(error => {
            showAlert('서버 오류가 발생했습니다.', 'danger');
            console.error('Error:', error);
        })
        .finally(() => {
            hideLoading();
        });
}

// 의약품 재고 보고서 생성
function generateMedicationReport() {
    const format = document.getElementById('medication_format').value;
    
    showLoading();
    
    fetch(`/reports/safework/medication-inventory?format=${format}`)
        .then(response => {
            if (format === 'excel') {
                return response.blob().then(blob => {
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `SafeWork_의약품재고현황.xlsx`;
                    a.click();
                    window.URL.revokeObjectURL(url);
                    showAlert('의약품 재고 보고서가 다운로드되었습니다.', 'success');
                });
            } else {
                return response.json().then(data => {
                    if (data.success) {
                        showReportPreview(JSON.stringify(data, null, 2));
                        showAlert('의약품 재고 보고서가 생성되었습니다.', 'success');
                    } else {
                        showAlert('보고서 생성 중 오류가 발생했습니다: ' + data.error, 'danger');
                    }
                });
            }
        })
        .catch(error => {
            showAlert('서버 오류가 발생했습니다.', 'danger');
            console.error('Error:', error);
        })
        .finally(() => {
            hideLoading();
        });
}

// 근로자 개인 프로필 생성
function generateWorkerProfile() {
    const workerId = document.getElementById('selected_worker_id').value;
    
    if (!workerId) {
        showAlert('근로자를 선택해주세요.', 'warning');
        return;
    }
    
    showLoading();
    
    fetch(`/reports/safework/worker-health-profile/${workerId}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showReportPreview(JSON.stringify(data, null, 2));
                showAlert('근로자 건강 프로필이 생성되었습니다.', 'success');
            } else {
                showAlert('보고서 생성 중 오류가 발생했습니다: ' + data.error, 'danger');
            }
        })
        .catch(error => {
            showAlert('서버 오류가 발생했습니다.', 'danger');
            console.error('Error:', error);
        })
        .finally(() => {
            hideLoading();
        });
}

// 종합 보고서 생성 (준비중)
function generateComprehensiveReport() {
    showAlert('종합 보고서 기능은 현재 준비 중입니다.', 'info');
}

// 로딩 표시
function showLoading() {
    document.getElementById('loading_overlay').style.display = 'flex';
}

function hideLoading() {
    document.getElementById('loading_overlay').style.display = 'none';
}

// 보고서 미리보기 표시
function showReportPreview(content) {
    document.getElementById('report_preview_content').textContent = content;
    const modal = new bootstrap.Modal(document.getElementById('reportPreviewModal'));
    modal.show();
}

// 알림 메시지 표시
function showAlert(message, type) {
    const alertContainer = document.getElementById('alert-container');
    const alert = document.createElement('div');
    alert.className = `alert alert-${type} alert-dismissible fade show`;
    alert.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    alertContainer.appendChild(alert);

    // 5초 후 자동 제거
    setTimeout(() => {
        if (alert.parentNode) {
            alert.remove();
        }
    }, 5000);
}
</script>
{% endblock %}