{% extends "layout.html" %}

{% block title %}건강검진 결과 입력 - SafeWork{% endblock %}

{% block head %}
<style>
.health-check-form {
    background: #fff;
    padding: 30px;
    border-radius: 12px;
    box-shadow: 0 4px 20px rgba(0,0,0,0.1);
    margin-bottom: 30px;
}

.form-section {
    margin-bottom: 30px;
    padding: 20px;
    background: #f8f9fa;
    border-radius: 8px;
    border-left: 4px solid #007bff;
}

.section-title {
    color: #2c3e50;
    font-weight: 600;
    margin-bottom: 15px;
    display: flex;
    align-items: center;
}

.section-title i {
    margin-right: 8px;
    color: #007bff;
}

.form-row {
    display: flex;
    gap: 15px;
    margin-bottom: 15px;
}

.form-group {
    flex: 1;
}

.form-control {
    border: 2px solid #e9ecef;
    border-radius: 8px;
    padding: 12px;
    transition: all 0.3s ease;
}

.form-control:focus {
    border-color: #007bff;
    box-shadow: 0 0 0 3px rgba(0,123,255,0.1);
}

.btn-primary {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    border: none;
    border-radius: 8px;
    padding: 12px 24px;
    font-weight: 600;
    transition: all 0.3s ease;
}

.btn-primary:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 20px rgba(0,0,0,0.2);
}

.worker-info {
    background: #e3f2fd;
    padding: 15px;
    border-radius: 8px;
    margin-bottom: 20px;
}

.alert {
    border-radius: 8px;
    border: none;
    padding: 15px 20px;
}

.loading {
    display: none;
    text-align: center;
    padding: 20px;
}

.loading .spinner-border {
    width: 3rem;
    height: 3rem;
}
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- 페이지 헤더 -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2><i class="bi bi-clipboard-pulse"></i> 건강검진 결과 입력</h2>
        <a href="{{ url_for('admin.safework_health_checks') }}" class="btn btn-outline-secondary">
            <i class="bi bi-arrow-left"></i> 건강검진 관리
        </a>
    </div>

    <!-- 알림 메시지 -->
    <div id="alert-container"></div>

    <!-- 건강검진 입력 폼 -->
    <div class="health-check-form">
        <form id="healthCheckForm">
            <!-- 근로자 선택 -->
            <div class="form-section">
                <h4 class="section-title">
                    <i class="bi bi-person"></i> 검진 대상자
                </h4>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="worker_select">근로자 선택 *</label>
                        <select id="worker_select" name="worker_id" class="form-control" required>
                            <option value="">근로자를 선택하세요</option>
                        </select>
                    </div>
                </div>
                
                <div id="worker_info" class="worker-info" style="display: none;">
                    <div class="row">
                        <div class="col-md-4">
                            <strong>사번:</strong> <span id="worker_employee_number">-</span>
                        </div>
                        <div class="col-md-4">
                            <strong>부서:</strong> <span id="worker_department">-</span>
                        </div>
                        <div class="col-md-4">
                            <strong>직책:</strong> <span id="worker_position">-</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 검진 기본 정보 -->
            <div class="form-section">
                <h4 class="section-title">
                    <i class="bi bi-calendar-check"></i> 검진 정보
                </h4>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="check_date">검진일 *</label>
                        <input type="date" id="check_date" name="check_date" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label for="check_type">검진 구분 *</label>
                        <select id="check_type" name="check_type" class="form-control" required>
                            <option value="">검진 구분 선택</option>
                            <option value="일반">일반검진</option>
                            <option value="특수">특수검진</option>
                            <option value="배치전">배치전검진</option>
                            <option value="수시">수시검진</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="hospital">검진기관</label>
                        <input type="text" id="hospital" name="hospital" class="form-control" placeholder="검진기관명">
                    </div>
                </div>
            </div>

            <!-- 신체 계측 -->
            <div class="form-section">
                <h4 class="section-title">
                    <i class="bi bi-person-lines-fill"></i> 신체 계측
                </h4>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="height">신장(cm)</label>
                        <input type="number" id="height" name="height" class="form-control" step="0.1" placeholder="신장">
                    </div>
                    <div class="form-group">
                        <label for="weight">체중(kg)</label>
                        <input type="number" id="weight" name="weight" class="form-control" step="0.1" placeholder="체중">
                    </div>
                    <div class="form-group">
                        <label for="bmi">BMI</label>
                        <input type="number" id="bmi" name="bmi" class="form-control" step="0.1" placeholder="BMI (자동계산)" readonly>
                    </div>
                </div>
            </div>

            <!-- 혈압 및 맥박 -->
            <div class="form-section">
                <h4 class="section-title">
                    <i class="bi bi-heart-pulse"></i> 혈압 및 맥박
                </h4>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="blood_pressure">혈압</label>
                        <input type="text" id="blood_pressure" name="blood_pressure" class="form-control" placeholder="예: 120/80">
                    </div>
                    <div class="form-group">
                        <label for="pulse_rate">맥박(회/분)</label>
                        <input type="number" id="pulse_rate" name="pulse_rate" class="form-control" placeholder="맥박수">
                    </div>
                </div>
            </div>

            <!-- 시력 및 청력 -->
            <div class="form-section">
                <h4 class="section-title">
                    <i class="bi bi-eye"></i> 시력 및 청력
                </h4>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="vision_left">좌안 시력</label>
                        <input type="text" id="vision_left" name="vision_left" class="form-control" placeholder="예: 1.0">
                    </div>
                    <div class="form-group">
                        <label for="vision_right">우안 시력</label>
                        <input type="text" id="vision_right" name="vision_right" class="form-control" placeholder="예: 1.0">
                    </div>
                    <div class="form-group">
                        <label for="hearing_left">좌측 청력</label>
                        <select id="hearing_left" name="hearing_left" class="form-control">
                            <option value="">선택</option>
                            <option value="정상">정상</option>
                            <option value="이상">이상</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="hearing_right">우측 청력</label>
                        <select id="hearing_right" name="hearing_right" class="form-control">
                            <option value="">선택</option>
                            <option value="정상">정상</option>
                            <option value="이상">이상</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- 검사 결과 -->
            <div class="form-section">
                <h4 class="section-title">
                    <i class="bi bi-clipboard-data"></i> 검사 결과
                </h4>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="blood_sugar">혈당</label>
                        <input type="text" id="blood_sugar" name="blood_sugar" class="form-control" placeholder="혈당 수치">
                    </div>
                    <div class="form-group">
                        <label for="cholesterol">콜레스테롤</label>
                        <input type="text" id="cholesterol" name="cholesterol" class="form-control" placeholder="콜레스테롤 수치">
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="chest_xray">흉부 X선</label>
                        <input type="text" id="chest_xray" name="chest_xray" class="form-control" placeholder="흉부 X선 결과">
                    </div>
                </div>
            </div>

            <!-- 판정 및 소견 -->
            <div class="form-section">
                <h4 class="section-title">
                    <i class="bi bi-clipboard-check"></i> 판정 및 소견
                </h4>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="result">종합 판정 *</label>
                        <select id="result" name="result" class="form-control" required>
                            <option value="">판정 선택</option>
                            <option value="정상">정상 (A)</option>
                            <option value="관찰필요">관찰필요 (B)</option>
                            <option value="치료필요">치료필요 (C)</option>
                            <option value="요정밀검사">요정밀검사 (D)</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="next_check_date">차회 검진일</label>
                        <input type="date" id="next_check_date" name="next_check_date" class="form-control">
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="findings">검진 소견</label>
                        <textarea id="findings" name="findings" class="form-control" rows="3" placeholder="검진 소견을 입력하세요"></textarea>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="recommendations">의사 권고사항</label>
                        <textarea id="recommendations" name="recommendations" class="form-control" rows="3" placeholder="의사 권고사항을 입력하세요"></textarea>
                    </div>
                </div>
            </div>

            <!-- 제출 버튼 -->
            <div class="text-center">
                <button type="button" id="resetBtn" class="btn btn-secondary me-3">
                    <i class="bi bi-arrow-clockwise"></i> 초기화
                </button>
                <button type="submit" class="btn btn-primary">
                    <i class="bi bi-check-circle"></i> 건강검진 결과 저장
                </button>
            </div>
        </form>
    </div>

    <!-- 로딩 표시 -->
    <div id="loading" class="loading">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">저장 중...</span>
        </div>
        <p class="mt-3">건강검진 결과를 저장하고 있습니다...</p>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('healthCheckForm');
    const workerSelect = document.getElementById('worker_select');
    const workerInfo = document.getElementById('worker_info');
    const heightInput = document.getElementById('height');
    const weightInput = document.getElementById('weight');
    const bmiInput = document.getElementById('bmi');
    const loading = document.getElementById('loading');
    const alertContainer = document.getElementById('alert-container');

    // 근로자 목록 로드
    loadWorkers();

    // 근로자 선택 시 정보 표시
    workerSelect.addEventListener('change', function() {
        if (this.value) {
            showWorkerInfo(this.value);
        } else {
            workerInfo.style.display = 'none';
        }
    });

    // BMI 자동 계산
    function calculateBMI() {
        const height = parseFloat(heightInput.value);
        const weight = parseFloat(weightInput.value);
        
        if (height && weight && height > 0) {
            const bmi = weight / Math.pow(height / 100, 2);
            bmiInput.value = bmi.toFixed(1);
        } else {
            bmiInput.value = '';
        }
    }

    heightInput.addEventListener('input', calculateBMI);
    weightInput.addEventListener('input', calculateBMI);

    // 폼 제출 처리
    form.addEventListener('submit', function(e) {
        e.preventDefault();
        submitHealthCheck();
    });

    // 초기화 버튼
    document.getElementById('resetBtn').addEventListener('click', function() {
        if (confirm('입력한 내용이 모두 초기화됩니다. 계속하시겠습니까?')) {
            form.reset();
            workerInfo.style.display = 'none';
        }
    });

    // 근로자 목록 로드 함수
    function loadWorkers() {
        fetch('/api/safework/workers')
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const option = document.createElement('option');
                    option.value = '';
                    option.textContent = '근로자를 선택하세요';
                    workerSelect.appendChild(option);

                    data.data.forEach(worker => {
                        const option = document.createElement('option');
                        option.value = worker.id;
                        option.textContent = `${worker.employee_number} - ${worker.name} (${worker.department})`;
                        option.dataset.worker = JSON.stringify(worker);
                        workerSelect.appendChild(option);
                    });
                }
            })
            .catch(error => {
                showAlert('근로자 목록을 불러올 수 없습니다.', 'danger');
                console.error('Error:', error);
            });
    }

    // 근로자 정보 표시
    function showWorkerInfo(workerId) {
        const selectedOption = workerSelect.querySelector(`option[value="${workerId}"]`);
        if (selectedOption && selectedOption.dataset.worker) {
            const worker = JSON.parse(selectedOption.dataset.worker);
            document.getElementById('worker_employee_number').textContent = worker.employee_number;
            document.getElementById('worker_department').textContent = worker.department || '-';
            document.getElementById('worker_position').textContent = worker.position || '-';
            workerInfo.style.display = 'block';
        }
    }

    // 건강검진 결과 제출
    function submitHealthCheck() {
        const formData = new FormData(form);
        const data = Object.fromEntries(formData.entries());

        loading.style.display = 'block';
        form.style.display = 'none';

        fetch('/api/safework/health-checks', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(data)
        })
        .then(response => response.json())
        .then(result => {
            loading.style.display = 'none';
            form.style.display = 'block';

            if (result.success) {
                showAlert('건강검진 결과가 성공적으로 저장되었습니다.', 'success');
                form.reset();
                workerInfo.style.display = 'none';
            } else {
                showAlert('오류가 발생했습니다: ' + result.error, 'danger');
            }
        })
        .catch(error => {
            loading.style.display = 'none';
            form.style.display = 'block';
            showAlert('서버 오류가 발생했습니다. 다시 시도해주세요.', 'danger');
            console.error('Error:', error);
        });
    }

    // 알림 메시지 표시
    function showAlert(message, type) {
        const alert = document.createElement('div');
        alert.className = `alert alert-${type} alert-dismissible fade show`;
        alert.innerHTML = `
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        alertContainer.appendChild(alert);

        // 5초 후 자동 제거
        setTimeout(() => {
            if (alert.parentNode) {
                alert.remove();
            }
        }, 5000);
    }
});
</script>
{% endblock %}