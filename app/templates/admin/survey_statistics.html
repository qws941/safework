{% extends "base.html" %}

{% block title %}설문조사 통계 분석 - {{ app_name }}{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="mb-4">
        <a href="{{ url_for('admin.survey') }}" class="btn btn-secondary">
            <i class="bi bi-arrow-left"></i> 목록으로
        </a>
    </div>

    <h2 class="mb-4">
        <i class="bi bi-bar-chart"></i> 근골격계 증상조사표 분석 결과
        <small class="text-muted">(엑셀 분석 프로그램과 동일)</small>
    </h2>

    <!-- 1. 전체 현황 카드 -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card bg-primary text-white">
                <div class="card-body">
                    <h5 class="card-title">전체 응답자</h5>
                    <h2>{{ total_surveys }}명</h2>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-warning text-white">
                <div class="card-body">
                    <h5 class="card-title">근골격계 설문</h5>
                    <h2>{{ musculo_surveys }}명</h2>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-info text-white">
                <div class="card-body">
                    <h5 class="card-title">신규입사자 설문</h5>
                    <h2>{{ newbie_surveys }}명</h2>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-danger text-white">
                <div class="card-body">
                    <h5 class="card-title">관리대상자</h5>
                    <h2>{{ dept_stats.values()|sum(attribute='관리대상자') }}명</h2>
                </div>
            </div>
        </div>
    </div>

    <!-- 2. 부서별 통계 분석 (엑셀과 동일한 형태) -->
    <div class="card mb-4">
        <div class="card-header bg-success text-white">
            <h5 class="mb-0">📊 부서별 자가증상 분석 결과</h5>
            <small>※ 엑셀 「근골격계부담작업 유해요인조사 지침」 양식과 동일한 분석</small>
        </div>
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-bordered table-hover mb-0" style="font-size: 0.9rem;">
                    <thead class="table-success">
                        <tr>
                            <th rowspan="2" class="text-center align-middle">부서</th>
                            <th colspan="2" class="text-center">연령 분포</th>
                            <th colspan="2" class="text-center">성별 분포</th>
                            <th colspan="2" class="text-center">근골격계 증상</th>
                        </tr>
                        <tr>
                            <th class="text-center">응답자(명)</th>
                            <th class="text-center">평균(세)</th>
                            <th class="text-center">남성</th>
                            <th class="text-center">여성</th>
                            <th class="text-center">통증호소자</th>
                            <th class="text-center bg-warning">관리대상자</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for dept, stats in dept_stats.items() %}
                        <tr>
                            <td class="fw-bold">{{ dept }}</td>
                            <td class="text-center">{{ stats['응답자수'] }}</td>
                            <td class="text-center">{{ stats['평균나이'] if stats['평균나이'] > 0 else '-' }}</td>
                            <td class="text-center">{{ stats['남성'] }}</td>
                            <td class="text-center">{{ stats['여성'] }}</td>
                            <td class="text-center">
                                <span class="{% if stats['통증호소자'] > 0 %}text-warning fw-bold{% endif %}">
                                    {{ stats['통증호소자'] }}
                                </span>
                            </td>
                            <td class="text-center bg-warning-subtle">
                                <span class="{% if stats['관리대상자'] > 0 %}text-danger fw-bold{% endif %}">
                                    {{ stats['관리대상자'] }}
                                </span>
                            </td>
                        </tr>
                        {% endfor %}
                        <!-- 전체 합계 행 -->
                        <tr class="table-secondary fw-bold">
                            <td>전체 합계</td>
                            <td class="text-center">{{ total_surveys }}</td>
                            <td class="text-center">
                                {% set total_age = namespace(value=0, count=0) %}
                                {% for dept, stats in dept_stats.items() %}
                                    {% if stats['평균나이'] > 0 %}
                                        {% set total_age.value = total_age.value + (stats['평균나이'] * stats['응답자수']) %}
                                        {% set total_age.count = total_age.count + stats['응답자수'] %}
                                    {% endif %}
                                {% endfor %}
                                {{ (total_age.value / total_age.count)|round(1) if total_age.count > 0 else '-' }}
                            </td>
                            <td class="text-center">{{ dept_stats.values()|sum(attribute='남성') }}</td>
                            <td class="text-center">{{ dept_stats.values()|sum(attribute='여성') }}</td>
                            <td class="text-center text-warning">{{ dept_stats.values()|sum(attribute='통증호소자') }}</td>
                            <td class="text-center bg-warning text-danger">{{ dept_stats.values()|sum(attribute='관리대상자') }}</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- 3. 신체부위별 근골격계 통증호소자 분포 -->
    <div class="card mb-4">
        <div class="card-header bg-danger text-white">
            <h5 class="mb-0">🏥 신체부위별 근골격계 통증호소자 분포</h5>
            <small>※ 관리대상자 판정기준: 엑셀 분석프로그램과 동일</small>
        </div>
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-bordered table-hover mb-0" style="font-size: 0.85rem;">
                    <thead class="table-danger">
                        <tr>
                            <th class="text-center align-middle">신체부위</th>
                            <th class="text-center">통증호소자</th>
                            <th class="text-center">약한 통증</th>
                            <th class="text-center">중간 통증</th>
                            <th class="text-center">심한 통증</th>
                            <th class="text-center">매우 심한 통증</th>
                            <th class="text-center bg-warning">관리대상자</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for part, stats in body_part_stats.items() %}
                        <tr>
                            <td class="fw-bold">{{ part }}</td>
                            <td class="text-center">{{ stats['통증호소자'] }}</td>
                            <td class="text-center text-success">{{ stats['약한통증'] }}</td>
                            <td class="text-center text-warning">{{ stats['중간통증'] }}</td>
                            <td class="text-center text-danger">{{ stats['심한통증'] }}</td>
                            <td class="text-center text-danger fw-bold">{{ stats['매우심한통증'] }}</td>
                            <td class="text-center bg-warning-subtle">
                                <span class="{% if stats['관리대상자'] > 0 %}text-danger fw-bold{% endif %}">
                                    {{ stats['관리대상자'] }}
                                </span>
                            </td>
                        </tr>
                        {% endfor %}
                        <!-- 전체 합계 -->
                        <tr class="table-secondary fw-bold">
                            <td>전체 합계</td>
                            <td class="text-center">{{ body_part_stats.values()|sum(attribute='통증호소자') }}</td>
                            <td class="text-center text-success">{{ body_part_stats.values()|sum(attribute='약한통증') }}</td>
                            <td class="text-center text-warning">{{ body_part_stats.values()|sum(attribute='중간통증') }}</td>
                            <td class="text-center text-danger">{{ body_part_stats.values()|sum(attribute='심한통증') }}</td>
                            <td class="text-center text-danger">{{ body_part_stats.values()|sum(attribute='매우심한통증') }}</td>
                            <td class="text-center bg-warning text-danger">{{ body_part_stats.values()|sum(attribute='관리대상자') }}</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- 4. 작업의 육체적 부담 정도 분포 -->
    <div class="card mb-4">
        <div class="card-header bg-info text-white">
            <h5 class="mb-0">💪 작업의 육체적 부담 정도 분포</h5>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-8">
                    <div class="table-responsive">
                        <table class="table table-bordered">
                            <thead class="table-info">
                                <tr>
                                    <th class="text-center">부담 정도</th>
                                    <th class="text-center">응답자 수</th>
                                    <th class="text-center">비율(%)</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% set total_workload = workload_stats.values()|sum %}
                                {% for level, count in workload_stats.items() %}
                                <tr>
                                    <td>{{ level }}</td>
                                    <td class="text-center">{{ count }}</td>
                                    <td class="text-center">
                                        {{ ((count / total_workload * 100)|round(1) if total_workload > 0 else 0) }}%
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="alert alert-info">
                        <h6><i class="bi bi-info-circle"></i> 분석 기준</h6>
                        <ul class="mb-0 small">
                            <li><strong>관리대상자 판정:</strong></li>
                            <li>• 1주일 이상 지속 OR (1달 1회 이상 + 중간통증)</li>
                            <li>• 1주일 이상 지속 AND 1달 1회 이상 AND 심한통증</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 5. 통계 요약 정보 -->
    <div class="card">
        <div class="card-header bg-secondary text-white">
            <h5 class="mb-0">📋 분석 결과 요약</h5>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-6">
                    <h6><i class="bi bi-people"></i> 조사 개요</h6>
                    <ul class="list-unstyled">
                        <li>• 총 응답자: <strong>{{ total_surveys }}명</strong></li>
                        <li>• 근골격계 설문: <strong>{{ musculo_surveys }}명</strong></li>
                        <li>• 신규입사자 설문: <strong>{{ newbie_surveys }}명</strong></li>
                        <li>• 부서 수: <strong>{{ dept_stats|length }}개</strong></li>
                    </ul>
                </div>
                <div class="col-md-6">
                    <h6><i class="bi bi-exclamation-triangle"></i> 주요 발견사항</h6>
                    <ul class="list-unstyled">
                        <li>• 통증호소자: <strong class="text-warning">{{ dept_stats.values()|sum(attribute='통증호소자') }}명</strong></li>
                        <li>• 관리대상자: <strong class="text-danger">{{ dept_stats.values()|sum(attribute='관리대상자') }}명</strong></li>
                        <li>• 관리대상자 비율: <strong class="text-danger">
                            {{ ((dept_stats.values()|sum(attribute='관리대상자') / total_surveys * 100)|round(1) if total_surveys > 0 else 0) }}%
                        </strong></li>
                    </ul>
                </div>
            </div>

            <hr>
            <div class="text-center">
                <small class="text-muted">
                    ※ 본 평가 결과는 '의학적 관리'나 '법률적 판단' 등의 기준 및 근거자료로 사용되기 힘듦을 알려드립니다.<br>
                    ※ 「근골격계부담작업 유해요인조사 지침」 양식을 활용한 분석 결과입니다.
                </small>
            </div>
        </div>
    </div>

    <!-- 버튼 그룹 -->
    <div class="mt-4 text-center">
        <a href="{{ url_for('admin.survey') }}" class="btn btn-secondary">
            <i class="bi bi-arrow-left"></i> 설문 목록으로
        </a>
        <button onclick="window.print()" class="btn btn-primary">
            <i class="bi bi-printer"></i> 인쇄하기
        </button>
        <a href="#" class="btn btn-success" onclick="exportToExcel()">
            <i class="bi bi-file-excel"></i> Excel 내보내기
        </a>
    </div>
</div>

<script>
function exportToExcel() {
    // 간단한 Excel 내보내기 기능 (추후 구현 가능)
    alert('Excel 내보내기 기능은 개발 예정입니다.');
}

// 인쇄시 버튼 숨김
window.addEventListener('beforeprint', function() {
    document.querySelector('.mt-4.text-center').style.display = 'none';
});

window.addEventListener('afterprint', function() {
    document.querySelector('.mt-4.text-center').style.display = 'block';
});
</script>

<style>
/* 인쇄용 스타일 */
@media print {
    .btn, .mt-4.text-center {
        display: none !important;
    }

    .container-fluid {
        max-width: none !important;
        padding: 0 !important;
    }

    .card {
        border: 1px solid #000 !important;
        box-shadow: none !important;
    }

    .table-bordered {
        border: 1px solid #000 !important;
    }

    .table-bordered th,
    .table-bordered td {
        border: 1px solid #000 !important;
    }
}
</style>
{% endblock %}