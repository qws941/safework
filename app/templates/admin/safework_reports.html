{% extends "base.html" %}

{% block title %}보고서 관리 - SafeWork{% endblock %}

{% block content %}
<div class="container-fluid mt-3">
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="mb-0">
            <i class="bi bi-file-earmark-text"></i> 보고서 관리
        </h2>
        <div>
            <button class="btn btn-primary" onclick="generateMonthlyReport()">
                <i class="bi bi-calendar-month"></i> 월간 보고서
            </button>
            <button class="btn btn-success" onclick="generateAnnualReport()">
                <i class="bi bi-calendar"></i> 연간 보고서
            </button>
        </div>
    </div>

    <!-- 보고서 유형 선택 -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card h-100 report-card" onclick="selectReportType('health-check')">
                <div class="card-body text-center">
                    <i class="bi bi-heart-pulse display-4 text-primary"></i>
                    <h5 class="mt-3">건강검진 결과 보고서</h5>
                    <p class="text-muted">검진 결과 및 통계 분석</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card h-100 report-card" onclick="selectReportType('medical-visit')">
                <div class="card-body text-center">
                    <i class="bi bi-hospital display-4 text-info"></i>
                    <h5 class="mt-3">의무실 이용 현황</h5>
                    <p class="text-muted">방문 기록 및 처치 통계</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card h-100 report-card" onclick="selectReportType('medication')">
                <div class="card-body text-center">
                    <i class="bi bi-capsule display-4 text-warning"></i>
                    <h5 class="mt-3">의약품 사용 보고서</h5>
                    <p class="text-muted">재고 및 사용량 분석</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card h-100 report-card" onclick="selectReportType('accident')">
                <div class="card-body text-center">
                    <i class="bi bi-exclamation-triangle display-4 text-danger"></i>
                    <h5 class="mt-3">산업재해 보고서</h5>
                    <p class="text-muted">재해 발생 및 예방 현황</p>
                </div>
            </div>
        </div>
    </div>

    <!-- 보고서 설정 -->
    <div class="card mb-4" id="reportSettings" style="display: none;">
        <div class="card-header">
            <h5 class="mb-0">보고서 설정</h5>
        </div>
        <div class="card-body">
            <form id="reportForm">
                <div class="row g-3">
                    <div class="col-md-3">
                        <label class="form-label">기간 설정</label>
                        <select class="form-select" id="periodType" onchange="updatePeriodInputs()">
                            <option value="monthly">월간</option>
                            <option value="quarterly">분기</option>
                            <option value="yearly">연간</option>
                            <option value="custom">사용자 지정</option>
                        </select>
                    </div>
                    <div class="col-md-3" id="monthSelect">
                        <label class="form-label">년월 선택</label>
                        <input type="month" class="form-control" id="reportMonth" value="{{ current_month }}">
                    </div>
                    <div class="col-md-3" id="dateRange" style="display: none;">
                        <label class="form-label">시작일</label>
                        <input type="date" class="form-control" id="startDate">
                    </div>
                    <div class="col-md-3" id="dateRangeEnd" style="display: none;">
                        <label class="form-label">종료일</label>
                        <input type="date" class="form-control" id="endDate">
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">부서 선택</label>
                        <select class="form-select" id="departmentFilter">
                            <option value="">전체 부서</option>
                            <option value="생산부">생산부</option>
                            <option value="품질관리부">품질관리부</option>
                            <option value="연구개발부">연구개발부</option>
                            <option value="경영지원부">경영지원부</option>
                        </select>
                    </div>
                </div>
                <div class="row g-3 mt-2">
                    <div class="col-md-12">
                        <label class="form-label">포함할 항목</label>
                        <div class="form-check form-check-inline">
                            <input class="form-check-input" type="checkbox" id="includeCharts" checked>
                            <label class="form-check-label" for="includeCharts">차트/그래프</label>
                        </div>
                        <div class="form-check form-check-inline">
                            <input class="form-check-input" type="checkbox" id="includeDetails" checked>
                            <label class="form-check-label" for="includeDetails">상세 데이터</label>
                        </div>
                        <div class="form-check form-check-inline">
                            <input class="form-check-input" type="checkbox" id="includeRecommendations">
                            <label class="form-check-label" for="includeRecommendations">개선 권고사항</label>
                        </div>
                    </div>
                </div>
                <div class="mt-3">
                    <button type="button" class="btn btn-primary" onclick="generateReport()">
                        <i class="bi bi-file-earmark-pdf"></i> 보고서 생성
                    </button>
                    <button type="button" class="btn btn-secondary" onclick="previewReport()">
                        <i class="bi bi-eye"></i> 미리보기
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- 최근 생성된 보고서 -->
    <div class="card">
        <div class="card-header">
            <h5 class="mb-0">최근 생성 보고서</h5>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-hover">
                    <thead>
                        <tr>
                            <th>생성일시</th>
                            <th>보고서 유형</th>
                            <th>기간</th>
                            <th>부서</th>
                            <th>생성자</th>
                            <th>파일 크기</th>
                            <th>상태</th>
                            <th>다운로드</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for report in recent_reports %}
                        <tr>
                            <td>{{ report.created_at }}</td>
                            <td>
                                <span class="badge bg-{{ report.type_color }}">
                                    {{ report.type_name }}
                                </span>
                            </td>
                            <td>{{ report.period }}</td>
                            <td>{{ report.department|default('전체') }}</td>
                            <td>{{ report.created_by }}</td>
                            <td>{{ report.file_size }}</td>
                            <td>
                                {% if report.status == 'completed' %}
                                <span class="badge bg-success">완료</span>
                                {% elif report.status == 'processing' %}
                                <span class="badge bg-warning">생성중</span>
                                {% else %}
                                <span class="badge bg-danger">실패</span>
                                {% endif %}
                            </td>
                            <td>
                                <button class="btn btn-sm btn-outline-primary" onclick="downloadReport({{ report.id }})">
                                    <i class="bi bi-download"></i>
                                </button>
                                <button class="btn btn-sm btn-outline-info" onclick="viewReport({{ report.id }})">
                                    <i class="bi bi-eye"></i>
                                </button>
                                <button class="btn btn-sm btn-outline-danger" onclick="deleteReport({{ report.id }})">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </td>
                        </tr>
                        {% else %}
                        <tr>
                            <td colspan="8" class="text-center text-muted py-4">
                                생성된 보고서가 없습니다.
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- 보고서 템플릿 관리 -->
    <div class="card mt-4">
        <div class="card-header">
            <div class="d-flex justify-content-between align-items-center">
                <h5 class="mb-0">보고서 템플릿</h5>
                <button class="btn btn-sm btn-success" onclick="createTemplate()">
                    <i class="bi bi-plus-circle"></i> 템플릿 추가
                </button>
            </div>
        </div>
        <div class="card-body">
            <div class="row">
                {% for template in report_templates %}
                <div class="col-md-4 mb-3">
                    <div class="card">
                        <div class="card-body">
                            <h6>{{ template.name }}</h6>
                            <p class="text-muted small">{{ template.description }}</p>
                            <div class="btn-group btn-group-sm">
                                <button class="btn btn-outline-primary" onclick="useTemplate({{ template.id }})">
                                    사용
                                </button>
                                <button class="btn btn-outline-info" onclick="editTemplate({{ template.id }})">
                                    수정
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
</div>

<style>
.report-card {
    cursor: pointer;
    transition: all 0.3s;
    border: 2px solid transparent;
}
.report-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 5px 15px rgba(0,0,0,0.1);
}
.report-card.selected {
    border-color: #007bff;
    background-color: #f0f8ff;
}
</style>

<script>
let selectedReportType = null;

function selectReportType(type) {
    selectedReportType = type;
    
    // Update UI
    document.querySelectorAll('.report-card').forEach(card => {
        card.classList.remove('selected');
    });
    event.currentTarget.classList.add('selected');
    
    // Show settings
    document.getElementById('reportSettings').style.display = 'block';
    
    // Update form based on report type
    updateReportForm(type);
}

function updatePeriodInputs() {
    const periodType = document.getElementById('periodType').value;
    
    document.getElementById('monthSelect').style.display = 'none';
    document.getElementById('dateRange').style.display = 'none';
    document.getElementById('dateRangeEnd').style.display = 'none';
    
    if (periodType === 'monthly') {
        document.getElementById('monthSelect').style.display = 'block';
    } else if (periodType === 'custom') {
        document.getElementById('dateRange').style.display = 'block';
        document.getElementById('dateRangeEnd').style.display = 'block';
    }
}

function updateReportForm(type) {
    // Customize form based on report type
    const includeRecommendations = document.getElementById('includeRecommendations');
    
    if (type === 'health-check') {
        includeRecommendations.checked = true;
        includeRecommendations.disabled = false;
    } else if (type === 'accident') {
        includeRecommendations.checked = true;
        includeRecommendations.disabled = false;
    } else {
        includeRecommendations.checked = false;
        includeRecommendations.disabled = true;
    }
}

async function generateReport() {
    if (!selectedReportType) {
        alert('보고서 유형을 선택해주세요.');
        return;
    }
    
    const data = {
        type: selectedReportType,
        period_type: document.getElementById('periodType').value,
        department: document.getElementById('departmentFilter').value,
        include_charts: document.getElementById('includeCharts').checked,
        include_details: document.getElementById('includeDetails').checked,
        include_recommendations: document.getElementById('includeRecommendations').checked
    };
    
    // Add period data
    if (data.period_type === 'monthly') {
        data.month = document.getElementById('reportMonth').value;
    } else if (data.period_type === 'custom') {
        data.start_date = document.getElementById('startDate').value;
        data.end_date = document.getElementById('endDate').value;
    }
    
    try {
        const response = await fetch('/api/safework/reports/generate', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('meta[name="csrf-token"]')?.content || ''
            },
            body: JSON.stringify(data)
        });
        
        const result = await response.json();
        
        if (result.success) {
            alert('보고서 생성이 시작되었습니다. 잠시 후 완료됩니다.');
            // Reload report list
            location.reload();
        } else {
            alert('보고서 생성 실패: ' + (result.error || '알 수 없는 오류'));
        }
    } catch (error) {
        console.error('Error:', error);
        alert('서버 연결 오류가 발생했습니다.');
    }
}

function previewReport() {
    if (!selectedReportType) {
        alert('보고서 유형을 선택해주세요.');
        return;
    }
    
    // Open preview in new window
    const params = new URLSearchParams({
        type: selectedReportType,
        period: document.getElementById('periodType').value,
        department: document.getElementById('departmentFilter').value
    });
    
    window.open(`/admin/safework/reports/preview?${params.toString()}`, '_blank');
}

function downloadReport(id) {
    window.location.href = `/api/safework/reports/${id}/download`;
}

function viewReport(id) {
    window.open(`/admin/safework/reports/${id}/view`, '_blank');
}

async function deleteReport(id) {
    if (!confirm('이 보고서를 삭제하시겠습니까?')) {
        return;
    }
    
    try {
        const response = await fetch(`/api/safework/reports/${id}`, {
            method: 'DELETE',
            headers: {
                'X-CSRFToken': document.querySelector('meta[name="csrf-token"]')?.content || ''
            }
        });
        
        if (response.ok) {
            location.reload();
        }
    } catch (error) {
        console.error('Error:', error);
        alert('삭제 중 오류가 발생했습니다.');
    }
}

function generateMonthlyReport() {
    selectedReportType = 'health-check';
    document.getElementById('periodType').value = 'monthly';
    updatePeriodInputs();
    document.getElementById('reportSettings').style.display = 'block';
}

function generateAnnualReport() {
    selectedReportType = 'health-check';
    document.getElementById('periodType').value = 'yearly';
    updatePeriodInputs();
    document.getElementById('reportSettings').style.display = 'block';
}

// Set current month as default
document.addEventListener('DOMContentLoaded', function() {
    const now = new Date();
    const month = String(now.getMonth() + 1).padStart(2, '0');
    const year = now.getFullYear();
    document.getElementById('reportMonth').value = `${year}-${month}`;
});
</script>
{% endblock %}