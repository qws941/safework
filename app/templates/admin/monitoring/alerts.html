{% extends "admin/base_admin.html" %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-md-12">
            <h1>알림 관리</h1>

            <!-- 알림 요약 카드 -->
            <div class="row mb-4">
                <div class="col-md-3">
                    <div class="card bg-info text-white">
                        <div class="card-body">
                            <h5 class="card-title">총 이벤트</h5>
                            <h3>{{ recent_events|length }}</h3>
                            <small>최근 24시간</small>
                        </div>
                    </div>
                </div>

                <div class="col-md-3">
                    <div class="card bg-warning text-white">
                        <div class="card-body">
                            <h5 class="card-title">경고 알림</h5>
                            <h3>{{ recent_events|selectattr('action', 'equalto', 'warning')|list|length }}</h3>
                            <small>주의 필요</small>
                        </div>
                    </div>
                </div>

                <div class="col-md-3">
                    <div class="card bg-danger text-white">
                        <div class="card-body">
                            <h5 class="card-title">에러 알림</h5>
                            <h3>{{ recent_events|selectattr('action', 'equalto', 'error')|list|length }}</h3>
                            <small>즉시 처리 필요</small>
                        </div>
                    </div>
                </div>

                <div class="col-md-3">
                    <div class="card bg-success text-white">
                        <div class="card-body">
                            <h5 class="card-title">정상 상태</h5>
                            <h3>{{ recent_events|selectattr('action', 'equalto', 'container_restart')|list|length }}</h3>
                            <small>복구 완료</small>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 알림 설정 -->
            <div class="row mb-4">
                <div class="col-md-12">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="card-title mb-0">알림 설정</h5>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <h6>이메일 알림</h6>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="emailCritical" checked>
                                        <label class="form-check-label" for="emailCritical">
                                            치명적 오류 시 이메일 발송
                                        </label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="emailWarning">
                                        <label class="form-check-label" for="emailWarning">
                                            경고 발생 시 이메일 발송
                                        </label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="emailDaily" checked>
                                        <label class="form-check-label" for="emailDaily">
                                            일일 요약 리포트 발송
                                        </label>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <h6>알림 임계값</h6>
                                    <div class="form-group">
                                        <label for="errorThreshold">시간당 에러 임계값:</label>
                                        <input type="number" class="form-control" id="errorThreshold" value="15" min="1" max="100">
                                    </div>
                                    <div class="form-group">
                                        <label for="responseThreshold">응답시간 임계값 (초):</label>
                                        <input type="number" class="form-control" id="responseThreshold" value="5" min="1" max="30" step="0.1">
                                    </div>
                                    <div class="form-group">
                                        <label for="memoryThreshold">메모리 사용률 임계값 (%):</label>
                                        <input type="number" class="form-control" id="memoryThreshold" value="85" min="50" max="95">
                                    </div>
                                </div>
                            </div>
                            <div class="row mt-3">
                                <div class="col-md-12">
                                    <button class="btn btn-primary" onclick="saveAlertSettings()">
                                        설정 저장
                                    </button>
                                    <button class="btn btn-secondary ml-2" onclick="testAlert()">
                                        테스트 알림 발송
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 최근 이벤트 목록 -->
            <div class="row">
                <div class="col-md-12">
                    <div class="card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5 class="card-title mb-0">최근 시스템 이벤트</h5>
                            <div>
                                <button class="btn btn-sm btn-outline-primary" onclick="refreshEvents()">
                                    <i class="bi bi-arrow-clockwise"></i> 새로고침
                                </button>
                                <button class="btn btn-sm btn-outline-success" onclick="exportEvents()">
                                    <i class="bi bi-download"></i> Excel 다운로드
                                </button>
                            </div>
                        </div>
                        <div class="card-body">
                            {% if recent_events %}
                            <div class="table-responsive">
                                <table class="table table-striped" id="eventsTable">
                                    <thead>
                                        <tr>
                                            <th>시간</th>
                                            <th>이벤트 유형</th>
                                            <th>세부 내용</th>
                                            <th>사용자</th>
                                            <th>IP 주소</th>
                                            <th>심각도</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for event in recent_events %}
                                        <tr>
                                            <td>
                                                <small>{{ event.timestamp }}</small>
                                            </td>
                                            <td>
                                                <span class="badge badge-{{
                                                    'danger' if event.action in ['error', 'critical'] else
                                                    'warning' if event.action in ['warning', 'container_restart'] else
                                                    'info' if event.action in ['page_access', 'login'] else
                                                    'secondary'
                                                }}">
                                                    {{ event.action }}
                                                </span>
                                            </td>
                                            <td>
                                                <div style="max-width: 400px; overflow: hidden; text-overflow: ellipsis;">
                                                    {{ event.details }}
                                                </div>
                                            </td>
                                            <td>
                                                {% if event.user_id %}
                                                    <span class="badge badge-primary">User {{ event.user_id }}</span>
                                                {% else %}
                                                    <span class="text-muted">시스템</span>
                                                {% endif %}
                                            </td>
                                            <td>
                                                <small>{{ event.ip_address or 'N/A' }}</small>
                                            </td>
                                            <td>
                                                {% if event.action in ['error', 'critical'] %}
                                                    <i class="bi bi-exclamation-triangle-fill text-danger" title="높음"></i>
                                                {% elif event.action in ['warning', 'container_restart'] %}
                                                    <i class="bi bi-exclamation-triangle text-warning" title="보통"></i>
                                                {% else %}
                                                    <i class="bi bi-info-circle text-info" title="낮음"></i>
                                                {% endif %}
                                            </td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                            {% else %}
                            <div class="text-center py-4">
                                <i class="bi bi-clock-history" style="font-size: 3rem; color: #6c757d;"></i>
                                <p class="text-muted mt-2">최근 24시간 동안 기록된 이벤트가 없습니다.</p>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>

            <!-- 알림 규칙 관리 -->
            <div class="row mt-4">
                <div class="col-md-12">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="card-title mb-0">알림 규칙</h5>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-sm">
                                    <thead>
                                        <tr>
                                            <th>규칙명</th>
                                            <th>조건</th>
                                            <th>액션</th>
                                            <th>상태</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                            <td>컨테이너 중지 감지</td>
                                            <td>SafeWork 컨테이너 상태가 'exited'로 변경</td>
                                            <td>즉시 이메일 알림 + 자동 재시작 시도</td>
                                            <td><span class="badge badge-success">활성</span></td>
                                        </tr>
                                        <tr>
                                            <td>높은 에러율 감지</td>
                                            <td>시간당 에러 15개 이상 발생</td>
                                            <td>이메일 알림 + Slack 알림</td>
                                            <td><span class="badge badge-success">활성</span></td>
                                        </tr>
                                        <tr>
                                            <td>응답시간 초과</td>
                                            <td>애플리케이션 응답시간 5초 초과</td>
                                            <td>경고 알림</td>
                                            <td><span class="badge badge-success">활성</span></td>
                                        </tr>
                                        <tr>
                                            <td>메모리 사용률 과다</td>
                                            <td>컨테이너 메모리 사용률 85% 이상</td>
                                            <td>경고 알림 + 성능 분석 보고서 생성</td>
                                            <td><span class="badge badge-success">활성</span></td>
                                        </tr>
                                        <tr>
                                            <td>데이터베이스 연결 실패</td>
                                            <td>PostgreSQL 연결 실패 로그 감지</td>
                                            <td>즉시 알림 + 자동 복구 시도</td>
                                            <td><span class="badge badge-success">활성</span></td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// 알림 설정 저장
function saveAlertSettings() {
    const settings = {
        email_critical: document.getElementById('emailCritical').checked,
        email_warning: document.getElementById('emailWarning').checked,
        email_daily: document.getElementById('emailDaily').checked,
        error_threshold: parseInt(document.getElementById('errorThreshold').value),
        response_threshold: parseFloat(document.getElementById('responseThreshold').value),
        memory_threshold: parseInt(document.getElementById('memoryThreshold').value)
    };

    // 실제 구현에서는 백엔드 API로 전송
    console.log('저장할 알림 설정:', settings);
    alert('알림 설정이 저장되었습니다.');
}

// 테스트 알림 발송
function testAlert() {
    // 실제 구현에서는 백엔드 API로 테스트 알림 요청
    console.log('테스트 알림 발송 요청');
    alert('테스트 알림이 발송되었습니다. 이메일을 확인해주세요.');
}

// 이벤트 목록 새로고침
function refreshEvents() {
    location.reload();
}

// 이벤트 Excel 다운로드
function exportEvents() {
    // 실제 구현에서는 백엔드 API로 Excel 파일 생성 요청
    console.log('이벤트 Excel 다운로드 요청');
    alert('Excel 파일 다운로드를 준비 중입니다...');
}

// 페이지 로드시 실행
document.addEventListener('DOMContentLoaded', function() {
    // 테이블 정렬 기능 (실제 구현에서는 DataTables 등 사용)
    console.log('알림 관리 페이지 로드 완료');

    // 5분마다 자동 새로고침
    setInterval(function() {
        refreshEvents();
    }, 300000); // 5분 = 300,000ms
});
</script>

<style>
.card-body {
    max-height: 600px;
    overflow-y: auto;
}

.table th {
    position: sticky;
    top: 0;
    background: #fff;
    z-index: 10;
}

.badge {
    font-size: 0.75em;
}

.form-check {
    margin-bottom: 0.5rem;
}

.form-group {
    margin-bottom: 1rem;
}
</style>
{% endblock %}