{% extends "admin/base_admin.html" %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-md-12">
            <h1>시스템 모니터링 대시보드</h1>

            <!-- 시스템 상태 카드 -->
            <div class="row mb-4">
                <div class="col-md-3">
                    <div class="card bg-{{ 'success' if health.overall_status == 'healthy' else 'warning' if health.overall_status == 'degraded' else 'danger' }} text-white">
                        <div class="card-body">
                            <h5 class="card-title">전체 상태</h5>
                            <h3>{{ health.overall_status|upper }}</h3>
                            <small>{{ health.timestamp }}</small>
                        </div>
                    </div>
                </div>

                <div class="col-md-3">
                    <div class="card bg-info text-white">
                        <div class="card-body">
                            <h5 class="card-title">컨테이너 상태</h5>
                            <h3>{{ health.components.containers.running }}/{{ health.components.containers.total }}</h3>
                            <small>{{ health.components.containers.status|upper }}</small>
                        </div>
                    </div>
                </div>

                <div class="col-md-3">
                    <div class="card bg-{{ 'success' if health.components.application.status == 'healthy' else 'danger' }} text-white">
                        <div class="card-body">
                            <h5 class="card-title">애플리케이션</h5>
                            <h3>{{ health.components.application.status|upper }}</h3>
                            {% if health.components.application.response_time %}
                            <small>응답시간: {{ "%.2f"|format(health.components.application.response_time) }}초</small>
                            {% endif %}
                        </div>
                    </div>
                </div>

                <div class="col-md-3">
                    <div class="card bg-{{ 'success' if health.components.redis.status == 'healthy' else 'danger' }} text-white">
                        <div class="card-body">
                            <h5 class="card-title">Redis 캐시</h5>
                            <h3>{{ health.components.redis.status|upper }}</h3>
                            {% if health.components.redis.used_memory_human %}
                            <small>메모리: {{ health.components.redis.used_memory_human }}</small>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>

            <!-- 컨테이너 목록 -->
            <div class="row">
                <div class="col-md-12">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="card-title mb-0">SafeWork 컨테이너 상태</h5>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-striped">
                                    <thead>
                                        <tr>
                                            <th>컨테이너 ID</th>
                                            <th>이름</th>
                                            <th>상태</th>
                                            <th>상태 메시지</th>
                                            <th>이미지</th>
                                            <th>생성일</th>
                                            <th>액션</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for container in containers %}
                                        <tr>
                                            <td>
                                                <code>{{ container.id }}</code>
                                            </td>
                                            <td>
                                                <strong>{{ container.name }}</strong>
                                            </td>
                                            <td>
                                                <span class="badge badge-{{ 'success' if container.state == 'running' else 'danger' }}">
                                                    {{ container.state|upper }}
                                                </span>
                                            </td>
                                            <td>{{ container.status }}</td>
                                            <td>
                                                <small>{{ container.image }}</small>
                                            </td>
                                            <td>{{ container.created }}</td>
                                            <td>
                                                <div class="btn-group btn-group-sm">
                                                    <button class="btn btn-outline-primary" onclick="viewLogs('{{ container.id }}')">
                                                        로그
                                                    </button>
                                                    {% if container.state != 'running' %}
                                                    <button class="btn btn-outline-success" onclick="restartContainer('{{ container.name }}')">
                                                        재시작
                                                    </button>
                                                    {% endif %}
                                                </div>
                                            </td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 실시간 메트릭 -->
            <div class="row mt-4">
                <div class="col-md-12">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="card-title mb-0">실시간 메트릭 (자동 새로고침)</h5>
                        </div>
                        <div class="card-body">
                            <div id="metrics-content">
                                <p class="text-muted">메트릭 로딩 중...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 로그 모달 -->
<div class="modal fade" id="logsModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">컨테이너 로그</h5>
                <button type="button" class="close" data-dismiss="modal">
                    <span>&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <pre id="logs-content" style="max-height: 400px; overflow-y: auto; background: #f8f9fa; padding: 15px;"></pre>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">닫기</button>
                <button type="button" class="btn btn-primary" onclick="refreshLogs()">새로고침</button>
            </div>
        </div>
    </div>
</div>

<script>
let currentContainerId = null;

// 컨테이너 로그 보기
function viewLogs(containerId) {
    currentContainerId = containerId;
    $('#logsModal').modal('show');
    refreshLogs();
}

// 로그 새로고침
function refreshLogs() {
    if (!currentContainerId) return;

    fetch(`/admin/monitoring/api/logs/${currentContainerId}?lines=100`)
        .then(response => response.json())
        .then(data => {
            document.getElementById('logs-content').textContent = data.logs.join('\n');
        })
        .catch(error => {
            console.error('로그 로딩 실패:', error);
            document.getElementById('logs-content').textContent = '로그 로딩에 실패했습니다.';
        });
}

// 컨테이너 재시작
function restartContainer(containerName) {
    if (!confirm(`${containerName} 컨테이너를 재시작하시겠습니까?`)) {
        return;
    }

    fetch(`/admin/monitoring/api/restart/${containerName}`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('컨테이너가 성공적으로 재시작되었습니다.');
            location.reload();
        } else {
            alert('컨테이너 재시작에 실패했습니다: ' + data.error);
        }
    })
    .catch(error => {
        console.error('재시작 실패:', error);
        alert('컨테이너 재시작 요청 중 오류가 발생했습니다.');
    });
}

// 메트릭 새로고침
function refreshMetrics() {
    fetch('/admin/monitoring/api/metrics')
        .then(response => response.json())
        .then(data => {
            const metricsHtml = `
                <div class="row">
                    <div class="col-md-4">
                        <h6>컨테이너 상태</h6>
                        <p>총 ${data.containers.total}개 / 실행 중 ${data.containers.running}개</p>
                    </div>
                    <div class="col-md-4">
                        <h6>애플리케이션</h6>
                        <p>상태: ${data.application.status} / 응답시간: ${data.application.response_time}초</p>
                    </div>
                    <div class="col-md-4">
                        <h6>Redis</h6>
                        <p>클라이언트: ${data.redis.connected_clients || 0}개 / 메모리: ${data.redis.used_memory_human || 'N/A'}</p>
                    </div>
                </div>
                <p class="text-muted"><small>마지막 업데이트: ${new Date(data.timestamp).toLocaleString()}</small></p>
            `;
            document.getElementById('metrics-content').innerHTML = metricsHtml;
        })
        .catch(error => {
            console.error('메트릭 로딩 실패:', error);
            document.getElementById('metrics-content').innerHTML = '<p class="text-danger">메트릭 로딩에 실패했습니다.</p>';
        });
}

// 페이지 로드 시 초기 메트릭 로드 및 자동 새로고침 설정
document.addEventListener('DOMContentLoaded', function() {
    refreshMetrics();

    // 30초마다 메트릭 자동 새로고침
    setInterval(refreshMetrics, 30000);
});
</script>
{% endblock %}