{% extends "base.html" %}

{% block title %}SafeWork 안전보건관리 대시보드{% endblock %}

{% block content %}
<div class="container-fluid mt-3">
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="mb-0">
            <i class="bi bi-shield-check"></i> SafeWork 안전보건관리시스템
        </h2>
        <div class="text-end">
            <span class="badge bg-primary">{{ current_user.username }}</span>
            <span class="badge bg-secondary">{{ today }}</span>
        </div>
    </div>

    <!-- 주요 지표 카드 -->
    <div class="row mb-4">
        <!-- 근로자 현황 -->
        <div class="col-xl-3 col-lg-6 mb-3">
            <div class="card border-start border-primary border-4">
                <div class="card-body">
                    <div class="row align-items-center">
                        <div class="col">
                            <div class="text-primary text-uppercase mb-1 small">전체 근로자</div>
                            <div class="h4 mb-0 fw-bold">{{ worker_total }}</div>
                            <small class="text-muted">재직: {{ worker_active }} / 휴직: {{ worker_leave }}</small>
                        </div>
                        <div class="col-auto">
                            <i class="bi bi-people-fill fs-1 text-primary opacity-25"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 건강검진 현황 -->
        <div class="col-xl-3 col-lg-6 mb-3">
            <div class="card border-start border-success border-4">
                <div class="card-body">
                    <div class="row align-items-center">
                        <div class="col">
                            <div class="text-success text-uppercase mb-1 small">{{ current_year }}년 건강검진</div>
                            <div class="h4 mb-0 fw-bold">{{ health_check_rate }}%</div>
                            <small class="text-muted">완료: {{ health_check_completed }} / 대상: {{ health_check_target }}</small>
                        </div>
                        <div class="col-auto">
                            <i class="bi bi-heart-pulse-fill fs-1 text-success opacity-25"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 의무실 방문 -->
        <div class="col-xl-3 col-lg-6 mb-3">
            <div class="card border-start border-warning border-4">
                <div class="card-body">
                    <div class="row align-items-center">
                        <div class="col">
                            <div class="text-warning text-uppercase mb-1 small">이번달 의무실 방문</div>
                            <div class="h4 mb-0 fw-bold">{{ medical_visits_month }}건</div>
                            <small class="text-muted">전월 대비: 
                                {% if medical_change < 0 %}
                                <span class="text-success">{{ medical_change }}%</span>
                                {% else %}
                                <span class="text-danger">+{{ medical_change }}%</span>
                                {% endif %}
                            </small>
                        </div>
                        <div class="col-auto">
                            <i class="bi bi-hospital fs-1 text-warning opacity-25"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 작업환경측정 -->
        <div class="col-xl-3 col-lg-6 mb-3">
            <div class="card border-start border-info border-4">
                <div class="card-body">
                    <div class="row align-items-center">
                        <div class="col">
                            <div class="text-info text-uppercase mb-1 small">작업환경측정</div>
                            <div class="h4 mb-0 fw-bold">{{ env_status }}</div>
                            <small class="text-muted">다음 측정: {{ next_measurement }}</small>
                        </div>
                        <div class="col-auto">
                            <i class="bi bi-building fs-1 text-info opacity-25"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- 건강검진 일정 -->
        <div class="col-lg-6 mb-4">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h6 class="mb-0"><i class="bi bi-calendar-check me-2"></i>이번달 건강검진 일정</h6>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-sm">
                            <thead>
                                <tr>
                                    <th>날짜</th>
                                    <th>대상자</th>
                                    <th>구분</th>
                                    <th>상태</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% if health_checks %}
                                    {% for check in health_checks %}
                                    <tr>
                                        <td>{{ check.scheduled_date }}</td>
                                        <td>{{ check.worker_name }}</td>
                                        <td><span class="badge bg-info">{{ check.check_type }}</span></td>
                                        <td>
                                            {% if check.status == 'COMPLETED' %}
                                            <span class="badge bg-success">완료</span>
                                            {% elif check.status == 'SCHEDULED' %}
                                            <span class="badge bg-warning">예정</span>
                                            {% else %}
                                            <span class="badge bg-danger">미완료</span>
                                            {% endif %}
                                        </td>
                                    </tr>
                                    {% endfor %}
                                {% else %}
                                <tr>
                                    <td colspan="4" class="text-center text-muted">예정된 건강검진이 없습니다</td>
                                </tr>
                                {% endif %}
                            </tbody>
                        </table>
                    </div>
                    <div class="text-end mt-2">
                        <a href="/admin/safework/health-checks" class="btn btn-sm btn-primary">전체 보기</a>
                    </div>
                </div>
            </div>
        </div>

        <!-- 최근 의무실 방문 -->
        <div class="col-lg-6 mb-4">
            <div class="card">
                <div class="card-header bg-success text-white">
                    <h6 class="mb-0"><i class="bi bi-clipboard2-pulse me-2"></i>최근 의무실 방문</h6>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-sm">
                            <thead>
                                <tr>
                                    <th>일시</th>
                                    <th>근로자</th>
                                    <th>주증상</th>
                                    <th>조치</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% if medical_visits %}
                                    {% for visit in medical_visits %}
                                    <tr>
                                        <td>{{ visit.visit_date.strftime('%m/%d %H:%M') }}</td>
                                        <td>{{ visit.worker_name }}</td>
                                        <td>{{ visit.chief_complaint[:20] }}</td>
                                        <td>
                                            {% if visit.follow_up_needed %}
                                            <span class="badge bg-warning">후속조치</span>
                                            {% else %}
                                            <span class="badge bg-success">조치완료</span>
                                            {% endif %}
                                        </td>
                                    </tr>
                                    {% endfor %}
                                {% else %}
                                <tr>
                                    <td colspan="4" class="text-center text-muted">최근 방문 기록이 없습니다</td>
                                </tr>
                                {% endif %}
                            </tbody>
                        </table>
                    </div>
                    <div class="text-end mt-2">
                        <a href="/admin/safework/medical-visits" class="btn btn-sm btn-success">전체 보기</a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 부서별 현황 차트 -->
    <div class="row">
        <div class="col-lg-8 mb-4">
            <div class="card">
                <div class="card-header">
                    <h6 class="mb-0"><i class="bi bi-bar-chart-fill me-2"></i>부서별 건강검진 현황</h6>
                </div>
                <div class="card-body">
                    <canvas id="healthCheckChart" height="100"></canvas>
                </div>
            </div>
        </div>
        
        <div class="col-lg-4 mb-4">
            <div class="card">
                <div class="card-header">
                    <h6 class="mb-0"><i class="bi bi-exclamation-triangle-fill me-2"></i>주요 알림</h6>
                </div>
                <div class="card-body">
                    {% for alert in alerts %}
                    <div class="alert alert-{{ alert.type }} mb-2" role="alert">
                        <small><strong>{{ alert.title }}:</strong> {{ alert.message }}</small>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>

    <!-- 빠른 실행 메뉴 -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h6 class="mb-0"><i class="bi bi-lightning-fill me-2"></i>빠른 실행</h6>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-3 mb-2">
                            <a href="/admin/safework/workers/new" class="btn btn-outline-primary w-100">
                                <i class="bi bi-person-plus"></i> 근로자 등록
                            </a>
                        </div>
                        <div class="col-md-3 mb-2">
                            <a href="/admin/safework/health-checks/new" class="btn btn-outline-success w-100">
                                <i class="bi bi-calendar-plus"></i> 검진 예약
                            </a>
                        </div>
                        <div class="col-md-3 mb-2">
                            <a href="/admin/safework/medical-visits/new" class="btn btn-outline-warning w-100">
                                <i class="bi bi-clipboard2-pulse"></i> 의무실 기록
                            </a>
                        </div>
                        <div class="col-md-3 mb-2">
                            <a href="/admin/safework/reports" class="btn btn-outline-info w-100">
                                <i class="bi bi-file-earmark-text"></i> 보고서 작성
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.border-start.border-4 {
    border-left-width: 4px !important;
}
.opacity-25 {
    opacity: 0.25 !important;
}
</style>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
// 부서별 건강검진 현황 차트
document.addEventListener('DOMContentLoaded', function() {
    const ctx = document.getElementById('healthCheckChart');
    if (ctx) {
        const healthCheckChart = new Chart(ctx.getContext('2d'), {
            type: 'bar',
            data: {
                labels: {{ department_names|tojson }},
                datasets: [{
                    label: '완료',
                    data: {{ department_completed|tojson }},
                    backgroundColor: 'rgba(40, 167, 69, 0.8)',
                }, {
                    label: '미완료',
                    data: {{ department_pending|tojson }},
                    backgroundColor: 'rgba(220, 53, 69, 0.8)',
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    x: {
                        stacked: true,
                    },
                    y: {
                        stacked: true,
                        beginAtZero: true
                    }
                },
                plugins: {
                    legend: {
                        position: 'top',
                    },
                    title: {
                        display: false
                    }
                }
            }
        });
    }
});
</script>
{% endblock %}