{% extends "base.html" %}
{% block title %}조사표 상세보기{% endblock %}

{% block content %}
<div class="container">
    <div class="mb-4">
        <a href="{{ url_for('admin.survey') }}" class="btn btn-secondary">
            <i class="bi bi-arrow-left"></i> 목록으로
        </a>
    </div>
    
    <h2 class="mb-4">
        조사표 상세 정보 #{{ survey.id }}
        {% if survey.form_type %}
            {% if '001' in survey.form_type %}
                <span class="badge bg-primary">001 근골격계</span>
            {% elif '002' in survey.form_type %}
                <span class="badge bg-info">002 신규입사자</span>
            {% endif %}
        {% else %}
            <span class="badge bg-primary">001 근골격계</span>
        {% endif %}
    </h2>
    
    <!-- 기본 정보 -->
    <div class="card mb-4">
        <div class="card-header bg-primary text-white">
            <h5 class="mb-0">기본 정보</h5>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-3">
                    <strong>제출일시:</strong><br>
                    {{ survey.created_at.strftime('%Y-%m-%d %H:%M:%S') if survey.created_at else '-' }}
                </div>
                <div class="col-md-3">
                    <strong>사번:</strong><br>
                    {{ survey.employee_number or '-' }}
                </div>
                <div class="col-md-3">
                    <strong>이름:</strong><br>
                    {{ survey.name }}
                </div>
                <div class="col-md-3">
                    <strong>나이:</strong><br>
                    {{ survey.age }}세
                </div>
            </div>
            <hr>
            <div class="row">
                <div class="col-md-3">
                    <strong>성별:</strong><br>
                    {{ survey.gender or '-' }}
                </div>
                <div class="col-md-3">
                    <strong>부서:</strong><br>
                    {{ survey.department or '-' }}
                </div>
                <div class="col-md-3">
                    <strong>직위:</strong><br>
                    {{ survey.position or '-' }}
                </div>
                <div class="col-md-3">
                    <strong>근무경력:</strong><br>
                    {% if survey.work_years or survey.work_months %}
                        {{ survey.work_years or 0 }}년 {{ survey.work_months or 0 }}개월
                    {% else %}
                        -
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
    
    <!-- Form 001 근골격계 관련 정보 -->
    {% if not survey.form_type or '001' in (survey.form_type or '') %}
    <div class="card mb-4">
        <div class="card-header bg-warning">
            <h5 class="mb-0">작업 정보</h5>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-4">
                    <strong>작업형태:</strong><br>
                    {{ survey.work_type or '-' }}
                </div>
                <div class="col-md-4">
                    <strong>1일 근무시간:</strong><br>
                    {{ survey.work_hours_per_day or '-' }}시간
                </div>
                <div class="col-md-4">
                    <strong>휴식시간:</strong><br>
                    {{ survey.break_time_minutes or '-' }}분
                </div>
            </div>
            {% if survey.work_posture %}
            <hr>
            <div class="row">
                <div class="col-12">
                    <strong>작업 자세:</strong><br>
                    {{ survey.work_posture }}
                </div>
            </div>
            {% endif %}
        </div>
    </div>
    
    <!-- 증상 정보 -->
    <div class="card mb-4">
        <div class="card-header bg-danger text-white">
            <h5 class="mb-0">증상 정보</h5>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-sm">
                    <thead>
                        <tr>
                            <th>부위</th>
                            <th>통증정도</th>
                            <th>증상</th>
                            <th>빈도</th>
                            <th>지속기간</th>
                            <th>강도</th>
                            <th>업무영향</th>
                            <th>지난1년</th>
                            <th>지난1주</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- 목 -->
                        <tr>
                            <td><strong>목</strong></td>
                            <td>
                                {% set neck_data = (survey.responses.목 if survey.responses and survey.responses.목 else {}) %}
                                {% if neck_data.severity is defined %}
                                    {{ neck_data.severity }}
                                {% elif survey.data and survey.data.neck and survey.data.neck.severity %}
                                    {{ survey.data.neck.severity }}
                                {% else %}
                                    -
                                {% endif %}
                            </td>
                            <td>{{ neck_data.side or '-' }}</td>
                            <td>{{ neck_data.frequency or '-' }}</td>
                            <td>{{ neck_data.duration or '-' }}</td>
                            <td>{{ neck_data.severity or '-' }}</td>
                            <td>{{ neck_data.consequences|join(', ') if neck_data.consequences else '-' }}</td>
                            <td>{{ '✓' if neck_data.last_year else '-' }}</td>
                            <td>{{ '✓' if neck_data.last_week else '-' }}</td>
                        </tr>
                        <!-- 어깨 -->
                        <tr>
                            <td><strong>어깨</strong></td>
                            {% set shoulder_data = (survey.responses.어깨 if survey.responses and survey.responses.어깨 else {}) %}
                            <td>{{ shoulder_data.severity or '-' }}</td>
                            <td>{{ shoulder_data.side or '-' }}</td>
                            <td>{{ shoulder_data.frequency or '-' }}</td>
                            <td>{{ shoulder_data.duration or '-' }}</td>
                            <td>{{ shoulder_data.severity or '-' }}</td>
                            <td>{{ shoulder_data.consequences|join(', ') if shoulder_data.consequences else '-' }}</td>
                            <td>{{ '✓' if shoulder_data.last_year else '-' }}</td>
                            <td>{{ '✓' if shoulder_data.last_week else '-' }}</td>
                        </tr>
                        <!-- 팔/팔꿈치 -->
                        <tr>
                            <td><strong>팔/팔꿈치</strong></td>
                            {% set arm_data = (survey.responses['팔/팔꿈치'] if survey.responses and survey.responses['팔/팔꿈치'] else {}) %}
                            <td>{{ arm_data.severity or '-' }}</td>
                            <td>{{ arm_data.side or '-' }}</td>
                            <td>{{ arm_data.frequency or '-' }}</td>
                            <td>{{ arm_data.duration or '-' }}</td>
                            <td>{{ arm_data.severity or '-' }}</td>
                            <td>{{ arm_data.consequences|join(', ') if arm_data.consequences else '-' }}</td>
                            <td>{{ '✓' if arm_data.last_year else '-' }}</td>
                            <td>{{ '✓' if arm_data.last_week else '-' }}</td>
                        </tr>
                        <!-- 손/손목/손가락 -->
                        <tr>
                            <td><strong>손/손목</strong></td>
                            {% set hand_data = (survey.responses['손/손목/손가락'] if survey.responses and survey.responses['손/손목/손가락'] else {}) %}
                            <td>{{ hand_data.severity or '-' }}</td>
                            <td>{{ hand_data.side or '-' }}</td>
                            <td>{{ hand_data.frequency or '-' }}</td>
                            <td>{{ hand_data.duration or '-' }}</td>
                            <td>{{ hand_data.severity or '-' }}</td>
                            <td>{{ hand_data.consequences|join(', ') if hand_data.consequences else '-' }}</td>
                            <td>{{ '✓' if hand_data.last_year else '-' }}</td>
                            <td>{{ '✓' if hand_data.last_week else '-' }}</td>
                        </tr>
                        <!-- 등/허리 -->
                        <tr>
                            <td><strong>등/허리</strong></td>
                            {% set back_data = (survey.responses.허리 if survey.responses and survey.responses.허리 else {}) %}
                            <td>{{ back_data.severity or '-' }}</td>
                            <td>{{ back_data.side or '-' }}</td>
                            <td>{{ back_data.frequency or '-' }}</td>
                            <td>{{ back_data.duration or '-' }}</td>
                            <td>{{ back_data.severity or '-' }}</td>
                            <td>{{ back_data.consequences|join(', ') if back_data.consequences else '-' }}</td>
                            <td>{{ '✓' if back_data.last_year else '-' }}</td>
                            <td>{{ '✓' if back_data.last_week else '-' }}</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    {% endif %}
    
    <!-- Form 002 신규입사자 관련 정보 -->
    {% if survey.form_type and '002' in survey.form_type %}
    <div class="card mb-4">
        <div class="card-header bg-info text-white">
            <h5 class="mb-0">신체 정보</h5>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-3">
                    <strong>신장:</strong><br>
                    {{ survey.height_cm or '-' }} cm
                </div>
                <div class="col-md-3">
                    <strong>체중:</strong><br>
                    {{ survey.weight_kg or '-' }} kg
                </div>
                <div class="col-md-3">
                    <strong>BMI:</strong><br>
                    {% if survey.height_cm and survey.weight_kg %}
                        {{ ((survey.weight_kg / ((survey.height_cm/100) ** 2)) | round(1)) }}
                    {% else %}
                        -
                    {% endif %}
                </div>
                <div class="col-md-3">
                    <strong>혈액형:</strong><br>
                    {{ survey.blood_type or '-' }}
                </div>
            </div>
        </div>
    </div>
    
    <div class="card mb-4">
        <div class="card-header bg-warning">
            <h5 class="mb-0">건강 이력</h5>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-12 mb-3">
                    <strong>기존 질환:</strong><br>
                    {{ survey.existing_conditions or '없음' }}
                </div>
                <div class="col-md-12 mb-3">
                    <strong>복용 약물:</strong><br>
                    {{ survey.medication_history or '없음' }}
                </div>
                <div class="col-md-12">
                    <strong>알레르기 이력:</strong><br>
                    {{ survey.allergy_history or '없음' }}
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- 설문 응답 데이터 (원본) -->
    {% if survey.responses or survey.data %}
    <div class="card mb-4">
        <div class="card-header bg-secondary text-white">
            <h5 class="mb-0">설문 응답 데이터</h5>
        </div>
        <div class="card-body">
            {% if survey.responses %}
            <h6>Responses 필드:</h6>
            <pre class="bg-light p-3"><code>{{ survey.responses|tojson(indent=2) }}</code></pre>
            {% endif %}

            {% if survey.data %}
            <h6>Data 필드:</h6>
            <pre class="bg-light p-3"><code>{{ survey.data|tojson(indent=2) }}</code></pre>
            {% endif %}
        </div>
    </div>
    {% endif %}

    <!-- 작업 버튼 -->
    <div class="mb-5">
        <a href="{{ url_for('admin.survey') }}" class="btn btn-secondary">
            <i class="bi bi-arrow-left"></i> 목록으로
        </a>
        <button onclick="window.print()" class="btn btn-primary">
            <i class="bi bi-printer"></i> 인쇄
        </button>
    </div>
</div>
{% endblock %}