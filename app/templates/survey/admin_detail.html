{% extends "base.html" %}
{% block title %}조사표 상세보기{% endblock %}

{% block content %}
<div class="container">
    <div class="mb-4">
        <a href="{{ url_for('admin.survey') }}" class="btn btn-secondary">
            <i class="bi bi-arrow-left"></i> 목록으로
        </a>
    </div>
    
    <h2 class="mb-4">
        조사표 상세 정보 #{{ survey.id }}
        {% if survey.form_type %}
            {% if '001' in survey.form_type %}
                <span class="badge bg-primary">001 근골격계</span>
            {% elif '002' in survey.form_type %}
                <span class="badge bg-info">002 신규입사자</span>
            {% endif %}
        {% else %}
            <span class="badge bg-primary">001 근골격계</span>
        {% endif %}
    </h2>
    
    <!-- 기본 정보 -->
    <div class="card mb-4">
        <div class="card-header bg-primary text-white">
            <h5 class="mb-0">기본 정보</h5>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-3">
                    <strong>제출일시:</strong><br>
                    {{ survey.created_at.strftime('%Y-%m-%d %H:%M:%S') if survey.created_at else '-' }}
                </div>
                <div class="col-md-3">
                    <strong>사번:</strong><br>
                    {{ survey.employee_number or '-' }}
                </div>
                <div class="col-md-3">
                    <strong>이름:</strong><br>
                    {{ survey.name }}
                </div>
                <div class="col-md-3">
                    <strong>나이:</strong><br>
                    {{ survey.age }}세
                </div>
            </div>
            <hr>
            <div class="row">
                <div class="col-md-3">
                    <strong>성별:</strong><br>
                    {{ survey.gender or '-' }}
                </div>
                <div class="col-md-3">
                    <strong>부서:</strong><br>
                    {{ survey.department or '-' }}
                </div>
                <div class="col-md-3">
                    <strong>직위:</strong><br>
                    {{ survey.position or '-' }}
                </div>
                <div class="col-md-3">
                    <strong>근무경력:</strong><br>
                    {% if survey.work_years or survey.work_months %}
                        {{ survey.work_years or 0 }}년 {{ survey.work_months or 0 }}개월
                    {% else %}
                        -
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
    
    <!-- Form 001 근골격계 관련 정보 -->
    {% if not survey.form_type or '001' in (survey.form_type or '') %}
    <div class="card mb-4">
        <div class="card-header bg-warning">
            <h5 class="mb-0">작업 정보</h5>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-4">
                    <strong>작업형태:</strong><br>
                    {{ survey.work_type or '-' }}
                </div>
                <div class="col-md-4">
                    <strong>1일 근무시간:</strong><br>
                    {{ survey.work_hours_per_day or '-' }}시간
                </div>
                <div class="col-md-4">
                    <strong>휴식시간:</strong><br>
                    {{ survey.break_time_minutes or '-' }}분
                </div>
            </div>
            {% if survey.work_posture %}
            <hr>
            <div class="row">
                <div class="col-12">
                    <strong>작업 자세:</strong><br>
                    {{ survey.work_posture }}
                </div>
            </div>
            {% endif %}
        </div>
    </div>
    
    <!-- 증상 정보 -->
    <div class="card mb-4">
        <div class="card-header bg-danger text-white">
            <h5 class="mb-0">증상 정보</h5>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-sm">
                    <thead>
                        <tr>
                            <th>부위</th>
                            <th>통증정도</th>
                            <th>증상</th>
                            <th>빈도</th>
                            <th>지속기간</th>
                            <th>강도</th>
                            <th>업무영향</th>
                            <th>지난1년</th>
                            <th>지난1주</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- 목/어깨 -->
                        <tr>
                            <td><strong>목/어깨</strong></td>
                            <td>
                                {% if survey.responses and survey.responses.data and survey.responses.data.symptom_parts %}
                                    {% if "목/어깨" in survey.responses.data.symptom_parts %}
                                        {{ survey.responses.data.symptom_severity or '-' }}
                                    {% else %}
                                        -
                                    {% endif %}
                                {% else %}
                                    -
                                {% endif %}
                            </td>
                            <td>증상있음</td>
                            <td>-</td>
                            <td>-</td>
                            <td>{{ survey.responses.data.symptom_severity if survey.responses and survey.responses.data else '-' }}</td>
                            <td>-</td>
                            <td>-</td>
                            <td>-</td>
                        </tr>
                        <!-- 허리 -->
                        <tr>
                            <td><strong>허리</strong></td>
                            <td>
                                {% if survey.responses and survey.responses.data and survey.responses.data.symptom_parts %}
                                    {% if "허리" in survey.responses.data.symptom_parts %}
                                        {{ survey.responses.data.symptom_severity or '-' }}
                                    {% else %}
                                        -
                                    {% endif %}
                                {% else %}
                                    -
                                {% endif %}
                            </td>
                            <td>증상있음</td>
                            <td>-</td>
                            <td>-</td>
                            <td>{{ survey.responses.data.symptom_severity if survey.responses and survey.responses.data else '-' }}</td>
                            <td>-</td>
                            <td>-</td>
                            <td>-</td>
                        </tr>
                        <!-- 다리/발 -->
                        <tr>
                            <td><strong>다리/발</strong></td>
                            <td>
                                {% if survey.responses and survey.responses.data and survey.responses.data.symptom_parts %}
                                    {% if "다리/발" in survey.responses.data.symptom_parts %}
                                        {{ survey.responses.data.symptom_severity or '-' }}
                                    {% else %}
                                        -
                                    {% endif %}
                                {% else %}
                                    -
                                {% endif %}
                            </td>
                            <td>증상있음</td>
                            <td>-</td>
                            <td>-</td>
                            <td>{{ survey.responses.data.symptom_severity if survey.responses and survey.responses.data else '-' }}</td>
                            <td>-</td>
                            <td>-</td>
                            <td>-</td>
                        </tr>
                        <!-- 작업환경 정보 -->
                        <tr>
                            <td><strong>작업환경</strong></td>
                            <td colspan="8">
                                {% if survey.responses and survey.responses.data %}
                                    근무시간: {{ survey.responses.data.daily_hours or '-' }}시간<br>
                                    작업환경: {{ survey.responses.data.work_environment or '-' }}<br>
                                    증상여부: {{ '있음' if survey.responses.data.has_symptoms else '없음' }}
                                {% else %}
                                    -
                                {% endif %}
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    {% endif %}
    
    <!-- Form 002 신규입사자 관련 정보 -->
    {% if survey.form_type and '002' in survey.form_type %}
    <div class="card mb-4">
        <div class="card-header bg-info text-white">
            <h5 class="mb-0">신체 정보</h5>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-3">
                    <strong>신장:</strong><br>
                    {{ survey.height_cm or '-' }} cm
                </div>
                <div class="col-md-3">
                    <strong>체중:</strong><br>
                    {{ survey.weight_kg or '-' }} kg
                </div>
                <div class="col-md-3">
                    <strong>BMI:</strong><br>
                    {% if survey.height_cm and survey.weight_kg %}
                        {{ ((survey.weight_kg / ((survey.height_cm/100) ** 2)) | round(1)) }}
                    {% else %}
                        -
                    {% endif %}
                </div>
                <div class="col-md-3">
                    <strong>혈액형:</strong><br>
                    {{ survey.blood_type or '-' }}
                </div>
            </div>
        </div>
    </div>
    
    <div class="card mb-4">
        <div class="card-header bg-warning">
            <h5 class="mb-0">건강 이력</h5>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-12 mb-3">
                    <strong>기존 질환:</strong><br>
                    {{ survey.existing_conditions or '없음' }}
                </div>
                <div class="col-md-12 mb-3">
                    <strong>복용 약물:</strong><br>
                    {{ survey.medication_history or '없음' }}
                </div>
                <div class="col-md-12">
                    <strong>알레르기 이력:</strong><br>
                    {{ survey.allergy_history or '없음' }}
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- 설문 응답 데이터 (제출한 그대로) -->
    {% if survey.responses %}
    <div class="card mb-4">
        <div class="card-header bg-success text-white">
            <h5 class="mb-0">📝 설문 제출 데이터 (원본)</h5>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-bordered">
                    <thead class="thead-light">
                        <tr>
                            <th style="width: 30%;">항목</th>
                            <th>응답 내용</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for key, value in survey.responses.items() %}
                            {% if key not in ['csrf_token'] %}
                            <tr>
                                <td><strong>{{ key }}</strong></td>
                                <td>
                                    {% if value is iterable and value is not string %}
                                        {% if key == 'musculo_details' %}
                                            <!-- 근골격계 상세 데이터 특별 표시 -->
                                            {% for detail in value %}
                                            <div class="border p-2 mb-2">
                                                <strong>부위:</strong> {{ detail.part or '-' }}<br>
                                                <strong>측면:</strong> {{ detail.side or '-' }}<br>
                                                <strong>지속기간:</strong> {{ detail.duration or '-' }}<br>
                                                <strong>심각도:</strong> {{ detail.severity or '-' }}<br>
                                                <strong>빈도:</strong> {{ detail.frequency or '-' }}<br>
                                                <strong>지난주:</strong> {{ detail.last_week or '-' }}<br>
                                                <strong>결과:</strong> {{ detail.consequences|join(', ') if detail.consequences else '-' }}
                                            </div>
                                            {% endfor %}
                                        {% else %}
                                            {{ value|join(', ') if value else '-' }}
                                        {% endif %}
                                    {% else %}
                                        {{ value or '-' }}
                                    {% endif %}
                                </td>
                            </tr>
                            {% endif %}
                        {% endfor %}
                    </tbody>
                </table>
            </div>

            <!-- JSON 원본 데이터도 표시 -->
            <details class="mt-3">
                <summary><strong>JSON 원본 데이터 보기</strong></summary>
                <pre class="bg-light p-3 mt-2"><code>{{ survey.responses|tojson(indent=2) }}</code></pre>
            </details>
        </div>
    </div>
    {% endif %}

    <!-- 작업 버튼 -->
    <div class="mb-5">
        <a href="{{ url_for('admin.survey') }}" class="btn btn-secondary">
            <i class="bi bi-arrow-left"></i> 목록으로
        </a>
        <button onclick="window.print()" class="btn btn-primary">
            <i class="bi bi-printer"></i> 인쇄
        </button>
    </div>
</div>
{% endblock %}