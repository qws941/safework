{% extends "base.html" %}

{% block title %}근골격계질환 예방관리 프로그램 조사표{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row justify-content-center">
        <div class="col-lg-10">
            <div class="card shadow-sm">
                <div class="card-header bg-primary text-white">
                    <h4 class="mb-0">
                        <i class="fas fa-user-md"></i>
                        근골격계질환 예방관리 프로그램 조사표 (003)
                    </h4>
                    <p class="mb-0 mt-2">
                        <small>근골격계 질환 예방을 위한 종합 건강 조사표입니다. 모든 항목을 정확히 작성해 주세요.</small>
                    </p>
                </div>
                <div class="card-body">
                    <form method="POST" id="musculoskeletalForm">
                        <!-- 기본 정보 섹션 -->
                        <div class="section-header">
                            <h5 class="text-primary">
                                <i class="fas fa-user"></i> 기본 정보
                            </h5>
                        </div>

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="name" class="form-label required">성명</label>
                                <input type="text" class="form-control" name="name" id="name" required>
                            </div>
                            <div class="col-md-3 mb-3">
                                <label for="age" class="form-label required">나이</label>
                                <input type="number" class="form-control" name="age" id="age" min="18" max="100" required>
                            </div>
                            <div class="col-md-3 mb-3">
                                <label for="gender" class="form-label required">성별</label>
                                <select class="form-control" name="gender" id="gender" required>
                                    <option value="">선택하세요</option>
                                    <option value="남성">남성</option>
                                    <option value="여성">여성</option>
                                </select>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-4 mb-3">
                                <label for="department" class="form-label required">부서</label>
                                <input type="text" class="form-control" name="department" id="department" required>
                            </div>
                            <div class="col-md-4 mb-3">
                                <label for="position" class="form-label required">직위/직책</label>
                                <input type="text" class="form-control" name="position" id="position" required>
                            </div>
                            <div class="col-md-4 mb-3">
                                <label for="employee_number" class="form-label">사번</label>
                                <input type="text" class="form-control" name="employee_number" id="employee_number">
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-4 mb-3">
                                <label for="work_years" class="form-label">근무년수 (년)</label>
                                <input type="number" class="form-control" name="work_years" id="work_years" min="0" max="50">
                            </div>
                            <div class="col-md-4 mb-3">
                                <label for="work_months" class="form-label">근무월수 (월)</label>
                                <input type="number" class="form-control" name="work_months" id="work_months" min="0" max="11">
                            </div>
                            <div class="col-md-4 mb-3">
                                <label for="survey_date" class="form-label">조사일자</label>
                                <input type="date" class="form-control" name="survey_date" id="survey_date" value="{{ current_date }}">
                            </div>
                        </div>

                        <hr class="my-4">

                        <!-- 근골격계 증상 조사 섹션 -->
                        <div class="section-header">
                            <h5 class="text-primary">
                                <i class="fas fa-stethoscope"></i> 근골격계 증상 조사
                            </h5>
                            <p class="text-muted">
                                지난 1년 동안 각 신체 부위별 증상을 정확히 기록해 주세요.
                            </p>
                        </div>

                        <!-- 목/목덜미 -->
                        <div class="body-part-section" data-part="neck">
                            <h6 class="bg-light p-2 border-left border-primary">
                                <i class="fas fa-head-side-cough"></i> 목/목덜미
                            </h6>
                            <div class="row">
                                <div class="col-md-2 mb-3">
                                    <label class="form-label">통증/불편감</label>
                                    <div>
                                        <div class="form-check form-check-inline">
                                            <input class="form-check-input" type="radio" name="neck_pain" id="neck_pain_yes" value="예">
                                            <label class="form-check-label" for="neck_pain_yes">예</label>
                                        </div>
                                        <div class="form-check form-check-inline">
                                            <input class="form-check-input" type="radio" name="neck_pain" id="neck_pain_no" value="아니오">
                                            <label class="form-check-label" for="neck_pain_no">아니오</label>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-2 mb-3 conditional-field" data-condition="neck_pain_yes">
                                    <label class="form-label">지속기간</label>
                                    <select class="form-control" name="neck_duration">
                                        <option value="">선택</option>
                                        <option value="1일 미만">1일 미만</option>
                                        <option value="1-7일">1-7일</option>
                                        <option value="8-30일">8-30일</option>
                                        <option value="1-3개월">1-3개월</option>
                                        <option value="3개월 이상">3개월 이상</option>
                                    </select>
                                </div>
                                <div class="col-md-2 mb-3 conditional-field" data-condition="neck_pain_yes">
                                    <label class="form-label">강도 (1-10)</label>
                                    <input type="number" class="form-control" name="neck_intensity" min="1" max="10">
                                </div>
                                <div class="col-md-3 mb-3 conditional-field" data-condition="neck_pain_yes">
                                    <label class="form-label">발생빈도</label>
                                    <select class="form-control" name="neck_frequency">
                                        <option value="">선택</option>
                                        <option value="매일">매일</option>
                                        <option value="주 3-4회">주 3-4회</option>
                                        <option value="주 1-2회">주 1-2회</option>
                                        <option value="월 1-2회">월 1-2회</option>
                                        <option value="가끔">가끔</option>
                                    </select>
                                </div>
                                <div class="col-md-3 mb-3 conditional-field" data-condition="neck_pain_yes">
                                    <label class="form-label">일상생활 지장</label>
                                    <select class="form-control" name="neck_interference">
                                        <option value="">선택</option>
                                        <option value="전혀 없음">전혀 없음</option>
                                        <option value="약간">약간</option>
                                        <option value="보통">보통</option>
                                        <option value="심함">심함</option>
                                        <option value="매우 심함">매우 심함</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <!-- 어깨 -->
                        <div class="body-part-section" data-part="shoulder">
                            <h6 class="bg-light p-2 border-left border-primary">
                                <i class="fas fa-user-circle"></i> 어깨
                            </h6>
                            <div class="row">
                                <div class="col-md-2 mb-3">
                                    <label class="form-label">통증/불편감</label>
                                    <div>
                                        <div class="form-check form-check-inline">
                                            <input class="form-check-input" type="radio" name="shoulder_pain" id="shoulder_pain_yes" value="예">
                                            <label class="form-check-label" for="shoulder_pain_yes">예</label>
                                        </div>
                                        <div class="form-check form-check-inline">
                                            <input class="form-check-input" type="radio" name="shoulder_pain" id="shoulder_pain_no" value="아니오">
                                            <label class="form-check-label" for="shoulder_pain_no">아니오</label>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-2 mb-3 conditional-field" data-condition="shoulder_pain_yes">
                                    <label class="form-label">지속기간</label>
                                    <select class="form-control" name="shoulder_duration">
                                        <option value="">선택</option>
                                        <option value="1일 미만">1일 미만</option>
                                        <option value="1-7일">1-7일</option>
                                        <option value="8-30일">8-30일</option>
                                        <option value="1-3개월">1-3개월</option>
                                        <option value="3개월 이상">3개월 이상</option>
                                    </select>
                                </div>
                                <div class="col-md-2 mb-3 conditional-field" data-condition="shoulder_pain_yes">
                                    <label class="form-label">강도 (1-10)</label>
                                    <input type="number" class="form-control" name="shoulder_intensity" min="1" max="10">
                                </div>
                                <div class="col-md-3 mb-3 conditional-field" data-condition="shoulder_pain_yes">
                                    <label class="form-label">발생빈도</label>
                                    <select class="form-control" name="shoulder_frequency">
                                        <option value="">선택</option>
                                        <option value="매일">매일</option>
                                        <option value="주 3-4회">주 3-4회</option>
                                        <option value="주 1-2회">주 1-2회</option>
                                        <option value="월 1-2회">월 1-2회</option>
                                        <option value="가끔">가끔</option>
                                    </select>
                                </div>
                                <div class="col-md-3 mb-3 conditional-field" data-condition="shoulder_pain_yes">
                                    <label class="form-label">일상생활 지장</label>
                                    <select class="form-control" name="shoulder_interference">
                                        <option value="">선택</option>
                                        <option value="전혀 없음">전혀 없음</option>
                                        <option value="약간">약간</option>
                                        <option value="보통">보통</option>
                                        <option value="심함">심함</option>
                                        <option value="매우 심함">매우 심함</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <!-- 팔/팔꿈치 -->
                        <div class="body-part-section" data-part="arm_elbow">
                            <h6 class="bg-light p-2 border-left border-primary">
                                <i class="fas fa-hand-paper"></i> 팔/팔꿈치
                            </h6>
                            <div class="row">
                                <div class="col-md-2 mb-3">
                                    <label class="form-label">통증/불편감</label>
                                    <div>
                                        <div class="form-check form-check-inline">
                                            <input class="form-check-input" type="radio" name="arm_elbow_pain" id="arm_elbow_pain_yes" value="예">
                                            <label class="form-check-label" for="arm_elbow_pain_yes">예</label>
                                        </div>
                                        <div class="form-check form-check-inline">
                                            <input class="form-check-input" type="radio" name="arm_elbow_pain" id="arm_elbow_pain_no" value="아니오">
                                            <label class="form-check-label" for="arm_elbow_pain_no">아니오</label>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-2 mb-3 conditional-field" data-condition="arm_elbow_pain_yes">
                                    <label class="form-label">지속기간</label>
                                    <select class="form-control" name="arm_elbow_duration">
                                        <option value="">선택</option>
                                        <option value="1일 미만">1일 미만</option>
                                        <option value="1-7일">1-7일</option>
                                        <option value="8-30일">8-30일</option>
                                        <option value="1-3개월">1-3개월</option>
                                        <option value="3개월 이상">3개월 이상</option>
                                    </select>
                                </div>
                                <div class="col-md-2 mb-3 conditional-field" data-condition="arm_elbow_pain_yes">
                                    <label class="form-label">강도 (1-10)</label>
                                    <input type="number" class="form-control" name="arm_elbow_intensity" min="1" max="10">
                                </div>
                                <div class="col-md-3 mb-3 conditional-field" data-condition="arm_elbow_pain_yes">
                                    <label class="form-label">발생빈도</label>
                                    <select class="form-control" name="arm_elbow_frequency">
                                        <option value="">선택</option>
                                        <option value="매일">매일</option>
                                        <option value="주 3-4회">주 3-4회</option>
                                        <option value="주 1-2회">주 1-2회</option>
                                        <option value="월 1-2회">월 1-2회</option>
                                        <option value="가끔">가끔</option>
                                    </select>
                                </div>
                                <div class="col-md-3 mb-3 conditional-field" data-condition="arm_elbow_pain_yes">
                                    <label class="form-label">일상생활 지장</label>
                                    <select class="form-control" name="arm_elbow_interference">
                                        <option value="">선택</option>
                                        <option value="전혀 없음">전혀 없음</option>
                                        <option value="약간">약간</option>
                                        <option value="보통">보통</option>
                                        <option value="심함">심함</option>
                                        <option value="매우 심함">매우 심함</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <!-- 손/손가락/손목 -->
                        <div class="body-part-section" data-part="hand_wrist">
                            <h6 class="bg-light p-2 border-left border-primary">
                                <i class="fas fa-hand-rock"></i> 손/손가락/손목
                            </h6>
                            <div class="row">
                                <div class="col-md-2 mb-3">
                                    <label class="form-label">통증/불편감</label>
                                    <div>
                                        <div class="form-check form-check-inline">
                                            <input class="form-check-input" type="radio" name="hand_wrist_pain" id="hand_wrist_pain_yes" value="예">
                                            <label class="form-check-label" for="hand_wrist_pain_yes">예</label>
                                        </div>
                                        <div class="form-check form-check-inline">
                                            <input class="form-check-input" type="radio" name="hand_wrist_pain" id="hand_wrist_pain_no" value="아니오">
                                            <label class="form-check-label" for="hand_wrist_pain_no">아니오</label>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-2 mb-3 conditional-field" data-condition="hand_wrist_pain_yes">
                                    <label class="form-label">지속기간</label>
                                    <select class="form-control" name="hand_wrist_duration">
                                        <option value="">선택</option>
                                        <option value="1일 미만">1일 미만</option>
                                        <option value="1-7일">1-7일</option>
                                        <option value="8-30일">8-30일</option>
                                        <option value="1-3개월">1-3개월</option>
                                        <option value="3개월 이상">3개월 이상</option>
                                    </select>
                                </div>
                                <div class="col-md-2 mb-3 conditional-field" data-condition="hand_wrist_pain_yes">
                                    <label class="form-label">강도 (1-10)</label>
                                    <input type="number" class="form-control" name="hand_wrist_intensity" min="1" max="10">
                                </div>
                                <div class="col-md-3 mb-3 conditional-field" data-condition="hand_wrist_pain_yes">
                                    <label class="form-label">발생빈도</label>
                                    <select class="form-control" name="hand_wrist_frequency">
                                        <option value="">선택</option>
                                        <option value="매일">매일</option>
                                        <option value="주 3-4회">주 3-4회</option>
                                        <option value="주 1-2회">주 1-2회</option>
                                        <option value="월 1-2회">월 1-2회</option>
                                        <option value="가끔">가끔</option>
                                    </select>
                                </div>
                                <div class="col-md-3 mb-3 conditional-field" data-condition="hand_wrist_pain_yes">
                                    <label class="form-label">일상생활 지장</label>
                                    <select class="form-control" name="hand_wrist_interference">
                                        <option value="">선택</option>
                                        <option value="전혀 없음">전혀 없음</option>
                                        <option value="약간">약간</option>
                                        <option value="보통">보통</option>
                                        <option value="심함">심함</option>
                                        <option value="매우 심함">매우 심함</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <!-- 허리 -->
                        <div class="body-part-section" data-part="back">
                            <h6 class="bg-light p-2 border-left border-primary">
                                <i class="fas fa-walking"></i> 허리
                            </h6>
                            <div class="row">
                                <div class="col-md-2 mb-3">
                                    <label class="form-label">통증/불편감</label>
                                    <div>
                                        <div class="form-check form-check-inline">
                                            <input class="form-check-input" type="radio" name="back_pain" id="back_pain_yes" value="예">
                                            <label class="form-check-label" for="back_pain_yes">예</label>
                                        </div>
                                        <div class="form-check form-check-inline">
                                            <input class="form-check-input" type="radio" name="back_pain" id="back_pain_no" value="아니오">
                                            <label class="form-check-label" for="back_pain_no">아니오</label>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-2 mb-3 conditional-field" data-condition="back_pain_yes">
                                    <label class="form-label">지속기간</label>
                                    <select class="form-control" name="back_duration">
                                        <option value="">선택</option>
                                        <option value="1일 미만">1일 미만</option>
                                        <option value="1-7일">1-7일</option>
                                        <option value="8-30일">8-30일</option>
                                        <option value="1-3개월">1-3개월</option>
                                        <option value="3개월 이상">3개월 이상</option>
                                    </select>
                                </div>
                                <div class="col-md-2 mb-3 conditional-field" data-condition="back_pain_yes">
                                    <label class="form-label">강도 (1-10)</label>
                                    <input type="number" class="form-control" name="back_intensity" min="1" max="10">
                                </div>
                                <div class="col-md-3 mb-3 conditional-field" data-condition="back_pain_yes">
                                    <label class="form-label">발생빈도</label>
                                    <select class="form-control" name="back_frequency">
                                        <option value="">선택</option>
                                        <option value="매일">매일</option>
                                        <option value="주 3-4회">주 3-4회</option>
                                        <option value="주 1-2회">주 1-2회</option>
                                        <option value="월 1-2회">월 1-2회</option>
                                        <option value="가끔">가끔</option>
                                    </select>
                                </div>
                                <div class="col-md-3 mb-3 conditional-field" data-condition="back_pain_yes">
                                    <label class="form-label">일상생활 지장</label>
                                    <select class="form-control" name="back_interference">
                                        <option value="">선택</option>
                                        <option value="전혀 없음">전혀 없음</option>
                                        <option value="약간">약간</option>
                                        <option value="보통">보통</option>
                                        <option value="심함">심함</option>
                                        <option value="매우 심함">매우 심함</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <!-- 다리/발 -->
                        <div class="body-part-section" data-part="leg_foot">
                            <h6 class="bg-light p-2 border-left border-primary">
                                <i class="fas fa-shoe-prints"></i> 다리/발
                            </h6>
                            <div class="row">
                                <div class="col-md-2 mb-3">
                                    <label class="form-label">통증/불편감</label>
                                    <div>
                                        <div class="form-check form-check-inline">
                                            <input class="form-check-input" type="radio" name="leg_foot_pain" id="leg_foot_pain_yes" value="예">
                                            <label class="form-check-label" for="leg_foot_pain_yes">예</label>
                                        </div>
                                        <div class="form-check form-check-inline">
                                            <input class="form-check-input" type="radio" name="leg_foot_pain" id="leg_foot_pain_no" value="아니오">
                                            <label class="form-check-label" for="leg_foot_pain_no">아니오</label>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-2 mb-3 conditional-field" data-condition="leg_foot_pain_yes">
                                    <label class="form-label">지속기간</label>
                                    <select class="form-control" name="leg_foot_duration">
                                        <option value="">선택</option>
                                        <option value="1일 미만">1일 미만</option>
                                        <option value="1-7일">1-7일</option>
                                        <option value="8-30일">8-30일</option>
                                        <option value="1-3개월">1-3개월</option>
                                        <option value="3개월 이상">3개월 이상</option>
                                    </select>
                                </div>
                                <div class="col-md-2 mb-3 conditional-field" data-condition="leg_foot_pain_yes">
                                    <label class="form-label">강도 (1-10)</label>
                                    <input type="number" class="form-control" name="leg_foot_intensity" min="1" max="10">
                                </div>
                                <div class="col-md-3 mb-3 conditional-field" data-condition="leg_foot_pain_yes">
                                    <label class="form-label">발생빈도</label>
                                    <select class="form-control" name="leg_foot_frequency">
                                        <option value="">선택</option>
                                        <option value="매일">매일</option>
                                        <option value="주 3-4회">주 3-4회</option>
                                        <option value="주 1-2회">주 1-2회</option>
                                        <option value="월 1-2회">월 1-2회</option>
                                        <option value="가끔">가끔</option>
                                    </select>
                                </div>
                                <div class="col-md-3 mb-3 conditional-field" data-condition="leg_foot_pain_yes">
                                    <label class="form-label">일상생활 지장</label>
                                    <select class="form-control" name="leg_foot_interference">
                                        <option value="">선택</option>
                                        <option value="전혀 없음">전혀 없음</option>
                                        <option value="약간">약간</option>
                                        <option value="보통">보통</option>
                                        <option value="심함">심함</option>
                                        <option value="매우 심함">매우 심함</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <hr class="my-4">

                        <!-- 추가 정보 섹션 -->
                        <div class="section-header">
                            <h5 class="text-primary">
                                <i class="fas fa-notes-medical"></i> 추가 정보
                            </h5>
                        </div>

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="work_environment" class="form-label">주요 작업환경</label>
                                <textarea class="form-control" name="work_environment" id="work_environment" rows="3" placeholder="예: 컴퓨터 작업, 중량물 취급, 반복작업 등"></textarea>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="additional_symptoms" class="form-label">기타 증상 또는 특이사항</label>
                                <textarea class="form-control" name="additional_symptoms" id="additional_symptoms" rows="3" placeholder="기타 증상이나 특이사항이 있으면 기록해 주세요"></textarea>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="previous_treatment" class="form-label">이전 치료 경험</label>
                                <select class="form-control" name="previous_treatment" id="previous_treatment">
                                    <option value="">선택하세요</option>
                                    <option value="없음">없음</option>
                                    <option value="물리치료">물리치료</option>
                                    <option value="약물치료">약물치료</option>
                                    <option value="수술">수술</option>
                                    <option value="기타">기타</option>
                                </select>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="exercise_habit" class="form-label">운동 습관</label>
                                <select class="form-control" name="exercise_habit" id="exercise_habit">
                                    <option value="">선택하세요</option>
                                    <option value="매일">매일</option>
                                    <option value="주 3-4회">주 3-4회</option>
                                    <option value="주 1-2회">주 1-2회</option>
                                    <option value="월 1-2회">월 1-2회</option>
                                    <option value="거의 안함">거의 안함</option>
                                </select>
                            </div>
                        </div>

                        <!-- 관리 분류 결과 표시 (JavaScript로 자동 계산) -->
                        <div class="alert alert-info" id="management_classification_result" style="display: none;">
                            <h6><i class="fas fa-chart-line"></i> 관리 분류 결과</h6>
                            <p id="classification_text"></p>
                            <small class="text-muted">* 이 결과는 설문 응답을 바탕으로 자동 계산된 예비 분류입니다.</small>
                        </div>

                        <div class="form-group text-center mt-4">
                            <button type="submit" class="btn btn-primary btn-lg">
                                <i class="fas fa-save"></i> 조사표 제출
                            </button>
                            <a href="{{ url_for('survey.survey_index') }}" class="btn btn-secondary btn-lg ml-2">
                                <i class="fas fa-arrow-left"></i> 목록으로
                            </a>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.section-header {
    margin-bottom: 1.5rem;
    padding-bottom: 0.5rem;
    border-bottom: 2px solid #e9ecef;
}

.body-part-section {
    margin-bottom: 2rem;
    padding: 1rem;
    border: 1px solid #e9ecef;
    border-radius: 0.5rem;
    background-color: #f8f9fa;
}

.body-part-section h6 {
    margin: -1rem -1rem 1rem -1rem;
    padding: 0.75rem 1rem;
    background-color: #f8f9fa !important;
    border-radius: 0.5rem 0.5rem 0 0;
    border-left: 4px solid #007bff !important;
}

.conditional-field {
    display: none;
}

.required:after {
    content: " *";
    color: red;
}

.form-check-input:checked + .form-check-label {
    font-weight: bold;
}

.alert-info {
    border-left: 4px solid #17a2b8;
}

.btn-lg {
    padding: 0.75rem 1.5rem;
    font-size: 1.1rem;
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // 조건부 필드 표시/숨김 처리
    const bodyParts = ['neck', 'shoulder', 'arm_elbow', 'hand_wrist', 'back', 'leg_foot'];

    bodyParts.forEach(function(part) {
        const yesRadio = document.getElementById(part + '_pain_yes');
        const noRadio = document.getElementById(part + '_pain_no');
        const conditionalFields = document.querySelectorAll('.conditional-field[data-condition="' + part + '_pain_yes"]');

        function toggleConditionalFields() {
            const shouldShow = yesRadio && yesRadio.checked;
            conditionalFields.forEach(function(field) {
                field.style.display = shouldShow ? 'block' : 'none';
                // 숨김 처리시 입력값 초기화
                if (!shouldShow) {
                    const inputs = field.querySelectorAll('input, select');
                    inputs.forEach(function(input) {
                        input.value = '';
                    });
                }
            });

            // 관리 분류 자동 계산
            calculateManagementClassification();
        }

        if (yesRadio) yesRadio.addEventListener('change', toggleConditionalFields);
        if (noRadio) noRadio.addEventListener('change', toggleConditionalFields);
    });

    // 관리 분류 자동 계산 함수
    function calculateManagementClassification() {
        let managementTargets = 0;
        let painComplaints = 0;

        bodyParts.forEach(function(part) {
            const painRadio = document.querySelector('input[name="' + part + '_pain"]:checked');
            if (painRadio && painRadio.value === '예') {
                const duration = document.querySelector('select[name="' + part + '_duration"]').value;
                const frequency = document.querySelector('select[name="' + part + '_frequency"]').value;
                const intensity = parseInt(document.querySelector('input[name="' + part + '_intensity"]').value) || 0;
                const interference = document.querySelector('select[name="' + part + '_interference"]').value;

                // 관리대상자 기준 체크
                const isManagementTarget = (
                    duration === '3개월 이상' ||
                    frequency === '매일' ||
                    intensity >= 5 ||
                    interference === '심함' || interference === '매우 심함'
                );

                if (isManagementTarget) {
                    managementTargets++;
                } else {
                    painComplaints++;
                }
            }
        });

        // 분류 결과 결정
        let classification = '';
        let description = '';

        if (managementTargets > 0) {
            classification = '관리대상자';
            description = '근골격계 질환 발생 위험이 높은 상태입니다. 의학적 평가와 적극적인 관리가 필요합니다.';
        } else if (painComplaints > 0) {
            classification = '통증호소자';
            description = '근골격계 증상이 있지만 경미한 상태입니다. 예방적 관리와 주기적 관찰이 필요합니다.';
        } else {
            classification = '정상';
            description = '현재 특별한 근골격계 증상이 없는 상태입니다. 예방 교육과 주기적 점검을 권장합니다.';
        }

        // 결과 표시
        if (classification) {
            const resultDiv = document.getElementById('management_classification_result');
            const classificationText = document.getElementById('classification_text');

            classificationText.innerHTML = '<strong>분류:</strong> ' + classification + '<br><strong>설명:</strong> ' + description;
            resultDiv.style.display = 'block';

            // 분류에 따른 색상 변경
            resultDiv.className = 'alert ' + (
                classification === '관리대상자' ? 'alert-danger' :
                classification === '통증호소자' ? 'alert-warning' : 'alert-success'
            );
        }
    }

    // 현재 날짜 설정
    const today = new Date().toISOString().split('T')[0];
    const surveyDateField = document.getElementById('survey_date');
    if (surveyDateField && !surveyDateField.value) {
        surveyDateField.value = today;
    }

    // 폼 제출 전 검증
    document.getElementById('musculoskeletalForm').addEventListener('submit', function(e) {
        const requiredFields = document.querySelectorAll('input[required], select[required]');
        let isValid = true;

        requiredFields.forEach(function(field) {
            if (!field.value.trim()) {
                isValid = false;
                field.classList.add('is-invalid');
            } else {
                field.classList.remove('is-invalid');
            }
        });

        if (!isValid) {
            e.preventDefault();
            alert('필수 항목을 모두 입력해 주세요.');
            return false;
        }

        // 제출 확인
        if (!confirm('조사표를 제출하시겠습니까?')) {
            e.preventDefault();
            return false;
        }
    });
});
</script>
{% endblock %}