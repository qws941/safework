name: Pull Request CI

on:
  pull_request:
    branches: [ main, develop ]
    types: [opened, synchronize, reopened]

jobs:
  # PR ì½”ë“œ í’ˆì§ˆ ê²€ì‚¬
  quality-check:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        
    - name: Install dependencies
      run: |
        cd app
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install flake8 black pytest safety
        
    - name: Code formatting check
      run: |
        cd app
        black --check --line-length 100 . || echo "âŒ Code formatting issues found"
        
    - name: Lint check
      run: |
        cd app
        flake8 --max-line-length=100 --ignore=E501,W503 --exclude=migrations . || echo "âŒ Lint issues found"
        
    - name: Security check
      run: |
        cd app
        safety check || echo "âš ï¸ Security vulnerabilities found"
        
    - name: Run tests
      run: |
        cd app
        FLASK_CONFIG=testing python -m pytest tests/ -v --tb=short || echo "âŒ Tests failed"
      
  # Docker ë¹Œë“œ í…ŒìŠ¤íŠ¸
  build-test:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        service: [app, mysql, redis]
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
      
    - name: Build test image
      uses: docker/build-push-action@v5
      with:
        context: ./${{ matrix.service }}
        file: ./${{ matrix.service }}/Dockerfile
        push: false
        tags: safework/${{ matrix.service }}:test
        cache-from: type=gha
        cache-to: type=gha,mode=max
        
    - name: Test image
      run: |
        echo "âœ… ${{ matrix.service }} image built successfully"
        
  # PR ê²€í†  ìš”ì•½
  pr-summary:
    needs: [quality-check, build-test]
    runs-on: ubuntu-latest
    if: always()
    steps:
    - name: PR Check Summary
      run: |
        echo "## ğŸ“‹ Pull Request ê²€í†  ê²°ê³¼"
        echo "### ì½”ë“œ í’ˆì§ˆ ê²€ì‚¬: ${{ needs.quality-check.result }}"
        echo "### Docker ë¹Œë“œ í…ŒìŠ¤íŠ¸: ${{ needs.build-test.result }}"
        echo ""
        if [ "${{ needs.quality-check.result }}" = "success" ] && [ "${{ needs.build-test.result }}" = "success" ]; then
          echo "âœ… **ëª¨ë“  ê²€ì‚¬ê°€ ì„±ê³µí–ˆìŠµë‹ˆë‹¤. ë³‘í•© ì¤€ë¹„ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.**"
        else
          echo "âŒ **ì¼ë¶€ ê²€ì‚¬ì—ì„œ ë¬¸ì œê°€ ë°œê²¬ë˜ì—ˆìŠµë‹ˆë‹¤. ìˆ˜ì • í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.**"
        fi