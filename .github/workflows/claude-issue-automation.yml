name: Claude Issue Automation

on:
  issues:
    types: [opened, labeled, assigned]
  issue_comment:
    types: [created]

env:
  ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}

jobs:
  claude-issue-handler:
    if: |
      (github.event_name == 'issues' && 
       (contains(github.event.issue.labels.*.name, 'enhancement') || 
        contains(github.event.issue.labels.*.name, 'bug') ||
        contains(github.event.issue.labels.*.name, 'P0'))) ||
      (github.event_name == 'issue_comment' && contains(github.event.comment.body, '@claude'))
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: Setup Claude Code Action
      uses: anthropics/claude-code-action@v1
      with:
        anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
        github_token: ${{ secrets.GITHUB_TOKEN }}
        max_turns: 10
        prompt: |
          SafeWork í”„ë¡œì íŠ¸ì˜ GitHub ì´ìŠˆ ìë™ ì²˜ë¦¬ë¥¼ ìˆ˜í–‰í•©ë‹ˆë‹¤.
          
          **í”„ë¡œì íŠ¸ ì»¨í…ìŠ¤íŠ¸:**
          - Flask 3.0+ ê¸°ë°˜ ì•ˆì „ë³´ê±´ ê´€ë¦¬ ì‹œìŠ¤í…œ
          - MySQL + Redis + Docker í™˜ê²½
          - 001/002 ì„¤ë¬¸ ì‹œìŠ¤í…œ ë° SafeWork v2 ê´€ë¦¬ ëŒ€ì‹œë³´ë“œ
          
          **ì²˜ë¦¬ ë‹¨ê³„:**
          1. ì´ìŠˆ #${{ github.event.issue.number || github.event.issue.number }} ë‚´ìš© ë¶„ì„
          2. ê´€ë ¨ ì½”ë“œë² ì´ìŠ¤ ê²€í†  (templates/, routes/, models/)
          3. SafeWork í”„ë¡œì íŠ¸ íŒ¨í„´ì— ë§ëŠ” êµ¬í˜„
          4. í…ŒìŠ¤íŠ¸ ì‹¤í–‰ìœ¼ë¡œ ê²€ì¦
          5. PR ìƒì„± (ê°€ëŠ¥í•œ ê²½ìš°)
          
          **ìš°ì„ ìˆœìœ„:**
          - P0 ë¼ë²¨: ì¦‰ì‹œ ì²˜ë¦¬
          - enhancement: ê¸°ëŠ¥ ê°œì„ 
          - bug: ë²„ê·¸ ìˆ˜ì •
          
          **ì¤€ìˆ˜ì‚¬í•­:**
          - CLAUDE.md ê°€ì´ë“œë¼ì¸ ì¤€ìˆ˜
          - Flask ëª¨ë²”ì‚¬ë¡€ ì ìš©
          - ê¸°ì¡´ ì½”ë“œ ìŠ¤íƒ€ì¼ ìœ ì§€
          - Docker í™˜ê²½ì—ì„œ í…ŒìŠ¤íŠ¸

    - name: Auto-assign issue
      if: github.event_name == 'issues' && github.event.action == 'opened'
      run: |
        gh issue edit ${{ github.event.issue.number }} --add-assignee qws941
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Label high priority issues  
      if: contains(github.event.issue.title, '[URGENT]') || contains(github.event.issue.title, '[P0]')
      run: |
        gh issue edit ${{ github.event.issue.number }} --add-label "priority:high,needs-review"
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Setup Docker environment for testing
      run: |
        docker-compose -f docker-compose.yml up -d
        sleep 30  # Wait for services to be ready
        
    - name: Run tests after changes
      run: |
        docker exec safework-app python3 -m pytest tests/ -v --tb=short
      continue-on-error: true

    - name: Check application health
      run: |
        curl -f http://localhost:4545/health || echo "Health check failed"

    - name: Comment on issue with results
      if: always()
      run: |
        gh issue comment ${{ github.event.issue.number }} --body "ğŸ¤– Claude ìë™ ì²˜ë¦¬ ì™„ë£Œ
        
        **ì²˜ë¦¬ ê²°ê³¼:**
        - ì›Œí¬í”Œë¡œìš° ìƒíƒœ: ${{ job.status }}
        - ì‹¤í–‰ ì‹œê°„: $(date)
        - ì‹¤í–‰ ë¡œê·¸: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
        
        **ë‹¤ìŒ ë‹¨ê³„:**
        - ìƒì„±ëœ PR ê²€í†  (í•´ë‹¹ì‹œ)
        - ì¶”ê°€ í…ŒìŠ¤íŠ¸ í•„ìš”ì‹œ @claude ë©˜ì…˜ìœ¼ë¡œ ìš”ì²­
        
        ë¬¸ì œê°€ ìˆë‹¤ë©´ ìˆ˜ë™ ê²€í† ê°€ í•„ìš”í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤."
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}