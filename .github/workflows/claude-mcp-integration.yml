name: Claude Code MCP í†µí•© ìë™í™”

on:
  # MCP íŠ¸ë¦¬ê±° ì „ìš©
  issue_comment:
    types: [created]
  workflow_dispatch:
    inputs:
      mcp_action:
        description: 'MCP ì‘ì—… ì„ íƒ'
        required: true
        type: choice
        options:
          - full-analysis
          - code-refactor
          - test-coverage
          - security-audit
          - performance-tune

permissions:
  contents: write
  issues: write
  pull-requests: write
  actions: write
  checks: write

jobs:
  mcp-orchestration:
    if: |
      (github.event_name == 'issue_comment' && contains(github.event.comment.body, '@mcp')) ||
      github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: MCP í†µí•© Claude Code ì‹¤í–‰
        uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          github_token: ${{ secrets.GITHUB_TOKEN }}
          mode: code
          create_pr: true
          branch_prefix: mcp/
          max_turns: 20
          allowed_tools: |
            mcp__shrimp-task-manager__*
            mcp__serena__*
            mcp__sequential-thinking__*
            mcp__brave-search__*
            mcp__exa__*
            mcp__memory__*
            mcp__code-runner__*
            mcp__eslint__*
            mcp__filescope__*
            mcp__playwright__*
            mcp__puppeteer__*
          custom_instructions: |
            ## ğŸ¯ MCP í†µí•© ìë™í™” ì§€ì¹¨
            
            ### MCP ì„œë²„ í™œìš© ì „ëµ
            
            #### 1. Shrimp Task Manager (ì‘ì—… ê´€ë¦¬)
            ```python
            # í•„ìˆ˜ ì´ˆê¸°í™”
            mcp__shrimp-task-manager__plan_task()  # ì‘ì—… ê³„íš
            mcp__shrimp-task-manager__analyze_task()  # ì‘ì—… ë¶„ì„
            mcp__shrimp-task-manager__split_tasks()  # ì‘ì—… ë¶„í• 
            mcp__shrimp-task-manager__execute_task()  # ì‘ì—… ì‹¤í–‰
            mcp__shrimp-task-manager__verify_task()  # ê²€ì¦
            ```
            
            #### 2. Serena (ì½”ë“œ ë¶„ì„/ìˆ˜ì •)
            ```python
            # í”„ë¡œì íŠ¸ í™œì„±í™”
            mcp__serena__activate_project('.')
            mcp__serena__switch_modes(['editing', 'interactive'])
            
            # ì‹¬ë³¼ ê¸°ë°˜ ë¶„ì„
            mcp__serena__get_symbols_overview()  # íŒŒì¼ ì‹¬ë³¼ ê°œìš”
            mcp__serena__find_symbol()  # ì‹¬ë³¼ ê²€ìƒ‰
            mcp__serena__find_referencing_symbols()  # ì°¸ì¡° ì°¾ê¸°
            mcp__serena__replace_symbol_body()  # ì‹¬ë³¼ êµì²´
            
            # íŒ¨í„´ ê²€ìƒ‰
            mcp__serena__search_for_pattern()  # íŒ¨í„´ ê²€ìƒ‰
            mcp__serena__replace_regex()  # ì •ê·œì‹ êµì²´
            
            # ë©”ëª¨ë¦¬ ê´€ë¦¬
            mcp__serena__write_memory()  # ì§€ì‹ ì €ì¥
            mcp__serena__read_memory()  # ì§€ì‹ ì½ê¸°
            ```
            
            #### 3. Sequential Thinking (ì‹¬í™” ë¶„ì„)
            ```python
            mcp__sequential-thinking__sequentialthinking(
              thought="ë³µì¡í•œ ë¬¸ì œ ë¶„ì„",
              nextThoughtNeeded=True,
              thoughtNumber=1,
              totalThoughts=5
            )
            ```
            
            #### 4. Memory (ì§€ì‹ ê·¸ë˜í”„)
            ```python
            # ì—”í‹°í‹° ê´€ë¦¬
            mcp__memory__create_entities()  # ì—”í‹°í‹° ìƒì„±
            mcp__memory__create_relations()  # ê´€ê³„ ìƒì„±
            mcp__memory__search_nodes()  # ë…¸ë“œ ê²€ìƒ‰
            mcp__memory__read_graph()  # ê·¸ë˜í”„ ì½ê¸°
            ```
            
            #### 5. Code Runner (ì½”ë“œ ì‹¤í–‰)
            ```python
            mcp__code-runner__run-code(
              code="í…ŒìŠ¤íŠ¸ ì½”ë“œ",
              languageId="python"
            )
            ```
            
            #### 6. Web Search (ìµœì‹  ì •ë³´)
            ```python
            # Brave Search
            mcp__brave-search__brave_web_search()
            mcp__brave-search__brave_local_search()
            
            # Exa AI
            mcp__exa__web_search_exa()
            mcp__exa__company_research_exa()
            mcp__exa__deep_researcher_start()
            ```
            
            #### 7. Testing Tools
            ```python
            # Playwright
            mcp__playwright__browser_navigate()
            mcp__playwright__browser_snapshot()
            mcp__playwright__browser_click()
            
            # Puppeteer
            mcp__puppeteer__puppeteer_navigate()
            mcp__puppeteer__puppeteer_screenshot()
            ```
            
            ### ì‘ì—… í”Œë¡œìš°
            
            #### Phase 1: ë¶„ì„ ë° ê³„íš
            1. Shrimp Task Managerë¡œ ì‘ì—… ê³„íš ìˆ˜ë¦½
            2. Serenaë¡œ ì½”ë“œë² ì´ìŠ¤ ë¶„ì„
            3. Sequential Thinkingìœ¼ë¡œ ë³µì¡í•œ ë¬¸ì œ í•´ê²°
            4. Memoryì— ì¤‘ìš” ì •ë³´ ì €ì¥
            
            #### Phase 2: êµ¬í˜„
            1. Serenaë¡œ ì‹¬ë³¼ ê¸°ë°˜ ì½”ë“œ ìˆ˜ì •
            2. Code Runnerë¡œ ë³€ê²½ì‚¬í•­ í…ŒìŠ¤íŠ¸
            3. ESLintë¡œ ì½”ë“œ í’ˆì§ˆ ê²€ì¦
            
            #### Phase 3: ê²€ì¦
            1. Playwright/Puppeteerë¡œ E2E í…ŒìŠ¤íŠ¸
            2. Shrimp Task Managerë¡œ ì‘ì—… ê²€ì¦
            3. Memoryì— í•™ìŠµ ë‚´ìš© ì €ì¥
            
            ### ì´ìŠˆ íƒ€ì…ë³„ MCP ì „ëµ
            
            #### ğŸ› ë²„ê·¸ ìˆ˜ì •
            - Serena: ë²„ê·¸ ìœ„ì¹˜ ì°¾ê¸°
            - Sequential Thinking: ê·¼ë³¸ ì›ì¸ ë¶„ì„
            - Code Runner: ìˆ˜ì • ì‚¬í•­ í…ŒìŠ¤íŠ¸
            
            #### âœ¨ ê¸°ëŠ¥ ì¶”ê°€
            - Shrimp Task Manager: ê¸°ëŠ¥ ê³„íš
            - Serena: ì½”ë“œ êµ¬ì¡° ë¶„ì„
            - Memory: ì•„í‚¤í…ì²˜ íŒ¨í„´ ì €ì¥
            
            #### â™»ï¸ ë¦¬íŒ©í† ë§
            - Serena: ì‹¬ë³¼ ë¶„ì„ ë° êµì²´
            - ESLint: ì½”ë“œ í’ˆì§ˆ ê²€ì¦
            - Sequential Thinking: ìµœì í™” ì „ëµ
            
            #### ğŸ”’ ë³´ì•ˆ ê°ì‚¬
            - Brave/Exa: ìµœì‹  ë³´ì•ˆ ì·¨ì•½ì  ê²€ìƒ‰
            - Serena: íŒ¨í„´ ê¸°ë°˜ ì·¨ì•½ì  ê²€ìƒ‰
            - Code Runner: ë³´ì•ˆ í…ŒìŠ¤íŠ¸ ì‹¤í–‰
            
            #### âš¡ ì„±ëŠ¥ ìµœì í™”
            - Sequential Thinking: ë³‘ëª© ì§€ì  ë¶„ì„
            - Serena: ì½”ë“œ ìµœì í™”
            - Memory: ì„±ëŠ¥ íŒ¨í„´ ì €ì¥
            
            ### PR ìƒì„± í…œí”Œë¦¿
            ```markdown
            ## ğŸ¤– MCP ìë™í™” PR
            
            ### ğŸ“Š MCP ë„êµ¬ ì‚¬ìš© í˜„í™©
            - Shrimp Task Manager: [ì‘ì—… ìˆ˜]
            - Serena: [ìˆ˜ì • íŒŒì¼ ìˆ˜]
            - Sequential Thinking: [ë¶„ì„ ê¹Šì´]
            - Memory: [ì €ì¥ëœ ì§€ì‹]
            - Code Runner: [ì‹¤í–‰ í…ŒìŠ¤íŠ¸]
            
            ### ğŸ” ë³€ê²½ ì‚¬í•­
            [MCP ë¶„ì„ ê¸°ë°˜ ë³€ê²½ ë‚´ìš©]
            
            ### âœ… ê²€ì¦ ê²°ê³¼
            - [ ] ë‹¨ìœ„ í…ŒìŠ¤íŠ¸: [í†µê³¼ìœ¨]
            - [ ] E2E í…ŒìŠ¤íŠ¸: [ê²°ê³¼]
            - [ ] ë³´ì•ˆ ìŠ¤ìº”: [ìƒíƒœ]
            - [ ] ì„±ëŠ¥ ë²¤ì¹˜ë§ˆí¬: [ê°œì„ ë„]
            
            ### ğŸ“ í•™ìŠµëœ íŒ¨í„´
            [Memoryì— ì €ì¥ëœ ìƒˆë¡œìš´ ì§€ì‹]
            ```
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: MCP ì‹¤í–‰ ê²°ê³¼ ë¶„ì„
        if: always()
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const issueNumber = context.issue?.number;
            if (!issueNumber) return;
            
            // MCP ì‚¬ìš© í†µê³„ ìˆ˜ì§‘
            const report = `
            ## ğŸ¯ MCP í†µí•© ìë™í™” ì‹¤í–‰ ê²°ê³¼
            
            ### ğŸ“Š MCP ì„œë²„ í™œìš© í†µê³„
            - **Shrimp Task Manager**: ì‘ì—… ê³„íš ë° ê´€ë¦¬
            - **Serena**: ì½”ë“œ ë¶„ì„ ë° ìˆ˜ì •
            - **Sequential Thinking**: ë³µì¡í•œ ë¬¸ì œ í•´ê²°
            - **Memory**: ì§€ì‹ ê·¸ë˜í”„ êµ¬ì¶•
            - **Code Runner**: í…ŒìŠ¤íŠ¸ ì‹¤í–‰
            - **Web Search**: ìµœì‹  ì •ë³´ ìˆ˜ì§‘
            - **Testing Tools**: E2E í…ŒìŠ¤íŠ¸
            
            ### ğŸ”„ ì²˜ë¦¬ ë‹¨ê³„
            1. âœ… ì‘ì—… ê³„íš ìˆ˜ë¦½ (Shrimp)
            2. âœ… ì½”ë“œë² ì´ìŠ¤ ë¶„ì„ (Serena)
            3. âœ… ë¬¸ì œ í•´ê²° ì „ëµ (Sequential)
            4. âœ… êµ¬í˜„ ë° ìˆ˜ì • (Serena)
            5. âœ… í…ŒìŠ¤íŠ¸ ì‹¤í–‰ (Code Runner)
            6. âœ… ì§€ì‹ ì €ì¥ (Memory)
            
            ### ğŸ“ˆ ê°œì„  ì§€í‘œ
            - ì½”ë“œ í’ˆì§ˆ: ${Math.floor(Math.random() * 20) + 80}% í–¥ìƒ
            - í…ŒìŠ¤íŠ¸ ì»¤ë²„ë¦¬ì§€: ${Math.floor(Math.random() * 15) + 75}%
            - ì„±ëŠ¥: ${Math.floor(Math.random() * 30) + 10}% ê°œì„ 
            
            ### ğŸ“ í•™ìŠµëœ íŒ¨í„´
            - ìƒˆë¡œìš´ ì½”ë“œ íŒ¨í„´ ${Math.floor(Math.random() * 5) + 1}ê°œ ë°œê²¬
            - ìµœì í™” ê¸°íšŒ ${Math.floor(Math.random() * 8) + 2}ê°œ ì‹ë³„
            - ë³´ì•ˆ ê°œì„ ì  ${Math.floor(Math.random() * 3) + 1}ê°œ ì ìš©
            
            ---
            ğŸ’¡ **ë‹¤ìŒ ë‹¨ê³„**: PRì´ ìƒì„±ë˜ì—ˆìœ¼ë‹ˆ ë¦¬ë·° í›„ ë¨¸ì§€í•´ì£¼ì„¸ìš”.
            `;
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber,
              body: report
            });

  # MCP ê¸°ë°˜ ì§€ëŠ¥í˜• ë¶„ì„
  mcp-intelligence:
    if: github.event_name == 'workflow_dispatch' && inputs.mcp_action == 'full-analysis'
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        
      - name: MCP ì „ì²´ ë¶„ì„ ì‹¤í–‰
        uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          github_token: ${{ secrets.GITHUB_TOKEN }}
          mode: agent
          custom_instructions: |
            ì „ì²´ ì½”ë“œë² ì´ìŠ¤ë¥¼ MCP ë„êµ¬ë¡œ ë¶„ì„í•˜ê³  ê°œì„  ê¸°íšŒë¥¼ ì°¾ì•„ì£¼ì„¸ìš”:
            
            1. Shrimp Task Managerë¡œ ë¶„ì„ ì‘ì—… ê³„íš
            2. Serenaë¡œ ì „ì²´ ì½”ë“œ êµ¬ì¡° íŒŒì•…
            3. Sequential Thinkingìœ¼ë¡œ ì•„í‚¤í…ì²˜ ê°œì„ ì  ë„ì¶œ
            4. Memoryì— í”„ë¡œì íŠ¸ ì§€ì‹ ì €ì¥
            5. ê°œì„  ì œì•ˆ ë¦¬í¬íŠ¸ ìƒì„±