name: Claude Code - ì‹œìŠ¤í…œ ëª¨ë‹ˆí„°ë§ ë° ì•Œë¦¼

on:
  schedule:
    - cron: '0 */6 * * *'  # 6ì‹œê°„ë§ˆë‹¤ ì‹¤í–‰
  workflow_dispatch:
  repository_dispatch:
    types: [claude-health-check]

permissions:
  contents: read
  issues: write
  actions: write

jobs:
  system-health-monitoring:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
      - name: ğŸ“¥ ì†ŒìŠ¤ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4
        
      - name: ğŸ” Claude Code Action ìƒíƒœ ì ê²€
        id: claude-status
        run: |
          echo "claude_active=$(gh run list --workflow='Claude Code - ê³ ë„í™”ëœ ì´ìŠˆ ìë™ í•´ê²° (MCP í†µí•©)' --limit=5 --json status,conclusion | jq -r '.[] | select(.conclusion == "success") | length')" >> $GITHUB_OUTPUT
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          
      - name: ğŸ“Š í”„ë¡œì íŠ¸ ê±´ê°•ë„ ë¶„ì„
        id: health-check
        run: |
          # ìµœê·¼ ì´ìŠˆ ì²˜ë¦¬ ì„±ê³µë¥  ê³„ì‚°
          SUCCESS_RATE=$(gh run list --limit=20 --json conclusion | jq '[.[] | select(.conclusion == "success")] | length')
          TOTAL_RUNS=$(gh run list --limit=20 --json conclusion | jq '. | length')
          
          if [ $TOTAL_RUNS -gt 0 ]; then
            SUCCESS_PERCENTAGE=$((SUCCESS_RATE * 100 / TOTAL_RUNS))
          else
            SUCCESS_PERCENTAGE=0
          fi
          
          echo "success_rate=$SUCCESS_PERCENTAGE" >> $GITHUB_OUTPUT
          echo "total_runs=$TOTAL_RUNS" >> $GITHUB_OUTPUT
          echo "successful_runs=$SUCCESS_RATE" >> $GITHUB_OUTPUT
          
          # ì½”ë“œë² ì´ìŠ¤ ìƒíƒœ ì²´í¬
          PYTHON_FILES=$(find app -name "*.py" | wc -l)
          TEMPLATE_FILES=$(find app -name "*.html" | wc -l) 
          TEST_FILES=$(find app/tests -name "test_*.py" | wc -l)
          
          echo "python_files=$PYTHON_FILES" >> $GITHUB_OUTPUT
          echo "template_files=$TEMPLATE_FILES" >> $GITHUB_OUTPUT
          echo "test_files=$TEST_FILES" >> $GITHUB_OUTPUT
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          
      - name: ğŸ”” Slack ì•Œë¦¼ (ì„±ê³µë¥  80% ë¯¸ë§Œì‹œ)
        if: steps.health-check.outputs.success_rate < 80 && steps.health-check.outputs.total_runs > 5
        uses: 8398a7/action-slack@v3
        with:
          status: custom
          custom_payload: |
            {
              "text": "âš ï¸ SafeWork Claude Code ì‹œìŠ¤í…œ ê²½ê³ ",
              "blocks": [
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn", 
                    "text": "*ğŸš¨ Claude Code ì„±ëŠ¥ ì €í•˜ ê°ì§€*\n\nâ€¢ ì„±ê³µë¥ : ${{ steps.health-check.outputs.success_rate }}%\nâ€¢ ì´ ì‹¤í–‰: ${{ steps.health-check.outputs.total_runs }}íšŒ\nâ€¢ ì„±ê³µ: ${{ steps.health-check.outputs.successful_runs }}íšŒ\n\n*ì ê²€ í•„ìš”ì‚¬í•­:*\n- API í† í° ìœ íš¨ì„±\n- MCP ì„œë²„ ì—°ê²° ìƒíƒœ\n- ì›Œí¬í”Œë¡œìš° ì„¤ì •"
                  }
                }
              ]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          
      - name: ğŸ“ˆ ì‹œìŠ¤í…œ ìƒíƒœ ì´ìŠˆ ìƒì„±
        if: steps.health-check.outputs.success_rate < 70 && steps.health-check.outputs.total_runs > 10
        run: |
          ISSUE_TITLE="ğŸš¨ Claude Code ì‹œìŠ¤í…œ ì„±ëŠ¥ ì €í•˜ ì•Œë¦¼"
          ISSUE_BODY="## ğŸ“Š ì‹œìŠ¤í…œ ìƒíƒœ ë³´ê³ ì„œ

### ğŸ¯ ì„±ëŠ¥ ì§€í‘œ
- **ì„±ê³µë¥ **: ${{ steps.health-check.outputs.success_rate }}% (ëª©í‘œ: 90% ì´ìƒ)
- **ì´ ì‹¤í–‰**: ${{ steps.health-check.outputs.total_runs }}íšŒ
- **ì„±ê³µ ì‹¤í–‰**: ${{ steps.health-check.outputs.successful_runs }}íšŒ

### ğŸ“‹ ì½”ë“œë² ì´ìŠ¤ í˜„í™©
- **Python íŒŒì¼**: ${{ steps.health-check.outputs.python_files }}ê°œ
- **í…œí”Œë¦¿ íŒŒì¼**: ${{ steps.health-check.outputs.template_files }}ê°œ  
- **í…ŒìŠ¤íŠ¸ íŒŒì¼**: ${{ steps.health-check.outputs.test_files }}ê°œ

### ğŸ”§ ê¶Œì¥ ì¡°ì¹˜ì‚¬í•­

1. **API í† í° í™•ì¸**
   - \`CLAUDE_CODE_OAUTH_TOKEN\` ìœ íš¨ì„± ê²€ì¦
   - í† í° ë§Œë£Œì¼ í™•ì¸

2. **MCP ì„œë²„ ì—°ê²° í…ŒìŠ¤íŠ¸**
   - ê° MCP ì„œë²„ ì‘ë‹µ ì‹œê°„ í™•ì¸
   - ë„¤íŠ¸ì›Œí¬ ì—°ê²° ìƒíƒœ ì ê²€

3. **ì›Œí¬í”Œë¡œìš° ìµœì í™”**
   - íƒ€ì„ì•„ì›ƒ ì„¤ì • ê²€í† 
   - ë¦¬ì†ŒìŠ¤ í• ë‹¹ ìµœì í™”

### ğŸ“ ë‹´ë‹¹ì
@qws941

---
*ìë™ ìƒì„± ì‹œê°: $(date '+%Y-%m-%d %H:%M:%S KST')*"

          gh issue create --title "$ISSUE_TITLE" --body "$ISSUE_BODY" --label "monitoring,priority-high,claude-system"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          
      - name: âœ… ì‹œìŠ¤í…œ ì •ìƒ ìƒíƒœ í™•ì¸
        if: steps.health-check.outputs.success_rate >= 90
        run: |
          echo "ğŸ‰ Claude Code ì‹œìŠ¤í…œì´ ì •ìƒì ìœ¼ë¡œ ì‘ë™ ì¤‘ì…ë‹ˆë‹¤!"
          echo "ì„±ê³µë¥ : ${{ steps.health-check.outputs.success_rate }}%"
          echo "SafeWork í”„ë¡œì íŠ¸ì˜ ìë™í™”ê°€ ê±´ê°•í•˜ê²Œ ìœ ì§€ë˜ê³  ìˆìŠµë‹ˆë‹¤."