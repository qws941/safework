name: ğŸ¤– Claude Post-Deployment Assistant

on:
  workflow_run:
    workflows: ["ğŸš€ Deploy SafeWork"]
    types: [completed]
  schedule:
    # Run every 30 minutes to monitor deployment health
    - cron: '*/30 * * * *'
  workflow_dispatch:
    inputs:
      scenario:
        description: 'Deployment scenario to handle'
        required: true
        default: 'health-check'
        type: choice
        options:
          - 'health-check'
          - 'error-analysis'
          - 'performance-check'
          - 'security-audit'
          - 'database-health'

jobs:
  claude-post-deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      issues: write
      pull-requests: write
      id-token: write
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: ğŸ¤– Claude Post-Deployment Analysis
        uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          track_progress: true
          prompt: |
            REPO: ${{ github.repository }}
            DEPLOYMENT SCENARIO: ${{ github.event.inputs.scenario || 'health-check' }}
            WORKFLOW STATUS: ${{ github.event.workflow_run.conclusion || 'manual' }}

            ğŸ¤– **SafeWork ë°°í¬ í›„ ìë™ ë¶„ì„ ë° ì²˜ë¦¬**
            
            ë°°í¬ í›„ ì‹œìŠ¤í…œ ìƒíƒœë¥¼ ë¶„ì„í•˜ê³  í•„ìš”í•œ ì¡°ì¹˜ë¥¼ ì·¨í•´ì£¼ì„¸ìš”.
            MCP ë„êµ¬ë“¤ì„ ì ê·¹ì ìœ¼ë¡œ í™œìš©í•˜ì—¬ ì²´ê³„ì ìœ¼ë¡œ ë¶„ì„í•´ì£¼ì„¸ìš”.

            **1. ì‹œìŠ¤í…œ ê±´ê°•ì„± ì²´í¬**
            ```
            - SafeWork ì• í”Œë¦¬ì¼€ì´ì…˜ ìƒíƒœ í™•ì¸ (https://safework.jclee.me/health)
            - ì„¤ë¬¸ì¡°ì‚¬ ê¸°ëŠ¥ ì •ìƒ ì‘ë™ í™•ì¸
            - ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²° ë° ì„±ëŠ¥ ì²´í¬
            - Redis ìºì‹œ ìƒíƒœ í™•ì¸
            - Docker ì»¨í…Œì´ë„ˆ ë¦¬ì†ŒìŠ¤ ì‚¬ìš©ëŸ‰
            ```

            **2. ì˜¤ë¥˜ ë¶„ì„ ë° ìë™ í•´ê²°**
            ```
            - ì• í”Œë¦¬ì¼€ì´ì…˜ ë¡œê·¸ ë¶„ì„
            - 500/404 ì˜¤ë¥˜ íŒ¨í„´ ê°ì§€
            - ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²° ì˜¤ë¥˜ ì§„ë‹¨
            - ì„±ëŠ¥ ë³‘ëª© ì§€ì  íŒŒì•…
            - ìë™ ìˆ˜ì • ê°€ëŠ¥í•œ ì´ìŠˆë“¤ í•´ê²°
            ```

            **3. ë³´ì•ˆ ë° ì»´í”Œë¼ì´ì–¸ìŠ¤ ê²€ì¦**
            ```
            - SSL/TLS ì¸ì¦ì„œ ìƒíƒœ
            - ê°œì¸ì •ë³´ë³´í˜¸ ì •ì±… ì¤€ìˆ˜
            - ì‚°ì—…ì•ˆì „ë³´ê±´ ë°ì´í„° ë³´ì•ˆ
            - ì•¡ì„¸ìŠ¤ ë¡œê·¸ ëª¨ë‹ˆí„°ë§
            ```

            **MCP ë„êµ¬ í™œìš© ì§€ì‹œ:**
            1. **mcp__serena**: ì½”ë“œë² ì´ìŠ¤ ë¶„ì„ ë° ìˆ˜ì •
               - í”„ë¡œì íŠ¸ í™œì„±í™”: `mcp__serena__activate_project('.')`
               - ì‹¬ë³¼ ê²€ìƒ‰: `mcp__serena__find_symbol()`  
               - ì½”ë“œ ìˆ˜ì •: `mcp__serena__replace_symbol_body()`

            2. **mcp__sequential-thinking**: ë³µì¡í•œ ë¬¸ì œ ë¶„ì„
               - ë‹¨ê³„ì  ì‚¬ê³ : `mcp__sequential-thinking__sequentialthinking()`
               - ë¬¸ì œ ë¶„í•´ ë° í•´ê²° ì „ëµ ìˆ˜ë¦½

            3. **mcp__shrimp-task-manager**: ì‘ì—… ê´€ë¦¬ ë° ê³„íš
               - ì‘ì—… ë¶„ì„: `mcp__shrimp-task-manager__analyze_task()`
               - ì‘ì—… ë¶„í• : `mcp__shrimp-task-manager__split_tasks()`
               - ì§„í–‰ìƒí™© ì¶”ì : `mcp__shrimp-task-manager__list_tasks()`

            **ìë™ ì‹¤í–‰ ì‹œë‚˜ë¦¬ì˜¤:**
            
            ğŸ” **health-check**: ì „ì²´ ì‹œìŠ¤í…œ ê±´ê°•ì„± ê²€ì‚¬
            - ëª¨ë“  ì—”ë“œí¬ì¸íŠ¸ ì‘ë‹µ ì‹œê°„ ì²´í¬
            - ë°ì´í„°ë² ì´ìŠ¤ ì¿¼ë¦¬ ì„±ëŠ¥ ì¸¡ì •
            - ë©”ëª¨ë¦¬/CPU ì‚¬ìš©ë¥  ë¶„ì„

            ğŸš¨ **error-analysis**: ì˜¤ë¥˜ íŒ¨í„´ ë¶„ì„ ë° í•´ê²°
            - ë¡œê·¸ íŒŒì¼ì—ì„œ ì˜¤ë¥˜ íŒ¨í„´ ì¶”ì¶œ
            - ê·¼ë³¸ ì›ì¸ ë¶„ì„ ë° í•´ê²°ë°©ì•ˆ ì œì‹œ
            - ìë™ ìˆ˜ì • ê°€ëŠ¥í•œ ì½”ë“œ ë¬¸ì œ í•´ê²°

            âš¡ **performance-check**: ì„±ëŠ¥ ìµœì í™”
            - ëŠë¦° ì¿¼ë¦¬ ì‹ë³„ ë° ìµœì í™”
            - ìºì‹œ íˆíŠ¸ìœ¨ ë¶„ì„
            - ì‘ë‹µ ì‹œê°„ ê°œì„  ë°©ì•ˆ ì œì‹œ

            ğŸ” **security-audit**: ë³´ì•ˆ ê°ì‚¬
            - ì·¨ì•½ì  ìŠ¤ìº” ë° ë¶„ì„
            - ë³´ì•ˆ ì„¤ì • ê²€ì¦
            - ë³´ì•ˆ íŒ¨ì¹˜ í•„ìš”ì„± í‰ê°€

            ğŸ—„ï¸ **database-health**: ë°ì´í„°ë² ì´ìŠ¤ ê±´ê°•ì„±
            - ë§ˆì´ê·¸ë ˆì´ì…˜ ìƒíƒœ í™•ì¸
            - ë°ì´í„° ë¬´ê²°ì„± ê²€ì¦
            - ë°±ì—… ìƒíƒœ ì ê²€

            ëª¨ë“  ë¶„ì„ ê²°ê³¼ë¥¼ ë°”íƒ•ìœ¼ë¡œ í•„ìš”í•œ ê²½ìš° ìë™ìœ¼ë¡œ ì´ìŠˆë¥¼ ìƒì„±í•˜ê±°ë‚˜
            ìˆ˜ì • PRì„ ë§Œë“¤ì–´ì£¼ì„¸ìš”.

          claude_args: |
            --allowedTools "mcp__serena__*,mcp__sequential-thinking__*,mcp__shrimp-task-manager__*,mcp__github__*,Bash(curl:*),Bash(docker:*),Bash(gh:*),Bash(git:*)"