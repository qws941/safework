name: SafeWork CI Auto-Fix - Flask & MySQL Expert

on:
  workflow_run:
    workflows: ["SafeWork CI/CD Pipeline", "Test SafeWork Application", "Docker Build and Push"]
    types:
      - completed
  workflow_dispatch:
    inputs:
      failed_workflow:
        description: 'Failed workflow run ID'
        required: true
        type: string
      fix_type:
        description: 'Type of fix to attempt'
        required: false
        default: 'auto'
        type: choice
        options:
        - auto
        - eslint
        - pytest
        - docker
        - mysql

permissions:
  contents: write
  pull-requests: write
  actions: read
  issues: write
  id-token: write

jobs:
  safework-ci-autofix:
    if: |
      (github.event.workflow_run.conclusion == 'failure' &&
       github.event.workflow_run.pull_requests[0] &&
       !startsWith(github.event.workflow_run.head_branch, 'claude-autofix-')) ||
      github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    timeout-minutes: 25

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.workflow_run.head_branch || github.ref }}
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Python 3.9
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: Setup git identity
        run: |
          git config --global user.email "claude-safework[bot]@users.noreply.github.com"
          git config --global user.name "Claude SafeWork Bot"

      - name: Create autofix branch
        id: branch
        run: |
          TIMESTAMP=$(date +%Y%m%d-%H%M%S)
          BRANCH_NAME="claude-autofix-${TIMESTAMP}-${{ github.run_id }}"
          git checkout -b "$BRANCH_NAME"
          echo "branch_name=$BRANCH_NAME" >> $GITHUB_OUTPUT

      - name: Install SafeWork dependencies
        run: |
          cd app
          pip install -r requirements.txt
          pip install pytest pytest-cov flake8 black bandit safety

      - name: Get CI failure details
        id: failure_details
        uses: actions/github-script@v7
        with:
          script: |
            const runId = ${{ github.event.workflow_run.id || inputs.failed_workflow }};
            
            const run = await github.rest.actions.getWorkflowRun({
              owner: context.repo.owner,
              repo: context.repo.repo,
              run_id: runId
            });

            const jobs = await github.rest.actions.listJobsForWorkflowRun({
              owner: context.repo.owner,
              repo: context.repo.repo,
              run_id: runId
            });

            const failedJobs = jobs.data.jobs.filter(job => job.conclusion === 'failure');
            
            let errorCategories = {
              eslint: false,
              pytest: false,
              docker: false,
              mysql: false,
              security: false
            };

            let errorSummary = [];
            
            for (const job of failedJobs) {
              const jobName = job.name.toLowerCase();
              
              if (jobName.includes('lint') || jobName.includes('eslint')) {
                errorCategories.eslint = true;
              }
              if (jobName.includes('test') || jobName.includes('pytest')) {
                errorCategories.pytest = true;
              }
              if (jobName.includes('docker') || jobName.includes('build')) {
                errorCategories.docker = true;
              }
              if (jobName.includes('mysql') || jobName.includes('database')) {
                errorCategories.mysql = true;
              }
              if (jobName.includes('security') || jobName.includes('bandit')) {
                errorCategories.security = true;
              }
              
              errorSummary.push({
                jobName: job.name,
                stepsFailed: job.steps.filter(step => step.conclusion === 'failure').map(step => step.name)
              });
            }

            return {
              runUrl: run.data.html_url,
              failedJobs: failedJobs.map(j => j.name),
              errorCategories: errorCategories,
              errorSummary: errorSummary,
              prNumber: ${{ github.event.workflow_run.pull_requests[0].number || 'null' }}
            };

      - name: SafeWork CI Auto-Fix with Claude
        id: claude_fix
        uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}

          prompt: |
            # SafeWork CI ìë™ ìˆ˜ì • ì‹œìŠ¤í…œ

            ## CI ì‹¤íŒ¨ ì •ë³´
            **ì›Œí¬í”Œë¡œ ì‹¤í–‰**: ${{ fromJSON(steps.failure_details.outputs.result).runUrl }}
            **ì‹¤íŒ¨í•œ Jobë“¤**: ${{ join(fromJSON(steps.failure_details.outputs.result).failedJobs, ', ') }}
            **PR ë²ˆí˜¸**: ${{ fromJSON(steps.failure_details.outputs.result).prNumber }}
            **ìˆ˜ì • ë¸Œëœì¹˜**: ${{ steps.branch.outputs.branch_name }}

            ## ì˜¤ë¥˜ ì¹´í…Œê³ ë¦¬ ë¶„ì„
            ```json
            ${{ toJSON(fromJSON(steps.failure_details.outputs.result).errorCategories) }}
            ```

            ## SafeWork ì „ìš© ìë™ ìˆ˜ì • ì „ëµ

            ### 1. ESLint ì˜¤ë¥˜ ìˆ˜ì • ğŸ”§
            ```bash
            # í˜„ì¬ ìƒíƒœ: 18 errors, 1 warning
            cd app && npm run lint:fix  # 11ê°œ ìë™ ìˆ˜ì •
            
            # ìˆ˜ë™ ìˆ˜ì • í•„ìš”í•œ ì˜¤ë¥˜ë“¤:
            - 'quotes': single quotes ê°•ì œ
            - 'curly': if ë¬¸ ì¤‘ê´„í˜¸ í•„ìˆ˜
            - 'no-unused-vars': ë¯¸ì‚¬ìš© ë³€ìˆ˜ ì œê±°
            - 'max-lines-per-function': 100ì¤„ ì œí•œ
            ```

            ### 2. Pytest í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨ ìˆ˜ì • ğŸ§ª
            ```python
            # SafeWork í…ŒìŠ¤íŠ¸ íŒ¨í„´
            # ëª©í‘œ: 39/39 tests passing, 80%+ coverage
            
            # ì¼ë°˜ì ì¸ ì‹¤íŒ¨ ì›ì¸:
            - MySQL 8.0 í˜¸í™˜ì„± (UTF8MB4)
            - Redis ì—°ê²° ì‹¤íŒ¨
            - Flask context ëˆ„ë½
            - ì„¤ë¬¸ ë°ì´í„° validation
            - ì˜ë£Œì •ë³´ ì•”í˜¸í™” í…ŒìŠ¤íŠ¸
            ```

            ### 3. Docker ë¹Œë“œ ì‹¤íŒ¨ ìˆ˜ì • ğŸ³
            ```dockerfile
            # SafeWork Docker íŒ¨í„´
            - Python 3.9 base image
            - MySQL 8.0 client ë¼ì´ë¸ŒëŸ¬ë¦¬
            - Redis connection pool
            - í™˜ê²½ë³€ìˆ˜ validation
            - í—¬ìŠ¤ì²´í¬ ì—”ë“œí¬ì¸íŠ¸ (/health)
            ```

            ### 4. MySQL ë§ˆì´ê·¸ë ˆì´ì…˜ ì˜¤ë¥˜ ğŸ—„ï¸
            ```python
            # SafeWork DB íŒ¨í„´
            - INFORMATION_SCHEMA ì¿¼ë¦¬
            - AUTO_INCREMENT, INSERT IGNORE
            - UTF8MB4 charset í•„ìˆ˜
            - KST íƒ€ì„ì¡´ (kst_now())
            - íŠ¸ëœì­ì…˜ ë¡¤ë°± ì§€ì›
            ```

            ### 5. ë³´ì•ˆ ìŠ¤ìº” ì‹¤íŒ¨ ğŸ”’
            ```python
            # Bandit/Safety ì¼ë°˜ ì´ìŠˆ
            - hardcoded passwords ì œê±°
            - SQL injection ë°©ì§€
            - XSS protection ê°•í™”
            - CSRF í† í° ê²€ì¦
            - PHI ë°ì´í„° ì•”í˜¸í™”
            ```

            ## ìë™ ìˆ˜ì • ë‹¨ê³„ë³„ ê°€ì´ë“œ

            ### Phase 1: ë¹ ë¥¸ ìˆ˜ì • (Auto-fixable)
            1. **ESLint Auto-fix**: `cd app && npm run lint:fix`
            2. **Black Formatting**: `cd app && black . --line-length 88`
            3. **Import Sorting**: `cd app && isort .`
            4. **Trailing Whitespace**: ìë™ ì œê±°

            ### Phase 2: êµ¬ì¡°ì  ìˆ˜ì •
            1. **í•¨ìˆ˜ í¬ê¸° ì œí•œ**: 100ì¤„ ì´ˆê³¼ í•¨ìˆ˜ ë¶„í• 
            2. **íŒŒì¼ í¬ê¸° ì œí•œ**: 500ì¤„ ì´ˆê³¼ íŒŒì¼ ëª¨ë“ˆí™”
            3. **ë¯¸ì‚¬ìš© ì½”ë“œ ì œê±°**: imports, variables, functions
            4. **Type hints ì¶”ê°€**: Flask route parameters

            ### Phase 3: í…ŒìŠ¤íŠ¸ ìˆ˜ì •
            1. **DB ì—°ê²° í…ŒìŠ¤íŠ¸**: MySQL/Redis connection
            2. **ì„¤ë¬¸ ì œì¶œ í…ŒìŠ¤íŠ¸**: 001/002 form validation
            3. **API ì—”ë“œí¬ì¸íŠ¸**: v2 REST API í…ŒìŠ¤íŠ¸
            4. **ì¸ì¦ í…ŒìŠ¤íŠ¸**: login/logout flows

            ### Phase 4: ë°°í¬ ì¤€ë¹„
            1. **Docker ì´ë¯¸ì§€**: multi-platform build
            2. **í™˜ê²½ë³€ìˆ˜ ê²€ì¦**: production settings
            3. **í—¬ìŠ¤ì²´í¬**: /health endpoint
            4. **Watchtower í˜¸í™˜ì„±**: auto-deployment

            ## ìˆ˜ì • í›„ ê²€ì¦
            ```bash
            # ëª¨ë“  ìˆ˜ì • í›„ ì‹¤í–‰í•  ê²€ì¦ ëª…ë ¹ì–´
            cd app
            python -m pytest --cov=. --cov-report=html  # í…ŒìŠ¤íŠ¸ + ì»¤ë²„ë¦¬ì§€
            flake8 . --max-line-length=88                # ì½”ë“œ ìŠ¤íƒ€ì¼
            bandit -r . -f json                         # ë³´ì•ˆ ìŠ¤ìº”
            python app.py --check-config                # ì„¤ì • ê²€ì¦
            ```

            ## ì‘ì—… ì§€ì‹œì‚¬í•­
            1. **ì‹¤íŒ¨í•œ CI ë¡œê·¸ ë¶„ì„í•˜ê³  ì˜¤ë¥˜ ì¹´í…Œê³ ë¦¬ ì‹ë³„**
            2. **SafeWork ë„ë©”ì¸ íŠ¹ì„± ê³ ë ¤í•œ ìˆ˜ì •ì‚¬í•­ ì ìš©**
            3. **ë‹¨ê³„ë³„ë¡œ ìˆ˜ì •í•˜ê³  ê° ë‹¨ê³„ë§ˆë‹¤ ê²€ì¦**
            4. **ìˆ˜ì • ì™„ë£Œ í›„ ì»¤ë°‹ ë©”ì‹œì§€ì— ìƒì„¸í•œ ìˆ˜ì • ë‚´ì—­ í¬í•¨**
            5. **PR ì½”ë©˜íŠ¸ë¡œ ìˆ˜ì • ìš”ì•½ ë° ê²€ì¦ ê²°ê³¼ ì œê³µ**

            **ì§€ê¸ˆ CI ì‹¤íŒ¨ë¥¼ ë¶„ì„í•˜ê³  SafeWork ì‹œìŠ¤í…œì— íŠ¹í™”ëœ ìë™ ìˆ˜ì •ì„ ì§„í–‰í•´ì£¼ì„¸ìš”.**

          claude_args: |
            --allowedTools "Edit,MultiEdit,Write,Read,Bash(git:*),Bash(python:*),Bash(pip:*),Bash(pytest:*),Bash(npm:*),Bash(docker:*),Bash(flake8:*),Bash(black:*)"
            --max-turns 20

      - name: Push autofix changes
        id: push_changes
        run: |
          if [[ -n $(git status --porcelain) ]]; then
            git add -A
            git commit -m "ğŸ¤– SafeWork CI Auto-Fix

            ìë™ ìˆ˜ì •ëœ í•­ëª©:
            - ESLint ì˜¤ë¥˜ ìˆ˜ì •
            - Python ì½”ë“œ í¬ë§·íŒ…
            - í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨ ìˆ˜ì •
            - Docker ë¹Œë“œ ì´ìŠˆ í•´ê²°
            
            ìˆ˜ì • ë¸Œëœì¹˜: ${{ steps.branch.outputs.branch_name }}
            ì›ë³¸ ì‹¤íŒ¨ ì›Œí¬í”Œë¡œ: ${{ fromJSON(steps.failure_details.outputs.result).runUrl }}
            
            Claude SafeWork Botì´ ìë™ ìƒì„±í•œ ìˆ˜ì •ì‚¬í•­ì…ë‹ˆë‹¤."
            
            git push origin "${{ steps.branch.outputs.branch_name }}"
            echo "changes_pushed=true" >> $GITHUB_OUTPUT
          else
            echo "changes_pushed=false" >> $GITHUB_OUTPUT
          fi

      - name: Create auto-fix PR
        if: steps.push_changes.outputs.changes_pushed == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const { data: pr } = await github.rest.pulls.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'ğŸ¤– SafeWork CI ìë™ ìˆ˜ì •',
              body: `## ğŸš¨ CI ì‹¤íŒ¨ ìë™ ìˆ˜ì •ì‚¬í•­

            ### ì›ë³¸ ì‹¤íŒ¨ ì •ë³´
            - **ì‹¤íŒ¨ ì›Œí¬í”Œë¡œ**: ${{ fromJSON(steps.failure_details.outputs.result).runUrl }}
            - **ì‹¤íŒ¨ Jobë“¤**: ${{ join(fromJSON(steps.failure_details.outputs.result).failedJobs, ', ') }}
            - **ì›ë³¸ PR**: ${${{ fromJSON(steps.failure_details.outputs.result).prNumber }} || 'N/A'}

            ### ìë™ ìˆ˜ì • ì¹´í…Œê³ ë¦¬
            ${JSON.stringify(${{ fromJSON(steps.failure_details.outputs.result).errorCategories }}, null, 2)}

            ### ìˆ˜ì •ëœ í•­ëª©ë“¤
            - âœ… ESLint ì˜¤ë¥˜ ìë™ ìˆ˜ì •
            - âœ… Python ì½”ë“œ í¬ë§·íŒ… (Black)
            - âœ… Import ì •ë ¬ (isort)
            - âœ… í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨ ìˆ˜ì •
            - âœ… Docker ë¹Œë“œ ì´ìŠˆ í•´ê²°

            ### ê²€ì¦ í•„ìš”ì‚¬í•­
            - [ ] ìˆ˜ì •ì‚¬í•­ ì½”ë“œ ë¦¬ë·°
            - [ ] í…ŒìŠ¤íŠ¸ í†µê³¼ í™•ì¸
            - [ ] SafeWork ê¸°ëŠ¥ ì •ìƒ ë™ì‘ í™•ì¸
            - [ ] ì˜ë£Œì •ë³´ ë³´í˜¸ ê·œì • ì¤€ìˆ˜ í™•ì¸

            ---
            ğŸ¤– **Claude SafeWork Bot**ì´ ìë™ ìƒì„±í•œ ìˆ˜ì •ì‚¬í•­ì…ë‹ˆë‹¤.
            ìˆ˜ë™ ê²€í†  í›„ ë³‘í•©í•´ì£¼ì„¸ìš”.`,
              head: '${{ steps.branch.outputs.branch_name }}',
              base: '${{ github.event.workflow_run.head_branch || github.ref_name }}'
            });

            // Add labels
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: pr.number,
              labels: ['automated-fix', 'ci/cd', 'claude-bot']
            });

            console.log(`ìë™ ìˆ˜ì • PR ìƒì„± ì™„ë£Œ: #${pr.number}`);

      - name: Auto-fix completed
        run: |
          echo "SafeWork CI ìë™ ìˆ˜ì • ì™„ë£Œ"
          echo "ë¸Œëœì¹˜: ${{ steps.branch.outputs.branch_name }}"
          echo "ë³€ê²½ì‚¬í•­ í‘¸ì‹œ: ${{ steps.push_changes.outputs.changes_pushed }}"