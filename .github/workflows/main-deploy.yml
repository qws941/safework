name: SafeWork Simple Deploy

on:
  push:
    branches: [main, master]
  workflow_dispatch:

env:
  REGISTRY: registry.jclee.me
  REGISTRY_USER: admin
  REGISTRY_PASSWORD: bingogo1

jobs:
  build-and-deploy:
    name: Build and Deploy SafeWork
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Generate version
      id: version
      run: |
        VERSION=$(date +%Y%m%d.%H%M)
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "Generated version: $VERSION"
        
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
      
    - name: Login to Registry
      uses: docker/login-action@v3
      with:
        registry: ${{ env.REGISTRY }}
        username: ${{ env.REGISTRY_USER }}
        password: ${{ env.REGISTRY_PASSWORD }}
        
    - name: Build and push App image
      uses: docker/build-push-action@v5
      with:
        context: ./app
        push: true
        tags: |
          ${{ env.REGISTRY }}/safework/app:latest
          ${{ env.REGISTRY }}/safework/app:${{ steps.version.outputs.version }}
        platforms: linux/amd64,linux/arm64
        
    - name: Build and push MySQL image
      uses: docker/build-push-action@v5
      with:
        context: ./mysql
        push: true
        tags: |
          ${{ env.REGISTRY }}/safework/mysql:latest
          ${{ env.REGISTRY }}/safework/mysql:${{ steps.version.outputs.version }}
        platforms: linux/amd64,linux/arm64
        
    - name: Build and push Redis image
      uses: docker/build-push-action@v5
      with:
        context: ./redis
        push: true
        tags: |
          ${{ env.REGISTRY }}/safework/redis:latest
          ${{ env.REGISTRY }}/safework/redis:${{ steps.version.outputs.version }}
        platforms: linux/amd64,linux/arm64
        
    - name: Update version file
      run: |
        echo "${{ steps.version.outputs.version }}" > app/VERSION
        
    - name: Deploy success notification
      run: |
        echo "ğŸ‰ SafeWork ë°°í¬ ì™„ë£Œ!"
        echo "ğŸ·ï¸ Version: ${{ steps.version.outputs.version }}"
        echo "ğŸ³ Images pushed to ${{ env.REGISTRY }}/safework/*"