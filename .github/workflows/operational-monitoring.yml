name: ðŸ“Š SafeWork Operational Monitoring

# ìš´ì˜ ëª¨ë‹ˆí„°ë§ ë° ë¡œê·¸ ë¶„ì„ ì›Œí¬í”Œë¡œìš°
# í†µí•© ìš´ì˜ ìŠ¤í¬ë¦½íŠ¸ë¥¼ í™œìš©í•œ ìžë™ ëª¨ë‹ˆí„°ë§

on:
  schedule:
    # ë§¤ ì‹œê°„ë§ˆë‹¤ ì‹¤í–‰ (ìš´ì˜ ì‹œê°„ ë™ì•ˆ)
    - cron: '0 9-18 * * 1-5'  # ì›”-ê¸ˆ, 9ì‹œ-18ì‹œ
    # ë§¤ 4ì‹œê°„ë§ˆë‹¤ ì‹¤í–‰ (ë¹„ìš´ì˜ ì‹œê°„)
    - cron: '0 */4 * * *'      # ëª¨ë“  ë‚ , 4ì‹œê°„ë§ˆë‹¤

  workflow_dispatch:
    inputs:
      monitoring_type:
        description: 'Monitoring type'
        required: true
        default: 'health'
        type: choice
        options:
          - 'health'
          - 'overview'
          - 'logs'
          - 'full'
      container_target:
        description: 'Container target (for logs)'
        required: false
        default: 'all'
        type: string

env:
  # ìš´ì˜ í™˜ê²½ ì„¤ì •
  PRODUCTION_URL: https://safework.jclee.me
  PORTAINER_URL: https://portainer.jclee.me
  PORTAINER_TOKEN: ${{ secrets.PORTAINER_API_KEY }}
  
  # ì•Œë¦¼ ì„¤ì • (ë¹„í™œì„±í™”ë¨)
  # SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
  
  # ëª¨ë‹ˆí„°ë§ ìž„ê³„ê°’
  HEALTH_THRESHOLD: 80
  LOG_ERROR_THRESHOLD: 5

permissions:
  contents: read
  actions: write
  issues: write

jobs:
  operational-monitoring:
    name: ðŸ” Operational Monitoring
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ“‚ Checkout Repository
        uses: actions/checkout@v4

      - name: ðŸ”§ Setup Monitoring Environment
        run: |
          # Install required tools
          sudo apt-get update
          sudo apt-get install -y jq curl bc

          # Make unified operations script executable
          chmod +x ./scripts/safework_ops_unified.sh

          # Configure environment
          export PORTAINER_URL="${{ env.PORTAINER_URL }}"
          export PORTAINER_TOKEN="${{ env.PORTAINER_TOKEN }}"
          export PRODUCTION_URL="${{ env.PRODUCTION_URL }}"
          export DEBUG=0  # Reduce noise in production monitoring

      - name: ðŸ¥ System Health Check
        id: health_check
        run: |
          echo "ðŸ¥ Running comprehensive system health check..."
          
          # Run health monitoring using unified script
          if ./scripts/safework_ops_unified.sh monitor health > health-report.txt 2>&1; then
            echo "health_status=healthy" >> $GITHUB_OUTPUT
            echo "âœ… System health check completed successfully"
          else
            echo "health_status=degraded" >> $GITHUB_OUTPUT
            echo "âš ï¸ System health check detected issues"
          fi

          # Extract health score if available
          if grep -q "ê±´ê°• ì ìˆ˜" health-report.txt; then
            health_score=$(grep "ê±´ê°• ì ìˆ˜" health-report.txt | grep -o '[0-9]\+' | head -1)
            echo "health_score=${health_score:-0}" >> $GITHUB_OUTPUT
          else
            echo "health_score=0" >> $GITHUB_OUTPUT
          fi

          # Display health report
          cat health-report.txt

      - name: ðŸ“Š System Overview
        run: |
          echo "ðŸ“Š Generating system overview..."
          
          # Run system overview using unified script
          ./scripts/safework_ops_unified.sh monitor overview > overview-report.txt 2>&1 || {
            echo "âš ï¸ System overview failed - using fallback monitoring"
            
            # Fallback monitoring
            {
              echo "ðŸ” Fallback System Overview"
              echo "=========================="
              echo "Timestamp: $(date -u)"
              echo ""
              
              # Direct endpoint checks
              echo "ðŸ“¡ Direct Endpoint Checks:"
              if curl -sf "${{ env.PRODUCTION_URL }}/health" >/dev/null; then
                echo "âœ… Health API: Responding"
              else
                echo "âŒ Health API: Not responding"
              fi
              
              if curl -sf "${{ env.PRODUCTION_URL }}/" >/dev/null; then
                echo "âœ… Main Site: Responding"
              else
                echo "âŒ Main Site: Not responding"
              fi
              
            } > overview-report.txt
          }

          cat overview-report.txt

      - name: ðŸ“ Error Log Analysis
        id: log_analysis
        run: |
          echo "ðŸ“ Analyzing recent error logs..."
          
          # Run error log analysis using unified script
          ./scripts/safework_ops_unified.sh logs errors all > error-logs.txt 2>&1 || {
            echo "âš ï¸ Error log analysis failed"
            echo "No error logs available" > error-logs.txt
          }

          # Count errors
          error_count=$(grep -c -i "error\|exception\|critical\|fatal" error-logs.txt || echo "0")
          echo "error_count=${error_count}" >> $GITHUB_OUTPUT
          
          echo "ðŸ“Š Error count: ${error_count}"
          
          # Show recent errors if any
          if [[ $error_count -gt 0 ]]; then
            echo "ðŸš¨ Recent errors found:"
            head -20 error-logs.txt
          else
            echo "âœ… No recent errors detected"
          fi

      - name: ðŸš¨ Alert Processing
        if: steps.health_check.outputs.health_status == 'degraded' || steps.log_analysis.outputs.error_count > env.LOG_ERROR_THRESHOLD
        run: |
          echo "ðŸš¨ Processing alerts for system issues..."
          
          health_score="${{ steps.health_check.outputs.health_score }}"
          error_count="${{ steps.log_analysis.outputs.error_count }}"
          
          # Create alert message
          {
            echo "ðŸš¨ SafeWork Production Alert"
            echo "=========================="
            echo "Timestamp: $(date -u)"
            echo "Health Score: ${health_score}%"
            echo "Error Count: ${error_count}"
            echo ""
            
            if [[ $health_score -lt ${{ env.HEALTH_THRESHOLD }} ]]; then
              echo "âš ï¸ Health score below threshold (${{ env.HEALTH_THRESHOLD }}%)"
            fi
            
            if [[ $error_count -gt ${{ env.LOG_ERROR_THRESHOLD }} ]]; then
              echo "âš ï¸ Error count above threshold (${{ env.LOG_ERROR_THRESHOLD }})"
            fi
            
            echo ""
            echo "ðŸ”— Action URL: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
            
          } > alert-message.txt

          cat alert-message.txt

      - name: ðŸ“Š Generate Monitoring Report
        run: |
          echo "ðŸ“Š Generating comprehensive monitoring report..."
          
          {
            echo "# SafeWork Operational Monitoring Report"
            echo ""
            echo "**Generated:** $(date -u)"
            echo "**Workflow:** ${{ github.workflow }}"
            echo "**Run ID:** ${{ github.run_id }}"
            echo "**Trigger:** ${{ github.event_name }}"
            echo ""
            
            echo "## System Health Summary"
            echo "- **Status:** ${{ steps.health_check.outputs.health_status }}"
            echo "- **Health Score:** ${{ steps.health_check.outputs.health_score }}%"
            echo "- **Error Count:** ${{ steps.log_analysis.outputs.error_count }}"
            echo ""
            
            echo "## Health Check Details"
            echo '```'
            if [[ -f health-report.txt ]]; then
              cat health-report.txt
            else
              echo "Health report not available"
            fi
            echo '```'
            echo ""
            
            echo "## System Overview"
            echo '```'
            if [[ -f overview-report.txt ]]; then
              cat overview-report.txt
            else
              echo "Overview report not available"
            fi
            echo '```'
            echo ""
            
            if [[ ${{ steps.log_analysis.outputs.error_count }} -gt 0 ]]; then
              echo "## Recent Errors"
              echo '```'
              if [[ -f error-logs.txt ]]; then
                head -50 error-logs.txt
              else
                echo "Error logs not available"
              fi
              echo '```'
            fi
            
            echo ""
            echo "## Operations Script Usage"
            echo "The following unified operations script commands are available:"
            echo ""
            echo "### Health Monitoring"
            echo '```bash'
            echo "./scripts/safework_ops_unified.sh monitor health"
            echo "./scripts/safework_ops_unified.sh monitor overview"
            echo '```'
            echo ""
            echo "### Log Analysis"
            echo '```bash'
            echo "./scripts/safework_ops_unified.sh logs recent all 50"
            echo "./scripts/safework_ops_unified.sh logs errors all"
            echo "./scripts/safework_ops_unified.sh logs live safework-app"
            echo '```'
            echo ""
            echo "### Deployment Status"
            echo '```bash'
            echo "./scripts/safework_ops_unified.sh deploy status"
            echo '```'
            
          } > monitoring-report.md

          echo "ðŸ“‹ Monitoring report generated:"
          cat monitoring-report.md

      - name: ðŸ“¤ Upload Monitoring Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: monitoring-report-${{ github.run_number }}
          path: |
            monitoring-report.md
            health-report.txt
            overview-report.txt
            error-logs.txt
            alert-message.txt
          retention-days: 7

      - name: ðŸ”” Send Slack Notification (ë¹„í™œì„±í™”ë¨)
        if: false  # ì•Œë¦¼ ì‹œìŠ¤í…œ ë¹„í™œì„±í™”
        run: |
          # Prepare Slack notification
          status_emoji="âœ…"
          if [[ "${{ steps.health_check.outputs.health_status }}" == "degraded" ]]; then
            status_emoji="âš ï¸"
          fi
          
          health_score="${{ steps.health_check.outputs.health_score }}"
          error_count="${{ steps.log_analysis.outputs.error_count }}"
          
          curl -X POST "${{ env.SLACK_WEBHOOK_URL }}" \
            -H 'Content-Type: application/json' \
            -d "{
              \"text\": \"${status_emoji} SafeWork Monitoring Report\",
              \"blocks\": [
                {
                  \"type\": \"header\",
                  \"text\": {
                    \"type\": \"plain_text\",
                    \"text\": \"${status_emoji} SafeWork Production Monitoring\"
                  }
                },
                {
                  \"type\": \"section\",
                  \"fields\": [
                    {
                      \"type\": \"mrkdwn\",
                      \"text\": \"*Health Score:* ${health_score}%\"
                    },
                    {
                      \"type\": \"mrkdwn\",
                      \"text\": \"*Error Count:* ${error_count}\"
                    },
                    {
                      \"type\": \"mrkdwn\",
                      \"text\": \"*Status:* ${{ steps.health_check.outputs.health_status }}\"
                    },
                    {
                      \"type\": \"mrkdwn\",
                      \"text\": \"*Time:* $(date -u)\"
                    }
                  ]
                },
                {
                  \"type\": \"actions\",
                  \"elements\": [
                    {
                      \"type\": \"button\",
                      \"text\": {
                        \"type\": \"plain_text\",
                        \"text\": \"View Report\"
                      },
                      \"url\": \"${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}\"
                    },
                    {
                      \"type\": \"button\",
                      \"text\": {
                        \"type\": \"plain_text\",
                        \"text\": \"Production Site\"
                      },
                      \"url\": \"${{ env.PRODUCTION_URL }}\"
                    }
                  ]
                }
              ]
            }" || echo "âš ï¸ Slack notification failed"

  # Additional job for manual log collection
  manual-log-collection:
    name: ðŸ“‹ Manual Log Collection
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch' && github.event.inputs.monitoring_type == 'logs'
    
    steps:
      - name: ðŸ“‚ Checkout Repository
        uses: actions/checkout@v4

      - name: ðŸ”§ Setup Log Collection Environment
        run: |
          sudo apt-get update
          sudo apt-get install -y jq curl
          chmod +x ./scripts/safework_ops_unified.sh

      - name: ðŸ“ Collect Detailed Logs
        run: |
          container_target="${{ github.event.inputs.container_target }}"
          
          echo "ðŸ“‹ Collecting detailed logs for: ${container_target}"
          
          # Use unified script for log collection
          ./scripts/safework_ops_unified.sh logs recent "${container_target}" 100 > detailed-logs.txt || {
            echo "âš ï¸ Log collection failed"
            echo "Log collection failed at $(date)" > detailed-logs.txt
          }

          echo "ðŸ“Š Log collection completed"
          echo "Lines collected: $(wc -l < detailed-logs.txt)"

      - name: ðŸ“¤ Upload Detailed Logs
        uses: actions/upload-artifact@v4
        with:
          name: detailed-logs-${{ github.event.inputs.container_target }}-${{ github.run_number }}
          path: detailed-logs.txt
          retention-days: 14