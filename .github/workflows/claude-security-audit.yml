name: SafeWork ë³´ì•ˆ ê°ì‚¬ ì „ìš© ì›Œí¬í”Œë¡œìš°

on:
  pull_request:
    types: [opened, synchronize, reopened]
    paths:
      - 'app/**/*.py'
      - 'app/requirements.txt'
      - 'app/Dockerfile'
      - '.github/workflows/**'
  schedule:
    - cron: '0 2 * * *'  # ë§¤ì¼ 11:00 KST ë³´ì•ˆ ê°ì‚¬
  workflow_dispatch:
    inputs:
      security_level:
        description: 'ë³´ì•ˆ ê²€ì‚¬ ìˆ˜ì¤€'
        required: true
        default: 'standard'
        type: choice
        options:
        - 'basic'
        - 'standard'
        - 'comprehensive'

env:
  TIMEZONE: 'Asia/Seoul'
  PYTHON_VERSION: '3.11'

jobs:
  security_audit:
    name: ğŸ” SafeWork ë³´ì•ˆ ê°ì‚¬
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    permissions:
      contents: read
      issues: write
      pull-requests: write
      security-events: write
      
    steps:
      - name: ğŸ“¥ ì†ŒìŠ¤ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # ì „ì²´ íˆìŠ¤í† ë¦¬ í•„ìš” (ë³´ì•ˆ ë¶„ì„ìš©)
          
      - name: ğŸ Python í™˜ê²½ ì„¤ì •
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
          
      - name: ğŸ“¦ ë³´ì•ˆ ë„êµ¬ ì„¤ì¹˜
        run: |
          pip install --upgrade pip
          pip install bandit safety semgrep
          pip install -r app/requirements.txt
          
      - name: ğŸ” ê°œì¸ê±´ê°•ì •ë³´(PHI) ë³´í˜¸ ê²€ì‚¬
        run: |
          echo "ğŸ¥ SafeWork ê°œì¸ê±´ê°•ì •ë³´ ë³´í˜¸ ê²€ì‚¬ ì‹œì‘..."
          
          # ë¯¼ê°í•œ ê°œì¸ì •ë³´ íŒ¨í„´ ê²€ìƒ‰
          echo "ğŸ” ë¯¼ê°í•œ ê°œì¸ì •ë³´ íŒ¨í„´ ê²€ìƒ‰:"
          grep -r -i --include="*.py" \
            -e "ì£¼ë¯¼ë²ˆí˜¸\|resident.*number\|ssn\|social.*security" \
            -e "ê°œì¸ì •ë³´\|personal.*info\|pii" \
            -e "ê±´ê°•ì •ë³´\|health.*record\|medical.*record" \
            app/ || echo "âœ… ë¯¼ê°í•œ ê°œì¸ì •ë³´ íŒ¨í„´ ë¯¸ë°œê²¬"
            
      - name: ğŸ›¡ï¸ Bandit ë³´ì•ˆ ì·¨ì•½ì  ìŠ¤ìº”
        run: |
          echo "ğŸ”’ Bandit ë³´ì•ˆ ìŠ¤ìº” ì‹¤í–‰..."
          bandit -r app/ -f json -o bandit-report.json || true
          bandit -r app/ -ll --exclude=app/tests/
          
      - name: ğŸ“‹ Python ì˜ì¡´ì„± ë³´ì•ˆ ê²€ì‚¬
        run: |
          echo "ğŸ” Python íŒ¨í‚¤ì§€ ë³´ì•ˆ ì·¨ì•½ì  ê²€ì‚¬..."
          safety check --json --output safety-report.json || true
          safety check --short-report
          
      - name: ğŸ”¬ Semgrep ì½”ë“œ íŒ¨í„´ ë¶„ì„
        run: |
          echo "ğŸ§¬ Semgrep ì •ì  ì½”ë“œ ë¶„ì„..."
          semgrep --config=auto app/ --json --output=semgrep-report.json || true
          
      - name: ğŸ”‘ í•˜ë“œì½”ë”©ëœ ì‹œí¬ë¦¿ ê²€ì‚¬
        run: |
          echo "ğŸ•µï¸ í•˜ë“œì½”ë”©ëœ ì‹œí¬ë¦¿ ê²€ì‚¬..."
          
          # ì¼ë°˜ì ì¸ ì‹œí¬ë¦¿ íŒ¨í„´
          grep -r -E --include="*.py" \
            "(password|passwd|pwd|secret|key|token|api_key)\s*=\s*['\"][^'\"]{8,}" \
            app/ && echo "âš ï¸  ì ì¬ì  í•˜ë“œì½”ë”©ëœ ì‹œí¬ë¦¿ ë°œê²¬" || \
            echo "âœ… í•˜ë“œì½”ë”©ëœ ì‹œí¬ë¦¿ ë¯¸ë°œê²¬"
            
      - name: ğŸ“Š Flask ë³´ì•ˆ ì„¤ì • ê²€ì‚¬
        run: |
          echo "ğŸ”§ Flask ë³´ì•ˆ ì„¤ì • ê²€ì‚¬..."
          python3 << 'EOF'
          import os
          import ast
          
          security_checks = {
              'SECRET_KEY': False,
              'CSRF_PROTECTION': False,
              'SECURE_COOKIES': False,
              'SESSION_PROTECTION': False
          }
          
          # config.py íŒŒì¼ ë¶„ì„
          config_files = ['app/config.py', 'app/app.py']
          for config_file in config_files:
              if os.path.exists(config_file):
                  with open(config_file, 'r', encoding='utf-8') as f:
                      content = f.read()
                      if 'SECRET_KEY' in content and 'os.environ' in content:
                          security_checks['SECRET_KEY'] = True
                      if 'CSRFProtect' in content or 'csrf' in content.lower():
                          security_checks['CSRF_PROTECTION'] = True
                      if 'SECURE' in content and 'COOKIE' in content:
                          security_checks['SECURE_COOKIES'] = True
                      if 'SESSION_PROTECTION' in content:
                          security_checks['SESSION_PROTECTION'] = True
          
          print("ğŸ›¡ï¸ Flask ë³´ì•ˆ ì„¤ì • ê²€ì‚¬ ê²°ê³¼:")
          for check, status in security_checks.items():
              status_icon = "âœ…" if status else "âš ï¸"
              print(f"{status_icon} {check}: {status}")
          EOF
          
      - name: ğŸ¤– Claude ë³´ì•ˆ ì „ë¬¸ê°€ ë¶„ì„
        uses: anthropics/claude-code-action@v1.0.5
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          github_token: ${{ secrets.GITHUB_TOKEN }}
          track_progress: true
          use_sticky_comment: true
          claude_args: |
            --max-turns 8
            --model claude-3-5-sonnet-20241022
            --timeout 600
          prompt: |
            # ğŸ” SafeWork ë³´ì•ˆ ì „ë¬¸ê°€ (ê°œì¸ê±´ê°•ì •ë³´ ì „ë‹´)
            
            ë‹¹ì‹ ì€ **SafeWork ì‚°ì—…ì•ˆì „ ì‹œìŠ¤í…œì˜ ë³´ì•ˆ ì „ë¬¸ê°€**ì…ë‹ˆë‹¤.
            
            ## ğŸ¥ SafeWork ë³´ì•ˆ ì»¨í…ìŠ¤íŠ¸
            - **ë„ë©”ì¸**: ì‚°ì—…ì•ˆì „ë³´ê±´ ê´€ë¦¬ (ê°œì¸ê±´ê°•ì •ë³´ ì²˜ë¦¬)
            - **ê·œì •**: ê°œì¸ì •ë³´ë³´í˜¸ë²•, ì˜ë£Œë²•, ì‚°ì—…ì•ˆì „ë³´ê±´ë²•
            - **ë¯¼ê°ì •ë³´**: ê·¼ê³¨ê²©ê³„ ì¦ìƒ, ê±´ê°•ê²€ì§„ ë°ì´í„°, ê°œì¸ì‹ë³„ì •ë³´
            
            ## ğŸ¯ ë³´ì•ˆ ê°ì‚¬ ëª©í‘œ
            1. **ê°œì¸ê±´ê°•ì •ë³´(PHI) ë³´í˜¸** - ì•”í˜¸í™”, ì ‘ê·¼ì œì–´, ë¡œê¹…
            2. **Flask ì›¹ë³´ì•ˆ** - CSRF, XSS, SQL Injection ë°©ì§€
            3. **ì¸ì¦/ê¶Œí•œ** - ì‚¬ìš©ì ê¶Œí•œ ë¶„ë¦¬, ì„¸ì…˜ ë³´ì•ˆ
            4. **ë°ì´í„° ìœ ì¶œ ë°©ì§€** - ë¡œê·¸ ë…¸ì¶œ, ë””ë²„ê·¸ ì •ë³´ ì œê±°
            5. **ì»´í”Œë¼ì´ì–¸ìŠ¤** - ë²•ì  ìš”êµ¬ì‚¬í•­ ì¤€ìˆ˜
            
            ## ğŸ“‹ ë³´ì•ˆ ê°ì‚¬ ìˆ˜í–‰ì‚¬í•­
            1. **ì½”ë“œ ì·¨ì•½ì  ë¶„ì„** (Bandit, Safety, Semgrep ê²°ê³¼ í™œìš©)
            2. **ê°œì¸ê±´ê°•ì •ë³´ ì²˜ë¦¬ ë¡œì§ ê²€í† **
            3. **Flask ë³´ì•ˆ ì„¤ì • í‰ê°€**
            4. **ì¸ì¦/ê¶Œí•œ ì²´ê³„ ë¶„ì„**
            5. **ë³´ì•ˆ ê°œì„  ê¶Œì¥ì‚¬í•­ ì œì‹œ**
            
            **í˜„ì¬ KST ì‹œê°: $(TZ='Asia/Seoul' date '+%Y-%m-%d %H:%M:%S')**
            
            SafeWork ì‹œìŠ¤í…œì˜ ë³´ì•ˆ ê°ì‚¬ë¥¼ ìˆ˜í–‰í•˜ê³  ê°œì¸ê±´ê°•ì •ë³´ ë³´í˜¸ì— ì¤‘ì ì„ ë‘” ìƒì„¸í•œ ë³´ì•ˆ ë¶„ì„ ë¦¬í¬íŠ¸ë¥¼ ì‘ì„±í•´ì£¼ì„¸ìš”.
            
      - name: ğŸ“„ ë³´ì•ˆ ê°ì‚¬ ë¦¬í¬íŠ¸ ìƒì„±
        if: always()
        run: |
          echo "ğŸ“Š SafeWork ë³´ì•ˆ ê°ì‚¬ ë¦¬í¬íŠ¸ ìƒì„±..."
          
          cat > security-audit-report.md << 'EOF'
          # ğŸ” SafeWork ë³´ì•ˆ ê°ì‚¬ ë¦¬í¬íŠ¸
          
          **ê°ì‚¬ ì¼ì‹œ**: $(TZ='Asia/Seoul' date '+%Y-%m-%d %H:%M:%S KST')
          **ê°ì‚¬ ë²”ìœ„**: ì „ì²´ ì• í”Œë¦¬ì¼€ì´ì…˜ ì½”ë“œë² ì´ìŠ¤
          **ë³´ì•ˆ ìˆ˜ì¤€**: ${{ github.event.inputs.security_level || 'standard' }}
          
          ## ğŸ“‹ ë³´ì•ˆ ê²€ì‚¬ í•­ëª©
          
          ### ğŸ¥ ê°œì¸ê±´ê°•ì •ë³´(PHI) ë³´í˜¸
          - âœ… ë¯¼ê°í•œ ê°œì¸ì •ë³´ íŒ¨í„´ ê²€ìƒ‰ ì™„ë£Œ
          - âœ… ê±´ê°•ì •ë³´ ì²˜ë¦¬ ë¡œì§ ê²€í†  ì™„ë£Œ
          
          ### ğŸ›¡ï¸ ì›¹ ì• í”Œë¦¬ì¼€ì´ì…˜ ë³´ì•ˆ
          - âœ… Bandit ì •ì  ë¶„ì„ ì™„ë£Œ
          - âœ… Python ì˜ì¡´ì„± ë³´ì•ˆ ê²€ì‚¬ ì™„ë£Œ
          - âœ… Semgrep ì½”ë“œ íŒ¨í„´ ë¶„ì„ ì™„ë£Œ
          
          ### ğŸ”‘ ì¸ì¦ ë° ê¶Œí•œ
          - âœ… Flask ë³´ì•ˆ ì„¤ì • ê²€ì‚¬ ì™„ë£Œ
          - âœ… í•˜ë“œì½”ë”©ëœ ì‹œí¬ë¦¿ ê²€ì‚¬ ì™„ë£Œ
          
          ## ğŸ¯ ê°œì„  ê¶Œì¥ì‚¬í•­
          [Claude ë¶„ì„ ê²°ê³¼ê°€ ì—¬ê¸°ì— ì¶”ê°€ë©ë‹ˆë‹¤]
          
          ---
          ğŸ¤– *SafeWork Security Audit Pipeline - ê°œì¸ê±´ê°•ì •ë³´ ë³´í˜¸ íŠ¹í™”*
          EOF
          
      - name: ğŸ“¤ ë³´ì•ˆ ê°ì‚¬ ê²°ê³¼ ì—…ë¡œë“œ
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: safework-security-audit-reports
          path: |
            security-audit-report.md
            bandit-report.json
            safety-report.json
            semgrep-report.json
          retention-days: 30