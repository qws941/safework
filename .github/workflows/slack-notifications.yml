name: SafeWork Slack Notifications

on:
  issues:
    types: [opened, closed, assigned, labeled]
  pull_request:
    types: [opened, closed, merged, ready_for_review]
  workflow_run:
    workflows: ["Deploy to Production", "SafeWork Claude AI - Issues & PRs", "SafeWork Claude AI - Comments"]
    types: [completed]
  push:
    branches: [master, main]

permissions:
  contents: read
  issues: read
  pull-requests: read
  actions: read

jobs:
  slack-notification:
    runs-on: ubuntu-latest
    timeout-minutes: 5
    
    steps:
      - name: Determine notification type
        id: notification
        run: |
          echo "Determining notification context..."
          
          case "${{ github.event_name }}" in
            "issues")
              case "${{ github.event.action }}" in
                "opened")
                  echo "title=ğŸ› ìƒˆ ì´ìŠˆ ë“±ë¡" >> $GITHUB_OUTPUT
                  echo "message=ì´ìŠˆ #${{ github.event.issue.number }}: ${{ github.event.issue.title }}" >> $GITHUB_OUTPUT
                  echo "color=warning" >> $GITHUB_OUTPUT
                  echo "url=${{ github.event.issue.html_url }}" >> $GITHUB_OUTPUT
                  ;;
                "closed")
                  echo "title=âœ… ì´ìŠˆ í•´ê²°ì™„ë£Œ" >> $GITHUB_OUTPUT
                  echo "message=ì´ìŠˆ #${{ github.event.issue.number }}: ${{ github.event.issue.title }}" >> $GITHUB_OUTPUT
                  echo "color=good" >> $GITHUB_OUTPUT
                  echo "url=${{ github.event.issue.html_url }}" >> $GITHUB_OUTPUT
                  ;;
                "assigned")
                  echo "title=ğŸ‘¤ ì´ìŠˆ ë‹´ë‹¹ì ì§€ì •" >> $GITHUB_OUTPUT
                  echo "message=ì´ìŠˆ #${{ github.event.issue.number }} â†’ ${{ github.event.assignee.login }}" >> $GITHUB_OUTPUT
                  echo "color=good" >> $GITHUB_OUTPUT
                  echo "url=${{ github.event.issue.html_url }}" >> $GITHUB_OUTPUT
                  ;;
                "labeled")
                  echo "title=ğŸ·ï¸ ì´ìŠˆ ë¼ë²¨ ì¶”ê°€" >> $GITHUB_OUTPUT
                  echo "message=ì´ìŠˆ #${{ github.event.issue.number }}: ${{ github.event.label.name }}" >> $GITHUB_OUTPUT
                  echo "color=#439FE0" >> $GITHUB_OUTPUT
                  echo "url=${{ github.event.issue.html_url }}" >> $GITHUB_OUTPUT
                  ;;
              esac
              ;;
            "pull_request")
              case "${{ github.event.action }}" in
                "opened")
                  echo "title=ğŸ”„ ìƒˆ PR ìƒì„±" >> $GITHUB_OUTPUT
                  echo "message=PR #${{ github.event.pull_request.number }}: ${{ github.event.pull_request.title }}" >> $GITHUB_OUTPUT
                  echo "color=warning" >> $GITHUB_OUTPUT
                  echo "url=${{ github.event.pull_request.html_url }}" >> $GITHUB_OUTPUT
                  ;;
                "closed")
                  if [ "${{ github.event.pull_request.merged }}" == "true" ]; then
                    echo "title=ğŸ‰ PR ë³‘í•© ì™„ë£Œ" >> $GITHUB_OUTPUT
                    echo "message=PR #${{ github.event.pull_request.number }}: ${{ github.event.pull_request.title }}" >> $GITHUB_OUTPUT
                    echo "color=good" >> $GITHUB_OUTPUT
                  else
                    echo "title=âŒ PR ë‹«í˜" >> $GITHUB_OUTPUT
                    echo "message=PR #${{ github.event.pull_request.number }}: ${{ github.event.pull_request.title }}" >> $GITHUB_OUTPUT
                    echo "color=danger" >> $GITHUB_OUTPUT
                  fi
                  echo "url=${{ github.event.pull_request.html_url }}" >> $GITHUB_OUTPUT
                  ;;
                "ready_for_review")
                  echo "title=ğŸ‘€ PR ë¦¬ë·° ìš”ì²­" >> $GITHUB_OUTPUT
                  echo "message=PR #${{ github.event.pull_request.number }}: ${{ github.event.pull_request.title }}" >> $GITHUB_OUTPUT
                  echo "color=warning" >> $GITHUB_OUTPUT
                  echo "url=${{ github.event.pull_request.html_url }}" >> $GITHUB_OUTPUT
                  ;;
              esac
              ;;
            "workflow_run")
              if [ "${{ github.event.workflow_run.conclusion }}" == "success" ]; then
                echo "title=âœ… ì›Œí¬í”Œë¡œìš° ì„±ê³µ" >> $GITHUB_OUTPUT
                echo "message=${{ github.event.workflow_run.name }} - ${{ github.event.workflow_run.head_branch }}" >> $GITHUB_OUTPUT
                echo "color=good" >> $GITHUB_OUTPUT
              elif [ "${{ github.event.workflow_run.conclusion }}" == "failure" ]; then
                echo "title=âŒ ì›Œí¬í”Œë¡œìš° ì‹¤íŒ¨" >> $GITHUB_OUTPUT
                echo "message=${{ github.event.workflow_run.name }} - ${{ github.event.workflow_run.head_branch }}" >> $GITHUB_OUTPUT
                echo "color=danger" >> $GITHUB_OUTPUT
              fi
              echo "url=${{ github.event.workflow_run.html_url }}" >> $GITHUB_OUTPUT
              ;;
            "push")
              echo "title=ğŸ“¤ ì½”ë“œ í‘¸ì‹œ" >> $GITHUB_OUTPUT
              echo "message=${{ github.ref_name }} ë¸Œëœì¹˜ì— ${{ github.event.commits | length }}ê°œ ì»¤ë°‹" >> $GITHUB_OUTPUT
              echo "color=good" >> $GITHUB_OUTPUT
              echo "url=${{ github.event.compare }}" >> $GITHUB_OUTPUT
              ;;
          esac

      - name: Send Slack notification
        if: steps.notification.outputs.title != ''
        uses: 8398a7/action-slack@v3
        with:
          status: custom
          custom_payload: |
            {
              "text": "${{ steps.notification.outputs.title }}",
              "attachments": [
                {
                  "color": "${{ steps.notification.outputs.color }}",
                  "fields": [
                    {
                      "title": "SafeWork Repository",
                      "value": "${{ steps.notification.outputs.message }}",
                      "short": false
                    },
                    {
                      "title": "Repository",
                      "value": "${{ github.repository }}",
                      "short": true
                    },
                    {
                      "title": "Actor",
                      "value": "${{ github.actor }}",
                      "short": true
                    },
                    {
                      "title": "Link",
                      "value": "<${{ steps.notification.outputs.url || github.event.repository.html_url }}|View Details>",
                      "short": false
                    }
                  ],
                  "footer": "SafeWork GitHub Actions",
                  "ts": ${{ github.event.head_commit.timestamp && github.event.head_commit.timestamp || 'null' }}
                }
              ]
            }
        env:
          SLACK_WEBHOOK_URL: https://hooks.slack.com/services/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

  slack-deployment-status:
    if: github.event_name == 'workflow_run' && contains(github.event.workflow_run.name, 'Deploy')
    runs-on: ubuntu-latest
    timeout-minutes: 3
    
    steps:
      - name: Send deployment notification
        uses: 8398a7/action-slack@v3
        with:
          status: custom
          custom_payload: |
            {
              "text": "${{ github.event.workflow_run.conclusion == 'success' && 'ğŸš€ SafeWork ë°°í¬ ì™„ë£Œ' || 'ğŸ’¥ SafeWork ë°°í¬ ì‹¤íŒ¨' }}",
              "attachments": [
                {
                  "color": "${{ github.event.workflow_run.conclusion == 'success' && 'good' || 'danger' }}",
                  "fields": [
                    {
                      "title": "ë°°í¬ í™˜ê²½",
                      "value": "${{ contains(github.event.workflow_run.head_branch, 'master') && 'Production' || 'Staging' }}",
                      "short": true
                    },
                    {
                      "title": "ë¸Œëœì¹˜",
                      "value": "${{ github.event.workflow_run.head_branch }}",
                      "short": true
                    },
                    {
                      "title": "ì‹¤í–‰ ì‹œê°„",
                      "value": "${{ github.event.workflow_run.run_attempt }}ì°¨ ì‹œë„",
                      "short": true
                    },
                    {
                      "title": "ìƒíƒœ",
                      "value": "${{ github.event.workflow_run.conclusion }}",
                      "short": true
                    },
                    {
                      "title": "ì›Œí¬í”Œë¡œìš°",
                      "value": "<${{ github.event.workflow_run.html_url }}|${{ github.event.workflow_run.name }}>",
                      "short": false
                    }
                  ],
                  "footer": "SafeWork ìë™ ë°°í¬ ì‹œìŠ¤í…œ",
                  "ts": ${{ github.event.workflow_run.created_at && github.event.workflow_run.created_at || 'null' }}
                }
              ]
            }
        env:
          SLACK_WEBHOOK_URL: https://hooks.slack.com/services/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