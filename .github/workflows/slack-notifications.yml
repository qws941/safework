name: SafeWork Slack Notifications

on:
  issues:
    types: [opened, closed, assigned, labeled]
  pull_request:
    types: [opened, closed, merged, ready_for_review]
  workflow_run:
    workflows: ["Deploy to Production", "SafeWork Claude AI - Issues & PRs", "SafeWork Claude AI - Comments"]
    types: [completed]
  push:
    branches: [master, main]

permissions:
  contents: read
  issues: read
  pull-requests: read
  actions: read

jobs:
  slack-notification:
    runs-on: ubuntu-latest
    timeout-minutes: 5
    
    steps:
      - name: Determine notification type
        id: notification
        run: |
          echo "Determining notification context..."
          
          case "${{ github.event_name }}" in
            "issues")
              case "${{ github.event.action }}" in
                "opened")
                  echo "title=ðŸ› New Issue Created" >> $GITHUB_OUTPUT
                  echo "message=Issue #${{ github.event.issue.number }}: ${{ github.event.issue.title }}" >> $GITHUB_OUTPUT
                  echo "color=warning" >> $GITHUB_OUTPUT
                  echo "url=${{ github.event.issue.html_url }}" >> $GITHUB_OUTPUT
                  ;;
                "closed")
                  echo "title=âœ… Issue Resolved" >> $GITHUB_OUTPUT
                  echo "message=Issue #${{ github.event.issue.number }}: ${{ github.event.issue.title }}" >> $GITHUB_OUTPUT
                  echo "color=good" >> $GITHUB_OUTPUT
                  echo "url=${{ github.event.issue.html_url }}" >> $GITHUB_OUTPUT
                  ;;
                "assigned")
                  echo "title=ðŸ‘¤ Issue Assigned" >> $GITHUB_OUTPUT
                  echo "message=Issue #${{ github.event.issue.number }} â†’ ${{ github.event.assignee.login }}" >> $GITHUB_OUTPUT
                  echo "color=good" >> $GITHUB_OUTPUT
                  echo "url=${{ github.event.issue.html_url }}" >> $GITHUB_OUTPUT
                  ;;
                "labeled")
                  echo "title=ðŸ·ï¸ Issue Labeled" >> $GITHUB_OUTPUT
                  echo "message=Issue #${{ github.event.issue.number }}: ${{ github.event.label.name }}" >> $GITHUB_OUTPUT
                  echo "color=#439FE0" >> $GITHUB_OUTPUT
                  echo "url=${{ github.event.issue.html_url }}" >> $GITHUB_OUTPUT
                  ;;
              esac
              ;;
            "pull_request")
              case "${{ github.event.action }}" in
                "opened")
                  echo "title=ðŸ”„ New PR Created" >> $GITHUB_OUTPUT
                  echo "message=PR #${{ github.event.pull_request.number }}: ${{ github.event.pull_request.title }}" >> $GITHUB_OUTPUT
                  echo "color=warning" >> $GITHUB_OUTPUT
                  echo "url=${{ github.event.pull_request.html_url }}" >> $GITHUB_OUTPUT
                  ;;
                "closed")
                  if [ "${{ github.event.pull_request.merged }}" == "true" ]; then
                    echo "title=ðŸŽ‰ PR Merged" >> $GITHUB_OUTPUT
                    echo "message=PR #${{ github.event.pull_request.number }}: ${{ github.event.pull_request.title }}" >> $GITHUB_OUTPUT
                    echo "color=good" >> $GITHUB_OUTPUT
                  else
                    echo "title=âŒ PR Closed" >> $GITHUB_OUTPUT
                    echo "message=PR #${{ github.event.pull_request.number }}: ${{ github.event.pull_request.title }}" >> $GITHUB_OUTPUT
                    echo "color=danger" >> $GITHUB_OUTPUT
                  fi
                  echo "url=${{ github.event.pull_request.html_url }}" >> $GITHUB_OUTPUT
                  ;;
                "ready_for_review")
                  echo "title=ðŸ‘€ PR Ready for Review" >> $GITHUB_OUTPUT
                  echo "message=PR #${{ github.event.pull_request.number }}: ${{ github.event.pull_request.title }}" >> $GITHUB_OUTPUT
                  echo "color=warning" >> $GITHUB_OUTPUT
                  echo "url=${{ github.event.pull_request.html_url }}" >> $GITHUB_OUTPUT
                  ;;
              esac
              ;;
            "workflow_run")
              if [ "${{ github.event.workflow_run.conclusion }}" == "success" ]; then
                echo "title=âœ… Workflow Success" >> $GITHUB_OUTPUT
                echo "message=${{ github.event.workflow_run.name }} - ${{ github.event.workflow_run.head_branch }}" >> $GITHUB_OUTPUT
                echo "color=good" >> $GITHUB_OUTPUT
              elif [ "${{ github.event.workflow_run.conclusion }}" == "failure" ]; then
                echo "title=âŒ Workflow Failed" >> $GITHUB_OUTPUT
                echo "message=${{ github.event.workflow_run.name }} - ${{ github.event.workflow_run.head_branch }}" >> $GITHUB_OUTPUT
                echo "color=danger" >> $GITHUB_OUTPUT
              fi
              echo "url=${{ github.event.workflow_run.html_url }}" >> $GITHUB_OUTPUT
              ;;
            "push")
              COMMIT_COUNT=$(echo '${{ toJSON(github.event.commits) }}' | jq '. | length')
              echo "title=ðŸ“¤ Code Push" >> $GITHUB_OUTPUT
              echo "message=${COMMIT_COUNT} commits to ${{ github.ref_name }} branch" >> $GITHUB_OUTPUT
              echo "color=good" >> $GITHUB_OUTPUT
              echo "url=${{ github.event.compare }}" >> $GITHUB_OUTPUT
              ;;
          esac

      - name: Send Slack notification
        if: steps.notification.outputs.title != ''
        uses: 8398a7/action-slack@v3
        with:
          status: custom
          custom_payload: |
            {
              "text": "${{ steps.notification.outputs.title }}",
              "attachments": [
                {
                  "color": "${{ steps.notification.outputs.color }}",
                  "fields": [
                    {
                      "title": "SafeWork Repository",
                      "value": "${{ steps.notification.outputs.message }}",
                      "short": false
                    },
                    {
                      "title": "Repository",
                      "value": "${{ github.repository }}",
                      "short": true
                    },
                    {
                      "title": "Actor",
                      "value": "${{ github.actor }}",
                      "short": true
                    },
                    {
                      "title": "Link",
                      "value": "<${{ steps.notification.outputs.url || github.event.repository.html_url }}|View Details>",
                      "short": false
                    }
                  ],
                  "footer": "SafeWork GitHub Actions"
                }
              ]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

  slack-deployment-status:
    if: github.event_name == 'workflow_run' && contains(github.event.workflow_run.name, 'Deploy')
    runs-on: ubuntu-latest
    timeout-minutes: 3
    
    steps:
      - name: Send deployment notification
        uses: 8398a7/action-slack@v3
        with:
          status: custom
          custom_payload: |
            {
              "text": "${{ github.event.workflow_run.conclusion == 'success' && 'ðŸš€ SafeWork Deployment Complete' || 'ðŸ’¥ SafeWork Deployment Failed' }}",
              "attachments": [
                {
                  "color": "${{ github.event.workflow_run.conclusion == 'success' && 'good' || 'danger' }}",
                  "fields": [
                    {
                      "title": "Environment",
                      "value": "${{ contains(github.event.workflow_run.head_branch, 'master') && 'Production' || 'Staging' }}",
                      "short": true
                    },
                    {
                      "title": "Branch",
                      "value": "${{ github.event.workflow_run.head_branch }}",
                      "short": true
                    },
                    {
                      "title": "Run Attempt",
                      "value": "#${{ github.event.workflow_run.run_attempt }}",
                      "short": true
                    },
                    {
                      "title": "Status",
                      "value": "${{ github.event.workflow_run.conclusion }}",
                      "short": true
                    },
                    {
                      "title": "Workflow",
                      "value": "<${{ github.event.workflow_run.html_url }}|${{ github.event.workflow_run.name }}>",
                      "short": false
                    }
                  ],
                  "footer": "SafeWork Auto Deploy System"
                }
              ]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}