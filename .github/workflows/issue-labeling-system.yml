name: SafeWork Issue Labeling System

on:
  issues:
    types: [opened, edited, reopened]
  issue_comment:
    types: [created]
  workflow_dispatch:
    inputs:
      issue_number:
        description: 'ÎùºÎ≤®ÎßÅÌï† Ïù¥Ïäà Î≤àÌò∏'
        required: true
        type: string

jobs:
  smart-labeling:
    runs-on: ubuntu-latest
    timeout-minutes: 5
    
    permissions:
      issues: write
      contents: read
      
    steps:
      - name: SafeWork Smart Labeling System
        uses: actions/github-script@v7
        with:
          script: |
            console.log("üè∑Ô∏è SafeWork Smart Labeling System starting...");
            
            const issueNumber = context.issue?.number || '${{ github.event.inputs.issue_number }}';
            
            if (!issueNumber) {
              console.log("‚ùå Ïù¥Ïäà Î≤àÌò∏Î•º Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§.");
              return;
            }
            
            // Ïù¥Ïäà Ï†ïÎ≥¥ Í∞ÄÏ†∏Ïò§Í∏∞
            const { data: issue } = await github.rest.issues.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber
            });
            
            const title = (issue.title || '').toLowerCase();
            const body = (issue.body || '').toLowerCase();
            const author = issue.user.login;
            const content = `${title} ${body}`;
            
            console.log(`üìã Ïù¥Ïäà Î∂ÑÏÑù: #${issueNumber} - ${issue.title}`);
            console.log(`üë§ ÏûëÏÑ±Ïûê: ${author}`);
            
            // SafeWork domain-specific label classification logic
            const labels = [];
            
            // 1. Priority auto-classification (easy for non-developers to understand)
            if (content.includes('Ï§ëÎã®') || content.includes('ÏûëÎèô Ïïà') || content.includes('Ï†ëÏÜç Î∂àÍ∞Ä') || 
                content.includes('Ïò§Î•ò') || content.includes('ÏóêÎü¨') || content.includes('urgent') || 
                content.includes('critical') || content.includes('Î¨∏Ï†ú')) {
              labels.push('urgent');
            } else if (content.includes('ÎäêÎ¶º') || content.includes('Í∞úÏÑ†') || content.includes('Î∂àÌé∏') ||
                       content.includes('enhancement') || content.includes('feature')) {
              labels.push('enhancement');
            } else if (content.includes('Î¨∏Ïùò') || content.includes('ÏßàÎ¨∏') || content.includes('ÏÇ¨Ïö©Î≤ï') ||
                       content.includes('question') || content.includes('how to')) {
              labels.push('question');
            } else {
              labels.push('general');
            }
            
            // 2. SafeWork functional area classification
            if (content.includes('ÏÑ§Î¨∏') || content.includes('survey') || content.includes('001') || content.includes('002') ||
                content.includes('Í∑ºÍ≥®Í≤©') || content.includes('Ïã†Í∑úÏûÖÏÇ¨')) {
              labels.push('area/survey');
            }
            
            if (content.includes('Í¥ÄÎ¶¨Ïûê') || content.includes('admin') || content.includes('Í¥ÄÎ¶¨Ìå®ÎÑê') || 
                content.includes('ÎåÄÏãúÎ≥¥Îìú') || content.includes('dashboard')) {
              labels.push('area/admin');
            }
            
            if (content.includes('Í±¥Í∞ï') || content.includes('ÏùòÎ£å') || content.includes('Í≤ÄÏßÑ') || content.includes('health') ||
                content.includes('medical') || content.includes('ÏùòÏïΩÌíà') || content.includes('medication')) {
              labels.push('area/medical');
            }
            
            if (content.includes('Î¨∏ÏÑú') || content.includes('ÌååÏùº') || content.includes('document') || 
                content.includes('upload') || content.includes('Îã§Ïö¥Î°úÎìú') || content.includes('download')) {
              labels.push('area/document');
            }
            
            if (content.includes('Î°úÍ∑∏Ïù∏') || content.includes('ÌöåÏõêÍ∞ÄÏûÖ') || content.includes('Ïù∏Ï¶ù') || 
                content.includes('login') || content.includes('auth') || content.includes('password')) {
              labels.push('area/auth');
            }
            
            if (content.includes('api') || content.includes('Ïó∞Îèô') || content.includes('integration') ||
                content.includes('Ïô∏Î∂Ä') || content.includes('export') || content.includes('import')) {
              labels.push('area/api');
            }
            
            // 3. Technical classification (developer-friendly but understandable terms)
            if (content.includes('Î™®Î∞îÏùº') || content.includes('mobile') || content.includes('Ïä§ÎßàÌä∏Ìè∞') || 
                content.includes('tablet') || content.includes('Î∞òÏùëÌòï')) {
              labels.push('tech/mobile');
            }
            
            if (content.includes('ÏÜçÎèÑ') || content.includes('ÎäêÎ¶º') || content.includes('performance') || 
                content.includes('Îπ†Î•¥Í≤å') || content.includes('ÏµúÏ†ÅÌôî')) {
              labels.push('tech/performance');
            }
            
            if (content.includes('ÎîîÏûêÏù∏') || content.includes('ui') || content.includes('ÌôîÎ©¥') || 
                content.includes('Î≤ÑÌäº') || content.includes('ÏÉâÏÉÅ') || content.includes('Î†àÏù¥ÏïÑÏõÉ')) {
              labels.push('tech/ui');
            }
            
            // 4. User type classification
            if (content.includes('Í∞ÑÌò∏ÏÇ¨') || content.includes('ÏùòÎ£åÏßÑ') || content.includes('Î≥¥Í±¥Í¥ÄÎ¶¨Ïûê')) {
              labels.push('user/medical-staff');
            }
            
            if (content.includes('ÏïàÏ†ÑÍ¥ÄÎ¶¨Ïûê') || content.includes('Í¥ÄÎ¶¨Ïûê') || content.includes('Îã¥ÎãπÏûê')) {
              labels.push('user/admin');
            }
            
            if (content.includes('Í∑ºÎ°úÏûê') || content.includes('ÏßÅÏõê') || content.includes('ÏÇ¨Ïö©Ïûê') || content.includes('ÏùºÎ∞ò')) {
              labels.push('user/worker');
            }
            
            // 5. Korean language related issues
            if (content.includes('ÌïúÍ∏Ä') || content.includes('ÌïúÍµ≠Ïñ¥') || content.includes('Î≤àÏó≠') || 
                content.includes('Ïñ∏Ïñ¥') || /[Í∞Ä-Ìû£]/.test(title + body)) {
              labels.push('lang/korean');
            }
            
            // 6. Data/security related (PHI important)
            if (content.includes('Í∞úÏù∏Ï†ïÎ≥¥') || content.includes('Î≥¥Ïïà') || content.includes('ÏïîÌò∏Ìôî') || 
                content.includes('privacy') || content.includes('security') || content.includes('phi')) {
              labels.push('security/phi');
            }
            
            if (content.includes('Î∞±ÏóÖ') || content.includes('Îç∞Ïù¥ÌÑ∞') || content.includes('ÏÜêÏã§') || 
                content.includes('Î≥µÍµ¨') || content.includes('backup') || content.includes('data')) {
              labels.push('data/backup');
            }
            
            // 7. Browser compatibility
            if (content.includes('ie') || content.includes('explorer') || content.includes('chrome') || 
                content.includes('safari') || content.includes('firefox') || content.includes('Î∏åÎùºÏö∞Ï†Ä')) {
              labels.push('tech/browser');
            }
            
            // 8. Check existing labels and remove duplicates
            const existingLabels = issue.labels.map(label => 
              typeof label === 'string' ? label : label.name
            );
            
            const newLabels = labels.filter(label => !existingLabels.includes(label));
            
            console.log(`üè∑Ô∏è Existing labels: ${existingLabels.join(', ')}`);
            console.log(`üÜï New labels: ${newLabels.join(', ')}`);
            
            // Apply labels
            if (newLabels.length > 0) {
              try {
                await github.rest.issues.addLabels({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: issueNumber,
                  labels: newLabels
                });
                
                console.log(`‚úÖ ${newLabels.length} labels added successfully!`);
                
                // Add non-developer friendly comment (Korean)
                const labelExplanation = `
            üè∑Ô∏è **Auto Labeling Complete!**
            
            This issue has been classified as follows:
            
            ${newLabels.map(label => {
              const explanations = {
                'urgent': 'Critical issue requiring immediate attention.',
                'enhancement': 'Feature improvement or new feature request.',
                'question': 'Usage question or feature inquiry.',
                'general': 'General issue or feedback.',
                'area/survey': 'Survey system related issue.',
                'area/admin': 'Admin panel related issue.',
                'area/medical': 'Medical/health check related issue.',
                'area/document': 'Document management related issue.',
                'area/auth': 'Authentication or login related issue.',
                'area/api': 'API or external integration related issue.',
                'tech/mobile': 'Mobile device usability related issue.',
                'tech/performance': 'System performance related issue.',
                'tech/ui': 'User interface design related issue.',
                'user/medical-staff': 'Medical staff function related issue.',
                'user/admin': 'Safety manager or system admin related issue.',
                'user/worker': 'General worker function related issue.',
                'lang/korean': 'Korean language or localization related issue.',
                'security/phi': 'Security or personal health information related issue.',
                'data/backup': 'Data storage or backup related issue.',
                'tech/browser': 'Browser compatibility related issue.'
              };
              return `- **${label}**: ${explanations[label] || 'Related issue.'}`;
            }).join('\n')}
            
            üìû **Need Help?**
            - Urgent issues: Mention @claude for immediate assistance
            - General inquiries: Add additional details in the issue
            
            ---
            ü§ñ *SafeWork Auto Labeling System*`;
                
                if (newLabels.some(label => ['urgent', 'enhancement', 'question'].includes(label))) {
                  await github.rest.issues.createComment({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    issue_number: issueNumber,
                    body: labelExplanation
                  });
                  
                  console.log("üí¨ User-friendly explanation comment added");
                }
                
                // Automatically call Claude AI for urgent issues
                if (newLabels.includes('urgent')) {
                  await github.rest.issues.createComment({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    issue_number: issueNumber,
                    body: `üö® **Urgent Issue Auto Processing**\n\n@claude Please analyze this urgent issue immediately and provide solution.\n\nPriority: P0-CRITICAL`
                  });
                  
                  console.log("üö® Claude AI automatically called for urgent issue");
                }
                
              } catch (error) {
                console.log(`‚ùå Label addition failed: ${error.message}`);
              }
            } else {
              console.log("‚ÑπÔ∏è No new labels to add.");
            }

  # Issue Statistics and Dashboard Update
  update-dashboard:
    needs: smart-labeling
    if: always()
    runs-on: ubuntu-latest
    timeout-minutes: 3
    
    steps:
      - name: SafeWork Issue Dashboard Update
        uses: actions/github-script@v7
        with:
          script: |
            console.log("üìä SafeWork Issue Dashboard Update...");
            
            try {
              // Get all open issues
              const { data: issues } = await github.rest.issues.listForRepo({
                owner: context.repo.owner,
                repo: context.repo.repo,
                state: 'open',
                per_page: 100
              });
              
              // Aggregate statistics by label
              const labelStats = {};
              const priorityStats = {'urgent': 0, 'enhancement': 0, 'question': 0, 'general': 0};
              const areaStats = {};
              
              issues.forEach(issue => {
                issue.labels.forEach(label => {
                  const labelName = typeof label === 'string' ? label : label.name;
                  labelStats[labelName] = (labelStats[labelName] || 0) + 1;
                  
                  // Priority statistics
                  if (priorityStats.hasOwnProperty(labelName)) {
                    priorityStats[labelName]++;
                  }
                  
                  // Area statistics
                  if (labelName.includes('area/') || labelName.includes('tech/') || labelName.includes('user/')) {
                    areaStats[labelName] = (areaStats[labelName] || 0) + 1;
                  }
                });
              });
              
              console.log("üìà Issue Status:");
              console.log(`  - Total open issues: ${issues.length}`);
              console.log("üìä By Priority:");
              Object.entries(priorityStats).forEach(([label, count]) => {
                if (count > 0) console.log(`  - ${label}: ${count}`);
              });
              
              console.log("üéØ By Area:");
              Object.entries(areaStats).forEach(([label, count]) => {
                console.log(`  - ${label}: ${count}`);
              });
              
              // Update dashboard section in README if exists
              // (Future expansion possible)
              
            } catch (error) {
              console.log(`‚ùå Dashboard update failed: ${error.message}`);
            }