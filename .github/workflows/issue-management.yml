name: ì´ìŠˆ ê´€ë¦¬ ê³ ë„í™” ì‹œìŠ¤í…œ

on:
  issues:
    types: [opened, edited]
  workflow_dispatch:
    inputs:
      action:
        description: 'ìˆ˜í–‰í•  ì‘ì—…'
        required: true
        type: choice
        options:
          - cleanup-comments
          - relabel-all
          - analyze-all

permissions:
  issues: write
  contents: read

jobs:
  # ìƒˆ ì´ìŠˆ ìë™ ë¼ë²¨ë§
  auto-label:
    if: github.event_name == 'issues'
    runs-on: ubuntu-latest
    steps:
      - name: ì²´ê³„ì  ë¼ë²¨ ì ìš©
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const issue = context.payload.issue;
            const title = issue.title.toLowerCase();
            const body = (issue.body || '').toLowerCase();
            const content = title + ' ' + body;
            
            // ê¸°ì¡´ ë¼ë²¨ ëª¨ë‘ ì œê±°
            const currentLabels = issue.labels.map(l => l.name);
            if (currentLabels.length > 0) {
              await github.rest.issues.removeAllLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number
              }).catch(() => {}); // ë¼ë²¨ì´ ì—†ì„ ìˆ˜ë„ ìˆìŒ
            }
            
            // ìƒˆë¡œìš´ ë¼ë²¨ ì²´ê³„
            const labels = [];
            
            // 1. íƒ€ì… (í•˜ë‚˜ë§Œ)
            if (content.includes('ë²„ê·¸') || content.includes('bug') || content.includes('ì˜¤ë¥˜') || content.includes('ì—ëŸ¬') || content.includes('error') || content.includes('ì•ˆë¨') || content.includes('ì•ˆë¼')) {
              labels.push('ğŸ› bug');
            } else if (content.includes('ê¸°ëŠ¥') || content.includes('feature') || content.includes('ì¶”ê°€') || content.includes('êµ¬í˜„')) {
              labels.push('âœ¨ enhancement');
            } else if (content.includes('ë¦¬íŒ©í† ë§') || content.includes('refactor') || content.includes('ê°œì„ ')) {
              labels.push('â™»ï¸ refactor');
            } else if (content.includes('ë¬¸ì„œ') || content.includes('doc') || content.includes('readme')) {
              labels.push('ğŸ“ documentation');
            } else if (content.includes('í…ŒìŠ¤íŠ¸') || content.includes('test')) {
              labels.push('ğŸ§ª test');
            } else {
              labels.push('ğŸ“‹ task');
            }
            
            // 2. ìš°ì„ ìˆœìœ„ (í•˜ë‚˜ë§Œ)
            if (content.includes('ê¸´ê¸‰') || content.includes('urgent') || content.includes('asap') || content.includes('ì¦‰ì‹œ') || content.includes('í¬ë¦¬í‹°ì»¬')) {
              labels.push('ğŸ”´ P0-urgent');
            } else if (content.includes('ì¤‘ìš”') || content.includes('important') || content.includes('ë†’ìŒ')) {
              labels.push('ğŸŸ  P1-high');
            } else if (content.includes('ë³´í†µ') || content.includes('normal')) {
              labels.push('ğŸŸ¡ P2-medium');
            } else {
              labels.push('ğŸŸ¢ P3-low');
            }
            
            // 3. ì˜ì—­ (ë³µìˆ˜ ê°€ëŠ¥)
            if (content.includes('ui') || content.includes('í™”ë©´') || content.includes('í…œí”Œë¦¿') || content.includes('í”„ë¡ íŠ¸')) {
              labels.push('ğŸ¨ frontend');
            }
            if (content.includes('api') || content.includes('ë°±ì—”ë“œ') || content.includes('ì„œë²„') || content.includes('db') || content.includes('ë°ì´í„°ë² ì´ìŠ¤')) {
              labels.push('âš™ï¸ backend');
            }
            if (content.includes('ë³´ì•ˆ') || content.includes('security') || content.includes('ì¸ì¦') || content.includes('ê¶Œí•œ')) {
              labels.push('ğŸ”’ security');
            }
            if (content.includes('ì„±ëŠ¥') || content.includes('performance') || content.includes('ìµœì í™”') || content.includes('ì†ë„')) {
              labels.push('âš¡ performance');
            }
            if (content.includes('docker') || content.includes('ë„ì»¤') || content.includes('ì»¨í…Œì´ë„ˆ') || content.includes('ë°°í¬')) {
              labels.push('ğŸ³ devops');
            }
            
            // 4. ìƒíƒœ
            labels.push('ğŸ†• new');
            
            // 5. Claude ì²˜ë¦¬ ëŒ€ìƒ
            labels.push('ğŸ¤– claude-ready');
            
            // ë¼ë²¨ ì ìš©
            await github.rest.issues.setLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issue.number,
              labels: labels
            });
            
            // ê¹”ë”í•œ ë‹¨ì¼ ì½”ë©˜íŠ¸
            const typeLabel = labels.find(l => l.includes('bug') || l.includes('enhancement') || l.includes('refactor') || l.includes('documentation') || l.includes('test') || l.includes('task'));
            const priorityLabel = labels.find(l => l.includes('P0') || l.includes('P1') || l.includes('P2') || l.includes('P3'));
            const areaLabels = labels.filter(l => l.includes('frontend') || l.includes('backend') || l.includes('security') || l.includes('performance') || l.includes('devops'));
            
            const comment = `## ğŸ¯ ì´ìŠˆ ë¶„ì„ ì™„ë£Œ

**íƒ€ì…**: ${typeLabel}
**ìš°ì„ ìˆœìœ„**: ${priorityLabel}
**ì˜ì—­**: ${areaLabels.length > 0 ? areaLabels.join(', ') : 'ì¼ë°˜'}

ì´ìŠˆê°€ ìë™ ë¶„ë¥˜ë˜ì—ˆìŠµë‹ˆë‹¤. \`@claude\`ë¥¼ ë©˜ì…˜í•˜ì—¬ ì²˜ë¦¬ë¥¼ ì‹œì‘í•˜ì„¸ìš”.`;
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issue.number,
              body: comment
            });

  # ê¸°ì¡´ ì´ìŠˆ ì •ë¦¬ ë° ì¬ë¼ë²¨ë§
  cleanup-and-relabel:
    if: github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    steps:
      - name: ëª¨ë“  ì´ìŠˆ ì¬ë¶„ì„
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const action = '${{ github.event.inputs.action }}';
            
            // ëª¨ë“  ì˜¤í”ˆ ì´ìŠˆ ê°€ì ¸ì˜¤ê¸°
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              per_page: 100
            });
            
            for (const issue of issues.data) {
              // PRì€ ì œì™¸
              if (issue.pull_request) continue;
              
              if (action === 'cleanup-comments' || action === 'analyze-all') {
                // ê¸°ì¡´ ë´‡ ì½”ë©˜íŠ¸ ì‚­ì œ
                const comments = await github.rest.issues.listComments({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: issue.number
                });
                
                for (const comment of comments.data) {
                  // ë´‡ì´ë‚˜ ìë™í™” ì½”ë©˜íŠ¸ ì‚­ì œ
                  if (comment.user.type === 'Bot' || 
                      comment.body.includes('ìë™ ë¶„ë¥˜') || 
                      comment.body.includes('ìë™ ì²˜ë¦¬') ||
                      comment.body.includes('Claude Code') ||
                      comment.body.includes('ì´ìŠˆ ë¶„ì„ ì™„ë£Œ')) {
                    await github.rest.issues.deleteComment({
                      owner: context.repo.owner,
                      repo: context.repo.repo,
                      comment_id: comment.id
                    });
                  }
                }
              }
              
              if (action === 'relabel-all' || action === 'analyze-all') {
                const title = issue.title.toLowerCase();
                const body = (issue.body || '').toLowerCase();
                const content = title + ' ' + body;
                
                // ê¸°ì¡´ ë¼ë²¨ ì œê±°
                if (issue.labels.length > 0) {
                  await github.rest.issues.removeAllLabels({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    issue_number: issue.number
                  }).catch(() => {});
                }
                
                // ìƒˆ ë¼ë²¨ ì ìš©
                const labels = [];
                
                // íƒ€ì…
                if (content.includes('ë²„ê·¸') || content.includes('bug') || content.includes('ì˜¤ë¥˜')) {
                  labels.push('ğŸ› bug');
                } else if (content.includes('ê¸°ëŠ¥') || content.includes('feature')) {
                  labels.push('âœ¨ enhancement');
                } else {
                  labels.push('ğŸ“‹ task');
                }
                
                // ìš°ì„ ìˆœìœ„
                if (content.includes('ê¸´ê¸‰') || content.includes('urgent')) {
                  labels.push('ğŸ”´ P0-urgent');
                } else {
                  labels.push('ğŸŸ¡ P2-medium');
                }
                
                // ìƒíƒœ
                const created = new Date(issue.created_at);
                const now = new Date();
                const days = (now - created) / (1000 * 60 * 60 * 24);
                
                if (days > 7) {
                  labels.push('â° stale');
                } else {
                  labels.push('ğŸ†• new');
                }
                
                labels.push('ğŸ¤– claude-ready');
                
                await github.rest.issues.setLabels({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: issue.number,
                  labels: labels
                });
                
                // ë‹¨ì¼ ë¶„ì„ ì½”ë©˜íŠ¸
                if (action === 'analyze-all') {
                  await github.rest.issues.createComment({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    issue_number: issue.number,
                    body: `## ğŸ”„ ì¬ë¶„ì„ ì™„ë£Œ\n\nì´ìŠˆê°€ ì¬ë¶„ë¥˜ë˜ì—ˆìŠµë‹ˆë‹¤. \`@claude\`ë¥¼ ë©˜ì…˜í•˜ì—¬ ì²˜ë¦¬ë¥¼ ì‹œì‘í•˜ì„¸ìš”.`
                  });
                }
              }
              
              // ì²˜ë¦¬ ê°„ê²© (API ì œí•œ ë°©ì§€)
              await new Promise(resolve => setTimeout(resolve, 1000));
            }
            
            // ì™„ë£Œ ì´ìŠˆ ìƒì„±
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `âœ… ì´ìŠˆ ì •ë¦¬ ì™„ë£Œ - ${new Date().toLocaleDateString('ko-KR')}`,
              body: `## ì´ìŠˆ ê´€ë¦¬ ì‘ì—… ì™„ë£Œ\n\n**ìˆ˜í–‰í•œ ì‘ì—…**: ${action}\n**ì²˜ë¦¬ëœ ì´ìŠˆ**: ${issues.data.length}ê°œ\n\nëª¨ë“  ì´ìŠˆê°€ ì¼ê´€ëœ ì²´ê³„ë¡œ ì¬ë¶„ë¥˜ë˜ì—ˆìŠµë‹ˆë‹¤.`,
              labels: ['ğŸ“ documentation']
            });