name: 🔧 Claude Maintenance & Health Check

on:
  schedule:
    # Run daily at 2 AM KST (17:00 UTC)
    - cron: '0 17 * * *'
  workflow_dispatch:
    inputs:
      maintenance_type:
        description: 'Type of maintenance to perform'
        required: false
        default: 'full'
        type: choice
        options:
          - 'full'
          - 'security'
          - 'performance'
          - 'dependencies'

jobs:
  claude-maintenance:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      issues: write
      pull-requests: write
      security-events: write
      id-token: write
    
    steps:
      - name: 📥 Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: 🔧 Claude Automated Maintenance
        uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          track_progress: true
          prompt: |
            REPO: ${{ github.repository }}
            MAINTENANCE TYPE: ${{ github.event.inputs.maintenance_type || 'full' }}

            🔧 **SafeWork 시스템 자동 유지보수**
            
            SafeWork 산업안전보건 관리 시스템의 정기적인 유지보수를 수행해주세요.

            **유지보수 체크리스트:**

            **1. 보안 검사**
            - Python 패키지 취약점 스캔 (requirements.txt)
            - Docker 이미지 보안 검사
            - 환경변수 및 시크릿 관리 점검
            - Flask 보안 설정 검토
            - SQL 인젝션 및 XSS 방지 검증

            **2. 성능 최적화**
            - 데이터베이스 쿼리 성능 분석
            - Redis 캐시 효율성 검토
            - Docker 컨테이너 리소스 사용량 체크
            - 로그 파일 크기 및 로테이션 확인
            - 페이지 로딩 속도 최적화

            **3. 코드 품질 관리**
            - Python 코드 스타일 검사 (flake8, black)
            - 미사용 imports 및 변수 제거
            - 코드 복잡도 분석
            - 테스트 커버리지 확인
            - 문서화 상태 점검

            **4. 의존성 관리**
            - Python 패키지 업데이트 가능성 검토
            - 보안 업데이트 우선순위 분석
            - 호환성 검증
            - 라이센스 준수 확인

            **5. 데이터베이스 건강성 검사**
            - 마이그레이션 상태 확인
            - 인덱스 최적화 검토
            - 데이터 무결성 검증
            - 백업 정책 점검

            **6. SafeWork 특화 점검**
            - 설문조사 시스템 정상 작동 확인
            - 한국어 인코딩 및 KST 시간 처리
            - 산업안전보건 데이터 정합성
            - 개인정보보호 정책 준수

            **자동화 가능한 작업:**
            - 패키지 업데이트 PR 생성
            - 보안 패치 적용
            - 코드 포맷팅 수정
            - 문서 업데이트
            - 테스트 케이스 추가

            발견된 문제점들을 분류하고, 자동으로 수정 가능한 것들은 PR을 생성해주세요.
            중요한 보안 이슈는 별도의 이슈로 생성하여 알려주세요.

          claude_args: |
            --allowedTools "mcp__serena__*,mcp__sequential-thinking__*,mcp__shrimp-task-manager__*,mcp__github__*,Bash(gh:*),Bash(git:*),Bash(pip:*),Bash(docker:*)"