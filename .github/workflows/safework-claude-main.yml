name: SafeWork Claude AI - Comments

on:
  issue_comment:
    types: [created]
  pull_request_review_comment:
    types: [created]
  pull_request_review:
    types: [submitted]
  workflow_dispatch:
    inputs:
      issue_number:
        description: 'Issue number to process'
        required: false
        type: string
      pr_number:
        description: 'PR number to process'
        required: false
        type: string
      action_type:
        description: 'Type of action to perform'
        required: false
        default: 'analyze'
        type: choice
        options:
        - analyze
        - fix
        - review
        - deploy

permissions:
  contents: write
  pull-requests: write
  issues: write
  actions: read
  id-token: write

jobs:
  safework-claude:
    if: |
      (github.event_name == 'issue_comment' && contains(github.event.comment.body, '@claude')) ||
      (github.event_name == 'pull_request_review_comment' && contains(github.event.comment.body, '@claude')) ||
      (github.event_name == 'pull_request_review' && contains(github.event.review.body, '@claude')) ||
      github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Python for SafeWork context
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: Install SafeWork dependencies
        run: |
          cd app
          pip install -r requirements.txt

      - name: Run SafeWork Claude AI
        id: claude
        uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          model: "claude-opus-4-1-20250805"
          track_progress: false
          use_sticky_comment: true
          use_commit_signing: false
          
          # Enhanced prompt with SafeWork domain expertise
          prompt: |
            # SafeWork ì‚°ì—…ë³´ê±´ì•ˆì „ ì‹œìŠ¤í…œ ì „ë¬¸ê°€ Claude

            ## ì‹œìŠ¤í…œ ì»¨í…ìŠ¤íŠ¸
            **í”„ë¡œì íŠ¸**: SafeWork - ì‚°ì—…ë³´ê±´ì•ˆì „ ê´€ë¦¬ì‹œìŠ¤í…œ (Flask 3.0+)
            **ì €ì¥ì†Œ**: ${{ github.repository }}
            **ì´ë²¤íŠ¸**: ${{ github.event_name }}
            ${{ github.event_name == 'issues' && format('**ì´ìŠˆ ë²ˆí˜¸**: #{0}', github.event.issue.number) || '' }}
            ${{ github.event_name == 'pull_request' && format('**PR ë²ˆí˜¸**: #{0}', github.event.pull_request.number) || '' }}
            ${{ github.event_name == 'workflow_dispatch' && format('**ìˆ˜ë™ ì‹¤í–‰** - ì´ìŠˆ: {0}, PR: {1}, ì•¡ì…˜: {2}', inputs.issue_number, inputs.pr_number, inputs.action_type) || '' }}

            ## ë„ë©”ì¸ ì „ë¬¸ì„±
            - **ì˜ë£Œ/ë³´ê±´**: ê·¼ê³¨ê²©ê³„ ì„¤ë¬¸(001), ì‹ ê·œì ê±´ê°•ê²€ì§„(002), 13ê°œ SafeWork ê´€ë¦¬íŒ¨ë„
            - **ê¸°ìˆ ìŠ¤íƒ**: Flask 3.0+, SQLAlchemy 2.0, MySQL 8.0, Redis, Docker, Bootstrap 4.6
            - **ì›Œí¬í”Œë¡œ**: Watchtower ìë™ë°°í¬, 5ê°œ íŠ¹í™” GitHub Actions, í•œêµ­ì–´ ì§€ì›

            ## AI ì—ì´ì „íŠ¸ ì—­í• 
            1. **í•œêµ­ì–´ ìš°ì„  ì‘ë‹µ**: í•œêµ­ì–´ ì»¨í…ì¸  ê°ì§€ì‹œ í•œêµ­ì–´ë¡œ ì‘ë‹µ
            2. **ë„ë©”ì¸ ì»¨í…ìŠ¤íŠ¸ ë¶„ì„**: 
               - ì„¤ë¬¸ì‹œìŠ¤í…œ â†’ `ì„¤ë¬¸`, `survey`, `001`, `002` í‚¤ì›Œë“œ
               - ê´€ë¦¬ì‹œìŠ¤í…œ â†’ `ê´€ë¦¬ì`, `admin`, `safework` í‚¤ì›Œë“œ  
               - ì˜ë£Œì‹œìŠ¤í…œ â†’ `ì˜ë£Œ`, `health`, `ê²€ì§„` í‚¤ì›Œë“œ
               - APIì—°ë™ â†’ `api`, `ì—°ë™`, `integration` í‚¤ì›Œë“œ
            3. **ìë™ ë¬¸ì œí•´ê²°**: 
               - ESLint ì˜¤ë¥˜ ìˆ˜ì • (18ê°œ ì˜¤ë¥˜, 1ê°œ ê²½ê³ )
               - í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨ ë¶„ì„ (39/39 í†µê³¼ ëª©í‘œ)
               - ë°ì´í„°ë² ì´ìŠ¤ ë§ˆì´ê·¸ë ˆì´ì…˜ ì˜¤ë¥˜
               - Docker ë°°í¬ ì´ìŠˆ
            4. **ë³´ì•ˆ ìš°ì„ **: 
               - PHI(ê°œì¸ê±´ê°•ì •ë³´) ë³´í˜¸
               - CSRF í† í° ê²€ì¦
               - SQL ì¸ì ì…˜ ë°©ì§€
               - ìµëª… ì„¤ë¬¸ ì§€ì› (user_id=1)

            ## ì‘ì—… ìš°ì„ ìˆœìœ„
            1. **P0-ê¸´ê¸‰**: `ê¸´ê¸‰`, `urgent`, `critical`, `ì¤‘ë‹¨`, `ì‘ë™ ì•ˆ` í‚¤ì›Œë“œ
            2. **ë³´ì•ˆ ì´ìŠˆ**: ì·¨ì•½ì , ê°œì¸ì •ë³´, ì¸ì¦ ê´€ë ¨
            3. **ì˜ë£Œ ë°ì´í„°**: ê±´ê°•ê²€ì§„, ì„¤ë¬¸ì¡°ì‚¬ ê´€ë ¨ ì˜¤ë¥˜
            4. **ë°°í¬ íŒŒì´í”„ë¼ì¸**: CI/CD, Docker, Watchtower ì´ìŠˆ

            ## ê¸°ìˆ ì  ê°€ì´ë“œë¼ì¸
            - **MySQL 8.0**: UTF8MB4, íŠ¸ëœì­ì…˜, `kst_now()` íƒ€ì„ì¡´
            - **Flask íŒ¨í„´**: Blueprint ê¸°ë°˜ 8ê°œ ë¼ìš°í„°, Factory íŒ¨í„´
            - **ë³´ì•ˆ**: `@login_required`, CSRF ì „ì—­, ê°ì‚¬ë¡œê·¸, ë¹„ìœ¨ì œí•œ
            - **ì„±ëŠ¥**: Redis ìºì‹±, DB ì¸ë±ì‹±, ì§€ì—°ë¡œë”©, í˜ì´ì§•(20/page)
            - **í…ŒìŠ¤íŠ¸**: pytest, 80%+ ì»¤ë²„ë¦¬ì§€, conftest.py í”½ìŠ¤ì²˜

            **ì§€ê¸ˆ ë¶„ì„í•˜ê³  í•„ìš”í•œ ì‘ì—…ì„ ìˆ˜í–‰í•´ì£¼ì„¸ìš”.**

          # SafeWork-optimized tool permissions
          claude_args: |
            --allowedTools "Edit,MultiEdit,Write,Read,Glob,Grep,Bash(git:*),Bash(python:*),Bash(pip:*),Bash(pytest:*),Bash(docker:*),Bash(gh:*),Bash(npm:*),Bash(mysql:*)"
            --model claude-sonnet-4-20250514
            --max-turns 15

      - name: Post-process results
        if: always()
        run: |
          echo "SafeWork Claude AI ì‘ì—… ì™„ë£Œ"
          echo "ì´ë²¤íŠ¸: ${{ github.event_name }}"
          echo "ìƒíƒœ: ${{ steps.claude.conclusion }}"

      - name: Send Slack notification
        if: always()
        uses: 8398a7/action-slack@v3
        with:
          status: custom
          custom_payload: |
            {
              "text": "${{ steps.claude.conclusion == 'success' && 'ğŸ¤– Claude AI ì‘ì—… ì™„ë£Œ' || 'âš ï¸ Claude AI ì‘ì—… ì´ìŠˆ' }}",
              "attachments": [
                {
                  "color": "${{ steps.claude.conclusion == 'success' && 'good' || 'warning' }}",
                  "fields": [
                    {
                      "title": "ì›Œí¬í”Œë¡œìš°",
                      "value": "SafeWork Claude AI - Comments",
                      "short": true
                    },
                    {
                      "title": "ì´ë²¤íŠ¸",
                      "value": "${{ github.event_name }}",
                      "short": true
                    },
                    {
                      "title": "ìƒíƒœ",
                      "value": "${{ steps.claude.conclusion }}",
                      "short": true
                    },
                    {
                      "title": "ì‹¤í–‰ì",
                      "value": "${{ github.actor }}",
                      "short": true
                    },
                    ${{ github.event_name == 'issue_comment' && format('{"title": "ì´ìŠˆ", "value": "<{0}|#{1}>", "short": false},', github.event.issue.html_url, github.event.issue.number) || '' }}
                    ${{ github.event_name == 'pull_request_review_comment' && format('{"title": "PR", "value": "<{0}|#{1}>", "short": false},', github.event.pull_request.html_url, github.event.pull_request.number) || '' }}
                    {
                      "title": "Repository",
                      "value": "<${{ github.event.repository.html_url }}|${{ github.repository }}>",
                      "short": false
                    }
                  ],
                  "footer": "SafeWork Claude AI System",
                  "ts": ${{ github.event.repository.updated_at && github.event.repository.updated_at || 'null' }}
                }
              ]
            }
        env:
          SLACK_WEBHOOK_URL: https://hooks.slack.com/services/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