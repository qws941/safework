name: ğŸ” Claude PR Code Review

on:
  pull_request:
    types: [opened, synchronize, ready_for_review, reopened]
    paths:
      - 'app/**'
      - 'scripts/**'
      - 'migrations/**'
      - 'docker-compose.yml'
      - 'requirements.txt'
      - '.github/workflows/**'

jobs:
  claude-review:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      id-token: write
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: ğŸ¤– Claude Code Review
        uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          track_progress: true
          prompt: |
            REPO: ${{ github.repository }}
            PR NUMBER: ${{ github.event.pull_request.number }}

            ğŸ” **SafeWork ì‹œìŠ¤í…œ ì „ë¬¸ ì½”ë“œ ë¦¬ë·°**
            
            SafeWorkëŠ” Flask 3.0 ê¸°ë°˜ì˜ ì‚°ì—…ì•ˆì „ë³´ê±´ ê´€ë¦¬ ì‹œìŠ¤í…œì…ë‹ˆë‹¤.
            ë‹¤ìŒ ê´€ì ì—ì„œ ì „ë¬¸ì ì¸ ì½”ë“œ ë¦¬ë·°ë¥¼ ìˆ˜í–‰í•´ì£¼ì„¸ìš”:

            **1. SafeWork ë„ë©”ì¸ íŠ¹í™” ê²€í† **
            - ì‚°ì—…ì•ˆì „ë³´ê±´ ê´€ë ¨ ê·œì • ì¤€ìˆ˜
            - ì„¤ë¬¸ì¡°ì‚¬(001/002) ë°ì´í„° ì²˜ë¦¬ ì •í™•ì„±
            - ê·¼ê³¨ê²©ê³„ ì¦ìƒ ë°ì´í„° ë¬´ê²°ì„±
            - ì˜ë£Œì •ë³´ ë³´í˜¸ ë° ê°œì¸ì •ë³´ ì²˜ë¦¬ë°©ì¹¨ ì¤€ìˆ˜

            **2. ë³´ì•ˆ ë° ë°ì´í„° ë³´í˜¸**
            - Flask-Login ì¸ì¦ ë¡œì§ ê²€ì¦
            - SQL ì¸ì ì…˜ ë°©ì§€ (SQLAlchemy ì‚¬ìš© íŒ¨í„´)
            - CSRF ë³´í˜¸ êµ¬í˜„
            - ë¯¼ê° ë°ì´í„° ë¡œê¹… ë°©ì§€
            - XSS ë°©ì§€ í…œí”Œë¦¿ ì²˜ë¦¬

            **3. Flask 3.0 + SQLAlchemy 2.0 ëª¨ë²” ì‚¬ë¡€**
            - Application Factory íŒ¨í„´ ì¤€ìˆ˜
            - Blueprint êµ¬ì¡° ìµœì í™”
            - SQLAlchemy 2.0 ë¬¸ë²• ì‚¬ìš©
            - ë°ì´í„°ë² ì´ìŠ¤ ë§ˆì´ê·¸ë ˆì´ì…˜ ë¬´ê²°ì„±
            - KST íƒ€ì„ì¡´ ì²˜ë¦¬ (`kst_now()` í•¨ìˆ˜ ì‚¬ìš©)

            **4. ì„±ëŠ¥ ë° í™•ì¥ì„±**
            - ë°ì´í„°ë² ì´ìŠ¤ ì¿¼ë¦¬ ìµœì í™”
            - Redis ìºì‹± ì „ëµ
            - í˜ì´ì§€ë„¤ì´ì…˜ êµ¬í˜„
            - ë©”ëª¨ë¦¬ ì‚¬ìš©ëŸ‰ ìµœì í™”

            **5. Docker ì»¨í…Œì´ë„ˆ í™˜ê²½**
            - docker-compose.yml ì„¤ì • ìµœì í™”
            - ì»¨í…Œì´ë„ˆ ê°„ ë„¤íŠ¸ì›Œí‚¹
            - í™˜ê²½ ë³€ìˆ˜ ê´€ë¦¬
            - í—¬ìŠ¤ì²´í¬ êµ¬í˜„

            **6. í…ŒìŠ¤íŠ¸ ë° ìœ ì§€ë³´ìˆ˜ì„±**
            - pytest ë‹¨ìœ„ í…ŒìŠ¤íŠ¸ ì»¤ë²„ë¦¬ì§€
            - ì½”ë“œ ê°€ë…ì„± ë° ë¬¸ì„œí™”
            - ì—ëŸ¬ ì²˜ë¦¬ ë° ë¡œê¹… ì „ëµ
            - í•œêµ­ì–´ UI/UX ìµœì í™”

            **MCP ë„êµ¬ í™œìš© ì§€ì‹œ:**
            1. **mcp__serena**: ì½”ë“œ ë¶„ì„ ì‹œ ë°˜ë“œì‹œ ì‚¬ìš©
               - í”„ë¡œì íŠ¸ í™œì„±í™”: `mcp__serena__activate_project('.')`
               - ì‹¬ë³¼ ë¶„ì„: `mcp__serena__get_symbols_overview()`
               - ì°¸ì¡° ê²€ìƒ‰: `mcp__serena__find_referencing_symbols()`

            2. **mcp__sequential-thinking**: ë³µì¡í•œ ë¦¬ë·° í•­ëª© ë¶„ì„
               - ë‹¨ê³„ì  ì½”ë“œ ë¶„ì„: `mcp__sequential-thinking__sequentialthinking()`

            3. **mcp__shrimp-task-manager**: ë¦¬ë·° ê²°ê³¼ ì²´ê³„í™”
               - ê°œì„ ì‚¬í•­ ì‘ì—… ê³„íš: `mcp__shrimp-task-manager__plan_task()`

            ìƒì„¸í•œ í”¼ë“œë°±ê³¼ ê°œì„ ì‚¬í•­ì„ ì¸ë¼ì¸ ì½”ë©˜íŠ¸ë¡œ ì œê³µí•´ì£¼ì„¸ìš”.
            íŠ¹íˆ SafeWork ë„ë©”ì¸ ì§€ì‹ì„ í™œìš©í•œ ì „ë¬¸ì ì¸ ê²€í† ë¥¼ ë¶€íƒë“œë¦½ë‹ˆë‹¤.

          claude_args: |
            --allowedTools "mcp__serena__*,mcp__sequential-thinking__*,mcp__shrimp-task-manager__*,mcp__github_inline_comment__create_inline_comment,Bash(gh pr comment:*),Bash(gh pr diff:*),Bash(gh pr view:*)"