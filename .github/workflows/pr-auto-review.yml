name: ðŸ” PR Auto Review

on:
  pull_request:
    types: [opened, synchronize, ready_for_review]
    paths:
      - '**/*.py'
      - '**/*.yml'
      - '**/*.yaml'
      - '**/*.json'
      - '**/*.md'
      - '**/requirements.txt'
      - '**/Dockerfile'

permissions:
  contents: read
  pull-requests: write
  checks: write

env:
  CLAUDE_CODE_OAUTH_TOKEN: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

jobs:
  automated-review:
    if: github.event.pull_request.draft == false
    runs-on: ubuntu-latest
    timeout-minutes: 20
    
    steps:
      - name: ðŸ”— Checkout Repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0
          
      - name: ðŸ“Š Analyze Changed Files
        id: changes
        run: |
          echo "=== PR ë³€ê²½ì‚¬í•­ ë¶„ì„ ===" > pr_analysis.txt
          echo "PR ë²ˆí˜¸: ${{ github.event.pull_request.number }}" >> pr_analysis.txt
          echo "ì œëª©: ${{ github.event.pull_request.title }}" >> pr_analysis.txt
          echo "ìž‘ì„±ìž: ${{ github.event.pull_request.user.login }}" >> pr_analysis.txt
          echo "ë¸Œëžœì¹˜: ${{ github.event.pull_request.head.ref }} â†’ ${{ github.event.pull_request.base.ref }}" >> pr_analysis.txt
          echo "" >> pr_analysis.txt
          
          # Get changed files
          echo "=== ë³€ê²½ëœ íŒŒì¼ ëª©ë¡ ===" >> pr_analysis.txt
          git diff --name-only ${{ github.event.pull_request.base.sha }} ${{ github.event.pull_request.head.sha }} >> pr_analysis.txt
          echo "" >> pr_analysis.txt
          
          # Get detailed changes
          echo "=== ìƒì„¸ ë³€ê²½ ë‚´ìš© ===" >> pr_analysis.txt
          git diff ${{ github.event.pull_request.base.sha }} ${{ github.event.pull_request.head.sha }} >> pr_analysis.txt
          
          # Count changes by file type
          PYTHON_FILES=$(git diff --name-only ${{ github.event.pull_request.base.sha }} ${{ github.event.pull_request.head.sha }} | grep '\.py$' | wc -l)
          DOCKER_FILES=$(git diff --name-only ${{ github.event.pull_request.base.sha }} ${{ github.event.pull_request.head.sha }} | grep -E '(Dockerfile|\.yml$|\.yaml$)' | wc -l)
          CONFIG_FILES=$(git diff --name-only ${{ github.event.pull_request.base.sha }} ${{ github.event.pull_request.head.sha }} | grep -E '(requirements\.txt|\.json$|\.md$)' | wc -l)
          
          echo "python_files=$PYTHON_FILES" >> $GITHUB_OUTPUT
          echo "docker_files=$DOCKER_FILES" >> $GITHUB_OUTPUT
          echo "config_files=$CONFIG_FILES" >> $GITHUB_OUTPUT
          
      - name: ðŸ§  Expert Code Review
        run: |
          curl -fsSL https://claude.ai/install.sh | bash
          echo "$CLAUDE_CODE_OAUTH_TOKEN" | claude auth
          
          claude code --dir . << 'EOF'
          ðŸ” **SafeWork Flask ì• í”Œë¦¬ì¼€ì´ì…˜ PR ì „ë¬¸ ì½”ë“œ ë¦¬ë·° ìš”ì²­**
          
          **í”„ë¡œì íŠ¸ ì»¨í…ìŠ¤íŠ¸:**
          - SafeWork Flask 3.0+ ì• í”Œë¦¬ì¼€ì´ì…˜ (ì‚°ì—… ì•ˆì „ ê´€ë¦¬ ì‹œìŠ¤í…œ)
          - ë…ë¦½ ì»¨í…Œì´ë„ˆ ì•„í‚¤í…ì²˜: safework2-postgres (4546), safework2-redis (4547), safework2-app (4545)
          - í•µì‹¬ ê¸°ëŠ¥: ê±´ê°• ì„¤ë¬¸ì¡°ì‚¬ (001/002), SafeWork ê´€ë¦¬, ë¬¸ì„œ ê´€ë¦¬, RESTful API v2
          - ê¸°ìˆ  ìŠ¤íƒ: Flask 3.0+, SQLAlchemy 2.0, PostgreSQL, Redis, Bootstrap 4.6
          
          **PR ì •ë³´:**
          - PR ë²ˆí˜¸: ${{ github.event.pull_request.number }}
          - ì œëª©: "${{ github.event.pull_request.title }}"
          - ìž‘ì„±ìž: ${{ github.event.pull_request.user.login }}
          - ë³€ê²½ íŒŒì¼: Python ${{ steps.changes.outputs.python_files }}ê°œ, Docker/YAML ${{ steps.changes.outputs.docker_files }}ê°œ, ì„¤ì • ${{ steps.changes.outputs.config_files }}ê°œ
          
          **ì½”ë“œ ë¦¬ë·° ì§€ì¹¨:**
          
          ðŸ“‹ **1. `pr_analysis.txt` íŒŒì¼ì„ ì½ê³  ë³€ê²½ì‚¬í•­ ë¶„ì„**
          
          ðŸ”’ **2. ë³´ì•ˆ ê²€í†  (ìµœìš°ì„ )**:
          - SQL ì¸ì ì…˜, XSS ì·¨ì•½ì  ê²€ì‚¬
          - í•˜ë“œì½”ë”©ëœ ì‹œí¬ë¦¿ì´ë‚˜ ë¹„ë°€ë²ˆí˜¸ í™•ì¸
          - ìž…ë ¥ ê²€ì¦ ë° sanitization ì ê²€
          - ì¸ì¦/ê¶Œí•œ ë¶€ì—¬ ë¡œì§ ê²€í† 
          - CSRF ë³´í˜¸ (í˜„ìž¬ ë¹„í™œì„±í™” ìƒíƒœ) ê³ ë ¤
          
          âš¡ **3. ì„±ëŠ¥ ìµœì í™”**:
          - ë°ì´í„°ë² ì´ìŠ¤ ì¿¼ë¦¬ íš¨ìœ¨ì„± (N+1 ë¬¸ì œ ë“±)
          - Redis ìºì‹± í™œìš©ë„
          - ë©”ëª¨ë¦¬ ì‚¬ìš©ëŸ‰ ë° ë¦¬ì†ŒìŠ¤ ëˆ„ìˆ˜
          - ë¬´ê±°ìš´ ì—°ì‚°ì˜ ë¹„ë™ê¸° ì²˜ë¦¬ ê°€ëŠ¥ì„±
          
          ðŸ—ï¸ **4. Flask ì•„í‚¤í…ì²˜ í’ˆì§ˆ**:
          - ë¸”ë£¨í”„ë¦°íŠ¸ êµ¬ì¡° ë° ëª¨ë“ˆí™”
          - ëª¨ë¸ ì •ì˜ ë° ê´€ê³„ ì„¤ì • (models.py, models_safework.py)
          - ë¼ìš°íŠ¸ êµ¬ì„± ë° RESTful ì„¤ê³„
          - í…œí”Œë¦¿ ìƒì† ë° ìž¬ì‚¬ìš©ì„±
          - ì—ëŸ¬ í•¸ë“¤ë§ ë° ë¡œê¹…
          
          ðŸ§ª **5. í…ŒìŠ¤íŠ¸ ë° ì½”ë“œ í‘œì¤€**:
          - ë‹¨ìœ„ í…ŒìŠ¤íŠ¸ ì»¤ë²„ë¦¬ì§€
          - í†µí•© í…ŒìŠ¤íŠ¸ í•„ìš”ì„±
          - PEP 8 ì¤€ìˆ˜ (Black, Flake8)
          - íƒ€ìž… ížŒíŒ… ì‚¬ìš©
          - ë¬¸ì„œí™” í’ˆì§ˆ
          
          ðŸ³ **6. ì»¨í…Œì´ë„ˆ ë° ë°°í¬**:
          - Dockerfile ìµœì í™”
          - ì˜ì¡´ì„± ê´€ë¦¬ (requirements.txt)
          - í™˜ê²½ ë³€ìˆ˜ ì„¤ì •
          - GitHub Actions ì›Œí¬í”Œë¡œìš°
          - ë…ë¦½ ì»¨í…Œì´ë„ˆ í˜¸í™˜ì„±
          
          ðŸ“Š **7. SafeWork íŠ¹í™” ê²€í† **:
          - ì„¤ë¬¸ ì¡°ì‚¬ ë¡œì§ (001/002 ì–‘ì‹)
          - SafeWork ê´€ë¦¬ íŒ¨ë„ ê¸°ëŠ¥
          - ë¬¸ì„œ ë²„ì „ ê´€ë¦¬ ì‹œìŠ¤í…œ
          - API v2 ì—”ë“œí¬ì¸íŠ¸ ì„¤ê³„
          - í•œêµ­ì–´ ì§€ì› ë° KST íƒ€ìž„ì¡´
          
          **ë¦¬ë·° ì¶œë ¥ í˜•ì‹:**
          
          ## ðŸ” SafeWork PR ì½”ë“œ ë¦¬ë·° ë³´ê³ ì„œ
          
          ### ðŸ“Š ë³€ê²½ì‚¬í•­ ìš”ì•½
          - [ë³€ê²½ëœ íŒŒì¼ ìˆ˜ì™€ ìœ í˜•]
          - [ì£¼ìš” ê¸°ëŠ¥ ë³€ê²½ì‚¬í•­]
          - [ì˜í–¥ ë²”ìœ„ í‰ê°€]
          
          ### âœ… ê¸ì •ì  ìš”ì†Œ
          - [ìž˜ ìž‘ì„±ëœ ì½”ë“œë‚˜ ê°œì„ ì‚¬í•­]
          - [ëª¨ë²” ì‚¬ë¡€ ì ìš©]
          - [ì„±ëŠ¥ í–¥ìƒ ìš”ì†Œ]
          
          ### âš ï¸ ê°œì„  í•„ìš” ì‚¬í•­
          - [ë³´ì•ˆ ì´ìŠˆë‚˜ ì·¨ì•½ì ]
          - [ì„±ëŠ¥ ê°œì„  ê°€ëŠ¥ ë¶€ë¶„]
          - [ì½”ë“œ í’ˆì§ˆ ë¬¸ì œ]
          
          ### ðŸš¨ ì¤‘ìš” ì´ìŠˆ (ìžˆëŠ” ê²½ìš°)
          - [ì¦‰ì‹œ ìˆ˜ì •ì´ í•„ìš”í•œ ì‹¬ê°í•œ ë¬¸ì œ]
          - [ë³´ì•ˆ ìœ„í—˜ì´ë‚˜ ì„œë¹„ìŠ¤ ìž¥ì•  ê°€ëŠ¥ì„±]
          
          ### ðŸ’¡ ê¶Œìž¥ì‚¬í•­
          - [êµ¬ì²´ì ì¸ ê°œì„  ë°©ë²•]
          - [ëŒ€ì•ˆ êµ¬í˜„ ë°©ì‹]
          - [ì¶”ê°€ í…ŒìŠ¤íŠ¸ í•„ìš”ì„±]
          
          ### ðŸŽ¯ ìµœì¢… íŒì •
          - **ìŠ¹ì¸ ê¶Œìž¥** / **ì¡°ê±´ë¶€ ìŠ¹ì¸** / **ìˆ˜ì • í•„ìš”**
          - [íŒì • ì´ìœ ì™€ ê·¼ê±°]
          
          **ë¦¬ë·° ì›ì¹™:**
          - ê±´ì„¤ì ì´ê³  êµ¬ì²´ì ì¸ í”¼ë“œë°±
          - ì½”ë“œ ì˜ˆì œë‚˜ ìˆ˜ì • ë°©ë²• ì œì‹œ
          - SafeWork í”„ë¡œì íŠ¸ ì»¨í…ìŠ¤íŠ¸ ê³ ë ¤
          - í•œêµ­ì–´ë¡œ ì¹œê·¼í•˜ë©´ì„œ ì „ë¬¸ì ì¸ í†¤
          - í•™ìŠµê³¼ ê°œì„ ì— ë„ì›€ì´ ë˜ëŠ” ì„¤ëª…
          
          ì§€ê¸ˆ PRì„ ìƒì„¸ížˆ ë¶„ì„í•˜ê³  ì „ë¬¸ì ì¸ ë¦¬ë·°ë¥¼ ìž‘ì„±í•´ì£¼ì„¸ìš”.
          EOF
          
      - name: ðŸ“‹ Review Summary
        if: always()
        run: |
          echo "=== PR ìžë™ ë¦¬ë·° ì™„ë£Œ ==="
          echo "PR ë²ˆí˜¸: ${{ github.event.pull_request.number }}"
          echo "ì œëª©: ${{ github.event.pull_request.title }}"
          echo "ë³€ê²½ íŒŒì¼: Python ${{ steps.changes.outputs.python_files }}ê°œ, Docker/YAML ${{ steps.changes.outputs.docker_files }}ê°œ, ì„¤ì • ${{ steps.changes.outputs.config_files }}ê°œ"
          echo "ë¦¬ë·° ìƒíƒœ: ${{ job.status }}"
          echo "ì™„ë£Œ ì‹œê°„: $(date)"
          
          # If review found critical issues, create a comment
          if [ "${{ job.status }}" != "success" ]; then
            gh pr comment ${{ github.event.pull_request.number }} \
              --body "ðŸš¨ **ìžë™ ì½”ë“œ ë¦¬ë·° ì‹¤íŒ¨**

              PR ìžë™ ë¦¬ë·° ì¤‘ ë¬¸ì œê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.
              ìˆ˜ë™ ë¦¬ë·°ê°€ í•„ìš”í•©ë‹ˆë‹¤.
              
              **ë¦¬ë·° ì‹œê°„**: $(date)
              **ìƒíƒœ**: ${{ job.status }}
              
              ê´€ë¦¬ìžì—ê²Œ ë¬¸ì˜í•˜ê±°ë‚˜ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”."
          fi