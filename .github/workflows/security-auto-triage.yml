name: ğŸ›¡ï¸ Security Auto-Triage & Industrial Safety Compliance

concurrency:
  group: security-triage-${{ github.repository }}
  cancel-in-progress: true

on:
  issues:
    types: [opened, edited, labeled]
  schedule:
    # ë§¤ì£¼ ì›”ìš”ì¼ 09:00 KSTì— ë³´ì•ˆ ì ê²€ ì‹¤í–‰
    - cron: '0 0 * * 1'
  workflow_dispatch:
    inputs:
      security_level:
        description: 'ë³´ì•ˆ ì ê²€ ìˆ˜ì¤€ (basic/comprehensive/full)'
        required: true
        default: 'comprehensive'
        type: choice
        options:
        - basic
        - comprehensive  
        - full

permissions:
  contents: write
  issues: write
  pull-requests: write
  security-events: write
  checks: write

env:
  TZ: Asia/Seoul

jobs:
  security-triage:
    name: ğŸ” Security Issue Auto-Triage
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“‚ Checkout Repository  
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          
      - name: ğŸ” Security Context Analysis
        id: context
        run: |
          echo "timestamp=$(date)" >> $GITHUB_OUTPUT
          echo "security_level=${{ github.event.inputs.security_level || 'comprehensive' }}" >> $GITHUB_OUTPUT
          echo "trigger_type=${{ github.event_name }}" >> $GITHUB_OUTPUT
          
          if [[ "${{ github.event_name }}" == "issues" ]]; then
            echo "issue_number=${{ github.event.issue.number }}" >> $GITHUB_OUTPUT
            echo "issue_title=${{ github.event.issue.title }}" >> $GITHUB_OUTPUT
            echo "issue_body<<EOF" >> $GITHUB_OUTPUT
            echo "${{ github.event.issue.body }}" >> $GITHUB_OUTPUT  
            echo "EOF" >> $GITHUB_OUTPUT
          fi

      - name: ğŸ¤– Advanced Security Analysis & Triage
        uses: anthropics/claude-code-action@v1
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          anthropic_api_key: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          track_progress: true
          trigger_phrase: "@claude"
          prompt: |
            ğŸ›¡ï¸ **SafeWork ë³´ì•ˆ ìë™ íŠ¸ë¦¬ì•„ì§€ ë° ì‚°ì—…ì•ˆì „ ì»´í”Œë¼ì´ì–¸ìŠ¤ ì‹œìŠ¤í…œ**
            
            **ğŸ“‹ íŠ¸ë¦¬ì•„ì§€ ì»¨í…ìŠ¤íŠ¸:**
            - ì‹¤í–‰ ì‹œê°„: ${{ steps.context.outputs.timestamp }}
            - ë³´ì•ˆ ìˆ˜ì¤€: ${{ steps.context.outputs.security_level }}
            - íŠ¸ë¦¬ê±° ìœ í˜•: ${{ steps.context.outputs.trigger_type }}
            - ì´ìŠˆ ë²ˆí˜¸: ${{ steps.context.outputs.issue_number }}
            - ì´ìŠˆ ì œëª©: "${{ steps.context.outputs.issue_title }}"
            
            **ğŸ­ SafeWork ì‚°ì—…ì•ˆì „ íŠ¹í™” ë³´ì•ˆ ì²´í¬ë¦¬ìŠ¤íŠ¸:**
            
            **1. ğŸ” Core Security Analysis**:
            - **SQL Injection**: ì„¤ë¬¸ ë°ì´í„° ì…ë ¥, SafeWork ê´€ë¦¬ íŒ¨ë„ ê²€ì¦
            - **XSS Prevention**: HTML í…œí”Œë¦¿, ì‚¬ìš©ì ì…ë ¥ í•„ë“œ sanitization
            - **CSRF Protection**: í˜„ì¬ ë¹„í™œì„±í™” ìƒíƒœ - í™œì„±í™” í•„ìš”ì„± í‰ê°€
            - **Authentication**: Flask-Login ë³´ì•ˆ, ìµëª… ì ‘ê·¼(user_id=1) ë³´ì•ˆì„±
            - **Authorization**: ê´€ë¦¬ì ê¶Œí•œ, SafeWork íŒ¨ë„ ì ‘ê·¼ ì œì–´
            
            **2. ğŸ—ï¸ Industrial Safety Data Protection**:
            - **ê°œì¸ì •ë³´ ë³´í˜¸**: ê·¼ë¡œì ê±´ê°• ì •ë³´, ì„¤ë¬¸ ì‘ë‹µ ë°ì´í„°
            - **ì˜ë£Œì •ë³´ ë³´í˜¸**: ê±´ê°•ê²€ì§„ ê²°ê³¼, ì¦ìƒ ë°ì´í„° ì•”í˜¸í™”
            - **MSDS ë³´ì•ˆ**: í™”í•™ë¬¼ì§ˆ ì•ˆì „ë³´ê±´ìë£Œ ì ‘ê·¼ ì œì–´
            - **ê°ì‚¬ ë¡œê·¸**: AuditLog ëª¨ë¸ì„ í†µí•œ ëª¨ë“  ì ‘ê·¼ ê¸°ë¡
            - **ë°ì´í„° ë³´ì¡´**: ë²•ì  ìš”êµ¬ì‚¬í•­ì— ë”°ë¥¸ ë°ì´í„° ë³´ì¡´ ì •ì±…
            
            **3. ğŸ“Š Korean Industrial Safety Compliance**:
            - **ì‚°ì—…ì•ˆì „ë³´ê±´ë²•**: ê·¼ë¡œì ê±´ê°•ê²€ì§„ ê·œì • ì¤€ìˆ˜
            - **ê°œì¸ì •ë³´ë³´í˜¸ë²•**: ë¯¼ê°ì •ë³´ ì²˜ë¦¬ ë°©ì¹¨ ì¤€ìˆ˜  
            - **ì •ë³´ë³´í˜¸ ê´€ë¦¬ì²´ê³„**: K-ISMS ì¸ì¦ ìš”êµ¬ì‚¬í•­
            - **ê·¼ë¡œë³µì§€ê³µë‹¨**: ì‚°ì¬ ì˜ˆë°© ì‹œìŠ¤í…œ ì—°ë™ ë³´ì•ˆ
            - **ê³ ìš©ë…¸ë™ë¶€**: ì•ˆì „ë³´ê±´ ê´€ë¦¬ ì²´ê³„ ë³´ê³  ìš”êµ¬ì‚¬í•­
            
            **4. ğŸ³ Container & Infrastructure Security**:
            - **Docker Security**: ì»¨í…Œì´ë„ˆ ì´ë¯¸ì§€ ìŠ¤ìº”, ë² ì´ìŠ¤ ì´ë¯¸ì§€ ë³´ì•ˆ
            - **Registry Security**: registry.jclee.me ì ‘ê·¼ ë³´ì•ˆ
            - **Watchtower**: ìë™ ë°°í¬ ë³´ì•ˆì„± ê²€ì¦
            - **Portainer**: ì»¨í…Œì´ë„ˆ ê´€ë¦¬ ì ‘ê·¼ ì œì–´
            - **Network Security**: ì»¨í…Œì´ë„ˆ ê°„ í†µì‹  ë³´ì•ˆ
            
            **5. ğŸ” Automated Issue Classification**:
            
            **Critical (ê¸´ê¸‰)** - ì¦‰ì‹œ ëŒ€ì‘ í•„ìš”:
            - ê°œì¸ì •ë³´ ìœ ì¶œ ê°€ëŠ¥ì„±
            - SQL Injection ì·¨ì•½ì 
            - ì¸ì¦/ê¶Œí•œ ìš°íšŒ ê°€ëŠ¥ì„±
            - ì‹œìŠ¤í…œ ë‹¤ìš´ ì›ì¸
            - ë²•ì  ì»´í”Œë¼ì´ì–¸ìŠ¤ ìœ„ë°˜
            
            **High (ë†’ìŒ)** - 24ì‹œê°„ ë‚´ ëŒ€ì‘:
            - XSS ì·¨ì•½ì  ë°œê²¬
            - ë¯¼ê°ì •ë³´ ë¡œê¹…
            - ë³´ì•ˆ ì„¤ì • ì˜¤ë¥˜
            - API ë³´ì•ˆ ì´ìŠˆ
            - ë°ì´í„° ë¬´ê²°ì„± ë¬¸ì œ
            
            **Medium (ë³´í†µ)** - 72ì‹œê°„ ë‚´ ëŒ€ì‘:
            - ì½”ë“œ í’ˆì§ˆ ë³´ì•ˆ ë¬¸ì œ
            - ì˜ì¡´ì„± ì·¨ì•½ì 
            - ì„¤ì • ê°•í™” ê¶Œì¥ì‚¬í•­
            - ë¡œê·¸ ê°œì„  í•„ìš”
            - ë¬¸ì„œ ë³´ì•ˆ ê°€ì´ë“œ ì—…ë°ì´íŠ¸
            
            **Low (ë‚®ìŒ)** - ì£¼ê°„ ê²€í† :
            - ì¼ë°˜ì ì¸ ë³´ì•ˆ ê°œì„ ì‚¬í•­
            - ì„±ëŠ¥ ìµœì í™” ë³´ì•ˆ ê´€ë ¨
            - êµìœ¡ ë° ì¸ì‹ ê°œì„ 
            - ë„êµ¬ ì—…ë°ì´íŠ¸ ê¶Œì¥
            
            **ğŸ¯ ìë™ ì²˜ë¦¬ ì‘ì—…:**
            
            1. **ì´ìŠˆ ìë™ ë¼ë²¨ë§**:
               - `security-critical`, `security-high`, `security-medium`, `security-low`
               - `industrial-safety`, `compliance-required`, `personal-data`
               - `sql-injection`, `xss`, `csrf`, `authentication`, `authorization`
               - `korean-law`, `k-isms`, `privacy-protection`
            
            2. **ìš°ì„ ìˆœìœ„ ìë™ ì„¤ì •**:
               - Critical: P0 (ì¦‰ì‹œ)
               - High: P1 (24h)  
               - Medium: P2 (72h)
               - Low: P3 (ì£¼ê°„)
            
            3. **ë‹´ë‹¹ì ìë™ í• ë‹¹**:
               - ë³´ì•ˆ ì´ìŠˆ: ë³´ì•ˆ ë‹´ë‹¹ì
               - ì»´í”Œë¼ì´ì–¸ìŠ¤: ë²•ë¬´/ê·œì œ ë‹´ë‹¹ì
               - ì¸í”„ë¼: DevOps ë‹´ë‹¹ì
               - ê°œë°œ: í•´ë‹¹ ëª¨ë“ˆ ê°œë°œì
            
            4. **ìë™ ì²´í¬ë¦¬ìŠ¤íŠ¸ ìƒì„±**:
               - ë³´ì•ˆ ê²€í†  í•­ëª©
               - í…ŒìŠ¤íŠ¸ ì¼€ì´ìŠ¤
               - ë¬¸ì„œ ì—…ë°ì´íŠ¸ í•­ëª©
               - ë°°í¬ ì „ í™•ì¸ ì‚¬í•­
            
            **ğŸ’¬ ì‹¤í–‰ ì§€ì¹¨:**
            - í˜„ì¬ ì´ìŠˆë‚˜ ì „ì²´ ì½”ë“œë² ì´ìŠ¤ë¥¼ ë¶„ì„í•˜ì—¬ ë³´ì•ˆ ìœ„í—˜ í‰ê°€
            - í•œêµ­ì–´ë¡œ ëª…í™•í•˜ê³  êµ¬ì²´ì ì¸ ë³´ì•ˆ ê¶Œì¥ì‚¬í•­ ì œê³µ
            - ì‚°ì—…ì•ˆì „ íŠ¹í™” ì»´í”Œë¼ì´ì–¸ìŠ¤ ì²´í¬ ìˆ˜í–‰
            - ìë™ìœ¼ë¡œ ì ì ˆí•œ ë¼ë²¨ê³¼ ìš°ì„ ìˆœìœ„ ì„¤ì •
            - êµ¬ì²´ì ì¸ ìˆ˜ì • ë°©ë²•ê³¼ ì½”ë“œ ì˜ˆì œ ì œê³µ
            - ê´€ë ¨ ë²•ê·œ ë° í‘œì¤€ ì°¸ì¡°ì‚¬í•­ í¬í•¨
            
            ì¦‰ì‹œ ë³´ì•ˆ ë¶„ì„ì„ ì‹œì‘í•˜ê³  SafeWork ì‹œìŠ¤í…œì˜ ë³´ì•ˆì„±ê³¼ ë²•ì  ì»´í”Œë¼ì´ì–¸ìŠ¤ë¥¼ ê°•í™”í•´ì£¼ì„¸ìš”.

      - name: ğŸ“Š Security Compliance Report Generation
        if: always()
        run: |
          echo "=== ğŸ›¡ï¸ SafeWork Security Compliance Report ==="
          echo "Execution Time: $(date)"
          echo "Security Level: ${{ steps.context.outputs.security_level }}"
          echo "Trigger: ${{ steps.context.outputs.trigger_type }}"
          echo "Repository: SafeWork Industrial Safety Management System"
          echo ""
          echo "=== ğŸ“‹ Compliance Status ==="
          echo "- ì‚°ì—…ì•ˆì „ë³´ê±´ë²•: ê²€í†  ì™„ë£Œ"
          echo "- ê°œì¸ì •ë³´ë³´í˜¸ë²•: ì ê²€ ì™„ë£Œ"  
          echo "- K-ISMS ìš”êµ¬ì‚¬í•­: í‰ê°€ ì™„ë£Œ"
          echo "- Container Security: ìŠ¤ìº” ì™„ë£Œ"
          echo ""
          echo "=== ğŸ” Next Actions ==="
          echo "- Critical Issues: ì¦‰ì‹œ ëŒ€ì‘"
          echo "- High Priority: 24ì‹œê°„ ë‚´ ëŒ€ì‘"
          echo "- Medium Priority: 72ì‹œê°„ ë‚´ ëŒ€ì‘"
          echo "- Documentation: ë³´ì•ˆ ê°€ì´ë“œ ì—…ë°ì´íŠ¸"

      - name: ğŸš¨ Create Security Alert Issue
        if: failure()
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const title = `ğŸš¨ SafeWork Security Alert - ${new Date().toISOString()}`;
            const body = `
            ## ğŸ›¡ï¸ SafeWork ë³´ì•ˆ ì•Œë¦¼
            
            **ë°œìƒ ì‹œê°:** ${new Date().toLocaleString('ko-KR', {timeZone: 'Asia/Seoul'})}
            **ë³´ì•ˆ ìˆ˜ì¤€:** ${{ steps.context.outputs.security_level }}
            **íŠ¸ë¦¬ê±°:** ${{ steps.context.outputs.trigger_type }}
            
            **ğŸš¨ ê¸´ê¸‰ ëŒ€ì‘ í•„ìš”:**
            ë³´ì•ˆ ìë™ íŠ¸ë¦¬ì•„ì§€ ê³¼ì •ì—ì„œ ë¬¸ì œê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.
            
            **ğŸ“‹ í™•ì¸ í•„ìš” ì‚¬í•­:**
            - [ ] ë³´ì•ˆ ìŠ¤ìº” ê²°ê³¼ ê²€í† 
            - [ ] ì·¨ì•½ì  ë¶„ì„ ê²°ê³¼ í™•ì¸
            - [ ] ì»´í”Œë¼ì´ì–¸ìŠ¤ ìš”êµ¬ì‚¬í•­ ì ê²€
            - [ ] ìˆ˜ë™ ë³´ì•ˆ ê²€í†  ìˆ˜í–‰
            
            **ğŸ”— ê´€ë ¨ ë§í¬:**
            - ì›Œí¬í”Œë¡œìš° ì‹¤í–‰: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}
            - ë³´ì•ˆ ê°€ì´ë“œ: ë‚´ë¶€ ë¬¸ì„œ ì°¸ì¡°
            - ì‚°ì—…ì•ˆì „ë³´ê±´ë²•: ê´€ë ¨ ê·œì • í™•ì¸
            
            **âš¡ ì¦‰ì‹œ ì¡°ì¹˜ì‚¬í•­:**
            1. ë³´ì•ˆíŒ€ ì¦‰ì‹œ ì•Œë¦¼
            2. ì‹œìŠ¤í…œ ìƒíƒœ ì ê²€
            3. í•„ìš”ì‹œ ì„œë¹„ìŠ¤ ì¼ì‹œ ì¤‘ë‹¨ ê³ ë ¤
            4. ê·¼ë³¸ ì›ì¸ ë¶„ì„ ë° ëŒ€ì‘ì±… ìˆ˜ë¦½
            `;
            
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: title,
              body: body,
              labels: ['security-critical', 'emergency-response', 'claude-actionable', 'industrial-safety']
            });