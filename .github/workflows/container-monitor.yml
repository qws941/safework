name: ğŸ³ ì»¨í…Œì´ë„ˆ ëª¨ë‹ˆí„°ë§ ë° ìë™ ì´ìŠˆ ìƒì„±

on:
  push:
    branches: [main, master]
  schedule:
    # 10ë¶„ë§ˆë‹¤ ì‹¤í–‰ (ìš´ì˜ ì‹œê°„ ì¤‘)
    - cron: '*/10 6-22 * * *'  # KST 06:00-22:00
    # 30ë¶„ë§ˆë‹¤ ì‹¤í–‰ (ì•¼ê°„)
    - cron: '0,30 23,0-5 * * *'  # KST 23:00-05:00
  workflow_dispatch:
    inputs:
      check_type:
        description: 'ê²€ì‚¬ ìœ í˜•'
        required: false
        default: 'all'
        type: choice
        options:
        - all
        - health
        - logs
        - performance

permissions:
  contents: read
  issues: write
  actions: read

env:
  CONTAINER_NAME: safework-app
  ERROR_THRESHOLD: 5  # ì—ëŸ¬ ì„ê³„ê°’
  RESTART_THRESHOLD: 3  # ì¬ì‹œì‘ ì„ê³„ê°’

jobs:
  # ========================================
  # 1. ì»¨í…Œì´ë„ˆ ìƒíƒœ ëª¨ë‹ˆí„°ë§
  # ========================================
  container-health:
    name: "ğŸ¥ ì»¨í…Œì´ë„ˆ ìƒíƒœ ê²€ì‚¬"
    runs-on: self-hosted
    outputs:
      has_errors: ${{ steps.check.outputs.has_errors }}
      error_count: ${{ steps.check.outputs.error_count }}
      container_status: ${{ steps.check.outputs.container_status }}
      need_issue: ${{ steps.check.outputs.need_issue }}
      error_details: ${{ steps.check.outputs.error_details }}
    
    steps:
    - name: "ğŸ“¥ ì½”ë“œ ì²´í¬ì•„ì›ƒ"
      uses: actions/checkout@v4
      
    - name: "ğŸ” ì»¨í…Œì´ë„ˆ ìƒíƒœ í™•ì¸"
      id: check
      run: |
        echo "ğŸ” SafeWork ì»¨í…Œì´ë„ˆ ìƒíƒœ í™•ì¸ ì¤‘..."
        
        HAS_ERRORS=false
        ERROR_COUNT=0
        NEED_ISSUE=false
        CONTAINER_STATUS="unknown"
        ERROR_DETAILS=""
        
        # ì»¨í…Œì´ë„ˆ ìƒíƒœ í™•ì¸
        if docker ps --format "table {{.Names}}\t{{.Status}}\t{{.RunningFor}}" | grep -q "${{ env.CONTAINER_NAME }}"; then
          CONTAINER_INFO=$(docker ps --format "{{.Status}}|{{.RunningFor}}" --filter "name=${{ env.CONTAINER_NAME }}")
          CONTAINER_STATUS="running"
          echo "âœ… ì»¨í…Œì´ë„ˆ ì‹¤í–‰ ì¤‘: $CONTAINER_INFO"
          
          # ì¬ì‹œì‘ íšŸìˆ˜ í™•ì¸
          RESTART_COUNT=$(docker inspect ${{ env.CONTAINER_NAME }} --format='{{.RestartCount}}' 2>/dev/null || echo "0")
          if [ "$RESTART_COUNT" -gt "${{ env.RESTART_THRESHOLD }}" ]; then
            echo "âš ï¸ ì»¨í…Œì´ë„ˆê°€ $RESTART_COUNT ë²ˆ ì¬ì‹œì‘ë¨"
            HAS_ERRORS=true
            ERROR_DETAILS="${ERROR_DETAILS}Container restarted $RESTART_COUNT times. "
          fi
          
        else
          echo "âŒ ì»¨í…Œì´ë„ˆê°€ ì‹¤í–‰ë˜ì§€ ì•ŠìŒ"
          CONTAINER_STATUS="stopped"
          HAS_ERRORS=true
          NEED_ISSUE=true
          ERROR_DETAILS="${ERROR_DETAILS}Container is not running. "
        fi
        
        # ìµœê·¼ ë¡œê·¸ì—ì„œ ì—ëŸ¬ ê²€ì‚¬ (ì»¨í…Œì´ë„ˆê°€ ì‹¤í–‰ ì¤‘ì¸ ê²½ìš°)
        if [ "$CONTAINER_STATUS" = "running" ]; then
          echo "ğŸ“‹ ìµœê·¼ ë¡œê·¸ ê²€ì‚¬ ì¤‘..."
          
          # ìµœê·¼ 100ì¤„ ë¡œê·¸ì—ì„œ ì—ëŸ¬ íŒ¨í„´ ê²€ìƒ‰
          RECENT_LOGS=$(docker logs ${{ env.CONTAINER_NAME }} --tail 100 2>&1 || echo "")
          
          # ì—ëŸ¬ íŒ¨í„´ ê²€ì‚¬
          ERROR_PATTERNS=(
            "ERROR"
            "CRITICAL"
            "FATAL"
            "Exception"
            "Traceback"
            "500 Internal Server Error"
            "502 Bad Gateway"
            "Connection refused"
            "Database connection failed"
            "OperationalError"
            "MySQLdb._exceptions"
          )
          
          for pattern in "${ERROR_PATTERNS[@]}"; do
            PATTERN_COUNT=$(echo "$RECENT_LOGS" | grep -c "$pattern" || echo "0")
            if [ "$PATTERN_COUNT" -gt 0 ]; then
              ERROR_COUNT=$((ERROR_COUNT + PATTERN_COUNT))
              echo "âš ï¸ '$pattern' íŒ¨í„´ $PATTERN_COUNT ê°œ ë°œê²¬"
              ERROR_DETAILS="${ERROR_DETAILS}Found $PATTERN_COUNT occurrences of '$pattern'. "
            fi
          done
          
          # ì—ëŸ¬ ì„ê³„ê°’ ì´ˆê³¼ í™•ì¸
          if [ "$ERROR_COUNT" -gt "${{ env.ERROR_THRESHOLD }}" ]; then
            echo "âŒ ì—ëŸ¬ ìˆ˜ê°€ ì„ê³„ê°’ ì´ˆê³¼: $ERROR_COUNT > ${{ env.ERROR_THRESHOLD }}"
            HAS_ERRORS=true
            NEED_ISSUE=true
          elif [ "$ERROR_COUNT" -gt 0 ]; then
            echo "âš ï¸ ì—ëŸ¬ ë°œê²¬: $ERROR_COUNT ê°œ"
            HAS_ERRORS=true
          fi
        fi
        
        # í—¬ìŠ¤ì²´í¬
        echo "ğŸ’š í—¬ìŠ¤ì²´í¬ ìˆ˜í–‰ ì¤‘..."
        if curl -f -s -o /dev/null -w "%{http_code}" http://localhost:5000/health | grep -qE "200|204"; then
          echo "âœ… í—¬ìŠ¤ì²´í¬ ì„±ê³µ"
        else
          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:5000/health || echo "000")
          echo "âŒ í—¬ìŠ¤ì²´í¬ ì‹¤íŒ¨ (HTTP $HTTP_CODE)"
          HAS_ERRORS=true
          ERROR_DETAILS="${ERROR_DETAILS}Health check failed with HTTP $HTTP_CODE. "
          
          if [ "$HTTP_CODE" = "000" ] || [ "$HTTP_CODE" = "502" ]; then
            NEED_ISSUE=true
          fi
        fi
        
        # ë©”ëª¨ë¦¬ ì‚¬ìš©ëŸ‰ í™•ì¸
        if [ "$CONTAINER_STATUS" = "running" ]; then
          MEMORY_USAGE=$(docker stats ${{ env.CONTAINER_NAME }} --no-stream --format "{{.MemPerc}}" | sed 's/%//')
          MEMORY_USAGE_INT=${MEMORY_USAGE%.*}
          
          if [ "$MEMORY_USAGE_INT" -gt 80 ]; then
            echo "âš ï¸ ë†’ì€ ë©”ëª¨ë¦¬ ì‚¬ìš©ëŸ‰: ${MEMORY_USAGE}%"
            ERROR_DETAILS="${ERROR_DETAILS}High memory usage: ${MEMORY_USAGE}%. "
            HAS_ERRORS=true
          fi
        fi
        
        # ê²°ê³¼ ì¶œë ¥
        echo "has_errors=$HAS_ERRORS" >> $GITHUB_OUTPUT
        echo "error_count=$ERROR_COUNT" >> $GITHUB_OUTPUT
        echo "container_status=$CONTAINER_STATUS" >> $GITHUB_OUTPUT
        echo "need_issue=$NEED_ISSUE" >> $GITHUB_OUTPUT
        echo "error_details=$ERROR_DETAILS" >> $GITHUB_OUTPUT
        
        # ìƒíƒœ ìš”ì•½
        echo "## ğŸ³ ì»¨í…Œì´ë„ˆ ëª¨ë‹ˆí„°ë§ ê²°ê³¼" >> $GITHUB_STEP_SUMMARY
        echo "| í•­ëª© | ìƒíƒœ |" >> $GITHUB_STEP_SUMMARY
        echo "|------|------|" >> $GITHUB_STEP_SUMMARY
        echo "| ì»¨í…Œì´ë„ˆ ìƒíƒœ | $CONTAINER_STATUS |" >> $GITHUB_STEP_SUMMARY
        echo "| ì—ëŸ¬ ë°œê²¬ | $HAS_ERRORS |" >> $GITHUB_STEP_SUMMARY
        echo "| ì—ëŸ¬ ìˆ˜ | $ERROR_COUNT |" >> $GITHUB_STEP_SUMMARY
        echo "| ì´ìŠˆ ìƒì„± í•„ìš” | $NEED_ISSUE |" >> $GITHUB_STEP_SUMMARY
        if [ -n "$ERROR_DETAILS" ]; then
          echo "| ì—ëŸ¬ ìƒì„¸ | $ERROR_DETAILS |" >> $GITHUB_STEP_SUMMARY
        fi

    - name: "ğŸ“‹ ìƒì„¸ ë¡œê·¸ ìˆ˜ì§‘"
      if: steps.check.outputs.has_errors == 'true'
      run: |
        echo "ğŸ“‹ ìƒì„¸ ë¡œê·¸ ìˆ˜ì§‘ ì¤‘..."
        
        # ì—ëŸ¬ ë¡œê·¸ ìˆ˜ì§‘
        docker logs ${{ env.CONTAINER_NAME }} --tail 500 > container-full-logs.txt 2>&1 || echo "ë¡œê·¸ ìˆ˜ì§‘ ì‹¤íŒ¨"
        
        # ì—ëŸ¬ë§Œ í•„í„°ë§
        grep -E "ERROR|CRITICAL|FATAL|Exception|Traceback|500|502" container-full-logs.txt > container-error-logs.txt || echo "ì—ëŸ¬ ë¡œê·¸ ì—†ìŒ"
        
        # ì‹œìŠ¤í…œ ì •ë³´ ìˆ˜ì§‘
        echo "=== System Information ===" > system-info.txt
        echo "Date: $(date)" >> system-info.txt
        echo "Container Status:" >> system-info.txt
        docker ps -a | grep safework >> system-info.txt || echo "No safework containers" >> system-info.txt
        echo "" >> system-info.txt
        echo "Docker Stats:" >> system-info.txt
        docker stats --no-stream >> system-info.txt || echo "Stats not available" >> system-info.txt
        echo "" >> system-info.txt
        echo "Disk Usage:" >> system-info.txt
        df -h >> system-info.txt
        
    - name: "ğŸ“Š ë¡œê·¸ ì•„í‹°íŒ©íŠ¸ ì—…ë¡œë“œ"
      if: steps.check.outputs.has_errors == 'true'
      uses: actions/upload-artifact@v3
      with:
        name: container-logs-${{ github.run_number }}
        path: |
          container-full-logs.txt
          container-error-logs.txt
          system-info.txt
        retention-days: 7

  # ========================================
  # 2. ìë™ ì´ìŠˆ ìƒì„±
  # ========================================
  create-issue:
    name: "ğŸ“ ìë™ ì´ìŠˆ ìƒì„±"
    needs: container-health
    if: needs.container-health.outputs.need_issue == 'true'
    runs-on: ubuntu-latest
    
    steps:
    - name: "ğŸ” ê¸°ì¡´ ì´ìŠˆ í™•ì¸"
      id: check_issue
      uses: actions/github-script@v6
      with:
        script: |
          // ì˜¤ëŠ˜ ë‚ ì§œ ìƒì„±
          const today = new Date().toISOString().split('T')[0];
          
          // ê¸°ì¡´ ì˜¤í”ˆ ì´ìŠˆ í™•ì¸
          const issues = await github.rest.issues.listForRepo({
            owner: context.repo.owner,
            repo: context.repo.repo,
            state: 'open',
            labels: 'container-error,auto-generated',
            per_page: 10
          });
          
          // ì˜¤ëŠ˜ ìƒì„±ëœ ì´ìŠˆê°€ ìˆëŠ”ì§€ í™•ì¸
          const todayIssue = issues.data.find(issue => 
            issue.title.includes(today) && 
            issue.title.includes('Container Error')
          );
          
          if (todayIssue) {
            console.log(`ê¸°ì¡´ ì´ìŠˆ ë°œê²¬: #${todayIssue.number}`);
            core.setOutput('existing_issue', todayIssue.number);
            return todayIssue.number;
          }
          
          core.setOutput('existing_issue', '');
          return null;
          
    - name: "ğŸ“ ìƒˆ ì´ìŠˆ ìƒì„±"
      if: steps.check_issue.outputs.existing_issue == ''
      uses: actions/github-script@v6
      with:
        script: |
          const errorCount = '${{ needs.container-health.outputs.error_count }}';
          const containerStatus = '${{ needs.container-health.outputs.container_status }}';
          const errorDetails = '${{ needs.container-health.outputs.error_details }}';
          const runUrl = `${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`;
          
          // ì´ìŠˆ ì œëª©ê³¼ ë³¸ë¬¸ ìƒì„±
          const date = new Date().toISOString();
          const title = `ğŸ³ [Container Error] SafeWork ì»¨í…Œì´ë„ˆ ì˜¤ë¥˜ ê°ì§€ - ${date.split('T')[0]}`;
          
          const body = `## ğŸš¨ ì»¨í…Œì´ë„ˆ ì˜¤ë¥˜ ìë™ ê°ì§€
          
          SafeWork ì»¨í…Œì´ë„ˆì—ì„œ ì˜¤ë¥˜ê°€ ê°ì§€ë˜ì–´ ìë™ìœ¼ë¡œ ì´ìŠˆê°€ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.
          
          ### ğŸ“Š ì˜¤ë¥˜ ìš”ì•½
          - **ê°ì§€ ì‹œê°„:** ${date}
          - **ì»¨í…Œì´ë„ˆ ìƒíƒœ:** ${containerStatus}
          - **ì˜¤ë¥˜ ìˆ˜:** ${errorCount}ê°œ
          - **ì‹¤í–‰ ë²ˆí˜¸:** #${context.runNumber}
          
          ### ğŸ” ì˜¤ë¥˜ ìƒì„¸
          ${errorDetails || 'ìƒì„¸ ì •ë³´ëŠ” ë¡œê·¸ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.'}
          
          ### ğŸ“‹ í™•ì¸ í•„ìš” ì‚¬í•­
          - [ ] ì»¨í…Œì´ë„ˆ ë¡œê·¸ í™•ì¸
          - [ ] ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²° ìƒíƒœ í™•ì¸
          - [ ] ë©”ëª¨ë¦¬ ì‚¬ìš©ëŸ‰ í™•ì¸
          - [ ] ë””ìŠ¤í¬ ê³µê°„ í™•ì¸
          - [ ] ì• í”Œë¦¬ì¼€ì´ì…˜ ì—ëŸ¬ ë¡œê·¸ ë¶„ì„
          - [ ] í•„ìš”ì‹œ ì»¨í…Œì´ë„ˆ ì¬ì‹œì‘
          
          ### ğŸ”§ ê¶Œì¥ ì¡°ì¹˜
          1. [GitHub Actions ë¡œê·¸ í™•ì¸](${runUrl})
          2. ì„œë²„ ì ‘ì†í•˜ì—¬ ìƒíƒœ í™•ì¸
             \`\`\`bash
             docker logs safework-app --tail 100
             docker stats safework-app --no-stream
             docker inspect safework-app
             \`\`\`
          3. í•„ìš”ì‹œ ì¬ì‹œì‘
             \`\`\`bash
             docker-compose restart app
             \`\`\`
          
          ### ğŸ·ï¸ ê´€ë ¨ ì •ë³´
          - **Workflow:** ${context.workflow}
          - **Commit:** ${context.sha}
          - **Actor:** ${context.actor}
          - **[ìƒì„¸ ë¡œê·¸ ë‹¤ìš´ë¡œë“œ](${runUrl}#artifacts)**
          
          ---
          *ì´ ì´ìŠˆëŠ” GitHub Actions ì›Œí¬í”Œë¡œìš°ì— ì˜í•´ ìë™ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.*
          `;
          
          // ì´ìŠˆ ìƒì„±
          const issue = await github.rest.issues.create({
            owner: context.repo.owner,
            repo: context.repo.repo,
            title: title,
            body: body,
            labels: ['container-error', 'auto-generated', 'priority-high', 'bug'],
            assignees: ['qws941']
          });
          
          console.log(`ìƒˆ ì´ìŠˆ ìƒì„±ë¨: #${issue.data.number}`);
          core.setOutput('issue_number', issue.data.number);
          
    - name: "ğŸ’¬ ê¸°ì¡´ ì´ìŠˆì— ì½”ë©˜íŠ¸ ì¶”ê°€"
      if: steps.check_issue.outputs.existing_issue != ''
      uses: actions/github-script@v6
      with:
        script: |
          const issueNumber = ${{ steps.check_issue.outputs.existing_issue }};
          const errorCount = '${{ needs.container-health.outputs.error_count }}';
          const errorDetails = '${{ needs.container-health.outputs.error_details }}';
          const runUrl = `${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`;
          
          const comment = `## ğŸ”„ ì¶”ê°€ ì˜¤ë¥˜ ê°ì§€
          
          **ì‹œê°„:** ${new Date().toISOString()}
          **ì˜¤ë¥˜ ìˆ˜:** ${errorCount}ê°œ
          **ì‹¤í–‰:** [#${context.runNumber}](${runUrl})
          
          ### ì˜¤ë¥˜ ìƒì„¸
          ${errorDetails || 'ë¡œê·¸ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.'}
          
          [ìƒì„¸ ë¡œê·¸ ë³´ê¸°](${runUrl})
          `;
          
          await github.rest.issues.createComment({
            owner: context.repo.owner,
            repo: context.repo.repo,
            issue_number: issueNumber,
            body: comment
          });
          
          console.log(`ê¸°ì¡´ ì´ìŠˆ #${issueNumber}ì— ì½”ë©˜íŠ¸ ì¶”ê°€ë¨`);

  # ========================================
  # 3. ìë™ ë³µêµ¬ ì‹œë„ (ì„ íƒì )
  # ========================================
  auto-recovery:
    name: "ğŸ”§ ìë™ ë³µêµ¬ ì‹œë„"
    needs: [container-health, create-issue]
    if: needs.container-health.outputs.container_status == 'stopped' || needs.container-health.outputs.error_count > 10
    runs-on: self-hosted
    
    steps:
    - name: "ğŸ”§ ì»¨í…Œì´ë„ˆ ì¬ì‹œì‘ ì‹œë„"
      id: restart
      run: |
        echo "ğŸ”§ SafeWork ì»¨í…Œì´ë„ˆ ìë™ ë³µêµ¬ ì‹œë„..."
        
        # ì»¨í…Œì´ë„ˆ ìƒíƒœ í™•ì¸
        CONTAINER_STATUS="${{ needs.container-health.outputs.container_status }}"
        
        if [ "$CONTAINER_STATUS" = "stopped" ]; then
          echo "ğŸ”„ ì •ì§€ëœ ì»¨í…Œì´ë„ˆ ì¬ì‹œì‘ ì¤‘..."
          
          # Docker Composeë¡œ ì¬ì‹œì‘
          cd /home/jclee/app/safework2 || cd ~/safework
          docker-compose restart app || docker-compose up -d app
          
          # ì¬ì‹œì‘ í›„ ëŒ€ê¸°
          sleep 10
          
          # ìƒíƒœ í™•ì¸
          if docker ps | grep -q "${{ env.CONTAINER_NAME }}"; then
            echo "âœ… ì»¨í…Œì´ë„ˆ ì¬ì‹œì‘ ì„±ê³µ"
            RESTART_SUCCESS=true
          else
            echo "âŒ ì»¨í…Œì´ë„ˆ ì¬ì‹œì‘ ì‹¤íŒ¨"
            RESTART_SUCCESS=false
          fi
        else
          echo "â„¹ï¸ ì»¨í…Œì´ë„ˆëŠ” ì‹¤í–‰ ì¤‘ì´ì§€ë§Œ ì—ëŸ¬ê°€ ë§ìŒ"
          
          # ë¡œê·¸ ë¡œí…Œì´ì…˜
          docker logs ${{ env.CONTAINER_NAME }} > "/tmp/safework-logs-$(date +%Y%m%d-%H%M%S).log" 2>&1
          
          # ë¶€ë“œëŸ¬ìš´ ì¬ì‹œì‘
          echo "ğŸ”„ ë¶€ë“œëŸ¬ìš´ ì¬ì‹œì‘ ìˆ˜í–‰ ì¤‘..."
          docker-compose restart app
          
          sleep 10
          RESTART_SUCCESS=true
        fi
        
        echo "restart_success=$RESTART_SUCCESS" >> $GITHUB_OUTPUT
        
    - name: "ğŸ“ ë³µêµ¬ ê²°ê³¼ ê¸°ë¡"
      if: always()
      uses: actions/github-script@v6
      with:
        script: |
          const restartSuccess = '${{ steps.restart.outputs.restart_success }}' === 'true';
          const issueNumber = ${{ needs.create-issue.outputs.issue_number || 0 }};
          
          if (issueNumber > 0) {
            const comment = restartSuccess 
              ? `âœ… **ìë™ ë³µêµ¬ ì„±ê³µ**\n\nì»¨í…Œì´ë„ˆê°€ ì„±ê³µì ìœ¼ë¡œ ì¬ì‹œì‘ë˜ì—ˆìŠµë‹ˆë‹¤.\nì‹œê°„: ${new Date().toISOString()}`
              : `âŒ **ìë™ ë³µêµ¬ ì‹¤íŒ¨**\n\nìˆ˜ë™ ê°œì…ì´ í•„ìš”í•©ë‹ˆë‹¤.\nì‹œê°„: ${new Date().toISOString()}`;
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber,
              body: comment
            });
          }

  # ========================================
  # 4. ì•Œë¦¼ ì „ì†¡
  # ========================================
  notify:
    name: "ğŸ“¨ ì•Œë¦¼ ì „ì†¡"
    needs: [container-health, create-issue]
    if: needs.container-health.outputs.need_issue == 'true'
    runs-on: ubuntu-latest
    
    steps:
    - name: "ğŸ“¨ ì•Œë¦¼ ì „ì†¡"
      run: |
        echo "ğŸ“¨ ì•Œë¦¼ ì „ì†¡ ì¤‘..."
        
        # Slack ì›¹í›… (ì„¤ì •ëœ ê²½ìš°)
        if [ -n "${{ secrets.SLACK_WEBHOOK_URL }}" ]; then
          curl -X POST -H 'Content-type: application/json' \
            --data "{
              \"text\": \"ğŸš¨ SafeWork Container Alert\",
              \"attachments\": [{
                \"color\": \"danger\",
                \"title\": \"Container Error Detected\",
                \"fields\": [
                  {\"title\": \"Status\", \"value\": \"${{ needs.container-health.outputs.container_status }}\", \"short\": true},
                  {\"title\": \"Errors\", \"value\": \"${{ needs.container-health.outputs.error_count }}\", \"short\": true},
                  {\"title\": \"Action\", \"value\": \"Issue created automatically\", \"short\": false}
                ],
                \"footer\": \"GitHub Actions\",
                \"ts\": $(date +%s)
              }]
            }" \
            ${{ secrets.SLACK_WEBHOOK_URL }} || echo "Slack ì•Œë¦¼ ì „ì†¡ ì‹¤íŒ¨"
        fi
        
        # Discord ì›¹í›… (ì„¤ì •ëœ ê²½ìš°)
        if [ -n "${{ secrets.DISCORD_WEBHOOK_URL }}" ]; then
          curl -X POST -H "Content-Type: application/json" \
            -d "{
              \"content\": \"ğŸš¨ **SafeWork Container Alert**\",
              \"embeds\": [{
                \"title\": \"Container Error Detected\",
                \"color\": 15158332,
                \"fields\": [
                  {\"name\": \"Status\", \"value\": \"${{ needs.container-health.outputs.container_status }}\", \"inline\": true},
                  {\"name\": \"Error Count\", \"value\": \"${{ needs.container-health.outputs.error_count }}\", \"inline\": true}
                ],
                \"timestamp\": \"$(date -u +%Y-%m-%dT%H:%M:%S.000Z)\"
              }]
            }" \
            ${{ secrets.DISCORD_WEBHOOK_URL }} || echo "Discord ì•Œë¦¼ ì „ì†¡ ì‹¤íŒ¨"
        fi
        
        echo "âœ… ì•Œë¦¼ ì „ì†¡ ì™„ë£Œ"