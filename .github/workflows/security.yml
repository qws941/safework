name: Security Scan Pipeline

on:
  push:
    branches: [ main, develop, staging ]
  pull_request:
    branches: [ main, develop ]
  schedule:
    # ë§¤ì¼ ì˜¤ì „ 2ì‹œ ë³´ì•ˆ ìŠ¤ìº” (UTC)
    - cron: '0 2 * * *'
  workflow_dispatch:

env:
  PYTHON_VERSION: '3.11'

jobs:
  vulnerability-scan:
    name: Vulnerability Assessment
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        # ì „ì²´ íˆìŠ¤í† ë¦¬ í•„ìš” (ë³´ì•ˆ ë¶„ì„ìš©)
        fetch-depth: 0
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
    
    - name: Cache pip dependencies
      uses: actions/cache@v3
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-security-${{ hashFiles('app/requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-security-
          ${{ runner.os }}-pip-
    
    - name: Install security tools
      run: |
        python -m pip install --upgrade pip
        pip install bandit[toml] safety semgrep gitpython
    
    - name: Python dependency vulnerability scan
      run: |
        echo "ğŸ” Python íŒ¨í‚¤ì§€ ì·¨ì•½ì  ìŠ¤ìº”..."
        cd app
        safety check --json --output safety-report.json || true
        safety check --short-report || echo "âš ï¸ ì·¨ì•½ì  ë°œê²¬ë¨"
    
    - name: Bandit security scan
      run: |
        echo "ğŸ”’ Python ì½”ë“œ ë³´ì•ˆ ìŠ¤ìº”..."
        cd app
        bandit -r . -f json -o bandit-report.json -x tests/ || true
        bandit -r . -ll -x tests/ || echo "âš ï¸ ë³´ì•ˆ ì´ìŠˆ ë°œê²¬ë¨"
    
    - name: Semgrep SAST scan
      uses: returntocorp/semgrep-action@v1
      with:
        config: >-
          p/security-audit
          p/python
          p/flask
          p/docker
          p/secrets
        publishToken: ${{ secrets.SEMGREP_APP_TOKEN }}
      continue-on-error: true
    
    - name: Git secrets scan
      run: |
        echo "ğŸ” Git íˆìŠ¤í† ë¦¬ ë¯¼ê°ì •ë³´ ìŠ¤ìº”..."
        pip install detect-secrets
        detect-secrets scan --all-files --baseline .secrets.baseline || echo "âš ï¸ ì ì¬ì  ë¹„ë°€ ì •ë³´ ë°œê²¬"
    
    - name: License compliance check
      run: |
        echo "ğŸ“œ ë¼ì´ì„ ìŠ¤ ì»´í”Œë¼ì´ì–¸ìŠ¤ í™•ì¸..."
        cd app
        pip install pip-licenses
        pip-licenses --format=json --output-file=licenses.json
        pip-licenses --summary || echo "âš ï¸ ë¼ì´ì„ ìŠ¤ ì´ìŠˆ í™•ì¸ í•„ìš”"
    
    - name: Upload security reports
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: security-reports-${{ github.run_id }}
        path: |
          app/safety-report.json
          app/bandit-report.json
          app/licenses.json
        retention-days: 30
    
    - name: Security summary
      run: |
        echo "## ğŸ›¡ï¸ Security Scan Summary" >> $GITHUB_STEP_SUMMARY
        echo "- **Safety (Dependencies)**: $(cd app && safety check --json | jq -r '.vulnerabilities | length') vulnerabilities" >> $GITHUB_STEP_SUMMARY
        echo "- **Bandit (SAST)**: $(cd app && bandit -r . -f json -x tests/ | jq -r '.results | length') issues" >> $GITHUB_STEP_SUMMARY
        echo "- **License Check**: Completed" >> $GITHUB_STEP_SUMMARY

  docker-security:
    name: Docker Security Scan
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
    
    - name: Build test image
      run: |
        docker build -t safework-security-test:latest ./app
    
    - name: Docker security scan with Trivy
      uses: aquasecurity/trivy-action@master
      with:
        image-ref: 'safework-security-test:latest'
        format: 'sarif'
        output: 'docker-trivy.sarif'
    
    - name: Docker security scan with Snyk
      continue-on-error: true
      run: |
        # Snyk CLI ì„¤ì¹˜ ë° ì‹¤í–‰
        curl -o snyk https://static.snyk.io/cli/latest/snyk-linux
        chmod +x ./snyk
        ./snyk auth ${{ secrets.SNYK_TOKEN }} || echo "Snyk token not configured"
        ./snyk container test safework-security-test:latest --json > snyk-docker.json || echo "Docker vulnerabilities found"
    
    - name: Dockerfile best practices scan
      run: |
        echo "ğŸ³ Dockerfile ëª¨ë²” ì‚¬ë¡€ í™•ì¸..."
        # Hadolintë¡œ Dockerfile ë¦°íŒ…
        docker run --rm -i hadolint/hadolint < app/Dockerfile || echo "âš ï¸ Dockerfile ê°œì„  ì‚¬í•­ ì¡´ì¬"
    
    - name: Upload Docker security reports
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: docker-security-reports-${{ github.run_id }}
        path: |
          docker-trivy.sarif
          snyk-docker.json
        retention-days: 30
    
    - name: Upload SARIF to GitHub Security
      uses: github/codeql-action/upload-sarif@v2
      if: always()
      with:
        sarif_file: docker-trivy.sarif

  secrets-detection:
    name: Secrets Detection
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: TruffleHog OSS secrets scan
      uses: trufflesecurity/trufflehog@main
      with:
        path: ./
        base: main
        head: HEAD
        extra_args: --debug --only-verified
    
    - name: GitLeaks secrets scan
      uses: gitleaks/gitleaks-action@v2
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        GITLEAKS_LICENSE: ${{ secrets.GITLEAKS_LICENSE }}
    
    - name: Secrets baseline update
      run: |
        pip install detect-secrets
        detect-secrets scan --all-files --baseline .secrets.baseline --exclude-files '\.git/'
        
  compliance-check:
    name: Compliance Assessment
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: GDPR compliance check
      run: |
        echo "ğŸ“‹ GDPR ì»´í”Œë¼ì´ì–¸ìŠ¤ í™•ì¸..."
        # ê°œì¸ì •ë³´ ì²˜ë¦¬ ê´€ë ¨ ì½”ë“œ íŒ¨í„´ í™•ì¸
        grep -r "password\|email\|phone\|ssn\|personal" app/ || echo "ê°œì¸ì •ë³´ ì²˜ë¦¬ ì½”ë“œ ì—†ìŒ"
    
    - name: Security headers check
      run: |
        echo "ğŸ”’ ë³´ì•ˆ í—¤ë” ì„¤ì • í™•ì¸..."
        grep -r "X-Content-Type-Options\|X-Frame-Options\|X-XSS-Protection" app/ || echo "âš ï¸ ë³´ì•ˆ í—¤ë” ì„¤ì • í™•ì¸ í•„ìš”"
    
    - name: Audit logging check
      run: |
        echo "ğŸ“Š ê°ì‚¬ ë¡œê¹… í™•ì¸..."
        grep -r "AuditLog\|audit\|logging" app/ || echo "âš ï¸ ê°ì‚¬ ë¡œê¹… êµ¬í˜„ í™•ì¸ í•„ìš”"

  notify-security-results:
    name: Security Notification
    runs-on: ubuntu-latest
    needs: [vulnerability-scan, docker-security, secrets-detection]
    if: always()
    
    steps:
    - name: Download security reports
      uses: actions/download-artifact@v4
      with:
        name: security-reports-${{ github.run_id }}
        path: ./reports
      continue-on-error: true
    
    - name: Security notification
      if: contains(needs.*.result, 'failure')
      run: |
        echo "ğŸš¨ ë³´ì•ˆ ìŠ¤ìº”ì—ì„œ ì¤‘ìš”í•œ ì´ìŠˆê°€ ë°œê²¬ë˜ì—ˆìŠµë‹ˆë‹¤!"
        echo "ìƒì„¸ ë‚´ìš©ì€ Actions íƒ­ì—ì„œ í™•ì¸í•˜ì„¸ìš”: $GITHUB_SERVER_URL/$GITHUB_REPOSITORY/actions/runs/$GITHUB_RUN_ID"
        
        # Slack/Teams ì•Œë¦¼ (ì„ íƒì‚¬í•­)
        # curl -X POST -H 'Content-type: application/json' \
        #   --data '{"text":"ğŸš¨ SafeWork Security Alert: Issues found in security scan"}' \
        #   ${{ secrets.SLACK_WEBHOOK_URL }}
    
    - name: Create security issue
      if: contains(needs.*.result, 'failure') && github.ref == 'refs/heads/main'
      uses: actions/github-script@v6
      with:
        script: |
          github.rest.issues.create({
            owner: context.repo.owner,
            repo: context.repo.repo,
            title: 'ğŸš¨ Security Scan Alert - ' + new Date().toISOString().split('T')[0],
            body: `## Security Scan Results
            
            ë³´ì•ˆ ìŠ¤ìº”ì—ì„œ ì£¼ì˜ê°€ í•„ìš”í•œ í•­ëª©ì´ ë°œê²¬ë˜ì—ˆìŠµë‹ˆë‹¤.
            
            **ì‹¤í–‰ ì •ë³´:**
            - Run ID: ${context.runId}
            - Branch: ${context.ref}
            - Commit: ${context.sha}
            
            **í™•ì¸ í•„ìš” ì‚¬í•­:**
            - [ ] ì·¨ì•½í•œ íŒ¨í‚¤ì§€ ì˜ì¡´ì„± ê²€í† 
            - [ ] ì½”ë“œ ë³´ì•ˆ ì´ìŠˆ ê²€í† 
            - [ ] Docker ì´ë¯¸ì§€ ë³´ì•ˆ ê²€í† 
            - [ ] ë¹„ë°€ ì •ë³´ ë…¸ì¶œ ì—¬ë¶€ ê²€í† 
            
            [ìƒì„¸ ë³´ê³ ì„œ í™•ì¸](${context.payload.repository.html_url}/actions/runs/${context.runId})
            `,
            labels: ['security', 'priority-high']
          })