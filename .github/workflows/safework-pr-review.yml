name: SafeWork PR Review - Medical & Safety Expert

on:
  pull_request:
    types: [opened, synchronize, ready_for_review, reopened]
    paths:
      - 'app/**'
      - 'docker-compose.yml'
      - 'requirements.txt'
      - '.github/workflows/**'

permissions:
  contents: read
  pull-requests: write
  actions: read
  id-token: write

jobs:
  safework-pr-review:
    runs-on: ubuntu-latest
    timeout-minutes: 20
    if: github.event.pull_request.draft == false

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 2
          ref: ${{ github.event.pull_request.head.sha }}

      - name: Setup Python for code analysis
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: Install SafeWork dependencies
        run: |
          cd app
          pip install -r requirements.txt || echo "Requirements installation failed"

      - name: Analyze changed files
        id: changes
        run: |
          echo "Changed files:"
          git diff --name-only HEAD~1 HEAD
          
          # Categorize changes
          MODELS_CHANGED=$(git diff --name-only HEAD~1 HEAD | grep -E "models.*\.py$" | wc -l)
          ROUTES_CHANGED=$(git diff --name-only HEAD~1 HEAD | grep -E "routes/.*\.py$" | wc -l)
          TEMPLATES_CHANGED=$(git diff --name-only HEAD~1 HEAD | grep -E "templates/.*\.html$" | wc -l)
          MIGRATIONS_CHANGED=$(git diff --name-only HEAD~1 HEAD | grep -E "migrations/.*\.py$" | wc -l)
          
          echo "models_changed=$MODELS_CHANGED" >> $GITHUB_OUTPUT
          echo "routes_changed=$ROUTES_CHANGED" >> $GITHUB_OUTPUT
          echo "templates_changed=$TEMPLATES_CHANGED" >> $GITHUB_OUTPUT
          echo "migrations_changed=$MIGRATIONS_CHANGED" >> $GITHUB_OUTPUT

      - name: SafeWork Medical & Safety PR Review
        uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          track_progress: true
          use_sticky_comment: true

          prompt: |
            # SafeWork ì˜ë£Œë³´ê±´ì•ˆì „ ì‹œìŠ¤í…œ PR ê²€í† 

            ## PR ì •ë³´
            **ì €ì¥ì†Œ**: ${{ github.repository }}
            **PR ë²ˆí˜¸**: #${{ github.event.pull_request.number }}
            **PR ì œëª©**: "${{ github.event.pull_request.title }}"
            **ì‘ì„±ì**: @${{ github.event.pull_request.user.login }}
            **ë² ì´ìŠ¤ ë¸Œëœì¹˜**: ${{ github.event.pull_request.base.ref }}
            **í—¤ë“œ ë¸Œëœì¹˜**: ${{ github.event.pull_request.head.ref }}

            ## ë³€ê²½ì‚¬í•­ ë¶„ì„
            - **ëª¨ë¸ ë³€ê²½**: ${{ steps.changes.outputs.models_changed }}ê°œ íŒŒì¼
            - **ë¼ìš°íŠ¸ ë³€ê²½**: ${{ steps.changes.outputs.routes_changed }}ê°œ íŒŒì¼  
            - **í…œí”Œë¦¿ ë³€ê²½**: ${{ steps.changes.outputs.templates_changed }}ê°œ íŒŒì¼
            - **ë§ˆì´ê·¸ë ˆì´ì…˜**: ${{ steps.changes.outputs.migrations_changed }}ê°œ íŒŒì¼

            ## SafeWork ì „ë¬¸ ê²€í†  ì˜ì—­

            ### 1. ì˜ë£Œì •ë³´ë³´í˜¸ (PHI) ê²€í†  ğŸ¥
            - **ê°œì¸ê±´ê°•ì •ë³´ (PHI) ë³´í˜¸**: 
              - ê±´ê°•ê²€ì§„ ë°ì´í„°, ê·¼ê³¨ê²©ê³„ ì„¤ë¬¸ ì‘ë‹µ ì•”í˜¸í™”
              - ë¡œê·¸ì— ì˜ë£Œì •ë³´ ë…¸ì¶œ ì—†ëŠ”ì§€ í™•ì¸
              - ìµëª…í™” ì²˜ë¦¬ ì ì ˆì„± (user_id=1 íŒ¨í„´)
            - **HIPAA/ê°œì¸ì •ë³´ë³´í˜¸ë²• ì¤€ìˆ˜**:
              - ë°ì´í„° ì ‘ê·¼ ê¶Œí•œ ì œí•œ
              - ê°ì‚¬ ë¡œê·¸ ëˆ„ë½ í™•ì¸
              - ë°ì´í„° ì „ì†¡ì‹œ TLS ì‚¬ìš©

            ### 2. SafeWork ë„ë©”ì¸ ë¡œì§ ê²€í†  ğŸ“‹
            - **ì„¤ë¬¸ì¡°ì‚¬ ì‹œìŠ¤í…œ**:
              - 001 ê·¼ê³¨ê²©ê³„ ì„¤ë¬¸: 16ê°œ ì‹ ì²´ë¶€ìœ„, í†µì¦ ì²™ë„
              - 002 ì‹ ê·œì ê±´ê°•ê²€ì§„: ì˜ë£Œì´ë ¥ í†µí•©
              - JSON ë°ì´í„° êµ¬ì¡° validation
              - ì¡°ê±´ë¶€ ë¡œì§ JavaScript ID ë§¤ì¹­
            - **13ê°œ ê´€ë¦¬íŒ¨ë„ ì¼ê´€ì„±**:
              - Workers, Health Checks, Medications ë“±
              - RESTful API v2 í˜¸í™˜ì„±
              - Bootstrap 4.6 + jQuery íŒ¨í„´

            ### 3. ë°ì´í„°ë² ì´ìŠ¤ ì•ˆì „ì„± ğŸ—„ï¸
            - **MySQL 8.0 í˜¸í™˜ì„±**:
              - UTF8MB4 charset ì‚¬ìš©
              - íŠ¸ëœì­ì…˜ ë¡¤ë°± ì²˜ë¦¬
              - `kst_now()` íƒ€ì„ì¡´ ì¼ê´€ì„±
            - **ë§ˆì´ê·¸ë ˆì´ì…˜ ê²€í† **:
              - INFORMATION_SCHEMA ì‚¬ìš©ë²•
              - AUTO_INCREMENT, INSERT IGNORE ë¬¸ë²•
              - ì¸ë±ìŠ¤ ê´€ë¦¬ ì ì ˆì„±

            ### 4. ë³´ì•ˆ ë° ì¸ì¦ ğŸ”’
            - **Flask ë³´ì•ˆ íŒ¨í„´**:
              - `@login_required` ë°ì½”ë ˆì´í„° ì‚¬ìš©
              - CSRF í† í° ê²€ì¦ (global)
              - XSS ë°©ì§€ (í…œí”Œë¦¿ ì´ìŠ¤ì¼€ì´í•‘)
            - **API ë³´ì•ˆ**:
              - ì…ë ¥ validation ë° sanitization
              - SQL ì¸ì ì…˜ ë°©ì§€
              - ë¹„ìœ¨ ì œí•œ (anonymous survey)

            ### 5. ì„±ëŠ¥ ë° í™•ì¥ì„± âš¡
            - **ë°ì´í„°ë² ì´ìŠ¤ ì„±ëŠ¥**:
              - ì¿¼ë¦¬ ìµœì í™” (lazy loading)
              - ì¸ë±ìŠ¤ í™œìš©
              - N+1 ë¬¸ì œ ë°©ì§€
            - **ìºì‹± ì „ëµ**:
              - Redis ìºì‹± í™œìš©
              - í˜ì´ì§€ë„¤ì´ì…˜ (20/page)
              - ì •ì  ë¦¬ì†ŒìŠ¤ ì••ì¶•

            ### 6. ì‚¬ìš©ì ê²½í—˜ (UX) ğŸ‘¥
            - **ë‹¤êµ­ì–´ ì§€ì›**:
              - í•œêµ­ì–´ ìš°ì„  ì¸í„°í˜ì´ìŠ¤
              - KST íƒ€ì„ì¡´ ì¼ê´€ì„±
              - ì˜ë£Œ ìš©ì–´ ì •í™•ì„±
            - **ì ‘ê·¼ì„±**:
              - ì‚°ì—… í˜„ì¥ ì‚¬ìš©ì ê³ ë ¤
              - ëª¨ë°”ì¼ ë°˜ì‘í˜• (Bootstrap 4.6)
              - í‚¤ë³´ë“œ ë„¤ë¹„ê²Œì´ì…˜

            ### 7. í…ŒìŠ¤íŠ¸ ë° í’ˆì§ˆ ğŸ§ª
            - **í…ŒìŠ¤íŠ¸ ì»¤ë²„ë¦¬ì§€**:
              - ì˜ë£Œ ë°ì´í„° ì²˜ë¦¬ í…ŒìŠ¤íŠ¸
              - ì„¤ë¬¸ ì œì¶œ flow í…ŒìŠ¤íŠ¸
              - API ì—”ë“œí¬ì¸íŠ¸ í…ŒìŠ¤íŠ¸
            - **ì½”ë“œ í’ˆì§ˆ**:
              - ESLint ê·œì¹™ ì¤€ìˆ˜ (18 errors í•´ê²°)
              - íŒŒì¼ë‹¹ 500ì¤„, í•¨ìˆ˜ë‹¹ 100ì¤„ ì œí•œ
              - pytest 39/39 í†µê³¼

            ### 8. ë°°í¬ ë° ìš´ì˜ ğŸš€
            - **Docker & Watchtower**:
              - multi-platform ì´ë¯¸ì§€
              - í™˜ê²½ë³€ìˆ˜ ë³´ì•ˆ ê´€ë¦¬
              - í—¬ìŠ¤ì²´í¬ ì—”ë“œí¬ì¸íŠ¸
            - **GitHub Actions**:
              - 5ê°œ íŠ¹í™” ì›Œí¬í”Œë¡œ í˜¸í™˜ì„±
              - ë³´ì•ˆ ìŠ¤ìº” (Trivy, Bandit)
              - ìë™ ë°°í¬ íŒŒì´í”„ë¼ì¸

            ## ê²€í†  ì§€ì¹¨
            1. **í•œêµ­ì–´ PRì€ í•œêµ­ì–´ë¡œ ê²€í†  ë° í”¼ë“œë°±**
            2. **ì˜ë£Œì •ë³´ ê´€ë ¨ ë³€ê²½ì‚¬í•­ì€ íŠ¹ë³„íˆ ì—„ê²©í•˜ê²Œ ê²€í† **
            3. **ì¸ë¼ì¸ ì½”ë©˜íŠ¸ë¡œ êµ¬ì²´ì  ê°œì„ ì‚¬í•­ ì œì‹œ**
            4. **ì „ì²´ ì½”ë©˜íŠ¸ë¡œ ì•„í‚¤í…ì²˜ ë ˆë²¨ í”¼ë“œë°±**
            5. **ë³´ì•ˆ ì´ìŠˆ ë°œê²¬ì‹œ ì¦‰ì‹œ ì§€ì **
            6. **ì„±ëŠ¥ ì˜í–¥ë„ ë¶„ì„ ë° ê¶Œì¥ì‚¬í•­**

            ## ì²´í¬ë¦¬ìŠ¤íŠ¸
            - [ ] PHI ë°ì´í„° ë³´í˜¸ ê²€ì¦
            - [ ] SafeWork ë„ë©”ì¸ ë¡œì§ ì •í™•ì„±
            - [ ] MySQL 8.0 í˜¸í™˜ì„± í™•ì¸
            - [ ] ë³´ì•ˆ vulnerability ìŠ¤ìº”
            - [ ] í…ŒìŠ¤íŠ¸ ì»¤ë²„ë¦¬ì§€ í™•ì¸
            - [ ] ì„±ëŠ¥ impact ë¶„ì„
            - [ ] ì ‘ê·¼ì„± ë° UX ê²€í† 
            - [ ] ë°°í¬ íŒŒì´í”„ë¼ì¸ í˜¸í™˜ì„±

            **ì´ì œ PRì„ ì¢…í•©ì ìœ¼ë¡œ ê²€í† í•˜ê³  SafeWork ì˜ë£Œë³´ê±´ ì‹œìŠ¤í…œì— íŠ¹í™”ëœ í”¼ë“œë°±ì„ ì œê³µí•´ì£¼ì„¸ìš”.**

          claude_args: |
            --allowedTools "Read,Grep,Bash(gh pr diff:*),Bash(gh pr view:*),Bash(python:*),Bash(pytest:*)"
            --max-turns 15

      - name: Post-review summary
        run: |
          echo "SafeWork PR ê²€í†  ì™„ë£Œ"
          echo "PR: #${{ github.event.pull_request.number }}"
          echo "ë³€ê²½ì‚¬í•­: Models(${{ steps.changes.outputs.models_changed }}) Routes(${{ steps.changes.outputs.routes_changed }}) Templates(${{ steps.changes.outputs.templates_changed }})"