name: 🎯 Claude Issue Assistant

on:
  issues:
    types: [opened, reopened, edited]
  issue_comment:
    types: [created]
  workflow_dispatch:
    inputs:
      issue_number:
        description: 'Issue number to process'
        required: true
        type: string

jobs:
  claude-assistant:
    runs-on: ubuntu-latest
    # Only run if issue mentions @claude or is manually triggered
    if: |
      github.event_name == 'workflow_dispatch' ||
      (github.event_name == 'issues' && (
        contains(github.event.issue.body, '@claude') || 
        contains(github.event.issue.title, '@claude') ||
        contains(github.event.issue.labels.*.name, 'claude-assist')
      )) ||
      (github.event_name == 'issue_comment' && 
        contains(github.event.comment.body, '@claude'))
    
    permissions:
      contents: write
      issues: write
      pull-requests: write
      id-token: write
    
    steps:
      - name: 📥 Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: 🤖 Claude Issue Analysis & Resolution
        uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          track_progress: true
          prompt: |
            REPO: ${{ github.repository }}
            ISSUE NUMBER: ${{ github.event.issue.number || github.event.inputs.issue_number }}

            🎯 **SafeWork 이슈 분석 및 해결 전문가**
            
            SafeWork는 Flask 3.0 기반의 산업안전보건 관리 시스템입니다.
            이슈를 분석하고 가능한 경우 직접 해결해주세요.

            **분석 및 처리 단계:**

            **1. 이슈 분류 및 우선순위 평가**
            - 버그/기능요청/개선사항/질문 분류
            - Critical/High/Medium/Low 우선순위 설정
            - SafeWork 시스템 영향도 평가

            **2. 기술적 분석**
            - Flask 3.0 웹 애플리케이션 아키텍처 관점
            - SQLAlchemy 2.0 데이터 모델 영향도
            - Docker 컨테이너 환경 고려사항
            - 산업안전보건 도메인 로직 검토

            **3. 자동 해결 가능한 이슈들**
            - 설정 파일 오류 수정
            - 코드 포맷팅 및 린팅 문제
            - 간단한 버그 수정
            - 문서화 개선
            - 테스트 코드 추가
            - 의존성 업데이트
            - 데이터베이스 마이그레이션 수정

            **4. 복잡한 이슈 처리**
            - 상세한 분석 리포트 제공
            - 단계별 해결 방안 제시
            - 관련 코드 파일 및 라인 참조
            - 테스트 방법 제안

            **5. SafeWork 도메인 전문 지식 활용**
            - 설문조사 시스템 (001 근골격계, 002 신규채용자)
            - 산업안전보건 규정 준수
            - 개인정보보호 및 의료정보 처리
            - 한국어 UI/UX 최적화

            이슈를 철저히 분석하고, 가능한 경우 코드를 직접 수정하여 Pull Request를 생성해주세요.
            복잡한 이슈의 경우 단계별 해결 방향을 제시해주세요.

          claude_args: |
            --allowedTools "mcp__serena__*,mcp__sequential-thinking__*,mcp__shrimp-task-manager__*,mcp__github__*,Bash(gh issue:*),Bash(gh pr:*),Bash(git:*)"