name: ğŸ”§ CI Auto Fix

on:
  workflow_run:
    workflows: ["ğŸš€ SafeWork Deployment Pipeline"]
    types: [completed]
    branches: [main, master]
  workflow_dispatch:
    inputs:
      fix_strategy:
        description: 'Auto-fix strategy'
        required: true
        default: 'quick'
        type: choice
        options:
          - 'quick'
          - 'comprehensive'
          - 'experimental'

permissions:
  contents: write
  actions: read
  pull-requests: write

jobs:
  auto-fix:
    name: ğŸ› ï¸ Automated Problem Resolution
    runs-on: ubuntu-latest
    if: >
      (github.event_name == 'workflow_run' && github.event.workflow_run.conclusion == 'failure') ||
      github.event_name == 'workflow_dispatch'
    
    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: ğŸ” Analyze Workflow Failure
        uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          track_progress: true
          prompt: |
            ğŸ”§ **SafeWork CI/CD ìë™ ìˆ˜ì • ì‹œìŠ¤í…œ**
            
            ì‹¤íŒ¨í•œ ì›Œí¬í”Œë¡œìš°ë¥¼ ë¶„ì„í•˜ê³  ìë™ìœ¼ë¡œ ë¬¸ì œë¥¼ í•´ê²°í•´ì£¼ì„¸ìš”.
            
            **ìˆ˜ì • ì „ëµ:** ${{ inputs.fix_strategy || 'quick' }}
            **ì‹¤íŒ¨í•œ ì›Œí¬í”Œë¡œìš°:** ${{ github.event.workflow_run.html_url || 'ìˆ˜ë™ íŠ¸ë¦¬ê±°' }}
            
            **ì¼ë°˜ì ì¸ ë¬¸ì œ ìœ í˜•:**
            1. **Docker ë¹Œë“œ ì‹¤íŒ¨** - Dockerfile ì˜¤ë¥˜, ì˜ì¡´ì„± ë¬¸ì œ
            2. **í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨** - í™˜ê²½ ì„¤ì •, ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²° ë¬¸ì œ
            3. **ë°°í¬ ì‹¤íŒ¨** - ë ˆì§€ìŠ¤íŠ¸ë¦¬ ì¸ì¦, Watchtower API ë¬¸ì œ
            4. **ì˜ì¡´ì„± ì˜¤ë¥˜** - requirements.txt, Python íŒ¨í‚¤ì§€ ë¬¸ì œ
            5. **ì„¤ì • ì˜¤ë¥˜** - í™˜ê²½ ë³€ìˆ˜, Docker Compose ì„¤ì •
            
            **ìë™ ìˆ˜ì • ê°€ëŠ¥í•œ í•­ëª©:**
            - requirements.txt ì—…ë°ì´íŠ¸
            - Docker ì„¤ì • ìˆ˜ì •
            - í…ŒìŠ¤íŠ¸ í™˜ê²½ êµ¬ì„± ê°œì„ 
            - ì½”ë“œ í¬ë§·íŒ… ë° ë¦°íŒ… ì˜¤ë¥˜
            - ê¸°ë³¸ì ì¸ êµ¬ë¬¸ ì˜¤ë¥˜
            
            **ìˆ˜ì • í›„ ì‘ì—…:**
            1. ë³€ê²½ì‚¬í•­ì„ ìƒˆ ë¸Œëœì¹˜ì— ì»¤ë°‹
            2. Pull Request ìƒì„±
            3. ìˆ˜ì • ë‚´ìš© ìƒì„¸ ì„¤ëª…
            
            SafeWork í”„ë¡œì íŠ¸ì˜ ì•ˆì •ì„±ì„ ìœ„í•´ ì‹ ì¤‘í•˜ê²Œ ìˆ˜ì •í•´ì£¼ì„¸ìš”.
          claude_args: |
            --model claude-sonnet-4-20250514
            --maxTokens 12288
            --temperature 0.1
            --allowedTools "mcp__serena__*,mcp__github__*,mcp__sequential-thinking__*"
            --systemPrompt "CI/CD íŒŒì´í”„ë¼ì¸ ì „ë¬¸ê°€. SafeWork Flask ì• í”Œë¦¬ì¼€ì´ì…˜ì˜ ë¹Œë“œ, í…ŒìŠ¤íŠ¸, ë°°í¬ ë¬¸ì œë¥¼ ìë™ìœ¼ë¡œ ì§„ë‹¨í•˜ê³  ì•ˆì „í•œ ìˆ˜ì • ë°©ì•ˆì„ ì œì‹œí•©ë‹ˆë‹¤. ë³€ê²½ì‚¬í•­ì€ í•­ìƒ PRì„ í†µí•´ ê²€í†  ê°€ëŠ¥í•˜ë„ë¡ í•©ë‹ˆë‹¤."