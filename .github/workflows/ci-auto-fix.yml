name: ğŸ¤– CI Auto-Fix Pipeline

on:
  workflow_run:
    workflows: ["ğŸš€ Deploy Pipeline"]
    types:
      - completed
  workflow_dispatch:
    inputs:
      fix_strategy:
        description: 'Fix strategy to use'
        required: false
        default: 'quick'
        type: choice
        options:
          - quick
          - comprehensive
          - experimental

permissions:
  contents: write
  actions: write
  issues: write
  pull-requests: write
  checks: write
  security-events: write
  statuses: write
  id-token: write
  packages: write
  deployments: write

env:
  CLAUDE_CODE_OAUTH_TOKEN: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
  PORTAINER_API_KEY: ${{ secrets.PORTAINER_API_KEY }}
  POSTGRES_PASSWORD: ${{ secrets.POSTGRES_PASSWORD }}
  REDIS_PASSWORD: ${{ secrets.REDIS_PASSWORD }}
  REGISTRY_PASSWORD: ${{ secrets.REGISTRY_PASSWORD }}

jobs:
  auto-fix:
    if: github.event.workflow_run.conclusion == 'failure' || github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    timeout-minutes: 20
    
    steps:
      - name: ğŸ”— Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0
          
      - name: ğŸ§  Setup Claude Code
        run: |
          curl -fsSL https://claude.ai/install.sh | bash
          echo "$CLAUDE_CODE_OAUTH_TOKEN" | claude auth
          
      - name: ğŸ“Š Collect failure context
        id: context
        run: |
          echo "failure_context<<EOF" >> $GITHUB_OUTPUT
          echo "Repository: SafeWork Flask Application" >> $GITHUB_OUTPUT
          echo "Branch: ${{ github.ref_name }}" >> $GITHUB_OUTPUT
          echo "Commit: ${{ github.sha }}" >> $GITHUB_OUTPUT
          echo "Triggered by: ${{ github.event_name }}" >> $GITHUB_OUTPUT
          echo "Fix strategy: ${{ github.event.inputs.fix_strategy || 'quick' }}" >> $GITHUB_OUTPUT
          echo "Architecture: Independent containers (PostgreSQL, Redis, Flask)" >> $GITHUB_OUTPUT
          echo "Services: safework-postgres:4546, safework-redis:4547, safework-app:4545" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          
      - name: ğŸ” Intelligent CI Failure Auto-Fix
        uses: anthropics/claude-code-action@v1
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          anthropic_api_key: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          track_progress: true
          prompt: |
            ğŸš¨ **SafeWork CI/CD íŒŒì´í”„ë¼ì¸ ìë™ ë³µêµ¬**
            
            **ì‹¤íŒ¨ ì»¨í…ìŠ¤íŠ¸:**
            - ì „ëµ: ${{ github.event.inputs.fix_strategy || 'quick' }}
            - ë¸Œëœì¹˜: ${{ github.ref_name }}
            - ì»¤ë°‹: ${{ github.sha }}
            
            **ìë™ ìˆ˜ì • í”„ë¡œí† ì½œ:**
            1. ìµœê·¼ ì›Œí¬í”Œë¡œìš° ì‹¤íŒ¨ ë¡œê·¸ ë¶„ì„
            2. ì¼ë°˜ì ì¸ ì˜¤ë¥˜ íŒ¨í„´ ì‹ë³„
            3. ì•ˆì „í•œ ìë™ ìˆ˜ì • ì ìš©
            4. ìˆ˜ì • ë‚´ìš© ê²€ì¦
            5. ìƒˆë¡œìš´ ë°°í¬ íŒŒì´í”„ë¼ì¸ íŠ¸ë¦¬ê±°
            
            **ì£¼ìš” ìˆ˜ì • ëŒ€ìƒ:**
            - Docker ë¹Œë“œ ì˜¤ë¥˜ (COPY ê²½ë¡œ, requirements.txt)
            - PostgreSQL ì—°ê²° ì„¤ì • (í˜¸ìŠ¤íŠ¸ëª…, í¬íŠ¸, ìê²©ì¦ëª…)
            - GitHub Actions YAML ë¬¸ë²• ì˜¤ë¥˜
            - í™˜ê²½ ë³€ìˆ˜ ë¶ˆì¼ì¹˜
            - Python ì˜ì¡´ì„± ì¶©ëŒ
            
            ì¦‰ì‹œ ìë™ ë³µêµ¬ë¥¼ ì‹œì‘í•˜ê³  í•œêµ­ì–´ë¡œ ì§„í–‰ ìƒí™©ì„ ë³´ê³ í•´ì£¼ì„¸ìš”.
          
      - name: ğŸ“ˆ Report execution metrics
        if: always()
        run: |
          echo "=== ğŸ¤– CI Auto-Fix Execution Report ==="
          echo "Strategy Used: ${{ github.event.inputs.fix_strategy || 'quick' }}"
          echo "Execution Time: ${{ github.run_number }}"
          echo "Repository: SafeWork"
          echo "Status: ${{ job.status }}"
          
          # Create GitHub issue for tracking if needed
          if [ "${{ job.status }}" != "success" ]; then
            gh issue create \
              --title "ğŸš¨ CI Auto-Fix Failed - Manual Intervention Required" \
              --body "Auto-fix pipeline failed to resolve CI/CD issues. Manual review needed." \
              --label "claude-actionable,ci-failure,high-priority"
          fi