name: 🔧 CI Auto Fix

on:
  workflow_run:
    workflows: ["🚀 SafeWork Deployment Pipeline"]
    types: [completed]
    branches: [main, master]
  workflow_dispatch:
    inputs:
      fix_strategy:
        description: 'Auto-fix strategy'
        required: true
        default: 'quick'
        type: choice
        options:
          - 'quick'
          - 'comprehensive'
          - 'experimental'

permissions:
  contents: write
  actions: read
  pull-requests: write

jobs:
  auto-fix:
    name: 🛠️ Automated Problem Resolution
    runs-on: ubuntu-latest
    if: >
      (github.event_name == 'workflow_run' && github.event.workflow_run.conclusion == 'failure') ||
      github.event_name == 'workflow_dispatch'
    
    steps:
      - name: 📥 Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: 🔍 Analyze Workflow Failure
        uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          track_progress: true
          prompt: |
            🔧 **SafeWork CI/CD 자동 수정 시스템**
            
            실패한 워크플로우를 분석하고 자동으로 문제를 해결해주세요.
            
            **수정 전략:** ${{ inputs.fix_strategy || 'quick' }}
            **실패한 워크플로우:** ${{ github.event.workflow_run.html_url || '수동 트리거' }}
            
            **일반적인 문제 유형:**
            1. **Docker 빌드 실패** - Dockerfile 오류, 의존성 문제
            2. **테스트 실패** - 환경 설정, 데이터베이스 연결 문제
            3. **배포 실패** - 레지스트리 인증, Watchtower API 문제
            4. **의존성 오류** - requirements.txt, Python 패키지 문제
            5. **설정 오류** - 환경 변수, Docker Compose 설정
            
            **자동 수정 가능한 항목:**
            - requirements.txt 업데이트
            - Docker 설정 수정
            - 테스트 환경 구성 개선
            - 코드 포맷팅 및 린팅 오류
            - 기본적인 구문 오류
            
            **수정 후 작업:**
            1. 변경사항을 새 브랜치에 커밋
            2. Pull Request 생성
            3. 수정 내용 상세 설명
            
            SafeWork 프로젝트의 안정성을 위해 신중하게 수정해주세요.
          claude_args: |
            --model claude-sonnet-4-20250514
            --maxTokens 12288
            --temperature 0.1
            --allowedTools "mcp__serena__*,mcp__github__*,mcp__sequential-thinking__*"
            --systemPrompt "CI/CD 파이프라인 전문가. SafeWork Flask 애플리케이션의 빌드, 테스트, 배포 문제를 자동으로 진단하고 안전한 수정 방안을 제시합니다. 변경사항은 항상 PR을 통해 검토 가능하도록 합니다."