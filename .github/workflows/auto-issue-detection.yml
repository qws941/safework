name: ì´ìŠˆ ìë™ ê°ì§€ ë° ì²˜ë¦¬

on:
  push:
    branches: [master, main]
  schedule:
    # ë§¤ 30ë¶„ë§ˆë‹¤ ì—´ë¦° ì´ìŠˆ í™•ì¸ ë° Claude ìë™ í• ë‹¹
    - cron: '*/30 * * * *'  # 30ë¶„ë§ˆë‹¤ ì‹¤í–‰
  workflow_dispatch:
    inputs:
      test_mode:
        description: 'í…ŒìŠ¤íŠ¸ ëª¨ë“œ ì‹¤í–‰'
        required: false
        default: 'true'
        type: boolean

env:
  TZ: Asia/Seoul

jobs:
  # 1ë‹¨ê³„: ì˜¤í”ˆ ì´ìŠˆ ìë™ ê°ì§€ ë° Claude í• ë‹¹
  detect-open-issues:
    runs-on: ubuntu-latest
    permissions:
      issues: write
      contents: read
    
    steps:
      - name: ğŸ” ì—´ë¦° ì´ìŠˆ ìŠ¤ìº” ë° Claude ìë™ í• ë‹¹
        uses: actions/github-script@v7
        with:
          script: |
            console.log('ğŸ” ì—´ë¦° ì´ìŠˆ ìë™ Claude í• ë‹¹ ì‹œì‘...');
            
            const { owner, repo } = context.repo;
            let assignedCount = 0;
            
            try {
              // ì—´ë¦° ì´ìŠˆ ëª©ë¡ ê°€ì ¸ì˜¤ê¸° (ìµœê·¼ 10ê°œ)
              const { data: issues } = await github.rest.issues.listForRepo({
                owner,
                repo,
                state: 'open',
                per_page: 10,
                sort: 'created',
                direction: 'desc'
              });
              
              console.log(`ğŸ“‹ ${issues.length}ê°œì˜ ì—´ë¦° ì´ìŠˆ ë°œê²¬`);
              
              for (const issue of issues) {
                // PRì€ ì œì™¸
                if (issue.pull_request) {
                  console.log(`â­ï¸ ì´ìŠˆ #${issue.number}: PRì´ë¯€ë¡œ ì œì™¸`);
                  continue;
                }
                
                console.log(`ğŸ” ì´ìŠˆ #${issue.number} ê²€í† : ${issue.title}`);
                
                // 24ì‹œê°„ ì´ë‚´ ìƒì„±ëœ ì´ìŠˆë§Œ ì²˜ë¦¬
                const created = new Date(issue.created_at);
                const now = new Date();
                const hoursOld = (now - created) / (1000 * 60 * 60);
                
                if (hoursOld > 24) {
                  console.log(`â­ï¸ ì´ìŠˆ #${issue.number}: 24ì‹œê°„ ê²½ê³¼ (${Math.round(hoursOld)}ì‹œê°„)`);
                  continue;
                }
                
                // ê¸°ì¡´ ëŒ“ê¸€ì—ì„œ Claude ë©˜ì…˜ í™•ì¸
                const { data: comments } = await github.rest.issues.listComments({
                  owner,
                  repo,
                  issue_number: issue.number
                });
                
                const hasClaudeComment = comments.some(comment => 
                  comment.user.login === 'claude[bot]' ||
                  comment.body.includes('@claude') ||
                  comment.body.includes('Claude ì‘ì—… ì‹œì‘') ||
                  comment.body.includes('Claude ìë™ í• ë‹¹')
                );
                
                if (hasClaudeComment) {
                  console.log(`â­ï¸ ì´ìŠˆ #${issue.number}: ì´ë¯¸ Claudeê°€ ì²˜ë¦¬ ì¤‘`);
                  continue;
                }
                
                // Claude ìë™ í• ë‹¹ ëŒ“ê¸€ ì¶”ê°€
                console.log(`âœ… ì´ìŠˆ #${issue.number} Claude ìë™ í• ë‹¹ ì¤‘...`);
                
                // ì´ìŠˆ ì œëª©ì„ ê¸°ë°˜ìœ¼ë¡œ ê´€ë ¨ ì—”ë“œí¬ì¸íŠ¸ URL íŒíŠ¸ ìƒì„±
                const issueTitle = issue.title || '';
                let endpointHints = [];
                
                if (issueTitle.includes('ì„¤ë¬¸') || issueTitle.includes('survey')) {
                  endpointHints.push('- ì„¤ë¬¸ì¡°ì‚¬ 001: /survey/001');
                  endpointHints.push('- ì„¤ë¬¸ì¡°ì‚¬ 002: /survey/002');
                }
                if (issueTitle.includes('ê´€ë¦¬') || issueTitle.includes('admin')) {
                  endpointHints.push('- ê´€ë¦¬ì ëŒ€ì‹œë³´ë“œ: /admin');
                  endpointHints.push('- SafeWork íŒ¨ë„: /admin/safework');
                }
                if (issueTitle.includes('API') || issueTitle.includes('api')) {
                  endpointHints.push('- SafeWork API: /api/safework/v2/*');
                }
                if (issueTitle.includes('ë¬¸ì„œ') || issueTitle.includes('document')) {
                  endpointHints.push('- ë¬¸ì„œ ê´€ë¦¬: /admin/documents');
                  endpointHints.push('- ê³µê°œ ë¬¸ì„œ: /documents');
                }
                if (issueTitle.includes('ì¸ì¦') || issueTitle.includes('auth')) {
                  endpointHints.push('- ë¡œê·¸ì¸: /auth/login');
                  endpointHints.push('- íšŒì›ê°€ì…: /auth/register');
                }
                
                const endpointHintSection = endpointHints.length > 0 ? 
                  `\n\n**ğŸ”— ê´€ë ¨ ì—”ë“œí¬ì¸íŠ¸ íŒíŠ¸:**\n${endpointHints.join('\n')}\n_(í•´ê²° ì™„ë£Œ ì‹œ ì‹¤ì œ URLì„ ëŒ“ê¸€ì— í¬í•¨í•´ì£¼ì„¸ìš”)_` : '';

                const commentBody = `ğŸ¤– **Claude ìë™ í• ë‹¹**

ğŸ“‹ **ìë™ ê°ì§€ëœ ì´ìŠˆ**
- **ì´ìŠˆ**: ${issue.title}
- **ìƒì„±ì‹œê°„**: ${created.toLocaleString('ko-KR', { timeZone: 'Asia/Seoul' })}
- **í• ë‹¹ì‹œê°„**: ${new Date().toLocaleString('ko-KR', { timeZone: 'Asia/Seoul' })}${endpointHintSection}

ğŸ¯ **Claude ì‘ì—… ì‹œì‘**
@claude ì´ ì´ìŠˆë¥¼ ë¶„ì„í•˜ê³  í•´ê²°í•´ì£¼ì„¸ìš”.

SafeWork í”„ë¡œì íŠ¸ íŒ¨í„´ì„ ë”°ë¼ ë‹¤ìŒ ë‹¨ê³„ë¡œ ì§„í–‰í•´ì£¼ì„¸ìš”:
1. ì´ìŠˆ ë‚´ìš© ì •í™•í•œ ë¶„ì„
2. ê´€ë ¨ íŒŒì¼ ì‹ë³„ ë° í˜„ì¬ ìƒíƒœ í™•ì¸
3. ì ì ˆí•œ í•´ê²°ë°©ì•ˆ êµ¬í˜„
4. í…ŒìŠ¤íŠ¸ ì‹¤í–‰ ë° ê²€ì¦
5. ì»¤ë°‹ ë° ì´ìŠˆ ì™„ë£Œ (ì—”ë“œí¬ì¸íŠ¸ URL í¬í•¨)

---
_ğŸ•’ ìë™ í• ë‹¹ ì‹œìŠ¤í…œì— ì˜í•´ ìƒì„±ë¨_`;
                
                await github.rest.issues.createComment({
                  owner,
                  repo,
                  issue_number: issue.number,
                  body: commentBody
                });
                
                assignedCount++;
                console.log(`âœ… ì´ìŠˆ #${issue.number} Claude ìë™ í• ë‹¹ ì™„ë£Œ`);
                
                // API ì œí•œì„ ìœ„í•œ ëŒ€ê¸°
                await new Promise(resolve => setTimeout(resolve, 2000));
              }
              
              console.log(`ğŸ¯ ì´ ${assignedCount}ê°œ ì´ìŠˆì— Claude ìë™ í• ë‹¹ ì™„ë£Œ`);
              
            } catch (error) {
              console.error('âŒ ì´ìŠˆ í• ë‹¹ ì¤‘ ì˜¤ë¥˜ ë°œìƒ:', error);
            }

  # 2ë‹¨ê³„: ê²°ê³¼ ì•Œë¦¼
  notify-completion:
    needs: detect-open-issues
    if: always()
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“Š ìë™ í• ë‹¹ ê²°ê³¼ ì•Œë¦¼
        run: |
          echo "ğŸ¯ ì—´ë¦° ì´ìŠˆ ìë™ Claude í• ë‹¹ ì™„ë£Œ!"
          echo "âœ… ì›Œí¬í”Œë¡œìš°ê°€ ì„±ê³µì ìœ¼ë¡œ ì‹¤í–‰ë˜ì—ˆìŠµë‹ˆë‹¤."
          echo "ğŸ’¡ ìƒˆë¡œìš´ ì´ìŠˆê°€ ìˆìœ¼ë©´ ìë™ìœ¼ë¡œ Claudeì—ê²Œ í• ë‹¹ë©ë‹ˆë‹¤."