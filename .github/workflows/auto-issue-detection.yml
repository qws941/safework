name: SafeWork Auto Issue Detection

on:
  issue_comment:
    types: [created]
  pull_request_review_comment:
    types: [created]
  issues:
    types: [opened, edited]
  pull_request:
    types: [opened, edited, synchronize]

permissions:
  contents: read
  issues: write
  pull-requests: write

jobs:
  detect-claude-requests:
    # 모든 댓글에서 자동으로 Claude AI가 분석 (사용자 기입 불필요)
    runs-on: ubuntu-latest
    timeout-minutes: 5
    
    steps:
      - name: Detect Claude Request
        uses: actions/github-script@v7
        with:
          script: |
            // 이벤트 타입별 처리
            let targetBody = '';
            let issueNumber = 0;
            
            if (context.payload.comment) {
              // 댓글 이벤트
              targetBody = context.payload.comment.body.toLowerCase();
              issueNumber = context.issue.number;
            } else if (context.payload.issue) {
              // 이슈 이벤트
              targetBody = (context.payload.issue.title + ' ' + context.payload.issue.body).toLowerCase();
              issueNumber = context.payload.issue.number;
            } else if (context.payload.pull_request) {
              // PR 이벤트
              targetBody = (context.payload.pull_request.title + ' ' + context.payload.pull_request.body).toLowerCase();
              issueNumber = context.payload.pull_request.number;
            }
            
            // 자동 분석: 문제, 오류, 도움 키워드 감지 + SafeWork 키워드
            const triggerWords = [
              // 일반 문제 키워드
              '문제', '오류', '에러', '도움', '수정', '버그', '안됨', '작동', '실행', '테스트', 
              'error', 'bug', 'help', 'fix', 'issue',
              // SafeWork 도메인 키워드  
              '설문', '건강', '검진', '안전', '의료', '관리', 'survey', 'health', 'admin', 'safework',
              // 기술 키워드
              'flask', 'mysql', 'redis', 'docker', 'api', '데이터베이스', '워크플로'
            ];
            const needsHelp = triggerWords.some(word => targetBody.includes(word));
            
            if (needsHelp || targetBody.includes('@claude')) {
              // 자동 라벨 추가
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issueNumber,
                labels: ['auto-analyzed', 'claude-ai', 'safework-domain']
              });
              
              // 자동 분석 및 대응 댓글 생성
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issueNumber,
                body: \`🤖 **SafeWork AI 완전 자동화 시스템**

**✅ 사용자 기입 없이 자동 분석 완료!**

📋 **SafeWork 산업보건안전 도메인 자동 감지:**
- 🏥 의료/보건: 근골격계 설문(001), 건강검진(002)  
- 💻 기술스택: Flask 3.0+, MySQL 8.0, Redis, Docker
- 🛠️ 13개 관리패널 + RESTful API v2
- 🔄 Watchtower 자동배포 시스템

🔍 **자동 분석된 내용**: 
\\\`\\\`\\\`
\${targetBody.substring(0, 200)}...
\\\`\\\`\\\`

🎯 **자동 실행된 액션:**
- ✅ \`auto-analyzed\` 라벨 자동 추가
- ✅ \`safework-domain\` 라벨 자동 적용
- ✅ SafeWork 전문가 AI 모드 활성화
- ✅ 우선순위 자동 분류 완료

🚀 **완전 자동화**: 앞으로 어떤 Issue나 댓글을 작성하셔도 
Claude AI가 자동으로 SafeWork 도메인을 분석하고 대응합니다!

**더 이상 @claude나 특별한 키워드 입력이 필요 없습니다!** 🎉\`
              });
            } else {
              // 일반 콘텐츠도 모니터링
              console.log('Content monitored for SafeWork patterns:', targetBody.substring(0, 100));
            }

      - name: Update Memory
        run: |
          echo "Claude request detected and processed for SafeWork project"
          echo "Comment ID: \${{ github.event.comment.id }}"
          echo "Issue/PR: #\${{ github.event.issue.number || github.event.pull_request.number }}"