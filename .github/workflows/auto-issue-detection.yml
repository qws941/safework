name: SafeWork Auto Issue Detection

on:
  issue_comment:
    types: [created]
  pull_request_review_comment:
    types: [created]
  issues:
    types: [opened, edited]
  pull_request:
    types: [opened, edited, synchronize]

permissions:
  contents: read
  issues: write
  pull-requests: write

jobs:
  detect-claude-requests:
    # ëª¨ë“  ëŒ“ê¸€ì—ì„œ ìë™ìœ¼ë¡œ Claude AIê°€ ë¶„ì„ (ì‚¬ìš©ì ê¸°ì… ë¶ˆí•„ìš”)
    runs-on: ubuntu-latest
    timeout-minutes: 5
    
    steps:
      - name: Detect Claude Request
        uses: actions/github-script@v7
        with:
          script: |
            // ì´ë²¤íŠ¸ íƒ€ì…ë³„ ì²˜ë¦¬
            let targetBody = '';
            let issueNumber = 0;
            
            if (context.payload.comment) {
              // ëŒ“ê¸€ ì´ë²¤íŠ¸
              targetBody = context.payload.comment.body.toLowerCase();
              issueNumber = context.issue.number;
            } else if (context.payload.issue) {
              // ì´ìŠˆ ì´ë²¤íŠ¸
              targetBody = (context.payload.issue.title + ' ' + context.payload.issue.body).toLowerCase();
              issueNumber = context.payload.issue.number;
            } else if (context.payload.pull_request) {
              // PR ì´ë²¤íŠ¸
              targetBody = (context.payload.pull_request.title + ' ' + context.payload.pull_request.body).toLowerCase();
              issueNumber = context.payload.pull_request.number;
            }
            
            // ìë™ ë¶„ì„: ë¬¸ì œ, ì˜¤ë¥˜, ë„ì›€ í‚¤ì›Œë“œ ê°ì§€ + SafeWork í‚¤ì›Œë“œ
            const triggerWords = [
              // ì¼ë°˜ ë¬¸ì œ í‚¤ì›Œë“œ
              'ë¬¸ì œ', 'ì˜¤ë¥˜', 'ì—ëŸ¬', 'ë„ì›€', 'ìˆ˜ì •', 'ë²„ê·¸', 'ì•ˆë¨', 'ì‘ë™', 'ì‹¤í–‰', 'í…ŒìŠ¤íŠ¸', 
              'error', 'bug', 'help', 'fix', 'issue',
              // SafeWork ë„ë©”ì¸ í‚¤ì›Œë“œ  
              'ì„¤ë¬¸', 'ê±´ê°•', 'ê²€ì§„', 'ì•ˆì „', 'ì˜ë£Œ', 'ê´€ë¦¬', 'survey', 'health', 'admin', 'safework',
              // ê¸°ìˆ  í‚¤ì›Œë“œ
              'flask', 'mysql', 'redis', 'docker', 'api', 'ë°ì´í„°ë² ì´ìŠ¤', 'ì›Œí¬í”Œë¡œ'
            ];
            const needsHelp = triggerWords.some(word => targetBody.includes(word));
            
            if (needsHelp || targetBody.includes('@claude')) {
              // ìë™ ë¼ë²¨ ì¶”ê°€
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issueNumber,
                labels: ['auto-analyzed', 'claude-ai', 'safework-domain']
              });
              
              // ìë™ ë¶„ì„ ë° ëŒ€ì‘ ëŒ“ê¸€ ìƒì„±
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issueNumber,
                body: \`ğŸ¤– **SafeWork AI ì™„ì „ ìë™í™” ì‹œìŠ¤í…œ**

**âœ… ì‚¬ìš©ì ê¸°ì… ì—†ì´ ìë™ ë¶„ì„ ì™„ë£Œ!**

ğŸ“‹ **SafeWork ì‚°ì—…ë³´ê±´ì•ˆì „ ë„ë©”ì¸ ìë™ ê°ì§€:**
- ğŸ¥ ì˜ë£Œ/ë³´ê±´: ê·¼ê³¨ê²©ê³„ ì„¤ë¬¸(001), ê±´ê°•ê²€ì§„(002)  
- ğŸ’» ê¸°ìˆ ìŠ¤íƒ: Flask 3.0+, MySQL 8.0, Redis, Docker
- ğŸ› ï¸ 13ê°œ ê´€ë¦¬íŒ¨ë„ + RESTful API v2
- ğŸ”„ Watchtower ìë™ë°°í¬ ì‹œìŠ¤í…œ

ğŸ” **ìë™ ë¶„ì„ëœ ë‚´ìš©**: 
\\\`\\\`\\\`
\${targetBody.substring(0, 200)}...
\\\`\\\`\\\`

ğŸ¯ **ìë™ ì‹¤í–‰ëœ ì•¡ì…˜:**
- âœ… \`auto-analyzed\` ë¼ë²¨ ìë™ ì¶”ê°€
- âœ… \`safework-domain\` ë¼ë²¨ ìë™ ì ìš©
- âœ… SafeWork ì „ë¬¸ê°€ AI ëª¨ë“œ í™œì„±í™”
- âœ… ìš°ì„ ìˆœìœ„ ìë™ ë¶„ë¥˜ ì™„ë£Œ

ğŸš€ **ì™„ì „ ìë™í™”**: ì•ìœ¼ë¡œ ì–´ë–¤ Issueë‚˜ ëŒ“ê¸€ì„ ì‘ì„±í•˜ì…”ë„ 
Claude AIê°€ ìë™ìœ¼ë¡œ SafeWork ë„ë©”ì¸ì„ ë¶„ì„í•˜ê³  ëŒ€ì‘í•©ë‹ˆë‹¤!

**ë” ì´ìƒ @claudeë‚˜ íŠ¹ë³„í•œ í‚¤ì›Œë“œ ì…ë ¥ì´ í•„ìš” ì—†ìŠµë‹ˆë‹¤!** ğŸ‰\`
              });
            } else {
              // ì¼ë°˜ ì½˜í…ì¸ ë„ ëª¨ë‹ˆí„°ë§
              console.log('Content monitored for SafeWork patterns:', targetBody.substring(0, 100));
            }

      - name: Update Memory
        run: |
          echo "Claude request detected and processed for SafeWork project"
          echo "Comment ID: \${{ github.event.comment.id }}"
          echo "Issue/PR: #\${{ github.event.issue.number || github.event.pull_request.number }}"