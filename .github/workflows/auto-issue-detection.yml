name: ì´ìŠˆ ìë™ ê°ì§€ ë° ì²˜ë¦¬

on:
  push:
    branches: [master, main]
  schedule:
    # ë§¤ 30ë¶„ë§ˆë‹¤ ì—´ë¦° ì´ìŠˆ í™•ì¸ ë° Claude ìë™ í• ë‹¹
    - cron: '*/30 * * * *'  # 30ë¶„ë§ˆë‹¤ ì‹¤í–‰
  workflow_dispatch:

env:
  TZ: Asia/Seoul

jobs:
  # 1ë‹¨ê³„: ì˜¤í”ˆ ì´ìŠˆ ìë™ ê°ì§€ ë° Claude í• ë‹¹
  detect-open-issues:
    runs-on: ubuntu-latest
    permissions:
      issues: write
      contents: read
      actions: write
    outputs:
      issues-assigned: ${{ steps.assign.outputs.issues-assigned }}
      issue-count: ${{ steps.assign.outputs.issue-count }}
    
    steps:
      - name: ğŸ” ì—´ë¦° ì´ìŠˆ ìŠ¤ìº” ë° Claude ìë™ í• ë‹¹
        id: assign
        uses: actions/github-script@v7
        with:
          script: |
            const { owner, repo } = context.repo;
            let assignedCount = 0;
            
            console.log('ğŸ” ì—´ë¦° ì´ìŠˆ ê²€ìƒ‰ ì¤‘...');
            
            // ì—´ë¦° ì´ìŠˆ ì¤‘ Claudeê°€ í• ë‹¹ë˜ì§€ ì•Šì€ ì´ìŠˆ ê²€ìƒ‰
            const openIssues = await github.rest.issues.listForRepo({
              owner,
              repo,
              state: 'open',
              per_page: 50,
              sort: 'created',
              direction: 'desc'
            });
            
            console.log(`ğŸ“‹ ì´ ${openIssues.data.length}ê°œì˜ ì—´ë¦° ì´ìŠˆ ë°œê²¬`);
            
            for (const issue of openIssues.data) {
              // PRì€ ì œì™¸
              if (issue.pull_request) continue;
              
              // ì´ë¯¸ Claudeê°€ ëŒ“ê¸€ì„ ë‹¨ ì´ìŠˆëŠ” ì œì™¸
              const comments = await github.rest.issues.listComments({
                owner,
                repo,
                issue_number: issue.number
              });
              
              const hasClaudeComment = comments.data.some(comment => 
                comment.user.login === 'claude[bot]' || 
                comment.body.includes('ğŸ¤– **Claude ì‘ì—… ì‹œì‘!**') ||
                comment.body.includes('@claude')
              );
              
              if (hasClaudeComment) {
                console.log(`â­ï¸ ì´ìŠˆ #${issue.number}: ì´ë¯¸ Claudeê°€ ì²˜ë¦¬ ì¤‘`);
                continue;
              }
              
              // 24ì‹œê°„ ì´ë‚´ì— ìƒì„±ëœ ì´ìŠˆë§Œ ìë™ í• ë‹¹
              const issueAge = Date.now() - new Date(issue.created_at).getTime();
              const hoursOld = issueAge / (1000 * 60 * 60);
              
              if (hoursOld > 24) {
                console.log(`â­ï¸ ì´ìŠˆ #${issue.number}: 24ì‹œê°„ ê²½ê³¼ (${Math.round(hoursOld)}ì‹œê°„)`);
                continue;
              }
              
              // Claude ìë™ í• ë‹¹ ëŒ“ê¸€ ì¶”ê°€
              try {
                await github.rest.issues.createComment({
                  owner,
                  repo,
                  issue_number: issue.number,
                  body: `ğŸ¤– **Claude ìë™ í• ë‹¹**
                  
ğŸ“‹ **ìë™ ê°ì§€ëœ ì´ìŠˆ**
- **ì´ìŠˆ**: ${issue.title}
- **ìƒì„±ì‹œê°„**: ${new Date(issue.created_at).toLocaleString('ko-KR', { timeZone: 'Asia/Seoul' })}
- **í• ë‹¹ì‹œê°„**: ${new Date().toLocaleString('ko-KR', { timeZone: 'Asia/Seoul' })}

ğŸ¯ **Claude ì‘ì—… ì‹œì‘**
@claude ì´ ì´ìŠˆë¥¼ ë¶„ì„í•˜ê³  í•´ê²°í•´ì£¼ì„¸ìš”.

SafeWork í”„ë¡œì íŠ¸ íŒ¨í„´ì„ ë”°ë¼ ë‹¤ìŒ ë‹¨ê³„ë¡œ ì§„í–‰í•´ì£¼ì„¸ìš”:
1. ì´ìŠˆ ë‚´ìš© ì •í™•í•œ ë¶„ì„
2. ê´€ë ¨ íŒŒì¼ ì‹ë³„ ë° í˜„ì¬ ìƒíƒœ í™•ì¸
3. ì ì ˆí•œ í•´ê²°ë°©ì•ˆ êµ¬í˜„
4. í…ŒìŠ¤íŠ¸ ì‹¤í–‰ ë° ê²€ì¦
5. ì»¤ë°‹ ë° ì´ìŠˆ ì™„ë£Œ

---
_ğŸ•’ ìë™ í• ë‹¹ ì‹œìŠ¤í…œì— ì˜í•´ ìƒì„±ë¨_`
                });
                
                assignedCount++;
                console.log(`âœ… ì´ìŠˆ #${issue.number} Claude ìë™ í• ë‹¹ ì™„ë£Œ: "${issue.title}"`);
                
                // ë„ˆë¬´ ë§ì€ ìš”ì²­ì„ ë°©ì§€í•˜ê¸° ìœ„í•´ ì ì‹œ ëŒ€ê¸°
                await new Promise(resolve => setTimeout(resolve, 2000));
                
              } catch (error) {
                console.error(`âŒ ì´ìŠˆ #${issue.number} í• ë‹¹ ì‹¤íŒ¨:`, error.message);
              }
            }
            
            console.log(`ğŸ¯ ì´ ${assignedCount}ê°œ ì´ìŠˆì— Claude ìë™ í• ë‹¹ ì™„ë£Œ`);
            
            // ì¶œë ¥ ì„¤ì •
            core.setOutput('issues-assigned', assignedCount > 0 ? 'true' : 'false');
            core.setOutput('issue-count', assignedCount);

  # 2ë‹¨ê³„: ê²°ê³¼ ì•Œë¦¼
  notify-completion:
    needs: detect-open-issues
    if: always()
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“Š ìë™ í• ë‹¹ ê²°ê³¼ ì•Œë¦¼
        run: |
          echo "ğŸ¯ ì—´ë¦° ì´ìŠˆ ìë™ Claude í• ë‹¹ ì™„ë£Œ!"
          echo ""
          echo "ğŸ“‹ ê²°ê³¼ ìš”ì•½:"
          echo "  - ì´ìŠˆ í• ë‹¹ ì—¬ë¶€: ${{ needs.detect-open-issues.outputs.issues-assigned }}"
          echo "  - í• ë‹¹ëœ ì´ìŠˆ ìˆ˜: ${{ needs.detect-open-issues.outputs.issue-count }}"
          echo ""
          if [ "${{ needs.detect-open-issues.outputs.issues-assigned }}" = "true" ]; then
            echo "ğŸ¤– ${{ needs.detect-open-issues.outputs.issue-count }}ê°œ ì´ìŠˆì— Claudeê°€ ìë™ í• ë‹¹ë˜ì—ˆìŠµë‹ˆë‹¤."
            echo "ì‹¤ì‹œê°„ ì§„í–‰ìƒí™©ì€ ê° ì´ìŠˆ í˜ì´ì§€ì—ì„œ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤."
          else
            echo "âœ… ìƒˆë¡œ í• ë‹¹í•  ì´ìŠˆê°€ ì—†ìŠµë‹ˆë‹¤. ëª¨ë“  ì´ìŠˆê°€ ì²˜ë¦¬ ì¤‘ì´ê±°ë‚˜ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤."
          fi