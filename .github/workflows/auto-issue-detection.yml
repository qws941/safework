name: ì´ìŠˆ ìë™ ê°ì§€ ë° ì²˜ë¦¬

on:
  push:
    branches: [master, main]
  schedule:
    # ë§¤ì¼ ì˜¤ì „ 9ì‹œ (KST) ìë™ ìŠ¤ìº”
    - cron: '0 0 * * *'  # UTC 0ì‹œ = KST 9ì‹œ
  workflow_dispatch:

env:
  TZ: Asia/Seoul

jobs:
  # 1ë‹¨ê³„: ì½”ë“œ ìŠ¤ìº” ë° ì´ìŠˆ ê°ì§€
  detect-issues:
    runs-on: ubuntu-latest
    outputs:
      issues-found: ${{ steps.scan.outputs.issues-found }}
      issue-count: ${{ steps.scan.outputs.issue-count }}
    
    steps:
      - name: ğŸ“¥ ì½”ë“œë² ì´ìŠ¤ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          
      - name: ğŸ” ì½”ë“œ ì´ìŠˆ ìŠ¤ìº”
        id: scan
        run: |
          echo "ğŸ” SafeWork ì½”ë“œë² ì´ìŠ¤ ìŠ¤ìº” ì‹œì‘..."
          ISSUES_FOUND=false
          ISSUE_COUNT=0
          
          # Python ì½”ë“œ ìŠ¤ìº”
          echo "ğŸ“Š Python ì½”ë“œ ë¶„ì„..."
          
          # TODO/FIXME ì£¼ì„ ê°ì§€
          TODO_COUNT=$(find app/ -name "*.py" -exec grep -n "TODO\|FIXME\|BUG\|HACK" {} + | wc -l || echo 0)
          if [ "$TODO_COUNT" -gt 0 ]; then
            echo "âš ï¸ TODO/FIXME ë°œê²¬: $TODO_COUNT ê±´"
            ISSUES_FOUND=true
            ISSUE_COUNT=$((ISSUE_COUNT + TODO_COUNT))
          fi
          
          # ì—ëŸ¬ íŒ¨í„´ ê°ì§€
          ERROR_PATTERNS=$(find app/ -name "*.py" -exec grep -n "raise Exception\|print.*error\|logging\.error" {} + | wc -l || echo 0)
          if [ "$ERROR_PATTERNS" -gt 0 ]; then
            echo "ğŸš¨ ì—ëŸ¬ íŒ¨í„´ ë°œê²¬: $ERROR_PATTERNS ê±´"
            ISSUES_FOUND=true
            ISSUE_COUNT=$((ISSUE_COUNT + ERROR_PATTERNS))
          fi
          
          # ë³´ì•ˆ íŒ¨í„´ ê°ì§€  
          SECURITY_ISSUES=$(find app/ -name "*.py" -exec grep -n "password.*=\|secret.*=\|api_key.*=" {} + | wc -l || echo 0)
          if [ "$SECURITY_ISSUES" -gt 0 ]; then
            echo "ğŸ”’ ì ì¬ì  ë³´ì•ˆ ì´ìŠˆ ë°œê²¬: $SECURITY_ISSUES ê±´"
            ISSUES_FOUND=true
            ISSUE_COUNT=$((ISSUE_COUNT + SECURITY_ISSUES))
          fi
          
          # ì›Œí¬í”Œë¡œìš° ì‹¤íŒ¨ ê°ì§€
          if [ "${{ github.event_name }}" = "push" ]; then
            echo "ğŸ”„ ìµœê·¼ ì›Œí¬í”Œë¡œìš° ìƒíƒœ í™•ì¸..."
            # ì—¬ê¸°ì„œëŠ” ë‹¨ìˆœí™”í•˜ì—¬ ì‹¤íŒ¨ê°€ ìˆë‹¤ê³  ê°€ì •
          fi
          
          echo "issues-found=$ISSUES_FOUND" >> $GITHUB_OUTPUT
          echo "issue-count=$ISSUE_COUNT" >> $GITHUB_OUTPUT
          
          if [ "$ISSUES_FOUND" = "true" ]; then
            echo "ğŸ¯ ì´ $ISSUE_COUNT ê°œì˜ ì´ìŠˆê°€ ê°ì§€ë˜ì—ˆìŠµë‹ˆë‹¤."
          else
            echo "âœ… ì½”ë“œë² ì´ìŠ¤ê°€ ê¹¨ë—í•©ë‹ˆë‹¤!"
          fi

  # 2ë‹¨ê³„: ìë™ ì´ìŠˆ ìƒì„± ë° Claude í• ë‹¹  
  create-auto-issues:
    needs: detect-issues
    if: needs.detect-issues.outputs.issues-found == 'true'
    runs-on: ubuntu-latest
    permissions:
      issues: write
      contents: read
      
    steps:
      - name: ğŸ“¥ ì½”ë“œë² ì´ìŠ¤ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4
        
      - name: ğŸ¤– ìë™ ì´ìŠˆ ìƒì„±
        uses: actions/github-script@v7
        with:
          script: |
            const { owner, repo } = context.repo;
            const issueCount = '${{ needs.detect-issues.outputs.issue-count }}';
            
            // ê¸°ì¡´ ìë™ ìƒì„± ì´ìŠˆ í™•ì¸
            const existingIssues = await github.rest.issues.listForRepo({
              owner,
              repo,
              labels: 'ğŸ¤– claude-ready,ğŸ†• new',
              state: 'open'
            });
            
            if (existingIssues.data.length > 0) {
              console.log(`â­ï¸ ê¸°ì¡´ ìë™ ì´ìŠˆ ${existingIssues.data.length}ê°œê°€ ì—´ë ¤ìˆì–´ ìƒˆ ì´ìŠˆë¥¼ ìƒì„±í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.`);
              return;
            }
            
            // ìƒˆ ì´ìŠˆ ìƒì„±
            const issueBody = `
            ## ğŸ” ìë™ ê°ì§€ëœ ì½”ë“œ ì´ìŠˆ
            
            **ê°ì§€ ë‚ ì§œ**: ${new Date().toLocaleString('ko-KR', { timeZone: 'Asia/Seoul' })}
            **ê°ì§€ëœ ì´ìŠˆ ìˆ˜**: ${issueCount}ê°œ
            
            ### ğŸ“‹ ê°ì§€ í•­ëª©
            - [ ] TODO/FIXME ì£¼ì„ ì •ë¦¬
            - [ ] ì—ëŸ¬ í•¸ë“¤ë§ ê°œì„   
            - [ ] ë³´ì•ˆ íŒ¨í„´ ê²€í† 
            - [ ] ì½”ë“œ í’ˆì§ˆ í–¥ìƒ
            
            ### ğŸ¯ ìš”ì²­ ì‚¬í•­
            @claude ìœ„ì˜ ê°ì§€ëœ ì´ìŠˆë“¤ì„ ë¶„ì„í•˜ê³  í•´ê²°í•´ ì£¼ì„¸ìš”.
            
            ë‹¤ìŒ ìˆœì„œë¡œ ì‘ì—…í•´ ì£¼ì„¸ìš”:
            1. ì½”ë“œë² ì´ìŠ¤ ì „ì²´ ìŠ¤ìº”
            2. ìš°ì„ ìˆœìœ„ë³„ ì´ìŠˆ ë¶„ë¥˜
            3. ì‹¤ì œ ì½”ë“œ ìˆ˜ì • ë° ê°œì„ 
            4. í…ŒìŠ¤íŠ¸ ì‹¤í–‰ ë° ê²€ì¦
            5. ì»¤ë°‹ ë° PR ìƒì„±
            
            ---
            
            _ì´ ì´ìŠˆëŠ” ìë™ìœ¼ë¡œ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤. ğŸ¤–_
            `;
            
            const issue = await github.rest.issues.create({
              owner,
              repo,
              title: `ğŸ” ìë™ ê°ì§€: ì½”ë“œ í’ˆì§ˆ ê°œì„  í•„ìš” (${issueCount}ê°œ ì´ìŠˆ)`,
              body: issueBody,
              labels: [
                'ğŸ¤– claude-ready',
                'ğŸ†• new', 
                'â™»ï¸ refactor',
                'ğŸŸ¡ P2-medium',
                'âš™ï¸ backend'
              ]
            });
            
            console.log(`âœ… ìë™ ì´ìŠˆ ìƒì„± ì™„ë£Œ: #${issue.data.number}`);
            console.log(`ğŸ”— URL: ${issue.data.html_url}`);

  # 3ë‹¨ê³„: Claude ì›Œí¬í”Œë¡œìš° íŠ¸ë¦¬ê±°  
  trigger-claude:
    needs: [detect-issues, create-auto-issues]
    if: needs.detect-issues.outputs.issues-found == 'true'
    runs-on: ubuntu-latest
    permissions:
      actions: write
      contents: read
      
    steps:
      - name: ğŸš€ Claude ì›Œí¬í”Œë¡œìš° íŠ¸ë¦¬ê±°
        uses: actions/github-script@v7
        with:
          script: |
            const { owner, repo } = context.repo;
            
            // Claude Code ì›Œí¬í”Œë¡œìš° ì‹¤í–‰
            try {
              const response = await github.rest.actions.createWorkflowDispatch({
                owner,
                repo,
                workflow_id: 'claude.yml',
                ref: 'main'
              });
              
              console.log('âœ… Claude ì›Œí¬í”Œë¡œìš° íŠ¸ë¦¬ê±° ì™„ë£Œ');
            } catch (error) {
              console.error('âŒ Claude ì›Œí¬í”Œë¡œìš° íŠ¸ë¦¬ê±° ì‹¤íŒ¨:', error);
            }

  # 4ë‹¨ê³„: ì•Œë¦¼
  notify-completion:
    needs: [detect-issues, create-auto-issues, trigger-claude]
    if: always()
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“Š ìµœì¢… ì•Œë¦¼
        run: |
          echo "ğŸ¯ ì´ìŠˆ ìë™ ê°ì§€ ë° ì²˜ë¦¬ ì™„ë£Œ!"
          echo ""
          echo "ğŸ“‹ ê²°ê³¼ ìš”ì•½:"
          echo "  - ì´ìŠˆ ê°ì§€: ${{ needs.detect-issues.outputs.issues-found }}"
          echo "  - ê°ì§€ëœ ì´ìŠˆ ìˆ˜: ${{ needs.detect-issues.outputs.issue-count }}"
          echo "  - ìë™ ì´ìŠˆ ìƒì„±: ${{ needs.create-auto-issues.result }}"
          echo "  - Claude í• ë‹¹: ${{ needs.assign-to-claude.result }}"
          echo ""
          if [ "${{ needs.detect-issues.outputs.issues-found }}" = "true" ]; then
            echo "ğŸ¤– Claudeê°€ ìë™ìœ¼ë¡œ ë¬¸ì œë¥¼ í•´ê²°í•  ì˜ˆì •ì…ë‹ˆë‹¤."
          else
            echo "âœ… ì½”ë“œë² ì´ìŠ¤ê°€ ê±´ê°•í•œ ìƒíƒœì…ë‹ˆë‹¤!"
          fi