name: ì´ìŠˆ ìë™ ê°ì§€ ë° ì²˜ë¦¬

on:
  push:
    branches: [master, main]
  schedule:
    # ë§¤ 30ë¶„ë§ˆë‹¤ ì—´ë¦° ì´ìŠˆ í™•ì¸ ë° Claude ìë™ í• ë‹¹
    - cron: '*/30 * * * *'  # 30ë¶„ë§ˆë‹¤ ì‹¤í–‰
  workflow_dispatch:

env:
  TZ: Asia/Seoul

jobs:
  # 1ë‹¨ê³„: ì˜¤í”ˆ ì´ìŠˆ ìë™ ê°ì§€ ë° Claude í• ë‹¹
  detect-open-issues:
    runs-on: ubuntu-latest
    permissions:
      issues: write
      contents: read
      actions: write
    outputs:
      issues-assigned: ${{ steps.assign.outputs.issues-assigned }}
      issue-count: ${{ steps.assign.outputs.issue-count }}
    
    steps:
      - name: ğŸ” ì—´ë¦° ì´ìŠˆ ìŠ¤ìº” ë° Claude ìë™ í• ë‹¹
        id: assign
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "ğŸ” ì—´ë¦° ì´ìŠˆ ìë™ Claude í• ë‹¹ ì‹œì‘..."
          
          # ì„ì‹œ íŒŒì¼ë¡œ ì¹´ìš´í„° ê´€ë¦¬
          echo "0" > /tmp/assigned_count
          echo "false" > /tmp/issues_assigned
          
          # ì—´ë¦° ì´ìŠˆ ëª©ë¡ ê°€ì ¸ì˜¤ê¸°
          ISSUE_COUNT=$(gh issue list --state open --limit 50 --json number | jq length)
          
          if [ "$ISSUE_COUNT" -eq 0 ]; then
            echo "ğŸ“‹ ì—´ë¦° ì´ìŠˆê°€ ì—†ìŠµë‹ˆë‹¤."
          else
            echo "ğŸ“‹ $ISSUE_COUNT ê°œì˜ ì—´ë¦° ì´ìŠˆ ë°œê²¬"
            
            # ê° ì´ìŠˆ ë²ˆí˜¸ ê°€ì ¸ì™€ì„œ ì²˜ë¦¬
            gh issue list --state open --limit 10 --json number,title,createdAt | jq -r '.[] | [.number, .title, .createdAt] | @tsv' | while IFS=$'\t' read -r number title created_at; do
              echo "ğŸ” ì´ìŠˆ #$number ê²€í† : $title"
              
              # ì´ìŠˆ ìƒì„± ì‹œê°„ í™•ì¸ (24ì‹œê°„ ì´ë‚´)
              created_timestamp=$(date -d "$created_at" +%s 2>/dev/null || date -d "$(echo "$created_at" | cut -c1-19)" +%s)
              current_timestamp=$(date +%s)
              hours_old=$(( (current_timestamp - created_timestamp) / 3600 ))
              
              if [ "$hours_old" -gt 24 ]; then
                echo "â­ï¸ ì´ìŠˆ #$number: 24ì‹œê°„ ê²½ê³¼ ($hours_old ì‹œê°„)"
                continue
              fi
              
              # Claude ëŒ“ê¸€ í™•ì¸
              claude_mentions=$(gh issue view $number | grep -c "@claude\|Claude ì‘ì—… ì‹œì‘\|claude\[bot\]" || echo "0")
              
              if [ "$claude_mentions" -gt 0 ]; then
                echo "â­ï¸ ì´ìŠˆ #$number: ì´ë¯¸ Claudeê°€ ì²˜ë¦¬ ì¤‘"
                continue
              fi
              
              # Claude ìë™ í• ë‹¹ ëŒ“ê¸€ ì¶”ê°€
              echo "âœ… ì´ìŠˆ #$number Claude ìë™ í• ë‹¹ ì¤‘..."
              
              gh issue comment $number --body "ğŸ¤– **Claude ìë™ í• ë‹¹**

ğŸ“‹ **ìë™ ê°ì§€ëœ ì´ìŠˆ**  
- **ì´ìŠˆ**: $title
- **ìƒì„±ì‹œê°„**: $(date -d "$created_at" '+%Y-%m-%d %H:%M:%S KST' 2>/dev/null || echo "$created_at")
- **í• ë‹¹ì‹œê°„**: $(date '+%Y-%m-%d %H:%M:%S KST')

ğŸ¯ **Claude ì‘ì—… ì‹œì‘**
@claude ì´ ì´ìŠˆë¥¼ ë¶„ì„í•˜ê³  í•´ê²°í•´ì£¼ì„¸ìš”.

SafeWork í”„ë¡œì íŠ¸ íŒ¨í„´ì„ ë”°ë¼ ë‹¤ìŒ ë‹¨ê³„ë¡œ ì§„í–‰í•´ì£¼ì„¸ìš”:
1. ì´ìŠˆ ë‚´ìš© ì •í™•í•œ ë¶„ì„
2. ê´€ë ¨ íŒŒì¼ ì‹ë³„ ë° í˜„ì¬ ìƒíƒœ í™•ì¸
3. ì ì ˆí•œ í•´ê²°ë°©ì•ˆ êµ¬í˜„  
4. í…ŒìŠ¤íŠ¸ ì‹¤í–‰ ë° ê²€ì¦
5. ì»¤ë°‹ ë° ì´ìŠˆ ì™„ë£Œ

---
_ğŸ•’ ìë™ í• ë‹¹ ì‹œìŠ¤í…œì— ì˜í•´ ìƒì„±ë¨_"
              
              # ì¹´ìš´í„° ì—…ë°ì´íŠ¸
              current_count=$(cat /tmp/assigned_count)
              echo $((current_count + 1)) > /tmp/assigned_count
              echo "true" > /tmp/issues_assigned
              
              echo "âœ… ì´ìŠˆ #$number Claude ìë™ í• ë‹¹ ì™„ë£Œ"
              
              # API ì œí•œì„ ìœ„í•œ ëŒ€ê¸°
              sleep 3
              
            done
          fi
          
          # ìµœì¢… ê²°ê³¼ ì½ê¸°
          ASSIGNED_COUNT=$(cat /tmp/assigned_count)
          ISSUES_ASSIGNED=$(cat /tmp/issues_assigned)
          
          echo "ğŸ¯ ì´ $ASSIGNED_COUNT ê°œ ì´ìŠˆì— Claude ìë™ í• ë‹¹ ì™„ë£Œ"
          
          # ì¶œë ¥ ì„¤ì •
          echo "issues-assigned=$ISSUES_ASSIGNED" >> $GITHUB_OUTPUT
          echo "issue-count=$ASSIGNED_COUNT" >> $GITHUB_OUTPUT

  # 2ë‹¨ê³„: ê²°ê³¼ ì•Œë¦¼
  notify-completion:
    needs: detect-open-issues
    if: always()
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“Š ìë™ í• ë‹¹ ê²°ê³¼ ì•Œë¦¼
        run: |
          echo "ğŸ¯ ì—´ë¦° ì´ìŠˆ ìë™ Claude í• ë‹¹ ì™„ë£Œ!"
          echo ""
          echo "ğŸ“‹ ê²°ê³¼ ìš”ì•½:"
          echo "  - ì´ìŠˆ í• ë‹¹ ì—¬ë¶€: ${{ needs.detect-open-issues.outputs.issues-assigned }}"
          echo "  - í• ë‹¹ëœ ì´ìŠˆ ìˆ˜: ${{ needs.detect-open-issues.outputs.issue-count }}"
          echo ""
          if [ "${{ needs.detect-open-issues.outputs.issues-assigned }}" = "true" ]; then
            echo "ğŸ¤– ${{ needs.detect-open-issues.outputs.issue-count }}ê°œ ì´ìŠˆì— Claudeê°€ ìë™ í• ë‹¹ë˜ì—ˆìŠµë‹ˆë‹¤."
            echo "ì‹¤ì‹œê°„ ì§„í–‰ìƒí™©ì€ ê° ì´ìŠˆ í˜ì´ì§€ì—ì„œ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤."
          else
            echo "âœ… ìƒˆë¡œ í• ë‹¹í•  ì´ìŠˆê°€ ì—†ìŠµë‹ˆë‹¤. ëª¨ë“  ì´ìŠˆê°€ ì²˜ë¦¬ ì¤‘ì´ê±°ë‚˜ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤."
          fi