name: Multi-Stage Deployment Pipeline

on:
  push:
    branches: [ main, staging, develop ]
    tags: [ 'v*' ]
  workflow_dispatch:
    inputs:
      environment:
        description: 'ë°°í¬ í™˜ê²½ ì„ íƒ'
        required: true
        default: 'staging'
        type: choice
        options:
        - staging
        - production
      skip_tests:
        description: 'í…ŒìŠ¤íŠ¸ ê±´ë„ˆë›°ê¸° (ê¸´ê¸‰ ë°°í¬)'
        required: false
        default: false
        type: boolean

env:
  REGISTRY: ${{ secrets.REGISTRY_URL || 'registry.jclee.me' }}
  PROJECT: safework

jobs:
  # Stage 1: ì¤€ë¹„ ë‹¨ê³„
  prepare:
    name: Deployment Preparation
    runs-on: ubuntu-latest
    outputs:
      environment: ${{ steps.determine-env.outputs.environment }}
      version: ${{ steps.version.outputs.version }}
      should-deploy: ${{ steps.determine-env.outputs.should-deploy }}
      
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: Determine deployment environment
      id: determine-env
      run: |
        # í™˜ê²½ ê²°ì • ë¡œì§
        if [[ "${{ github.event.inputs.environment }}" != "" ]]; then
          ENVIRONMENT="${{ github.event.inputs.environment }}"
        elif [[ "${{ github.ref }}" == "refs/heads/main" ]]; then
          ENVIRONMENT="production"
        elif [[ "${{ github.ref }}" == "refs/heads/staging" ]]; then
          ENVIRONMENT="staging"
        elif [[ "${{ github.ref }}" == "refs/heads/develop" ]]; then
          ENVIRONMENT="development"
        elif [[ "${{ github.ref }}" == refs/tags/* ]]; then
          ENVIRONMENT="production"
        else
          ENVIRONMENT="development"
        fi
        
        echo "environment=$ENVIRONMENT" >> $GITHUB_OUTPUT
        
        # ë°°í¬ ì—¬ë¶€ ê²°ì •
        SHOULD_DEPLOY="true"
        if [[ "$ENVIRONMENT" == "production" && "${{ github.actor }}" != "admin" ]]; then
          # í”„ë¡œë•ì…˜ ë°°í¬ ê¶Œí•œ ì²´í¬ (í•„ìš”ì‹œ)
          echo "should-deploy=false" >> $GITHUB_OUTPUT
          echo "âš ï¸ Production deployment requires admin approval"
        else
          echo "should-deploy=true" >> $GITHUB_OUTPUT
        fi
        
        echo "ğŸ¯ Deployment Environment: $ENVIRONMENT"
    
    - name: Generate version
      id: version
      run: |
        if [[ "${{ github.ref }}" == refs/tags/* ]]; then
          VERSION=${GITHUB_REF#refs/tags/v}
        else
          VERSION="$(date +%Y%m%d.%H%M)-${GITHUB_SHA::7}"
        fi
        
        ENVIRONMENT="${{ steps.determine-env.outputs.environment }}"
        if [[ "$ENVIRONMENT" != "production" ]]; then
          VERSION="${ENVIRONMENT}-${VERSION}"
        fi
        
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "ğŸ·ï¸ Version: $VERSION"

  # Stage 2: ë¹Œë“œ ë° í…ŒìŠ¤íŠ¸
  build-and-test:
    name: Build and Test
    runs-on: ubuntu-latest
    needs: prepare
    if: needs.prepare.outputs.should-deploy == 'true'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
    
    - name: Log in to Docker Registry
      uses: docker/login-action@v3
      with:
        registry: ${{ env.REGISTRY }}
        username: ${{ secrets.REGISTRY_USER || 'admin' }}
        password: ${{ secrets.REGISTRY_PASSWORD }}
    
    - name: Build Docker images
      run: |
        echo "ğŸ³ Building Docker images for version ${{ needs.prepare.outputs.version }}"
        
        # App image build
        docker buildx build \
          --platform linux/amd64,linux/arm64 \
          --tag ${{ env.REGISTRY }}/${{ env.PROJECT }}/app:${{ needs.prepare.outputs.version }} \
          --tag ${{ env.REGISTRY }}/${{ env.PROJECT }}/app:latest-${{ needs.prepare.outputs.environment }} \
          --push \
          ./app
        
        # MySQL image build
        docker buildx build \
          --platform linux/amd64,linux/arm64 \
          --tag ${{ env.REGISTRY }}/${{ env.PROJECT }}/mysql:${{ needs.prepare.outputs.version }} \
          --tag ${{ env.REGISTRY }}/${{ env.PROJECT }}/mysql:latest-${{ needs.prepare.outputs.environment }} \
          --push \
          ./mysql
        
        # Redis image build
        docker buildx build \
          --platform linux/amd64,linux/arm64 \
          --tag ${{ env.REGISTRY }}/${{ env.PROJECT }}/redis:${{ needs.prepare.outputs.version }} \
          --tag ${{ env.REGISTRY }}/${{ env.PROJECT }}/redis:latest-${{ needs.prepare.outputs.environment }} \
          --push \
          ./redis
    
    - name: Run integration tests
      if: ${{ !github.event.inputs.skip_tests }}
      run: |
        echo "ğŸ§ª Running integration tests..."
        
        # í…ŒìŠ¤íŠ¸ìš© Docker Compose ì„¤ì •
        export TEST_VERSION="${{ needs.prepare.outputs.version }}"
        export TEST_REGISTRY="${{ env.REGISTRY }}"
        
        # ì„ì‹œ í…ŒìŠ¤íŠ¸ í™˜ê²½ ì‹œì‘
        docker-compose -f docker-compose.test.yml up -d --wait
        
        # í—¬ìŠ¤ì²´í¬ ëŒ€ê¸°
        for i in {1..30}; do
          if curl -f http://localhost:4545/health; then
            echo "âœ… Application is healthy"
            break
          fi
          echo "Waiting for application... ($i/30)"
          sleep 10
        done
        
        # ê¸°ë³¸ ê¸°ëŠ¥ í…ŒìŠ¤íŠ¸
        curl -f http://localhost:4545/ || exit 1
        curl -f http://localhost:4545/survey/new || exit 1
        
        # ì •ë¦¬
        docker-compose -f docker-compose.test.yml down
    
    - name: Security scan on built images
      continue-on-error: true
      run: |
        echo "ğŸ”’ Scanning built images for vulnerabilities..."
        
        # Trivyë¡œ ë¹Œë“œëœ ì´ë¯¸ì§€ ìŠ¤ìº”
        docker run --rm -v /var/run/docker.sock:/var/run/docker.sock \
          aquasec/trivy:latest image --exit-code 0 --severity HIGH,CRITICAL \
          ${{ env.REGISTRY }}/${{ env.PROJECT }}/app:${{ needs.prepare.outputs.version }}

  # Stage 3: ìŠ¤í…Œì´ì§• ë°°í¬
  deploy-staging:
    name: Deploy to Staging
    runs-on: ubuntu-latest
    needs: [prepare, build-and-test]
    if: needs.prepare.outputs.environment != 'production' && needs.prepare.outputs.should-deploy == 'true'
    environment:
      name: staging
      url: https://staging.safework.jclee.me
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Deploy to staging
      run: |
        echo "ğŸš€ Deploying to staging environment..."
        echo "Version: ${{ needs.prepare.outputs.version }}"
        echo "Environment: ${{ needs.prepare.outputs.environment }}"
        
        # ìŠ¤í…Œì´ì§• ë°°í¬ ë¡œì§ (ì‹¤ì œ í™˜ê²½ì— ë§ê²Œ ìˆ˜ì •)
        echo "âœ… Staging deployment completed"
    
    - name: Run smoke tests
      run: |
        echo "ğŸ’¨ Running smoke tests on staging..."
        
        # ê¸°ë³¸ smoke test
        curl -f https://staging.safework.jclee.me/health || exit 1
        echo "âœ… Smoke tests passed"
    
    - name: Notify staging deployment
      run: |
        echo "ğŸ“¢ Staging deployment notification"
        echo "ğŸ¯ Environment: Staging"
        echo "ğŸ·ï¸ Version: ${{ needs.prepare.outputs.version }}"
        echo "ğŸ”— URL: https://staging.safework.jclee.me"

  # Stage 4: í”„ë¡œë•ì…˜ ìŠ¹ì¸ ëŒ€ê¸°
  production-approval:
    name: Production Deployment Approval
    runs-on: ubuntu-latest
    needs: [prepare, build-and-test, deploy-staging]
    if: needs.prepare.outputs.environment == 'production' && needs.prepare.outputs.should-deploy == 'true'
    environment:
      name: production-approval
    
    steps:
    - name: Manual approval checkpoint
      run: |
        echo "â³ Waiting for manual approval for production deployment"
        echo "ğŸ·ï¸ Version: ${{ needs.prepare.outputs.version }}"
        echo "ğŸ“‹ Deployment checklist:"
        echo "- [ ] Staging tests passed"
        echo "- [ ] Security scans completed"
        echo "- [ ] Database migrations reviewed"
        echo "- [ ] Rollback plan confirmed"

  # Stage 5: í”„ë¡œë•ì…˜ ë°°í¬
  deploy-production:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: [prepare, build-and-test, production-approval]
    if: needs.prepare.outputs.environment == 'production' && needs.prepare.outputs.should-deploy == 'true'
    environment:
      name: production
      url: https://safework.jclee.me
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Pre-deployment backup
      run: |
        echo "ğŸ’¾ Creating pre-deployment backup..."
        # ë°±ì—… ë¡œì§ (ì‹¤ì œ í™˜ê²½ì— ë§ê²Œ êµ¬í˜„)
        echo "âœ… Backup completed"
    
    - name: Deploy to production
      run: |
        echo "ğŸš€ Deploying to production environment..."
        echo "Version: ${{ needs.prepare.outputs.version }}"
        
        # í”„ë¡œë•ì…˜ ë°°í¬ ë¡œì§
        # - Blue-Green ë°°í¬
        # - ì ì§„ì  ë¡¤ì•„ì›ƒ
        # - íŠ¸ë˜í”½ ì „í™˜
        
        echo "âœ… Production deployment completed"
    
    - name: Post-deployment verification
      run: |
        echo "âœ… Running post-deployment verification..."
        
        # í”„ë¡œë•ì…˜ ê²€ì¦
        curl -f https://safework.jclee.me/health || exit 1
        
        # ì£¼ìš” ê¸°ëŠ¥ ê²€ì¦
        curl -f https://safework.jclee.me/ || exit 1
        curl -f https://safework.jclee.me/survey/new || exit 1
        
        echo "âœ… Production verification passed"
    
    - name: Create release
      if: startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v1
      with:
        tag_name: v${{ needs.prepare.outputs.version }}
        name: SafeWork v${{ needs.prepare.outputs.version }}
        body: |
          ## ğŸ‰ SafeWork v${{ needs.prepare.outputs.version }} í”„ë¡œë•ì…˜ ë°°í¬
          
          **ë°°í¬ ì •ë³´:**
          - ğŸ·ï¸ ë²„ì „: ${{ needs.prepare.outputs.version }}
          - ğŸŒ í™˜ê²½: Production
          - ğŸ“… ë°°í¬ì¼: ${{ github.event.head_commit.timestamp }}
          - ğŸ‘¤ ë°°í¬ì: ${{ github.actor }}
          
          **Docker ì´ë¯¸ì§€:**
          - App: `${{ env.REGISTRY }}/${{ env.PROJECT }}/app:${{ needs.prepare.outputs.version }}`
          - MySQL: `${{ env.REGISTRY }}/${{ env.PROJECT }}/mysql:${{ needs.prepare.outputs.version }}`
          - Redis: `${{ env.REGISTRY }}/${{ env.PROJECT }}/redis:${{ needs.prepare.outputs.version }}`
          
          **ì ‘ì† ì •ë³´:**
          - ğŸŒ ì›¹ì‚¬ì´íŠ¸: https://safework.jclee.me
          - ğŸ‘¤ ê´€ë¦¬ì: admin / safework2024
        draft: false
        prerelease: false

  # Stage 6: ë°°í¬ í›„ ëª¨ë‹ˆí„°ë§
  post-deployment:
    name: Post-Deployment Monitoring
    runs-on: ubuntu-latest
    needs: [prepare, deploy-staging, deploy-production]
    if: always() && (needs.deploy-staging.result == 'success' || needs.deploy-production.result == 'success')
    
    steps:
    - name: Setup monitoring
      run: |
        echo "ğŸ“Š Setting up post-deployment monitoring..."
        
        ENVIRONMENT="${{ needs.prepare.outputs.environment }}"
        VERSION="${{ needs.prepare.outputs.version }}"
        
        if [[ "$ENVIRONMENT" == "production" ]]; then
          MONITOR_URL="https://safework.jclee.me"
        else
          MONITOR_URL="https://staging.safework.jclee.me"
        fi
        
        echo "ğŸ” Monitoring URL: $MONITOR_URL"
        echo "ğŸ“ˆ Setting up alerts for version: $VERSION"
    
    - name: Health monitoring
      run: |
        echo "ğŸ¥ Running extended health monitoring..."
        
        # 5ë¶„ê°„ í—¬ìŠ¤ì²´í¬ ëª¨ë‹ˆí„°ë§
        for i in {1..10}; do
          if curl -f $MONITOR_URL/health; then
            echo "âœ… Health check $i/10 passed"
          else
            echo "âŒ Health check $i/10 failed"
            exit 1
          fi
          sleep 30
        done
        
        echo "âœ… Extended health monitoring completed"
    
    - name: Performance baseline
      run: |
        echo "âš¡ Establishing performance baseline..."
        
        # ê¸°ë³¸ ì„±ëŠ¥ ì¸¡ì •
        RESPONSE_TIME=$(curl -o /dev/null -s -w '%{time_total}' $MONITOR_URL/)
        
        echo "ğŸ“Š Homepage response time: ${RESPONSE_TIME}s"
        
        if (( $(echo "$RESPONSE_TIME > 2.0" | bc -l) )); then
          echo "âš ï¸ Performance warning: Response time > 2s"
        else
          echo "âœ… Performance baseline established"
        fi

  # Stage 7: ì•Œë¦¼ ë° ì •ë¦¬
  notify-completion:
    name: Deployment Notification
    runs-on: ubuntu-latest
    needs: [prepare, build-and-test, deploy-staging, deploy-production, post-deployment]
    if: always()
    
    steps:
    - name: Deployment summary
      run: |
        echo "## ğŸš€ Deployment Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**í™˜ê²½**: ${{ needs.prepare.outputs.environment }}" >> $GITHUB_STEP_SUMMARY
        echo "**ë²„ì „**: ${{ needs.prepare.outputs.version }}" >> $GITHUB_STEP_SUMMARY
        echo "**ë¸Œëœì¹˜**: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
        echo "**ë°°í¬ì**: ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        echo "### ğŸ“Š Stage Results" >> $GITHUB_STEP_SUMMARY
        echo "- **Build & Test**: ${{ needs.build-and-test.result }}" >> $GITHUB_STEP_SUMMARY
        
        if [[ "${{ needs.deploy-staging.result }}" != "skipped" ]]; then
          echo "- **Staging Deploy**: ${{ needs.deploy-staging.result }}" >> $GITHUB_STEP_SUMMARY
        fi
        
        if [[ "${{ needs.deploy-production.result }}" != "skipped" ]]; then
          echo "- **Production Deploy**: ${{ needs.deploy-production.result }}" >> $GITHUB_STEP_SUMMARY
        fi
        
        echo "- **Post-Deployment**: ${{ needs.post-deployment.result }}" >> $GITHUB_STEP_SUMMARY
    
    - name: Success notification
      if: contains(needs.*.result, 'success') && !contains(needs.*.result, 'failure')
      run: |
        echo "ğŸ‰ ë°°í¬ê°€ ì„±ê³µì ìœ¼ë¡œ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!"
        echo "í™˜ê²½: ${{ needs.prepare.outputs.environment }}"
        echo "ë²„ì „: ${{ needs.prepare.outputs.version }}"
        
        # Slack/Teams/Discord ì•Œë¦¼ (í™˜ê²½ë³€ìˆ˜ ì„¤ì • ì‹œ)
        if [[ -n "${{ secrets.SLACK_WEBHOOK_URL }}" ]]; then
          curl -X POST -H 'Content-type: application/json' \
            --data "{\"text\":\"âœ… SafeWork ë°°í¬ ì„±ê³µ\\ní™˜ê²½: ${{ needs.prepare.outputs.environment }}\\në²„ì „: ${{ needs.prepare.outputs.version }}\\nì‹œê°„: $(date)\"}" \
            ${{ secrets.SLACK_WEBHOOK_URL }}
        fi
        
        if [[ -n "${{ secrets.DISCORD_WEBHOOK_URL }}" ]]; then
          curl -X POST -H 'Content-type: application/json' \
            --data "{\"content\":\"âœ… **SafeWork ë°°í¬ ì„±ê³µ**\\ní™˜ê²½: ${{ needs.prepare.outputs.environment }}\\në²„ì „: ${{ needs.prepare.outputs.version }}\\nì‹œê°„: $(date)\"}" \
            ${{ secrets.DISCORD_WEBHOOK_URL }}
        fi
    
    - name: Failure notification
      if: contains(needs.*.result, 'failure')
      run: |
        echo "âŒ ë°°í¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤!"
        echo "ì‹¤íŒ¨í•œ ë‹¨ê³„ë¥¼ í™•ì¸í•˜ê³  ë¡¤ë°±ì„ ê²€í† í•˜ì„¸ìš”."
        
        # ì‹¤íŒ¨ ì•Œë¦¼
        if [[ -n "${{ secrets.SLACK_WEBHOOK_URL }}" ]]; then
          curl -X POST -H 'Content-type: application/json' \
            --data "{\"text\":\"ğŸš¨ SafeWork ë°°í¬ ì‹¤íŒ¨\\ní™˜ê²½: ${{ needs.prepare.outputs.environment }}\\në²„ì „: ${{ needs.prepare.outputs.version }}\\nì‹¤í–‰ ID: ${{ github.run_id }}\\nURL: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}\"}" \
            ${{ secrets.SLACK_WEBHOOK_URL }}
        fi
        
        if [[ -n "${{ secrets.DISCORD_WEBHOOK_URL }}" ]]; then
          curl -X POST -H 'Content-type: application/json' \
            --data "{\"content\":\"ğŸš¨ **SafeWork ë°°í¬ ì‹¤íŒ¨**\\ní™˜ê²½: ${{ needs.prepare.outputs.environment }}\\në²„ì „: ${{ needs.prepare.outputs.version }}\\n[ìƒì„¸ ë³´ê¸°](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})\"}" \
            ${{ secrets.DISCORD_WEBHOOK_URL }}
        fi
        
        # ìë™ ë¡¤ë°± íŠ¸ë¦¬ê±° (ì„ íƒì‚¬í•­)
        if [[ "${{ needs.prepare.outputs.environment }}" == "production" ]]; then
          echo "ğŸ”„ í”„ë¡œë•ì…˜ ìë™ ë¡¤ë°±ì„ ê³ ë ¤í•˜ì„¸ìš”."
          
          # GitHub Issue ìë™ ìƒì„±
          curl -X POST \
            -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            -H "Accept: application/vnd.github.v3+json" \
            "${{ github.api_url }}/repos/${{ github.repository }}/issues" \
            -d "{
              \"title\": \"ğŸš¨ Production Deployment Failed - ${{ needs.prepare.outputs.version }}\",
              \"body\": \"## Deployment Failure Report\\n\\n**Environment:** Production\\n**Version:** ${{ needs.prepare.outputs.version }}\\n**Run ID:** ${{ github.run_id }}\\n**Time:** $(date)\\n\\n**Action Required:**\\n- [ ] Investigate failure cause\\n- [ ] Consider rollback to previous version\\n- [ ] Fix identified issues\\n- [ ] Re-deploy after verification\\n\\n[View Failed Run](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})\",
              \"labels\": [\"deployment\", \"production\", \"critical\", \"bug\"]
            }"
        fi