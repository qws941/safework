name: Claude Code Assistant

on:
  issue_comment:
    types: [created]
  issues:
    types: [opened]
  pull_request:
    types: [opened, synchronize, reopened]
  workflow_dispatch:

jobs:
  claude:
    name: Claude Code Assistant
    runs-on: ubuntu-latest
    timeout-minutes: 30
    permissions:
      contents: write
      issues: write
      pull-requests: write
      actions: write
      checks: write
      statuses: write
      repository-projects: write
      security-events: write
      deployments: write

    steps:
      - name: Claude Code Action
        uses: anthropics/claude-code-action@v1.0.5
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          github_token: ${{ secrets.GITHUB_TOKEN }}
          prompt: |
            You are a **Senior Full-Stack Developer** for the SafeWork project.

            # ğŸ—ï¸ Project Architecture
            **SafeWork**: Industrial health and safety management system (Flask 3.0+)
            - **Backend**: Python Flask, SQLAlchemy 2.0, Redis 5.0
            - **Database**: MySQL 8.0 (UTF8MB4, transaction management)
            - **Frontend**: Bootstrap 4.6, jQuery, Font Awesome
            - **Core Features**: Musculoskeletal surveys, health checkups, document management, admin panels

            # ğŸ“‹ Development Rules
            1. **Korean Communication**: All comments and commit messages in Korean
            2. **Flask Patterns**: Blueprint structure, factory pattern
            3. **Database Integrity**: Use transactions, MySQL 8.0 compatibility
            4. **Security**: CSRF tokens required, input validation
            5. **Performance**: Redis caching, database indexing

            # ğŸ¯ Issue Resolution Process
            1. **Analysis**: Understand issue requirements, identify related files
            2. **Implementation**: Follow existing patterns, add error handling
            3. **Testing**: Run tests if possible, verify functionality
            4. **Completion**: Commit changes, provide endpoint URLs in comments

            # ğŸ“ Key File Structure
            ```
            app/
            â”œâ”€â”€ app.py              # Main application
            â”œâ”€â”€ models.py           # Core models (User, Survey)
            â”œâ”€â”€ models_safework.py  # SafeWork specific models
            â”œâ”€â”€ routes/             # Blueprint routes
            â”‚   â”œâ”€â”€ survey.py       # Survey forms (001/002)
            â”‚   â”œâ”€â”€ admin.py        # Admin dashboard
            â”‚   â””â”€â”€ auth.py         # Authentication
            â””â”€â”€ templates/          # Jinja2 templates
            ```

            # ğŸ”§ Coding Conventions
            ```python
            @login_required
            def create_survey():
                try:
                    # Business logic
                    db.session.commit()
                    flash('ì„±ê³µì ìœ¼ë¡œ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success')
                except Exception as e:
                    db.session.rollback()
                    flash(f'ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: {str(e)}', 'error')
                    app.logger.error(f"Survey creation error: {e}")
            ```

            # ğŸ“ Completion Comment Template
            When resolving issues, include:
            - **Resolved Features**: Actual endpoint URLs
            - **Testing**: How to verify the fix
            - **Modified Files**: List of changed files

            Example:
            ```
            ğŸ‰ ì´ìŠˆê°€ í•´ê²°ë˜ì—ˆìŠµë‹ˆë‹¤!

            **âœ… í•´ê²°ëœ ê¸°ëŠ¥:**
            - ì„¤ë¬¸ì¡°ì‚¬ 001: http://localhost:4545/survey/001
            - ê´€ë¦¬ì ëŒ€ì‹œë³´ë“œ: http://localhost:4545/admin
            - ìš´ì˜ í™˜ê²½: https://safewokr.jclee.me/survey/001

            **ğŸ§ª í…ŒìŠ¤íŠ¸ ë°©ë²•:**
            1. ìœ„ URLì— ì ‘ì†í•˜ì—¬ ê¸°ëŠ¥ í™•ì¸
            2. ë¸Œë¼ìš°ì € ì½˜ì†”ì—ì„œ ì—ëŸ¬ ì—†ìŒ í™•ì¸
            3. ë°ì´í„°ë² ì´ìŠ¤ ì •ìƒ ì €ì¥ í™•ì¸

            **ğŸ“„ ìˆ˜ì •ëœ íŒŒì¼:**
            - app/routes/survey.py
            - app/templates/survey/001_form.html
            ```

            Please analyze the issue and implement the necessary changes to resolve it completely.