name: Claude Code - ì´ìŠˆ ìë™ í•´ê²°

on:
  # ì´ìŠˆ ìƒì„±ì‹œ ìë™ ì²˜ë¦¬
  issues:
    types: [opened]
  # @claude ë©˜ì…˜ì‹œ ì¦‰ì‹œ ì²˜ë¦¬  
  issue_comment:
    types: [created]
  # ìˆ˜ë™ ì‹¤í–‰ ê°€ëŠ¥
  workflow_dispatch:
    inputs:
      issue_number:
        description: 'ì²˜ë¦¬í•  ì´ìŠˆ ë²ˆí˜¸'
        required: false
        type: string

permissions:
  contents: write
  issues: write
  pull-requests: write
  actions: write

jobs:
  # ì´ìŠˆ ìë™ ë¼ë²¨ë§ ë° ì²˜ë¦¬
  claude-auto-fix:
    if: |
      (github.event_name == 'issues' && github.event.action == 'opened') ||
      (github.event_name == 'issue_comment' && contains(github.event.comment.body, '@claude')) ||
      (github.event_name == 'workflow_dispatch')
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
      
      - name: ì´ìŠˆ ìë™ ë¶„ë¥˜ (ì‹ ê·œ ì´ìŠˆë§Œ)
        if: github.event_name == 'issues' && github.event.action == 'opened'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const issue = context.payload.issue;
            const content = (issue.title + ' ' + (issue.body || '')).toLowerCase();
            
            // ë¼ë²¨ ê²°ì •
            const labels = [];
            
            if (content.includes('ë²„ê·¸') || content.includes('bug') || content.includes('ì˜¤ë¥˜')) {
              labels.push('bug');
            } else if (content.includes('ê¸°ëŠ¥') || content.includes('feature')) {
              labels.push('enhancement');
            } else {
              labels.push('task');
            }
            
            if (content.includes('ê¸´ê¸‰') || content.includes('urgent')) {
              labels.push('P0-urgent');
            } else {
              labels.push('P2-medium');
            }
            
            labels.push('claude-processing');
            
            // ë¼ë²¨ ì ìš©
            await github.rest.issues.setLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issue.number,
              labels: labels
            });
      
      - name: Claude Code ì´ìŠˆ í•´ê²°
        uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          github_token: ${{ secrets.GITHUB_TOKEN }}
          custom_instructions: |
            # SafeWork í”„ë¡œì íŠ¸ ì´ìŠˆ ìë™ í•´ê²°

            ## ğŸ¯ ëª©í‘œ
            ì´ìŠˆë¥¼ ì™„ì „íˆ í•´ê²°í•˜ê³  ìš´ì˜ í™˜ê²½ì— ë°°í¬ê¹Œì§€ ì™„ë£Œí•˜ê¸°

            ## ğŸ“‹ í•„ìˆ˜ ì²˜ë¦¬ ë‹¨ê³„
            1. **ì´ìŠˆ ë¶„ì„**: ë¬¸ì œì ê³¼ ìš”êµ¬ì‚¬í•­ íŒŒì•…
            2. **ì½”ë“œ ìˆ˜ì •**: ì‹¤ì œ ë¬¸ì œ í•´ê²°ì„ ìœ„í•œ ì½”ë“œ ë³€ê²½
            3. **í…ŒìŠ¤íŠ¸ ì¶”ê°€**: ìˆ˜ì •ì‚¬í•­ì— ëŒ€í•œ í…ŒìŠ¤íŠ¸ ì‘ì„±
            4. **ì»¤ë°‹ & PR**: ë³€ê²½ì‚¬í•­ì„ PRë¡œ ìƒì„±
            5. **ë°°í¬ í™•ì¸**: main ë¸Œëœì¹˜ ë³‘í•© ì‹œ ìë™ ë°°í¬ë¨
            6. **ì´ìŠˆ í´ë¡œì¦ˆ**: ìš´ì˜ í™˜ê²½ ë°˜ì˜ í™•ì¸ í›„ ì´ìŠˆ ì™„ì „ ì¢…ë£Œ

            ## ğŸ›  ê¸°ìˆ  ìŠ¤íƒ
            - **Backend**: Flask 3.0+, SQLAlchemy, MySQL 8.0
            - **Frontend**: Bootstrap 4.6, jQuery, Jinja2
            - **Testing**: pytest, coverage
            - **Style**: PEP 8, Black í¬ë§¤í„°
            - **Deployment**: Docker, GitHub Actions â†’ registry.jclee.me

            ## âœ… ì„±ê³µ ê¸°ì¤€
            - ì‹¤ì œ ì½”ë“œ ë³€ê²½ìœ¼ë¡œ ì´ìŠˆ í•´ê²°
            - í…ŒìŠ¤íŠ¸ í†µê³¼
            - PR ìƒì„± ì™„ë£Œ
            - ìš´ì˜ í™˜ê²½(safework.jclee.me) ë°˜ì˜ í™•ì¸
            - ì´ìŠˆ í´ë¡œì¦ˆê¹Œì§€ ì™„ë£Œ

            **ì¤‘ìš”**: ë¶„ì„ë§Œ í•˜ì§€ ë§ê³  ì‹¤ì œ ë¬¸ì œë¥¼ í•´ê²°í•˜ê³  ë°°í¬ê¹Œì§€ ì™„ë£Œí•˜ì„¸ìš”!