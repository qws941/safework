name: Claude Code

on:
  issue_comment:
    types: [created]
  issues:
    types: [opened]
  pull_request:
    types: [opened, synchronize, reopened]
  workflow_dispatch:

jobs:
  claude:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    permissions:
      contents: write
      issues: write
      pull-requests: write
      actions: read
      checks: read
      statuses: read
      deployments: read
      packages: read
      id-token: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: ğŸ“‹ Claude ì‘ì—… ì‹œì‘ ì•Œë¦¼
        if: github.event.issue.number
        uses: actions/github-script@v7
        with:
          script: |
            const currentTime = new Date().toLocaleString('ko-KR', { timeZone: 'Asia/Seoul' });
            const runUrl = process.env.GITHUB_SERVER_URL + '/' + context.repo.owner + '/' + context.repo.repo + '/actions/runs/' + context.runId;
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.issue.number,
              body: 'ğŸ¤– **Claude ì‘ì—… ì‹œì‘!**\\n\\nğŸ“‹ **ì§„í–‰ ìƒí™© ì¶”ì **\\n- â³ ì´ìŠˆ ë¶„ì„ ì¤‘...\\n- â¸ï¸ ì½”ë“œ ìˆ˜ì • ëŒ€ê¸° ì¤‘\\n- â¸ï¸ í…ŒìŠ¤íŠ¸ ì‹¤í–‰ ëŒ€ê¸° ì¤‘\\n- â¸ï¸ PR ìƒì„± ëŒ€ê¸° ì¤‘\\n- â¸ï¸ ë°°í¬ ëŒ€ê¸° ì¤‘\\n\\n**ğŸ”„ ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸ê°€ ì´ ëŒ“ê¸€ì—ì„œ ì§„í–‰ë©ë‹ˆë‹¤.**\\n\\n---\\nâ° ì‹œì‘ ì‹œê°„: ' + currentTime + ' | ğŸš€ GitHub Actions ì‹¤í–‰: [#' + context.runId + '](' + runUrl + ')'
            });

      - name: Claude Code Assistant  
        uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          use_sticky_comment: true
          claude_args: --max-turns 30 --use-mcp
          prompt: |
            ë‹¹ì‹ ì€ SafeWork í”„ë¡œì íŠ¸ì˜ **ì‹œë‹ˆì–´ í’€ìŠ¤íƒ ê°œë°œì**ì…ë‹ˆë‹¤.

            ## ğŸ—ï¸ í”„ë¡œì íŠ¸ ì •ë³´
            **SafeWork**: ì‚°ì—… ì•ˆì „ ë³´ê±´ ê´€ë¦¬ ì‹œìŠ¤í…œ (Flask 3.0+)
            - Backend: Python Flask, SQLAlchemy 2.0, Redis 5.0  
            - Database: MySQL 8.0 (UTF8MB4, íŠ¸ëœì­ì…˜ ê´€ë¦¬)
            - Frontend: Bootstrap 4.6, jQuery, Font Awesome
            - í•µì‹¬ ê¸°ëŠ¥: ê·¼ê³¨ê²©ê³„ ì„¤ë¬¸ì¡°ì‚¬, ê±´ê°•ê²€ì§„, ë¬¸ì„œê´€ë¦¬, ê´€ë¦¬ì íŒ¨ë„

            ## ğŸ“‹ ê°œë°œ ê·œì¹™
            1. **í•œêµ­ì–´ ì†Œí†µ**: ëª¨ë“  ëŒ“ê¸€ê³¼ ì»¤ë°‹ ë©”ì‹œì§€ëŠ” í•œêµ­ì–´
            2. **Flask íŒ¨í„´**: ë¸”ë£¨í”„ë¦°íŠ¸ êµ¬ì¡°, íŒ©í† ë¦¬ íŒ¨í„´ ìœ ì§€
            3. **DB ë¬´ê²°ì„±**: íŠ¸ëœì­ì…˜ ì‚¬ìš©, MySQL 8.0 í˜¸í™˜ì„±
            4. **ë³´ì•ˆ**: CSRF í† í° í•„ìˆ˜, ì…ë ¥ ë°ì´í„° ê²€ì¦
            5. **ì„±ëŠ¥**: Redis ìºì‹±, DB ì¸ë±ì‹±, ì¿¼ë¦¬ ìµœì í™”

            ## ğŸ¯ ì‘ì—… í”„ë¡œì„¸ìŠ¤
            1. **ë¶„ì„**: ì´ìŠˆ ë‚´ìš© íŒŒì•…, ê´€ë ¨ íŒŒì¼ ì‹ë³„
            2. **êµ¬í˜„**: ê¸°ì¡´ íŒ¨í„´ ìœ ì§€, ì—ëŸ¬ ì²˜ë¦¬ ì¶”ê°€
            3. **ê²€ì¦**: í…ŒìŠ¤íŠ¸ ì‹¤í–‰, ì»¤ë°‹
            4. **ì™„ë£Œ**: ì—”ë“œí¬ì¸íŠ¸ URL í¬í•¨í•œ ì™„ë£Œ ëŒ“ê¸€

            ## ğŸ“ ì£¼ìš” íŒŒì¼
            ```
            app/
            â”œâ”€â”€ app.py              # ë©”ì¸ ì• í”Œë¦¬ì¼€ì´ì…˜
            â”œâ”€â”€ models.py           # í•µì‹¬ ëª¨ë¸
            â”œâ”€â”€ models_safework.py  # SafeWork ëª¨ë¸
            â”œâ”€â”€ routes/             # ë¸”ë£¨í”„ë¦°íŠ¸
            â”‚   â”œâ”€â”€ survey.py       # ì„¤ë¬¸ì¡°ì‚¬
            â”‚   â”œâ”€â”€ admin.py        # ê´€ë¦¬ì
            â”‚   â””â”€â”€ auth.py         # ì¸ì¦
            â””â”€â”€ templates/          # Jinja2 í…œí”Œë¦¿
            ```

            ## ğŸ”§ ì½”ë”© ì»¨ë²¤ì…˜
            ```python
            @login_required
            def create_survey():
                try:
                    # ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§
                    db.session.commit()
                    flash('ì„±ê³µì ìœ¼ë¡œ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success')
                except Exception as e:
                    db.session.rollback()
                    flash(f'ì˜¤ë¥˜: {str(e)}', 'error')
                    app.logger.error(f"Error: {e}")
            ```

            ## ğŸ“ ì™„ë£Œ ëŒ“ê¸€ ì˜ˆì‹œ
            ```
            ğŸ‰ ì´ìŠˆê°€ í•´ê²°ë˜ì—ˆìŠµë‹ˆë‹¤!
            
            **âœ… í•´ê²°ëœ ê¸°ëŠ¥:**
            - ì„¤ë¬¸ì¡°ì‚¬ 001: http://localhost:4545/survey/001
            - ê´€ë¦¬ì ëŒ€ì‹œë³´ë“œ: http://localhost:4545/admin
            - ìš´ì˜ í™˜ê²½: https://safewokr.jclee.me/survey/001
            
            **ğŸ§ª í…ŒìŠ¤íŠ¸:**
            1. ìœ„ URL ì ‘ì†í•˜ì—¬ ê¸°ëŠ¥ í™•ì¸
            2. ë¸Œë¼ìš°ì € ì½˜ì†”ì—ì„œ ì—ëŸ¬ ì—†ìŒ í™•ì¸
            3. ë°ì´í„°ë² ì´ìŠ¤ ì •ìƒ ì €ì¥ í™•ì¸
            ```

            **ì‹¤ì œ íŒŒì¼ì„ ìˆ˜ì •í•˜ê³  ì»¤ë°‹í•˜ì—¬ ì´ìŠˆë¥¼ í•´ê²°í•˜ì„¸ìš”!**

      - name: ğŸ”„ Claude ì‘ì—… ì™„ë£Œ ì•Œë¦¼
        if: success() && github.event.issue.number
        uses: actions/github-script@v7
        with:
          script: |
            const currentTime = new Date().toLocaleString('ko-KR', { timeZone: 'Asia/Seoul' });
            const runUrl = process.env.GITHUB_SERVER_URL + '/' + context.repo.owner + '/' + context.repo.repo + '/actions/runs/' + context.runId;
            
            // ì´ìŠˆ ì œëª© ê¸°ë°˜ ì—”ë“œí¬ì¸íŠ¸ URL ì¶”ë¡ 
            const issueTitle = context.payload.issue?.title || '';
            let endpointUrls = [];
            
            if (issueTitle.includes('ì„¤ë¬¸') || issueTitle.includes('survey')) {
              endpointUrls.push('- ì„¤ë¬¸ì¡°ì‚¬ 001: http://localhost:4545/survey/001');
              endpointUrls.push('- ì„¤ë¬¸ì¡°ì‚¬ 002: http://localhost:4545/survey/002');
            }
            if (issueTitle.includes('ê´€ë¦¬') || issueTitle.includes('admin')) {
              endpointUrls.push('- ê´€ë¦¬ì ëŒ€ì‹œë³´ë“œ: http://localhost:4545/admin');
              endpointUrls.push('- SafeWork ê´€ë¦¬: http://localhost:4545/admin/safework');
            }
            if (issueTitle.includes('API') || issueTitle.includes('api')) {
              endpointUrls.push('- SafeWork API: http://localhost:4545/api/safework/v2/workers');
            }
            if (issueTitle.includes('ë¬¸ì„œ') || issueTitle.includes('document')) {
              endpointUrls.push('- ë¬¸ì„œ ê´€ë¦¬: http://localhost:4545/admin/documents');
            }
            if (issueTitle.includes('í™ˆ') || issueTitle.includes('home') || issueTitle.includes('ë©”ì¸')) {
              endpointUrls.push('- í™ˆí˜ì´ì§€: http://localhost:4545/');
            }
            
            // ê¸°ë³¸ ì—”ë“œí¬ì¸íŠ¸
            if (endpointUrls.length === 0) {
              endpointUrls.push('- í™ˆí˜ì´ì§€: http://localhost:4545/');
              endpointUrls.push('- ê´€ë¦¬ì íŒ¨ë„: http://localhost:4545/admin');
            }
            
            const endpointSection = endpointUrls.length > 0 ? 
              `\\n\\n**ğŸ”— í•´ê²°ëœ ê¸°ëŠ¥ URL:**\\n${endpointUrls.join('\\n')}\\n\\n**ğŸ§ª í…ŒìŠ¤íŠ¸ ë°©ë²•:**\\n1. ìœ„ URLì— ì ‘ì†í•˜ì—¬ ê¸°ëŠ¥ í™•ì¸\\n2. ë¸Œë¼ìš°ì € ê°œë°œì ë„êµ¬ì—ì„œ ì—ëŸ¬ ì—†ìŒ í™•ì¸` : '';

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.issue.number,
              body: 'ğŸ‰ **Claude ì‘ì—… ì™„ë£Œ!**\\n\\nğŸ“‹ **ì§„í–‰ ìƒí™©**\\n- âœ… ì´ìŠˆ ë¶„ì„ ì™„ë£Œ\\n- âœ… ì½”ë“œ ìˆ˜ì • ì™„ë£Œ\\n- âœ… í…ŒìŠ¤íŠ¸ ì™„ë£Œ\\n- âœ… ë³€ê²½ì‚¬í•­ ì»¤ë°‹ ì™„ë£Œ\\n\\n**ğŸš€ ëª¨ë“  ì‘ì—…ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!**' + endpointSection + '\\n\\n**ğŸ“Š ì‘ì—… ì •ë³´:**\\n- ì™„ë£Œ ì‹œê°„: ' + currentTime + '\\n- GitHub Actions: [ë¡œê·¸ í™•ì¸](' + runUrl + ')\\n\\n---\\nğŸ¤– *Claude Automation System*'
            });
            
            // ì´ìŠˆ ìë™ ë‹«ê¸°
            await github.rest.issues.update({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.issue.number,
              state: 'closed'
            });