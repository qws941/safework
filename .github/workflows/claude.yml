name: Claude Code

on:
  issue_comment:
    types: [created]
  issues:
    types: [opened]
  pull_request:
    types: [opened, synchronize, reopened]
  workflow_dispatch:

jobs:
  claude:
    if: |
      github.event_name == 'workflow_dispatch' ||
      (github.event_name == 'issue_comment' && contains(github.event.comment.body, '@claude')) ||
      (github.event_name == 'issues' && github.event.action == 'opened') ||
      (github.event_name == 'pull_request' && contains(fromJSON('["opened", "synchronize", "reopened"]'), github.event.action))
    runs-on: ubuntu-latest
    timeout-minutes: 30
    permissions:
      contents: write
      issues: write
      pull-requests: write
      actions: read
      checks: read
      statuses: read
      deployments: read
      packages: read
      id-token: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: ğŸ“‹ Claude ì‘ì—… ì‹œì‘ ì•Œë¦¼
        if: github.event.issue.number
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.issue.number,
              body: `ğŸ¤– **Claude ì‘ì—… ì‹œì‘!**
              
              ğŸ“‹ **ì§„í–‰ ìƒí™© ì¶”ì **
              - â³ ì´ìŠˆ ë¶„ì„ ì¤‘...
              - â¸ï¸ ì½”ë“œ ìˆ˜ì • ëŒ€ê¸° ì¤‘
              - â¸ï¸ í…ŒìŠ¤íŠ¸ ì‹¤í–‰ ëŒ€ê¸° ì¤‘  
              - â¸ï¸ PR ìƒì„± ëŒ€ê¸° ì¤‘
              - â¸ï¸ ë°°í¬ ëŒ€ê¸° ì¤‘
              
              **ğŸ”„ ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸ê°€ ì´ ëŒ“ê¸€ì—ì„œ ì§„í–‰ë©ë‹ˆë‹¤.**
              
              ---
              â° ì‹œì‘ ì‹œê°„: \\${new Date().toLocaleString('ko-KR')} | ğŸš€ GitHub Actions ì‹¤í–‰: [#\\${context.runId}](\\${process.env.GITHUB_SERVER_URL}/\\${context.repo.owner}/\\${context.repo.repo}/actions/runs/\\${context.runId})`
            });

      - name: Enhanced Claude Code Assistant  
        id: claude_action
        uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          use_sticky_comment: true
          track_progress: ${{ github.event_name == 'issues' || github.event_name == 'pull_request' }}
          prompt: |
            ë‹¹ì‹ ì€ SafeWork í”„ë¡œì íŠ¸ì˜ **ì‹œë‹ˆì–´ í’€ìŠ¤íƒ ê°œë°œì**ì…ë‹ˆë‹¤.

            ## ğŸ—ï¸ í”„ë¡œì íŠ¸ ì•„í‚¤í…ì²˜
            **SafeWork**: ì‚°ì—… ì•ˆì „ ë³´ê±´ ê´€ë¦¬ ì‹œìŠ¤í…œ (Flask 3.0+)
            - **ë°±ì—”ë“œ**: Python Flask, SQLAlchemy 2.0, Redis 5.0  
            - **ë°ì´í„°ë² ì´ìŠ¤**: MySQL 8.0 (UTF8MB4, íŠ¸ëœì­ì…˜ ê´€ë¦¬)
            - **í”„ë¡ íŠ¸ì—”ë“œ**: Bootstrap 4.6, jQuery, Font Awesome
            - **í•µì‹¬ ê¸°ëŠ¥**: ê·¼ê³¨ê²©ê³„ ì„¤ë¬¸ì¡°ì‚¬, ê±´ê°•ê²€ì§„, ë¬¸ì„œê´€ë¦¬, ê´€ë¦¬ì íŒ¨ë„

            ## ğŸ“‹ ê°œë°œ ì›ì¹™ (í•„ìˆ˜ ì¤€ìˆ˜)
            1. **í•œêµ­ì–´ ì†Œí†µ**: ëª¨ë“  ëŒ“ê¸€ê³¼ ì»¤ë°‹ ë©”ì‹œì§€ëŠ” í•œêµ­ì–´
            2. **Flask íŒ¨í„´ ì¤€ìˆ˜**: ë¸”ë£¨í”„ë¦°íŠ¸ êµ¬ì¡°, íŒ©í† ë¦¬ íŒ¨í„´ ìœ ì§€
            3. **ë°ì´í„°ë² ì´ìŠ¤ ë¬´ê²°ì„±**: 
               - íŠ¸ëœì­ì…˜ ì‚¬ìš© (`db.session.commit()`, `rollback()`)
               - ë§ˆì´ê·¸ë ˆì´ì…˜ ìƒì„± ì‹œ MySQL 8.0 í˜¸í™˜ì„± í™•ì¸
               - í•œêµ­ ì‹œê°„ëŒ€(KST) ì¼ê´€ì„±: `kst_now()` í•¨ìˆ˜ ì‚¬ìš©
            4. **ë³´ì•ˆ ê°•í™”**: 
               - CSRF í† í° í•„ìˆ˜
               - SQL ì¸ì ì…˜ ë°©ì–´
               - ì…ë ¥ ë°ì´í„° ê²€ì¦ ë° ì‚¬ë‹ˆíƒ€ì´ì§•
            5. **ì„±ëŠ¥ ìµœì í™”**: 
               - Redis ìºì‹± í™œìš©
               - ë°ì´í„°ë² ì´ìŠ¤ ì¸ë±ì‹±
               - ì¿¼ë¦¬ ìµœì í™”

            ## ğŸ”§ ì½”ë”© ì»¨ë²¤ì…˜
            ```python
            # âœ… ì˜¬ë°”ë¥¸ íŒ¨í„´
            @login_required
            def create_survey():
                try:
                    # ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§
                    db.session.commit()
                    flash('ì„¤ë¬¸ì´ ì„±ê³µì ìœ¼ë¡œ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success')
                except Exception as e:
                    db.session.rollback()
                    flash(f'ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: {str(e)}', 'error')
                    app.logger.error(f"Survey creation error: {e}")
            ```

            ## ğŸ¯ ì´ìŠˆ í•´ê²° í”„ë¡œì„¸ìŠ¤
            ### 1ë‹¨ê³„: ë¶„ì„
            - ì´ìŠˆ ë‚´ìš© ì •í™•íˆ íŒŒì•…
            - ê´€ë ¨ íŒŒì¼ë“¤ ì‹ë³„ (`app/routes/`, `app/models.py`, `app/templates/`)
            - í˜„ì¬ êµ¬í˜„ ìƒíƒœ í™•ì¸

            ### 2ë‹¨ê³„: êµ¬í˜„
            - ê¸°ì¡´ ì½”ë“œ íŒ¨í„´ ìœ ì§€
            - ë‹¨ê³„ë³„ ë³€ê²½ì‚¬í•­ ì ìš©
            - ì—ëŸ¬ ì²˜ë¦¬ ë° ë¡œê¹… ì¶”ê°€

            ### 3ë‹¨ê³„: ê²€ì¦
            - ì½”ë“œ ë¦¬ë·° ë° í…ŒìŠ¤íŠ¸
            - ë§ˆì´ê·¸ë ˆì´ì…˜ í•„ìš” ì‹œ ìƒì„±
            - ì˜ë¯¸ìˆëŠ” ì»¤ë°‹ ë©”ì‹œì§€ ì‘ì„±

            ### 4ë‹¨ê³„: ì™„ë£Œ
            - ë³€ê²½ì‚¬í•­ ìš”ì•½ ëŒ“ê¸€
            - **ì´ìŠˆ ìë™ ë‹«ê¸°** (ì¤‘ìš”!)

            ## ğŸ“ ì£¼ìš” íŒŒì¼ êµ¬ì¡°
            ```
            app/
            â”œâ”€â”€ app.py              # ë©”ì¸ ì• í”Œë¦¬ì¼€ì´ì…˜
            â”œâ”€â”€ models.py           # í•µì‹¬ ëª¨ë¸ (User, Survey)
            â”œâ”€â”€ models_safework.py  # SafeWork ì „ìš© ëª¨ë¸
            â”œâ”€â”€ routes/            # ë¸”ë£¨í”„ë¦°íŠ¸ ë¼ìš°í„°
            â”‚   â”œâ”€â”€ survey.py      # ì„¤ë¬¸ì¡°ì‚¬ (001/002)
            â”‚   â”œâ”€â”€ admin.py       # ê´€ë¦¬ì íŒ¨ë„
            â”‚   â””â”€â”€ auth.py        # ì¸ì¦
            â””â”€â”€ templates/         # Jinja2 í…œí”Œë¦¿
            ```

            ## âš¡ ì‘ì—… ì™„ë£Œ ì²´í¬ë¦¬ìŠ¤íŠ¸
            - [ ] ê¸°ëŠ¥ êµ¬í˜„ ì™„ë£Œ
            - [ ] ì—ëŸ¬ ì²˜ë¦¬ ì¶”ê°€
            - [ ] í…ŒìŠ¤íŠ¸ ì‹¤í–‰ (ê°€ëŠ¥í•œ ê²½ìš°)
            - [ ] ì»¤ë°‹ ë©”ì‹œì§€ ì‘ì„± ("feat:", "fix:", "refactor:" ë“±)
            - [ ] ì´ìŠˆì— ì™„ë£Œ ëŒ“ê¸€ ì‘ì„±
            - [ ] **ì´ìŠˆ ìƒíƒœë¥¼ 'closed'ë¡œ ë³€ê²½**

            ì‘ì—…ì„ ì‹œì‘í•˜ì„¸ìš”! ğŸš€
          claude_args: |
            --max-turns 30

      - name: ğŸ”„ Claude ì‘ì—… ì™„ë£Œ ë° PR ì²˜ë¦¬ ì‹œì‘
        if: success() && github.event.issue.number
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.issue.number,
              body: `âœ… **Claude ë¶„ì„ ì™„ë£Œ!**
              
              ğŸ“‹ **ì§„í–‰ ìƒí™© ì—…ë°ì´íŠ¸**
              - âœ… ì´ìŠˆ ë¶„ì„ ì™„ë£Œ
              - âœ… ì½”ë“œ ìˆ˜ì • ì™„ë£Œ
              - â³ PR ìƒì„± ì¤‘...
              - â¸ï¸ ìë™ ë³‘í•© ëŒ€ê¸° ì¤‘
              - â¸ï¸ ë°°í¬ ëŒ€ê¸° ì¤‘
              
              **ğŸ”„ ê³§ PRì´ ìë™ìœ¼ë¡œ ìƒì„±ë©ë‹ˆë‹¤...**`
            });

      - name: Advanced Auto PR and Merge
        if: success()
        uses: actions/github-script@v7
        with:
          script: |
            console.log('ğŸš€ Claude ì‘ì—… ì™„ë£Œ!');
            console.log('ì´ìŠˆ ë²ˆí˜¸:', context.payload.issue?.number);
            console.log('ì´ìŠˆ ì œëª©:', context.payload.issue?.title);
            
            if (context.payload.issue?.number) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.payload.issue.number,
                body: 'ğŸ‰ **Claude ì‘ì—… ì™„ë£Œ!**\n\nâœ… ì´ìŠˆê°€ ì„±ê³µì ìœ¼ë¡œ ì²˜ë¦¬ë˜ì—ˆìŠµë‹ˆë‹¤.\n\nğŸ“‹ **ì²˜ë¦¬ ì™„ë£Œ ì‚¬í•­:**\n- ì´ìŠˆ ë¶„ì„ ì™„ë£Œ\n- ì½”ë“œ ìˆ˜ì • ì™„ë£Œ\n- ìë™ ë°°í¬ ì§„í–‰ ì¤‘\n\nğŸš€ ë³€ê²½ì‚¬í•­ì´ ìš´ì˜ í™˜ê²½ì— ë°˜ì˜ë  ì˜ˆì •ì…ë‹ˆë‹¤!'
              });
            }

