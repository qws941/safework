name: Claude Code

on:
  issue_comment:
    types: [created]
  issues:
    types: [opened]
  pull_request:
    types: [opened, synchronize, reopened]
  workflow_dispatch:

jobs:
  claude:
    if: |
      (github.event_name == 'issue_comment' && contains(github.event.comment.body, '@claude')) ||
      (github.event_name == 'issues') ||
      (github.event_name == 'pull_request') ||
      github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    permissions:
      contents: write
      issues: write
      pull-requests: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Claude Code Assistant
        uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          prompt: |
            ë‹¹ì‹ ì€ SafeWork í”„ë¡œì íŠ¸ì˜ ì „ë¬¸ ê°œë°œìì…ë‹ˆë‹¤.
            
            **í”„ë¡œì íŠ¸ ì»¨í…ìŠ¤íŠ¸:**
            - Flask 3.0+ ê¸°ë°˜ ì‚°ì—… ì•ˆì „ ë³´ê±´ ê´€ë¦¬ ì‹œìŠ¤í…œ
            - MySQL 8.0, Redis, Bootstrap 4.6 ì‚¬ìš©
            - ì„¤ë¬¸ì¡°ì‚¬, ê±´ê°•ê²€ì§„, ë¬¸ì„œê´€ë¦¬ ê¸°ëŠ¥ ì œê³µ
            
            **ì‘ì—… ì§€ì¹¨:**
            1. í•œêµ­ì–´ë¡œ ì‚¬ìš©ìì™€ ì†Œí†µí•˜ì„¸ìš”
            2. ê¸°ì¡´ ì½”ë“œ íŒ¨í„´ê³¼ ìŠ¤íƒ€ì¼ì„ ìœ ì§€í•˜ì„¸ìš”
            3. Flask ë¸”ë£¨í”„ë¦°íŠ¸ êµ¬ì¡°ë¥¼ ë”°ë¥´ì„¸ìš”
            4. ë°ì´í„°ë² ì´ìŠ¤ ë³€ê²½ì‹œ ë§ˆì´ê·¸ë ˆì´ì…˜ì„ ìƒì„±í•˜ì„¸ìš”
            5. ë³´ì•ˆê³¼ ì„±ëŠ¥ì„ ê³ ë ¤í•˜ì„¸ìš”
            6. í…ŒìŠ¤íŠ¸ ì‘ì„±ì„ ê¶Œì¥í•©ë‹ˆë‹¤
            
            **ì´ìŠˆ í•´ê²° ì‹œ:**
            - ë¬¸ì œë¥¼ ì •í™•íˆ íŒŒì•…í•˜ê³  ë¶„ì„í•˜ì„¸ìš”
            - ì½”ë“œë¥¼ ìˆ˜ì •í•˜ê¸° ì „ì— í˜„ì¬ ìƒíƒœë¥¼ í™•ì¸í•˜ì„¸ìš”
            - ë³€ê²½ì‚¬í•­ì„ ë‹¨ê³„ë³„ë¡œ ì„¤ëª…í•˜ì„¸ìš”
            - ì‘ì—… ì™„ë£Œ í›„ ì ì ˆí•œ ì»¤ë°‹ ë©”ì‹œì§€ë¡œ ì»¤ë°‹í•˜ì„¸ìš”
            - ì´ìŠˆ í•´ê²° ì™„ë£Œ í›„ ë°˜ë“œì‹œ ì´ìŠˆë¥¼ ë‹«ì•„ì£¼ì„¸ìš”
            
            CLAUDE.md íŒŒì¼ì˜ ì§€ì¹¨ì„ ì°¸ê³ í•˜ì—¬ ì‘ì—…í•´ì£¼ì„¸ìš”.
          claude_args: "--max-turns 20"

      - name: Auto PR and Merge
        if: success()
        uses: actions/github-script@v7
        with:
          script: |
            const { owner, repo } = context.repo;
            
            // Claudeê°€ ìƒì„±í•œ ë¸Œëœì¹˜ ì°¾ê¸°
            const branches = await github.rest.repos.listBranches({
              owner,
              repo,
              per_page: 100
            });
            
            const claudeBranches = branches.data.filter(branch => 
              branch.name.startsWith('claude/') && 
              branch.name.includes(new Date().toISOString().slice(0, 10).replace(/-/g, ''))
            );
            
            if (claudeBranches.length > 0) {
              const branchName = claudeBranches[0].name;
              console.log(`ğŸ” Claude ë¸Œëœì¹˜ ë°œê²¬: ${branchName}`);
              
              try {
                // PR ìƒì„±
                const prResponse = await github.rest.pulls.create({
                  owner,
                  repo,
                  title: `ğŸ¤– Claude: ${context.payload.issue?.title || 'ìë™ ìˆ˜ì •'}`,
                  head: branchName,
                  base: 'master',
                  body: `ğŸ¤– **Claudeê°€ ìë™ìœ¼ë¡œ ìƒì„±í•œ PRì…ë‹ˆë‹¤**

**ì´ìŠˆ:** #${context.payload.issue?.number || 'N/A'}
**ë¸Œëœì¹˜:** ${branchName}
**ì‘ì—… ì‹œê°„:** ${new Date().toLocaleString('ko-KR')}

Claudeê°€ ì´ìŠˆë¥¼ ë¶„ì„í•˜ê³  ì½”ë“œë¥¼ ìˆ˜ì •í–ˆìŠµë‹ˆë‹¤.
ìë™ìœ¼ë¡œ ë³‘í•©ë©ë‹ˆë‹¤.

---
_Generated by Claude Code Assistant ğŸ¤–_`
                });
                
                console.log(`âœ… PR ìƒì„± ì™„ë£Œ: #${prResponse.data.number}`);
                
                // ì ì‹œ ëŒ€ê¸° (PR ìƒíƒœ ì•ˆì •í™”)
                await new Promise(resolve => setTimeout(resolve, 2000));
                
                // ìë™ ë³‘í•©
                await github.rest.pulls.merge({
                  owner,
                  repo,
                  pull_number: prResponse.data.number,
                  commit_title: `ğŸ¤– Claude: ${context.payload.issue?.title || 'ìë™ ìˆ˜ì •'}`,
                  commit_message: `ì´ìŠˆ #${context.payload.issue?.number || 'N/A'} í•´ê²°

Claudeê°€ ìë™ìœ¼ë¡œ ìƒì„±í•œ ë³€ê²½ì‚¬í•­ì…ë‹ˆë‹¤.`,
                  merge_method: 'squash'
                });
                
                console.log(`âœ… ìë™ ë³‘í•© ì™„ë£Œ`);
                
                // ë¸Œëœì¹˜ ì‚­ì œ
                await github.rest.git.deleteRef({
                  owner,
                  repo,
                  ref: `heads/${branchName}`
                });
                
                console.log(`âœ… ë¸Œëœì¹˜ ì‚­ì œ ì™„ë£Œ: ${branchName}`);
                
              } catch (error) {
                console.error(`âŒ PR ìƒì„±/ë³‘í•© ì‹¤íŒ¨:`, error);
              }
            } else {
              console.log(`âš ï¸ Claude ë¸Œëœì¹˜ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤`);
            }

