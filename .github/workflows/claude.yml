name: Claude Code

on:
  issue_comment:
    types: [created]
  issues:
    types: [opened]
  pull_request:
    types: [opened, synchronize, reopened]
  workflow_dispatch:

jobs:
  claude:
    if: |
      github.event_name == 'workflow_dispatch' ||
      (github.event_name == 'issue_comment' && contains(github.event.comment.body, '@claude')) ||
      (github.event_name == 'issues' && github.event.action == 'opened') ||
      (github.event_name == 'pull_request' && contains(fromJSON('["opened", "synchronize", "reopened"]'), github.event.action))
    runs-on: ubuntu-latest
    timeout-minutes: 30
    permissions:
      contents: write
      issues: write
      pull-requests: write
      actions: write
      checks: write
      statuses: write
      deployments: write
      packages: write
      id-token: write
      repository-projects: write
      metadata: read
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}
          persist-credentials: true

      - name: ğŸ“‹ Claude ì‘ì—… ì‹œì‘ ì•Œë¦¼
        if: github.event.issue.number
        uses: actions/github-script@v7
        with:
          script: |
            const currentTime = new Date().toLocaleString('ko-KR', { timeZone: 'Asia/Seoul' });
            const runUrl = process.env.GITHUB_SERVER_URL + '/' + context.repo.owner + '/' + context.repo.repo + '/actions/runs/' + context.runId;
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.issue.number,
              body: 'ğŸ¤– **Claude ì‘ì—… ì‹œì‘!**\n\nğŸ“‹ **ì§„í–‰ ìƒí™© ì¶”ì **\n- â³ ì´ìŠˆ ë¶„ì„ ì¤‘...\n- â¸ï¸ ì½”ë“œ ìˆ˜ì • ëŒ€ê¸° ì¤‘\n- â¸ï¸ í…ŒìŠ¤íŠ¸ ì‹¤í–‰ ëŒ€ê¸° ì¤‘\n- â¸ï¸ PR ìƒì„± ëŒ€ê¸° ì¤‘\n- â¸ï¸ ë°°í¬ ëŒ€ê¸° ì¤‘\n\n**ğŸ”„ ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸ê°€ ì´ ëŒ“ê¸€ì—ì„œ ì§„í–‰ë©ë‹ˆë‹¤.**\n\n---\nâ° ì‹œì‘ ì‹œê°„: ' + currentTime + ' | ğŸš€ GitHub Actions ì‹¤í–‰: [#' + context.runId + '](' + runUrl + ')'
            });

      - name: Enhanced Claude Code Assistant  
        id: claude_action
        uses: anthropics/claude-code-action@main
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          github_token: ${{ secrets.GITHUB_TOKEN }}
          use_sticky_comment: true
          track_progress: ${{ github.event_name == 'issues' || github.event_name == 'pull_request' }}
          claude_args: --max-turns 30 --debug --enable-edit
          prompt: |
            ë‹¹ì‹ ì€ SafeWork í”„ë¡œì íŠ¸ì˜ **ì‹œë‹ˆì–´ í’€ìŠ¤íƒ ê°œë°œì**ì…ë‹ˆë‹¤.

            ## ğŸ—ï¸ í”„ë¡œì íŠ¸ ì•„í‚¤í…ì²˜
            **SafeWork**: ì‚°ì—… ì•ˆì „ ë³´ê±´ ê´€ë¦¬ ì‹œìŠ¤í…œ (Flask 3.0+)
            - **ë°±ì—”ë“œ**: Python Flask, SQLAlchemy 2.0, Redis 5.0  
            - **ë°ì´í„°ë² ì´ìŠ¤**: MySQL 8.0 (UTF8MB4, íŠ¸ëœì­ì…˜ ê´€ë¦¬)
            - **í”„ë¡ íŠ¸ì—”ë“œ**: Bootstrap 4.6, jQuery, Font Awesome
            - **í•µì‹¬ ê¸°ëŠ¥**: ê·¼ê³¨ê²©ê³„ ì„¤ë¬¸ì¡°ì‚¬, ê±´ê°•ê²€ì§„, ë¬¸ì„œê´€ë¦¬, ê´€ë¦¬ì íŒ¨ë„

            ## ğŸ“‹ ê°œë°œ ì›ì¹™ (í•„ìˆ˜ ì¤€ìˆ˜)
            1. **í•œêµ­ì–´ ì†Œí†µ**: ëª¨ë“  ëŒ“ê¸€ê³¼ ì»¤ë°‹ ë©”ì‹œì§€ëŠ” í•œêµ­ì–´
            2. **Flask íŒ¨í„´ ì¤€ìˆ˜**: ë¸”ë£¨í”„ë¦°íŠ¸ êµ¬ì¡°, íŒ©í† ë¦¬ íŒ¨í„´ ìœ ì§€
            3. **ë°ì´í„°ë² ì´ìŠ¤ ë¬´ê²°ì„±**: 
               - íŠ¸ëœì­ì…˜ ì‚¬ìš© (`db.session.commit()`, `rollback()`)
               - ë§ˆì´ê·¸ë ˆì´ì…˜ ìƒì„± ì‹œ MySQL 8.0 í˜¸í™˜ì„± í™•ì¸
               - í•œêµ­ ì‹œê°„ëŒ€(KST) ì¼ê´€ì„±: `kst_now()` í•¨ìˆ˜ ì‚¬ìš©
            4. **ë³´ì•ˆ ê°•í™”**: 
               - CSRF í† í° í•„ìˆ˜
               - SQL ì¸ì ì…˜ ë°©ì–´
               - ì…ë ¥ ë°ì´í„° ê²€ì¦ ë° ì‚¬ë‹ˆíƒ€ì´ì§•
            5. **ì„±ëŠ¥ ìµœì í™”**: 
               - Redis ìºì‹± í™œìš©
               - ë°ì´í„°ë² ì´ìŠ¤ ì¸ë±ì‹±
               - ì¿¼ë¦¬ ìµœì í™”

            ## ğŸ”§ ì½”ë”© ì»¨ë²¤ì…˜
            ```python
            # âœ… ì˜¬ë°”ë¥¸ íŒ¨í„´
            @login_required
            def create_survey():
                try:
                    # ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§
                    db.session.commit()
                    flash('ì„¤ë¬¸ì´ ì„±ê³µì ìœ¼ë¡œ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success')
                except Exception as e:
                    db.session.rollback()
                    flash(f'ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: {str(e)}', 'error')
                    app.logger.error(f"Survey creation error: {e}")
            ```

            ## ğŸ¯ ì´ìŠˆ í•´ê²° í”„ë¡œì„¸ìŠ¤ (ë°˜ë“œì‹œ íŒŒì¼ ìˆ˜ì • í•„ìˆ˜!)
            
            **âš ï¸ ì¤‘ìš”: ë°˜ë“œì‹œ ì‹¤ì œ íŒŒì¼ì„ ìˆ˜ì •í•˜ê³  ì»¤ë°‹í•´ì•¼ í•©ë‹ˆë‹¤!**
            
            ### 1ë‹¨ê³„: ë¶„ì„ (ì‹¤í–‰)
            - ì´ìŠˆ ë‚´ìš© ì •í™•íˆ íŒŒì•…
            - ê´€ë ¨ íŒŒì¼ë“¤ ì‹ë³„ (`app/routes/`, `app/models.py`, `app/templates/`)
            - í˜„ì¬ êµ¬í˜„ ìƒíƒœ í™•ì¸ (Read ë„êµ¬ ì‚¬ìš©)

            ### 2ë‹¨ê³„: êµ¬í˜„ (í•„ìˆ˜ ì‹¤í–‰)
            - **Edit ë„êµ¬ë¥¼ ì‚¬ìš©í•˜ì—¬ ì‹¤ì œ íŒŒì¼ ìˆ˜ì •**
            - **Write ë„êµ¬ë¥¼ ì‚¬ìš©í•˜ì—¬ ìƒˆ íŒŒì¼ ìƒì„± (í•„ìš”ì‹œ)**
            - ê¸°ì¡´ ì½”ë“œ íŒ¨í„´ ìœ ì§€
            - ë‹¨ê³„ë³„ ë³€ê²½ì‚¬í•­ ì ìš©
            - ì—ëŸ¬ ì²˜ë¦¬ ë° ë¡œê¹… ì¶”ê°€

            ### 3ë‹¨ê³„: ê²€ì¦ ë° ì»¤ë°‹ (í•„ìˆ˜ ì‹¤í–‰)
            - **Bash ë„êµ¬ë¥¼ ì‚¬ìš©í•˜ì—¬ git add, git commit ì‹¤í–‰**
            - ì½”ë“œ ë¦¬ë·° ë° í…ŒìŠ¤íŠ¸
            - ë§ˆì´ê·¸ë ˆì´ì…˜ í•„ìš” ì‹œ ìƒì„±
            - ì˜ë¯¸ìˆëŠ” ì»¤ë°‹ ë©”ì‹œì§€ ì‘ì„±

            ### 4ë‹¨ê³„: ì™„ë£Œ
            - ë³€ê²½ì‚¬í•­ ìš”ì•½ ëŒ“ê¸€ (í•´ê²°ëœ ê¸°ëŠ¥ì˜ ì—”ë“œí¬ì¸íŠ¸ URL í¬í•¨)
            - **ì´ìŠˆ ìë™ ë‹«ê¸°** (ì¤‘ìš”!)
            
            **âš ï¸ ê²½ê³ : íŒŒì¼ ìˆ˜ì • ì—†ì´ ì™„ë£Œ ëŒ“ê¸€ì„ ë‹¬ë©´ ì•ˆ ë©ë‹ˆë‹¤!**
            
            ## ğŸ”— ì™„ë£Œ ëŒ“ê¸€ ì‘ì„± ê°€ì´ë“œ
            ì´ìŠˆ ì™„ë£Œ ì‹œ ë‹¤ìŒ ì •ë³´ë¥¼ ë°˜ë“œì‹œ í¬í•¨í•˜ì„¸ìš”:
            - **í•´ê²°ëœ ê¸°ëŠ¥ URL**: ì‹¤ì œ ì ‘ê·¼ ê°€ëŠ¥í•œ ì—”ë“œí¬ì¸íŠ¸ ì£¼ì†Œ
            - **í…ŒìŠ¤íŠ¸ ë°©ë²•**: ê¸°ëŠ¥ í™•ì¸ ë°©ë²•
            - **ê´€ë ¨ íŒŒì¼**: ìˆ˜ì •ëœ ì£¼ìš” íŒŒì¼ ëª©ë¡
            
            ì˜ˆì‹œ:
            ```
            ğŸ‰ ì´ìŠˆê°€ í•´ê²°ë˜ì—ˆìŠµë‹ˆë‹¤!
            
            **âœ… í•´ê²°ëœ ê¸°ëŠ¥:**
            - ì„¤ë¬¸ì¡°ì‚¬ 001 í¼: http://localhost:4545/survey/001
            - ê´€ë¦¬ì ëŒ€ì‹œë³´ë“œ: http://localhost:4545/admin
            - API ì—”ë“œí¬ì¸íŠ¸: http://localhost:4545/api/safework/workers
            - ìš´ì˜ í™˜ê²½: https://safewokr.jclee.me/survey/001
            
            **ğŸ§ª í…ŒìŠ¤íŠ¸ ë°©ë²•:**
            1. ìœ„ URLì— ì ‘ì†í•˜ì—¬ ê¸°ëŠ¥ í™•ì¸
            2. ë¸Œë¼ìš°ì € ì½˜ì†”ì—ì„œ ì—ëŸ¬ ì—†ìŒ í™•ì¸
            3. ë°ì´í„°ë² ì´ìŠ¤ ì •ìƒ ì €ì¥ í™•ì¸
            ```

            ## ğŸ“ ì£¼ìš” íŒŒì¼ êµ¬ì¡°
            ```
            app/
            â”œâ”€â”€ app.py              # ë©”ì¸ ì• í”Œë¦¬ì¼€ì´ì…˜
            â”œâ”€â”€ models.py           # í•µì‹¬ ëª¨ë¸ (User, Survey)
            â”œâ”€â”€ models_safework.py  # SafeWork ì „ìš© ëª¨ë¸
            â”œâ”€â”€ routes/            # ë¸”ë£¨í”„ë¦°íŠ¸ ë¼ìš°í„°
            â”‚   â”œâ”€â”€ survey.py      # ì„¤ë¬¸ì¡°ì‚¬ (001/002)
            â”‚   â”œâ”€â”€ admin.py       # ê´€ë¦¬ì íŒ¨ë„
            â”‚   â””â”€â”€ auth.py        # ì¸ì¦
            â””â”€â”€ templates/         # Jinja2 í…œí”Œë¦¿
            ```

            ## âš¡ ì‘ì—… ì™„ë£Œ ì²´í¬ë¦¬ìŠ¤íŠ¸ (ëª¨ë‘ ì‹¤í–‰ í•„ìˆ˜!)
            - [ ] **íŒŒì¼ ì½ê¸° (Read ë„êµ¬ ì‚¬ìš©) - ë°˜ë“œì‹œ ì‹¤í–‰**
            - [ ] **íŒŒì¼ ìˆ˜ì • (Edit ë„êµ¬ ì‚¬ìš©) - ë°˜ë“œì‹œ ì‹¤í–‰**  
            - [ ] **Git ì»¤ë°‹ (Bash ë„êµ¬ ì‚¬ìš©) - ë°˜ë“œì‹œ ì‹¤í–‰**
            - [ ] ê¸°ëŠ¥ êµ¬í˜„ ì™„ë£Œ
            - [ ] ì—ëŸ¬ ì²˜ë¦¬ ì¶”ê°€
            - [ ] í…ŒìŠ¤íŠ¸ ì‹¤í–‰ (ê°€ëŠ¥í•œ ê²½ìš°)
            - [ ] ì»¤ë°‹ ë©”ì‹œì§€ ì‘ì„± ("feat:", "fix:", "refactor:" ë“±)
            - [ ] ì´ìŠˆì— ì™„ë£Œ ëŒ“ê¸€ ì‘ì„±
            - [ ] **ì´ìŠˆ ìƒíƒœë¥¼ 'closed'ë¡œ ë³€ê²½**
            
            ## ğŸš¨ ì‹¤í–‰ ëª…ë ¹ (ë°˜ë“œì‹œ ë”°ë¼ì•¼ í•¨!)
            1. **ë°˜ë“œì‹œ Read ë„êµ¬ë¡œ íŒŒì¼ì„ ì½ìœ¼ì„¸ìš”**
            2. **ë°˜ë“œì‹œ Edit ë„êµ¬ë¡œ íŒŒì¼ì„ ìˆ˜ì •í•˜ì„¸ìš”** 
            3. **ë°˜ë“œì‹œ Bash ë„êµ¬ë¡œ git commit í•˜ì„¸ìš”**
            4. **íŒŒì¼ ìˆ˜ì • ì—†ì´ëŠ” ì ˆëŒ€ ì™„ë£Œí•˜ì§€ ë§ˆì„¸ìš”!**

            **ì§€ê¸ˆ ë‹¹ì¥ ì‘ì—…ì„ ì‹œì‘í•˜ì„¸ìš”! ì‹¤ì œ ì½”ë“œë¥¼ ìˆ˜ì •í•˜ì„¸ìš”! ğŸš€**

      - name: ğŸ”„ Claude ì‘ì—… ì™„ë£Œ ë° PR ì²˜ë¦¬ ì‹œì‘
        if: success() && github.event.issue.number
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.issue.number,
              body: 'âœ… **Claude ë¶„ì„ ì™„ë£Œ!**\n\nğŸ“‹ **ì§„í–‰ ìƒí™© ì—…ë°ì´íŠ¸**\n- âœ… ì´ìŠˆ ë¶„ì„ ì™„ë£Œ\n- âœ… ì½”ë“œ ìˆ˜ì • ì™„ë£Œ\n- â³ PR ìƒì„± ì¤‘...\n- â¸ï¸ ìë™ ë³‘í•© ëŒ€ê¸° ì¤‘\n- â¸ï¸ ë°°í¬ ëŒ€ê¸° ì¤‘\n\n**ğŸ”„ ê³§ PRì´ ìë™ìœ¼ë¡œ ìƒì„±ë©ë‹ˆë‹¤...**'
            });

      - name: Advanced Auto PR and Merge
        if: success()
        uses: actions/github-script@v7
        with:
          script: |
            console.log('ğŸš€ Claude ì‘ì—… ì™„ë£Œ!');
            console.log('ì´ìŠˆ ë²ˆí˜¸:', context.payload.issue?.number);
            console.log('ì´ìŠˆ ì œëª©:', context.payload.issue?.title);
            
            if (context.payload.issue?.number) {
              const currentTime = new Date().toLocaleString('ko-KR', { timeZone: 'Asia/Seoul' });
              const runUrl = process.env.GITHUB_SERVER_URL + '/' + context.repo.owner + '/' + context.repo.repo + '/actions/runs/' + context.runId;
              
              // ì´ìŠˆ ì œëª©ì„ ê¸°ë°˜ìœ¼ë¡œ ê´€ë ¨ ì—”ë“œí¬ì¸íŠ¸ URL ì¶”ë¡ 
              const issueTitle = context.payload.issue?.title || '';
              let endpointUrls = [];
              
              // SafeWork í”„ë¡œì íŠ¸ì˜ ì£¼ìš” ì—”ë“œí¬ì¸íŠ¸ ë§¤í•‘
              if (issueTitle.includes('ì„¤ë¬¸') || issueTitle.includes('survey')) {
                endpointUrls.push('- ì„¤ë¬¸ì¡°ì‚¬ 001 (ê·¼ê³¨ê²©ê³„): http://localhost:4545/survey/001');
                endpointUrls.push('- ì„¤ë¬¸ì¡°ì‚¬ 002 (ì‹ ê·œì…ì‚¬ì): http://localhost:4545/survey/002');
              }
              if (issueTitle.includes('ê´€ë¦¬') || issueTitle.includes('admin')) {
                endpointUrls.push('- ê´€ë¦¬ì ëŒ€ì‹œë³´ë“œ: http://localhost:4545/admin');
                endpointUrls.push('- SafeWork ê´€ë¦¬íŒ¨ë„: http://localhost:4545/admin/safework');
              }
              if (issueTitle.includes('API') || issueTitle.includes('api')) {
                endpointUrls.push('- SafeWork API: http://localhost:4545/api/safework/v2/workers');
                endpointUrls.push('- ê±´ê°•ê²€ì§„ API: http://localhost:4545/api/safework/v2/health-checks');
              }
              if (issueTitle.includes('ë¬¸ì„œ') || issueTitle.includes('document')) {
                endpointUrls.push('- ë¬¸ì„œ ê´€ë¦¬: http://localhost:4545/admin/documents');
                endpointUrls.push('- ê³µê°œ ë¬¸ì„œ: http://localhost:4545/documents');
              }
              if (issueTitle.includes('ì¸ì¦') || issueTitle.includes('auth') || issueTitle.includes('ë¡œê·¸ì¸')) {
                endpointUrls.push('- ë¡œê·¸ì¸: http://localhost:4545/auth/login');
                endpointUrls.push('- íšŒì›ê°€ì…: http://localhost:4545/auth/register');
              }
              
              // ê¸°ë³¸ ì—”ë“œí¬ì¸íŠ¸ (íŠ¹ì • í‚¤ì›Œë“œê°€ ì—†ëŠ” ê²½ìš°)
              if (endpointUrls.length === 0) {
                endpointUrls.push('- í™ˆí˜ì´ì§€: http://localhost:4545/');
                endpointUrls.push('- ì„¤ë¬¸ì¡°ì‚¬ ë©”ì¸: http://localhost:4545/survey');
                endpointUrls.push('- ê´€ë¦¬ì íŒ¨ë„: http://localhost:4545/admin');
              }
              
              const endpointSection = endpointUrls.length > 0 ? 
                `\n\n**ğŸ”— í•´ê²°ëœ ê¸°ëŠ¥ URL:**\n${endpointUrls.join('\n')}\n\n**ğŸ§ª í…ŒìŠ¤íŠ¸ ë°©ë²•:**\n1. ìœ„ URLì— ì ‘ì†í•˜ì—¬ ê¸°ëŠ¥ ì •ìƒ ì‘ë™ í™•ì¸\n2. ë¸Œë¼ìš°ì € ê°œë°œì ë„êµ¬ì—ì„œ ì—ëŸ¬ ì—†ìŒ í™•ì¸\n3. ë°ì´í„°ë² ì´ìŠ¤ ì—°ë™ ë° ì €ì¥ ê¸°ëŠ¥ í™•ì¸` : '';

              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.payload.issue.number,
                body: 'ğŸ‰ **Claude ì‘ì—… ì™„ë£Œ!**\n\nğŸ“‹ **ìµœì¢… ì§„í–‰ ìƒí™©**\n- âœ… ì´ìŠˆ ë¶„ì„ ì™„ë£Œ\n- âœ… ì½”ë“œ ìˆ˜ì • ì™„ë£Œ\n- âœ… PR ìƒì„± ë° ë³‘í•© ì™„ë£Œ\n- â³ ìë™ ë°°í¬ ì§„í–‰ ì¤‘...\n- â¸ï¸ ìš´ì˜ ë°˜ì˜ ëŒ€ê¸° ì¤‘\n\n**ğŸš€ ë³€ê²½ì‚¬í•­ì´ master ë¸Œëœì¹˜ì— ì ìš©ë˜ì—ˆìŠµë‹ˆë‹¤!**' + endpointSection + '\n\n**ğŸ“Š ì‘ì—… ì„¸ë¶€ì‚¬í•­:**\n- **ì™„ë£Œ ì‹œê°„**: ' + currentTime + '\n- **ìë™ ë°°í¬**: Docker ë¹Œë“œ ë° ë ˆì§€ìŠ¤íŠ¸ë¦¬ í‘¸ì‹œ ì¤‘\n- **ì˜ˆìƒ ì™„ë£Œ**: ì•½ 5-10ë¶„ í›„\n\n**ğŸ”— ì°¸ê³  ë§í¬:**\n- [GitHub Actions ë¡œê·¸](' + runUrl + ')\n- [Docker Registry](https://registry.jclee.me)\n\n---\nğŸ¤– *Enhanced Claude Automation System v2.0*'
              });
              
              // ì´ìŠˆ ìë™ ë‹«ê¸°
              await github.rest.issues.update({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.payload.issue.number,
                state: 'closed'
              });
            }

