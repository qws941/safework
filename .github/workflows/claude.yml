name: ğŸ¤– Claude Code Assistant

concurrency:
  group: claude-assistant-${{ github.repository }}
  cancel-in-progress: true

on:
  issue_comment:
    types: [created]
  pull_request_review_comment:
    types: [created]
  issues:
    types: [opened, assigned, labeled]
  pull_request_review:
    types: [submitted]
  pull_request:
    types: [opened, synchronize, ready_for_review, reopened]
  workflow_run:
    workflows: ["ğŸš€ Deploy Pipeline"]
    types: [completed]

permissions:
  contents: write
  pull-requests: write
  issues: write
  checks: write
  actions: write
  security-events: write
  statuses: write
  packages: write
  id-token: write
  deployments: write
  repository-projects: write
  metadata: read

jobs:
  claude:
    if: |
      (github.event_name == 'issue_comment' && contains(github.event.comment.body, '@claude')) ||
      (github.event_name == 'pull_request_review_comment' && contains(github.event.comment.body, '@claude')) ||
      (github.event_name == 'issues' && contains(github.event.issue.labels.*.name, 'claude-actionable')) ||
      (github.event_name == 'pull_request_review' && contains(github.event.review.body, '@claude')) ||
      (github.event_name == 'pull_request' && (contains(github.event.pull_request.title, '[claude]') || contains(github.event.pull_request.body, '@claude'))) ||
      (github.event_name == 'workflow_run' && github.event.workflow_run.conclusion == 'failure')
      
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    steps:
      - name: ğŸ“‚ Checkout Repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0
          
      - name: ğŸ” Context Detection
        id: context
        run: |
          echo "event_type=${{ github.event_name }}" >> $GITHUB_OUTPUT
          echo "repository=SafeWork Flask Application" >> $GITHUB_OUTPUT
          echo "architecture=Independent containers (PostgreSQL, Redis, Flask)" >> $GITHUB_OUTPUT
          echo "services=safework2-postgres:4546, safework2-redis:4547, safework2-app:4545" >> $GITHUB_OUTPUT
          
          if [ "${{ github.event_name }}" = "workflow_run" ]; then
            echo "mode=failure_analysis" >> $GITHUB_OUTPUT
          elif [ "${{ github.event_name }}" = "issues" ]; then
            echo "mode=issue_resolution" >> $GITHUB_OUTPUT
          elif [ "${{ github.event_name }}" = "pull_request" ]; then
            echo "mode=code_review" >> $GITHUB_OUTPUT
          else
            echo "mode=general_assistance" >> $GITHUB_OUTPUT
          fi
          
      - name: ğŸ¤– Claude Code Action
        uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          claude_args: |
            --tool Task
            --tool Read
            --tool Write
            --tool Edit
            --tool Bash
            --tool Grep
            --tool Glob
            --tool WebFetch
            --system "You are Claude Code, an AI assistant integrated with GitHub Actions for the SafeWork Flask application. The project uses independent Docker containers with PostgreSQL database migration from MySQL. Container architecture: safework2-postgres (port 4546), safework2-redis (port 4547), safework2-app (port 4545). Database: safework_db with safework user. Provide solutions in Korean when communicating with users."
          prompt: |
            ğŸ¯ **SafeWork í”„ë¡œì íŠ¸ Claude ì–´ì‹œìŠ¤í„´íŠ¸**
            
            **í”„ë¡œì íŠ¸ ì»¨í…ìŠ¤íŠ¸:**
            - SafeWork Flask ì• í”Œë¦¬ì¼€ì´ì…˜ (ì‚°ì—… ì•ˆì „ ê´€ë¦¬ ì‹œìŠ¤í…œ)
            - ë…ë¦½ì  ì»¨í…Œì´ë„ˆ ì•„í‚¤í…ì²˜: PostgreSQL, Redis, Flask
            - MySQLì—ì„œ PostgreSQLë¡œ ë§ˆì´ê·¸ë ˆì´ì…˜ ì™„ë£Œ
            - ì»¨í…Œì´ë„ˆ êµ¬ì„±: safework2-postgres (4546), safework2-redis (4547), safework2-app (4545)
            - ë°ì´í„°ë² ì´ìŠ¤: safework_db, ì‚¬ìš©ì: safework
            - GitHub Actionsë¥¼ í†µí•œ Portainer API ë°°í¬
            
            **í˜„ì¬ ìƒí™©:**
            - ì´ë²¤íŠ¸ íƒ€ì…: ${{ github.event_name }}
            - ëª¨ë“œ: ${{ steps.context.outputs.mode }}
            - ë¸Œëœì¹˜: ${{ github.ref_name }}
            - ì»¤ë°‹: ${{ github.sha }}
            
            **ì‘ì—… ì§€ì¹¨:**
            
            ğŸ”¥ **ì‹¤íŒ¨ ë¶„ì„ ëª¨ë“œ** (workflow_run failure):
            1. ìµœê·¼ ì›Œí¬í”Œë¡œìš° ì‹¤íŒ¨ ë¡œê·¸ ë¶„ì„
            2. Docker ë¹Œë“œ, PostgreSQL ì—°ê²°, í™˜ê²½ ë³€ìˆ˜ ê²€ì¦
            3. ì¦‰ì‹œ ìˆ˜ì • ë° ì¬ë°°í¬ ì‹¤í–‰
            4. í•œêµ­ì–´ë¡œ ë¬¸ì œì ê³¼ í•´ê²° ê³¼ì • ë³´ê³ 
            
            ğŸ› **ì´ìŠˆ í•´ê²° ëª¨ë“œ** (issues with claude-actionable):
            1. ì´ìŠˆ ë‚´ìš©ì„ ì •í™•íˆ ë¶„ì„
            2. ì½”ë“œ ìˆ˜ì • ë˜ëŠ” ì„¤ì • ë³€ê²½ìœ¼ë¡œ í•´ê²°
            3. í…ŒìŠ¤íŠ¸ ë° ê²€ì¦ ì‹¤í–‰
            4. ì´ìŠˆì— í•´ê²° ê²°ê³¼ ëŒ“ê¸€ ì‘ì„±
            
            ğŸ“ **ì½”ë“œ ë¦¬ë·° ëª¨ë“œ** (pull_request):
            1. PR ë³€ê²½ì‚¬í•­ ìƒì„¸ ê²€í† 
            2. SafeWork í”„ë¡œì íŠ¸ í‘œì¤€ ì¤€ìˆ˜ í™•ì¸
            3. ë³´ì•ˆ, ì„±ëŠ¥, í˜¸í™˜ì„± ê²€ì¦
            4. ê°œì„  ì œì•ˆ ë° ìŠ¹ì¸/ê±°ë¶€ ì˜ê²¬ ì œì‹œ
            
            ğŸ’¬ **ì¼ë°˜ ì§€ì› ëª¨ë“œ** (comments with @claude):
            1. ìš”ì²­ì‚¬í•­ ì •í™•íˆ íŒŒì•…
            2. SafeWork í”„ë¡œì íŠ¸ ë§¥ë½ì—ì„œ ìµœì  ì†”ë£¨ì…˜ ì œê³µ
            3. í•„ìš”ì‹œ ì½”ë“œ ìˆ˜ì • ë° í…ŒìŠ¤íŠ¸ ì‹¤í–‰
            4. ëª…í™•í•˜ê³  ì‹¤ìš©ì ì¸ ë‹µë³€ ì œê³µ
            
            **í•µì‹¬ ì›ì¹™:**
            - í•œêµ­ì–´ë¡œ ì†Œí†µ (ê¸°ìˆ ì  ë‚´ìš© í¬í•¨)
            - ì¦‰ì‹œ ì‹¤í–‰ ê°€ëŠ¥í•œ ì†”ë£¨ì…˜ ì œê³µ
            - SafeWork í”„ë¡œì íŠ¸ ì•„í‚¤í…ì²˜ ì¤€ìˆ˜
            - PostgreSQL ì„¤ì • ë° ë…ë¦½ ì»¨í…Œì´ë„ˆ êµ¬ì¡° ê³ ë ¤
            - ë³´ì•ˆê³¼ ì•ˆì •ì„± ìµœìš°ì„ 
            
            ì‘ì—…ì„ ì‹œì‘í•˜ì„¸ìš”. ì‚¬ìš©ìì˜ ìš”êµ¬ì‚¬í•­ì„ ì •í™•íˆ íŒŒì•…í•˜ê³  ìµœì ì˜ ì†”ë£¨ì…˜ì„ ì œê³µí•´ì£¼ì„¸ìš”.