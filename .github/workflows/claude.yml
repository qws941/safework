name: Claude Code

on:
  issue_comment:
    types: [created]
  issues:
    types: [opened, labeled]
  schedule:
    # 매 30분마다 열린 이슈 자동 감지
    - cron: '*/30 * * * *'
  workflow_dispatch:

jobs:
  claude:
    if: |
      (github.event_name == 'issue_comment' && contains(github.event.comment.body, '@claude')) ||
      (github.event_name == 'issues' && (contains(github.event.issue.body, '@claude') || !contains(github.event.issue.body, '@claude'))) ||
      github.event_name == 'schedule' ||
      github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    permissions:
      contents: write
      issues: write
      pull-requests: write
    
    steps:
      - name: 🔍 열린 이슈 자동 감지 및 Claude 할당
        if: github.event_name == 'schedule' || github.event_name == 'workflow_dispatch'
        uses: actions/github-script@v7
        with:
          script: |
            const { owner, repo } = context.repo;
            
            // 열린 이슈 중 @claude 없는 것 찾기
            const openIssues = await github.rest.issues.listForRepo({
              owner,
              repo,
              state: 'open',
              per_page: 10
            });
            
            for (const issue of openIssues.data) {
              // PR은 제외
              if (issue.pull_request) continue;
              
              // 이미 @claude가 있는지 확인
              const comments = await github.rest.issues.listComments({
                owner,
                repo,
                issue_number: issue.number
              });
              
              const hasClaudeComment = comments.data.some(comment => 
                comment.body.includes('@claude')
              );
              
              const hasClaudeInBody = issue.body && issue.body.includes('@claude');
              
              // @claude가 없다면 댓글 추가
              if (!hasClaudeComment && !hasClaudeInBody) {
                await github.rest.issues.createComment({
                  owner,
                  repo,
                  issue_number: issue.number,
                  body: `🤖 **자동 감지**: 이 이슈를 @claude가 분석하고 해결하겠습니다.
                  
**SafeWork 시스템 개선 요청**
- 이슈를 분석하고 실제 코드를 수정해 주세요
- Flask 패턴과 기존 스타일을 유지해 주세요  
- 작업 완료 후 커밋하고 이슈를 닫아주세요

@claude 지금 바로 이 이슈를 해결해 주세요! 🚀`
                });
                
                console.log(`✅ 이슈 #${issue.number}에 Claude 자동 할당`);
              }
            }

      - uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          claude_args: "--max-turns 0"

