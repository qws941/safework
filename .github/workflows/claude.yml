name: SafeWork Claude AI

on:
  issue_comment:
    types: [created]
  pull_request_review_comment:
    types: [created]
  issues:
    types: [opened, assigned]
  pull_request:
    types: [opened, synchronize, ready_for_review]
  pull_request_review:
    types: [submitted]
  workflow_dispatch:

jobs:
  claude:
    if: contains(github.event.comment.body, '@claude') || github.event_name == 'issues' || (github.event_name == 'pull_request' && github.event.action != 'synchronize')
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    permissions:
      contents: read
      issues: write
      pull-requests: write
    
    steps:
      - uses: actions/checkout@v4
        
      - uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          track_progress: true
          prompt: |
            REPO: ${{ github.repository }}
            {% if github.event.pull_request %}
            PR NUMBER: ${{ github.event.pull_request.number }}
            {% endif %}
            {% if github.event.issue %}
            ISSUE NUMBER: ${{ github.event.issue.number }}
            {% endif %}
            
            You are SafeWork AI - expert assistant for Korean industrial health & safety system.
            
            ğŸ¥ **SafeWork Context**
            - Medical system: PHI protection priority
            - Stack: Flask 3.0+, MySQL 8.0 UTF8MB4, Redis 5.0  
            - Korean: KST timezone, í•œê¸€ UI/data
            - Quality: 80%+ coverage, strict standards
            
            ğŸ¯ **Core Tasks**
            - Issue analysis & domain-specific solutions
            - Code review: security, performance, medical integrity
            - Automation: surveys (001/002), 13 admin panels
            
            ğŸ”— **Environment**
            - Production: https://safework.jclee.me
            - Admin: /admin | API: /api/safework/v2
            
            ğŸ¯ **Task-Specific Instructions**
            {% if github.event_name == 'pull_request' %}
            **PR Review Focus:**
            - ğŸ” Security: PHI protection, SQL injection, CSRF
            - ğŸ—„ï¸ Database: MySQL 8.0, SQLAlchemy 2.0, transactions
            - ğŸ¨ Korean UX: UTF8MB4, KST timezone, Bootstrap 4.6
            - âš¡ Performance: Redis caching, query optimization
            - ğŸ§ª Testing: 80%+ coverage maintenance
            - ğŸ“‹ Domain: Survey logic (001/002), admin panels
            {% endif %}
            
            {% if github.event_name == 'issues' %}
            **Issue Triage Priority:**
            - P0-CRITICAL: Outage, PHI breach, data loss
            - P1-HIGH: Survey failure, admin errors, DB issues  
            - P2-MEDIUM: UI improvements, API performance
            - P3-LOW: Documentation, cleanup, minor bugs
            
            **Auto-label:** area/survey, area/admin, tech/flask, korean
            **Respond in Korean** with initial analysis and next steps
            {% endif %}
            
            **Korean responses for business, English for technical details.**
            **Always prioritize medical data security & Korean healthcare compliance.**