name: Claude Code

on:
  issue_comment:
    types: [created]
  issues:
    types: [opened]
  pull_request:
    types: [opened, synchronize, reopened]
  workflow_dispatch:

jobs:
  claude:
    if: |
      github.event_name == 'workflow_dispatch' ||
      (github.event_name == 'issue_comment' && contains(github.event.comment.body, '@claude')) ||
      (github.event_name == 'issues' && github.event.action == 'opened') ||
      (github.event_name == 'pull_request' && contains(fromJSON('["opened", "synchronize", "reopened"]'), github.event.action))
    runs-on: ubuntu-latest
    timeout-minutes: 30
    permissions:
      contents: write
      issues: write
      pull-requests: write
      actions: read
      checks: read
      statuses: read
      deployments: read
      packages: read
      id-token: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Enhanced Claude Code Assistant  
        uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          use_sticky_comment: true
          prompt: |
            ë‹¹ì‹ ì€ SafeWork í”„ë¡œì íŠ¸ì˜ **ì‹œë‹ˆì–´ í’€ìŠ¤íƒ ê°œë°œì**ì…ë‹ˆë‹¤.

            ## ğŸ—ï¸ í”„ë¡œì íŠ¸ ì•„í‚¤í…ì²˜
            **SafeWork**: ì‚°ì—… ì•ˆì „ ë³´ê±´ ê´€ë¦¬ ì‹œìŠ¤í…œ (Flask 3.0+)
            - **ë°±ì—”ë“œ**: Python Flask, SQLAlchemy 2.0, Redis 5.0  
            - **ë°ì´í„°ë² ì´ìŠ¤**: MySQL 8.0 (UTF8MB4, íŠ¸ëœì­ì…˜ ê´€ë¦¬)
            - **í”„ë¡ íŠ¸ì—”ë“œ**: Bootstrap 4.6, jQuery, Font Awesome
            - **í•µì‹¬ ê¸°ëŠ¥**: ê·¼ê³¨ê²©ê³„ ì„¤ë¬¸ì¡°ì‚¬, ê±´ê°•ê²€ì§„, ë¬¸ì„œê´€ë¦¬, ê´€ë¦¬ì íŒ¨ë„

            ## ğŸ“‹ ê°œë°œ ì›ì¹™ (í•„ìˆ˜ ì¤€ìˆ˜)
            1. **í•œêµ­ì–´ ì†Œí†µ**: ëª¨ë“  ëŒ“ê¸€ê³¼ ì»¤ë°‹ ë©”ì‹œì§€ëŠ” í•œêµ­ì–´
            2. **Flask íŒ¨í„´ ì¤€ìˆ˜**: ë¸”ë£¨í”„ë¦°íŠ¸ êµ¬ì¡°, íŒ©í† ë¦¬ íŒ¨í„´ ìœ ì§€
            3. **ë°ì´í„°ë² ì´ìŠ¤ ë¬´ê²°ì„±**: 
               - íŠ¸ëœì­ì…˜ ì‚¬ìš© (`db.session.commit()`, `rollback()`)
               - ë§ˆì´ê·¸ë ˆì´ì…˜ ìƒì„± ì‹œ MySQL 8.0 í˜¸í™˜ì„± í™•ì¸
               - í•œêµ­ ì‹œê°„ëŒ€(KST) ì¼ê´€ì„±: `kst_now()` í•¨ìˆ˜ ì‚¬ìš©
            4. **ë³´ì•ˆ ê°•í™”**: 
               - CSRF í† í° í•„ìˆ˜
               - SQL ì¸ì ì…˜ ë°©ì–´
               - ì…ë ¥ ë°ì´í„° ê²€ì¦ ë° ì‚¬ë‹ˆíƒ€ì´ì§•
            5. **ì„±ëŠ¥ ìµœì í™”**: 
               - Redis ìºì‹± í™œìš©
               - ë°ì´í„°ë² ì´ìŠ¤ ì¸ë±ì‹±
               - ì¿¼ë¦¬ ìµœì í™”

            ## ğŸ”§ ì½”ë”© ì»¨ë²¤ì…˜
            ```python
            # âœ… ì˜¬ë°”ë¥¸ íŒ¨í„´
            @login_required
            def create_survey():
                try:
                    # ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§
                    db.session.commit()
                    flash('ì„¤ë¬¸ì´ ì„±ê³µì ìœ¼ë¡œ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success')
                except Exception as e:
                    db.session.rollback()
                    flash(f'ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: {str(e)}', 'error')
                    app.logger.error(f"Survey creation error: {e}")
            ```

            ## ğŸ¯ ì´ìŠˆ í•´ê²° í”„ë¡œì„¸ìŠ¤
            ### 1ë‹¨ê³„: ë¶„ì„
            - ì´ìŠˆ ë‚´ìš© ì •í™•íˆ íŒŒì•…
            - ê´€ë ¨ íŒŒì¼ë“¤ ì‹ë³„ (`app/routes/`, `app/models.py`, `app/templates/`)
            - í˜„ì¬ êµ¬í˜„ ìƒíƒœ í™•ì¸

            ### 2ë‹¨ê³„: êµ¬í˜„
            - ê¸°ì¡´ ì½”ë“œ íŒ¨í„´ ìœ ì§€
            - ë‹¨ê³„ë³„ ë³€ê²½ì‚¬í•­ ì ìš©
            - ì—ëŸ¬ ì²˜ë¦¬ ë° ë¡œê¹… ì¶”ê°€

            ### 3ë‹¨ê³„: ê²€ì¦
            - ì½”ë“œ ë¦¬ë·° ë° í…ŒìŠ¤íŠ¸
            - ë§ˆì´ê·¸ë ˆì´ì…˜ í•„ìš” ì‹œ ìƒì„±
            - ì˜ë¯¸ìˆëŠ” ì»¤ë°‹ ë©”ì‹œì§€ ì‘ì„±

            ### 4ë‹¨ê³„: ì™„ë£Œ
            - ë³€ê²½ì‚¬í•­ ìš”ì•½ ëŒ“ê¸€
            - **ì´ìŠˆ ìë™ ë‹«ê¸°** (ì¤‘ìš”!)

            ## ğŸ“ ì£¼ìš” íŒŒì¼ êµ¬ì¡°
            ```
            app/
            â”œâ”€â”€ app.py              # ë©”ì¸ ì• í”Œë¦¬ì¼€ì´ì…˜
            â”œâ”€â”€ models.py           # í•µì‹¬ ëª¨ë¸ (User, Survey)
            â”œâ”€â”€ models_safework.py  # SafeWork ì „ìš© ëª¨ë¸
            â”œâ”€â”€ routes/            # ë¸”ë£¨í”„ë¦°íŠ¸ ë¼ìš°í„°
            â”‚   â”œâ”€â”€ survey.py      # ì„¤ë¬¸ì¡°ì‚¬ (001/002)
            â”‚   â”œâ”€â”€ admin.py       # ê´€ë¦¬ì íŒ¨ë„
            â”‚   â””â”€â”€ auth.py        # ì¸ì¦
            â””â”€â”€ templates/         # Jinja2 í…œí”Œë¦¿
            ```

            ## âš¡ ì‘ì—… ì™„ë£Œ ì²´í¬ë¦¬ìŠ¤íŠ¸
            - [ ] ê¸°ëŠ¥ êµ¬í˜„ ì™„ë£Œ
            - [ ] ì—ëŸ¬ ì²˜ë¦¬ ì¶”ê°€
            - [ ] í…ŒìŠ¤íŠ¸ ì‹¤í–‰ (ê°€ëŠ¥í•œ ê²½ìš°)
            - [ ] ì»¤ë°‹ ë©”ì‹œì§€ ì‘ì„± ("feat:", "fix:", "refactor:" ë“±)
            - [ ] ì´ìŠˆì— ì™„ë£Œ ëŒ“ê¸€ ì‘ì„±
            - [ ] **ì´ìŠˆ ìƒíƒœë¥¼ 'closed'ë¡œ ë³€ê²½**

            ì‘ì—…ì„ ì‹œì‘í•˜ì„¸ìš”! ğŸš€
          claude_args: |
            --max-turns 30

      - name: Advanced Auto PR and Merge
        if: success()
        uses: actions/github-script@v7
        with:
          script: |
            const { owner, repo } = context.repo;
            const issueNumber = context.payload.issue?.number;
            const issueTitle = context.payload.issue?.title || 'ìë™ ìˆ˜ì •';
            
            console.log(`ğŸš€ ê³ ë„í™”ëœ ìë™ PR/ë³‘í•© í”„ë¡œì„¸ìŠ¤ ì‹œì‘`);
            console.log(`ğŸ“‹ ì´ìŠˆ: #${issueNumber} - ${issueTitle}`);
            
            // 1. Claude ë¸Œëœì¹˜ ìŠ¤ë§ˆíŠ¸ ê²€ìƒ‰ (ì—¬ëŸ¬ íŒ¨í„´ ì§€ì›)
            async function findClaudeBranches() {
              const branches = await github.rest.repos.listBranches({
                owner,
                repo,
                per_page: 100
              });
              
              const today = new Date().toISOString().slice(0, 10).replace(/-/g, '');
              const patterns = [
                `claude/issue-${issueNumber}-`,
                `claude/issue-${today}`,
                `claude/`,
              ];
              
              return branches.data.filter(branch => 
                patterns.some(pattern => branch.name.includes(pattern)) &&
                branch.name !== 'master' && branch.name !== 'main'
              ).sort((a, b) => b.commit.commit.author.date.localeCompare(a.commit.commit.author.date));
            }
            
            // 2. PR ì¶©ëŒ ê²€ì‚¬
            async function checkForConflicts(branchName) {
              try {
                const comparison = await github.rest.repos.compareCommits({
                  owner,
                  repo,
                  base: 'master',
                  head: branchName
                });
                
                return {
                  hasConflicts: comparison.data.status === 'diverged',
                  ahead: comparison.data.ahead_by,
                  behind: comparison.data.behind_by,
                  files: comparison.data.files?.length || 0
                };
              } catch (error) {
                console.error('âš ï¸ ì¶©ëŒ ê²€ì‚¬ ì‹¤íŒ¨:', error.message);
                return { hasConflicts: false, ahead: 0, behind: 0, files: 0 };
              }
            }
            
            // 3. ê¸°ì¡´ PR í™•ì¸
            async function checkExistingPR(branchName) {
              try {
                const prs = await github.rest.pulls.list({
                  owner,
                  repo,
                  head: `${owner}:${branchName}`,
                  state: 'open'
                });
                return prs.data[0] || null;
              } catch (error) {
                return null;
              }
            }
            
            try {
              const claudeBranches = await findClaudeBranches();
              
              if (claudeBranches.length === 0) {
                console.log(`âš ï¸ Claude ë¸Œëœì¹˜ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤`);
                return;
              }
              
              const branchName = claudeBranches[0].name;
              console.log(`ğŸ” ìµœì‹  Claude ë¸Œëœì¹˜ ë°œê²¬: ${branchName}`);
              
              // ê¸°ì¡´ PR í™•ì¸
              const existingPR = await checkExistingPR(branchName);
              if (existingPR) {
                console.log(`â„¹ï¸ ê¸°ì¡´ PR ë°œê²¬: #${existingPR.number}, ë³‘í•© ì‹œë„`);
                
                // ê¸°ì¡´ PR ë³‘í•©
                try {
                  await github.rest.pulls.merge({
                    owner,
                    repo,
                    pull_number: existingPR.number,
                    commit_title: `ğŸ¤– Claude: ${issueTitle}`,
                    commit_message: `ì´ìŠˆ #${issueNumber} í•´ê²°\n\nClaudeê°€ ìë™ìœ¼ë¡œ ìƒì„±í•œ ë³€ê²½ì‚¬í•­ì…ë‹ˆë‹¤.`,
                    merge_method: 'squash'
                  });
                  
                  console.log(`âœ… ê¸°ì¡´ PR #${existingPR.number} ë³‘í•© ì™„ë£Œ`);
                } catch (mergeError) {
                  console.error(`âŒ ê¸°ì¡´ PR ë³‘í•© ì‹¤íŒ¨:`, mergeError.message);
                  return;
                }
              } else {
                // ì¶©ëŒ ê²€ì‚¬
                const conflictCheck = await checkForConflicts(branchName);
                console.log(`ğŸ“Š ë¸Œëœì¹˜ ìƒíƒœ: ${conflictCheck.files}ê°œ íŒŒì¼, ${conflictCheck.ahead}ê°œ ì»¤ë°‹ ì•ì„°ìŒ`);
                
                if (conflictCheck.hasConflicts) {
                  console.log(`âš ï¸ ì¶©ëŒ ê°ì§€ë¨, ìˆ˜ë™ ì²˜ë¦¬ í•„ìš”`);
                  
                  // ì¶©ëŒ ì•Œë¦¼ ëŒ“ê¸€
                  await github.rest.issues.createComment({
                    owner,
                    repo,
                    issue_number: issueNumber,
                    body: `âš ï¸ **ìë™ ë³‘í•© ì‹¤íŒ¨**: ë¸Œëœì¹˜ \\`${branchName}\\`ì—ì„œ ì¶©ëŒì´ ê°ì§€ë˜ì—ˆìŠµë‹ˆë‹¤.\\n\\n**ìˆ˜ë™ ì²˜ë¦¬ í•„ìš”:**\\n1. [ë¸Œëœì¹˜ í™•ì¸](https://github.com/${owner}/${repo}/tree/${branchName})\\n2. ì¶©ëŒ í•´ê²° í›„ ìˆ˜ë™ ë³‘í•©\\n3. ë˜ëŠ” ë¸Œëœì¹˜ë¥¼ ì‚­ì œí•˜ê³  ë‹¤ì‹œ ì‹œë„\\n\\n**ë¸Œëœì¹˜ ìƒíƒœ:** ${conflictCheck.files}ê°œ íŒŒì¼ ìˆ˜ì •, ${conflictCheck.ahead}ê°œ ì»¤ë°‹`
                  });
                  return;
                }
                
                // ìƒˆ PR ìƒì„±
                const prResponse = await github.rest.pulls.create({
                  owner,
                  repo,
                  title: `ğŸ¤– Claude: ${issueTitle}`,
                  head: branchName,
                  base: 'master',
                  body: `ğŸ¤– **Claude ìë™ ìƒì„± PR**\\n\\n**ğŸ“‹ ì´ìŠˆ:** #${issueNumber}\\n**ğŸŒ¿ ë¸Œëœì¹˜:** \\`${branchName}\\`\\n**â° ìƒì„± ì‹œê°„:** ${new Date().toLocaleString('ko-KR')}\\n**ğŸ“Š ë³€ê²½ì‚¬í•­:** ${conflictCheck.files}ê°œ íŒŒì¼, ${conflictCheck.ahead}ê°œ ì»¤ë°‹\\n\\n## ğŸ”„ ìë™í™” í”„ë¡œì„¸ìŠ¤\\n- âœ… ì¶©ëŒ ê²€ì‚¬ í†µê³¼\\n- âœ… ë¸Œëœì¹˜ ìƒíƒœ ê²€ì¦ ì™„ë£Œ\\n- ğŸ”„ ìë™ ë³‘í•© ì˜ˆì •\\n\\n---\\n*ğŸ¤– Generated by Enhanced Claude Code Assistant*`
                });
                
                console.log(`âœ… ìƒˆ PR ìƒì„± ì™„ë£Œ: #${prResponse.data.number}`);
                
                // PR ìƒíƒœ ì•ˆì •í™” ëŒ€ê¸°
                await new Promise(resolve => setTimeout(resolve, 3000));
                
                // ìë™ ë³‘í•©
                await github.rest.pulls.merge({
                  owner,
                  repo,
                  pull_number: prResponse.data.number,
                  commit_title: `ğŸ¤– Claude: ${issueTitle}`,
                  commit_message: `ì´ìŠˆ #${issueNumber} í•´ê²°\n\nClaudeê°€ ìë™ìœ¼ë¡œ ë¶„ì„í•˜ê³  ìˆ˜ì •í•œ ë³€ê²½ì‚¬í•­ì…ë‹ˆë‹¤.\n\në³€ê²½ íŒŒì¼: ${conflictCheck.files}ê°œ\nì»¤ë°‹: ${conflictCheck.ahead}ê°œ`,
                  merge_method: 'squash'
                });
                
                console.log(`âœ… ìë™ ë³‘í•© ì™„ë£Œ`);
              }
              
              // ë¸Œëœì¹˜ ì •ë¦¬
              await github.rest.git.deleteRef({
                owner,
                repo,
                ref: `heads/${branchName}`
              });
              
              console.log(`ğŸ—‘ï¸ ë¸Œëœì¹˜ ì‚­ì œ ì™„ë£Œ: ${branchName}`);
              
              // ì„±ê³µ ëŒ“ê¸€
              if (issueNumber) {
                await github.rest.issues.createComment({
                  owner,
                  repo,
                  issue_number: issueNumber,
                  body: `âœ… **ìë™ ì²˜ë¦¬ ì™„ë£Œ!**\\n\\nğŸ¤– Claudeê°€ ì´ìŠˆë¥¼ ì„±ê³µì ìœ¼ë¡œ í•´ê²°í–ˆìŠµë‹ˆë‹¤.\\n- ë¸Œëœì¹˜: \\`${branchName}\\`\\n- PR ìƒì„± ë° ë³‘í•© ì™„ë£Œ\\n- ë¸Œëœì¹˜ ì •ë¦¬ ì™„ë£Œ\\n\\në³€ê²½ì‚¬í•­ì´ main ë¸Œëœì¹˜ì— ì ìš©ë˜ì—ˆìŠµë‹ˆë‹¤. ğŸ‰`
                });
                
                // ì´ìŠˆ ìë™ ë‹«ê¸°
                await github.rest.issues.update({
                  owner,
                  repo,
                  issue_number: issueNumber,
                  state: 'closed'
                });
                
                console.log(`ğŸ”’ ì´ìŠˆ #${issueNumber} ìë™ ë‹«ê¸° ì™„ë£Œ`);
              }
              
            } catch (error) {
              console.error(`âŒ ê³ ë„í™”ëœ ìë™ ì²˜ë¦¬ ì‹¤íŒ¨:`, error);
              
              // ì‹¤íŒ¨ ì‹œ ì•Œë¦¼
              if (issueNumber) {
                await github.rest.issues.createComment({
                  owner,
                  repo,
                  issue_number: issueNumber,
                  body: `âŒ **ìë™ ì²˜ë¦¬ ì‹¤íŒ¨**\\n\\nì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: \\`${error.message}\\`\\n\\n**ë‹¤ìŒ ë‹¨ê³„:**\\n1. GitHub Actions ë¡œê·¸ í™•ì¸\\n2. ìˆ˜ë™ìœ¼ë¡œ ë¸Œëœì¹˜ í™•ì¸ ë° ì²˜ë¦¬\\n3. í•„ìš”ì‹œ ì´ìŠˆ ì¬í• ë‹¹\\n\\n*ì˜¤ë¥˜ ì‹œê°„: ${new Date().toLocaleString('ko-KR')}*`
                });
              }
            }

