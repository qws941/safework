# ==============================================================================
# Production CI/CD Pipeline
# ==============================================================================
# This workflow implements a complete CI/CD pipeline for production:
# 1. AI Code Review: On every PR to 'master', Gemini reviews code changes.
# 2. Build & Test: Runs unit tests, linting, and type checking.
# 3. Deploy to Production: Deploys to production on pushes to 'master' branch.
# 4. Post-Deployment Tests: Runs integration tests against live production.
# ==============================================================================

name: Production CI/CD

on:
  push:
    branches: [master]
    paths:
      - 'workers/**'
      - '.github/workflows/cloudflare-workers-deployment.yml'
  pull_request:
    branches: [master]
    paths:
      - 'workers/**'
      - '.github/workflows/cloudflare-workers-deployment.yml'
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write

env:
  CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
  CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
  NODE_VERSION: '20'

jobs:
  # ============================================
  # 1. AI Code Review Job (on Pull Requests to master)
  # ============================================
  ai-code-review:
    name: 'ğŸ¤– AI Code Review'
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ” Get Changed Files
        id: changed-files
        uses: tj-actions/changed-files@v41
        with:
          files: workers/**

      - name: ğŸ¤– Run Gemini Code Review
        if: steps.changed-files.outputs.any_changed == 'true'
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const { repo, issue: { number: issue_number } } = github.context;
            const diff_url = `${{ github.event.pull_request.diff_url }}`;
            const response = await fetch(diff_url);
            const diff = await response.text();

            if (diff.length > 10000) return; // Skip if diff is too large

            const prompt = "As a senior software engineer, please review the following code changes (git diff format). Focus on potential bugs, performance issues, and best practices. Provide specific, actionable feedback. If no issues, state 'No issues found.'\n\nGit Diff:\n\n" + diff;

            const geminiApiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-latest:generateContent?key=${{ secrets.GEMINI_API_KEY }}`;
            const geminiResponse = await fetch(geminiApiUrl, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
            });

            const geminiData = await geminiResponse.json();
            const review = geminiData.candidates[0].content.parts[0].text;

            await github.rest.issues.createComment({ ...repo, issue_number, body: `### ğŸ¤– Gemini AI Code Review\n\n${review}` });

  # ============================================
  # 2. Build and Test Job (Unit Tests Only)
  # ============================================
  build-and-test:
    name: 'ğŸ—ï¸ Build & Test'
    runs-on: ubuntu-latest
    timeout-minutes: 10
    defaults: { run: { working-directory: ./workers } }
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: 'workers/package-lock.json'
      - run: npm ci
      - run: npm run lint
      - run: npm run type-check
      - name: ğŸ§ª Run Unit Tests
        id: test
        run: npm run test:unit

      - name: ğŸ“¢ Slack - Test Results
        if: always()
        continue-on-error: true
        uses: slackapi/slack-github-action@v1
        with:
          payload: |
            {
              "text": "${{ steps.test.outcome == 'success' && 'âœ…' || 'âŒ' }} SafeWork í…ŒìŠ¤íŠ¸ ê²°ê³¼",
              "blocks": [
                {
                  "type": "header",
                  "text": {
                    "type": "plain_text",
                    "text": "${{ steps.test.outcome == 'success' && 'âœ… í…ŒìŠ¤íŠ¸ í†µê³¼' || 'âŒ í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨' }}"
                  }
                },
                {
                  "type": "section",
                  "fields": [
                    {
                      "type": "mrkdwn",
                      "text": "*ë¸Œëœì¹˜:*\n${{ github.ref_name }}"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*ì»¤ë°‹:*\n`${{ github.sha }}`.substring(0, 7)
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*íŠ¸ë¦¬ê±°:*\n${{ github.event_name }}"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*ì‘ì„±ì:*\n${{ github.actor }}"
                    }
                  ]
                },
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "<${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|ì›Œí¬í”Œë¡œìš° ë¡œê·¸ ë³´ê¸°>"
                  }
                }
              ]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          SLACK_WEBHOOK_TYPE: INCOMING_WEBHOOK

  # ============================================
  # 3. Deploy to Production Job
  # ============================================
  deploy-production:
    name: 'ğŸš€ Deploy to Production'
    needs: build-and-test
    if: github.ref == 'refs/heads/master' && github.event_name == 'push'
    runs-on: ubuntu-latest
    timeout-minutes: 15
    environment: { name: production, url: https://safework.jclee.me }
    defaults: { run: { working-directory: ./workers } }
    steps:
      - uses: actions/checkout@v4
        with: { fetch-depth: 0 }
      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: 'workers/package-lock.json'
      - run: npm ci
      - name: ğŸ“¢ Slack - Deployment Started
        if: always()
        continue-on-error: true
        uses: slackapi/slack-github-action@v1
        with:
          payload: |
            {
              "text": "ğŸš€ SafeWork ë°°í¬ ì‹œì‘",
              "blocks": [
                {
                  "type": "header",
                  "text": {
                    "type": "plain_text",
                    "text": "ğŸš€ SafeWork ë°°í¬ ì‹œì‘"
                  }
                },
                {
                  "type": "section",
                  "fields": [
                    {
                      "type": "mrkdwn",
                      "text": "*í™˜ê²½:*\nProduction"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*ë°°í¬ì:*\n${{ github.actor }}"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*ë¸Œëœì¹˜:*\n${{ github.ref_name }}"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*ì»¤ë°‹:*\n<${{ github.event.head_commit.url }}|${{ github.sha }}>".substring(0, 50)
                    }
                  ]
                },
                {
                  "type": "context",
                  "elements": [
                    {
                      "type": "mrkdwn",
                      "text": "ğŸ“ ë©”ì‹œì§€: ${{ github.event.head_commit.message }}"
                    }
                  ]
                }
              ]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          SLACK_WEBHOOK_TYPE: INCOMING_WEBHOOK

      - name: ğŸš€ Deploy to Production
        id: deploy
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          workingDirectory: workers
          command: deploy

      - name: ğŸ“Š Apply D1 Database Schema
        id: d1-schema
        continue-on-error: true  # Don't fail deployment if schema already exists
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        run: |
          echo "Applying D1 database schema..."
          npx wrangler d1 execute PRIMARY_DB --file=d1-schema.sql --remote || echo "Schema application failed (tables may already exist)"

      - name: ğŸ” Verify Production Deployment
        id: health-check
        run: |
          sleep 15
          health_status=$(curl -s -o /dev/null -w "%{http_code}" https://safework.jclee.me/api/health)
          if [ "$health_status" -ne 200 ]; then
            echo "âŒ Health check FAILED with status $health_status."
            exit 1
          fi
          echo "âœ… Health check passed with status $health_status."

      - name: ğŸ“¢ Slack - Deployment Success
        if: success()
        continue-on-error: true
        uses: slackapi/slack-github-action@v1
        with:
          payload: |
            {
              "text": "âœ… SafeWork ë°°í¬ ì„±ê³µ",
              "blocks": [
                {
                  "type": "header",
                  "text": {
                    "type": "plain_text",
                    "text": "âœ… ë°°í¬ ì„±ê³µ"
                  }
                },
                {
                  "type": "section",
                  "fields": [
                    {
                      "type": "mrkdwn",
                      "text": "*í™˜ê²½:*\nProduction"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*ë°°í¬ì:*\n${{ github.actor }}"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*ë¸Œëœì¹˜:*\n${{ github.ref_name }}"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*ì»¤ë°‹:*\n`${{ github.sha }}`.substring(0, 7)
                    }
                  ]
                },
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "*URL:* <https://safework.jclee.me|https://safework.jclee.me>"
                  }
                },
                {
                  "type": "context",
                  "elements": [
                    {
                      "type": "mrkdwn",
                      "text": "ğŸ‰ Health check í†µê³¼ | â±ï¸ ë°°í¬ ì™„ë£Œ"
                    }
                  ]
                }
              ]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          SLACK_WEBHOOK_TYPE: INCOMING_WEBHOOK

      - name: ğŸ“¢ Slack - Deployment Failure
        if: failure()
        continue-on-error: true
        uses: slackapi/slack-github-action@v1
        with:
          payload: |
            {
              "text": "âŒ SafeWork ë°°í¬ ì‹¤íŒ¨",
              "blocks": [
                {
                  "type": "header",
                  "text": {
                    "type": "plain_text",
                    "text": "âŒ ë°°í¬ ì‹¤íŒ¨"
                  }
                },
                {
                  "type": "section",
                  "fields": [
                    {
                      "type": "mrkdwn",
                      "text": "*í™˜ê²½:*\nProduction"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*ë°°í¬ì:*\n@${{ github.actor }}"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*ë¸Œëœì¹˜:*\n${{ github.ref_name }}"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*ì›Œí¬í”Œë¡œìš°:*\n<${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|ì‹¤íŒ¨ ë¡œê·¸ í™•ì¸>"
                    }
                  ]
                },
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "âš ï¸ ì¦‰ì‹œ í™•ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤!"
                  }
                }
              ],
              "attachments": [
                {
                  "color": "danger",
                  "footer": "SafeWork CI/CD",
                  "ts": ${{ github.event.repository.pushed_at }}
                }
              ]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          SLACK_WEBHOOK_TYPE: INCOMING_WEBHOOK


  # ============================================
  # 5. Post-Deployment Verification Tests
  # ============================================
  post-deployment-verification:
    name: 'ğŸ” Post-Deployment Tests'
    needs: deploy-production
    if: github.ref == 'refs/heads/master' && github.event_name == 'push'
    runs-on: ubuntu-latest
    timeout-minutes: 10
    defaults: { run: { working-directory: ./workers } }
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: 'workers/package-lock.json'
      - run: npm ci
      - name: ğŸ§ª Run Post-Deployment Integration Tests
        run: npm run test:post-deploy
      - name: âœ… Verification Complete
        run: echo "âœ… All post-deployment tests passed successfully!"
