name: Cloudflare Workers Deployment

on:
  push:
    branches: [master]
    paths:
      - 'workers/**'
  workflow_dispatch:

env:
  CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
  CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}

jobs:
  deploy-workers:
    name: ğŸš€ Deploy Cloudflare Workers
    runs-on: ubuntu-latest
    timeout-minutes: 10

    defaults:
      run:
        working-directory: ./workers

    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4

      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: 'workers/package-lock.json'

      - name: ğŸ“¦ Install Dependencies
        run: npm ci

      - name: ğŸ”§ Setup Wrangler
        run: npm install -g wrangler@latest

      - name: ğŸš€ Deploy to Cloudflare Workers
        run: |
          echo "ğŸš€ Deploying SafeWork Workers to Cloudflare..."

          # Deploy to production
          npx wrangler deploy --env production

          echo "âœ… Cloudflare Workers deployment completed"

      - name: ğŸ” Verify Deployment
        run: |
          echo "ğŸ” Verifying Workers deployment..."

          sleep 10  # Wait for propagation

          # Test health endpoints
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ¥ Health Checks"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

          health=$(curl -s https://safework.jclee.me/api/health)
          if echo "$health" | grep -q "healthy"; then
            echo "âœ… Workers Health: OK"
          else
            echo "âŒ Workers Health: FAILED"
          fi

          native_health=$(curl -s https://safework.jclee.me/api/native/native/health)
          if echo "$native_health" | grep -q "d1"; then
            echo "âœ… Native Services Health: OK"
            echo "$native_health" | jq -r '.services | to_entries[] | "  - \(.key): \(.value.status)"' || true
          else
            echo "âš ï¸ Native Services Health: Check required"
          fi

          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸŒ Endpoint Tests"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

          # Test main endpoints
          for endpoint in "/" "/admin" "/api/native/files"; do
            echo "ğŸ” Testing: $endpoint"
            status=$(curl -s -o /dev/null -w "%{http_code}" -m 10 "https://safework.jclee.me$endpoint" || echo "000")

            if [ "$status" = "200" ] || [ "$status" = "302" ]; then
              echo "âœ… $endpoint: HTTP $status"
            else
              echo "âš ï¸ $endpoint: HTTP $status"
            fi
          done

      - name: ğŸ“Š Deployment Summary
        if: always()
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ“Š Cloudflare Workers Deployment Summary"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

          if [ "${{ job.status }}" == "success" ]; then
            echo "âœ… Status: WORKERS DEPLOYMENT SUCCESSFUL"
            echo "ğŸŒ Workers URL: https://safework.jclee.me"
            echo "ğŸ“… Deploy Time: $(date '+%Y-%m-%d %H:%M:%S UTC')"
            echo "ğŸš€ Method: Cloudflare Wrangler"
            echo "ğŸ—ï¸ Build Number: ${{ github.run_number }}"
            echo ""
            echo "ğŸ” Key Endpoints:"
            echo "  â€¢ 001 Survey: https://safework.jclee.me/survey/001_musculoskeletal_symptom_survey"
            echo "  â€¢ 002 Admin Dashboard: https://safework.jclee.me/survey/002_musculoskeletal_symptom_program"
            echo "  â€¢ Health: https://safework.jclee.me/api/health"
          else
            echo "âŒ Status: WORKERS DEPLOYMENT FAILED"
            echo "ğŸ“… Failure Time: $(date '+%Y-%m-%d %H:%M:%S UTC')"
            echo "ğŸ” Check logs: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          fi

          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"