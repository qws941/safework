name: Cloudflare Workers Deployment

on:
  push:
    branches: [master]
    paths:
      - 'workers/**'
  workflow_dispatch:

env:
  CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
  CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}

jobs:
  deploy-workers:
    name: ğŸš€ Deploy Cloudflare Workers
    runs-on: ubuntu-latest
    timeout-minutes: 10

    defaults:
      run:
        working-directory: ./workers

    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4

      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: 'workers/package-lock.json'

      - name: ğŸ“¦ Install Dependencies
        run: npm ci

      - name: ğŸ”§ Setup Wrangler
        run: npm install -g wrangler@latest

      - name: ğŸš€ Deploy to Cloudflare Workers
        run: |
          echo "ğŸš€ Deploying SafeWork Workers to Cloudflare..."

          # Deploy to production
          npx wrangler deploy --env production

          echo "âœ… Cloudflare Workers deployment completed"

      - name: ğŸ” Verify Deployment
        run: |
          echo "ğŸ” Verifying Workers deployment..."

          sleep 10  # Wait for propagation

          # Test endpoints
          for endpoint in "/" "/survey/001_musculoskeletal_symptom_survey" "/survey/002_musculoskeletal_symptom_program"; do
            echo "ğŸ” Testing endpoint: $endpoint"
            response=$(curl -s -m 10 "https://safework.jclee.me$endpoint" || echo "FAILED")

            if echo "$response" | grep -q -i "safework"; then
              echo "âœ… Endpoint $endpoint: OK"
            else
              echo "âš ï¸ Endpoint $endpoint: Check required"
            fi
          done

      - name: ğŸ“Š Deployment Summary
        if: always()
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ“Š Cloudflare Workers Deployment Summary"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

          if [ "${{ job.status }}" == "success" ]; then
            echo "âœ… Status: WORKERS DEPLOYMENT SUCCESSFUL"
            echo "ğŸŒ Workers URL: https://safework.jclee.me"
            echo "ğŸ“… Deploy Time: $(date '+%Y-%m-%d %H:%M:%S UTC')"
            echo "ğŸš€ Method: Cloudflare Wrangler"
            echo "ğŸ—ï¸ Build Number: ${{ github.run_number }}"
            echo ""
            echo "ğŸ” Key Endpoints:"
            echo "  â€¢ 001 Survey: https://safework.jclee.me/survey/001_musculoskeletal_symptom_survey"
            echo "  â€¢ 002 Admin Dashboard: https://safework.jclee.me/survey/002_musculoskeletal_symptom_program"
            echo "  â€¢ Health: https://safework.jclee.me/api/health"
          else
            echo "âŒ Status: WORKERS DEPLOYMENT FAILED"
            echo "ğŸ“… Failure Time: $(date '+%Y-%m-%d %H:%M:%S UTC')"
            echo "ğŸ” Check logs: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          fi

          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"