name: Cloudflare Workers Deployment

on:
  push:
    branches: [master]
    paths:
      - 'workers/**'
  workflow_dispatch:

env:
  CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
  CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}

jobs:
  deploy-workers:
    name: 🚀 Deploy Cloudflare Workers
    runs-on: ubuntu-latest
    timeout-minutes: 10

    defaults:
      run:
        working-directory: ./workers

    steps:
      - name: 📥 Checkout Repository
        uses: actions/checkout@v4

      - name: 📦 Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: 'workers/package-lock.json'

      - name: 📦 Install Dependencies
        run: npm ci

      - name: 🔧 Setup Wrangler
        run: npm install -g wrangler@latest

      - name: 🚀 Deploy to Cloudflare Workers
        run: |
          echo "🚀 Deploying SafeWork Workers to Cloudflare..."

          # Deploy to production
          npx wrangler deploy --env production

          echo "✅ Cloudflare Workers deployment completed"

      - name: 🔍 Verify Deployment
        run: |
          echo "🔍 Verifying Workers deployment..."

          sleep 10  # Wait for propagation

          # Test endpoints
          for endpoint in "/" "/survey/001_musculoskeletal_symptom_survey" "/survey/002_musculoskeletal_symptom_program"; do
            echo "🔍 Testing endpoint: $endpoint"
            response=$(curl -s -m 10 "https://safework.jclee.me$endpoint" || echo "FAILED")

            if echo "$response" | grep -q -i "safework"; then
              echo "✅ Endpoint $endpoint: OK"
            else
              echo "⚠️ Endpoint $endpoint: Check required"
            fi
          done

      - name: 📊 Deployment Summary
        if: always()
        run: |
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          echo "📊 Cloudflare Workers Deployment Summary"
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"

          if [ "${{ job.status }}" == "success" ]; then
            echo "✅ Status: WORKERS DEPLOYMENT SUCCESSFUL"
            echo "🌐 Workers URL: https://safework.jclee.me"
            echo "📅 Deploy Time: $(date '+%Y-%m-%d %H:%M:%S UTC')"
            echo "🚀 Method: Cloudflare Wrangler"
            echo "🏗️ Build Number: ${{ github.run_number }}"
            echo ""
            echo "🔍 Key Endpoints:"
            echo "  • 001 Survey: https://safework.jclee.me/survey/001_musculoskeletal_symptom_survey"
            echo "  • 002 Admin Dashboard: https://safework.jclee.me/survey/002_musculoskeletal_symptom_program"
            echo "  • Health: https://safework.jclee.me/api/health"
          else
            echo "❌ Status: WORKERS DEPLOYMENT FAILED"
            echo "📅 Failure Time: $(date '+%Y-%m-%d %H:%M:%S UTC')"
            echo "🔍 Check logs: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          fi

          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"