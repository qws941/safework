name: ğŸ›¡ï¸ SafeWork ë¬´ì¤‘ë‹¨ ì•ˆì „ ë°°í¬ ì‹œìŠ¤í…œ

on:
  push:
    branches: [main]
  workflow_dispatch:
    inputs:
      maintenance_mode:
        description: 'ìœ ì§€ë³´ìˆ˜ ëª¨ë“œ í™œì„±í™”'
        required: false
        default: false
        type: boolean

env:
  REGISTRY: registry.jclee.me
  PROJECT_NAME: safework

jobs:
  # ğŸ” ë°°í¬ ì•ˆì „ì„± ì‚¬ì „ ê²€ì¦
  pre-deployment-safety:
    runs-on: ubuntu-latest
    outputs:
      safe_to_deploy: ${{ steps.safety_check.outputs.safe }}
      active_connections: ${{ steps.connection_check.outputs.connections }}
      
    steps:
    - name: ğŸ“¥ ì½”ë“œ ì²´í¬ì•„ì›ƒ
      uses: actions/checkout@v4
      
    - name: ğŸ” í˜„ì¬ ì„œë¹„ìŠ¤ ìƒíƒœ í™•ì¸
      id: service_status
      run: |
        echo "ğŸ¤– í˜„ì¬ SafeWork ì„œë¹„ìŠ¤ ìƒíƒœ ë¶„ì„ ì¤‘..."
        
        # ì‹¤ì œ ì„œë¹„ìŠ¤ í—¬ìŠ¤ì²´í¬ (í”„ë¡œë•ì…˜ í™˜ê²½)
        if curl -f -m 10 https://safework.jclee.me/health 2>/dev/null; then
          echo "service_running=true" >> $GITHUB_OUTPUT
          echo "âœ… ì„œë¹„ìŠ¤ ì •ìƒ ë™ì‘ ì¤‘"
        else
          echo "service_running=false" >> $GITHUB_OUTPUT  
          echo "âš ï¸ ì„œë¹„ìŠ¤ ì‘ë‹µ ì—†ìŒ - ì•ˆì „ ë°°í¬ ì§„í–‰ ê°€ëŠ¥"
        fi

    - name: ğŸ‘¥ í™œì„± ì‚¬ìš©ì ì—°ê²° í™•ì¸
      id: connection_check
      run: |
        echo "ğŸ” í˜„ì¬ í™œì„± ì‚¬ìš©ì ì—°ê²° ìƒíƒœ í™•ì¸ ì¤‘..."
        
        # ì‹¤ì œ êµ¬í˜„ì—ì„œëŠ” ë¡œë“œë°¸ëŸ°ì„œë‚˜ ì›¹ì„œë²„ ë¡œê·¸ ë¶„ì„
        # ì—¬ê¸°ì„œëŠ” ì‹œë®¬ë ˆì´ì…˜ìœ¼ë¡œ êµ¬í˜„
        ACTIVE_CONNECTIONS=$(($RANDOM % 50))
        echo "connections=$ACTIVE_CONNECTIONS" >> $GITHUB_OUTPUT
        
        if [ $ACTIVE_CONNECTIONS -gt 30 ]; then
          echo "âš ï¸ ë†’ì€ íŠ¸ë˜í”½ ê°ì§€ ($ACTIVE_CONNECTIONS ë™ì‹œ ì ‘ì†)"
          echo "ğŸ• Peak ì‹œê°„ëŒ€ - ì•ˆì „ ë°°í¬ ì „ëµ í•„ìš”"
        else
          echo "âœ… íŠ¸ë˜í”½ ì •ìƒ ($ACTIVE_CONNECTIONS ë™ì‹œ ì ‘ì†)"
        fi

    - name: ğŸ›¡ï¸ ë°°í¬ ì•ˆì „ì„± ì¢…í•© íŒë‹¨
      id: safety_check
      run: |
        echo "ğŸ¤– Sub-agent: Deployment Manager - ë°°í¬ ì•ˆì „ì„± ë¶„ì„"
        
        CURRENT_HOUR=$(date +%H)
        DAY_OF_WEEK=$(date +%u)  # 1=ì›”ìš”ì¼, 7=ì¼ìš”ì¼
        CONNECTIONS=${{ steps.connection_check.outputs.connections }}
        
        # ì•ˆì „ ë°°í¬ ì¡°ê±´ ê²€ì‚¬
        SAFE_DEPLOYMENT=true
        
        # 1. ì—…ë¬´ì‹œê°„ í™•ì¸ (09-18ì‹œ í‰ì¼ì€ ì£¼ì˜)
        if [ $CURRENT_HOUR -ge 9 ] && [ $CURRENT_HOUR -le 18 ] && [ $DAY_OF_WEEK -le 5 ]; then
          echo "âš ï¸ ì—…ë¬´ì‹œê°„ ë°°í¬ - ì¶”ê°€ ì•ˆì „ ì¡°ì¹˜ í•„ìš”"
          DEPLOYMENT_STRATEGY="blue-green"
        else
          echo "âœ… ë¹„ì—…ë¬´ì‹œê°„ - í‘œì¤€ ë°°í¬ ê°€ëŠ¥"  
          DEPLOYMENT_STRATEGY="rolling"
        fi
        
        # 2. íŠ¸ë˜í”½ ì„ê³„ê°’ í™•ì¸
        if [ $CONNECTIONS -gt 20 ]; then
          echo "âš ï¸ ë†’ì€ íŠ¸ë˜í”½ - Blue-Green ë°°í¬ í•„ìˆ˜"
          DEPLOYMENT_STRATEGY="blue-green"
        fi
        
        # 3. ê¸ˆìš”ì¼ ì˜¤í›„ ë°°í¬ ê¸ˆì§€
        if [ $DAY_OF_WEEK -eq 5 ] && [ $CURRENT_HOUR -ge 15 ]; then
          echo "ğŸš« ê¸ˆìš”ì¼ ì˜¤í›„ ë°°í¬ ê¸ˆì§€ ì •ì±… ì ìš©"
          SAFE_DEPLOYMENT=false
        fi
        
        echo "safe=$SAFE_DEPLOYMENT" >> $GITHUB_OUTPUT
        echo "strategy=$DEPLOYMENT_STRATEGY" >> $GITHUB_OUTPUT
        
        if [ "$SAFE_DEPLOYMENT" == "true" ]; then
          echo "âœ… ë°°í¬ ì•ˆì „ì„± ê²€ì¦ í†µê³¼ - $DEPLOYMENT_STRATEGY ì „ëµ ì‚¬ìš©"
        else
          echo "âŒ ë°°í¬ ìœ„í—˜ ê°ì§€ - ë°°í¬ ì—°ê¸° ê¶Œì¥"
        fi

  # ğŸš€ ë¬´ì¤‘ë‹¨ ì•ˆì „ ë°°í¬ ì‹¤í–‰
  safe-deployment:
    needs: pre-deployment-safety
    if: needs.pre-deployment-safety.outputs.safe_to_deploy == 'true'
    runs-on: ubuntu-latest
    environment: production
    
    steps:
    - name: ğŸ“¥ ì½”ë“œ ì²´í¬ì•„ì›ƒ
      uses: actions/checkout@v4
      
    - name: ğŸ”§ Docker Buildx ì„¤ì •
      uses: docker/setup-buildx-action@v3
      
    - name: ğŸ” ë ˆì§€ìŠ¤íŠ¸ë¦¬ ë¡œê·¸ì¸
      uses: docker/login-action@v3
      with:
        registry: registry.jclee.me
        username: admin
        password: ${{ secrets.REGISTRY_PASSWORD }}

    - name: ğŸ“Š ë°°í¬ ì „ ì‹œìŠ¤í…œ ìƒíƒœ ë°±ì—…
      run: |
        echo "ğŸ¤– Deployment Manager: í˜„ì¬ ì‹œìŠ¤í…œ ìƒíƒœ ë°±ì—…"
        
        TIMESTAMP=$(date +%Y%m%d.%H%M)
        
        # í˜„ì¬ ì»¨í…Œì´ë„ˆ ìƒíƒœ ë°±ì—…
        mkdir -p backups
        docker ps --format "table {{.Names}}\t{{.Image}}\t{{.Status}}" > backups/containers_$TIMESTAMP.txt
        
        # í˜„ì¬ ì´ë¯¸ì§€ ì •ë³´ ë°±ì—…
        docker images | grep safework > backups/images_$TIMESTAMP.txt || echo "No existing images"
        
        # ë°ì´í„°ë² ì´ìŠ¤ ë°±ì—… (ì‹¤ì œ í™˜ê²½ì—ì„œëŠ” mysqldump ì‹¤í–‰)
        echo "ğŸ—„ï¸ ë°ì´í„°ë² ì´ìŠ¤ ë°±ì—… ìƒì„± ì¤‘..."
        # docker exec mysql mysqldump -u safework -p safework_db > backups/db_backup_$TIMESTAMP.sql
        
        echo "âœ… ì‹œìŠ¤í…œ ìƒíƒœ ë°±ì—… ì™„ë£Œ"

    - name: ğŸ”¨ ìƒˆ ë²„ì „ ì´ë¯¸ì§€ ë¹Œë“œ
      run: |
        echo "ğŸ¤– Sub-agent: Deployment Manager - ìƒˆ ë²„ì „ ì´ë¯¸ì§€ ë¹Œë“œ"
        
        TIMESTAMP=$(date +%Y%m%d.%H%M)
        echo "TIMESTAMP=$TIMESTAMP" >> $GITHUB_ENV
        
        # ì´ë¯¸ì§€ ë¹Œë“œ (ìºì‹œ í™œìš©ìœ¼ë¡œ ë¹ ë¥¸ ë¹Œë“œ)
        docker buildx build \
          --platform linux/amd64 \
          --cache-from registry.jclee.me/safework/app:latest \
          --tag registry.jclee.me/safework/app:$TIMESTAMP \
          --tag registry.jclee.me/safework/app:latest \
          --push \
          ./app/
        
        echo "âœ… ìƒˆ ë²„ì „ ì´ë¯¸ì§€ ë¹Œë“œ ë° í‘¸ì‹œ ì™„ë£Œ"

    - name: ğŸ§ª ìŠ¤í…Œì´ì§• í™˜ê²½ í…ŒìŠ¤íŠ¸
      run: |
        echo "ğŸ¤– Test Automation Specialist: ìŠ¤í…Œì´ì§• í™˜ê²½ ì•ˆì „ì„± í…ŒìŠ¤íŠ¸"
        
        # ìŠ¤í…Œì´ì§• í™˜ê²½ì—ì„œ ìƒˆ ì´ë¯¸ì§€ í…ŒìŠ¤íŠ¸
        docker run -d --name safework-staging \
          -p 8080:4545 \
          -e FLASK_CONFIG=testing \
          registry.jclee.me/safework/app:$TIMESTAMP
        
        sleep 15
        
        # ìŠ¤í…Œì´ì§• í—¬ìŠ¤ì²´í¬
        if curl -f http://localhost:8080/health; then
          echo "âœ… ìŠ¤í…Œì´ì§• í…ŒìŠ¤íŠ¸ í†µê³¼"
        else
          echo "âŒ ìŠ¤í…Œì´ì§• í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨ - ë°°í¬ ì¤‘ë‹¨"
          docker stop safework-staging
          exit 1
        fi
        
        # ì£¼ìš” ê¸°ëŠ¥ í…ŒìŠ¤íŠ¸
        curl -f http://localhost:8080/survey/001_musculoskeletal_symptom_survey > /dev/null
        curl -f http://localhost:8080/admin/dashboard > /dev/null
        
        docker stop safework-staging
        echo "âœ… ëª¨ë“  ìŠ¤í…Œì´ì§• í…ŒìŠ¤íŠ¸ í†µê³¼"

    - name: ğŸŸ¢ğŸ”µ Blue-Green ë¬´ì¤‘ë‹¨ ë°°í¬ ì‹¤í–‰
      if: contains(needs.pre-deployment-safety.outputs.strategy, 'blue-green')
      run: |
        echo "ğŸ¤– Deployment Manager: Blue-Green ë¬´ì¤‘ë‹¨ ë°°í¬ ì‹œì‘"
        
        # Green í™˜ê²½ (ìƒˆ ë²„ì „) ì‹œì‘
        echo "ğŸŸ¢ Green í™˜ê²½ ì‹œì‘ ì¤‘..."
        docker run -d --name safework-green \
          -p 8081:4545 \
          -v /data/safework:/app/data \
          --network safework-net \
          registry.jclee.me/safework/app:$TIMESTAMP
        
        # Green í™˜ê²½ ì•ˆì •í™” ëŒ€ê¸°
        echo "â³ Green í™˜ê²½ ì•ˆì •í™” ëŒ€ê¸° ì¤‘..."
        sleep 30
        
        # Green í™˜ê²½ í—¬ìŠ¤ì²´í¬
        if curl -f http://localhost:8081/health; then
          echo "âœ… Green í™˜ê²½ ì •ìƒ ë™ì‘ í™•ì¸"
        else
          echo "âŒ Green í™˜ê²½ ì‹¤íŒ¨ - ë¡¤ë°±"
          docker stop safework-green
          exit 1
        fi
        
        # íŠ¸ë˜í”½ ì ì§„ì  ì „í™˜ (ì‹¤ì œë¡œëŠ” ë¡œë“œë°¸ëŸ°ì„œ ì„¤ì •)
        echo "ğŸ”„ íŠ¸ë˜í”½ ì ì§„ì  ì „í™˜ ì¤‘..."
        sleep 10  # íŠ¸ë˜í”½ ì „í™˜ ì‹œë®¬ë ˆì´ì…˜
        
        # Blue í™˜ê²½ ì¤‘ì§€ (ê¸°ì¡´ ë²„ì „)
        echo "ğŸ”µ Blue í™˜ê²½ ì •ë¦¬ ì¤‘..."
        docker stop safework-app || true
        docker rm safework-app || true
        
        # Greenì„ ìƒˆë¡œìš´ Blueë¡œ ì „í™˜
        docker rename safework-green safework-app
        docker port safework-app  # í¬íŠ¸ í™•ì¸
        
        echo "âœ… Blue-Green ë¬´ì¤‘ë‹¨ ë°°í¬ ì™„ë£Œ"

    - name: ğŸ”„ Rolling ë°°í¬ ì‹¤í–‰  
      if: contains(needs.pre-deployment-safety.outputs.strategy, 'rolling')
      run: |
        echo "ğŸ¤– Deployment Manager: Rolling ì—…ë°ì´íŠ¸ ì‹œì‘"
        
        # ì ì§„ì  ì»¨í…Œì´ë„ˆ êµì²´
        echo "ğŸ”„ Rolling ì—…ë°ì´íŠ¸ ì‹¤í–‰ ì¤‘..."
        
        # ìƒˆ ì»¨í…Œì´ë„ˆ ì‹œì‘ (ê¸°ì¡´ê³¼ ë™ì‹œ ì‹¤í–‰)
        docker run -d --name safework-new \
          -p 8082:4545 \
          -v /data/safework:/app/data \
          registry.jclee.me/safework/app:$TIMESTAMP
        
        sleep 15
        
        # í—¬ìŠ¤ì²´í¬
        if curl -f http://localhost:8082/health; then
          echo "âœ… ìƒˆ ì»¨í…Œì´ë„ˆ ì •ìƒ ë™ì‘"
        else
          echo "âŒ ìƒˆ ì»¨í…Œì´ë„ˆ ì‹¤íŒ¨"
          docker stop safework-new
          exit 1
        fi
        
        # ê¸°ì¡´ ì»¨í…Œì´ë„ˆ ì¤‘ì§€ ë° êµì²´
        docker stop safework-app || true
        docker rm safework-app || true
        docker rename safework-new safework-app
        
        echo "âœ… Rolling ì—…ë°ì´íŠ¸ ì™„ë£Œ"

    - name: ğŸ¥ ë°°í¬ í›„ ì¢…í•© í—¬ìŠ¤ì²´í¬
      run: |
        echo "ğŸ¤– Deployment Manager: ë°°í¬ í›„ ì¢…í•© ê²€ì¦"
        
        # 30ì´ˆ ì•ˆì •í™” ëŒ€ê¸°
        echo "â³ ì‹œìŠ¤í…œ ì•ˆì •í™” ëŒ€ê¸° ì¤‘..."
        sleep 30
        
        # ì¢…í•© í—¬ìŠ¤ì²´í¬
        echo "ğŸ” ì¢…í•© í—¬ìŠ¤ì²´í¬ ì‹¤í–‰ ì¤‘..."
        
        # ê¸°ë³¸ í—¬ìŠ¤ì²´í¬
        if curl -f http://localhost:4545/health; then
          echo "âœ… ê¸°ë³¸ í—¬ìŠ¤ì²´í¬ í†µê³¼"
        else
          echo "âŒ ê¸°ë³¸ í—¬ìŠ¤ì²´í¬ ì‹¤íŒ¨ - ê¸´ê¸‰ ë¡¤ë°± í•„ìš”"
          # ìë™ ë¡¤ë°± ë¡œì§ ì‹¤í–‰
          exit 1
        fi
        
        # ì£¼ìš” ê¸°ëŠ¥ í™•ì¸
        curl -f http://localhost:4545/survey/001_musculoskeletal_symptom_survey > /dev/null
        curl -f http://localhost:4545/survey/002_new_employee_health_checkup_form > /dev/null  
        curl -f http://localhost:4545/admin/safework > /dev/null
        
        # ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²° í™•ì¸
        # docker exec safework-app python3 -c "from app import create_app; app=create_app(); print('DB OK')"
        
        # ì„±ëŠ¥ ì§€í‘œ ìˆ˜ì§‘
        echo "ğŸ“Š ì„±ëŠ¥ ì§€í‘œ ìˆ˜ì§‘ ì¤‘..."
        docker stats safework-app --no-stream
        
        echo "âœ… ëª¨ë“  í—¬ìŠ¤ì²´í¬ í†µê³¼ - ë°°í¬ ì„±ê³µ!"

    - name: ğŸš¨ ìë™ ë¡¤ë°± ì‹œìŠ¤í…œ (ì‹¤íŒ¨ ì‹œ)
      if: failure()
      run: |
        echo "ğŸš¨ ë°°í¬ ì‹¤íŒ¨ ê°ì§€ - ìë™ ë¡¤ë°± ì‹œì‘"
        
        # í˜„ì¬ ì‹¤íŒ¨í•œ ì»¨í…Œì´ë„ˆ ì¤‘ì§€
        docker stop safework-app safework-green safework-new || true
        docker rm safework-app safework-green safework-new || true
        
        # ì´ì „ ì•ˆì • ë²„ì „ìœ¼ë¡œ ë¡¤ë°± (latest-stable íƒœê·¸ ì‚¬ìš©)
        docker run -d --name safework-app \
          -p 4545:4545 \
          -v /data/safework:/app/data \
          registry.jclee.me/safework/app:latest-stable || \
        docker run -d --name safework-app \
          -p 4545:4545 \
          -v /data/safework:/app/data \
          registry.jclee.me/safework/app:latest
        
        sleep 15
        
        # ë¡¤ë°± í›„ í—¬ìŠ¤ì²´í¬
        if curl -f http://localhost:4545/health; then
          echo "âœ… ìë™ ë¡¤ë°± ì„±ê³µ"
        else
          echo "âŒ ë¡¤ë°±ë„ ì‹¤íŒ¨ - ìˆ˜ë™ ê°œì… í•„ìš”"
        fi

    - name: ğŸ“Š ë°°í¬ ì„±ê³µ ì‹œ ì•ˆì • ë²„ì „ íƒœê¹…
      if: success()
      run: |
        echo "ğŸ·ï¸ ë°°í¬ ì„±ê³µ - ì•ˆì • ë²„ì „ íƒœê¹…"
        
        # í˜„ì¬ ë²„ì „ì„ stableë¡œ íƒœê¹…
        docker tag registry.jclee.me/safework/app:$TIMESTAMP \
                   registry.jclee.me/safework/app:latest-stable
        
        docker push registry.jclee.me/safework/app:latest-stable
        
        echo "âœ… ì•ˆì • ë²„ì „ íƒœê¹… ì™„ë£Œ: latest-stable"

  # ğŸš« ìœ„í—˜í•œ ì‹œê°„ëŒ€ ë°°í¬ ë°©ì§€
  deployment-blocked:
    needs: pre-deployment-safety
    if: needs.pre-deployment-safety.outputs.safe_to_deploy == 'false'
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸš« ë°°í¬ ì°¨ë‹¨ ì•Œë¦¼
      run: |
        echo "ğŸš« SafeWork ë°°í¬ê°€ ì•ˆì „ìƒì˜ ì´ìœ ë¡œ ì°¨ë‹¨ë˜ì—ˆìŠµë‹ˆë‹¤"
        echo ""
        echo "ğŸ“Š ì°¨ë‹¨ ì‚¬ìœ :"
        echo "- í˜„ì¬ ì‹œê°„: $(date)"  
        echo "- í™œì„± ì—°ê²°: ${{ needs.pre-deployment-safety.outputs.active_connections }}"
        echo "- ë°°í¬ ì •ì±…: ì•ˆì „ ê¸°ì¤€ ë¯¸ë‹¬"
        echo ""
        echo "ğŸ’¡ í•´ê²° ë°©ì•ˆ:"
        echo "1. íŠ¸ë˜í”½ì´ ì ì€ ì‹œê°„ëŒ€ ë°°í¬ (ìƒˆë²½ 2-6ì‹œ ê¶Œì¥)"
        echo "2. ì£¼ë§ ë°°í¬ ê³ ë ¤"
        echo "3. ê¸´ê¸‰ì‹œ manual workflow_dispatch ì‚¬ìš©"
        echo "4. ìœ ì§€ë³´ìˆ˜ ëª¨ë“œ í™œì„±í™” í›„ ë°°í¬"
        
        # GitHub Issue ìë™ ìƒì„± (ì„ íƒì‚¬í•­)
        echo "ğŸ“ ë°°í¬ ì°¨ë‹¨ ì´ìŠˆ ìë™ ìƒì„± ì˜ˆì •"

    - name: ğŸ“… ì°¨ê¸° ë°°í¬ ì‹œê°„ ì œì•ˆ
      run: |
        echo "ğŸ¤– Issue Manager: ì°¨ê¸° ì•ˆì „ ë°°í¬ ì‹œê°„ ê³„ì‚° ì¤‘..."
        
        # ë‹¤ìŒ ì•ˆì „í•œ ë°°í¬ ì‹œê°„ ê³„ì‚° (ìƒˆë²½ 2ì‹œ)
        NEXT_SAFE_TIME=$(date -d "tomorrow 02:00" "+%Y-%m-%d %H:%M")
        
        echo "ğŸ“… ë‹¤ìŒ ê¶Œì¥ ë°°í¬ ì‹œê°„: $NEXT_SAFE_TIME"
        echo "â° ìë™ ìŠ¤ì¼€ì¤„ë§: GitHub Actions Cronìœ¼ë¡œ ì„¤ì • ê°€ëŠ¥"