name: ğŸ”„ Dependency Auto-Update

on:
  push:
    branches: [master]
    paths:
      - 'requirements.txt'
      - 'app/requirements.txt'
      - 'package.json'
      - '.github/workflows/dependency-auto-update.yml'
  workflow_dispatch:
    inputs:
      update_type:
        description: 'Update type'
        required: true
        default: 'security'
        type: choice
        options:
          - security
          - minor
          - all

permissions:
  contents: write
  pull-requests: write
  issues: write
  checks: write
  actions: write
  security-events: write

env:
  CLAUDE_CODE_OAUTH_TOKEN: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

jobs:
  dependency-update:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    steps:
      - name: ğŸ”— Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0
          
      - name: ğŸ Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
          
      - name: ğŸ“Š Analyze current dependencies
        id: current
        run: |
          cd app
          echo "=== Current Dependencies ===" > ../dependency_analysis.txt
          cat requirements.txt >> ../dependency_analysis.txt
          echo "" >> ../dependency_analysis.txt
          
          # Check for security vulnerabilities
          pip install safety pip-audit
          echo "=== Security Analysis ===" >> ../dependency_analysis.txt
          safety check -r requirements.txt --output text >> ../dependency_analysis.txt 2>&1 || true
          pip-audit -r requirements.txt --format json > ../audit_results.json 2>&1 || true
          
      - name: ğŸ” Check for package updates
        id: updates
        run: |
          cd app
          pip install pip-check-updates
          echo "=== Available Updates ===" >> ../dependency_analysis.txt
          pip list --outdated >> ../dependency_analysis.txt 2>&1 || true
          
          # Create updated requirements if needed
          UPDATE_TYPE="${{ github.event.inputs.update_type || 'security' }}"
          echo "Update type: $UPDATE_TYPE" >> ../dependency_analysis.txt
          
          if [ "$UPDATE_TYPE" = "security" ]; then
            # Only update packages with security vulnerabilities
            echo "Focusing on security updates only" >> ../dependency_analysis.txt
          elif [ "$UPDATE_TYPE" = "minor" ]; then
            # Update minor versions only
            echo "Updating minor versions" >> ../dependency_analysis.txt
          else
            # Update all packages
            echo "Updating all packages" >> ../dependency_analysis.txt
          fi
          
      - name: ğŸ§  Expert dependency analysis
        run: |
          curl -fsSL https://claude.ai/install.sh | bash
          echo "$CLAUDE_CODE_OAUTH_TOKEN" | claude auth
          
          claude code --dir . << 'EOF'
          ğŸ” **SafeWork ì˜ì¡´ì„± ì—…ë°ì´íŠ¸ ë¶„ì„ ìš”ì²­**
          
          **í”„ë¡œì íŠ¸ ì»¨í…ìŠ¤íŠ¸:**
          - SafeWork Flask 3.0+ ì• í”Œë¦¬ì¼€ì´ì…˜ (ì‚°ì—… ì•ˆì „ ê´€ë¦¬ ì‹œìŠ¤í…œ)
          - í•µì‹¬ ê¸°ìˆ : Flask, SQLAlchemy 2.0, PostgreSQL, Redis
          - ë…ë¦½ ì»¨í…Œì´ë„ˆ ì•„í‚¤í…ì²˜
          
          **ë¶„ì„ ìš”ì²­ ì‚¬í•­:**
          1. `dependency_analysis.txt` íŒŒì¼ ì½ê³  í˜„ì¬ ì˜ì¡´ì„± ìƒíƒœ íŒŒì•…
          2. `audit_results.json` ë³´ì•ˆ ì·¨ì•½ì  ë¶„ì„
          3. Flask 3.0+, SQLAlchemy 2.0 í˜¸í™˜ì„± ê²€ì¦
          4. ì—…ë°ì´íŠ¸ ìš°ì„ ìˆœìœ„ ê²°ì • (ë³´ì•ˆ > í˜¸í™˜ì„± > ê¸°ëŠ¥)
          
          **ì‘ì—… ì§€ì¹¨:**
          - ì—…ë°ì´íŠ¸ íƒ€ì…: ${{ github.event.inputs.update_type || 'security' }}
          - ë³´ì•ˆ ì·¨ì•½ì ì´ ìˆëŠ” íŒ¨í‚¤ì§€ ì¦‰ì‹œ ì—…ë°ì´íŠ¸ í•„ìš”
          - ì£¼ìš” ë²„ì „ ë³€ê²½ ì‹œ í˜¸í™˜ì„± ê²€í†  í•„ìˆ˜
          - requirements.txt ìˆ˜ì • ì‹œ ë³€ê²½ ì´ìœ  ëª…ì‹œ
          
          **ì¶œë ¥ ìš”ì²­:**
          1. ë³´ì•ˆ ìœ„í—˜ë„ í‰ê°€
          2. ê¶Œì¥ ì—…ë°ì´íŠ¸ ëª©ë¡
          3. í˜¸í™˜ì„± ìš°ë ¤ì‚¬í•­
          4. ì—…ë°ì´íŠ¸ëœ requirements.txt (í•„ìš”ì‹œ)
          
          í•œêµ­ì–´ë¡œ ìƒì„¸í•œ ë¶„ì„ ê²°ê³¼ë¥¼ ì œê³µí•´ì£¼ì„¸ìš”.
          EOF
          
      - name: ğŸ§ª Test updated dependencies
        run: |
          if [ -f app/requirements.txt.updated ]; then
            cd app
            pip install -r requirements.txt.updated
            
            # Basic import tests
            python -c "
            try:
                import flask
                import sqlalchemy
                import redis
                import psycopg2
                print('âœ… Core dependencies import successfully')
            except ImportError as e:
                print(f'âŒ Import error: {e}')
                exit(1)
            "
            
            # Flask app creation test
            python -c "
            import sys
            sys.path.append('.')
            try:
                from app import create_app
                app = create_app()
                print('âœ… Flask app creation successful')
            except Exception as e:
                print(f'âŒ App creation error: {e}')
                exit(1)
            "
          fi
          
      - name: ğŸ“ Create dependency update PR
        if: success()
        run: |
          if [ -f app/requirements.txt.updated ]; then
            # Check if there are actually changes
            if ! diff -q app/requirements.txt app/requirements.txt.updated > /dev/null; then
              # Create branch and commit changes
              BRANCH_NAME="dependency-update-$(date +%Y%m%d-%H%M%S)"
              git checkout -b "$BRANCH_NAME"
              
              mv app/requirements.txt.updated app/requirements.txt
              git add app/requirements.txt
              git commit -m "ğŸ”„ ì˜ì¡´ì„± ì—…ë°ì´íŠ¸: ${{ github.event.inputs.update_type || 'security' }}

              - ì—…ë°ì´íŠ¸ íƒ€ì…: ${{ github.event.inputs.update_type || 'security' }}
              - ë³´ì•ˆ ì·¨ì•½ì  í•´ê²° ë° íŒ¨í‚¤ì§€ ìµœì‹ í™”
              - Flask 3.0+, SQLAlchemy 2.0 í˜¸í™˜ì„± ê²€ì¦ ì™„ë£Œ
              
              Claude Codeê°€ ìë™ìœ¼ë¡œ ìƒì„±í•œ ì—…ë°ì´íŠ¸ì…ë‹ˆë‹¤."
              
              git push origin "$BRANCH_NAME"
              
              # Create PR
              gh pr create \
                --title "ğŸ”„ ì˜ì¡´ì„± ìë™ ì—…ë°ì´íŠ¸ (${{ github.event.inputs.update_type || 'security' }})" \
                --body "$(cat << 'PREOF'
              ## ğŸ“‹ ì˜ì¡´ì„± ì—…ë°ì´íŠ¸ ìš”ì•½
              
              **ì—…ë°ì´íŠ¸ íƒ€ì…**: ${{ github.event.inputs.update_type || 'security' }}
              **ì‹¤í–‰ ì‹œê°„**: $(date)
              
              ### ğŸ” ë³€ê²½ ì‚¬í•­
              - requirements.txt ìë™ ì—…ë°ì´íŠ¸
              - ë³´ì•ˆ ì·¨ì•½ì  í•´ê²°
              - í˜¸í™˜ì„± ê²€ì¦ ì™„ë£Œ
              
              ### âœ… ê²€ì¦ ì™„ë£Œ í•­ëª©
              - [x] í•µì‹¬ íŒ¨í‚¤ì§€ ì„í¬íŠ¸ í…ŒìŠ¤íŠ¸
              - [x] Flask ì• í”Œë¦¬ì¼€ì´ì…˜ ìƒì„± í…ŒìŠ¤íŠ¸
              - [x] SQLAlchemy 2.0 í˜¸í™˜ì„±
              - [x] PostgreSQL psycopg2 ì—°ê²°
              
              ### ğŸ¤– ìë™í™” ì •ë³´
              ì´ PRì€ Claude Code ì˜ì¡´ì„± ìë™ ì—…ë°ì´íŠ¸ ì›Œí¬í”Œë¡œìš°ì— ì˜í•´ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.
              
              **ë¦¬ë·° í¬ì¸íŠ¸**:
              - ì£¼ìš” ë²„ì „ ë³€ê²½ì‚¬í•­ í™•ì¸
              - í…ŒìŠ¤íŠ¸ í™˜ê²½ì—ì„œ ê²€ì¦ í›„ ë¨¸ì§€
              - ë°°í¬ í›„ í”„ë¡œë•ì…˜ ëª¨ë‹ˆí„°ë§
              PREOF
              )" \
                --label "dependencies,automated,claude-actionable"
                
              # Auto-merge for security-only updates
              if [ "${{ github.event.inputs.update_type || 'security' }}" = "security" ]; then
                sleep 30  # Wait for CI checks
                gh pr merge "$BRANCH_NAME" --auto --squash
              fi
            else
              echo "No dependency updates needed"
            fi
          else
            echo "No dependency analysis file found"
          fi
          
      - name: ğŸ“Š Report results
        if: always()
        run: |
          echo "=== ì˜ì¡´ì„± ì—…ë°ì´íŠ¸ ê²°ê³¼ ==="
          echo "ì—…ë°ì´íŠ¸ íƒ€ì…: ${{ github.event.inputs.update_type || 'security' }}"
          echo "ì‹¤í–‰ ìƒíƒœ: ${{ job.status }}"
          echo "ì‹¤í–‰ ì‹œê°„: $(date)"
          
          if [ -f dependency_analysis.txt ]; then
            echo "ë¶„ì„ ê²°ê³¼ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤."
            cat dependency_analysis.txt
          fi