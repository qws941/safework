name: Issue Labeling
on:
  issues:
    types: [opened, edited]
  pull_request:
    types: [opened, edited, synchronize]

permissions:
  issues: write
  pull-requests: write
  contents: read

jobs:
  label:
    runs-on: ubuntu-latest
    steps:
      - name: Auto Label Issues and PRs
        uses: actions/github-script@v7
        with:
          script: |
            const { context, github } = require('@actions/github');
            
            const item = context.payload.issue || context.payload.pull_request;
            const isIssue = !!context.payload.issue;
            const itemType = isIssue ? 'issue' : 'pull_request';
            
            const title = item.title.toLowerCase();
            const body = (item.body || '').toLowerCase();
            const content = `${title} ${body}`;
            
            const labels = [];
            
            // Priority labeling
            if (content.match(/ê¸´ê¸‰|urgent|critical|ì¤‘ë‹¨|ì‘ë™.*ì•ˆ/)) {
              labels.push('P0-CRITICAL');
            } else if (content.match(/ë²„ê·¸|bug|ì˜¤ë¥˜|error|ë¬¸ì œ|problem/)) {
              labels.push('P1-HIGH');
            } else if (content.match(/ê°œì„ |enhance|feature|ê¸°ëŠ¥/)) {
              labels.push('P2-MEDIUM');
            }
            
            // Component labeling  
            if (content.match(/ì„¤ë¬¸|survey|001|002/)) {
              labels.push('component:survey');
            }
            if (content.match(/ê´€ë¦¬ì|admin|safework.*admin/)) {
              labels.push('component:admin');
            }
            if (content.match(/ì˜ë£Œ|health|ê²€ì§„|medical/)) {
              labels.push('component:medical');
            }
            if (content.match(/api|ì—°ë™|integration/)) {
              labels.push('component:api');
            }
            if (content.match(/ë°°í¬|deploy|docker|watchtower/)) {
              labels.push('component:deployment');
            }
            if (content.match(/ë°ì´í„°ë² ì´ìŠ¤|database|mysql|db/)) {
              labels.push('component:database');
            }
            if (content.match(/ui|ux|í…œí”Œë¦¿|template|html|css/)) {
              labels.push('component:frontend');
            }
            
            // Type labeling
            if (content.match(/ë²„ê·¸|bug|ì˜¤ë¥˜|error/)) {
              labels.push('type:bug');
            } else if (content.match(/ê¸°ëŠ¥|feature|ìƒˆë¡œìš´|new/)) {
              labels.push('type:feature');
            } else if (content.match(/ê°œì„ |enhance|í–¥ìƒ|improve/)) {
              labels.push('type:enhancement');
            } else if (content.match(/ë¬¸ì„œ|docs|documentation/)) {
              labels.push('type:documentation');
            }
            
            // Language detection
            if (content.match(/[ê°€-í£]/)) {
              labels.push('lang:korean');
            }
            
            // Auto-generated detection
            if (content.match(/\[auto\]|\[automated\]|auto.*generated/i) || 
                item.user.login === 'github-actions[bot]') {
              labels.push('automated');
            }
            
            // Add labels if any were determined
            if (labels.length > 0) {
              if (isIssue) {
                await github.rest.issues.addLabels({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: item.number,
                  labels: labels
                });
              } else {
                await github.rest.issues.addLabels({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: item.number,
                  labels: labels
                });
              }
              
              console.log(`Added labels: ${labels.join(', ')}`);
            }
            
            // Urgent issue notification
            if (labels.includes('P0-CRITICAL')) {
              const comment = `ğŸš¨ **ê¸´ê¸‰ ì´ìŠˆ ê°ì§€ë¨** 
              
ì´ ì´ìŠˆëŠ” ë†’ì€ ìš°ì„ ìˆœìœ„ë¡œ ë¶„ë¥˜ë˜ì—ˆìŠµë‹ˆë‹¤.
- ìš°ì„ ìˆœìœ„: P0-CRITICAL  
- ìë™ ë¼ë²¨ë§: ${labels.join(', ')}
- Claude AIê°€ ê³§ ë¶„ì„ì„ ì‹œì‘í•©ë‹ˆë‹¤.

@claude ì´ ê¸´ê¸‰ ì´ìŠˆë¥¼ ìš°ì„ ì ìœ¼ë¡œ ë¶„ì„í•´ì£¼ì„¸ìš”.`;
              
              if (isIssue) {
                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: item.number,
                  body: comment
                });
              }
            }