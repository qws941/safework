name: SafeWork Unified Deployment Pipeline

on:
  push:
    branches: [master]
    paths:
      - 'app/**'
      - 'postgres/**'
      - 'redis/**'
      - 'docker-compose.yml'
      - '.github/workflows/**'
  workflow_dispatch:

env:
  REGISTRY: registry.jclee.me
  REGISTRY_USER: admin
  STACK_NAME: safework
  WEBHOOK_URL: https://portainer.jclee.me/api/stacks/webhooks/e2abf888-e16d-419b-bdf0-65c206cca913
  SERVICE_URL: https://safework.jclee.me

jobs:
  # ë³‘ë ¬ ì´ë¯¸ì§€ ë¹Œë“œ Jobs
  build-app:
    name: ğŸ”¨ Build App Image
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4

      - name: ğŸ”‘ Login to Docker Registry
        run: |
          echo "${{ secrets.REGISTRY_PASSWORD }}" | docker login ${{ env.REGISTRY }} -u ${{ env.REGISTRY_USER }} --password-stdin

      - name: ğŸ”¨ Build and Push App Image
        run: |
          echo "ğŸ”¨ Building SafeWork App image..."
          docker build -t ${{ env.REGISTRY }}/safework-app:latest \
                       -t ${{ env.REGISTRY }}/safework-app:${{ github.sha }} \
                       ./app

          echo "ğŸ“¦ Pushing App images to registry..."
          docker push ${{ env.REGISTRY }}/safework-app:latest
          docker push ${{ env.REGISTRY }}/safework-app:${{ github.sha }}
          echo "âœ… App image push completed"

  build-postgres:
    name: ğŸ”¨ Build PostgreSQL Image
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4

      - name: ğŸ”‘ Login to Docker Registry
        run: |
          echo "${{ secrets.REGISTRY_PASSWORD }}" | docker login ${{ env.REGISTRY }} -u ${{ env.REGISTRY_USER }} --password-stdin

      - name: ğŸ”¨ Build and Push PostgreSQL Image
        run: |
          echo "ğŸ”¨ Building PostgreSQL image..."
          docker build -t ${{ env.REGISTRY }}/safework-postgres:latest \
                       -t ${{ env.REGISTRY }}/safework-postgres:${{ github.sha }} \
                       ./postgres

          echo "ğŸ“¦ Pushing PostgreSQL images to registry..."
          docker push ${{ env.REGISTRY }}/safework-postgres:latest
          docker push ${{ env.REGISTRY }}/safework-postgres:${{ github.sha }}
          echo "âœ… PostgreSQL image push completed"

  build-redis:
    name: ğŸ”¨ Build Redis Image
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4

      - name: ğŸ”‘ Login to Docker Registry
        run: |
          echo "${{ secrets.REGISTRY_PASSWORD }}" | docker login ${{ env.REGISTRY }} -u ${{ env.REGISTRY_USER }} --password-stdin

      - name: ğŸ”¨ Build and Push Redis Image
        run: |
          echo "ğŸ”¨ Building Redis image..."
          docker build -t ${{ env.REGISTRY }}/safework-redis:latest \
                       -t ${{ env.REGISTRY }}/safework-redis:${{ github.sha }} \
                       ./redis

          echo "ğŸ“¦ Pushing Redis images to registry..."
          docker push ${{ env.REGISTRY }}/safework-redis:latest
          docker push ${{ env.REGISTRY }}/safework-redis:${{ github.sha }}
          echo "âœ… Redis image push completed"

  # ë°°í¬ Job (ë¹Œë“œ ì™„ë£Œ í›„ ì‹¤í–‰)
  deploy:
    name: ğŸš€ Deploy via Webhook
    runs-on: ubuntu-latest
    timeout-minutes: 5
    needs: [build-app, build-postgres, build-redis]

    steps:

      - name: ğŸš€ Deploy via Portainer Webhook
        run: |
          echo "ğŸš€ Triggering Portainer webhook deployment..."

          response=$(curl -X POST -s -w "\n%{http_code}" "${{ env.WEBHOOK_URL }}")
          http_code=$(echo "$response" | tail -n 1)

          if [ "$http_code" = "204" ] || [ "$http_code" = "200" ]; then
            echo "âœ… Webhook deployment triggered successfully (HTTP $http_code)"
          else
            echo "âŒ Webhook deployment failed (HTTP $http_code)"
            echo "Response: $response"
            exit 1
          fi

      - name: â³ Wait for Deployment
        run: |
          echo "â³ Waiting for containers to restart..."
          sleep 45

      - name: ğŸ” Verify Deployment Health
        run: |
          echo "ğŸ” Verifying deployment health..."

          max_attempts=10
          attempt=1

          while [ $attempt -le $max_attempts ]; do
            echo "ğŸ” Health check attempt $attempt/$max_attempts..."

            response=$(curl -s -m 10 "${{ env.SERVICE_URL }}/health" || echo "")

            if echo "$response" | grep -q "healthy"; then
              echo "âœ… Service is healthy!"
              echo "ğŸ“Š Health response: $response"

              # Additional endpoint checks
              echo "ğŸ” Testing critical endpoints..."
              for endpoint in "/" "/admin/safework"; do
                status=$(curl -s -o /dev/null -w "%{http_code}" -m 10 "${{ env.SERVICE_URL }}$endpoint" || echo "000")
                if [ "$status" = "200" ] || [ "$status" = "302" ]; then
                  echo "âœ… Endpoint $endpoint: HTTP $status"
                else
                  echo "âš ï¸ Endpoint $endpoint: HTTP $status"
                fi
              done

              exit 0
            fi

            echo "âš ï¸ Attempt $attempt failed, retrying in 10s..."
            sleep 10
            attempt=$((attempt + 1))
          done

          echo "âŒ Health check failed after $max_attempts attempts"
          exit 1

      - name: ğŸ“Š Deployment Summary
        if: always()
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ“Š SafeWork Deployment Summary"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

          if [ "${{ job.status }}" == "success" ]; then
            echo "âœ… Status: DEPLOYMENT SUCCESSFUL"
            echo "ğŸŒ Service URL: ${{ env.SERVICE_URL }}"
            echo "ğŸ“¦ Image Version: ${{ github.sha }}"
            echo "ğŸ“… Deploy Time: $(date '+%Y-%m-%d %H:%M:%S UTC')"
            echo "ğŸš€ Method: Unified Pipeline (Build â†’ Registry â†’ Webhook)"
            echo "ğŸ—ï¸ Build Number: ${{ github.run_number }}"
            echo ""
            echo "ğŸ” Service Endpoints:"
            echo "  â€¢ Health: ${{ env.SERVICE_URL }}/health"
            echo "  â€¢ Admin: ${{ env.SERVICE_URL }}/admin/safework"
            echo "  â€¢ Main: ${{ env.SERVICE_URL }}/"

          else
            echo "âŒ Status: DEPLOYMENT FAILED"
            echo "ğŸ“… Failure Time: $(date '+%Y-%m-%d %H:%M:%S UTC')"
            echo "ğŸ” Check logs: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
            echo "ğŸ”§ Manual recovery:"
            echo "  â€¢ Portainer: https://portainer.jclee.me"
            echo "  â€¢ Registry: ${{ env.REGISTRY }}"
            echo "  â€¢ Webhook: ${{ env.WEBHOOK_URL }}"
          fi

          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

      - name: ğŸš¨ Failure Notification
        if: failure()
        run: |
          echo "ğŸš¨ Deployment failed! Attempting emergency webhook trigger..."

          # Emergency webhook trigger
          curl -X POST -s "${{ env.WEBHOOK_URL }}" || echo "Emergency webhook also failed"

          echo "ğŸ“ Manual intervention required:"
          echo "  1. Check Portainer: https://portainer.jclee.me"
          echo "  2. Check registry: ${{ env.REGISTRY }}"
          echo "  3. Check service: ${{ env.SERVICE_URL }}/health"