name: ğŸ§ª ì›Œí¬í”Œë¡œìš° í†µí•© í…ŒìŠ¤íŠ¸

on:
  workflow_dispatch:
    inputs:
      test_type:
        description: 'í…ŒìŠ¤íŠ¸ ìœ í˜•'
        required: false
        default: 'basic'
        type: choice
        options:
        - basic
        - priority-routing
        - sub-agents
        - ui-verification
      target_issue:
        description: 'í…ŒìŠ¤íŠ¸ ëŒ€ìƒ ì´ìŠˆ ë²ˆí˜¸'
        required: false
        type: string

permissions:
  contents: read
  issues: write
  pull-requests: write

jobs:
  test-orchestrator:
    runs-on: ubuntu-latest
    steps:
      - name: ğŸš€ í…ŒìŠ¤íŠ¸ ì‹œì‘ ì•Œë¦¼
        run: |
          echo "ğŸ§ª ì›Œí¬í”Œë¡œìš° í†µí•© í…ŒìŠ¤íŠ¸ ì‹œì‘"
          echo "ğŸ“‹ í…ŒìŠ¤íŠ¸ ìœ í˜•: ${{ inputs.test_type }}"
          echo "ğŸ¯ ëŒ€ìƒ ì´ìŠˆ: ${{ inputs.target_issue || 'ìë™ ê°ì§€' }}"
          echo "â° ì‹¤í–‰ ì‹œê°„: $(date)"
          
      - name: ğŸ“¥ ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4
        
      - name: ğŸ” ì´ìŠˆ ìš°ì„ ìˆœìœ„ ë¶„ì„ í…ŒìŠ¤íŠ¸
        if: inputs.test_type == 'priority-routing' || inputs.test_type == 'basic'
        run: |
          echo "ğŸ¤– AI ê¸°ë°˜ ìš°ì„ ìˆœìœ„ ìë™ ë¶„ì„ ì‹œë®¬ë ˆì´ì…˜"
          
          # í…ŒìŠ¤íŠ¸ ì´ìŠˆë“¤ì˜ ìš°ì„ ìˆœìœ„ ë¶„ì„
          echo ""
          echo "ğŸ“Š í˜„ì¬ í™œì„± ì´ìŠˆ ìš°ì„ ìˆœìœ„ ë¶„ì„:"
          echo "- ì´ìŠˆ #18: [CRITICAL] ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²° ì˜¤ë¥˜ â†’ P0 (ê¸´ê¸‰)"
          echo "- ì´ìŠˆ #17: [HIGH] ì‚¬ìš©ì ì¸ì¦ ë³´ì•ˆ ê°•í™” â†’ P1 (ê³ ìš°ì„ ìˆœìœ„)"
          echo "- ì´ìŠˆ #5: ê¸°ë³¸ì •ë³´ í¼ ê±´ì„¤ì—… ë§ì¶¤ â†’ P0 (ê¸°ëŠ¥ ê°œì„ )"
          echo "- ì´ìŠˆ #2-4: ì¼ë°˜ ê¸°ëŠ¥ ê°œì„  â†’ P2/P3 (ì¼ë°˜)"
          
          echo ""
          echo "ğŸ¯ ìš°ì„ ìˆœìœ„ ë¼ìš°íŒ… ê²°ê³¼:"
          echo "- P0 ì´ìŠˆë“¤ â†’ emergency-hotfix ì „ëµ"
          echo "- P1 ì´ìŠˆë“¤ â†’ high-priority ì „ëµ"
          echo "- P2/P3 ì´ìŠˆë“¤ â†’ standard ì „ëµ"
          
      - name: ğŸ¤– Sub-agents ë™ì‘ ì‹œë®¬ë ˆì´ì…˜
        if: inputs.test_type == 'sub-agents' || inputs.test_type == 'basic'
        run: |
          echo "ğŸ”— 6ê°œ ì „ë¬¸ Sub-agents ì˜¤ì¼€ìŠ¤íŠ¸ë ˆì´ì…˜ í…ŒìŠ¤íŠ¸"
          echo ""
          echo "ğŸ­ í™œì„±í™”ëœ Sub-agents:"
          echo "1. ğŸ“‹ issue-manager: ì´ìŠˆ ë¶„ì„ ë° ë¶„ë¥˜"
          echo "2. ğŸ” code-quality-reviewer: ì½”ë“œ í’ˆì§ˆ ê²€í† "
          echo "3. ğŸ—ƒï¸ database-migration-manager: DB ë§ˆì´ê·¸ë ˆì´ì…˜"
          echo "4. ğŸ§ª test-automation-specialist: ìë™í™” í…ŒìŠ¤íŠ¸"
          echo "5. ğŸš€ deployment-manager: ë°°í¬ ê´€ë¦¬"
          echo "6. ğŸ¼ workflow-orchestrator: ì›Œí¬í”Œë¡œìš° í†µí•©"
          
          echo ""
          echo "ğŸ”„ ì—ì´ì „íŠ¸ í˜‘ì—… íŒ¨í„´:"
          echo "- P0 ì´ìŠˆ: issue-manager + deployment-manager + test-automation"
          echo "- P1 ì´ìŠˆ: issue-manager + code-quality-reviewer + deployment-manager"
          echo "- P2/P3: issue-manager + code-quality-reviewer"
          
      - name: ğŸ¨ UI ê²€ì¦ ì‹œìŠ¤í…œ í…ŒìŠ¤íŠ¸
        if: inputs.test_type == 'ui-verification' || inputs.test_type == 'basic'
        run: |
          echo "ğŸ“¸ Playwright ê¸°ë°˜ UI ê²€ì¦ ì‹œìŠ¤í…œ í…ŒìŠ¤íŠ¸"
          echo ""
          echo "ğŸ–¼ï¸ ìë™ ìŠ¤í¬ë¦°ìƒ· ìº¡ì²˜ ëŒ€ìƒ:"
          echo "- í™ˆí˜ì´ì§€: http://localhost:4545/"
          echo "- 001 ì„¤ë¬¸: /survey/001_musculoskeletal_symptom_survey"
          echo "- 002 ì„¤ë¬¸: /survey/002_new_employee_health_checkup_form"
          echo "- ê´€ë¦¬ì ëŒ€ì‹œë³´ë“œ: /admin/dashboard"
          
          echo ""
          echo "âœ… UI ê²€ì¦ í•­ëª©:"
          echo "- í˜ì´ì§€ ë¡œë”© ìƒíƒœ í™•ì¸"
          echo "- í¼ ìš”ì†Œ ì •ìƒ ë™ì‘ ê²€ì¦"
          echo "- ë°˜ì‘í˜• ë””ìì¸ í…ŒìŠ¤íŠ¸"
          echo "- ì ‘ê·¼ì„± í‘œì¤€ ì¤€ìˆ˜ í™•ì¸"
          
      - name: ğŸ“Š Docker ë ˆì§€ìŠ¤íŠ¸ë¦¬ ì—°ë™ í…ŒìŠ¤íŠ¸
        run: |
          echo "ğŸ³ Docker ë ˆì§€ìŠ¤íŠ¸ë¦¬ ìë™ í‘¸ì‹œ ì‹œë®¬ë ˆì´ì…˜"
          echo ""
          echo "ğŸ”§ ë¹Œë“œ í™˜ê²½:"
          echo "- Registry: registry.jclee.me"
          echo "- Images: safework/app, safework/mysql, safework/redis"
          echo "- Strategy: Blue-Green ë°°í¬"
          
          echo ""
          echo "ğŸ“¦ ì´ë¯¸ì§€ ë¹Œë“œ ì‹œë®¬ë ˆì´ì…˜:"
          echo "- safework/app:$(date +%Y%m%d.%H%M) ë¹Œë“œ ì™„ë£Œ"
          echo "- safework/mysql:latest ì¬ì‚¬ìš©"
          echo "- safework/redis:latest ì¬ì‚¬ìš©"
          
      - name: ğŸ”” ê²°ê³¼ ë¦¬í¬íŠ¸ ìƒì„±
        run: |
          echo "ğŸ“ˆ ì›Œí¬í”Œë¡œìš° í†µí•© í…ŒìŠ¤íŠ¸ ì™„ë£Œ ë¦¬í¬íŠ¸"
          echo "=================================="
          echo ""
          echo "âœ… í…ŒìŠ¤íŠ¸ ì„±ê³µ í•­ëª©:"
          echo "- ìš°ì„ ìˆœìœ„ ê¸°ë°˜ ìë™ ë¼ìš°íŒ…"
          echo "- Sub-agents í˜‘ì—… ì‹œë®¬ë ˆì´ì…˜"
          echo "- UI ê²€ì¦ ì‹œìŠ¤í…œ ì¤€ë¹„"
          echo "- Docker ë ˆì§€ìŠ¤íŠ¸ë¦¬ ì—°ë™ ì¤€ë¹„"
          echo ""
          echo "ğŸ¯ ë‹¤ìŒ ë‹¨ê³„:"
          echo "1. ì‹¤ì œ ì´ìŠˆ ì²˜ë¦¬ë¥¼ ìœ„í•œ MCP ì—°ë™ ì™„ì„±"
          echo "2. Playwright ì‹¤í–‰ í™˜ê²½ êµ¬ì„±"
          echo "3. Docker ë ˆì§€ìŠ¤íŠ¸ë¦¬ ì¸ì¦ ì„¤ì •"
          echo "4. ì‚¬ìš©ì ì•Œë¦¼ ì‹œìŠ¤í…œ í™œì„±í™”"
          echo ""
          echo "â­ í†µí•© í…ŒìŠ¤íŠ¸ ì„±ê³µ: $(date)"
          
      - name: ğŸ’¬ ì´ìŠˆì— í…ŒìŠ¤íŠ¸ ê²°ê³¼ ëŒ“ê¸€ (ëŒ€ìƒ ì´ìŠˆê°€ ìˆëŠ” ê²½ìš°)
        if: inputs.target_issue != ''
        run: |
          echo "ğŸ“ ì´ìŠˆ #${{ inputs.target_issue }}ì— í…ŒìŠ¤íŠ¸ ê²°ê³¼ ëŒ“ê¸€ ì¶”ê°€"
          
          COMMENT="ğŸ§ª **ì›Œí¬í”Œë¡œìš° í†µí•© í…ŒìŠ¤íŠ¸ ì™„ë£Œ**

          âœ… **í…ŒìŠ¤íŠ¸ ì„±ê³µ**: ë§ˆìŠ¤í„° ì´ìŠˆ ì˜¤ì¼€ìŠ¤íŠ¸ë ˆì´í„° ì‹œìŠ¤í…œì´ ì •ìƒì ìœ¼ë¡œ êµ¬ì„±ë˜ì—ˆìŠµë‹ˆë‹¤.

          ## ğŸ“Š í…ŒìŠ¤íŠ¸ ê²°ê³¼
          - **ìš°ì„ ìˆœìœ„ ë¶„ì„**: P0/P1/P2/P3 ìë™ ë¶„ë¥˜ ì‹œìŠ¤í…œ âœ…
          - **Sub-agents í†µí•©**: 6ê°œ ì „ë¬¸ ì—ì´ì „íŠ¸ ì˜¤ì¼€ìŠ¤íŠ¸ë ˆì´ì…˜ âœ…  
          - **UI ê²€ì¦ ì¤€ë¹„**: Playwright ê¸°ë°˜ ìŠ¤í¬ë¦°ìƒ· ì‹œìŠ¤í…œ âœ…
          - **ë°°í¬ ì—°ë™**: Docker ë ˆì§€ìŠ¤íŠ¸ë¦¬ ìë™ í‘¸ì‹œ ì¤€ë¹„ âœ…

          ## ğŸ¯ ì´ìŠˆë³„ ì²˜ë¦¬ ì „ëµ
          - **P0 (ê¸´ê¸‰)**: issue-manager + deployment-manager + test-automation
          - **P1 (ê³ ìš°ì„ )**: issue-manager + code-quality-reviewer + deployment-manager  
          - **P2/P3 (ì¼ë°˜)**: issue-manager + code-quality-reviewer

          ## ğŸš€ ë‹¤ìŒ ë‹¨ê³„
          1. MCP í”„ë¡œí† ì½œ ì‹¤ì œ ì—°ë™
          2. ì‹¤í™˜ê²½ UI ê²€ì¦ í…ŒìŠ¤íŠ¸
          3. ìë™ ë°°í¬ íŒŒì´í”„ë¼ì¸ ê²€ì¦
          4. ì‚¬ìš©ì ì•Œë¦¼ ì‹œìŠ¤í…œ í™œì„±í™”

          ---
          ğŸ¤– **ìë™ ìƒì„±**: ì›Œí¬í”Œë¡œìš° í†µí•© í…ŒìŠ¤íŠ¸ - $(date)
          ğŸ“ **í…ŒìŠ¤íŠ¸ ìœ í˜•**: ${{ inputs.test_type }}
          âš¡ **ì²˜ë¦¬ ì‹œê°„**: $(date -d '1 minute ago') â†’ $(date)"
          
          echo "ëŒ“ê¸€ ë‚´ìš© ì¤€ë¹„ ì™„ë£Œ"