name: 📚 Claude Documentation Sync

on:
  push:
    branches: [master, main]
    paths:
      - 'app/**/*.py'
      - 'models*.py'
      - 'requirements.txt'
      - 'CLAUDE.md'
  workflow_dispatch:
    inputs:
      doc_type:
        description: 'Documentation type to update'
        required: false
        default: 'all'
        type: choice
        options:
          - 'all'
          - 'api'
          - 'models'
          - 'deployment'

jobs:
  claude-docs:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      id-token: write
    
    steps:
      - name: 📥 Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: 📚 Claude Documentation Update
        uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          track_progress: true
          prompt: |
            REPO: ${{ github.repository }}
            DOC TYPE: ${{ github.event.inputs.doc_type || 'all' }}

            📚 **SafeWork 문서 자동 동기화**
            
            SafeWork 시스템의 코드 변경사항을 반영하여 문서를 업데이트해주세요.

            **문서화 대상:**

            **1. API 문서 (app/routes/)**
            - REST API 엔드포인트 문서화
            - 요청/응답 스키마 설명
            - 인증 및 권한 요구사항
            - 에러 코드 및 메시지
            - 사용 예시 및 curl 명령어

            **2. 데이터 모델 문서 (models*.py)**
            - 데이터베이스 스키마 설명
            - 테이블 관계도
            - 필드 설명 및 제약조건
            - 인덱스 및 성능 고려사항
            - 마이그레이션 히스토리

            **3. 배포 및 운영 문서**
            - Docker 컨테이너 설정
            - 환경 변수 설명
            - 데이터베이스 설정
            - 모니터링 및 로그 관리
            - 백업 및 복구 절차

            **4. SafeWork 도메인 문서**
            - 설문조사 시스템 구조
            - 산업안전보건 데이터 모델
            - 한국어/KST 처리 방식
            - 보안 및 개인정보보호 정책

            **5. 개발자 가이드**
            - 개발 환경 설정
            - 코딩 컨벤션
            - 테스트 작성 방법
            - 기여 가이드라인

            **문서 업데이트 방식:**
            1. 기존 README.md 및 docs/ 폴더 분석
            2. 코드 변경사항을 반영한 문서 업데이트
            3. 새로운 기능에 대한 문서 추가
            4. 예제 코드 및 사용법 업데이트
            5. 한국어 및 영어 문서 병행 관리

            변경된 코드를 분석하여 관련 문서를 자동으로 업데이트하고,
            필요한 경우 새로운 문서를 생성해주세요.

          claude_args: |
            --allowedTools "mcp__serena__*,mcp__sequential-thinking__*,mcp__shrimp-task-manager__*,mcp__github__*,Bash(gh pr:*),Bash(git:*)"