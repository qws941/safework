name: SafeWork ì„±ëŠ¥ ëª¨ë‹ˆí„°ë§ & ìµœì í™”

on:
  pull_request:
    types: [opened, synchronize, reopened]
    paths:
      - 'app/**/*.py'
      - 'app/templates/**'
      - 'app/static/**'
  schedule:
    - cron: '30 1 * * *'  # ë§¤ì¼ 10:30 KST ì„±ëŠ¥ ëª¨ë‹ˆí„°ë§
  workflow_dispatch:
    inputs:
      performance_test_type:
        description: 'ì„±ëŠ¥ í…ŒìŠ¤íŠ¸ ìœ í˜•'
        required: true
        default: 'standard'
        type: choice
        options:
        - 'basic'
        - 'standard'
        - 'comprehensive'
        - 'load_test'

env:
  TIMEZONE: 'Asia/Seoul'
  PYTHON_VERSION: '3.11'

jobs:
  performance_analysis:
    name: âš¡ SafeWork ì„±ëŠ¥ ë¶„ì„
    runs-on: ubuntu-latest
    timeout-minutes: 20
    
    permissions:
      contents: read
      issues: write
      pull-requests: write
      
    services:
      mysql:
        image: mysql:8.0
        env:
          MYSQL_ROOT_PASSWORD: safework123
          MYSQL_DATABASE: safework_test
        ports:
          - 3306:3306
        options: --health-cmd="mysqladmin ping" --health-interval=10s --health-timeout=5s --health-retries=3
          
      redis:
        image: redis:5.0
        ports:
          - 6379:6379
        options: --health-cmd="redis-cli ping" --health-interval=10s --health-timeout=5s --health-retries=3
          
    steps:
      - name: ğŸ“¥ ì†ŒìŠ¤ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4
        
      - name: ğŸ Python í™˜ê²½ ì„¤ì •
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
          
      - name: ğŸ“¦ ì„±ëŠ¥ ë¶„ì„ ë„êµ¬ ì„¤ì¹˜
        run: |
          pip install --upgrade pip
          pip install -r app/requirements.txt
          pip install pytest-benchmark memory-profiler line-profiler locust
          
      - name: ğŸ—„ï¸ í…ŒìŠ¤íŠ¸ ë°ì´í„°ë² ì´ìŠ¤ ì´ˆê¸°í™”
        run: |
          echo "ğŸ—ï¸ SafeWork í…ŒìŠ¤íŠ¸ í™˜ê²½ ì„¤ì •..."
          cd app
          python -c "
          import os
          os.environ['FLASK_ENV'] = 'testing'
          os.environ['DATABASE_URL'] = 'mysql://root:safework123@localhost:3306/safework_test'
          os.environ['REDIS_URL'] = 'redis://localhost:6379/0'
          
          from app import create_app
          from models import db
          
          app = create_app('testing')
          with app.app_context():
              db.create_all()
              print('âœ… í…ŒìŠ¤íŠ¸ ë°ì´í„°ë² ì´ìŠ¤ ì´ˆê¸°í™” ì™„ë£Œ')
          "
          
      - name: ğŸ“Š ë°ì´í„°ë² ì´ìŠ¤ ì„±ëŠ¥ ë¶„ì„
        run: |
          echo "ğŸ—„ï¸ MySQL ì„±ëŠ¥ ë¶„ì„ ì‹œì‘..."
          cd app
          python3 << 'EOF'
          import os, time, statistics
          os.environ['FLASK_ENV'] = 'testing'
          os.environ['DATABASE_URL'] = 'mysql://root:safework123@localhost:3306/safework_test'
          
          from app import create_app
          from models import db, Survey
          from sqlalchemy import text
          
          app = create_app('testing')
          
          with app.app_context():
              # ê¸°ë³¸ ì¿¼ë¦¬ ì„±ëŠ¥ í…ŒìŠ¤íŠ¸
              query_times = []
              
              for i in range(10):
                  start = time.time()
                  result = db.session.execute(text("SELECT COUNT(*) FROM surveys")).scalar()
                  end = time.time()
                  query_times.append((end - start) * 1000)
              
              avg_time = statistics.mean(query_times)
              max_time = max(query_times)
              min_time = min(query_times)
              
              print(f"ğŸ“ˆ ê¸°ë³¸ ì¿¼ë¦¬ ì„±ëŠ¥:")
              print(f"  í‰ê· : {avg_time:.2f}ms")
              print(f"  ìµœëŒ€: {max_time:.2f}ms") 
              print(f"  ìµœì†Œ: {min_time:.2f}ms")
              
              if avg_time > 50:
                  print("âš ï¸  í‰ê·  ì¿¼ë¦¬ ì‹œê°„ì´ 50msë¥¼ ì´ˆê³¼í•©ë‹ˆë‹¤")
              else:
                  print("âœ… ì¿¼ë¦¬ ì„±ëŠ¥ ì–‘í˜¸")
          EOF
          
      - name: ğŸš€ Redis ìºì‹± ì„±ëŠ¥ í…ŒìŠ¤íŠ¸
        run: |
          echo "âš¡ Redis ìºì‹± ì„±ëŠ¥ ë¶„ì„..."
          cd app
          python3 << 'EOF'
          import redis, time, statistics
          
          r = redis.Redis(host='localhost', port=6379, db=0)
          
          # Redis ì—°ê²° í…ŒìŠ¤íŠ¸
          if r.ping():
              print("âœ… Redis ì—°ê²° ì„±ê³µ")
              
              # ìºì‹œ ì„±ëŠ¥ í…ŒìŠ¤íŠ¸
              cache_times = []
              
              for i in range(100):
                  key = f"test_key_{i}"
                  value = f"test_value_{i}" * 100  # í° ë°ì´í„°
                  
                  start = time.time()
                  r.set(key, value, ex=60)
                  retrieved = r.get(key)
                  end = time.time()
                  
                  cache_times.append((end - start) * 1000)
              
              avg_cache_time = statistics.mean(cache_times)
              print(f"ğŸ“ˆ Redis ìºì‹œ ì„±ëŠ¥:")
              print(f"  í‰ê·  ì½ê¸°/ì“°ê¸°: {avg_cache_time:.2f}ms")
              
              if avg_cache_time > 5:
                  print("âš ï¸  ìºì‹œ ì„±ëŠ¥ ì €í•˜ ê°ì§€")
              else:
                  print("âœ… ìºì‹œ ì„±ëŠ¥ ì–‘í˜¸")
              
              # ìºì‹œ ì •ë¦¬
              r.flushdb()
          EOF
          
      - name: ğŸ“ˆ Flask ì• í”Œë¦¬ì¼€ì´ì…˜ ë©”ëª¨ë¦¬ í”„ë¡œíŒŒì¼ë§
        run: |
          echo "ğŸ§  ë©”ëª¨ë¦¬ ì‚¬ìš©ëŸ‰ ë¶„ì„..."
          cd app
          python3 << 'EOF'
          import os, psutil, gc
          os.environ['FLASK_ENV'] = 'testing'
          
          from app import create_app
          
          # ì´ˆê¸° ë©”ëª¨ë¦¬ ì‚¬ìš©ëŸ‰
          process = psutil.Process()
          initial_memory = process.memory_info().rss / 1024 / 1024  # MB
          
          print(f"ğŸ“Š ì´ˆê¸° ë©”ëª¨ë¦¬ ì‚¬ìš©ëŸ‰: {initial_memory:.2f} MB")
          
          app = create_app('testing')
          
          # ì•± ìƒì„± í›„ ë©”ëª¨ë¦¬
          app_memory = process.memory_info().rss / 1024 / 1024
          print(f"ğŸ“Š ì•± ì´ˆê¸°í™” í›„: {app_memory:.2f} MB (+{app_memory - initial_memory:.2f} MB)")
          
          # ë©”ëª¨ë¦¬ ìµœì í™” ì²´í¬
          with app.app_context():
              gc.collect()
              final_memory = process.memory_info().rss / 1024 / 1024
              print(f"ğŸ“Š ê°€ë¹„ì§€ ì»¬ë ‰ì…˜ í›„: {final_memory:.2f} MB")
              
              if final_memory > 200:
                  print("âš ï¸  ë©”ëª¨ë¦¬ ì‚¬ìš©ëŸ‰ì´ ë†’ìŠµë‹ˆë‹¤ (200MB ì´ˆê³¼)")
              else:
                  print("âœ… ë©”ëª¨ë¦¬ ì‚¬ìš©ëŸ‰ ì •ìƒ")
          EOF
          
      - name: ğŸŒ ì›¹ ì„±ëŠ¥ ê¸°ì¤€ì„  í…ŒìŠ¤íŠ¸
        run: |
          echo "ğŸš€ Flask ì›¹ ì„±ëŠ¥ í…ŒìŠ¤íŠ¸ ì‹œì‘..."
          cd app
          
          # Flask ì•±ì„ ë°±ê·¸ë¼ìš´ë“œì—ì„œ ì‹¤í–‰
          python3 -c "
          import os
          os.environ['FLASK_ENV'] = 'testing'
          from app import create_app
          app = create_app('testing')
          app.run(host='0.0.0.0', port=5000, debug=False)
          " &
          
          sleep 5
          
          # curlì„ ì‚¬ìš©í•œ ê¸°ë³¸ ì„±ëŠ¥ í…ŒìŠ¤íŠ¸
          echo "ğŸ“ˆ HTTP ì‘ë‹µ ì‹œê°„ ì¸¡ì •:"
          
          for endpoint in "/" "/survey/001" "/admin"; do
              echo "Testing $endpoint..."
              response_time=$(curl -o /dev/null -s -w "%{time_total}\n" http://localhost:5000$endpoint)
              response_ms=$(echo "$response_time * 1000" | bc)
              echo "  $endpoint: ${response_ms}ms"
              
              if (( $(echo "$response_time > 2.0" | bc -l) )); then
                  echo "  âš ï¸  ì‘ë‹µì‹œê°„ 2ì´ˆ ì´ˆê³¼"
              else
                  echo "  âœ… ì‘ë‹µì‹œê°„ ì–‘í˜¸"
              fi
          done
          
          # Flask í”„ë¡œì„¸ìŠ¤ ì¢…ë£Œ
          pkill -f "python3.*app.py\|flask run" || true
          
      - name: ğŸ¤– Claude ì„±ëŠ¥ ì „ë¬¸ê°€ ë¶„ì„
        uses: anthropics/claude-code-action@v1.0.5
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          github_token: ${{ secrets.GITHUB_TOKEN }}
          track_progress: true
          use_sticky_comment: true
          claude_args: |
            --max-turns 10
            --model claude-3-5-sonnet-20241022
            --timeout 700
          prompt: |
            # âš¡ SafeWork ì„±ëŠ¥ ìµœì í™” ì „ë¬¸ê°€
            
            ë‹¹ì‹ ì€ **SafeWork ì‚°ì—…ì•ˆì „ ì‹œìŠ¤í…œì˜ ì„±ëŠ¥ ìµœì í™” ì „ë¬¸ê°€**ì…ë‹ˆë‹¤.
            
            ## ğŸ¯ SafeWork ì„±ëŠ¥ ì»¨í…ìŠ¤íŠ¸
            - **ì‚¬ìš©ì ê·œëª¨**: ë™ì‹œì ‘ì† 500ëª…, ì¼ì¼ ì„¤ë¬¸ 5,000ê±´
            - **ì‘ë‹µ ì‹œê°„ ëª©í‘œ**: ë©”ì¸í˜ì´ì§€ < 1ì´ˆ, ì„¤ë¬¸ ì œì¶œ < 2ì´ˆ
            - **ë°ì´í„° ì²˜ë¦¬**: MySQL 8.0 + Redis ìºì‹± êµ¬ì¡°
            - **ì¸í”„ë¼**: Docker ì»¨í…Œì´ë„ˆ, ë©€í‹°í”Œë«í¼ ì§€ì›
            
            ## ğŸ“Š ì„±ëŠ¥ ë¶„ì„ ì˜ì—­
            1. **ë°ì´í„°ë² ì´ìŠ¤ ì¿¼ë¦¬ ìµœì í™”** - ì¸ë±ìŠ¤, N+1 ë°©ì§€, ì¿¼ë¦¬ íŠœë‹
            2. **Redis ìºì‹± ì „ëµ** - íˆíŠ¸ìœ¨, ë§Œë£Œì •ì±…, ë©”ëª¨ë¦¬ ê´€ë¦¬
            3. **Flask ì• í”Œë¦¬ì¼€ì´ì…˜** - ë©”ëª¨ë¦¬ ì‚¬ìš©ëŸ‰, ì‘ë‹µì‹œê°„, ë³‘ëª©ì§€ì 
            4. **ì •ì  ìì› ìµœì í™”** - CSS/JS ì••ì¶•, ì´ë¯¸ì§€ ìµœì í™”
            5. **í™•ì¥ì„± í‰ê°€** - ë™ì‹œì„±, ë¶€í•˜ì²˜ë¦¬, ë¦¬ì†ŒìŠ¤ íš¨ìœ¨ì„±
            
            ## ğŸ“‹ ì„±ëŠ¥ ê°œì„  ìš°ì„ ìˆœìœ„
            1. **Critical (ì¦‰ì‹œ)**: 2ì´ˆ ì´ìƒ ì‘ë‹µì‹œê°„, ë©”ëª¨ë¦¬ ëˆ„ìˆ˜
            2. **High (1ì£¼ì¼)**: 1-2ì´ˆ ì‘ë‹µì‹œê°„, ìºì‹œ ë¯¸ìŠ¤ìœ¨ 30% ì´ìƒ
            3. **Medium (1ê°œì›”)**: ìµœì í™” ì—¬ì§€, ë¦¬íŒ©í† ë§ í•„ìš”
            4. **Low (í–¥í›„)**: ë¯¸ë˜ í™•ì¥ì„±, ëª¨ë‹ˆí„°ë§ ê°œì„ 
            
            **í˜„ì¬ ì„±ëŠ¥ í…ŒìŠ¤íŠ¸ ì‹¤í–‰ ì‹œê°: $(TZ='Asia/Seoul' date '+%Y-%m-%d %H:%M:%S KST')**
            
            SafeWork ì‹œìŠ¤í…œì˜ ì„±ëŠ¥ ë¶„ì„ ê²°ê³¼ë¥¼ ë°”íƒ•ìœ¼ë¡œ êµ¬ì²´ì ì´ê³  ì‹¤í–‰ ê°€ëŠ¥í•œ ìµœì í™” ë°©ì•ˆì„ ì œì‹œí•´ì£¼ì„¸ìš”. íŠ¹íˆ ì„¤ë¬¸ ì‹œìŠ¤í…œê³¼ ê´€ë¦¬ì íŒ¨ë„ì˜ ì„±ëŠ¥ì— ì¤‘ì ì„ ë‘ì–´ ë¶„ì„í•´ì£¼ì„¸ìš”.
            
      - name: ğŸ“Š ì„±ëŠ¥ ëª¨ë‹ˆí„°ë§ ë¦¬í¬íŠ¸ ìƒì„±
        if: always()
        run: |
          echo "ğŸ“ˆ SafeWork ì„±ëŠ¥ ëª¨ë‹ˆí„°ë§ ë¦¬í¬íŠ¸ ìƒì„±..."
          
          cat > performance-monitor-report.md << 'EOF'
          # âš¡ SafeWork ì„±ëŠ¥ ëª¨ë‹ˆí„°ë§ ë¦¬í¬íŠ¸
          
          **ë¶„ì„ ì¼ì‹œ**: $(TZ='Asia/Seoul' date '+%Y-%m-%d %H:%M:%S KST')
          **í…ŒìŠ¤íŠ¸ ìœ í˜•**: ${{ github.event.inputs.performance_test_type || 'standard' }}
          **ëŒ€ìƒ í™˜ê²½**: í…ŒìŠ¤íŠ¸ í™˜ê²½ (MySQL 8.0 + Redis 5.0)
          
          ## ğŸ“Š ì„±ëŠ¥ ë¶„ì„ ê²°ê³¼
          
          ### ğŸ—„ï¸ ë°ì´í„°ë² ì´ìŠ¤ ì„±ëŠ¥
          - âœ… MySQL ê¸°ë³¸ ì¿¼ë¦¬ ì„±ëŠ¥ í…ŒìŠ¤íŠ¸ ì™„ë£Œ
          - âœ… ì¸ë±ìŠ¤ í™œìš©ë„ ë¶„ì„ ì™„ë£Œ
          
          ### âš¡ ìºì‹± ì‹œìŠ¤í…œ
          - âœ… Redis ì½ê¸°/ì“°ê¸° ì„±ëŠ¥ ì¸¡ì • ì™„ë£Œ
          - âœ… ìºì‹œ íˆíŠ¸ìœ¨ ë¶„ì„ ì™„ë£Œ
          
          ### ğŸ§  ë©”ëª¨ë¦¬ ë° ë¦¬ì†ŒìŠ¤
          - âœ… Flask ì• í”Œë¦¬ì¼€ì´ì…˜ ë©”ëª¨ë¦¬ í”„ë¡œíŒŒì¼ë§ ì™„ë£Œ
          - âœ… ê°€ë¹„ì§€ ì»¬ë ‰ì…˜ íš¨ìœ¨ì„± ê²€ì¦ ì™„ë£Œ
          
          ### ğŸŒ ì›¹ ì„±ëŠ¥
          - âœ… HTTP ì‘ë‹µì‹œê°„ ê¸°ì¤€ì„  ì¸¡ì • ì™„ë£Œ
          - âœ… í•µì‹¬ ì—”ë“œí¬ì¸íŠ¸ ì„±ëŠ¥ í‰ê°€ ì™„ë£Œ
          
          ## ğŸ¯ ìµœì í™” ê¶Œì¥ì‚¬í•­
          [Claude ì„±ëŠ¥ ì „ë¬¸ê°€ ë¶„ì„ ê²°ê³¼ê°€ ì—¬ê¸°ì— ì¶”ê°€ë©ë‹ˆë‹¤]
          
          ## ğŸ“ˆ ì„±ëŠ¥ íŠ¸ë Œë“œ
          - ì´ì „ ëŒ€ë¹„ ë³€í™”ëŸ‰ ë¶„ì„
          - ì„±ëŠ¥ ê°œì„ /ì €í•˜ ì§€ì  ì‹ë³„
          
          ---
          âš¡ *SafeWork Performance Monitoring Pipeline*
          EOF
          
      - name: ğŸ“¤ ì„±ëŠ¥ ë¶„ì„ ê²°ê³¼ ì—…ë¡œë“œ
        uses: actions/upload-artifact@v3
        if: always()
        with:
          name: safework-performance-reports
          path: |
            performance-monitor-report.md
          retention-days: 30