name: Claude
on:
  issues:
    types: [opened, edited, reopened, labeled]
  issue_comment:
    types: [created, edited]
  pull_request:
    types: [opened, edited, synchronize, reopened, ready_for_review]
  pull_request_review:
    types: [submitted]
  workflow_run:
    workflows: ["Deploy", "Documentation"]
    types: [completed]
  workflow_dispatch:
    inputs:
      issue_number:
        description: 'Issue number to process'
        required: false
        type: string
      pr_number:
        description: 'PR number to process'
        required: false
        type: string
      custom_prompt:
        description: 'Custom prompt for Claude'
        required: false
        type: string
        default: 'Analyze and provide assistance'
      analysis_mode:
        description: 'Analysis mode selection'
        required: false
        type: choice
        options:
        - 'auto'
        - 'issue_triage'
        - 'ci_fix'
        - 'code_review'
        - 'documentation'
        default: 'auto'

# Enhanced permissions for full GitHub integration
permissions:
  contents: write
  issues: write
  pull-requests: write
  actions: read
  checks: write
  discussions: read
  repository-projects: read
  packages: read
  id-token: write

env:
  CLAUDE_MODEL: claude-3-5-sonnet-20241022
  MAX_TURNS: 10
  TRACK_PROGRESS: true

jobs:
  claude-automation:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    # Enhanced condition logic for comprehensive triggering
    if: |
      github.event_name == 'workflow_dispatch' ||
      (github.event_name == 'issues' && 
       (github.event.action == 'opened' || 
        github.event.action == 'edited' || 
        github.event.action == 'reopened' ||
        github.event.action == 'labeled')) ||
      (github.event_name == 'issue_comment' && 
       github.event.action == 'created' && 
       (contains(github.event.comment.body, '@claude') || 
        contains(github.event.comment.body, '@Claude') ||
        contains(github.event.comment.body, 'claude') ||
        github.actor == 'claude[bot]')) ||
      (github.event_name == 'pull_request' && 
       (github.event.action == 'opened' || 
        github.event.action == 'edited' || 
        github.event.action == 'synchronize' || 
        github.event.action == 'reopened' ||
        github.event.action == 'ready_for_review')) ||
      (github.event_name == 'pull_request_review' && 
       github.event.action == 'submitted')
    
    steps:
      - name: Repository Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: CI Failure Detection
        id: ci-failure
        if: github.event_name == 'workflow_run' && github.event.workflow_run.conclusion == 'failure'
        run: |
          echo "ğŸš¨ CI ì‹¤íŒ¨ ê°ì§€: ${{ github.event.workflow_run.name }}"
          echo "workflow_name=${{ github.event.workflow_run.name }}" >> $GITHUB_OUTPUT
          echo "workflow_status=${{ github.event.workflow_run.conclusion }}" >> $GITHUB_OUTPUT
          echo "ci_failure_detected=true" >> $GITHUB_OUTPUT
          
          # CI ì‹¤íŒ¨ ë¡œê·¸ ë¶„ì„ì„ ìœ„í•œ ì •ë³´ ìˆ˜ì§‘
          echo "head_sha=${{ github.event.workflow_run.head_sha }}" >> $GITHUB_OUTPUT
          echo "run_id=${{ github.event.workflow_run.id }}" >> $GITHUB_OUTPUT

      - name: SafeWork Context Detection
        id: context
        run: |
          echo "ğŸ§  SafeWork ì»¨í…ìŠ¤íŠ¸ ë¶„ì„ ì‹œì‘..."
          
          # Event type detection
          EVENT_TYPE="${{ github.event_name }}"
          CONTEXT_TYPE="general"
          DOMAIN_CONTEXT="general"
          KOREAN_DETECTED="false"
          PRIORITY_LEVEL="normal"
          CI_FAILURE="${{ steps.ci-failure.outputs.ci_failure_detected || 'false' }}"
          ANALYSIS_MODE="${{ github.event.inputs.analysis_mode || 'auto' }}"
          
          # Content analysis based on event type and analysis mode
          case "$EVENT_TYPE" in
            "issues")
              if [ "$ANALYSIS_MODE" = "issue_triage" ]; then
                CONTEXT_TYPE="issue_triage"
                echo "ğŸ·ï¸ ì´ìŠˆ ë¶„ë¥˜ ëª¨ë“œ í™œì„±í™”"
              else
                CONTEXT_TYPE="issue_analysis"
                echo "ğŸ“‹ Issue ë¶„ì„ ëª¨ë“œ í™œì„±í™”"
              fi
              ;;
            "issue_comment")
              CONTEXT_TYPE="issue_interaction"
              echo "ğŸ’¬ Issue ìƒí˜¸ì‘ìš© ëª¨ë“œ í™œì„±í™”"
              ;;
            "pull_request")
              if [ "$ANALYSIS_MODE" = "code_review" ]; then
                CONTEXT_TYPE="comprehensive_review"
                echo "ğŸ”¬ ì¢…í•© ì½”ë“œ ë¦¬ë·° ëª¨ë“œ í™œì„±í™”"
              else
                CONTEXT_TYPE="code_review"
                echo "ğŸ” ì½”ë“œ ë¦¬ë·° ëª¨ë“œ í™œì„±í™”"
              fi
              ;;
            "pull_request_review")
              CONTEXT_TYPE="review_response"
              echo "ğŸ“ ë¦¬ë·° ì‘ë‹µ ëª¨ë“œ í™œì„±í™”"
              ;;
            "workflow_run")
              if [ "$CI_FAILURE" = "true" ]; then
                CONTEXT_TYPE="ci_auto_fix"
                PRIORITY_LEVEL="high"
                echo "ğŸ”§ CI ìë™ ìˆ˜ì • ëª¨ë“œ í™œì„±í™”"
              fi
              ;;
            "workflow_dispatch")
              if [ "$ANALYSIS_MODE" = "documentation" ]; then
                CONTEXT_TYPE="documentation_update"
                echo "ğŸ“š ë¬¸ì„œí™” ëª¨ë“œ í™œì„±í™”"
              else
                CONTEXT_TYPE="manual_execution"
                echo "ğŸ¯ ìˆ˜ë™ ì‹¤í–‰ ëª¨ë“œ í™œì„±í™”"
              fi
              ;;
          esac
          
          # SafeWork domain detection with enhanced patterns
          DOMAIN_PATTERNS=(
            "ì„¤ë¬¸|survey|001|002|ê·¼ê³¨ê²©|musculoskeletal:survey_system"
            "ê´€ë¦¬ì|admin|safework|dashboard:admin_system" 
            "ì˜ë£Œ|health|medical|ê²€ì§„|medication:medical_system"
            "ë¬¸ì„œ|document|upload|download:document_system"
            "api|ì—°ë™|integration|v2:api_system"
            "ì¸ì¦|auth|login|password|jwt:auth_system"
            "ë°°í¬|deploy|docker|watchtower|registry:deployment_system"
            "ì›Œí¬í”Œë¡œìš°|workflow|github|actions|ci/cd:workflow_system"
            "ë°ì´í„°ë² ì´ìŠ¤|database|mysql|redis|db:database_system"
          )
          
          # Check for Korean content and domain context
          for pattern in "${DOMAIN_PATTERNS[@]}"; do
            keywords="${pattern%:*}"
            domain="${pattern#*:}"
            if echo "${{ github.event_name }} ${{ github.actor }}" | grep -qiE "($keywords)"; then
              DOMAIN_CONTEXT="$domain"
              break
            fi
          done
          
          # Priority detection
          if echo "${{ github.event_name }}" | grep -qiE "(urgent|critical|ê¸´ê¸‰|ì¤‘ìš”|P0|high)"; then
            PRIORITY_LEVEL="high"
          fi
          
          # Korean language detection
          if echo "${{ github.actor }} ${{ github.event_name }}" | grep -q '[ê°€-í£]'; then
            KOREAN_DETECTED="true"
          fi
          
          # Set outputs
          echo "context_type=$CONTEXT_TYPE" >> $GITHUB_OUTPUT
          echo "domain_context=$DOMAIN_CONTEXT" >> $GITHUB_OUTPUT  
          echo "korean_detected=$KOREAN_DETECTED" >> $GITHUB_OUTPUT
          echo "priority_level=$PRIORITY_LEVEL" >> $GITHUB_OUTPUT
          echo "event_type=$EVENT_TYPE" >> $GITHUB_OUTPUT
          
          echo "ğŸ“Š ì»¨í…ìŠ¤íŠ¸ ë¶„ì„ ì™„ë£Œ:"
          echo "  - ì´ë²¤íŠ¸: $EVENT_TYPE"
          echo "  - ì»¨í…ìŠ¤íŠ¸: $CONTEXT_TYPE"  
          echo "  - ë„ë©”ì¸: $DOMAIN_CONTEXT"
          echo "  - í•œêµ­ì–´: $KOREAN_DETECTED"
          echo "  - ìš°ì„ ìˆœìœ„: $PRIORITY_LEVEL"

      - name: Claude Code Action Enhanced
        uses: anthropics/claude-code-action@v1
        with:
          # OAuth Authentication (Enhanced Security)
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          github_token: ${{ secrets.GITHUB_TOKEN }}
          
          # Advanced Configuration
          track_progress: ${{ env.TRACK_PROGRESS }}
          trigger_phrase: "@claude"
          use_sticky_comment: true
          use_commit_signing: false
          branch_prefix: "claude-safework/"
          
          # Enhanced Claude Arguments
          claude_args: |
            --model ${{ env.CLAUDE_MODEL }}
            --max-turns ${{ env.MAX_TURNS }}
            --timeout 1800
            --verbose
          
          # Dynamic Context-Aware Prompt
          prompt: |
            You are Claude, an advanced AI assistant specialized in SafeWork industrial health & safety management system.
            
            ## ğŸš¨ Special Context Analysis
            **CI Failure Detected**: ${{ steps.ci-failure.outputs.ci_failure_detected || 'false' }}
            **Failed Workflow**: ${{ steps.ci-failure.outputs.workflow_name || 'N/A' }}
            **Analysis Mode**: ${{ steps.context.outputs.context_type }}
            **Priority Level**: ${{ steps.context.outputs.priority_level }}
            
            ## ğŸ¯ Mode-Specific Instructions
            
            ### CI Auto-Fix Mode (`ci_auto_fix`)
            When CI failures are detected, focus on:
            1. **Root Cause Analysis**: Analyze workflow logs and identify failure patterns
            2. **Automated Resolution**: Fix common issues (dependency conflicts, syntax errors, test failures)
            3. **Prevention Strategies**: Suggest improvements to prevent similar failures
            4. **Quick Recovery**: Prioritize fast, reliable fixes over perfect solutions
            
            ### Issue Triage Mode (`issue_triage`)  
            For intelligent issue classification:
            1. **Automated Labeling**: Apply appropriate labels (bug, feature, enhancement, documentation)
            2. **Priority Assessment**: Evaluate impact and urgency (P0-Critical, P1-High, P2-Medium, P3-Low)
            3. **Assignment Suggestions**: Recommend appropriate team members based on expertise
            4. **Resolution Estimates**: Provide time estimates and complexity analysis
            
            ### Comprehensive Review Mode (`comprehensive_review`)
            For thorough PR analysis:
            1. **Security Review**: Check for vulnerabilities, authentication issues, data validation
            2. **Performance Impact**: Analyze potential performance implications
            3. **Architecture Compliance**: Ensure adherence to SafeWork patterns and standards
            4. **Test Coverage**: Verify adequate test coverage for changes
            
            ### Documentation Update Mode (`documentation_update`)
            For comprehensive documentation maintenance:
            1. **Code Documentation**: Update inline comments and docstrings
            2. **README Updates**: Keep project documentation current with code changes
            3. **API Documentation**: Generate/update API endpoint documentation
            4. **Architecture Diagrams**: Suggest updates to system architecture docs
            
            ## ğŸ¯ Current Context Analysis
            **Event Type**: ${{ steps.context.outputs.event_type }}
            **Context Mode**: ${{ steps.context.outputs.context_type }}
            **Domain Focus**: ${{ steps.context.outputs.domain_context }}
            **Korean Language**: ${{ steps.context.outputs.korean_detected }}
            **Priority Level**: ${{ steps.context.outputs.priority_level }}
            
            ## ğŸ­ SafeWork System Overview
            SafeWork is a Flask 3.0+ industrial health & safety management platform with:
            
            ### Core Architecture
            - **Backend**: Python Flask 3.0+, SQLAlchemy 2.0, Redis 5.0
            - **Database**: MySQL 8.0 UTF8MB4, custom migration system
            - **Frontend**: Bootstrap 4.6, jQuery, Font Awesome
            - **Infrastructure**: Docker, GitHub Actions, registry.jclee.me, Watchtower
            
            ### Domain Systems
            1. **Survey System** (`survey_system`):
               - Form 001: 16-part musculoskeletal symptom surveys
               - Form 002: New employee health checkups
               - Anonymous submissions (user_id=1), Korean UI
               - Conditional JavaScript logic, pain scale rating (1-5)
            
            2. **Admin System** (`admin_system`):
               - 13 SafeWork panels: workers, health_checks, medical_visits, medications, consultations, health_programs, special_management, environment_measurements, risk_assessment, msds, protective_equipment, education, certifications
               - Bootstrap 4.6 UI, jQuery AJAX, CSRF protection
               - Pagination (20 items/page), audit logging
            
            3. **Medical System** (`medical_system`):
               - PHI compliance, medication expiry tracking
               - Health checkup workflows, dosage management
            
            4. **Document System** (`document_system`):
               - Version control, access logs, category management
               - Public/private/admin permissions, Korean filename support
            
            5. **API System** (`api_system`):
               - RESTful v2: `/api/safework/v2/*`
               - CRUD for all SafeWork entities, JSON responses
            
            6. **Auth System** (`auth_system`):
               - Flask-Login, session management, @login_required
               - Password security, rate limiting
            
            7. **Deployment System** (`deployment_system`):
               - Docker multi-platform (amd64/arm64)
               - GitHub Actions â†’ registry.jclee.me â†’ Watchtower
               - Automatic updates and health monitoring
            
            8. **Workflow System** (`workflow_system`):
               - 5 GitHub Actions workflows: Claude, Deploy, Documentation, Review, Code
               - CI/CD pipeline with automated testing and deployment
            
            9. **Database System** (`database_system`):
               - MySQL 8.0 with custom migrations, KST timezone
               - Redis caching, connection pooling
            
            ## ğŸ¯ Context-Specific Instructions
            
            ### Issue Analysis (`issue_analysis`)
            - Analyze issue content for SafeWork domain relevance
            - Identify specific system components affected
            - Provide actionable solutions with code examples
            - Create implementation plans with file paths
            
            ### Issue Interaction (`issue_interaction`)
            - Respond to user questions with SafeWork expertise
            - Provide code fixes, debugging assistance
            - Suggest improvements and best practices
            
            ### Code Review (`code_review`)
            - Review PR changes for SafeWork compatibility
            - Check MySQL 8.0 UTF8MB4 compatibility
            - Validate Flask patterns and security practices
            - Ensure Korean localization support
            
            ### Review Response (`review_response`)
            - Address reviewer feedback constructively
            - Implement requested changes with proper testing
            - Maintain SafeWork coding standards
            
            ### Manual Execution (`manual_execution`)
            - Process custom prompts with full SafeWork context
            - Execute complex automation tasks
            - Generate reports and documentation
            
            ## ğŸ“‹ Response Guidelines
            
            ### Korean Language Support
            - Use Korean for communication when `korean_detected=true`
            - Maintain technical terms in English with Korean explanations
            - Provide Korean UI text for user-facing features
            
            ### Technical Standards
            - Always specify exact file paths (e.g., `app/routes/admin.py:123`)
            - Ensure MySQL 8.0 UTF8MB4 compatibility
            - Follow Flask factory pattern and Blueprint architecture
            - Use proper CSRF protection and @login_required decorators
            - Implement proper error handling with db.session.rollback()
            
            ### Priority Handling
            - **High Priority**: Immediate response, detailed solutions
            - **Normal Priority**: Thorough analysis, step-by-step guidance
            - **Low Priority**: Best practices, optimization suggestions
            
            ### Deployment Considerations
            - Consider impact on production SafeWork service
            - Suggest testing procedures for registry.jclee.me deployment
            - Include Watchtower update considerations
            - Validate Docker multi-platform compatibility
            
            ## ğŸš€ Advanced Capabilities
            - File creation, modification, and deletion
            - Multi-file operations and refactoring
            - Database migration generation
            - Test case creation and validation
            - Documentation generation and updates
            - Performance optimization recommendations
            
            ## ğŸ¯ Current Task
            Please analyze the current GitHub event and provide comprehensive assistance based on the detected SafeWork context. Focus on practical, actionable solutions that maintain system integrity and follow established patterns.
            
            **Custom Instructions**: ${{ github.event.inputs.custom_prompt }}

      - name: Deployment Trigger Analysis
        id: deploy-check
        if: success()
        run: |
          echo "ğŸš€ ë°°í¬ íŠ¸ë¦¬ê±° ë¶„ì„ ì¤‘..."
          
          SHOULD_DEPLOY="false"
          DEPLOY_REASON=""
          
          # Check if Claude made code changes
          if git diff --quiet HEAD~1 HEAD; then
            echo "ğŸ“‹ ì½”ë“œ ë³€ê²½ì‚¬í•­ ì—†ìŒ"
            DEPLOY_REASON="no_changes"
          else
            echo "âœ… ì½”ë“œ ë³€ê²½ì‚¬í•­ ê°ì§€ë¨"
            SHOULD_DEPLOY="true"
            DEPLOY_REASON="claude_code_changes"
          fi
          
          # Check for specific deployment triggers
          if [[ "${{ steps.context.outputs.domain_context }}" == "deployment_system" ]]; then
            SHOULD_DEPLOY="true" 
            DEPLOY_REASON="deployment_domain_detected"
          fi
          
          # High priority issues should trigger deployment
          if [[ "${{ steps.context.outputs.priority_level }}" == "high" ]]; then
            SHOULD_DEPLOY="true"
            DEPLOY_REASON="high_priority_fix"
          fi
          
          echo "should_deploy=$SHOULD_DEPLOY" >> $GITHUB_OUTPUT
          echo "deploy_reason=$DEPLOY_REASON" >> $GITHUB_OUTPUT
          
          if [[ "$SHOULD_DEPLOY" == "true" ]]; then
            echo "ğŸ¯ ë°°í¬ íŠ¸ë¦¬ê±° í™œì„±í™”: $DEPLOY_REASON"
          else
            echo "â­ï¸ ë°°í¬ ê±´ë„ˆëœ€: $DEPLOY_REASON"
          fi

      - name: Automated Issue Labeling
        if: steps.context.outputs.context_type == 'issue_triage' || steps.context.outputs.context_type == 'issue_analysis'
        run: |
          echo "ğŸ·ï¸ ìë™ ì´ìŠˆ ë¼ë²¨ë§ ì‹œì‘..."
          
          ISSUE_NUMBER="${{ github.event.issue.number || github.event.inputs.issue_number }}"
          
          if [ ! -z "$ISSUE_NUMBER" ]; then
            # SafeWork ë„ë©”ì¸ë³„ ë¼ë²¨ë§
            DOMAIN="${{ steps.context.outputs.domain_context }}"
            case "$DOMAIN" in
              "survey_system")
                gh issue edit $ISSUE_NUMBER --add-label "ğŸ“‹ survey" --add-label "001/002"
                ;;
              "admin_system")
                gh issue edit $ISSUE_NUMBER --add-label "ğŸ‘¨â€ğŸ’¼ admin" --add-label "safework-panels"
                ;;
              "medical_system")
                gh issue edit $ISSUE_NUMBER --add-label "ğŸ¥ medical" --add-label "health-check"
                ;;
              "api_system")
                gh issue edit $ISSUE_NUMBER --add-label "ğŸ”Œ api" --add-label "v2"
                ;;
              "deployment_system")
                gh issue edit $ISSUE_NUMBER --add-label "ğŸš€ deployment" --add-label "ci-cd"
                ;;
            esac
            
            # ìš°ì„ ìˆœìœ„ ë¼ë²¨ë§
            PRIORITY="${{ steps.context.outputs.priority_level }}"
            case "$PRIORITY" in
              "high")
                gh issue edit $ISSUE_NUMBER --add-label "ğŸ”¥ P1-High"
                ;;
              "normal")
                gh issue edit $ISSUE_NUMBER --add-label "ğŸ“ P2-Medium" 
                ;;
            esac
            
            echo "âœ… ì´ìŠˆ #$ISSUE_NUMBER ìë™ ë¼ë²¨ë§ ì™„ë£Œ"
          fi

      - name: Post-Processing & Notification
        if: always()
        run: |
          echo "ğŸ¯ Claude ì‘ì—… ì™„ë£Œ"
          echo "ğŸ“Š ì²˜ë¦¬ ìƒíƒœ: ${{ job.status }}"
          echo "ğŸª ì´ë²¤íŠ¸: ${{ github.event_name }}"
          echo "ğŸ·ï¸ ì»¨í…ìŠ¤íŠ¸: ${{ steps.context.outputs.context_type }}"
          echo "ğŸ­ ë„ë©”ì¸: ${{ steps.context.outputs.domain_context }}"
          
          # CI ìë™ ìˆ˜ì • ê²°ê³¼ ë³´ê³ 
          if [ "${{ steps.context.outputs.context_type }}" = "ci_auto_fix" ]; then
            echo "ğŸ”§ CI ìë™ ìˆ˜ì • ëª¨ë“œ ì‹¤í–‰ë¨"
            echo "ğŸ“‹ ì‹¤íŒ¨í•œ ì›Œí¬í”Œë¡œìš°: ${{ steps.ci-failure.outputs.workflow_name }}"
          fi
          
          if [[ "${{ job.status }}" == "success" ]]; then
            echo "âœ… SafeWork AI ìë™í™” ì„±ê³µ"
            
            # Success notification for Korean users
            if [[ "${{ steps.context.outputs.korean_detected }}" == "true" ]]; then
              echo "ğŸ‡°ğŸ‡· í•œêµ­ì–´ ì»¨í…ìŠ¤íŠ¸ì—ì„œ ì„±ê³µì ìœ¼ë¡œ ì²˜ë¦¬ë˜ì—ˆìŠµë‹ˆë‹¤."
            fi
            
            # Check if deployment should be triggered
            if [[ "${{ steps.deploy-check.outputs.should_deploy }}" == "true" ]]; then
              echo "ğŸš€ ë°°í¬ íŒŒì´í”„ë¼ì¸ì´ ê³§ ì‹œì‘ë©ë‹ˆë‹¤."
              echo "ğŸ“‹ ë°°í¬ ì´ìœ : ${{ steps.deploy-check.outputs.deploy_reason }}"
            fi
          else
            echo "âš ï¸ SafeWork AI ìë™í™” ì™„ë£Œ (ì¼ë¶€ ë¬¸ì œ ë°œìƒ)"
          fi
          
          # Generate summary for complex operations
          if [[ "${{ steps.context.outputs.context_type }}" != "general" ]]; then
            echo "ğŸ“„ ì‘ì—… ìš”ì•½:"
            echo "  - ëŒ€ìƒ ì‹œìŠ¤í…œ: SafeWork ${{ steps.context.outputs.domain_context }}"
            echo "  - ì²˜ë¦¬ ëª¨ë“œ: ${{ steps.context.outputs.context_type }}"
            echo "  - ìš°ì„ ìˆœìœ„: ${{ steps.context.outputs.priority_level }}"
            echo "  - ì–¸ì–´ ì§€ì›: ${{ steps.context.outputs.korean_detected == 'true' && 'í•œêµ­ì–´' || 'ì˜ì–´' }}"
          fi

  # Trigger deployment workflow if needed
  trigger-deployment:
    needs: [claude-automation]
    if: needs.claude-automation.outputs.should_deploy == 'true' || needs.claude-automation.result == 'success'
    uses: ./.github/workflows/main_deploy.yml
    secrets: inherit
    with:
      deployment_reason: "Claude automation completed successfully"
      force_deploy: false