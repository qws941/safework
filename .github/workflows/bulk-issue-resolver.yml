name: ğŸš€ ëŒ€ëŸ‰ ì´ìŠˆ ìë™ í•´ê²°ê¸°

on:
  workflow_dispatch:
    inputs:
      max_issues:
        description: 'ì²˜ë¦¬í•  ìµœëŒ€ ì´ìŠˆ ìˆ˜'
        required: false
        default: '10'
        type: string
      issue_filter:
        description: 'ì´ìŠˆ í•„í„° (all/feature/bug/test)'
        required: false
        default: 'all'
        type: choice
        options:
        - all
        - feature
        - bug  
        - test

env:
  TZ: Asia/Seoul

jobs:
  bulk-resolve:
    runs-on: ubuntu-latest
    timeout-minutes: 120
    permissions:
      contents: write
      issues: write
      pull-requests: write
      actions: read
      checks: read
      
    steps:
      - name: ğŸ” ì—´ë¦° ì´ìŠˆ ëŒ€ëŸ‰ ë¶„ì„ ë° Claude í• ë‹¹
        uses: actions/github-script@v7
        with:
          script: |
            const { owner, repo } = context.repo;
            const maxIssues = parseInt('${{ github.event.inputs.max_issues }}') || 10;
            const issueFilter = '${{ github.event.inputs.issue_filter }}' || 'all';
            
            console.log(`ğŸš€ ëŒ€ëŸ‰ ì´ìŠˆ ìë™ í•´ê²° ì‹œì‘!`);
            console.log(`ğŸ“Š ì²˜ë¦¬ ì„¤ì •: ìµœëŒ€ ${maxIssues}ê°œ ì´ìŠˆ, í•„í„°: ${issueFilter}`);
            
            try {
              // ì—´ë¦° ì´ìŠˆ ì¡°íšŒ
              const openIssues = await github.rest.issues.listForRepo({
                owner,
                repo,
                state: 'open',
                per_page: maxIssues,
                sort: 'created',
                direction: 'desc'
              });
              
              console.log(`ğŸ“‹ ë°œê²¬ëœ ì—´ë¦° ì´ìŠˆ: ${openIssues.data.length}ê°œ`);
              
              // ì´ìŠˆ í•„í„°ë§
              let filteredIssues = openIssues.data.filter(issue => {
                if (issue.pull_request) return false; // PR ì œì™¸
                
                const title = issue.title.toLowerCase();
                const labels = issue.labels.map(label => 
                  typeof label === 'string' ? label : label.name
                ).join(' ').toLowerCase();
                
                switch(issueFilter) {
                  case 'feature':
                    return title.includes('[feature]') || title.includes('feature') || 
                           labels.includes('feature') || labels.includes('enhancement');
                  case 'bug':
                    return title.includes('[bug]') || title.includes('bug') || 
                           labels.includes('bug');
                  case 'test':
                    return title.includes('[test]') || title.includes('test') || 
                           title.includes('ğŸ§ª');
                  default:
                    return true;
                }
              });
              
              console.log(`ğŸ¯ í•„í„°ë§ëœ ì´ìŠˆ: ${filteredIssues.length}ê°œ`);
              
              if (filteredIssues.length === 0) {
                console.log('âŒ ì²˜ë¦¬í•  ì´ìŠˆê°€ ì—†ìŠµë‹ˆë‹¤.');
                return;
              }
              
              // ëŒ€ëŸ‰ ì²˜ë¦¬ ì‹œì‘ ì•Œë¦¼
              const bulkProcessComment = `ğŸš€ **ëŒ€ëŸ‰ ì´ìŠˆ ìë™ í•´ê²° ì‹œì‘**

**ğŸ“Š ì²˜ë¦¬ í˜„í™©:**
- ëŒ€ìƒ ì´ìŠˆ: ${filteredIssues.length}ê°œ
- í•„í„°: ${issueFilter}
- ì²˜ë¦¬ ì‹œê°„: ${new Date().toLocaleString('ko-KR')}

**ğŸ¤– ì²˜ë¦¬ ë°©ì‹:**
ê° ì´ìŠˆì— @claudeê°€ ìë™ìœ¼ë¡œ í• ë‹¹ë˜ì–´ ìˆœì°¨ì ìœ¼ë¡œ í•´ê²°í•©ë‹ˆë‹¤.

**ğŸ“‹ ëŒ€ìƒ ì´ìŠˆ ëª©ë¡:**
${filteredIssues.map(issue => 
  `- #${issue.number}: ${issue.title}`
).join('\n')}

---
*ğŸ¤– ëŒ€ëŸ‰ ìë™í™” ì‹œìŠ¤í…œ by Enhanced Claude*`;
              
              // ê° ì´ìŠˆì— Claude í• ë‹¹ ëŒ“ê¸€ ì¶”ê°€
              const processedIssues = [];
              let successCount = 0;
              let errorCount = 0;
              
              for (const issue of filteredIssues) {
                try {
                  console.log(`ğŸ”„ ì´ìŠˆ #${issue.number} ì²˜ë¦¬ ì¤‘...`);
                  
                  // ì´ë¯¸ @claude ëŒ“ê¸€ì´ ìˆëŠ”ì§€ í™•ì¸
                  const comments = await github.rest.issues.listComments({
                    owner,
                    repo,
                    issue_number: issue.number,
                    per_page: 100
                  });
                  
                  const hasClaudeComment = comments.data.some(comment => 
                    comment.body && comment.body.includes('@claude')
                  );
                  
                  const hasClaudeInBody = issue.body && issue.body.includes('@claude');
                  
                  if (!hasClaudeComment && !hasClaudeInBody) {
                    // Claude í• ë‹¹ ëŒ“ê¸€ ì¶”ê°€
                    await github.rest.issues.createComment({
                      owner,
                      repo,
                      issue_number: issue.number,
                      body: `ğŸ¤– **ëŒ€ëŸ‰ ìë™ ì²˜ë¦¬ í• ë‹¹**

@claude ì´ ì´ìŠˆë¥¼ ìë™ìœ¼ë¡œ í•´ê²°í•´ ì£¼ì„¸ìš”!

**ğŸ“‹ ì´ìŠˆ ì •ë³´:**
- ì œëª©: ${issue.title}
- ìƒì„±ì¼: ${new Date(issue.created_at).toLocaleDateString('ko-KR')}
- ë¼ë²¨: ${issue.labels.map(l => typeof l === 'string' ? l : l.name).join(', ') || 'ì—†ìŒ'}

**ğŸ¯ ì²˜ë¦¬ ì§€ì¹¨:**
1. ì´ìŠˆ ë‚´ìš©ì„ ì •í™•íˆ ë¶„ì„í•˜ì„¸ìš”
2. SafeWork í”„ë¡œì íŠ¸ íŒ¨í„´ì„ ë”°ë¼ êµ¬í˜„í•˜ì„¸ìš”
3. ì½”ë“œ ë³€ê²½ í›„ ì ì ˆí•œ ì»¤ë°‹ ë©”ì‹œì§€ë¡œ ì»¤ë°‹í•˜ì„¸ìš”
4. ì‘ì—… ì™„ë£Œ í›„ ì´ìŠˆë¥¼ ë‹«ì•„ì£¼ì„¸ìš”

**ìš°ì„ ìˆœìœ„**: ëŒ€ëŸ‰ ì²˜ë¦¬ (${new Date().toLocaleString('ko-KR')})

---
*ğŸš€ Enhanced Bulk Processing System*`
                    });
                    
                    successCount++;
                    processedIssues.push({
                      number: issue.number,
                      title: issue.title,
                      status: 'assigned'
                    });
                    
                    console.log(`âœ… ì´ìŠˆ #${issue.number} Claude í• ë‹¹ ì™„ë£Œ`);
                    
                    // API ì œí•œ ë°©ì§€ë¥¼ ìœ„í•œ ëŒ€ê¸°
                    await new Promise(resolve => setTimeout(resolve, 1000));
                    
                  } else {
                    console.log(`â© ì´ìŠˆ #${issue.number}ëŠ” ì´ë¯¸ Claude í• ë‹¹ë¨`);
                    processedIssues.push({
                      number: issue.number,
                      title: issue.title,
                      status: 'already_assigned'
                    });
                  }
                  
                } catch (error) {
                  console.error(`âŒ ì´ìŠˆ #${issue.number} ì²˜ë¦¬ ì‹¤íŒ¨:`, error.message);
                  errorCount++;
                  processedIssues.push({
                    number: issue.number,
                    title: issue.title,
                    status: 'error',
                    error: error.message
                  });
                }
              }
              
              // ìµœì¢… ê²°ê³¼ ìš”ì•½
              console.log(`\nğŸ“Š **ëŒ€ëŸ‰ ì²˜ë¦¬ ì™„ë£Œ!**`);
              console.log(`âœ… ì„±ê³µ: ${successCount}ê°œ`);
              console.log(`âŒ ì˜¤ë¥˜: ${errorCount}ê°œ`);
              console.log(`â© ì´ë¯¸ í• ë‹¹ë¨: ${processedIssues.filter(p => p.status === 'already_assigned').length}ê°œ`);
              
              // ê²°ê³¼ ìš”ì•½ ì´ìŠˆ ìƒì„±
              const summaryBody = `ğŸ¯ **ëŒ€ëŸ‰ ì´ìŠˆ ì²˜ë¦¬ ì™„ë£Œ ë³´ê³ ì„œ**

**ğŸ“Š ì²˜ë¦¬ ê²°ê³¼:**
- âœ… ìƒˆë¡œ í• ë‹¹ëœ ì´ìŠˆ: ${successCount}ê°œ
- â© ì´ë¯¸ í• ë‹¹ëœ ì´ìŠˆ: ${processedIssues.filter(p => p.status === 'already_assigned').length}ê°œ  
- âŒ ì²˜ë¦¬ ì‹¤íŒ¨: ${errorCount}ê°œ
- ğŸ“‹ ì´ ì²˜ë¦¬ëœ ì´ìŠˆ: ${processedIssues.length}ê°œ

**ğŸ” ìƒì„¸ ë‚´ì—­:**
${processedIssues.map(issue => {
  const statusIcon = issue.status === 'assigned' ? 'âœ…' : 
                    issue.status === 'already_assigned' ? 'â©' : 'âŒ';
  return `${statusIcon} #${issue.number}: ${issue.title} (${issue.status})`;
}).join('\n')}

**â° ì²˜ë¦¬ ì‹œê°„:** ${new Date().toLocaleString('ko-KR')}

**ğŸ¤– ë‹¤ìŒ ë‹¨ê³„:**
ê° ì´ìŠˆì—ì„œ Claudeê°€ ìë™ìœ¼ë¡œ ì‘ì—…ì„ ì‹œì‘í•©ë‹ˆë‹¤. GitHub Actions ë¡œê·¸ì—ì„œ ì§„í–‰ ìƒí™©ì„ í™•ì¸í•˜ì„¸ìš”.

---
*ğŸš€ Enhanced Bulk Issue Resolver v2.0*`;

              await github.rest.issues.create({
                owner,
                repo,
                title: `ğŸ“Š ëŒ€ëŸ‰ ì²˜ë¦¬ ì™„ë£Œ: ${successCount}ê°œ ì´ìŠˆ ìë™ í• ë‹¹ (${new Date().toLocaleDateString('ko-KR')})`,
                body: summaryBody,
                labels: ['ğŸ¤– claude-ready', 'ğŸ“Š bulk-processing', 'âœ… completed']
              });
              
              console.log(`ğŸ‰ ëŒ€ëŸ‰ ì²˜ë¦¬ ì™„ë£Œ! ê²°ê³¼ ì´ìŠˆê°€ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.`);
              
            } catch (error) {
              console.error('âŒ ëŒ€ëŸ‰ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ ë°œìƒ:', error);
              throw error;
            }