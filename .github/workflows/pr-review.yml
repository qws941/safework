name: ğŸ” Claude PR Review

concurrency:
  group: pr-review-${{ github.event.pull_request.number || github.run_id }}
  cancel-in-progress: true

on:
  pull_request:
    types: [opened, synchronize, ready_for_review, reopened]
  pull_request_review:
    types: [submitted]

permissions:
  contents: read
  pull-requests: write
  id-token: write

jobs:
  pr-review:
    if: github.event.pull_request.draft == false
    
    runs-on: ubuntu-latest
    timeout-minutes: 20
    
    steps:
      - name: ğŸ“‚ Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: ğŸ” PR Analysis
        id: pr_analysis
        run: |
          echo "ğŸ” Analyzing PR context..."
          
          # PR file analysis
          FILES_CHANGED=$(git diff --name-only ${{ github.event.pull_request.base.sha }}..${{ github.event.pull_request.head.sha }} | wc -l)
          LINES_CHANGED=$(git diff --stat ${{ github.event.pull_request.base.sha }}..${{ github.event.pull_request.head.sha }} | tail -1 | grep -o '[0-9]\+ insertion\|[0-9]\+ deletion' | head -1 | grep -o '[0-9]\+' || echo "0")
          
          echo "files_changed=$FILES_CHANGED" >> $GITHUB_OUTPUT
          echo "lines_changed=$LINES_CHANGED" >> $GITHUB_OUTPUT
          
          # Check for security-related file changes
          if git diff --name-only ${{ github.event.pull_request.base.sha }}..${{ github.event.pull_request.head.sha }} | grep -E "(auth|login|password|secret|key|token)" > /dev/null; then
            echo "security_related=true" >> $GITHUB_OUTPUT
          else
            echo "security_related=false" >> $GITHUB_OUTPUT
          fi
          
          # Check for database changes
          if git diff --name-only ${{ github.event.pull_request.base.sha }}..${{ github.event.pull_request.head.sha }} | grep -E "(models|migration|schema|sql)" > /dev/null; then
            echo "database_related=true" >> $GITHUB_OUTPUT
          else
            echo "database_related=false" >> $GITHUB_OUTPUT
          fi
          
          # Generate PR context file
          echo "=== SafeWork PR ì»¨í…ìŠ¤íŠ¸ ===" > pr_context.txt
          echo "PR ë²ˆí˜¸: ${{ github.event.pull_request.number }}" >> pr_context.txt
          echo "ì œëª©: ${{ github.event.pull_request.title }}" >> pr_context.txt
          echo "ì‘ì„±ì: ${{ github.event.pull_request.user.login }}" >> pr_context.txt
          echo "ìƒíƒœ: ${{ github.event.pull_request.state }}" >> pr_context.txt
          echo "ë¸Œëœì¹˜: ${{ github.event.pull_request.head.ref }} â†’ ${{ github.event.pull_request.base.ref }}" >> pr_context.txt
          echo "ë³€ê²½ íŒŒì¼ ìˆ˜: $FILES_CHANGED" >> pr_context.txt
          echo "ë³€ê²½ ë¼ì¸ ìˆ˜: $LINES_CHANGED" >> pr_context.txt
          echo "ë³´ì•ˆ ê´€ë ¨: ${{ steps.pr_analysis.outputs.security_related }}" >> pr_context.txt
          echo "ë°ì´í„°ë² ì´ìŠ¤ ê´€ë ¨: ${{ steps.pr_analysis.outputs.database_related }}" >> pr_context.txt
          echo "" >> pr_context.txt
          
          echo "=== PR ì„¤ëª… ===" >> pr_context.txt
          echo '${{ github.event.pull_request.body }}' >> pr_context.txt
          echo "" >> pr_context.txt
          
          echo "=== ë³€ê²½ëœ íŒŒì¼ ëª©ë¡ ===" >> pr_context.txt
          git diff --name-only ${{ github.event.pull_request.base.sha }}..${{ github.event.pull_request.head.sha }} >> pr_context.txt
          echo "" >> pr_context.txt
          
          echo "=== ë³€ê²½ ë‚´ìš© ìƒì„¸ ===" >> pr_context.txt
          git diff ${{ github.event.pull_request.base.sha }}..${{ github.event.pull_request.head.sha }} >> pr_context.txt
          
      - name: ğŸ” Comprehensive PR Review  
        uses: anthropics/claude-code-action@v1
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          anthropic_api_key: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          enable_progress: true  # Enable visual progress tracking
          enable_inline_comments: true  # Add inline code comments
          system_prompt: |
            You are Claude Code performing comprehensive PR reviews for SafeWork industrial safety management system.
            
            **Review Dimensions:**
            1. ğŸ—ï¸ **Code Quality**: Structure, patterns, maintainability
            2. ğŸ”’ **Security**: Vulnerabilities, auth, input validation  
            3. âš¡ **Performance**: Queries, caching, resource usage
            4. ğŸ§ª **Testing**: Coverage, test quality, edge cases
            5. ğŸ“ **Documentation**: Comments, README, API docs
            
            **SafeWork Context:**
            - Industrial safety management for Korean construction/manufacturing
            - Health surveys (001 Musculoskeletal, 002 New Employee)
            - SafeWork admin panels (13 specialized management areas)
            - PostgreSQL database with Redis caching
            - Anonymous survey access (user_id=1)
            - Bootstrap 4.6 + jQuery frontend
            
            **Review Standards:**
            - Korean workplace safety regulations compliance
            - Data privacy for health information
            - Mobile-responsive design for field workers
            - Korean language support (KST timezone)
            - Industrial environment reliability requirements
          prompt: |
            ğŸ” **SafeWork PR ì¢…í•© ë¶„ì„ ë° ë¦¬ë·°**
            
            **ë³€ê²½ ì‚¬í•­:**
            - íŒŒì¼: ${{ steps.pr_analysis.outputs.files_changed }}ê°œ ë³€ê²½
            - ë¼ì¸: ${{ steps.pr_analysis.outputs.lines_changed }}ì¤„ ìˆ˜ì •  
            - ë³´ì•ˆ ê´€ë ¨: ${{ steps.pr_analysis.outputs.security_related }}
            - ë°ì´í„°ë² ì´ìŠ¤ ê´€ë ¨: ${{ steps.pr_analysis.outputs.database_related }}
            
            **ë¦¬ë·° ì²´í¬ë¦¬ìŠ¤íŠ¸:**
            
            â˜ **ì½”ë“œ í’ˆì§ˆ ê²€í† **
            - [ ] ì½”ë”© í‘œì¤€ ì¤€ìˆ˜ (PEP 8, Black formatting)
            - [ ] í•¨ìˆ˜/í´ë˜ìŠ¤ ì„¤ê³„ ì ì ˆì„±
            - [ ] ì—ëŸ¬ í•¸ë“¤ë§ ë° ë¡œê¹…
            - [ ] ì½”ë“œ ì¤‘ë³µ ìµœì†Œí™”
            
            â˜ **ë³´ì•ˆ ë¶„ì„**  
            - [ ] ì¸ì¦/ê¶Œí•œ ê²€ì¦ (@login_required)
            - [ ] SQL ì¸ì ì…˜ ë°©ì§€ (ORM ì‚¬ìš©)
            - [ ] XSS ë°©ì§€ (í…œí”Œë¦¿ ì´ìŠ¤ì¼€ì´í•‘)
            - [ ] ë¯¼ê° ì •ë³´ í•˜ë“œì½”ë”© í™•ì¸
            
            â˜ **ì„±ëŠ¥ ìµœì í™”**
            - [ ] ë°ì´í„°ë² ì´ìŠ¤ ì¿¼ë¦¬ íš¨ìœ¨ì„±
            - [ ] Redis ìºì‹± í™œìš©
            - [ ] í˜ì´ì§€ë„¤ì´ì…˜ êµ¬í˜„
            - [ ] ë©”ëª¨ë¦¬ ì‚¬ìš©ëŸ‰ ìµœì í™”
            
            â˜ **í…ŒìŠ¤íŠ¸ ì»¤ë²„ë¦¬ì§€**
            - [ ] ë‹¨ìœ„ í…ŒìŠ¤íŠ¸ ì¡´ì¬/ìˆ˜ì •
            - [ ] í†µí•© í…ŒìŠ¤íŠ¸ ê³ ë ¤
            - [ ] ì—£ì§€ ì¼€ì´ìŠ¤ ì²˜ë¦¬
            
            â˜ **ë¬¸ì„œí™”**
            - [ ] ì½”ë“œ ì£¼ì„ ì ì ˆì„±
            - [ ] API ë¬¸ì„œ ì—…ë°ì´íŠ¸
            - [ ] README ìˆ˜ì • í•„ìš”ì„±
            
            **íŠ¹í™” ê²€í†  ì‚¬í•­:**
            - ê±´ê°• ì„¤ë¬¸ì¡°ì‚¬ ë¡œì§ (001/002)
            - SafeWork ê´€ë¦¬ íŒ¨ë„ ê¸°ëŠ¥
            - í•œêµ­ì–´/KST ì§€ì›
            - ì‚°ì—… ì•ˆì „ ê·œì • ì¤€ìˆ˜
            
            ê° í•­ëª©ì„ ì²´í¬í•˜ê³  ìƒì„¸í•œ í”¼ë“œë°±ì„ ì œê³µí•´ì£¼ì„¸ìš”.
          
      - name: ğŸ“Š Review Metrics
        if: always()
        run: |
          echo "=== PR ë¦¬ë·° ì™„ë£Œ ==="
          echo "PR ë²ˆí˜¸: ${{ github.event.pull_request.number }}"
          echo "ì œëª©: ${{ github.event.pull_request.title }}"
          echo "ë³€ê²½ íŒŒì¼: ${{ steps.pr_analysis.outputs.files_changed }}ê°œ"
          echo "ë³€ê²½ ë¼ì¸: ${{ steps.pr_analysis.outputs.lines_changed }}ì¤„"
          echo "ë³´ì•ˆ ê´€ë ¨: ${{ steps.pr_analysis.outputs.security_related }}"
          echo "ë°ì´í„°ë² ì´ìŠ¤ ê´€ë ¨: ${{ steps.pr_analysis.outputs.database_related }}"
          echo "ë¦¬ë·° ìƒíƒœ: ${{ job.status }}"
          echo "ì™„ë£Œ ì‹œê°„: $(date)"