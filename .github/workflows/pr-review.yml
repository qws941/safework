name: ğŸ” Claude PR Review

concurrency:
  group: pr-review-${{ github.event.pull_request.number || github.run_id }}
  cancel-in-progress: true

on:
  pull_request:
    types: [opened, synchronize, ready_for_review, reopened]
  pull_request_review:
    types: [submitted]

permissions:
  contents: read
  pull-requests: write
  id-token: write

jobs:
  pr-review:
    if: github.event.pull_request.draft == false
    
    runs-on: ubuntu-latest
    timeout-minutes: 20
    
    steps:
      - name: ğŸ“‚ Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: ğŸ” PR Analysis
        id: pr_analysis
        run: |
          echo "ğŸ” Analyzing PR context..."
          
          # PR file analysis
          FILES_CHANGED=$(git diff --name-only ${{ github.event.pull_request.base.sha }}..${{ github.event.pull_request.head.sha }} | wc -l)
          LINES_CHANGED=$(git diff --stat ${{ github.event.pull_request.base.sha }}..${{ github.event.pull_request.head.sha }} | tail -1 | grep -o '[0-9]\+ insertion\|[0-9]\+ deletion' | head -1 | grep -o '[0-9]\+' || echo "0")
          
          echo "files_changed=$FILES_CHANGED" >> $GITHUB_OUTPUT
          echo "lines_changed=$LINES_CHANGED" >> $GITHUB_OUTPUT
          
          # Check for security-related file changes
          if git diff --name-only ${{ github.event.pull_request.base.sha }}..${{ github.event.pull_request.head.sha }} | grep -E "(auth|login|password|secret|key|token)" > /dev/null; then
            echo "security_related=true" >> $GITHUB_OUTPUT
          else
            echo "security_related=false" >> $GITHUB_OUTPUT
          fi
          
          # Check for database changes
          if git diff --name-only ${{ github.event.pull_request.base.sha }}..${{ github.event.pull_request.head.sha }} | grep -E "(models|migration|schema|sql)" > /dev/null; then
            echo "database_related=true" >> $GITHUB_OUTPUT
          else
            echo "database_related=false" >> $GITHUB_OUTPUT
          fi
          
          # Generate PR context file
          echo "=== SafeWork PR ì»¨í…ìŠ¤íŠ¸ ===" > pr_context.txt
          echo "PR ë²ˆí˜¸: ${{ github.event.pull_request.number }}" >> pr_context.txt
          echo "ì œëª©: ${{ github.event.pull_request.title }}" >> pr_context.txt
          echo "ì‘ì„±ì: ${{ github.event.pull_request.user.login }}" >> pr_context.txt
          echo "ìƒíƒœ: ${{ github.event.pull_request.state }}" >> pr_context.txt
          echo "ë¸Œëœì¹˜: ${{ github.event.pull_request.head.ref }} â†’ ${{ github.event.pull_request.base.ref }}" >> pr_context.txt
          echo "ë³€ê²½ íŒŒì¼ ìˆ˜: $FILES_CHANGED" >> pr_context.txt
          echo "ë³€ê²½ ë¼ì¸ ìˆ˜: $LINES_CHANGED" >> pr_context.txt
          echo "ë³´ì•ˆ ê´€ë ¨: ${{ steps.pr_analysis.outputs.security_related }}" >> pr_context.txt
          echo "ë°ì´í„°ë² ì´ìŠ¤ ê´€ë ¨: ${{ steps.pr_analysis.outputs.database_related }}" >> pr_context.txt
          echo "" >> pr_context.txt
          
          echo "=== PR ì„¤ëª… ===" >> pr_context.txt
          echo '${{ github.event.pull_request.body }}' >> pr_context.txt
          echo "" >> pr_context.txt
          
          echo "=== ë³€ê²½ëœ íŒŒì¼ ëª©ë¡ ===" >> pr_context.txt
          git diff --name-only ${{ github.event.pull_request.base.sha }}..${{ github.event.pull_request.head.sha }} >> pr_context.txt
          echo "" >> pr_context.txt
          
          echo "=== ë³€ê²½ ë‚´ìš© ìƒì„¸ ===" >> pr_context.txt
          git diff ${{ github.event.pull_request.base.sha }}..${{ github.event.pull_request.head.sha }} >> pr_context.txt
          
      - name: ğŸ§  Setup Claude Code
        run: |
          curl -fsSL https://claude.ai/install.sh | bash
          echo "${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}" | claude auth
          
      - name: ğŸ” Expert PR Review
        run: |
          claude code --dir . << 'EOF'
          ğŸ” **SafeWork Flask ì• í”Œë¦¬ì¼€ì´ì…˜ ì „ë¬¸ PR ë¦¬ë·° ìš”ì²­**
          
          **í”„ë¡œì íŠ¸ ì»¨í…ìŠ¤íŠ¸:**
          - SafeWork Flask 3.0+ ì• í”Œë¦¬ì¼€ì´ì…˜ (ì‚°ì—… ì•ˆì „ ê´€ë¦¬ ì‹œìŠ¤í…œ)
          - ë…ë¦½ ì»¨í…Œì´ë„ˆ ì•„í‚¤í…ì²˜: safework2-postgres (4546), safework2-redis (4547), safework2-app (4545)
          - í•µì‹¬ ê¸°ëŠ¥: ê±´ê°• ì„¤ë¬¸ì¡°ì‚¬, SafeWork ê´€ë¦¬, ë¬¸ì„œ ê´€ë¦¬, RESTful API v2
          - ê¸°ìˆ  ìŠ¤íƒ: Flask 3.0+, SQLAlchemy 2.0, PostgreSQL, Redis
          
          **PR ë¶„ì„ ì •ë³´:**
          - ë³€ê²½ íŒŒì¼: ${{ steps.pr_analysis.outputs.files_changed }}ê°œ
          - ë³€ê²½ ë¼ì¸: ${{ steps.pr_analysis.outputs.lines_changed }}ì¤„
          - ë³´ì•ˆ ê´€ë ¨: ${{ steps.pr_analysis.outputs.security_related }}
          - ë°ì´í„°ë² ì´ìŠ¤ ê´€ë ¨: ${{ steps.pr_analysis.outputs.database_related }}
          
          **ë¦¬ë·° í”„ë¡œì„¸ìŠ¤:**
          
          1. **`pr_context.txt` íŒŒì¼ì„ ì½ê³  PR ë‚´ìš© ë¶„ì„**
             - PR ëª©ì  ë° ë²”ìœ„ íŒŒì•…
             - ë³€ê²½ì‚¬í•­ì˜ ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ ì´í•´
             - ê¸°ìˆ ì  êµ¬í˜„ ë°©ì‹ ê²€í† 
          
          2. **ì½”ë“œ í’ˆì§ˆ ì „ë¬¸ ê²€í† **:
             ğŸ”’ **ë³´ì•ˆ ìš°ì„  ê²€í† **:
             - ì¸ì¦/ê¶Œí•œ ì²´í¬ (Flask-Login, @login_required)
             - SQL ì¸ì ì…˜ ë°©ì§€ (SQLAlchemy ORM ì‚¬ìš©)
             - XSS ë°©ì§€ (í…œí”Œë¦¿ ì´ìŠ¤ì¼€ì´í•‘)
             - CSRF ë³´í˜¸ (í˜„ì¬ ë¹„í™œì„±í™” ìƒíƒœ ê³ ë ¤)
             - ë¯¼ê° ì •ë³´ í•˜ë“œì½”ë”© í™•ì¸
             
             âš¡ **ì„±ëŠ¥ ë° íš¨ìœ¨ì„±**:
             - ë°ì´í„°ë² ì´ìŠ¤ ì¿¼ë¦¬ ìµœì í™” (N+1 ë¬¸ì œ)
             - Redis ìºì‹± í™œìš©
             - í˜ì´ì§€ë„¤ì´ì…˜ (20ê°œ ë‹¨ìœ„)
             - ë©”ëª¨ë¦¬ ëˆ„ìˆ˜ ë°©ì§€
             
             ğŸ—ï¸ **ì•„í‚¤í…ì²˜ ì¼ê´€ì„±**:
             - ë¸”ë£¨í”„ë¦°íŠ¸ êµ¬ì¡° ì¤€ìˆ˜
             - ëª¨ë¸ ê´€ê³„ ì„¤ì • ì ì ˆì„±
             - RESTful API ì„¤ê³„ ì›ì¹™
             - ì—ëŸ¬ í•¸ë“¤ë§ í‘œì¤€í™”
             
             ğŸ§ª **í…ŒìŠ¤íŠ¸ ê°€ëŠ¥ì„±**:
             - ë‹¨ìœ„ í…ŒìŠ¤íŠ¸ ì‘ì„± ìš©ì´ì„±
             - Mock ê°ì²´ í™œìš© ê°€ëŠ¥ì„±
             - í†µí•© í…ŒìŠ¤íŠ¸ ê³ ë ¤ì‚¬í•­
          
          3. **SafeWork íŠ¹í™” ê²€í† **:
             - ì„¤ë¬¸ ì¡°ì‚¬ ë¡œì§ (001/002 ì–‘ì‹)
             - SafeWork ê´€ë¦¬ íŒ¨ë„ ê¸°ëŠ¥
             - í•œêµ­ì–´ ì§€ì› ë° KST íƒ€ì„ì¡´
             - ìµëª… ì‚¬ìš©ì ì²˜ë¦¬ (user_id=1)
             - ë¬¸ì„œ ë²„ì „ ê´€ë¦¬ ì‹œìŠ¤í…œ
          
          4. **ë°°í¬ ë° ìš´ì˜ ê³ ë ¤ì‚¬í•­**:
             - ë…ë¦½ ì»¨í…Œì´ë„ˆ í˜¸í™˜ì„±
             - í™˜ê²½ ë³€ìˆ˜ ì„¤ì •
             - ì˜ì¡´ì„± ê´€ë¦¬ (requirements.txt)
             - GitHub Actions ì›Œí¬í”Œë¡œìš° ì˜í–¥
          
          **ë¦¬ë·° ê²°ê³¼ë¥¼ GitHub PRì— ì§ì ‘ ëŒ“ê¸€ë¡œ ì‘ì„±**:
          - `gh pr comment` ëª…ë ¹ì–´ ì‚¬ìš©
          - êµ¬ì²´ì ì´ê³  ì‹¤í–‰ ê°€ëŠ¥í•œ í”¼ë“œë°±
          - ê¸ì •ì  ìš”ì†Œì™€ ê°œì„ ì‚¬í•­ ê· í˜•ìˆê²Œ ì œì‹œ
          - í•œêµ­ì–´ë¡œ ì¹œê·¼í•˜ë©´ì„œ ì „ë¬¸ì ì¸ í†¤
          
          **ìµœì¢… íŒì • ê¸°ì¤€**:
          - âœ… **ìŠ¹ì¸**: ì½”ë“œ í’ˆì§ˆ ìš°ìˆ˜, ë³´ì•ˆ ì´ìŠˆ ì—†ìŒ, ì•„í‚¤í…ì²˜ ì¼ê´€ì„± ìœ ì§€
          - âš ï¸ **ì¡°ê±´ë¶€ ìŠ¹ì¸**: ì‚¬ì†Œí•œ ê°œì„ ì‚¬í•­ ìˆìŒ, ë°°í¬ ì „ ìˆ˜ì • ê¶Œì¥
          - âŒ **ìˆ˜ì • í•„ìš”**: ë³´ì•ˆ ì´ìŠˆ, ì‹¬ê°í•œ ë²„ê·¸, ì•„í‚¤í…ì²˜ ìœ„ë°˜
          
          ì§€ê¸ˆ PRì„ ì „ë¬¸ì ìœ¼ë¡œ ë¦¬ë·°í•˜ê³  GitHubì— ëŒ“ê¸€ì„ ì‘ì„±í•´ì£¼ì„¸ìš”.
          EOF
          
      - name: ğŸ“Š Review Metrics
        if: always()
        run: |
          echo "=== PR ë¦¬ë·° ì™„ë£Œ ==="
          echo "PR ë²ˆí˜¸: ${{ github.event.pull_request.number }}"
          echo "ì œëª©: ${{ github.event.pull_request.title }}"
          echo "ë³€ê²½ íŒŒì¼: ${{ steps.pr_analysis.outputs.files_changed }}ê°œ"
          echo "ë³€ê²½ ë¼ì¸: ${{ steps.pr_analysis.outputs.lines_changed }}ì¤„"
          echo "ë³´ì•ˆ ê´€ë ¨: ${{ steps.pr_analysis.outputs.security_related }}"
          echo "ë°ì´í„°ë² ì´ìŠ¤ ê´€ë ¨: ${{ steps.pr_analysis.outputs.database_related }}"
          echo "ë¦¬ë·° ìƒíƒœ: ${{ job.status }}"
          echo "ì™„ë£Œ ì‹œê°„: $(date)"