name: 🚀 SafeWork Deployment Pipeline

on:
  push:
    branches: [ main, master ]
    paths:
      - 'app/**'
      - 'requirements.txt'
      - 'docker-compose.yml'
      - 'Dockerfile'
      - '.github/workflows/deploy.yml'
  workflow_dispatch:
    inputs:
      skip_tests:
        description: 'Skip tests'
        required: false
        default: 'false'
        type: boolean
      force_deploy:
        description: 'Force deployment even if tests fail'
        required: false
        default: 'false'
        type: boolean
      deployment_method:
        description: 'Deployment method'
        required: false
        default: 'watchtower'
        type: choice
        options:
          - 'watchtower'
          - 'portainer'

permissions:
  contents: read
  packages: write
  actions: read

jobs:
  # === Build and Test Phase ===
  build-test:
    name: 🔨 Build & Test
    runs-on: ubuntu-latest
    
    services:
      mysql:
        image: mysql:8.0
        env:
          MYSQL_ROOT_PASSWORD: safework_test_root
          MYSQL_DATABASE: safework_test
          MYSQL_USER: safework_test
          MYSQL_PASSWORD: safework_test
        ports:
          - 3306:3306
        options: >-
          --health-cmd="mysqladmin ping"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=3

      redis:
        image: redis:7.0
        ports:
          - 6379:6379

    steps:
      - name: 📥 Checkout repository
        uses: actions/checkout@v4

      - name: 🐍 Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: 📦 Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r app/requirements.txt
          pip install pytest

      - name: 🧪 Run tests
        if: ${{ inputs.skip_tests != 'true' }}
        run: |
          cd app
          export FLASK_CONFIG=testing
          export MYSQL_HOST=127.0.0.1
          export MYSQL_DATABASE=safework_test
          export MYSQL_USER=safework_test
          export MYSQL_PASSWORD=safework_test
          export REDIS_HOST=127.0.0.1
          
          # Wait for services
          for i in {1..30}; do
            if mysqladmin ping -h127.0.0.1 -usafework_test -psafework_test --silent; then
              break
            fi
            echo "Waiting for MySQL..."
            sleep 2
          done
          
          # Basic application test
          python -c "
          from app import create_app
          app = create_app('testing')
          print('✅ Flask application created successfully')
          "

      - name: 🐳 Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: 🔐 Login to Docker Registry
        uses: docker/login-action@v3
        with:
          registry: registry.jclee.me
          username: admin
          password: ${{ secrets.REGISTRY_PASSWORD }}

      - name: 🏗️ Build and push Docker images
        run: |
          # Build and tag images
          docker-compose build
          
          # Tag with timestamp
          TIMESTAMP=$(date +%Y%m%d-%H%M%S)
          docker tag safework-app:latest registry.jclee.me/safework/app:$TIMESTAMP
          docker tag safework-app:latest registry.jclee.me/safework/app:latest
          docker tag safework-mysql:latest registry.jclee.me/safework/mysql:latest
          docker tag safework-redis:latest registry.jclee.me/safework/redis:latest
          
          # Push to registry
          docker push registry.jclee.me/safework/app:$TIMESTAMP
          docker push registry.jclee.me/safework/app:latest
          docker push registry.jclee.me/safework/mysql:latest
          docker push registry.jclee.me/safework/redis:latest
          
          echo "✅ Docker images built and pushed successfully"

  # === Deployment Phase ===
  deploy:
    name: 🚀 Deploy to Production
    runs-on: ubuntu-latest
    needs: build-test
    if: always() && (needs.build-test.result == 'success' || inputs.force_deploy == 'true')
    
    steps:
      - name: 📥 Checkout repository
        uses: actions/checkout@v4

      - name: 🔄 Trigger Watchtower Deployment
        if: ${{ inputs.deployment_method != 'portainer' }}
        run: |
          echo "🔄 Triggering Watchtower deployment..."
          curl -H "Authorization: Bearer ${{ secrets.WATCHTOWER_HTTP_API_TOKEN }}" \
               -H "Content-Type: application/json" \
               -X POST \
               "https://watchtower.jclee.me/v1/update" \
               -d '{"filter":"safework"}' || echo "Watchtower API call failed, continuing..."

      - name: 🐳 Portainer Webhook Deployment
        if: ${{ inputs.deployment_method == 'portainer' }}
        run: |
          echo "🐳 Triggering Portainer deployment..."
          curl -X POST "${{ secrets.PORTAINER_WEBHOOK_URL }}" || echo "Portainer webhook failed, continuing..."

      - name: ⏰ Wait for deployment
        run: |
          echo "⏰ Waiting for deployment to complete..."
          sleep 60

      - name: 🏥 Health check
        run: |
          echo "🏥 Performing health check..."
          for i in {1..10}; do
            if curl -f -s https://safework.jclee.me/health; then
              echo "✅ Health check passed"
              break
            else
              echo "⏳ Health check attempt $i failed, retrying..."
              sleep 10
            fi
          done

  # === Notification Phase ===
  notify:
    name: 📱 Deployment Notification
    runs-on: ubuntu-latest
    needs: [build-test, deploy]
    if: always()
    
    steps:
      - name: 📱 Slack Notification
        uses: 8398a7/action-slack@v3
        with:
          status: custom
          channel: '#safework-deployment'
          custom_payload: |
            {
              "attachments": [{
                "color": "${{ needs.deploy.result == 'success' && 'good' || 'danger' }}",
                "title": "🚀 SafeWork Deployment",
                "fields": [
                  {
                    "title": "Status",
                    "value": "${{ needs.deploy.result == 'success' && '✅ Success' || '❌ Failed' }}",
                    "short": true
                  },
                  {
                    "title": "Branch",
                    "value": "${{ github.ref_name }}",
                    "short": true
                  },
                  {
                    "title": "Commit",
                    "value": "${{ github.sha }}",
                    "short": true
                  },
                  {
                    "title": "URL",
                    "value": "https://safework.jclee.me",
                    "short": true
                  }
                ]
              }]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        if: always()