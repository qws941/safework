name: SafeWork Docker Build & Deploy

on:
  push:
    branches: [master]
    paths:
      - 'src/app/**'
      - 'infrastructure/docker/**'
      - 'docker-compose.yml'
      - '.github/workflows/deploy.yml'
  workflow_dispatch:  # ìˆ˜ë™ ì‹¤í–‰ ê°€ëŠ¥
    inputs:
      deploy_to_production:
        description: 'Deploy to production after build'
        required: false
        default: 'false'
        type: choice
        options:
          - 'true'
          - 'false'

env:
  # Registry ì„¤ì •
  REGISTRY_HOST: registry.jclee.me
  REGISTRY_USER: admin
  REGISTRY_PASSWORD: ${{ secrets.REGISTRY_PASSWORD }}

  # Application ì„¤ì •
  APP_NAME: safework
  APP_PORT: 4545

  # Database ì„¤ì •
  DB_NAME: safework_db
  DB_USER: safework
  DB_PASSWORD: ${{ secrets.DB_PASSWORD }}

  # Portainer ì„¤ì •
  PORTAINER_URL: https://portainer.jclee.me
  PORTAINER_TOKEN: ${{ secrets.PORTAINER_TOKEN }}
  PORTAINER_ENDPOINT: 3

  # Admin ì„¤ì •
  ADMIN_USERNAME: ${{ secrets.ADMIN_USERNAME }}
  ADMIN_PASSWORD: ${{ secrets.ADMIN_PASSWORD }}

  # Security ì„¤ì •
  SECRET_KEY: ${{ secrets.SECRET_KEY }}

jobs:
  build:
    name: Build & Push Docker Images
    runs-on: ubuntu-latest
    timeout-minutes: 30  # íƒ€ì„ì•„ì›ƒ ì¶”ê°€ë¡œ ë¬´í•œ ëŒ€ê¸° ë°©ì§€

    strategy:
      matrix:
        service:
          - name: app
            context: ./src/app
            dockerfile: ./src/app/Dockerfile
          - name: postgres
            context: ./infrastructure/docker/postgres
            dockerfile: ./infrastructure/docker/postgres/Dockerfile
          - name: redis
            context: ./infrastructure/docker/redis
            dockerfile: ./infrastructure/docker/redis/Dockerfile
      fail-fast: false  # í•˜ë‚˜ì˜ ë¹Œë“œê°€ ì‹¤íŒ¨í•´ë„ ë‹¤ë¥¸ ë¹Œë“œ ê³„ì† ì§„í–‰

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY_HOST }}
          username: ${{ env.REGISTRY_USER }}
          password: ${{ env.REGISTRY_PASSWORD }}

      - name: Build & Push ${{ matrix.service.name }}
        uses: docker/build-push-action@v5
        with:
          context: ${{ matrix.service.context }}
          file: ${{ matrix.service.dockerfile }}
          push: true
          tags: |
            ${{ env.REGISTRY_HOST }}/${{ env.APP_NAME }}/${{ matrix.service.name }}:latest
            ${{ env.REGISTRY_HOST }}/${{ env.APP_NAME }}/${{ matrix.service.name }}:${{ github.sha }}
            ${{ env.REGISTRY_HOST }}/${{ env.APP_NAME }}/${{ matrix.service.name }}:${{ github.run_number }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          platforms: linux/amd64  # í”Œë«í¼ ëª…ì‹œì  ì§€ì •
          build-args: |
            DB_NAME=${{ env.DB_NAME }}
            DB_USER=${{ env.DB_USER }}
            DB_PASSWORD=${{ env.DB_PASSWORD }}

  deploy:
    name: Deploy to Production via Portainer API
    needs: build
    runs-on: ubuntu-latest
    if: github.event_name == 'push' || (github.event_name == 'workflow_dispatch' && github.event.inputs.deploy_to_production == 'true')

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Deploy via Portainer API
        env:
          PORTAINER_URL: ${{ env.PORTAINER_URL }}
          PORTAINER_TOKEN: ${{ env.PORTAINER_TOKEN }}
          ENDPOINT_ID: ${{ env.PORTAINER_ENDPOINT }}
          STACK_NAME: ${{ env.APP_NAME }}
          REGISTRY_URL: ${{ env.REGISTRY_HOST }}
        run: |
          echo "ğŸš€ Portainer API ë°°í¬ ì‹œì‘..."

          # ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰ ê¶Œí•œ ì„¤ì •
          chmod +x ./scripts/portainer_api_deploy.sh

          # ë°°í¬ ì‹¤í–‰
          ./scripts/portainer_api_deploy.sh deploy

          if [ $? -eq 0 ]; then
            echo "âœ… ë°°í¬ ì„±ê³µ!"
          else
            echo "âŒ ë°°í¬ ì‹¤íŒ¨"
            exit 1
          fi

      - name: Verify Deployment Health
        run: |
          echo "ğŸ” ë°°í¬ ê²€ì¦ ì¤‘..."
          sleep 10
          ./scripts/portainer_api_deploy.sh health

      - name: Notification
        if: always()
        run: |
          if [ "${{ job.status }}" == "success" ]; then
            echo "âœ… SafeWork deployment successful!"
            echo "ğŸŒ URL: https://safework.jclee.me"
            echo "ğŸ“¦ Version: ${{ github.sha }}"
          else
            echo "âŒ SafeWork deployment failed!"
            echo "Please check the logs for details"
          fi