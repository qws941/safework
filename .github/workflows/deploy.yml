name: SafeWork Docker Build & Deploy

on:
  push:
    branches: [master]
    paths:
      - 'src/app/**'
      - 'infrastructure/docker/**'
      - 'docker-compose.yml'
      - '.github/workflows/deploy.yml'
  workflow_dispatch:  # ìˆ˜ë™ ì‹¤í–‰ ê°€ëŠ¥
    inputs:
      deploy_to_production:
        description: 'Deploy to production after build'
        required: false
        default: 'false'
        type: choice
        options:
          - 'true'
          - 'false'

env:
  # Registry ì„¤ì •
  REGISTRY_HOST: registry.jclee.me
  REGISTRY_USER: admin
  REGISTRY_PASSWORD: ${{ secrets.REGISTRY_PASSWORD }}

  # Application ì„¤ì •
  APP_NAME: safework
  APP_PORT: 4545

  # Database ì„¤ì •
  DB_NAME: safework_db
  DB_USER: safework
  DB_PASSWORD: ${{ secrets.DB_PASSWORD }}

  # Portainer ì„¤ì •
  PORTAINER_URL: https://portainer.jclee.me
  PORTAINER_TOKEN: ${{ secrets.PORTAINER_TOKEN }}
  PORTAINER_WEBHOOK_URL: ${{ secrets.PORTAINER_WEBHOOK_URL }}
  PORTAINER_ENDPOINT: 3

  # Admin ì„¤ì •
  ADMIN_USERNAME: ${{ secrets.ADMIN_USERNAME }}
  ADMIN_PASSWORD: ${{ secrets.ADMIN_PASSWORD }}

  # Security ì„¤ì •
  SECRET_KEY: ${{ secrets.SECRET_KEY }}

jobs:
  build:
    name: Build & Push Docker Images
    runs-on: ubuntu-latest
    timeout-minutes: 30  # íƒ€ì„ì•„ì›ƒ ì¶”ê°€ë¡œ ë¬´í•œ ëŒ€ê¸° ë°©ì§€

    strategy:
      matrix:
        service:
          - name: app
            context: ./src/app
            dockerfile: ./src/app/Dockerfile
          - name: postgres
            context: ./infrastructure/docker/postgres
            dockerfile: ./infrastructure/docker/postgres/Dockerfile
          - name: redis
            context: ./infrastructure/docker/redis
            dockerfile: ./infrastructure/docker/redis/Dockerfile
      fail-fast: false  # í•˜ë‚˜ì˜ ë¹Œë“œê°€ ì‹¤íŒ¨í•´ë„ ë‹¤ë¥¸ ë¹Œë“œ ê³„ì† ì§„í–‰

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY_HOST }}
          username: ${{ env.REGISTRY_USER }}
          password: ${{ env.REGISTRY_PASSWORD }}

      - name: Build & Push ${{ matrix.service.name }}
        uses: docker/build-push-action@v5
        with:
          context: ${{ matrix.service.context }}
          file: ${{ matrix.service.dockerfile }}
          push: true
          tags: |
            ${{ env.REGISTRY_HOST }}/${{ env.APP_NAME }}/${{ matrix.service.name }}:latest
            ${{ env.REGISTRY_HOST }}/${{ env.APP_NAME }}/${{ matrix.service.name }}:${{ github.sha }}
            ${{ env.REGISTRY_HOST }}/${{ env.APP_NAME }}/${{ matrix.service.name }}:${{ github.run_number }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          platforms: linux/amd64  # í”Œë«í¼ ëª…ì‹œì  ì§€ì •
          build-args: |
            DB_NAME=${{ env.DB_NAME }}
            DB_USER=${{ env.DB_USER }}
            DB_PASSWORD=${{ env.DB_PASSWORD }}

  deploy:
    name: Deploy to Production via Portainer Webhook
    needs: build
    runs-on: ubuntu-latest
    if: github.event_name == 'push' || (github.event_name == 'workflow_dispatch' && github.event.inputs.deploy_to_production == 'true')

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Deploy via Portainer Webhook
        env:
          PORTAINER_WEBHOOK_URL: ${{ env.PORTAINER_WEBHOOK_URL }}
        run: |
          echo "ğŸš€ Portainer Webhook ë°°í¬ ì‹œì‘..."
          
          # í™˜ê²½ë³€ìˆ˜ ê²€ì¦
          if [ -z "$PORTAINER_WEBHOOK_URL" ]; then
            echo "âŒ PORTAINER_WEBHOOK_URL í™˜ê²½ë³€ìˆ˜ê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤."
            exit 1
          fi
          
          echo "Webhook URL ê²€ì¦ ì™„ë£Œ"
          
          # Webhook í˜¸ì¶œ
          response=$(curl -s -w "
%{http_code}" -X POST "$PORTAINER_WEBHOOK_URL")
          
          http_code=$(echo "$response" | tail -n1)
          response_body=$(echo "$response" | head -n -1)
          
          echo "Webhook ì‘ë‹µ ì½”ë“œ: $http_code"
          
          if [ "$http_code" = "200" ] || [ "$http_code" = "204" ]; then
            echo "âœ… Webhook í˜¸ì¶œ ì„±ê³µ!"
            echo "Portainer ìŠ¤íƒ ì—…ë°ì´íŠ¸ê°€ ì‹œì‘ë˜ì—ˆìŠµë‹ˆë‹¤."
          else
            echo "âŒ Webhook í˜¸ì¶œ ì‹¤íŒ¨: HTTP $http_code"
            echo "ì‘ë‹µ ë‚´ìš©: $response_body"
            exit 1
          fi

      - name: Verify Deployment Health
        run: |
          echo "ğŸ” ë°°í¬ ê²€ì¦ ì¤‘..."
          echo "Webhook ì²˜ë¦¬ ëŒ€ê¸° ì¤‘ (20ì´ˆ)..."
          sleep 20
          
          max_attempts=15
          attempt=1
          last_error=""
          
          # ë°°í¬ ê²€ì¦ ë¡œì§
          while [ $attempt -le $max_attempts ]; do
            echo "í—¬ìŠ¤ì²´í¬ ì‹œë„ $attempt/$max_attempts..."
            
            # ì»¨í…Œì´ë„ˆ ìƒíƒœ ê²€ì¦ (Portainer API)
            echo "ì»¨í…Œì´ë„ˆ ìƒíƒœ í™•ì¸ ì¤‘..."
            container_status=$(curl -s -m 10 \
              -H "X-API-Key: ${{ secrets.PORTAINER_API_KEY }}" \
              "https://portainer.jclee.me/api/endpoints/3/docker/containers/json?filters=%7B%22name%22%3A%5B%22safework%22%5D%7D" \
              | jq -r '.[].State // "unknown"' 2>/dev/null || echo "unknown")
            
            echo "ì»¨í…Œì´ë„ˆ ìƒíƒœ: $container_status"
            
            # ì• í”Œë¦¬ì¼€ì´ì…˜ í—¬ìŠ¤ì²´í¬
            echo "ì• í”Œë¦¬ì¼€ì´ì…˜ í—¬ìŠ¤ì²´í¬ ì¤‘..."
            response=$(curl -s -m 10 -w "
%{http_code}" https://safework.jclee.me/health 2>/dev/null || echo "")
            
            if [ -n "$response" ]; then
              http_code=$(echo "$response" | tail -n1)
              body=$(echo "$response" | head -n -1)
              
              echo "HTTP Status: $http_code"
              
              if [ "$http_code" = "200" ]; then
                # JSON íŒŒì‹± ë° ìƒíƒœ ê²€ì¦
                status=$(echo "$body" | jq -r '.status // "unknown"' 2>/dev/null || echo "unknown")
                database_status=$(echo "$body" | jq -r '.database // "unknown"' 2>/dev/null || echo "unknown")
                redis_status=$(echo "$body" | jq -r '.redis // "unknown"' 2>/dev/null || echo "unknown")
                
                echo "Application Status: $status"
                echo "Database Status: $database_status"
                echo "Redis Status: $redis_status"
                
                # ëª¨ë“  ì»´í¬ë„ŒíŠ¸ê°€ ì •ìƒì¸ì§€ í™•ì¸
                if [ "$status" = "healthy" ] && [ "$database_status" = "connected" ] && [ "$redis_status" = "connected" ]; then
                  echo "âœ… ëª¨ë“  ì»´í¬ë„ŒíŠ¸ í—¬ìŠ¤ì²´í¬ ì„±ê³µ!"
                  echo "ğŸ“Š í—¬ìŠ¤ì²´í¬ ìƒì„¸ ì •ë³´:"
                  echo "$body" | jq . 2>/dev/null || echo "$body"
                  
                  # ì¶”ê°€ ì—”ë“œí¬ì¸íŠ¸ ê²€ì¦
                  echo "ğŸ” ì£¼ìš” ì—”ë“œí¬ì¸íŠ¸ ê²€ì¦ ì¤‘..."
                  admin_response=$(curl -s -m 5 -w "
%{http_code}" https://safework.jclee.me/admin/login 2>/dev/null || echo "")
                  admin_code=$(echo "$admin_response" | tail -n1)
                  
                  survey_response=$(curl -s -m 5 -w "
%{http_code}" https://safework.jclee.me/survey 2>/dev/null || echo "")
                  survey_code=$(echo "$survey_response" | tail -n1)
                  
                  echo "Admin ë¡œê·¸ì¸ í˜ì´ì§€: HTTP $admin_code"
                  echo "Survey í˜ì´ì§€: HTTP $survey_code"
                  
                  if [ "$admin_code" = "200" ] && [ "$survey_code" = "200" ]; then
                    echo "âœ… ëª¨ë“  ì—”ë“œí¬ì¸íŠ¸ ê²€ì¦ ì™„ë£Œ!"
                    exit 0
                  else
                    echo "âš ï¸ ì¼ë¶€ ì—”ë“œí¬ì¸íŠ¸ì—ì„œ ë¬¸ì œê°€ ê°ì§€ë˜ì—ˆì§€ë§Œ í—¬ìŠ¤ì²´í¬ëŠ” ì„±ê³µ"
                    exit 0
                  fi
                else
                  last_error="ì»´í¬ë„ŒíŠ¸ ìƒíƒœ ì´ìƒ - App: $status, DB: $database_status, Redis: $redis_status"
                fi
              else
                last_error="HTTP $http_code - $body"
              fi
            else
              last_error="ì„œë²„ ì‘ë‹µ ì—†ìŒ ë˜ëŠ” íƒ€ì„ì•„ì›ƒ"
            fi
            
            echo "âŒ í—¬ìŠ¤ì²´í¬ ì‹¤íŒ¨: $last_error"
            
            if [ $attempt -eq $max_attempts ]; then
              echo "âŒ ë°°í¬ ê²€ì¦ ì‹¤íŒ¨ (ìµœëŒ€ ì‹œë„ íšŸìˆ˜ ì´ˆê³¼)"
              echo "ìµœì¢… ì˜¤ë¥˜: $last_error"
              
              # ì‹¤íŒ¨ ì‹œ ë””ë²„ê·¸ ì •ë³´ ìˆ˜ì§‘
              echo "ğŸ” ë””ë²„ê·¸ ì •ë³´ ìˆ˜ì§‘ ì¤‘..."
              echo "Portainer ìŠ¤íƒ ìƒíƒœ:"
              curl -s -m 10 \
                -H "X-API-Key: ${{ secrets.PORTAINER_API_KEY }}" \
                "https://portainer.jclee.me/api/stacks" \
                | jq '.[] | select(.Name | contains("safework")) | {Name, Status, CreationDate}' 2>/dev/null || echo "ìŠ¤íƒ ì •ë³´ ì¡°íšŒ ì‹¤íŒ¨"
              
              exit 1
            fi
            
            attempt=$((attempt + 1))
            echo "8ì´ˆ í›„ ì¬ì‹œë„..."
            sleep 8
          done

      - name: Fallback Deployment (API Script)
        if: failure()
        env:
          PORTAINER_TOKEN: ${{ env.PORTAINER_TOKEN }}
          PORTAINER_URL: ${{ env.PORTAINER_URL }}
          ENDPOINT_ID: ${{ env.PORTAINER_ENDPOINT }}
        run: |
          echo "ğŸ”„ Webhook ë°°í¬ ì‹¤íŒ¨ - Fallback API ë°°í¬ ì‹œì‘..."
          
          # Portainer API í† í° ê²€ì¦
          if [ -z "$PORTAINER_TOKEN" ]; then
            echo "âŒ PORTAINER_TOKEN í™˜ê²½ë³€ìˆ˜ê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤."
            exit 1
          fi
          
          # Fallback ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰
          chmod +x ./scripts/backup/portainer_api_deploy_v2.0.0.sh
          
          if ./scripts/backup/portainer_api_deploy_v2.0.0.sh deploy; then
            echo "âœ… Fallback ë°°í¬ ì„±ê³µ!"
            
            # Fallback ì„±ê³µ í›„ í—¬ìŠ¤ì²´í¬
            echo "ğŸ” Fallback ë°°í¬ í—¬ìŠ¤ì²´í¬..."
            sleep 15
            
            ./scripts/deployment_health_validator.sh --skip-container --max-attempts 10
            
            if [ $? -eq 0 ]; then
              echo "âœ… Fallback ë°°í¬ ë° í—¬ìŠ¤ì²´í¬ ì™„ë£Œ!"
            else
              echo "âš ï¸ Fallback ë°°í¬ëŠ” ì„±ê³µí–ˆìœ¼ë‚˜ í—¬ìŠ¤ì²´í¬ì—ì„œ ë¬¸ì œ ê°ì§€"
            fi
          else
            echo "âŒ Fallback ë°°í¬ë„ ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤."
            exit 1
          fi

      - name: Deployment Summary
        if: always()
        run: |
          echo "ğŸ“Š ë°°í¬ ìš”ì•½ ë¦¬í¬íŠ¸"
          echo "=================="
          
          if [ "${{ job.status }}" == "success" ]; then
            echo "âœ… SafeWork ë°°í¬ ì„±ê³µ!"
            echo "ğŸ“… ë°°í¬ ì‹œê°„: $(date '+%Y-%m-%d %H:%M:%S KST')"
            echo "ğŸŒ ì„œë¹„ìŠ¤ URL: https://safework.jclee.me"
            echo "ğŸ“¦ ì´ë¯¸ì§€ ë²„ì „: ${{ github.sha }}"
            echo "ğŸš€ ë°°í¬ ë°©ì‹: Portainer Webhook"
            echo "ğŸ—ï¸ ë¹Œë“œ ë²ˆí˜¸: ${{ github.run_number }}"
            
            # ìµœì¢… ìƒíƒœ í™•ì¸
            echo ""
            echo "ğŸ” ìµœì¢… ì„œë¹„ìŠ¤ ìƒíƒœ í™•ì¸:"
            response=$(curl -s -m 10 https://safework.jclee.me/health || echo "")
            if [ -n "$response" ]; then
              echo "$response" | jq . 2>/dev/null || echo "$response"
            else
              echo "âš ï¸ ìƒíƒœ í™•ì¸ ì‹¤íŒ¨"
            fi
            
          elif [ -n "$(echo '${{ steps.*.outcome }}' | grep -o 'success')" ]; then
            echo "âœ… SafeWork Fallback ë°°í¬ ì„±ê³µ!"
            echo "ğŸ“… ë°°í¬ ì‹œê°„: $(date '+%Y-%m-%d %H:%M:%S KST')"
            echo "ğŸŒ ì„œë¹„ìŠ¤ URL: https://safework.jclee.me"  
            echo "ğŸ“¦ ì´ë¯¸ì§€ ë²„ì „: ${{ github.sha }}"
            echo "ğŸ”„ ë°°í¬ ë°©ì‹: Portainer API (Fallback)"
            echo "ğŸ—ï¸ ë¹Œë“œ ë²ˆí˜¸: ${{ github.run_number }}"
            echo "âš ï¸ ì°¸ê³ : Webhook ì‹¤íŒ¨ë¡œ Fallback API ì‚¬ìš©ë¨"
            
          else
            echo "âŒ SafeWork ë°°í¬ ì‹¤íŒ¨!"
            echo "ğŸ“… ì‹¤íŒ¨ ì‹œê°„: $(date '+%Y-%m-%d %H:%M:%S KST')"
            echo "ğŸ” ë¡œê·¸ë¥¼ í™•ì¸í•˜ì—¬ ë¬¸ì œë¥¼ í•´ê²°í•˜ì„¸ìš”"
            echo "ğŸ“– ë¬¸ì œ í•´ê²° ê°€ì´ë“œ: docs/TROUBLESHOOTING.md"
            echo "ğŸ”§ Portainer ìŠ¤íƒ ìƒíƒœ: https://portainer.jclee.me"
          fi

      - name: Post-Deployment Monitoring
        if: success()
        run: |
          echo "ğŸ“Š ë°°í¬ í›„ ì„±ëŠ¥ ëª¨ë‹ˆí„°ë§ ì‹œì‘..."
          
          # ëª¨ë‹ˆí„°ë§ ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰ ê¶Œí•œ ì„¤ì •
          chmod +x ./scripts/deployment_monitor.sh
          
          # 5ë¶„ê°„ ì„±ëŠ¥ ëª¨ë‹ˆí„°ë§ (30ì´ˆ ê°„ê²©, 10íšŒ)
          echo "ğŸ” 5ë¶„ê°„ ì§‘ì¤‘ ëª¨ë‹ˆí„°ë§ ìˆ˜í–‰ ì¤‘..."
          
          if ./scripts/deployment_monitor.sh monitor -i 30 -c 10 --verbose; then
            echo "âœ… ë°°í¬ í›„ ëª¨ë‹ˆí„°ë§ ì™„ë£Œ - ì‹œìŠ¤í…œ ì•ˆì •"
          else
            echo "âš ï¸ ëª¨ë‹ˆí„°ë§ì—ì„œ ì¼ë¶€ ì´ìŠˆ ê°ì§€ë¨"
            
            # ì„±ëŠ¥ ë¦¬í¬íŠ¸ ìƒì„±
            echo "ğŸ“‹ ì„±ëŠ¥ ë¦¬í¬íŠ¸ ìƒì„± ì¤‘..."
            report_file=$(./scripts/deployment_monitor.sh report)
            echo "ë¦¬í¬íŠ¸ ìœ„ì¹˜: $report_file"
            
            # ë¦¬í¬íŠ¸ ìš”ì•½ ì¶œë ¥
            if [ -f "$report_file" ]; then
              echo "ğŸ“Š ì„±ëŠ¥ ë¦¬í¬íŠ¸ ìš”ì•½:"
              head -20 "$report_file" | grep -E "(í‰ê· |ìƒíƒœ|ì•Œë¦¼)" || echo "ìš”ì•½ ì •ë³´ ì—†ìŒ"
            fi
          fi
          
          # ìµœì¢… ìƒíƒœ í™•ì¸
          echo ""
          echo "ğŸ¯ ìµœì¢… ë°°í¬ ì„±ëŠ¥ í™•ì¸:"
          ./scripts/deployment_monitor.sh check --verbose