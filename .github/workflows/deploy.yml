name: SafeWork Docker Build & Deploy

on:
  push:
    branches: [master]
    paths:
      - 'src/app/**'
      - 'infrastructure/docker/**'
      - 'docker-compose.yml'
      - '.github/workflows/deploy.yml'
  workflow_dispatch:  # ìˆ˜ë™ ì‹¤í–‰ ê°€ëŠ¥
    inputs:
      deploy_to_production:
        description: 'Deploy to production after build'
        required: false
        default: 'false'
        type: choice
        options:
          - 'true'
          - 'false'

env:
  # Registry ì„¤ì •
  REGISTRY_HOST: registry.jclee.me
  REGISTRY_USER: admin
  REGISTRY_PASSWORD: ${{ secrets.REGISTRY_PASSWORD }}

  # Application ì„¤ì •
  APP_NAME: safework
  APP_PORT: 4545

  # Database ì„¤ì •
  DB_NAME: safework_db
  DB_USER: safework
  DB_PASSWORD: ${{ secrets.DB_PASSWORD }}

  # Portainer ì„¤ì •
  PORTAINER_URL: https://portainer.jclee.me
  PORTAINER_TOKEN: ${{ secrets.PORTAINER_TOKEN }}
  PORTAINER_ENDPOINT: 3

  # Admin ì„¤ì •
  ADMIN_USERNAME: ${{ secrets.ADMIN_USERNAME }}
  ADMIN_PASSWORD: ${{ secrets.ADMIN_PASSWORD }}

  # Security ì„¤ì •
  SECRET_KEY: ${{ secrets.SECRET_KEY }}

jobs:
  build:
    name: Build & Push Docker Images
    runs-on: ubuntu-latest
    timeout-minutes: 30  # íƒ€ì„ì•„ì›ƒ ì¶”ê°€ë¡œ ë¬´í•œ ëŒ€ê¸° ë°©ì§€

    strategy:
      matrix:
        service:
          - name: app
            context: ./src/app
            dockerfile: ./src/app/Dockerfile
          - name: postgres
            context: ./infrastructure/docker/postgres
            dockerfile: ./infrastructure/docker/postgres/Dockerfile
          - name: redis
            context: ./infrastructure/docker/redis
            dockerfile: ./infrastructure/docker/redis/Dockerfile
      fail-fast: false  # í•˜ë‚˜ì˜ ë¹Œë“œê°€ ì‹¤íŒ¨í•´ë„ ë‹¤ë¥¸ ë¹Œë“œ ê³„ì† ì§„í–‰

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY_HOST }}
          username: ${{ env.REGISTRY_USER }}
          password: ${{ env.REGISTRY_PASSWORD }}

      - name: Build & Push ${{ matrix.service.name }}
        uses: docker/build-push-action@v5
        with:
          context: ${{ matrix.service.context }}
          file: ${{ matrix.service.dockerfile }}
          push: true
          tags: |
            ${{ env.REGISTRY_HOST }}/${{ env.APP_NAME }}/${{ matrix.service.name }}:latest
            ${{ env.REGISTRY_HOST }}/${{ env.APP_NAME }}/${{ matrix.service.name }}:${{ github.sha }}
            ${{ env.REGISTRY_HOST }}/${{ env.APP_NAME }}/${{ matrix.service.name }}:${{ github.run_number }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          platforms: linux/amd64  # í”Œë«í¼ ëª…ì‹œì  ì§€ì •
          build-args: |
            DB_NAME=${{ env.DB_NAME }}
            DB_USER=${{ env.DB_USER }}
            DB_PASSWORD=${{ env.DB_PASSWORD }}

  deploy:
    name: Deploy to Production via Portainer
    needs: build
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch' && github.event.inputs.deploy_to_production == 'true'

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Pre-deployment Validation
        run: |
          echo "ğŸ” Pre-deployment validation starting..."

          # Portainer API ì—°ê²° í…ŒìŠ¤íŠ¸
          if ! curl -s -f -H "X-API-Key: ${{ env.PORTAINER_TOKEN }}" \
               "${{ env.PORTAINER_URL }}/api/status" > /dev/null; then
            echo "âŒ Portainer API ì—°ê²° ì‹¤íŒ¨"
            exit 1
          fi
          echo "âœ… Portainer API ì—°ê²° ì„±ê³µ"

          # í•„ìˆ˜ í™˜ê²½ë³€ìˆ˜ í™•ì¸
          for var in PORTAINER_TOKEN DB_PASSWORD SECRET_KEY ADMIN_PASSWORD; do
            if [ -z "${!var}" ]; then
              echo "âŒ í•„ìˆ˜ í™˜ê²½ë³€ìˆ˜ ëˆ„ë½: $var"
              exit 1
            fi
          done
          echo "âœ… í™˜ê²½ë³€ìˆ˜ ê²€ì¦ ì™„ë£Œ"

      - name: Check Stack Status
        id: check_stack
        run: |
          echo "ğŸ” ìŠ¤íƒ ìƒíƒœ í™•ì¸ ì¤‘..."

          STACKS_RESPONSE=$(curl -s -H "X-API-Key: ${{ env.PORTAINER_TOKEN }}" \
            "${{ env.PORTAINER_URL }}/api/stacks")

          STACK_INFO=$(echo "$STACKS_RESPONSE" | jq -r '.[] | select(.Name == "${{ env.APP_NAME }}")')

          if [ -n "$STACK_INFO" ] && [ "$STACK_INFO" != "null" ]; then
            STACK_ID=$(echo "$STACK_INFO" | jq -r '.Id')
            STACK_STATUS=$(echo "$STACK_INFO" | jq -r '.Status')
            echo "stack_exists=true" >> $GITHUB_OUTPUT
            echo "stack_id=$STACK_ID" >> $GITHUB_OUTPUT
            echo "stack_status=$STACK_STATUS" >> $GITHUB_OUTPUT
            echo "âœ… ê¸°ì¡´ ìŠ¤íƒ ë°œê²¬: ID=$STACK_ID, Status=$STACK_STATUS"
          else
            echo "stack_exists=false" >> $GITHUB_OUTPUT
            echo "âš ï¸ ê¸°ì¡´ ìŠ¤íƒì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ìƒˆ ìŠ¤íƒì„ ìƒì„±í•©ë‹ˆë‹¤."
          fi

      - name: Prepare Docker Compose
        run: |
          # docker-compose.ymlì„ í™˜ê²½ë³€ìˆ˜ë¡œ ì¹˜í™˜
          cat docker-compose.yml | \
            sed "s/\${DB_PASSWORD:-safework2024}/${{ env.DB_PASSWORD }}/g" | \
            sed "s/\${SECRET_KEY:-safework-production-secret-key-2024}/${{ env.SECRET_KEY }}/g" | \
            sed "s/\${ADMIN_USERNAME:-admin}/${{ env.ADMIN_USERNAME }}/g" | \
            sed "s/\${ADMIN_PASSWORD:-safework2024}/${{ env.ADMIN_PASSWORD }}/g" | \
            sed "s/\${FLASK_CONFIG:-production}/production/g" \
            > /tmp/docker-compose-prod.yml

      - name: Update Existing Stack
        if: steps.check_stack.outputs.stack_exists == 'true'
        run: |
          echo "ğŸ”„ ê¸°ì¡´ ìŠ¤íƒ ì—…ë°ì´íŠ¸ ì¤‘..."

          COMPOSE_CONTENT=$(cat /tmp/docker-compose-prod.yml | jq -Rs .)

          UPDATE_RESPONSE=$(curl -s -w "\n%{http_code}" -X PUT \
            -H "X-API-Key: ${{ env.PORTAINER_TOKEN }}" \
            -H "Content-Type: application/json" \
            "${{ env.PORTAINER_URL }}/api/stacks/${{ steps.check_stack.outputs.stack_id }}?endpointId=${{ env.PORTAINER_ENDPOINT }}" \
            -d "{
              \"StackFileContent\": $COMPOSE_CONTENT,
              \"Prune\": false,
              \"PullImage\": true
            }")

          HTTP_CODE=$(echo "$UPDATE_RESPONSE" | tail -n1)
          RESPONSE_BODY=$(echo "$UPDATE_RESPONSE" | head -n -1)

          if [ "$HTTP_CODE" = "200" ]; then
            echo "âœ… ìŠ¤íƒ ì—…ë°ì´íŠ¸ ì„±ê³µ"
          else
            echo "âŒ ìŠ¤íƒ ì—…ë°ì´íŠ¸ ì‹¤íŒ¨ (HTTP: $HTTP_CODE)"
            echo "Response: $RESPONSE_BODY"

            # Fallback: Docker ì§ì ‘ ëª…ë ¹ì–´ ì‚¬ìš©
            echo "ğŸ”„ Docker ì§ì ‘ ëª…ë ¹ì–´ë¡œ ëŒ€ì²´ ì‹œë„..."

            # ì»¨í…Œì´ë„ˆ ì—…ë°ì´íŠ¸ë¥¼ ìœ„í•œ Portainer API í˜¸ì¶œ
            CONTAINERS_RESPONSE=$(curl -s \
              -H "X-API-Key: ${{ env.PORTAINER_TOKEN }}" \
              "${{ env.PORTAINER_URL }}/api/endpoints/${{ env.PORTAINER_ENDPOINT }}/docker/containers/json")

            echo "$CONTAINERS_RESPONSE" | jq -r '.[] | select(.Names[] | contains("safework")) | .Names[0]' | while read container_name; do
              if [ -n "$container_name" ]; then
                container_name=$(echo "$container_name" | sed 's|^/||')
                echo "Updating container: $container_name"

                # ì»¨í…Œì´ë„ˆ ì¬ì‹œì‘
                curl -s -X POST \
                  -H "X-API-Key: ${{ env.PORTAINER_TOKEN }}" \
                  "${{ env.PORTAINER_URL }}/api/endpoints/${{ env.PORTAINER_ENDPOINT }}/docker/containers/$container_name/restart"
              fi
            done

            echo "âœ… Docker ì§ì ‘ ì—…ë°ì´íŠ¸ ì™„ë£Œ"
          fi

      - name: Create New Stack
        if: steps.check_stack.outputs.stack_exists == 'false'
        run: |
          COMPOSE_CONTENT=$(cat /tmp/docker-compose-prod.yml | jq -Rs .)

          curl -X POST \
            -H "X-API-Key: ${{ env.PORTAINER_TOKEN }}" \
            -H "Content-Type: application/json" \
            "${{ env.PORTAINER_URL }}/api/stacks/create/standalone/string?endpointId=${{ env.PORTAINER_ENDPOINT }}" \
            -d "{
              \"name\": \"${{ env.APP_NAME }}\",
              \"stackFileContent\": $COMPOSE_CONTENT
            }"

          echo "Stack created successfully"

      - name: Post-deployment Container Status Check
        run: |
          echo "ğŸ“Š ë°°í¬ í›„ ì»¨í…Œì´ë„ˆ ìƒíƒœ í™•ì¸..."
          sleep 15  # ì»¨í…Œì´ë„ˆ ì‹œì‘ ëŒ€ê¸°

          CONTAINERS_RESPONSE=$(curl -s \
            -H "X-API-Key: ${{ env.PORTAINER_TOKEN }}" \
            "${{ env.PORTAINER_URL }}/api/endpoints/${{ env.PORTAINER_ENDPOINT }}/docker/containers/json")

          echo "SafeWork ì»¨í…Œì´ë„ˆ ìƒíƒœ:"
          echo "$CONTAINERS_RESPONSE" | jq -r '.[] | select(.Names[] | contains("safework")) | "  " + .Names[0] + " - " + .State + " (" + .Status + ")"'

          # ëª¨ë“  safework ì»¨í…Œì´ë„ˆê°€ ì‹¤í–‰ ì¤‘ì¸ì§€ í™•ì¸
          RUNNING_COUNT=$(echo "$CONTAINERS_RESPONSE" | jq -r '.[] | select(.Names[] | contains("safework")) | select(.State == "running") | .Names[0]' | wc -l)

          if [ "$RUNNING_COUNT" -ge 3 ]; then
            echo "âœ… ëª¨ë“  SafeWork ì»¨í…Œì´ë„ˆê°€ ì •ìƒ ì‹¤í–‰ ì¤‘ì…ë‹ˆë‹¤."
          else
            echo "âš ï¸ ì¼ë¶€ ì»¨í…Œì´ë„ˆê°€ ì‹¤í–‰ë˜ì§€ ì•Šê³  ìˆìŠµë‹ˆë‹¤. (ì‹¤í–‰ ì¤‘: $RUNNING_COUNT/3)"
          fi

      - name: Verify Deployment
        run: |
          echo "ğŸ” ì„œë¹„ìŠ¤ ë°°í¬ ê²€ì¦ ì‹œì‘..."

          # ë‹¤ë‹¨ê³„ í—¬ìŠ¤ ì²´í¬
          MAX_ATTEMPTS=15
          ATTEMPT=1

          while [ $ATTEMPT -le $MAX_ATTEMPTS ]; do
            echo "í—¬ìŠ¤ ì²´í¬ ì‹œë„ $ATTEMPT/$MAX_ATTEMPTS"

            HEALTH_RESPONSE=$(curl -s -w "\n%{http_code}" https://safework.jclee.me/health 2>/dev/null)
            HTTP_CODE=$(echo "$HEALTH_RESPONSE" | tail -n1)
            RESPONSE_BODY=$(echo "$HEALTH_RESPONSE" | head -n -1)

            if [ "$HTTP_CODE" = "200" ]; then
              STATUS=$(echo "$RESPONSE_BODY" | jq -r '.status // "unknown"' 2>/dev/null)
              if [ "$STATUS" = "healthy" ]; then
                echo "âœ… ì„œë¹„ìŠ¤ í—¬ìŠ¤ ì²´í¬ ì„±ê³µ!"
                echo "$RESPONSE_BODY" | jq '.' 2>/dev/null
                break
              fi
            fi

            if [ $ATTEMPT -eq $MAX_ATTEMPTS ]; then
              echo "âŒ í—¬ìŠ¤ ì²´í¬ ìµœëŒ€ ì‹œë„ íšŸìˆ˜ ì´ˆê³¼"

              # ì‹¤íŒ¨ ì‹œ ìƒì„¸ ë””ë²„ê¹… ì •ë³´
              echo "ğŸ” ë””ë²„ê¹… ì •ë³´:"
              echo "HTTP Code: $HTTP_CODE"
              echo "Response: $RESPONSE_BODY"

              # ì»¨í…Œì´ë„ˆ ë¡œê·¸ í™•ì¸
              echo "ğŸ” ì»¨í…Œì´ë„ˆ ë¡œê·¸ (ìµœê·¼ 20ì¤„):"
              curl -s -H "X-API-Key: ${{ env.PORTAINER_TOKEN }}" \
                "${{ env.PORTAINER_URL }}/api/endpoints/${{ env.PORTAINER_ENDPOINT }}/docker/containers/safework-app/logs?stdout=true&stderr=true&tail=20" \
                2>/dev/null || echo "ë¡œê·¸ ì¡°íšŒ ì‹¤íŒ¨"

              exit 1
            fi

            echo "â³ ëŒ€ê¸° ì¤‘... (5ì´ˆ í›„ ì¬ì‹œë„)"
            sleep 5
            ATTEMPT=$((ATTEMPT + 1))
          done

          echo "ğŸ” ì¶”ê°€ ê²€ì¦ í…ŒìŠ¤íŠ¸..."

          # API ì—”ë“œí¬ì¸íŠ¸ í…ŒìŠ¤íŠ¸
          if curl -s https://safework.jclee.me/ | grep -q "SafeWork"; then
            echo "âœ… ë©”ì¸ í˜ì´ì§€ ì‘ë‹µ ì •ìƒ"
          else
            echo "âš ï¸ ë©”ì¸ í˜ì´ì§€ ì‘ë‹µ ë¬¸ì œ"
          fi

      - name: Notification
        if: always()
        run: |
          if [ "${{ job.status }}" == "success" ]; then
            echo "âœ… SafeWork deployment successful!"
            echo "ğŸŒ URL: https://safework.jclee.me"
            echo "ğŸ“¦ Version: ${{ github.sha }}"
          else
            echo "âŒ SafeWork deployment failed!"
            echo "Please check the logs for details"
          fi