name: SafeWork CI/CD Pipeline

on:
  push:
    branches: [ main, develop, staging ]
    paths:
      - 'app/**'
      - 'mysql/**' 
      - 'redis/**'
      - 'docker-compose.yml'
      - '.github/workflows/**'
      - 'Makefile'
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:
    inputs:
      version:
        description: 'ë°°í¬í•  ë²„ì „ (ì˜ˆ: 1.2.0, ë¹„ì›Œë‘ë©´ ìžë™ ìƒì„±)'
        required: false
        type: string
      environment:
        description: 'ë°°í¬ í™˜ê²½'
        required: true
        default: 'production'
        type: choice
        options:
        - production
        - staging
        - development
      target_branch:
        description: 'ëŒ€ìƒ ë¸Œëžœì¹˜'
        required: false
        default: ''
        type: string

env:
  REGISTRY: ${{ secrets.REGISTRY_URL || 'registry.jclee.me' }}
  PROJECT: safework
  REGISTRY_USER: ${{ secrets.REGISTRY_USER || 'admin' }}
  REGISTRY_PASSWORD: ${{ secrets.REGISTRY_PASSWORD }}

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
    
    - name: Log in to Docker Registry
      uses: docker/login-action@v3
      with:
        registry: ${{ env.REGISTRY }}
        username: ${{ env.REGISTRY_USER }}
        password: ${{ env.REGISTRY_PASSWORD }}
    
    - name: Get version and environment from git
      id: version
      run: |
        # Git fetchë¥¼ ë¨¼ì € ìˆ˜í–‰
        git fetch --tags || true
        
        # ë¸Œëžœì¹˜ì— ë”°ë¥¸ í™˜ê²½ ìžë™ ê²°ì •
        BRANCH_NAME="${{ github.ref_name }}"
        echo "ðŸŒ¿ í˜„ìž¬ ë¸Œëžœì¹˜: $BRANCH_NAME"
        
        # í™˜ê²½ ìžë™ ë§¤í•‘
        case $BRANCH_NAME in
          "main"|"master")
            AUTO_ENVIRONMENT="production"
            ENV_PREFIX=""
            ;;
          "staging")
            AUTO_ENVIRONMENT="staging"
            ENV_PREFIX="staging-"
            ;;
          "develop")
            AUTO_ENVIRONMENT="development"
            ENV_PREFIX="dev-"
            ;;
          *)
            AUTO_ENVIRONMENT="development"
            ENV_PREFIX="feature-"
            ;;
        esac
        
        # ìˆ˜ë™ ìž…ë ¥ì´ ìžˆìœ¼ë©´ ìš°ì„  ì ìš©, ì—†ìœ¼ë©´ ë¸Œëžœì¹˜ ê¸°ë°˜ ìžë™ ê²°ì •
        ENVIRONMENT="${{ github.event.inputs.environment || '$AUTO_ENVIRONMENT' }}"
        echo "ðŸŽ¯ ë°°í¬ í™˜ê²½: $ENVIRONMENT (ë¸Œëžœì¹˜ ê¸°ë°˜: $AUTO_ENVIRONMENT)"
        
        # ìˆ˜ë™ ìž…ë ¥ëœ ë²„ì „ì´ ìžˆëŠ”ì§€ í™•ì¸
        if [[ -n "${{ github.event.inputs.version }}" ]]; then
          VERSION="${{ github.event.inputs.version }}"
          echo "ðŸ‘¤ ìˆ˜ë™ ìž…ë ¥ ë²„ì „: $VERSION"
        elif git describe --tags --exact-match HEAD 2>/dev/null; then
          VERSION=$(git describe --tags --exact-match HEAD | sed 's/^v//')
          echo "ðŸ“Œ Git íƒœê·¸ ê¸°ë°˜ ë²„ì „: $VERSION"
        else
          # íƒœê·¸ê°€ ì—†ìœ¼ë©´ ë‚ ì§œ ê¸°ë°˜ ë²„ì „ ìƒì„± (ë¸Œëžœì¹˜ë³„ prefix ì ìš©)
          if [[ "$ENVIRONMENT" == "production" ]]; then
            VERSION="1.$(date +%Y%m%d).$(date +%H%M)"
          else
            VERSION="${ENV_PREFIX}1.$(date +%Y%m%d).$(date +%H%M)"
          fi
          echo "ðŸ—“ï¸ ë‚ ì§œ ê¸°ë°˜ ë²„ì „: $VERSION"
        fi
        
        # í™˜ê²½ë³„ íƒœê·¸ ì²˜ë¦¬ (productionì´ ì•„ë‹Œ ê²½ìš°ì—ë§Œ)
        if [[ "$ENVIRONMENT" != "production" && "$VERSION" != *"-$ENVIRONMENT"* ]]; then
          VERSION="${VERSION}-${ENVIRONMENT}"
        fi
        
        echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
        echo "SHA_SHORT=${GITHUB_SHA::7}" >> $GITHUB_OUTPUT
        echo "DATE_VERSION=$(date +%Y%m%d-%H%M%S)" >> $GITHUB_OUTPUT
        echo "ENVIRONMENT=$ENVIRONMENT" >> $GITHUB_OUTPUT
        echo "BRANCH_NAME=$BRANCH_NAME" >> $GITHUB_OUTPUT
        echo "ðŸ·ï¸ Building SafeWork version: $VERSION ($ENVIRONMENT í™˜ê²½, $BRANCH_NAME ë¸Œëžœì¹˜)"
        
        # VERSION íŒŒì¼ë„ ìžë™ ì—…ë°ì´íŠ¸
        echo $VERSION > app/VERSION
    
    - name: Run database migrations
      run: |
        cd app
        echo "ðŸ—‚ï¸ Running database migrations..."
        python migrate.py migrate || echo "âš ï¸ Migration failed, but continuing deployment"
    
    - name: Build and push App image
      uses: docker/build-push-action@v5
      with:
        context: ./app
        push: true
        tags: |
          ${{ env.REGISTRY }}/${{ env.PROJECT }}/app:latest
          ${{ env.REGISTRY }}/${{ env.PROJECT }}/app:v${{ steps.version.outputs.VERSION }}
          ${{ env.REGISTRY }}/${{ env.PROJECT }}/app:${{ steps.version.outputs.SHA_SHORT }}
        cache-from: type=gha
        cache-to: type=gha,mode=max
    
    - name: Build and push MySQL image
      uses: docker/build-push-action@v5
      with:
        context: ./mysql
        push: true
        tags: |
          ${{ env.REGISTRY }}/${{ env.PROJECT }}/mysql:latest
          ${{ env.REGISTRY }}/${{ env.PROJECT }}/mysql:v${{ steps.version.outputs.VERSION }}
          ${{ env.REGISTRY }}/${{ env.PROJECT }}/mysql:${{ steps.version.outputs.SHA_SHORT }}
        cache-from: type=gha
        cache-to: type=gha,mode=max
    
    - name: Build and push Redis image
      uses: docker/build-push-action@v5
      with:
        context: ./redis
        push: true
        tags: |
          ${{ env.REGISTRY }}/${{ env.PROJECT }}/redis:latest
          ${{ env.REGISTRY }}/${{ env.PROJECT }}/redis:v${{ steps.version.outputs.VERSION }}
          ${{ env.REGISTRY }}/${{ env.PROJECT }}/redis:${{ steps.version.outputs.SHA_SHORT }}
        cache-from: type=gha
        cache-to: type=gha,mode=max
    
    - name: Create Release
      if: steps.version.outputs.ENVIRONMENT == 'production' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')
      uses: softprops/action-gh-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: v${{ steps.version.outputs.VERSION }}
        name: SafeWork v${{ steps.version.outputs.VERSION }} (Production)
        body: |
          ## ðŸŽ‰ SafeWork v${{ steps.version.outputs.VERSION }} í”„ë¡œë•ì…˜ ë°°í¬
          
          **ë°°í¬ í™˜ê²½**: ${{ steps.version.outputs.ENVIRONMENT }}  
          **ë¸Œëžœì¹˜**: ${{ steps.version.outputs.BRANCH_NAME }}  
          **ì»¤ë°‹**: ${{ github.sha }}
          
          ### ðŸ“¦ Docker ì´ë¯¸ì§€
          ```bash
          # í”„ë¡œë•ì…˜ ì´ë¯¸ì§€ ê°€ì ¸ì˜¤ê¸°
          docker pull ${{ env.REGISTRY }}/${{ env.PROJECT }}/app:v${{ steps.version.outputs.VERSION }}
          docker pull ${{ env.REGISTRY }}/${{ env.PROJECT }}/mysql:v${{ steps.version.outputs.VERSION }}
          docker pull ${{ env.REGISTRY }}/${{ env.PROJECT }}/redis:v${{ steps.version.outputs.VERSION }}
          ```
          
          ### ðŸš€ ë°°í¬ ë°©ë²•
          ```bash
          # Makefile ì‚¬ìš© (ê¶Œìž¥)
          make deploy
          
          # Docker Compose ì‚¬ìš©
          ./docker-compose-up.sh
          
          # ê°„íŽ¸ ìŠ¤í¬ë¦½íŠ¸
          ./deploy.sh local
          ```
          
          ### ðŸ”§ ì£¼ìš” ê¸°ëŠ¥
          - ðŸ“± ëª¨ë°”ì¼ ìµœì í™” ì™„ë£Œ
          - ðŸ“Š ê´€ë¦¬ìž ëŒ€ì‹œë³´ë“œ ë° ì¡°ì‚¬í‘œ ê´€ë¦¬ ì‹œìŠ¤í…œ
          - ðŸ”„ Git ê¸°ë°˜ ë™ì  ë²„ì „ ê´€ë¦¬
          - ðŸ³ Docker Compose ì§€ì›
          - ðŸŒ¿ ë¸Œëžœì¹˜ë³„ ìžë™ ë°°í¬ í™˜ê²½ ê²°ì •
          
          ### ðŸ“‹ ì ‘ì† ì •ë³´
          - ðŸŒ ì›¹ì‚¬ì´íŠ¸: http://localhost:4545
          - ðŸ‘¤ ê´€ë¦¬ìž: admin / safework2024
        draft: false
        prerelease: false
    
    - name: Create Pre-release (Staging/Development)
      if: steps.version.outputs.ENVIRONMENT != 'production' && (github.ref == 'refs/heads/staging' || github.ref == 'refs/heads/develop')
      uses: softprops/action-gh-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: v${{ steps.version.outputs.VERSION }}
        name: SafeWork v${{ steps.version.outputs.VERSION }} (${{ steps.version.outputs.ENVIRONMENT }})
        body: |
          ## ðŸ§ª SafeWork v${{ steps.version.outputs.VERSION }} í…ŒìŠ¤íŠ¸ ë°°í¬
          
          **ë°°í¬ í™˜ê²½**: ${{ steps.version.outputs.ENVIRONMENT }}  
          **ë¸Œëžœì¹˜**: ${{ steps.version.outputs.BRANCH_NAME }}  
          **ì»¤ë°‹**: ${{ github.sha }}
          
          âš ï¸ **ì´ ë²„ì „ì€ í…ŒìŠ¤íŠ¸ìš©ìž…ë‹ˆë‹¤. í”„ë¡œë•ì…˜ í™˜ê²½ì—ì„œëŠ” ì‚¬ìš©í•˜ì§€ ë§ˆì„¸ìš”.**
          
          ### ðŸ“¦ Docker ì´ë¯¸ì§€
          ```bash
          # í…ŒìŠ¤íŠ¸ ì´ë¯¸ì§€ ê°€ì ¸ì˜¤ê¸°
          docker pull ${{ env.REGISTRY }}/${{ env.PROJECT }}/app:v${{ steps.version.outputs.VERSION }}
          docker pull ${{ env.REGISTRY }}/${{ env.PROJECT }}/mysql:v${{ steps.version.outputs.VERSION }}
          docker pull ${{ env.REGISTRY }}/${{ env.PROJECT }}/redis:v${{ steps.version.outputs.VERSION }}
          ```
          
          ### ðŸ§ª í…ŒìŠ¤íŠ¸ í™˜ê²½ ë°°í¬
          ```bash
          # í…ŒìŠ¤íŠ¸ í™˜ê²½ìœ¼ë¡œ ë°°í¬
          ENVIRONMENT=${{ steps.version.outputs.ENVIRONMENT }} ./docker-compose-up.sh
          ```
        draft: false
        prerelease: true
    
    - name: Create deployment info
      run: |
        cat > deployment-info.json <<EOF
        {
          "version": "v${{ steps.version.outputs.VERSION }}",
          "sha": "${{ github.sha }}",
          "sha_short": "${{ steps.version.outputs.SHA_SHORT }}",
          "timestamp": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
          "registry": "${{ env.REGISTRY }}",
          "images": {
            "app": "${{ env.REGISTRY }}/${{ env.PROJECT }}/app:v${{ steps.version.outputs.VERSION }}",
            "mysql": "${{ env.REGISTRY }}/${{ env.PROJECT }}/mysql:v${{ steps.version.outputs.VERSION }}",
            "redis": "${{ env.REGISTRY }}/${{ env.PROJECT }}/redis:v${{ steps.version.outputs.VERSION }}"
          },
          "deploy_commands": [
            "./docker-compose-up.sh",
            "./docker-run.sh"
          ]
        }
        EOF
        echo "ðŸ“‹ Deployment Info:"
        cat deployment-info.json
    
    - name: Upload deployment artifact
      uses: actions/upload-artifact@v4
      with:
        name: deployment-info-v${{ steps.version.outputs.VERSION }}
        path: deployment-info.json
        retention-days: 90
    
    - name: Success notification
      if: success()
      run: |
        echo "ðŸŽ‰ SafeWork v${{ steps.version.outputs.VERSION }} ë°°í¬ ì„±ê³µ!"
        echo "ðŸ“¦ Docker ì´ë¯¸ì§€ê°€ ${{ env.REGISTRY }}ì— í‘¸ì‹œë˜ì—ˆìŠµë‹ˆë‹¤."
        echo "ðŸ·ï¸  Tags: latest, v${{ steps.version.outputs.VERSION }}, ${{ steps.version.outputs.SHA_SHORT }}"
        echo ""
        echo "ðŸš€ ë°°í¬ ëª…ë ¹ì–´:"
        echo "  ./docker-compose-up.sh"
        echo ""
        echo "ðŸŒ ì ‘ì† ì •ë³´:"
        echo "  URL: http://localhost:4545"
        echo "  ê´€ë¦¬ìž: admin / safework2024"