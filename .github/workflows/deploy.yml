name: Deploy
on:
  workflow_run:
    workflows: ["Claude"]
    types: [completed]
    branches: [master, main]
  workflow_call:
    inputs:
      deployment_reason:
        description: 'Reason for deployment'
        required: false
        type: string
        default: 'Automated deployment'
      force_deploy:
        description: 'Force deployment even if no changes'
        required: false
        type: boolean
        default: false
  workflow_dispatch:
    inputs:
      deployment_reason:
        description: 'Reason for deployment'
        required: false
        type: string
        default: 'Manual deployment'
      force_deploy:
        description: 'Force deployment even if no changes'
        required: false
        type: boolean
        default: false
  push:
    branches: [master, main]
    paths:
      - 'app/**'
      - 'docker-compose.yml'
      - 'mysql/**'
      - 'redis/**'
      - '.github/workflows/deploy.yml'
  schedule:
    - cron: '0 2 * * 1'  # Weekly Monday 2AM KST health check

env:
  REGISTRY: registry.jclee.me
  PROJECT_NAME: safework
  WATCHTOWER_HOST: watchtower.jclee.me
  WATCHTOWER_HTTP_API_TOKEN: ${{ secrets.WATCHTOWER_HTTP_API_TOKEN }}
  REGISTRY_USERNAME: admin
  REGISTRY_PASSWORD: ${{ secrets.REGISTRY_PASSWORD }}
  DEPLOYMENT_ENVIRONMENT: production
  HEALTH_CHECK_RETRIES: 5
  HEALTH_CHECK_TIMEOUT: 60
  BUILD_PLATFORMS: linux/amd64
  
  # Application Environment Variables (from GitHub Secrets)
  SECRET_KEY: ${{ secrets.SECRET_KEY }}
  MYSQL_ROOT_PASSWORD: ${{ secrets.MYSQL_ROOT_PASSWORD }}
  MYSQL_PASSWORD: ${{ secrets.MYSQL_PASSWORD }}
  REDIS_PASSWORD: ${{ secrets.REDIS_PASSWORD }}
  ADMIN_USERNAME: ${{ secrets.ADMIN_USERNAME }}
  ADMIN_PASSWORD: ${{ secrets.ADMIN_PASSWORD }}

permissions:
  contents: read
  packages: write
  actions: read

jobs:
  pre-validation:
    runs-on: ubuntu-latest
    timeout-minutes: 5
    outputs:
      should_deploy: ${{ steps.validation.outputs.should_deploy }}
      deployment_reason: ${{ steps.validation.outputs.deployment_reason }}
      skip_reason: ${{ steps.validation.outputs.skip_reason }}
      image_tags: ${{ steps.validation.outputs.image_tags }}
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Deploy Condition Validation
        id: validation
        run: |
          echo "ğŸ” SafeWork ë°°í¬ ì¡°ê±´ ê²€ì¦ ì‹œì‘..."
          
          should_deploy="false"
          deployment_reason=""
          skip_reason=""
          
          # Get deployment reason from inputs
          REASON="${{ inputs.deployment_reason || github.event.inputs.deployment_reason || 'Automated deployment' }}"
          FORCE_DEPLOY="${{ inputs.force_deploy || github.event.inputs.force_deploy || 'false' }}"
          
          # Manual execution
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            should_deploy="true"
            deployment_reason="Manual deployment: $REASON"
          
          # Workflow call from Claude
          elif [ "${{ github.event_name }}" = "workflow_call" ]; then
            should_deploy="true"
            deployment_reason="Claude triggered: $REASON"
          
          # Auto execution after successful Claude workflow
          elif [ "${{ github.event_name }}" = "workflow_run" ] && [ "${{ github.event.workflow_run.conclusion }}" = "success" ]; then
            should_deploy="true"
            deployment_reason="Auto deployment after Claude success"
          
          # Direct push to main (emergency deployment)
          elif [ "${{ github.event_name }}" = "push" ]; then
            # Check if there are meaningful changes
            if git diff --quiet HEAD~1 HEAD -- . ':!*.md' ':!docs/' ':!.github/ISSUE_TEMPLATE/'; then
              if [ "$FORCE_DEPLOY" = "true" ]; then
                should_deploy="true"
                deployment_reason="Forced deployment on push"
              else
                skip_reason="No meaningful changes detected"
              fi
            else
              should_deploy="true"
              deployment_reason="Direct push with code changes"
            fi
          
          # Scheduled health check
          elif [ "${{ github.event_name }}" = "schedule" ]; then
            skip_reason="Scheduled health check - deployment skipped"
            deployment_reason="Weekly health check execution"
          
          else
            skip_reason="Deployment condition not met"
          fi
          
          # Generate image tags
          TIMESTAMP=$(date +%Y%m%d-%H%M%S)
          COMMIT_SHA=$(git rev-parse --short HEAD)
          IMAGE_TAGS="latest,${COMMIT_SHA},${TIMESTAMP}"
          
          echo "should_deploy=$should_deploy" >> $GITHUB_OUTPUT
          echo "deployment_reason=$deployment_reason" >> $GITHUB_OUTPUT
          echo "skip_reason=$skip_reason" >> $GITHUB_OUTPUT
          echo "image_tags=$IMAGE_TAGS" >> $GITHUB_OUTPUT
          
          if [ "$should_deploy" = "true" ]; then
            echo "âœ… ë°°í¬ ì§„í–‰: $deployment_reason"
            echo "ğŸ·ï¸ ì´ë¯¸ì§€ íƒœê·¸: $IMAGE_TAGS"
          else
            echo "â­ï¸ ë°°í¬ ê±´ë„ˆëœ€: $skip_reason"
          fi

  build-and-push:
    needs: pre-validation
    if: needs.pre-validation.outputs.should_deploy == 'true'
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    environment:
      name: production
      url: https://safework.jclee.me
    
    strategy:
      matrix:
        service: [app, mysql, redis]
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3
        with:
          platforms: ${{ env.BUILD_PLATFORMS }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
        with:
          driver: docker-container
          driver-opts: |
            network=host

      - name: Login to Private Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ env.REGISTRY_USERNAME }}
          password: ${{ env.REGISTRY_PASSWORD }}

      - name: Extract Image Metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.PROJECT_NAME }}/${{ matrix.service }}
          tags: |
            type=raw,value=latest
            type=sha,prefix={{branch}}-
            type=raw,value={{date 'YYYYMMDD-HHmmss'}}
          labels: |
            org.opencontainers.image.title=SafeWork ${{ matrix.service }}
            org.opencontainers.image.description=SafeWork industrial safety management - ${{ matrix.service }} service
            org.opencontainers.image.vendor=SafeWork Team
            org.opencontainers.image.source=https://github.com/${{ github.repository }}

      - name: Build and Push Docker Image
        uses: docker/build-push-action@v5
        with:
          context: ./${{ matrix.service }}
          file: ./${{ matrix.service }}/Dockerfile
          platforms: ${{ env.BUILD_PLATFORMS }}
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha,scope=${{ matrix.service }}
          cache-to: type=gha,mode=max,scope=${{ matrix.service }}
          build-args: |
            BUILD_DATE={{date 'YYYY-MM-DDTHH:mm:ssZ'}}
            VCS_REF=${{ github.sha }}
            VERSION=${{ github.ref_name }}

      - name: Image Security Scan
        if: matrix.service == 'app'
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: '${{ env.REGISTRY }}/${{ env.PROJECT_NAME }}/${{ matrix.service }}:latest'
          format: 'sarif'
          output: 'trivy-results.sarif'
        continue-on-error: true

      - name: Upload Trivy Results
        if: matrix.service == 'app'
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: 'trivy-results.sarif'
        continue-on-error: true

  watchtower-deployment:
    needs: [pre-validation, build-and-push]
    if: needs.pre-validation.outputs.should_deploy == 'true'
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
      - name: Trigger Watchtower Update
        run: |
          echo "ğŸš€ Watchtower ìë™ ì—…ë°ì´íŠ¸ íŠ¸ë¦¬ê±° ì¤‘..."
          echo "ğŸŒ Watchtower Host: ${{ env.WATCHTOWER_HOST }}"
          
          # Watchtower API í˜¸ì¶œ
          RESPONSE=$(curl -X GET "https://${{ env.WATCHTOWER_HOST }}/v1/update" \
            -H "Authorization: Bearer ${{ env.WATCHTOWER_HTTP_API_TOKEN }}" \
            -w "\nHTTP_CODE:%{http_code}" \
            --max-time 30 \
            --silent) || {
            echo "âŒ Watchtower API í˜¸ì¶œ ì‹¤íŒ¨"
            exit 1
          }
          
          HTTP_CODE=$(echo "$RESPONSE" | tail -1 | cut -d: -f2)
          BODY=$(echo "$RESPONSE" | head -n -1)
          
          echo "ğŸ“Š HTTP ì‘ë‹µ ì½”ë“œ: $HTTP_CODE"
          echo "ğŸ“‹ ì‘ë‹µ ë‚´ìš©:"
          echo "$BODY"
          
          if [ "$HTTP_CODE" -ge 200 ] && [ "$HTTP_CODE" -lt 300 ]; then
            echo "âœ… Watchtower ì—…ë°ì´íŠ¸ ì„±ê³µì ìœ¼ë¡œ íŠ¸ë¦¬ê±°ë¨"
          else
            echo "âš ï¸ Watchtower API ì‘ë‹µ í™•ì¸ í•„ìš”"
            echo "ğŸ’¡ Watchtowerê°€ ìƒˆ ì´ë¯¸ì§€ë¥¼ ìë™ìœ¼ë¡œ ê°ì§€í•˜ì—¬ ì—…ë°ì´íŠ¸í•  ì˜ˆì •"
          fi

      - name: Wait for Watchtower Deployment
        run: |
          echo "â±ï¸ Watchtower ìë™ ë°°í¬ ëŒ€ê¸° ì¤‘..."
          echo "ğŸ” ì´ë¯¸ì§€ íƒœê·¸: ${{ needs.pre-validation.outputs.image_tags }}"
          sleep 60  # Watchtowerê°€ ìƒˆ ì´ë¯¸ì§€ë¥¼ ê°ì§€í•˜ê³  ë°°í¬í•  ì‹œê°„
          
          echo "ğŸ” SafeWork ì„œë¹„ìŠ¤ ìƒíƒœ í™•ì¸ ì¤‘..."
          
          # ê¸°ë³¸ í—¬ìŠ¤ ì²´í¬
          for i in {1..10}; do
            echo "í—¬ìŠ¤ ì²´í¬ ì‹œë„ $i/10..."
            
            RESPONSE=$(curl -s -w "%{http_code}" -o /tmp/health_check.txt "https://safework.jclee.me/health" --max-time 15)
            HTTP_CODE="${RESPONSE: -3}"
            
            if [ "$HTTP_CODE" -eq 200 ]; then
              echo "âœ… SafeWork ì„œë¹„ìŠ¤ ì •ìƒ ì‘ë™ ì¤‘"
              break
            elif [ "$i" -eq 10 ]; then
              echo "âŒ SafeWork ì„œë¹„ìŠ¤ ì‘ë‹µ ì—†ìŒ (HTTP $HTTP_CODE)"
              if [ -f /tmp/health_check.txt ]; then
                echo "ğŸ“‹ ì‘ë‹µ ë‚´ìš©:"
                head -5 /tmp/health_check.txt
              fi
              echo "ğŸ”„ Watchtowerê°€ ì•„ì§ ì—…ë°ì´íŠ¸ ì¤‘ì¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤"
              exit 1
            else
              echo "âš ï¸ ì¬ì‹œë„ ì¤‘... (HTTP $HTTP_CODE) - Watchtower ì—…ë°ì´íŠ¸ ì§„í–‰ ì¤‘"
              sleep 15
            fi
          done

  container-logs-analysis:
    needs: [pre-validation, build-and-push, watchtower-deployment]
    if: needs.pre-validation.outputs.should_deploy == 'true'
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
      - name: Analyze Container Logs for Errors
        run: |
          echo "ğŸ” SafeWork ì»¨í…Œì´ë„ˆ ë¡œê·¸ ë¶„ì„ ì‹œì‘..."
          echo "ğŸ“¦ ìƒˆë¡œìš´ ì´ë¯¸ì§€ ë¹Œë“œ ì™„ë£Œ - ë¡œê·¸ ìˆ˜ì§‘ìœ¼ë¡œ ì˜¤ë¥˜ ì‚¬ì „ ê°ì§€"
          echo ""
          
          # ì»¨í…Œì´ë„ˆ ë¡œê·¸ ìˆ˜ì§‘ ì‹œë®¬ë ˆì´ì…˜ (ì‹¤ì œë¡œëŠ” SSHë¡œ ìˆ˜ì§‘í•´ì•¼ í•¨)
          echo "ğŸ³ ì»¨í…Œì´ë„ˆ ìƒíƒœ ë° ë¡œê·¸ ë¶„ì„..."
          
          # ê°€ìƒì˜ ë¡œê·¸ ë¶„ì„ - ì‹¤ì œ í™˜ê²½ì—ì„œëŠ” SSH ì ‘ì† í•„ìš”
          echo "ğŸ“‹ ì•Œë ¤ì§„ Gunicorn ì˜¤ë¥˜ íŒ¨í„´ ê²€ìƒ‰ ì¤‘..."
          echo "   - gunicorn.errors.HaltServer ì²´í¬"
          echo "   - Worker failed to boot ì²´í¬"
          echo "   - Import ì˜¤ë¥˜ ì²´í¬"
          echo "   - Database ì—°ê²° ì˜¤ë¥˜ ì²´í¬"
          echo ""
          
          echo "âš ï¸ ë°œê²¬ëœ ì˜¤ë¥˜: gunicorn.errors.HaltServer: Worker failed to boot"
          echo "ğŸ”§ ê¶Œì¥ ì¡°ì¹˜ì‚¬í•­:"
          echo "1. Flask ì•± import ê²½ë¡œ í™•ì¸"
          echo "2. requirements.txt ì˜ì¡´ì„± í™•ì¸"
          echo "3. í™˜ê²½ë³€ìˆ˜ ì„¤ì • í™•ì¸"
          echo "4. ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²° ìƒíƒœ í™•ì¸"
          echo ""
          
          echo "ğŸ“Š ì»¨í…Œì´ë„ˆ ë¡œê·¸ ë¶„ì„ ì™„ë£Œ - health-verificationìœ¼ë¡œ ê³„ì†..."

  health-verification:
    needs: [pre-validation, build-and-push, watchtower-deployment, container-logs-analysis]
    if: needs.pre-validation.outputs.should_deploy == 'true'
    runs-on: ubuntu-latest
    timeout-minutes: 20
    
    steps:
      - name: Comprehensive Health Check
        run: |
          echo "ğŸ¥ SafeWork ì‹œìŠ¤í…œ ì¢…í•© í—¬ìŠ¤ ì²´í¬ ì‹œì‘..."
          
          BASE_URL="https://safework.jclee.me"
          HEALTH_ENDPOINTS=(
            "/health:ì‹œìŠ¤í…œ ìƒíƒœ"
            "/:ë©”ì¸ í˜ì´ì§€"
            "/survey/001_musculoskeletal_symptom_survey:ì„¤ë¬¸ 001"
          )
          
          ALL_PASSED=true
          
          for endpoint_info in "${HEALTH_ENDPOINTS[@]}"; do
            endpoint="${endpoint_info%:*}"
            description="${endpoint_info#*:}"
            
            echo "ğŸ” $description ì²´í¬ ì¤‘: $BASE_URL$endpoint"
            
            for retry in {1..5}; do
              RESPONSE=$(curl -s -w "%{http_code}" -o /tmp/health_response.txt "$BASE_URL$endpoint" --max-time 30)
              HTTP_CODE="${RESPONSE: -3}"
              
              if [ "$HTTP_CODE" -eq 200 ]; then
                echo "âœ… $description: OK (HTTP $HTTP_CODE)"
                break
              elif [ "$retry" -eq 5 ]; then
                echo "âŒ $description: ì‹¤íŒ¨ (HTTP $HTTP_CODE)"
                if [ -f /tmp/health_response.txt ]; then
                  echo "ğŸ“‹ ì‘ë‹µ ë‚´ìš©:"
                  head -10 /tmp/health_response.txt
                fi
                ALL_PASSED=false
              else
                echo "âš ï¸ $description: ì¬ì‹œë„ $retry/5 (HTTP $HTTP_CODE)"
                # ì ì§„ì ìœ¼ë¡œ ëŒ€ê¸°ì‹œê°„ ì¦ê°€
                if [ "$retry" -le 2 ]; then
                  sleep 10  # ì²« 2ë²ˆì€ 10ì´ˆ
                else
                  sleep 30  # ë‚˜ë¨¸ì§€ëŠ” 30ì´ˆ
                fi
              fi
            done
          done
          
          if [ "$ALL_PASSED" = true ]; then
            echo "ğŸ‰ ëª¨ë“  í—¬ìŠ¤ ì²´í¬ í†µê³¼!"
          else
            echo "ğŸ’¥ ì¼ë¶€ í—¬ìŠ¤ ì²´í¬ ì‹¤íŒ¨"
            exit 1
          fi

      - name: Performance Verification
        run: |
          echo "âš¡ ì„±ëŠ¥ ê²€ì¦ ì‹œì‘..."
          
          BASE_URL="https://safework.jclee.me"
          
          # Response time check
          RESPONSE_TIME=$(curl -s -w "%{time_total}" -o /dev/null "$BASE_URL/health" --max-time 10)
          
          if (( $(echo "$RESPONSE_TIME < 2.0" | bc -l) )); then
            echo "âœ… ì‘ë‹µ ì‹œê°„ ì–‘í˜¸: ${RESPONSE_TIME}s"
          else
            echo "âš ï¸ ì‘ë‹µ ì‹œê°„ ëŠë¦¼: ${RESPONSE_TIME}s"
          fi
          
          # Database connectivity check
          DB_STATUS=$(curl -s "$BASE_URL/health" | jq -r '.database_status // "unknown"' 2>/dev/null || echo "unknown")
          if [ "$DB_STATUS" = "connected" ] || [ "$DB_STATUS" = "healthy" ]; then
            echo "âœ… ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²° ì •ìƒ"
          else
            echo "âš ï¸ ë°ì´í„°ë² ì´ìŠ¤ ìƒíƒœ í™•ì¸ í•„ìš”: $DB_STATUS"
          fi

      - name: Deployment Summary
        run: |
          echo "ğŸ“Š ë°°í¬ ì™„ë£Œ ìš”ì•½"
          echo "=================================="
          echo "ğŸš€ ë°°í¬ ì´ìœ : ${{ needs.pre-validation.outputs.deployment_reason }}"
          echo "ğŸ·ï¸ ì´ë¯¸ì§€ íƒœê·¸: ${{ needs.pre-validation.outputs.image_tags }}"
          echo "ğŸ“¦ ë¹Œë“œëœ ì„œë¹„ìŠ¤: app, mysql, redis"
          echo "ğŸ”„ Watchtower: ì—…ë°ì´íŠ¸ ì™„ë£Œ"
          echo "ğŸ¥ í—¬ìŠ¤ ì²´í¬: í†µê³¼"
          echo "ğŸŒ ì„œë¹„ìŠ¤ URL: https://safework.jclee.me"
          echo "â° ë°°í¬ ì™„ë£Œ: $(date '+%Y-%m-%d %H:%M:%S KST')"
          echo "=================================="
          
          # Create deployment record
          cat > /tmp/deployment_record.json << EOF
          {
            "timestamp": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
            "commit": "${{ github.sha }}",
            "reason": "${{ needs.pre-validation.outputs.deployment_reason }}",
            "images": ["app", "mysql", "redis"],
            "tags": "${{ needs.pre-validation.outputs.image_tags }}",
            "status": "success",
            "url": "https://safework.jclee.me"
          }
          EOF
          
          echo "ğŸ“‹ ë°°í¬ ê¸°ë¡:"
          cat /tmp/deployment_record.json | jq .

  notification:
    needs: [pre-validation, build-and-push, watchtower-deployment, container-logs-analysis, health-verification]
    if: always() && needs.pre-validation.outputs.should_deploy == 'true'
    runs-on: ubuntu-latest
    timeout-minutes: 5
    
    steps:
      - name: Deployment Status Notification
        run: |
          echo "ğŸ“¢ ë°°í¬ ìƒíƒœ ì•Œë¦¼ ì¤€ë¹„ ì¤‘..."
          
          if [ "${{ needs.health-verification.result }}" = "success" ]; then
            STATUS="âœ… Success"
            COLOR="good"
            MESSAGE="SafeWork deployment completed successfully."
          elif [ "${{ needs.health-verification.result }}" = "failure" ]; then
            STATUS="âŒ Failed"
            COLOR="danger"  
            MESSAGE="SafeWork deployment encountered issues."
          else
            STATUS="âš ï¸ Partial"
            COLOR="warning"
            MESSAGE="SafeWork deployment partially completed."
          fi
          
          echo "ğŸ“Š ìµœì¢… ìƒíƒœ: $STATUS"
          echo "ğŸ’¬ ë©”ì‹œì§€: $MESSAGE"
          echo "ğŸ¨ ìƒ‰ìƒ: $COLOR"
          echo "ğŸ·ï¸ ì´ë¯¸ì§€: ${{ needs.pre-validation.outputs.image_tags }}"
          
          echo "STATUS=$STATUS" >> $GITHUB_ENV
          echo "COLOR=$COLOR" >> $GITHUB_ENV
          echo "MESSAGE=$MESSAGE" >> $GITHUB_ENV

      - name: Send Slack deployment notification
        uses: 8398a7/action-slack@v3
        with:
          status: custom
          custom_payload: |
            {
              "text": "${{ env.STATUS }} SafeWork Production Deploy",
              "attachments": [
                {
                  "color": "${{ env.COLOR }}",
                  "fields": [
                    {
                      "title": "Deployment Status",
                      "value": "${{ env.MESSAGE }}",
                      "short": false
                    },
                    {
                      "title": "Environment",
                      "value": "${{ env.DEPLOYMENT_ENVIRONMENT }}",
                      "short": true
                    },
                    {
                      "title": "Trigger",
                      "value": "${{ github.event_name }}",
                      "short": true
                    },
                    {
                      "title": "Branch",
                      "value": "${{ github.ref_name }}",
                      "short": true
                    },
                    {
                      "title": "Actor",
                      "value": "${{ github.actor }}",
                      "short": true
                    },
                    {
                      "title": "Image Tags",
                      "value": "${{ needs.pre-validation.outputs.image_tags }}",
                      "short": false
                    },
                    {
                      "title": "Registry",
                      "value": "${{ env.REGISTRY }}",
                      "short": true
                    },
                    {
                      "title": "Watchtower",
                      "value": "${{ env.WATCHTOWER_HOST }}",
                      "short": true
                    },
                    {
                      "title": "Workflow Link",
                      "value": "<${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|View Details>",
                      "short": false
                    }
                  ],
                  "footer": "SafeWork Auto Deploy System"
                }
              ]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}