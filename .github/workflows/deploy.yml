name: SafeWork Enhanced Deployment Pipeline

on:
  push:
    branches: [master]
    paths:
      - 'src/app/**'
      - 'infrastructure/docker/**' 
      - 'scripts/**'
      - 'docker-compose.yml'
      - '.github/workflows/deploy.yml'
  workflow_dispatch:
    inputs:
      deploy_to_production:
        description: 'Deploy to production after build'
        required: false
        default: 'true'
        type: choice
        options:
          - 'true'
          - 'false'
      force_rebuild:
        description: 'Force rebuild all containers'
        required: false
        default: 'false'
        type: boolean

env:
  # Registry ì„¤ì •
  REGISTRY_HOST: registry.jclee.me
  REGISTRY_USER: admin
  REGISTRY_PASSWORD: ${{ secrets.REGISTRY_PASSWORD }}

  # Application ì„¤ì •
  APP_NAME: safework
  APP_PORT: 4545

  # Database ì„¤ì •
  DB_NAME: safework_db
  DB_USER: safework
  DB_PASSWORD: ${{ secrets.DB_PASSWORD }}

  # Portainer ì„¤ì • (Enhanced)
  PORTAINER_URL: https://portainer.jclee.me
  PORTAINER_API_KEY: ${{ secrets.PORTAINER_API_KEY }}
  PORTAINER_WEBHOOK_URL: ${{ secrets.PORTAINER_WEBHOOK_URL }}
  PORTAINER_ENDPOINT: 3

  # Admin ì„¤ì •
  ADMIN_USERNAME: ${{ secrets.ADMIN_USERNAME }}
  ADMIN_PASSWORD: ${{ secrets.ADMIN_PASSWORD }}

  # Security ì„¤ì •
  SECRET_KEY: ${{ secrets.SECRET_KEY }}

  # Deployment ì„¤ì •
  DEPLOYMENT_TIMEOUT: 600
  HEALTH_CHECK_RETRIES: 15
  PERFORMANCE_MONITORING_DURATION: 300

jobs:
  build:
    name: Build & Push Docker Images
    runs-on: ubuntu-latest
    timeout-minutes: 30  # íƒ€ì„ì•„ì›ƒ ì¶”ê°€ë¡œ ë¬´í•œ ëŒ€ê¸° ë°©ì§€

    strategy:
      matrix:
        service:
          - name: app
            context: ./src/app
            dockerfile: ./src/app/Dockerfile
          - name: postgres
            context: ./infrastructure/docker/postgres
            dockerfile: ./infrastructure/docker/postgres/Dockerfile
          - name: redis
            context: ./infrastructure/docker/redis
            dockerfile: ./infrastructure/docker/redis/Dockerfile
      fail-fast: false  # í•˜ë‚˜ì˜ ë¹Œë“œê°€ ì‹¤íŒ¨í•´ë„ ë‹¤ë¥¸ ë¹Œë“œ ê³„ì† ì§„í–‰

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY_HOST }}
          username: ${{ env.REGISTRY_USER }}
          password: ${{ env.REGISTRY_PASSWORD }}

      - name: Build & Push ${{ matrix.service.name }}
        uses: docker/build-push-action@v5
        with:
          context: ${{ matrix.service.context }}
          file: ${{ matrix.service.dockerfile }}
          push: true
          tags: |
            ${{ env.REGISTRY_HOST }}/${{ env.APP_NAME }}/${{ matrix.service.name }}:latest
            ${{ env.REGISTRY_HOST }}/${{ env.APP_NAME }}/${{ matrix.service.name }}:${{ github.sha }}
            ${{ env.REGISTRY_HOST }}/${{ env.APP_NAME }}/${{ matrix.service.name }}:${{ github.run_number }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          platforms: linux/amd64  # í”Œë«í¼ ëª…ì‹œì  ì§€ì •
          build-args: |
            DB_NAME=${{ env.DB_NAME }}
            DB_USER=${{ env.DB_USER }}
            DB_PASSWORD=${{ env.DB_PASSWORD }}

  deploy:
    name: Enhanced Deployment via Portainer Webhook
    needs: build
    runs-on: ubuntu-latest
    if: github.event_name == 'push' || (github.event_name == 'workflow_dispatch' && github.event.inputs.deploy_to_production == 'true')
    timeout-minutes: 15

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Enhanced Deployment Environment
        run: |
          echo "ğŸ”§ Enhanced Deployment System v2.0 ì¤€ë¹„ ì¤‘..."
          
          # Make deployment script executable
          chmod +x ./scripts/enhanced_deployment_system.sh
          
          # Verify required environment variables
          required_vars=("PORTAINER_WEBHOOK_URL" "PORTAINER_API_KEY")
          missing_vars=()
          
          for var in "${required_vars[@]}"; do
            if [ -z "${!var:-}" ]; then
              missing_vars+=("$var")
            fi
          done
          
          if [ ${#missing_vars[@]} -gt 0 ]; then
            echo "âŒ Missing required environment variables: ${missing_vars[*]}"
            exit 1
          fi
          
          echo "âœ… í™˜ê²½ ë³€ìˆ˜ ê²€ì¦ ì™„ë£Œ"

      - name: Deploy via Enhanced Webhook System
        env:
          PORTAINER_WEBHOOK_URL: ${{ env.PORTAINER_WEBHOOK_URL }}
          PORTAINER_API_KEY: ${{ env.PORTAINER_API_KEY }}
          PORTAINER_URL: ${{ env.PORTAINER_URL }}
          SERVICE_URL: https://safework.jclee.me
        run: |
          echo "ğŸš€ Enhanced Webhook ë°°í¬ ì‹œì‘..."
          
          # Execute enhanced deployment
          if ./scripts/enhanced_deployment_system.sh webhook-only; then
            echo "âœ… Webhook ë°°í¬ ì„±ê³µ!"
          else
            echo "âŒ Webhook ë°°í¬ ì‹¤íŒ¨"
            exit 1
          fi

      - name: Comprehensive Health Verification
        env:
          PORTAINER_API_KEY: ${{ env.PORTAINER_API_KEY }}
          PORTAINER_URL: ${{ env.PORTAINER_URL }}
        run: |
          echo "ğŸ” í¬ê´„ì ì¸ í—¬ìŠ¤ì²´í¬ ì‹œì‘..."
          
          # Wait for deployment propagation
          echo "ë°°í¬ ì „íŒŒ ëŒ€ê¸° ì¤‘ (20ì´ˆ)..."
          sleep 20
          
          # Execute health check
          if ./scripts/enhanced_deployment_system.sh health-check; then
            echo "âœ… í—¬ìŠ¤ì²´í¬ ì„±ê³µ!"
          else
            echo "âŒ í—¬ìŠ¤ì²´í¬ ì‹¤íŒ¨"
            
            # Collect debug information
            echo "ğŸ” ë””ë²„ê·¸ ì •ë³´ ìˆ˜ì§‘ ì¤‘..."
            
            # Stack status
            if [ -n "$PORTAINER_API_KEY" ]; then
              echo "Portainer ìŠ¤íƒ ìƒíƒœ:"
              curl -s -H "X-API-Key: $PORTAINER_API_KEY" \
                "$PORTAINER_URL/api/stacks" | \
                jq '.[] | select(.Name | contains("safework")) | {Name, Status, CreationDate}' 2>/dev/null || echo "ìŠ¤íƒ ì •ë³´ ì¡°íšŒ ì‹¤íŒ¨"
              
              echo "ì»¨í…Œì´ë„ˆ ìƒíƒœ:"
              curl -s -H "X-API-Key: $PORTAINER_API_KEY" \
                "$PORTAINER_URL/api/endpoints/3/docker/containers/json" | \
                jq '.[] | select(.Names[] | contains("safework")) | {Names: .Names[0], State, Status}' 2>/dev/null || echo "ì»¨í…Œì´ë„ˆ ì •ë³´ ì¡°íšŒ ì‹¤íŒ¨"
            fi
            
            exit 1
          fi

      - name: Performance Monitoring
        if: success()
        env:
          PORTAINER_API_KEY: ${{ env.PORTAINER_API_KEY }}
        run: |
          echo "ğŸ“Š ì„±ëŠ¥ ëª¨ë‹ˆí„°ë§ ì‹œì‘..."
          
          # Short performance check for CI/CD (2 minutes instead of 5)
          timeout 120 ./scripts/enhanced_deployment_system.sh monitor || {
            echo "âš ï¸ ì„±ëŠ¥ ëª¨ë‹ˆí„°ë§ íƒ€ì„ì•„ì›ƒ (ì •ìƒì ì¸ CI/CD ë™ì‘)"
            
            # Quick health check instead
            response=$(curl -s -m 10 https://safework.jclee.me/health || echo "")
            if [ -n "$response" ]; then
              echo "ìµœì¢… í—¬ìŠ¤ì²´í¬ ê²°ê³¼:"
              echo "$response" | jq . 2>/dev/null || echo "$response"
            fi
          }

      - name: Advanced Fallback Deployment
        if: failure()
        env:
          PORTAINER_API_KEY: ${{ env.PORTAINER_API_KEY }}
          PORTAINER_URL: ${{ env.PORTAINER_URL }}
          PORTAINER_ENDPOINT: ${{ env.PORTAINER_ENDPOINT }}
        run: |
          echo "ğŸ”„ ê³ ê¸‰ Fallback ë°°í¬ ì‹œì‘..."
          
          # Check if fallback script exists
          if [ -f "./scripts/backup/portainer_api_deploy_v2.0.0.sh" ]; then
            chmod +x ./scripts/backup/portainer_api_deploy_v2.0.0.sh
            
            echo "Portainer API ì§ì ‘ ë°°í¬ ì‹œë„..."
            if ./scripts/backup/portainer_api_deploy_v2.0.0.sh deploy; then
              echo "âœ… Fallback ë°°í¬ ì„±ê³µ!"
              
              # Fallback health check
              sleep 15
              ./scripts/enhanced_deployment_system.sh health-check
            else
              echo "âŒ Fallback ë°°í¬ë„ ì‹¤íŒ¨"
              exit 1
            fi
          else
            echo "âš ï¸ Fallback ìŠ¤í¬ë¦½íŠ¸ ì—†ìŒ - ìˆ˜ë™ ë³µêµ¬ í•„ìš”"
            echo "Portainer ëŒ€ì‹œë³´ë“œ: $PORTAINER_URL"
            exit 1
          fi

      - name: Deployment Summary
        if: always()
        run: |
          echo "ğŸ“Š ë°°í¬ ìš”ì•½ ë¦¬í¬íŠ¸"
          echo "=================="
          
          if [ "${{ job.status }}" == "success" ]; then
            echo "âœ… SafeWork ë°°í¬ ì„±ê³µ!"
            echo "ğŸ“… ë°°í¬ ì‹œê°„: $(date '+%Y-%m-%d %H:%M:%S KST')"
            echo "ğŸŒ ì„œë¹„ìŠ¤ URL: https://safework.jclee.me"
            echo "ğŸ“¦ ì´ë¯¸ì§€ ë²„ì „: ${{ github.sha }}"
            echo "ğŸš€ ë°°í¬ ë°©ì‹: Portainer Webhook"
            echo "ğŸ—ï¸ ë¹Œë“œ ë²ˆí˜¸: ${{ github.run_number }}"
            
            # ìµœì¢… ìƒíƒœ í™•ì¸
            echo ""
            echo "ğŸ” ìµœì¢… ì„œë¹„ìŠ¤ ìƒíƒœ í™•ì¸:"
            response=$(curl -s -m 10 https://safework.jclee.me/health || echo "")
            if [ -n "$response" ]; then
              echo "$response" | jq . 2>/dev/null || echo "$response"
            else
              echo "âš ï¸ ìƒíƒœ í™•ì¸ ì‹¤íŒ¨"
            fi
            
          elif [ -n "$(echo '${{ steps.*.outcome }}' | grep -o 'success')" ]; then
            echo "âœ… SafeWork Fallback ë°°í¬ ì„±ê³µ!"
            echo "ğŸ“… ë°°í¬ ì‹œê°„: $(date '+%Y-%m-%d %H:%M:%S KST')"
            echo "ğŸŒ ì„œë¹„ìŠ¤ URL: https://safework.jclee.me"  
            echo "ğŸ“¦ ì´ë¯¸ì§€ ë²„ì „: ${{ github.sha }}"
            echo "ğŸ”„ ë°°í¬ ë°©ì‹: Portainer API (Fallback)"
            echo "ğŸ—ï¸ ë¹Œë“œ ë²ˆí˜¸: ${{ github.run_number }}"
            echo "âš ï¸ ì°¸ê³ : Webhook ì‹¤íŒ¨ë¡œ Fallback API ì‚¬ìš©ë¨"
            
          else
            echo "âŒ SafeWork ë°°í¬ ì‹¤íŒ¨!"
            echo "ğŸ“… ì‹¤íŒ¨ ì‹œê°„: $(date '+%Y-%m-%d %H:%M:%S KST')"
            echo "ğŸ” ë¡œê·¸ë¥¼ í™•ì¸í•˜ì—¬ ë¬¸ì œë¥¼ í•´ê²°í•˜ì„¸ìš”"
            echo "ğŸ“– ë¬¸ì œ í•´ê²° ê°€ì´ë“œ: docs/TROUBLESHOOTING.md"
            echo "ğŸ”§ Portainer ìŠ¤íƒ ìƒíƒœ: https://portainer.jclee.me"
          fi

      - name: Post-Deployment Monitoring
        if: success()
        run: |
          echo "ğŸ“Š ë°°í¬ í›„ ì„±ëŠ¥ ëª¨ë‹ˆí„°ë§ ì‹œì‘..."
          
          # ëª¨ë‹ˆí„°ë§ ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰ ê¶Œí•œ ì„¤ì •
          chmod +x ./scripts/deployment_monitor.sh
          
          # 5ë¶„ê°„ ì„±ëŠ¥ ëª¨ë‹ˆí„°ë§ (30ì´ˆ ê°„ê²©, 10íšŒ)
          echo "ğŸ” 5ë¶„ê°„ ì§‘ì¤‘ ëª¨ë‹ˆí„°ë§ ìˆ˜í–‰ ì¤‘..."
          
          if ./scripts/deployment_monitor.sh monitor -i 30 -c 10 --verbose; then
            echo "âœ… ë°°í¬ í›„ ëª¨ë‹ˆí„°ë§ ì™„ë£Œ - ì‹œìŠ¤í…œ ì•ˆì •"
          else
            echo "âš ï¸ ëª¨ë‹ˆí„°ë§ì—ì„œ ì¼ë¶€ ì´ìŠˆ ê°ì§€ë¨"
            
            # ì„±ëŠ¥ ë¦¬í¬íŠ¸ ìƒì„±
            echo "ğŸ“‹ ì„±ëŠ¥ ë¦¬í¬íŠ¸ ìƒì„± ì¤‘..."
            report_file=$(./scripts/deployment_monitor.sh report)
            echo "ë¦¬í¬íŠ¸ ìœ„ì¹˜: $report_file"
            
            # ë¦¬í¬íŠ¸ ìš”ì•½ ì¶œë ¥
            if [ -f "$report_file" ]; then
              echo "ğŸ“Š ì„±ëŠ¥ ë¦¬í¬íŠ¸ ìš”ì•½:"
              head -20 "$report_file" | grep -E "(í‰ê· |ìƒíƒœ|ì•Œë¦¼)" || echo "ìš”ì•½ ì •ë³´ ì—†ìŒ"
            fi
          fi
          
          # ìµœì¢… ìƒíƒœ í™•ì¸
          echo ""
          echo "ğŸ¯ ìµœì¢… ë°°í¬ ì„±ëŠ¥ í™•ì¸:"
          ./scripts/deployment_monitor.sh check --verbose