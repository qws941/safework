name: ğŸš€ Deploy Pipeline

# Prevent concurrent deployments on the same branch
concurrency:
  group: deploy-${{ github.ref_name }}
  cancel-in-progress: true

on:
  push:
    branches: [master]
    paths:
      - 'app/**'
      - 'postgres/**'
      - 'redis/**'
      - '.github/workflows/deploy.yml'
  
  workflow_dispatch:

env:
  APP_NAME: safework
  REGISTRY_HOST: ${{ secrets.REGISTRY_HOST || 'registry.jclee.me' }}
  REGISTRY_USER: ${{ secrets.REGISTRY_USER || 'admin' }}
  TZ: Asia/Seoul
  PRD_URL: ${{ secrets.PRD_URL || 'https://safework.jclee.me' }}
  DEV_URL: ${{ secrets.DEV_URL || 'https://safework-dev.jclee.me' }}
  PORTAINER_URL: ${{ secrets.PORTAINER_URL || 'https://portainer.jclee.me' }}

permissions:
  contents: write          # Code modification access
  actions: write          # Workflow control and management
  pull-requests: write    # PR creation and management
  issues: write          # Issue management and creation
  packages: write        # Package and registry access
  security-events: write # Security event management
  checks: write          # Status check management
  statuses: write        # Commit status updates
  deployments: write     # Deployment management
  discussions: write     # Repository discussions
  repository-projects: write  # Project board access
  id-token: write        # OIDC token for authentication

jobs:
  # Phase 1: Build and Test
  build-and-test:
    name: ğŸ”¨ Build & Test
    runs-on: ubuntu-latest
    outputs:
      app_image_tag: ${{ steps.app_meta.outputs.tags }}
      postgres_image_tag: ${{ steps.postgres_meta.outputs.tags }}
      redis_image_tag: ${{ steps.redis_meta.outputs.tags }}
      test_results: ${{ steps.test.outputs.results }}
      build_status: ${{ steps.build.outputs.build_status }}
      
    steps:
      - name: ğŸ“‚ Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ³ Setup Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: ğŸ” Login to Registry  
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY_HOST }}
          username: ${{ env.REGISTRY_USER }}
          password: ${{ secrets.REGISTRY_PASSWORD }}

      # Metadata for PostgreSQL image
      - name: ğŸ“‹ Extract PostgreSQL Metadata
        id: postgres_meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY_HOST }}/safework/postgres
          tags: |
            type=raw,value=latest

      # Metadata for Redis image
      - name: ğŸ“‹ Extract Redis Metadata
        id: redis_meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY_HOST }}/safework/redis
          tags: |
            type=raw,value=latest

      # Metadata for App image
      - name: ğŸ“‹ Extract App Metadata
        id: app_meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY_HOST }}/safework/app
          tags: |
            type=raw,value=latest

      # Build PostgreSQL Container
      - name: ğŸ˜ Build & Push PostgreSQL Container
        uses: docker/build-push-action@v5
        with:
          context: ./postgres
          file: ./postgres/Dockerfile
          push: true
          tags: ${{ steps.postgres_meta.outputs.tags }}
          labels: ${{ steps.postgres_meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          platforms: linux/amd64

      # Build Redis Container  
      - name: ğŸ”´ Build & Push Redis Container
        uses: docker/build-push-action@v5
        with:
          context: ./redis
          file: ./redis/Dockerfile
          push: true
          tags: ${{ steps.redis_meta.outputs.tags }}
          labels: ${{ steps.redis_meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          platforms: linux/amd64

      # Build App Container
      - name: ğŸ Build & Push App Container
        uses: docker/build-push-action@v5
        with:
          context: ./app
          file: ./app/Dockerfile
          push: true
          tags: ${{ steps.app_meta.outputs.tags }}
          labels: ${{ steps.app_meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          platforms: linux/amd64

      # Test containers after build
      - name: ğŸ§ª Test Container Health
        id: test
        run: |
          echo "Testing container startup..."
          
          # Test PostgreSQL container
          docker run --rm --name test-postgres -d \
            -e POSTGRES_PASSWORD=safework2024 \
            -e POSTGRES_DB=safework_db \
            -e POSTGRES_USER=safework \
            ${{ steps.postgres_meta.outputs.tags }}
          
          sleep 10
          
          # Test Redis container
          docker run --rm --name test-redis -d \
            ${{ steps.redis_meta.outputs.tags }}
          
          sleep 5
          
          # Test App container startup
          docker run --rm --name test-app -d \
            -e POSTGRES_HOST=postgres \
            -e REDIS_HOST=redis \
            -e SECRET_KEY=test-secret \
            ${{ steps.app_meta.outputs.tags }}
          
          sleep 10
          
          # Cleanup test containers
          docker stop test-postgres test-redis test-app || true
          docker rm test-postgres test-redis test-app || true
          
          echo "results=success" >> $GITHUB_OUTPUT
          echo "build_status=success" >> $GITHUB_OUTPUT

  # Phase 2: Deploy to Production
  deploy:
    name: ğŸš€ Deploy to Production
    runs-on: ubuntu-latest
    needs: build-and-test
    if: success() || github.event.inputs.force_deploy == 'true'
    outputs:
      deployment_status: ${{ steps.deploy.outputs.status }}
      deployment_url: ${{ steps.deploy.outputs.url }}
      
    steps:
      - name: ğŸ“‚ Checkout
        uses: actions/checkout@v4

      - name: ğŸš€ Watchtower ìë™ë°°í¬ íŠ¸ë¦¬ê±°
        id: deploy
        run: |
          echo "ğŸš€ SafeWork Watchtower ìë™ë°°í¬ ì‹œì‘..."
          
          # Watchtower HTTP API í† í° í™•ì¸
          if [[ -z "${{ secrets.WATCHTOWER_HTTP_API_TOKEN }}" ]]; then
            echo "âŒ WATCHTOWER_HTTP_API_TOKENì´ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤"
            echo "status=failed" >> $GITHUB_OUTPUT
            exit 1
          fi
          
          echo "ğŸ“¡ Watchtower HTTP APIë¥¼ í†µí•œ SafeWork ì»¨í…Œì´ë„ˆ ì—…ë°ì´íŠ¸..."
          
          # Watchtower API í˜¸ì¶œë¡œ ëª¨ë“  SafeWork ì»¨í…Œì´ë„ˆ ì—…ë°ì´íŠ¸
          WATCHTOWER_RESPONSE=$(curl -X POST \
            -H "Authorization: Bearer ${{ secrets.WATCHTOWER_HTTP_API_TOKEN }}" \
            -H "Content-Type: application/json" \
            -d '{"containers": ["safework-postgres", "safework-redis", "safework-app"]}' \
            "https://watchtower.jclee.me/v1/update" \
            -w "%{http_code}" -s)
          
          RESPONSE_CODE="${WATCHTOWER_RESPONSE: -3}"
          RESPONSE_BODY="${WATCHTOWER_RESPONSE%???}"
          
          echo "Watchtower ì‘ë‹µ ì½”ë“œ: $RESPONSE_CODE"
          echo "Watchtower ì‘ë‹µ ë‚´ìš©: $RESPONSE_BODY"
          
          if [[ "$RESPONSE_CODE" == "200" || "$RESPONSE_CODE" == "202" ]]; then
            echo "âœ… Watchtower ìë™ë°°í¬ ì„±ê³µì ìœ¼ë¡œ íŠ¸ë¦¬ê±°ë¨"
            echo "ğŸ“¦ PostgreSQL: registry.jclee.me/safework/postgres:latest"
            echo "ğŸ“¦ Redis: registry.jclee.me/safework/redis:latest" 
            echo "ğŸ“¦ App: registry.jclee.me/safework/app:latest"
            echo "status=success" >> $GITHUB_OUTPUT
          else
            echo "âŒ Watchtower í˜¸ì¶œ ì‹¤íŒ¨: $RESPONSE_CODE"
            echo "status=failed" >> $GITHUB_OUTPUT
            exit 1
          fi
          
          # ë°°í¬ ëŒ€ê¸°
          echo "â³ ì»¨í…Œì´ë„ˆ ì¬ì‹œì‘ ëŒ€ê¸° (30ì´ˆ)..."
          sleep 30
          
          echo "status=success" >> $GITHUB_OUTPUT
          echo "url=${{ env.PRD_URL }}" >> $GITHUB_OUTPUT

      - name: ğŸ¥ Health Check
        id: health
        run: |
          echo "ğŸ¥ SafeWork ì• í”Œë¦¬ì¼€ì´ì…˜ ìƒíƒœ í™•ì¸..."
          
          # Health check with retry
          for i in {1..10}; do
            echo "ğŸ” Health check ì‹œë„ $i/10..."
            
            if curl -f -s "${{ env.PRD_URL }}/health" > /dev/null; then
              echo "âœ… SafeWork ì• í”Œë¦¬ì¼€ì´ì…˜ ì •ìƒ ë™ì‘"
              echo "health_status=healthy" >> $GITHUB_OUTPUT
              exit 0
            fi
            
            echo "â³ 30ì´ˆ ëŒ€ê¸° í›„ ì¬ì‹œë„..."
            sleep 30
          done
          
          echo "âŒ Health check ì‹¤íŒ¨"
          echo "health_status=unhealthy" >> $GITHUB_OUTPUT
          exit 1

      - name: ğŸ”„ Automatic Rollback on Failure
        if: failure()
        run: |
          echo "ğŸš¨ ë°°í¬ ì‹¤íŒ¨ ê°ì§€ - Watchtower ì´ì „ ë²„ì „ ë³µêµ¬..."
          
          # Watchtowerë¥¼ í†µí•œ SafeWork ì»¨í…Œì´ë„ˆ ë¡¤ë°±
          if [[ -n "${{ secrets.WATCHTOWER_HTTP_API_TOKEN }}" ]]; then
            echo "ğŸ“¡ Watchtower HTTP APIë¥¼ í†µí•œ ë¡¤ë°± ì‹¤í–‰..."
            ROLLBACK_RESPONSE=$(curl -X POST \
              -H "Authorization: Bearer ${{ secrets.WATCHTOWER_HTTP_API_TOKEN }}" \
              -H "Content-Type: application/json" \
              -d '{"containers": ["safework-postgres", "safework-redis", "safework-app"], "rollback": true}' \
              "https://watchtower.jclee.me/v1/update" \
              -w "%{http_code}" -s)
            
            ROLLBACK_CODE="${ROLLBACK_RESPONSE: -3}"
            echo "ë¡¤ë°± ì‘ë‹µ ì½”ë“œ: $ROLLBACK_CODE"
            
            if [[ "$ROLLBACK_CODE" == "200" || "$ROLLBACK_CODE" == "202" ]]; then
              echo "âœ… Watchtower ë¡¤ë°± ì„±ê³µ"
            else
              echo "âš ï¸ Watchtower ë¡¤ë°± ì‹¤íŒ¨: $ROLLBACK_CODE"
            fi
          else
            echo "âš ï¸ WATCHTOWER_HTTP_API_TOKENì´ ì„¤ì •ë˜ì§€ ì•Šì•„ ë¡¤ë°± ë¶ˆê°€"
          fi
          
          echo "ğŸ”„ ë¡¤ë°± í”„ë¡œì„¸ìŠ¤ ì™„ë£Œ"

  # Phase 3: Notification and Cleanup
  notify:
    name: ğŸ“¢ Deployment Notification
    runs-on: ubuntu-latest
    needs: [build-and-test, deploy]
    if: always()
    
    steps:
      - name: ğŸ“Š Deployment Summary
        run: |
          echo "=== SafeWork ë°°í¬ ì™„ë£Œ ===" 
          echo "ë¹Œë“œ ìƒíƒœ: ${{ needs.build-and-test.outputs.build_status }}"
          echo "ë°°í¬ ìƒíƒœ: ${{ needs.deploy.outputs.deployment_status }}"
          echo "ì• í”Œë¦¬ì¼€ì´ì…˜ URL: ${{ needs.deploy.outputs.deployment_url }}"
          echo "ë°°í¬ ì‹œê°„: $(date)"
          
          # ì»¨í…Œì´ë„ˆ ìƒíƒœ í™•ì¸
          echo ""
          echo "=== ì»¨í…Œì´ë„ˆ ìƒíƒœ ===" 
          echo "SafeWork PostgreSQL: safework-postgres:4546"
          echo "SafeWork Redis: safework-redis:4547" 
          echo "SafeWork App: safework-app:4545"

      - name: ğŸ› Create Issue on Deployment Failure
        if: failure()
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const title = `ğŸš¨ SafeWork ë°°í¬ ì‹¤íŒ¨ - ${new Date().toISOString()}`;
            const body = `
            ## ğŸš¨ SafeWork í”„ë¡œë•ì…˜ ë°°í¬ ì‹¤íŒ¨
            
            **ë°°í¬ ì •ë³´:**
            - ë¸Œëœì¹˜: ${{ github.ref_name }}
            - ì»¤ë°‹: ${{ github.sha }}
            - ì›Œí¬í”Œë¡œìš°: ${{ github.workflow }}
            - ì‹¤í–‰ ID: ${{ github.run_id }}
            
            **ì‹¤íŒ¨ ë‹¨ê³„:**
            - ë¹Œë“œ ìƒíƒœ: ${{ needs.build-and-test.outputs.build_status }}
            - ë°°í¬ ìƒíƒœ: ${{ needs.deploy.outputs.deployment_status }}
            
            **ì»¨í…Œì´ë„ˆ í¬íŠ¸:**
            - safework-postgres: 4546
            - safework-redis: 4547
            - safework-app: 4545
            
            **ì¡°ì¹˜ í•„ìš”:**
            - [ ] ë¹Œë“œ ë¡œê·¸ í™•ì¸
            - [ ] ì»¨í…Œì´ë„ˆ ìƒíƒœ ì ê²€  
            - [ ] Health check ê²°ê³¼ ë¶„ì„
            - [ ] ìˆ˜ë™ ë¡¤ë°± í•„ìš” ì—¬ë¶€ íŒë‹¨
            
            **ë¡œê·¸ í™•ì¸:**
            https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}
            `;
            
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: title,
              body: body,
              labels: ['deployment-failure', 'claude-actionable', 'safework']
            });

      - name: ğŸ‰ Deployment Success Notification
        if: success()
        run: |
          echo "ğŸ‰ SafeWork ë°°í¬ ì„±ê³µ!"
          echo "í”„ë¡œë•ì…˜ URL: ${{ env.PRD_URL }}"
          echo "Health check: ${{ env.PRD_URL }}/health"
          echo "Admin íŒ¨ë„: ${{ env.PRD_URL }}/admin"
          echo "ì„¤ë¬¸ì¡°ì‚¬: ${{ env.PRD_URL }}/survey/001_musculoskeletal_symptom_survey"

      - name: ğŸ“ˆ Claude Code Analysis
        if: success()
        uses: anthropics/claude-code-action@v1
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          anthropic_api_key: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          track_progress: true
          prompt: |
            ğŸ” **SafeWork ë°°í¬ íŒŒì´í”„ë¼ì¸ ë¶„ì„**
            
            **ë°°í¬ ê²°ê³¼:**
            - ë¹Œë“œ ìƒíƒœ: ${{ needs.build-and-test.outputs.build_status }}
            - ë°°í¬ ìƒíƒœ: ${{ needs.deploy.outputs.deployment_status }}
            - URL: ${{ needs.deploy.outputs.deployment_url }}
            
            **ì»¨í…Œì´ë„ˆ êµ¬ì„±:**
            - SafeWork PostgreSQL (í¬íŠ¸ 4546): ë°ì´í„°ë² ì´ìŠ¤ ì„œë¹„ìŠ¤
            - SafeWork Redis (í¬íŠ¸ 4547): ìºì‹œ ì„œë¹„ìŠ¤  
            - SafeWork App (í¬íŠ¸ 4545): Flask ì• í”Œë¦¬ì¼€ì´ì…˜
            
            **ë¶„ì„ ìš”ì²­:**
            1. ë°°í¬ ì„±ê³µ/ì‹¤íŒ¨ ì›ì¸ ë¶„ì„
            2. ì»¨í…Œì´ë„ˆ ë…ë¦½ ì•„í‚¤í…ì²˜ ìƒíƒœ ì ê²€
            3. Health check ê²°ê³¼ í•´ì„
            4. ì„±ëŠ¥ ìµœì í™” ì œì•ˆ
            5. ë‹¤ìŒ ë°°í¬ë¥¼ ìœ„í•œ ê°œì„ ì‚¬í•­
            
            **SafeWork íŠ¹í™” ì‚¬í•­:**
            - Flask 3.0+ ì‚°ì—… ì•ˆì „ ê´€ë¦¬ ì‹œìŠ¤í…œ
            - 001/002 ê±´ê°• ì„¤ë¬¸ì¡°ì‚¬ í¼
            - í•œêµ­ì–´ KST ì‹œê°„ëŒ€ ì§€ì›
            - Bootstrap 4.6 ë°˜ì‘í˜• UI
            
            ìƒì„¸í•œ ë¶„ì„ê³¼ ê¶Œì¥ì‚¬í•­ì„ í•œêµ­ì–´ë¡œ ì œê³µí•´ì£¼ì„¸ìš”.