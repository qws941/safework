name: 🤖 Automated Issue Handler

on:
  issues:
    types: [opened, edited, labeled]
  issue_comment:
    types: [created]
  workflow_dispatch:
    inputs:
      issue_number:
        description: 'Issue number to analyze'
        required: true
        type: number

permissions:
  contents: read
  issues: write
  pull-requests: write

jobs:
  issue-analysis:
    name: 🔍 Issue Analysis & Auto-Response
    runs-on: ubuntu-latest
    if: github.event_name == 'issues' || github.event_name == 'issue_comment' || github.event_name == 'workflow_dispatch'
    
    steps:
      - name: 📥 Checkout repository
        uses: actions/checkout@v4

      - name: 🤖 SafeWork Issue Analysis
        uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          track_progress: true
          prompt: |
            🤖 **SafeWork Issue Analysis System**
            
            REPOSITORY: ${{ github.repository }}
            ISSUE_NUMBER: ${{ github.event.issue.number || github.event.inputs.issue_number }}
            ISSUE_TITLE: "${{ github.event.issue.title }}"
            ISSUE_BODY: "${{ github.event.issue.body }}"
            ISSUE_AUTHOR: ${{ github.event.issue.user.login }}
            
            SafeWork 산업안전보건 관리 시스템의 GitHub 이슈를 분석하고 자동 응답을 제공해주세요.
            
            **프로젝트 컨텍스트:**
            - SafeWork: Flask 3.0+ 기반 산업안전보건 관리 시스템
            - 기술 스택: Python Flask, MySQL 8.0, Redis, Docker
            - 주요 기능: 설문 시스템, MSDS 관리, 안전 교육, 건강 검진
            - 배포: Docker Registry (registry.jclee.me), Watchtower 자동 배포
            
            **분석 및 응답:**
            1. 이슈 유형 분류 (버그, 기능 요청, 보안, 성능)
            2. 관련 코드 및 시스템 컴포넌트 식별
            3. 해결 방안 및 워크어라운드 제시
            4. 적절한 라벨 및 우선순위 설정
            
            **응답 언어:** 한국어로 답변해주세요.
          claude_args: |
            --model claude-sonnet-4-20250514
            --maxTokens 4096
            --temperature 0.1
            --allowedTools "mcp__serena__*,mcp__github__*,mcp__sequential-thinking__*"
            --systemPrompt "SafeWork Flask 애플리케이션 전문가. 산업안전보건 도메인 지식과 기술 전문성을 바탕으로 실용적인 솔루션을 제공합니다."

  security-escalation:
    name: 🔒 Security Issue Escalation
    runs-on: ubuntu-latest
    if: contains(github.event.issue.labels.*.name, 'security') || contains(github.event.issue.title, 'security') || contains(github.event.issue.title, 'vulnerability')
    
    steps:
      - name: 🚨 Security Alert
        uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          track_progress: true
          prompt: |
            🚨 **SafeWork 보안 이슈 긴급 분석**
            
            ISSUE_NUMBER: ${{ github.event.issue.number }}
            ISSUE_TITLE: "${{ github.event.issue.title }}"
            ISSUE_AUTHOR: ${{ github.event.issue.user.login }}
            
            SafeWork 시스템의 보안 이슈가 보고되었습니다.
            즉시 보안 영향도를 분석하고 대응 방안을 제시해주세요.
            
            **보안 분석 항목:**
            1. 보안 영향도 및 심각도 평가
            2. 영향받는 시스템 컴포넌트 식별
            3. 즉시 완화 조치 방안
            4. 장기 보안 개선 방안
            
            한국어로 상세한 보안 분석 및 대응 계획을 제공해주세요.
          claude_args: |
            --model claude-sonnet-4-20250514
            --maxTokens 4096
            --temperature 0.1
            --allowedTools "mcp__shrimp-task-manager__*,mcp__sequential-thinking__*,mcp__github__*"