name: ðŸŽ¯ Issue Handler

concurrency:
  group: issue-handler-${{ github.event.issue.number || github.run_id }}
  cancel-in-progress: true

on:
  issues:
    types: [opened, labeled, assigned]
  issue_comment:
    types: [created]

permissions:
  contents: read
  issues: write
  pull-requests: read
  id-token: write

jobs:
  handle-issue:
    if: |
      (github.event_name == 'issues' && (
        contains(github.event.issue.body, '@claude') || 
        contains(github.event.issue.title, '@claude') ||
        contains(github.event.issue.labels.*.name, 'claude-actionable') ||
        contains(github.event.issue.labels.*.name, 'needs-analysis')
      )) ||
      (github.event_name == 'issue_comment' && contains(github.event.comment.body, '@claude'))
    
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    steps:
      - name: ðŸ”— Checkout Repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0
          
      - name: ðŸ” Context Analysis
        id: context
        run: |
          echo "issue_number=${{ github.event.issue.number || 'N/A' }}" >> $GITHUB_OUTPUT
          echo "issue_title=${{ github.event.issue.title || 'N/A' }}" >> $GITHUB_OUTPUT
          echo "issue_author=${{ github.event.issue.user.login || 'N/A' }}" >> $GITHUB_OUTPUT
          echo "event_type=${{ github.event_name }}" >> $GITHUB_OUTPUT
          echo "repository=SafeWork Flask Application" >> $GITHUB_OUTPUT
          echo "architecture=Independent containers (PostgreSQL, Redis, Flask)" >> $GITHUB_OUTPUT
          
          # Extract issue labels
          LABELS="${{ join(github.event.issue.labels.*.name, ',') }}"
          echo "issue_labels=$LABELS" >> $GITHUB_OUTPUT
          
          # Determine issue priority and type
          if [[ "$LABELS" == *"critical"* ]]; then
            echo "priority=critical" >> $GITHUB_OUTPUT
          elif [[ "$LABELS" == *"high"* ]]; then
            echo "priority=high" >> $GITHUB_OUTPUT
          elif [[ "$LABELS" == *"bug"* ]]; then
            echo "priority=high" >> $GITHUB_OUTPUT
          else
            echo "priority=normal" >> $GITHUB_OUTPUT
          fi
          
      - name: ðŸ§  Setup Claude Code
        run: |
          curl -fsSL https://claude.ai/install.sh | bash
          echo "${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}" | claude auth
          
      - name: ðŸŽ¯ Claude Issue Analysis
        run: |
          claude code --dir . << 'EOF'
          ðŸŽ¯ **SafeWork ì´ìŠˆ ë¶„ì„ ë° ì²˜ë¦¬ ìš”ì²­**
          
          **í”„ë¡œì íŠ¸ ì»¨í…ìŠ¤íŠ¸:**
          - SafeWork Flask 3.0+ ì• í”Œë¦¬ì¼€ì´ì…˜ (ì‚°ì—… ì•ˆì „ ê´€ë¦¬ ì‹œìŠ¤í…œ)
          - ë…ë¦½ ì»¨í…Œì´ë„ˆ ì•„í‚¤í…ì²˜: safework2-postgres (4546), safework2-redis (4547), safework2-app (4545)
          - ë°ì´í„°ë² ì´ìŠ¤: PostgreSQL (safework_db, safework ì‚¬ìš©ìž)
          - ì£¼ìš” ê¸°ëŠ¥: ê±´ê°• ì„¤ë¬¸ì¡°ì‚¬, SafeWork ê´€ë¦¬, ë¬¸ì„œ ê´€ë¦¬, RESTful API v2
          
          **ì´ìŠˆ ì •ë³´:**
          - ì´ìŠˆ ë²ˆí˜¸: ${{ steps.context.outputs.issue_number }}
          - ì œëª©: "${{ steps.context.outputs.issue_title }}"
          - ìž‘ì„±ìž: ${{ steps.context.outputs.issue_author }}
          - ìš°ì„ ìˆœìœ„: ${{ steps.context.outputs.priority }}
          - ë¼ë²¨: ${{ steps.context.outputs.issue_labels }}
          - ì´ë²¤íŠ¸: ${{ steps.context.outputs.event_type }}
          
          **ì´ìŠˆ ë‚´ìš©:**
          ```
          ${{ github.event.issue.body || github.event.comment.body }}
          ```
          
          **ë¶„ì„ ë° ì²˜ë¦¬ ì§€ì¹¨:**
          
          1. **ì´ìŠˆ ë¶„ì„**:
             - ë¬¸ì œ ìœ í˜• ì‹ë³„ (ë²„ê·¸, ê¸°ëŠ¥ ìš”ì²­, ê°œì„ ì‚¬í•­, ì§ˆë¬¸)
             - ì˜í–¥ ë²”ìœ„ í‰ê°€ (í”„ë¡ íŠ¸ì—”ë“œ, ë°±ì—”ë“œ, ë°ì´í„°ë² ì´ìŠ¤, ì¸í”„ë¼)
             - ìš°ì„ ìˆœìœ„ ìž¬í‰ê°€ (critical, high, medium, low)
          
          2. **ìžë™ í•´ê²° ê°€ëŠ¥ì„± ê²€í† **:
             - ì½”ë“œ ìˆ˜ì •ìœ¼ë¡œ í•´ê²° ê°€ëŠ¥í•œ ë¬¸ì œì¸ì§€ íŒë‹¨
             - ì„¤ì • ë³€ê²½ì´ë‚˜ í™˜ê²½ ë³€ìˆ˜ ì¡°ì •ìœ¼ë¡œ í•´ê²° ê°€ëŠ¥í•œì§€ í™•ì¸
             - ë¬¸ì„œ ì—…ë°ì´íŠ¸ë‚˜ ê°€ì´ë“œ ì œê³µìœ¼ë¡œ í•´ê²° ê°€ëŠ¥í•œì§€ ê²€í† 
          
          3. **ì¦‰ì‹œ ì‹¤í–‰ ê°€ëŠ¥í•œ ìž‘ì—…**:
             - ë²„ê·¸ ìˆ˜ì •: ì½”ë“œ ìˆ˜ì • ë° í…ŒìŠ¤íŠ¸
             - ì„¤ì • ë¬¸ì œ: í™˜ê²½ ë³€ìˆ˜ë‚˜ ì„¤ì • íŒŒì¼ ìˆ˜ì •
             - ë¬¸ì„œ ì—…ë°ì´íŠ¸: README.md, CLAUDE.md ë“± ì—…ë°ì´íŠ¸
             - ì˜ì¡´ì„± ë¬¸ì œ: requirements.txt ìˆ˜ì •
          
          4. **ì‘ë‹µ ìƒì„±**:
             - ì´ìŠˆì— ëŒ€í•œ ëª…í™•í•œ ë¶„ì„ ê²°ê³¼
             - í•´ê²° ë°©ë²• ì œì‹œ (ì¦‰ì‹œ ì‹¤í–‰ ë˜ëŠ” ë‹¨ê³„ë³„ ê°€ì´ë“œ)
             - í•„ìš”í•œ ê²½ìš° ì¶”ê°€ ì •ë³´ ìš”ì²­
             - í•œêµ­ì–´ë¡œ ì¹œê·¼í•˜ê³  ì „ë¬¸ì ì¸ ì‘ë‹µ
          
          **íŠ¹ë³„ ì²˜ë¦¬ ê·œì¹™:**
          
          ðŸš¨ **Critical/High Priority**:
          - ì¦‰ì‹œ ì½”ë“œ ìˆ˜ì • ì‹¤í–‰
          - ë°°í¬ íŒŒì´í”„ë¼ì¸ íŠ¸ë¦¬ê±°
          - ìƒì„¸í•œ í•´ê²° ê³¼ì • ë³´ê³ 
          
          ðŸ”§ **Bug Reports**:
          - ìž¬í˜„ ê°€ëŠ¥í•œ ë²„ê·¸ëŠ” ì¦‰ì‹œ ìˆ˜ì •
          - ë¡œê·¸ ë¶„ì„ ë° ì›ì¸ íŒŒì•…
          - í…ŒìŠ¤íŠ¸ ì¼€ì´ìŠ¤ ì¶”ê°€
          
          ðŸ’¡ **Feature Requests**:
          - êµ¬í˜„ ê°€ëŠ¥ì„± í‰ê°€
          - ì•„í‚¤í…ì²˜ ì˜í–¥ë„ ë¶„ì„
          - êµ¬í˜„ ê³„íš ì œì‹œ
          
          â“ **Questions**:
          - ëª…í™•í•˜ê³  ìƒì„¸í•œ ë‹µë³€ ì œê³µ
          - ê´€ë ¨ ë¬¸ì„œë‚˜ ì½”ë“œ ì˜ˆì œ ì œì‹œ
          - ì¶”ê°€ í•™ìŠµ ìžë£Œ ì œê³µ
          
          **í–‰ë™ ì§€ì¹¨:**
          - ê°€ëŠ¥í•œ í•œ ì¦‰ì‹œ í•´ê²°
          - í•´ê²°í•  ìˆ˜ ì—†ëŠ” ê²½ìš° ëª…í™•í•œ ì´ìœ  ì„¤ëª…
          - ëŒ€ì•ˆ ì†”ë£¨ì…˜ ì œì‹œ
          - ì‚¬ìš©ìž ì¹œí™”ì ì¸ í•œêµ­ì–´ ì‘ë‹µ
          - í•„ìš”ì‹œ GitHub ì´ìŠˆì— ì§ì ‘ ëŒ“ê¸€ ìž‘ì„±
          
          ì´ì œ ì´ìŠˆë¥¼ ë¶„ì„í•˜ê³  ì ì ˆí•œ ì²˜ë¦¬ë¥¼ ì‹œìž‘í•´ì£¼ì„¸ìš”.
          EOF
          
      - name: ðŸ“Š Issue Processing Summary
        if: always()
        run: |
          echo "=== ì´ìŠˆ ì²˜ë¦¬ ìš”ì•½ ==="
          echo "ì´ìŠˆ ë²ˆí˜¸: ${{ steps.context.outputs.issue_number }}"
          echo "ì œëª©: ${{ steps.context.outputs.issue_title }}"
          echo "ìš°ì„ ìˆœìœ„: ${{ steps.context.outputs.priority }}"
          echo "ì²˜ë¦¬ ìƒíƒœ: ${{ job.status }}"
          echo "ì²˜ë¦¬ ì‹œê°„: $(date)"
          
          # Create processing summary comment if needed
          if [ "${{ job.status }}" != "success" ]; then
            gh issue comment ${{ steps.context.outputs.issue_number }} \
              --body "ðŸš¨ **ìžë™ ì²˜ë¦¬ ì‹¤íŒ¨**

              ì´ìŠˆ ìžë™ ì²˜ë¦¬ ì¤‘ ë¬¸ì œê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. 
              ìˆ˜ë™ ê²€í† ê°€ í•„ìš”í•©ë‹ˆë‹¤.
              
              **ì²˜ë¦¬ ì‹œê°„**: $(date)
              **ìƒíƒœ**: ${{ job.status }}
              
              @claude ë‹¤ì‹œ ì‹œë„í•˜ê±°ë‚˜ ê´€ë¦¬ìžì—ê²Œ ë¬¸ì˜í•´ì£¼ì„¸ìš”."
          fi