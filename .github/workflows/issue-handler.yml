name: ğŸ¯ Issue Handler

concurrency:
  group: issue-handler-${{ github.event.issue.number || github.run_id }}
  cancel-in-progress: true

on:
  issues:
    types: [opened, labeled, assigned]
  issue_comment:
    types: [created]

permissions:
  contents: read
  issues: write
  pull-requests: read
  id-token: write

jobs:
  handle-issue:
    if: |
      (github.event_name == 'issues' && (
        contains(github.event.issue.body, '@claude') || 
        contains(github.event.issue.title, '@claude') ||
        contains(github.event.issue.labels.*.name, 'claude-actionable') ||
        contains(github.event.issue.labels.*.name, 'needs-analysis')
      )) ||
      (github.event_name == 'issue_comment' && contains(github.event.comment.body, '@claude'))
    
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    steps:
      - name: ğŸ”— Checkout Repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0
          
      - name: ğŸ” Context Analysis
        id: context
        run: |
          echo "issue_number=${{ github.event.issue.number || 'N/A' }}" >> $GITHUB_OUTPUT
          echo "issue_title=${{ github.event.issue.title || 'N/A' }}" >> $GITHUB_OUTPUT
          echo "issue_author=${{ github.event.issue.user.login || 'N/A' }}" >> $GITHUB_OUTPUT
          echo "event_type=${{ github.event_name }}" >> $GITHUB_OUTPUT
          echo "repository=SafeWork Flask Application" >> $GITHUB_OUTPUT
          echo "architecture=Independent containers (PostgreSQL, Redis, Flask)" >> $GITHUB_OUTPUT
          
          # Extract issue labels
          LABELS="${{ join(github.event.issue.labels.*.name, ',') }}"
          echo "issue_labels=$LABELS" >> $GITHUB_OUTPUT
          
          # Determine issue priority and type
          if [[ "$LABELS" == *"critical"* ]]; then
            echo "priority=critical" >> $GITHUB_OUTPUT
          elif [[ "$LABELS" == *"high"* ]]; then
            echo "priority=high" >> $GITHUB_OUTPUT
          elif [[ "$LABELS" == *"bug"* ]]; then
            echo "priority=high" >> $GITHUB_OUTPUT
          else
            echo "priority=normal" >> $GITHUB_OUTPUT
          fi
          
      - name: ğŸ¯ Claude Issue Triage & Analysis
        uses: anthropics/claude-code-action@v1
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          anthropic_api_key: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          trigger_phrase: ""  # Always run for qualified issues
          prompt: |
            /label-issue ISSUE_NUMBER: ${{ github.event.issue.number || 'N/A' }}
            
            ğŸ¯ **SafeWork ì´ìŠˆ ìë™ íŠ¸ë¦¬ì•„ì§€ ë° ë¶„ì„**
            
            **ì´ìŠˆ ì •ë³´:**
            - ì œëª©: "${{ github.event.issue.title || 'N/A' }}"  
            - ì‘ì„±ì: ${{ github.event.issue.user.login || 'N/A' }}
            - í˜„ì¬ ë¼ë²¨: ${{ join(github.event.issue.labels.*.name, ', ') }}
            
            **ì´ìŠˆ ë‚´ìš©:**
            ```
            ${{ github.event.issue.body || github.event.comment.body }}
            ```
            
            **ì‘ì—… ì§€ì‹œ:**
            1. ì´ìŠˆë¥¼ ë¶„ì„í•˜ê³  ì ì ˆí•œ ë¼ë²¨ ìë™ í• ë‹¹
            2. ìš°ì„ ìˆœìœ„ ê²°ì • (critical/high/medium/low)
            3. ê°€ëŠ¥í•œ ê²½ìš° ì¦‰ì‹œ í•´ê²° ì‹œë„
            4. í•œêµ­ì–´ë¡œ ë¶„ì„ ê²°ê³¼ ë° í•´ê²° ë°©ì•ˆ ì œì‹œ
            5. ì¶”ê°€ ì •ë³´ í•„ìš” ì‹œ ì§ˆë¬¸ ìƒì„±
          
      - name: ğŸ“Š Issue Processing Summary
        if: always()
        run: |
          echo "=== ì´ìŠˆ ì²˜ë¦¬ ìš”ì•½ ==="
          echo "ì´ìŠˆ ë²ˆí˜¸: ${{ steps.context.outputs.issue_number }}"
          echo "ì œëª©: ${{ steps.context.outputs.issue_title }}"
          echo "ìš°ì„ ìˆœìœ„: ${{ steps.context.outputs.priority }}"
          echo "ì²˜ë¦¬ ìƒíƒœ: ${{ job.status }}"
          echo "ì²˜ë¦¬ ì‹œê°„: $(date)"
          
          # Create processing summary comment if needed
          if [ "${{ job.status }}" != "success" ]; then
            gh issue comment ${{ steps.context.outputs.issue_number }} \
              --body "ğŸš¨ **ìë™ ì²˜ë¦¬ ì‹¤íŒ¨**

              ì´ìŠˆ ìë™ ì²˜ë¦¬ ì¤‘ ë¬¸ì œê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. 
              ìˆ˜ë™ ê²€í† ê°€ í•„ìš”í•©ë‹ˆë‹¤.
              
              **ì²˜ë¦¬ ì‹œê°„**: $(date)
              **ìƒíƒœ**: ${{ job.status }}
              
              @claude ë‹¤ì‹œ ì‹œë„í•˜ê±°ë‚˜ ê´€ë¦¬ìì—ê²Œ ë¬¸ì˜í•´ì£¼ì„¸ìš”."
          fi