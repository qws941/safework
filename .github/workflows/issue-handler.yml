name: 🤖 Issue Handler

on:
  issues:
    types: [opened, edited, labeled, assigned]
  issue_comment:
    types: [created, edited]
  workflow_dispatch:
    inputs:
      issue_number:
        description: 'Issue number to process'
        required: true
        type: number
      action_type:
        description: 'Action to perform'
        required: false
        default: 'analyze'
        type: choice
        options:
          - 'analyze'
          - 'auto-fix'
          - 'prioritize'
          - 'close'

permissions:
  contents: write
  issues: write
  pull-requests: write
  actions: read

jobs:
  issue-processor:
    name: 🔍 Issue Processing
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    steps:
      - name: 📥 Checkout repository
        uses: actions/checkout@v4

      - name: 🤖 Claude Code Issue Analysis
        uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          track_progress: true
          prompt: |
            Please analyze and process SafeWork GitHub Issues.

            **Issue Information:**
            - Repository: ${{ github.repository }}
            - Issue Number: ${{ github.event.issue.number || inputs.issue_number }}
            - Title: "${{ github.event.issue.title }}"
            - Author: ${{ github.event.issue.user.login }}
            - Action: ${{ inputs.action_type || 'analyze' }}

            **Processing Methods:**
            1. **analyze**: Issue classification and initial analysis, label assignment
            2. **auto-fix**: Automatic fixes and PR creation when possible
            3. **prioritize**: Priority evaluation and milestone assignment
            4. **close**: Issue resolution status check and closure

            **SafeWork Project Context:**
            - Flask 3.0+ Industrial Health and Safety Management System
            - Independent container deployment (MySQL, Redis, App)
            - No docker-compose dependency - Dockerfile-based configuration
            - Watchtower automatic updates support
            - Core features: Survey system, MSDS management, safety education, health checkups

            **Auto-processable Issue Types:**
            - Configuration file modifications (environment variables, Docker settings)
            - Dependency updates (requirements.txt)
            - Documentation improvements (README, guides)
            - Simple bug fixes (typos, link corrections)

            **Issue Label Classifications:**
            - `bug`: Bug reports
            - `feature`: New feature requests
            - `security`: Security-related issues
            - `performance`: Performance improvements
            - `documentation`: Documentation-related
            - `enhancement`: Existing feature improvements
            - `good-first-issue`: Beginner-friendly

            **Response Language:** Please respond in Korean and add GitHub Issue comments when necessary.
          claude_args: |
            --temperature 0.1
            --allowedTools "mcp__serena__*,mcp__github__*,mcp__sequential-thinking__*,mcp__memory__*"
            --systemPrompt "SafeWork 프로젝트 이슈 관리 전문가. GitHub Issues를 분석하여 자동으로 분류, 라벨링, 우선순위 설정을 하고 가능한 경우 자동 수정까지 수행합니다."

  security-escalation:
    name: 🔒 Security Issue Escalation
    runs-on: ubuntu-latest
    if: contains(github.event.issue.labels.*.name, 'security') || contains(github.event.issue.title, 'security') || contains(github.event.issue.title, 'vulnerability')
    
    steps:
      - name: 🚨 Security Alert
        uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          track_progress: true
          prompt: |
            🚨 **SafeWork Security Issue Emergency Analysis**
            
            ISSUE_NUMBER: ${{ github.event.issue.number }}
            ISSUE_TITLE: "${{ github.event.issue.title }}"
            ISSUE_AUTHOR: ${{ github.event.issue.user.login }}
            
            A security issue has been reported in the SafeWork system.
            Please immediately analyze security impact and provide response measures.
            
            **Security Analysis Items:**
            1. Security impact and severity assessment
            2. Identify affected system components
            3. Immediate mitigation measures
            4. Long-term security improvement plans
            
            Please provide detailed security analysis and response plan in Korean.
          claude_args: |
            --temperature 0.1
            --allowedTools "mcp__serena__*,mcp__sequential-thinking__*,mcp__github__*,mcp__memory__*"