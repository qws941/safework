name: ğŸ¤– Automated Issue Handler

on:
  issues:
    types: [opened, edited, labeled]
  issue_comment:
    types: [created]
  workflow_dispatch:
    inputs:
      issue_number:
        description: 'Issue number to analyze'
        required: true
        type: number

permissions:
  contents: read
  issues: write
  pull-requests: write

jobs:
  issue-analysis:
    name: ğŸ” Issue Analysis & Auto-Response
    runs-on: ubuntu-latest
    if: github.event_name == 'issues' || github.event_name == 'issue_comment' || github.event_name == 'workflow_dispatch'
    
    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ğŸ¤– SafeWork Issue Analysis
        uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          track_progress: true
          prompt: |
            ğŸ¤– **SafeWork Issue Analysis System**
            
            REPOSITORY: ${{ github.repository }}
            ISSUE_NUMBER: ${{ github.event.issue.number || github.event.inputs.issue_number }}
            ISSUE_TITLE: "${{ github.event.issue.title }}"
            ISSUE_BODY: "${{ github.event.issue.body }}"
            ISSUE_AUTHOR: ${{ github.event.issue.user.login }}
            
            SafeWork ì‚°ì—…ì•ˆì „ë³´ê±´ ê´€ë¦¬ ì‹œìŠ¤í…œì˜ GitHub ì´ìŠˆë¥¼ ë¶„ì„í•˜ê³  ìë™ ì‘ë‹µì„ ì œê³µí•´ì£¼ì„¸ìš”.
            
            **í”„ë¡œì íŠ¸ ì»¨í…ìŠ¤íŠ¸:**
            - SafeWork: Flask 3.0+ ê¸°ë°˜ ì‚°ì—…ì•ˆì „ë³´ê±´ ê´€ë¦¬ ì‹œìŠ¤í…œ
            - ê¸°ìˆ  ìŠ¤íƒ: Python Flask, MySQL 8.0, Redis, Docker
            - ì£¼ìš” ê¸°ëŠ¥: ì„¤ë¬¸ ì‹œìŠ¤í…œ, MSDS ê´€ë¦¬, ì•ˆì „ êµìœ¡, ê±´ê°• ê²€ì§„
            - ë°°í¬: Docker Registry (registry.jclee.me), Watchtower ìë™ ë°°í¬
            
            **ë¶„ì„ ë° ì‘ë‹µ:**
            1. ì´ìŠˆ ìœ í˜• ë¶„ë¥˜ (ë²„ê·¸, ê¸°ëŠ¥ ìš”ì²­, ë³´ì•ˆ, ì„±ëŠ¥)
            2. ê´€ë ¨ ì½”ë“œ ë° ì‹œìŠ¤í…œ ì»´í¬ë„ŒíŠ¸ ì‹ë³„
            3. í•´ê²° ë°©ì•ˆ ë° ì›Œí¬ì–´ë¼ìš´ë“œ ì œì‹œ
            4. ì ì ˆí•œ ë¼ë²¨ ë° ìš°ì„ ìˆœìœ„ ì„¤ì •
            
            **ì‘ë‹µ ì–¸ì–´:** í•œêµ­ì–´ë¡œ ë‹µë³€í•´ì£¼ì„¸ìš”.
          claude_args: |
            --model claude-sonnet-4-20250514
            --maxTokens 4096
            --temperature 0.1
            --allowedTools "mcp__serena__*,mcp__github__*,mcp__sequential-thinking__*"
            --systemPrompt "SafeWork Flask ì• í”Œë¦¬ì¼€ì´ì…˜ ì „ë¬¸ê°€. ì‚°ì—…ì•ˆì „ë³´ê±´ ë„ë©”ì¸ ì§€ì‹ê³¼ ê¸°ìˆ  ì „ë¬¸ì„±ì„ ë°”íƒ•ìœ¼ë¡œ ì‹¤ìš©ì ì¸ ì†”ë£¨ì…˜ì„ ì œê³µí•©ë‹ˆë‹¤."

  security-escalation:
    name: ğŸ”’ Security Issue Escalation
    runs-on: ubuntu-latest
    if: contains(github.event.issue.labels.*.name, 'security') || contains(github.event.issue.title, 'security') || contains(github.event.issue.title, 'vulnerability')
    
    steps:
      - name: ğŸš¨ Security Alert
        uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          track_progress: true
          prompt: |
            ğŸš¨ **SafeWork ë³´ì•ˆ ì´ìŠˆ ê¸´ê¸‰ ë¶„ì„**
            
            ISSUE_NUMBER: ${{ github.event.issue.number }}
            ISSUE_TITLE: "${{ github.event.issue.title }}"
            ISSUE_AUTHOR: ${{ github.event.issue.user.login }}
            
            SafeWork ì‹œìŠ¤í…œì˜ ë³´ì•ˆ ì´ìŠˆê°€ ë³´ê³ ë˜ì—ˆìŠµë‹ˆë‹¤.
            ì¦‰ì‹œ ë³´ì•ˆ ì˜í–¥ë„ë¥¼ ë¶„ì„í•˜ê³  ëŒ€ì‘ ë°©ì•ˆì„ ì œì‹œí•´ì£¼ì„¸ìš”.
            
            **ë³´ì•ˆ ë¶„ì„ í•­ëª©:**
            1. ë³´ì•ˆ ì˜í–¥ë„ ë° ì‹¬ê°ë„ í‰ê°€
            2. ì˜í–¥ë°›ëŠ” ì‹œìŠ¤í…œ ì»´í¬ë„ŒíŠ¸ ì‹ë³„
            3. ì¦‰ì‹œ ì™„í™” ì¡°ì¹˜ ë°©ì•ˆ
            4. ì¥ê¸° ë³´ì•ˆ ê°œì„  ë°©ì•ˆ
            
            í•œêµ­ì–´ë¡œ ìƒì„¸í•œ ë³´ì•ˆ ë¶„ì„ ë° ëŒ€ì‘ ê³„íšì„ ì œê³µí•´ì£¼ì„¸ìš”.
          claude_args: |
            --model claude-sonnet-4-20250514
            --maxTokens 4096
            --temperature 0.1
            --allowedTools "mcp__shrimp-task-manager__*,mcp__sequential-thinking__*,mcp__github__*"