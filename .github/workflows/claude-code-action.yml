name: SafeWork Claude AI

on:
  issues:
    types: [opened, edited, reopened]
  issue_comment:
    types: [created]
  pull_request:
    types: [opened, edited, synchronize, reopened]
  pull_request_review:
    types: [submitted]
  workflow_dispatch:
    inputs:
      issue_number:
        description: 'Issue number to process'
        required: false
        type: string
      pr_number:
        description: 'Pull request number to process'  
        required: false
        type: string

permissions:
  contents: write
  issues: write
  pull-requests: write
  actions: read
  checks: read
  discussions: read
  repository-projects: read
  id-token: write

jobs:
  claude-ai-automation:
    runs-on: ubuntu-latest
    timeout-minutes: 25
    
    # Advanced conditions for intelligent triggering
    if: |
      (github.event_name == 'issues' && 
       (github.event.action == 'opened' || 
        github.event.action == 'edited' || 
        github.event.action == 'reopened')) ||
      (github.event_name == 'issue_comment' && 
       github.event.action == 'created' && 
       (contains(github.event.comment.body, '@claude') || 
        contains(github.event.comment.body, 'claude'))) ||
      (github.event_name == 'pull_request' && 
       (github.event.action == 'opened' || 
        github.event.action == 'edited' || 
        github.event.action == 'synchronize' || 
        github.event.action == 'reopened')) ||
      (github.event_name == 'pull_request_review' && 
       github.event.action == 'submitted') ||
      github.event_name == 'workflow_dispatch'
    
    steps:
      - name: Debug Event Information
        run: |
          echo "🔍 Event debugging information:"
          echo "Event name: ${{ github.event_name }}"
          echo "Action: ${{ github.event.action }}"
          echo "Repository: ${{ github.repository }}"
          echo "Actor: ${{ github.actor }}"
          
          if [ "${{ github.event_name }}" = "issues" ]; then
            echo "Issue number: ${{ github.event.issue.number }}"
            echo "Issue title: ${{ github.event.issue.title }}"
            echo "Issue author: ${{ github.event.issue.user.login }}"
          elif [ "${{ github.event_name }}" = "issue_comment" ]; then
            echo "Issue number: ${{ github.event.issue.number }}"
            echo "Comment author: ${{ github.event.comment.user.login }}"
            echo "Comment contains @claude: $(echo '${{ github.event.comment.body }}' | grep -q '@claude' && echo 'yes' || echo 'no')"
          elif [ "${{ github.event_name }}" = "pull_request" ]; then
            echo "PR number: ${{ github.event.pull_request.number }}"
            echo "PR title: ${{ github.event.pull_request.title }}"
            echo "PR author: ${{ github.event.pull_request.user.login }}"
          elif [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "Manual trigger"
            echo "Issue number: ${{ github.event.inputs.issue_number }}"
            echo "PR number: ${{ github.event.inputs.pr_number }}"
          fi

      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: SafeWork Context Analysis & Prompt Selection
        id: context
        run: |
          echo "🧠 SafeWork context analysis..."
          
          # Initialize variables
          context_type="general"
          domain_context=""
          korean_context=""
          
          # Extract content for analysis
          if [ "${{ github.event_name }}" = "issues" ]; then
            title="${{ github.event.issue.title }}"
            body="${{ github.event.issue.body }}"
            content="$title $body"
          elif [ "${{ github.event_name }}" = "issue_comment" ]; then
            comment="${{ github.event.comment.body }}"
            issue_title="${{ github.event.issue.title }}"
            content="$comment $issue_title"
          elif [ "${{ github.event_name }}" = "pull_request" ]; then
            pr_title="${{ github.event.pull_request.title }}"
            pr_body="${{ github.event.pull_request.body }}"
            content="$pr_title $pr_body"
            context_type="pull_request"
          fi
          
          # SafeWork domain detection
          if echo "$content" | grep -qi -E "(설문|survey|001|002|근골격|musculoskeletal)"; then
            domain_context="survey_system"
          elif echo "$content" | grep -qi -E "(관리자|admin|safework|dashboard)"; then
            domain_context="admin_system"
          elif echo "$content" | grep -qi -E "(의료|health|medical|검진|medication)"; then
            domain_context="medical_system"
          elif echo "$content" | grep -qi -E "(문서|document|upload|download)"; then
            domain_context="document_system"
          elif echo "$content" | grep -qi -E "(api|연동|integration)"; then
            domain_context="api_system"
          elif echo "$content" | grep -qi -E "(인증|auth|login|password)"; then
            domain_context="auth_system"
          elif echo "$content" | grep -qi -E "(배포|deploy|docker|watchtower)"; then
            domain_context="deployment_system"
          fi
          
          # Korean language detection
          if echo "$content" | grep -q '[가-힣]'; then
            korean_context="detected"
          fi
          
          echo "context_type=$context_type" >> $GITHUB_OUTPUT
          echo "domain_context=$domain_context" >> $GITHUB_OUTPUT
          echo "korean_context=$korean_context" >> $GITHUB_OUTPUT
          
          echo "📋 Context analysis results:"
          echo "  - Type: $context_type"
          echo "  - Domain: $domain_context"
          echo "  - Korean: $korean_context"

      - name: Advanced Claude Code Action with Domain Intelligence
        uses: anthropics/claude-code-action@v1
        with:
          # Authentication using OAuth token
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          github_token: ${{ secrets.GITHUB_TOKEN }}
          
          # Advanced configuration
          track_progress: ${{ github.event_name != 'workflow_dispatch' }}
          use_sticky_comment: true
          use_commit_signing: false
          
          # Dynamic prompts based on context
          prompt: |
            You are Claude, an AI assistant specialized in SafeWork industrial health & safety management system.
            
            ## System Context
            SafeWork is a Flask 3.0+ application managing Korean workplace health surveys, medical checkups, and safety administration.
            
            **Core Components:**
            - Survey System: 001 (musculoskeletal), 002 (new employee health)
            - SafeWork Admin: 13 specialized panels (workers, health checks, medications, etc.)
            - Document Management: Version control, access logging
            - API v2: RESTful endpoints for external integrations
            - Database: MySQL 8.0 UTF8MB4, Redis 5.0 caching
            - Deployment: Docker + Watchtower on registry.jclee.me
            
            **Domain Context Detected:** ${{ steps.context.outputs.domain_context }}
            **Event Type:** ${{ github.event_name }}
            **Korean Language:** ${{ steps.context.outputs.korean_context }}
            
            ## Specialized Instructions by Domain
            
            ### Survey System (001/002)
            - Focus on form validation, conditional logic (JavaScript), Korean UI
            - Body parts: 16 regions with pain scale (1-5)
            - Anonymous submissions supported (user_id=1)
            - MySQL KST timezone handling
            
            ### Admin System  
            - 13 SafeWork panels: workers, health_checks, medical_visits, medications, consultations, health_programs, special_management, environment_measurements, risk_assessment, msds, protective_equipment, education, certifications
            - Bootstrap 4.6 UI, jQuery AJAX, CSRF protection
            - Pagination (20 items/page), audit logging
            
            ### Medical System
            - PHI (Personal Health Information) compliance
            - Medication expiry tracking, dosage management  
            - Integration with health checkup workflows
            
            ### Document System
            - Version control, access logs, category management
            - Public/private/admin permissions
            - File upload security, Korean filename support
            
            ### API System
            - RESTful v2 endpoints: /api/safework/v2/*
            - CRUD operations for all SafeWork entities
            - JSON responses, proper HTTP status codes
            
            ### Auth System
            - Flask-Login integration, session management
            - @login_required decorators, role-based access
            - Password security, rate limiting
            
            ### Deployment System
            - Docker multi-platform builds (amd64/arm64)
            - Watchtower automatic updates
            - GitHub Actions → registry.jclee.me → production
            
            ## Task Priority Rules
            1. **Critical Issues**: Security, PHI leaks, service outages
            2. **High Priority**: Survey submission errors, admin panel failures  
            3. **Medium Priority**: UI improvements, performance optimization
            4. **Low Priority**: Documentation, code refactoring
            
            ## Response Guidelines
            - Use Korean for user communication when Korean content detected
            - Provide specific file paths (e.g., `app/routes/admin.py:123`)
            - Include deployment considerations for production changes
            - Reference SafeWork domain expertise in solutions
            - Always test solutions against MySQL 8.0 UTF8MB4 compatibility
            
            ## Current Task Analysis
            Please analyze the current GitHub event and provide appropriate assistance based on the SafeWork domain context detected above.

      - name: Post-Processing & Slack Notification
        if: always()
        run: |
          echo "🎯 Claude Code Action completed"
          echo "Event: ${{ github.event_name }}"
          echo "Context: ${{ steps.context.outputs.domain_context }}"
          echo "Status: ${{ job.status }}"
          
          # Slack notification
          if [ "${{ job.status }}" = "success" ]; then
            STATUS_EMOJI="✅"
            STATUS_TEXT="successful"
            COLOR="good"
            echo "✅ SafeWork AI automation successful"
          else
            STATUS_EMOJI="⚠️"
            STATUS_TEXT="completed with issues"
            COLOR="warning"
            echo "⚠️ SafeWork AI automation completed with issues"
          fi
          
          # Prepare Slack message
          SLACK_MESSAGE="{
            \"attachments\": [{
              \"color\": \"$COLOR\",
              \"title\": \"$STATUS_EMOJI SafeWork Claude AI - $STATUS_TEXT\",
              \"fields\": [
                {\"title\": \"Event\", \"value\": \"${{ github.event_name }}\", \"short\": true},
                {\"title\": \"Context\", \"value\": \"${{ steps.context.outputs.domain_context }}\", \"short\": true},
                {\"title\": \"Repository\", \"value\": \"${{ github.repository }}\", \"short\": true},
                {\"title\": \"Actor\", \"value\": \"${{ github.actor }}\", \"short\": true}
              ],
              \"footer\": \"SafeWork Automation\",
              \"ts\": $(date +%s)
            }]
          }"
          
          # Send to Slack using OAuth Token
          curl -X POST \
            -H "Authorization: Bearer ${{ secrets.SLACK_BOT_TOKEN }}" \
            -H "Content-type: application/json" \
            --data "{
              \"channel\": \"#safework-alerts\",
              \"text\": \"$STATUS_EMOJI SafeWork Claude AI - $STATUS_TEXT\",
              \"attachments\": [{
                \"color\": \"$COLOR\",
                \"title\": \"SafeWork Automation Report\",
                \"fields\": [
                  {\"title\": \"Event\", \"value\": \"${{ github.event_name }}\", \"short\": true},
                  {\"title\": \"Context\", \"value\": \"${{ steps.context.outputs.domain_context }}\", \"short\": true},
                  {\"title\": \"Repository\", \"value\": \"${{ github.repository }}\", \"short\": true},
                  {\"title\": \"Actor\", \"value\": \"${{ github.actor }}\", \"short\": true}
                ],
                \"footer\": \"SafeWork Automation\",
                \"ts\": $(date +%s)
              }]
            }" \
https://slack.com/api/chat.postMessage
          
          # Trigger deployment workflow if changes were made
          if [ "${{ job.status }}" = "success" ] && [ "${{ github.event_name }}" != "pull_request" ]; then
            echo "🚀 Changes detected - deployment pipeline will be triggered"
          fi

  # Parallel job for urgent issue handling
  urgent-issue-handler:
    runs-on: ubuntu-latest
    timeout-minutes: 5
    if: |
      github.event_name == 'issues' && 
      github.event.action == 'opened' &&
      (contains(github.event.issue.title, '긴급') || 
       contains(github.event.issue.title, 'urgent') ||
       contains(github.event.issue.title, 'critical') ||
       contains(github.event.issue.body, '중단') ||
       contains(github.event.issue.body, '작동 안'))
    
    steps:
      - name: Urgent Issue Alert & Slack Notification
        uses: actions/github-script@v7
        with:
          script: |
            console.log("🚨 Urgent SafeWork issue detected!");
            
            const issue = context.payload.issue;
            
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issue.number,
              labels: ['urgent', 'priority-high', 'safework']
            });
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issue.number,
              body: `🚨 **Urgent SafeWork Issue Detected**
              
              This issue has been automatically flagged as urgent and will be processed immediately.
              
              **Estimated Response Time:** < 5 minutes
              **Priority Level:** P0-CRITICAL
              **Domain:** SafeWork Industrial Safety System
              
              The main Claude AI workflow will process this issue with high priority.
              
              ---
              🤖 *SafeWork Urgent Issue Handler*`
            });
            
            // Send Slack notification for urgent issues
            const slackMessage = {
                "color": "danger",
                "title": "🚨 URGENT: SafeWork Issue Detected",
                "text": `*Issue #${issue.number}*: ${issue.title}`,
                "fields": [
                  {"title": "Priority", "value": "P0-CRITICAL", "short": true},
                  {"title": "Author", "value": issue.user.login, "short": true},
                  {"title": "URL", "value": issue.html_url, "short": false}
                ],
                "footer": "SafeWork Urgent Alert System",
                "ts": Math.floor(Date.now() / 1000)
              }]
            };
            
            await fetch('https://slack.com/api/chat.postMessage', {
              method: 'POST',
              headers: {
                'Authorization': 'Bearer ${{ secrets.SLACK_BOT_TOKEN }}',
                'Content-Type': 'application/json'
              },
              body: JSON.stringify({
                channel: "#safework-alerts",
                text: `🚨 URGENT: SafeWork Issue #${issue.number}`,
                attachments: [{
                  color: "danger",
                  title: "🚨 URGENT: SafeWork Issue Detected",
                  text: `*Issue #${issue.number}*: ${issue.title}`,
                  fields: [
                    {"title": "Priority", "value": "P0-CRITICAL", "short": true},
                    {"title": "Author", "value": issue.user.login, "short": true},
                    {"title": "URL", "value": issue.html_url, "short": false}
                  ],
                  footer: "SafeWork Urgent Alert System",
                  ts: Math.floor(Date.now() / 1000)
                }]
              })
            });