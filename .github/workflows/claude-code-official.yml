name: Claude Code - SafeWork ê³ ë„í™” ìë™í™” v2.0

on:
  # ì´ìŠˆ ê´€ë ¨ íŠ¸ë¦¬ê±°
  issues:
    types: [opened, edited, labeled]
  issue_comment:
    types: [created]
  
  # PR ê´€ë ¨ íŠ¸ë¦¬ê±°
  pull_request:
    types: [opened, edited, ready_for_review]
  pull_request_review_comment:
    types: [created]
  
  # ìŠ¤ì¼€ì¤„ íŠ¸ë¦¬ê±° (ë§¤ì¼ ì˜¤ì „ 9ì‹œ KST)
  schedule:
    - cron: '0 0 * * *'  # UTC 00:00 = KST 09:00
  
  # ìˆ˜ë™ íŠ¸ë¦¬ê±°
  workflow_dispatch:
    inputs:
      issue_number:
        description: 'ì²˜ë¦¬í•  ì´ìŠˆ ë²ˆí˜¸ (ì„ íƒì‚¬í•­)'
        required: false
        type: string
      action:
        description: 'ìˆ˜í–‰í•  ì‘ì—…'
        required: true
        type: choice
        options:
          - auto-fix-all
          - security-audit
          - performance-optimize
          - code-cleanup

permissions:
  actions: write
  checks: write
  contents: write
  deployments: write
  id-token: write
  issues: write
  discussions: write
  packages: write
  pages: write
  pull-requests: write
  repository-projects: write
  security-events: write
  statuses: write

jobs:
  # ì´ìŠˆ ìë™ ë¶„ë¥˜ ë° ë¼ë²¨ë§
  auto-label:
    if: github.event_name == 'issues' && github.event.action == 'opened'
    runs-on: ubuntu-latest
    steps:
      - name: ì´ìŠˆ ìë™ ë¶„ë¥˜
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const issue = context.payload.issue;
            const labels = [];
            
            // ì œëª©/ë³¸ë¬¸ ê¸°ë°˜ ìë™ ë¼ë²¨ë§
            const content = (issue.title + ' ' + issue.body).toLowerCase();
            
            if (content.includes('ë²„ê·¸') || content.includes('bug') || content.includes('ì˜¤ë¥˜') || content.includes('error')) {
              labels.push('bug');
            }
            if (content.includes('ê¸°ëŠ¥') || content.includes('feature') || content.includes('ì¶”ê°€')) {
              labels.push('enhancement');
            }
            if (content.includes('ê¸´ê¸‰') || content.includes('urgent') || content.includes('asap')) {
              labels.push('P0-urgent');
            }
            if (content.includes('ë³´ì•ˆ') || content.includes('security')) {
              labels.push('security');
            }
            if (content.includes('ì„±ëŠ¥') || content.includes('performance')) {
              labels.push('performance');
            }
            if (content.includes('ë¬¸ì„œ') || content.includes('documentation')) {
              labels.push('documentation');
            }
            
            // ê¸°ë³¸ ë¼ë²¨ ì¶”ê°€
            if (labels.length === 0) {
              labels.push('needs-triage');
            }
            
            // Claude ì²˜ë¦¬ ëŒ€ìƒ ë¼ë²¨ ì¶”ê°€
            labels.push('claude-ready');
            
            // ë¼ë²¨ ì ìš©
            if (labels.length > 0) {
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                labels: labels
              });
            }
            
            // ìë™ ì½”ë©˜íŠ¸
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issue.number,
              body: `ğŸ¤– **ìë™ ë¶„ë¥˜ ì™„ë£Œ**\n\nì ìš©ëœ ë¼ë²¨: ${labels.map(l => '`' + l + '`').join(', ')}\n\nì´ ì´ìŠˆëŠ” Claude Codeì— ì˜í•´ ìë™ìœ¼ë¡œ ì²˜ë¦¬ë  ì˜ˆì •ì…ë‹ˆë‹¤.\nìš°ì„ ìˆœìœ„ê°€ ë†’ì€ ê²½ìš° \`@claude\`ë¥¼ ë©˜ì…˜í•˜ì—¬ ì¦‰ì‹œ ì²˜ë¦¬ë¥¼ ìš”ì²­í•˜ì„¸ìš”.`
            });

  # Claude Code ë©”ì¸ ì²˜ë¦¬
  claude-processor:
    if: |
      github.event_name == 'workflow_dispatch' ||
      github.event_name == 'schedule' ||
      (github.event_name == 'issues' && contains(github.event.issue.labels.*.name, 'claude-ready')) ||
      (github.event_name == 'issue_comment' && contains(github.event.comment.body, '@claude')) ||
      (github.event_name == 'pull_request_review_comment' && contains(github.event.comment.body, '@claude'))
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0
          persist-credentials: true

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          
      - name: Install dependencies
        run: |
          pip install pytest pytest-cov black flake8
          if [ -f app/requirements.txt ]; then
            pip install -r app/requirements.txt
          fi

      - name: ì´ìŠˆ ì»¨í…ìŠ¤íŠ¸ ìˆ˜ì§‘
        id: context
        run: |
          echo "timestamp=$(date +'%Y%m%d_%H%M%S')" >> $GITHUB_OUTPUT
          echo "branch_name=claude/auto-fix-$(date +'%Y%m%d_%H%M%S')" >> $GITHUB_OUTPUT
          
          # ì´ìŠˆ ì •ë³´ ìˆ˜ì§‘
          if [[ "${{ github.event_name }}" == "issues" ]] || [[ "${{ github.event_name }}" == "issue_comment" ]]; then
            echo "issue_number=${{ github.event.issue.number }}" >> $GITHUB_OUTPUT
            echo "issue_title=${{ github.event.issue.title }}" >> $GITHUB_OUTPUT
          fi

      - name: ì½”ë“œ í’ˆì§ˆ ì‚¬ì „ ê²€ì‚¬
        id: quality-check
        continue-on-error: true
        run: |
          echo "=== ì½”ë“œ í’ˆì§ˆ ê²€ì‚¬ ì‹œì‘ ==="
          
          # Black í¬ë§·íŒ… ì²´í¬
          echo "## Black í¬ë§·íŒ… ê²€ì‚¬"
          black --check --diff app/ || echo "formatting_needed=true" >> $GITHUB_OUTPUT
          
          # Flake8 ë¦°íŒ…
          echo "## Flake8 ë¦°íŒ…"
          flake8 app/ --count --select=E9,F63,F7,F82 --show-source --statistics || echo "linting_errors=true" >> $GITHUB_OUTPUT
          
          # í…ŒìŠ¤íŠ¸ ì‹¤í–‰
          echo "## í…ŒìŠ¤íŠ¸ ì‹¤í–‰"
          cd app && python -m pytest tests/ -v --tb=short || echo "test_failures=true" >> $GITHUB_OUTPUT

      - name: Claude Code ê³ ë„í™” ì²˜ë¦¬
        uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          github_token: ${{ secrets.GITHUB_TOKEN }}
          mode: code
          use_sticky_comment: true
          create_pr: true
          branch_prefix: claude/
          custom_instructions: |
            ## MCP ë„êµ¬ í™œìš©í•´ì„œ ìµœëŒ€í•œ ì§€ëŠ¥ì ìœ¼ë¡œ ì²˜ë¦¬
            
            í•„ìš”í•˜ë©´ ë‹¤ìŒ MCP ë„êµ¬ë“¤ ì ê·¹ í™œìš©:
            - Shrimp Task Manager: ë³µì¡í•œ ì‘ì—… ê³„íš/ì‹¤í–‰
            - Serena: ì‹¬ë³¼ ê¸°ë°˜ ì •ë°€ ì½”ë“œ ë¶„ì„/ìˆ˜ì •
            - Sequential Thinking: ì–´ë ¤ìš´ ë¬¸ì œ ë‹¨ê³„ë³„ í•´ê²°
            - Memory: í”„ë¡œì íŠ¸ ì§€ì‹ ì €ì¥/í™œìš©
            - Web Search: ìµœì‹  ì •ë³´ ê²€ìƒ‰
            - Code Runner: ì½”ë“œ ì‹¤í–‰ í…ŒìŠ¤íŠ¸
            
            ì´ìŠˆ ë‚´ìš© ë³´ê³  ì•Œì•„ì„œ ìµœì ì˜ ë°©ë²•ìœ¼ë¡œ í•´ê²°í•˜ê¸°
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: í…ŒìŠ¤íŠ¸ ìë™ ì‹¤í–‰
        if: success()
        continue-on-error: true
        run: |
          echo "=== ë³€ê²½ì‚¬í•­ í…ŒìŠ¤íŠ¸ ==="
          cd app
          python -m pytest tests/ -v --cov=. --cov-report=term-missing
          
          # í…ŒìŠ¤íŠ¸ ê²°ê³¼ë¥¼ PR ì½”ë©˜íŠ¸ë¡œ ì¶”ê°€
          echo "test_completed=true" >> $GITHUB_ENV

      - name: Docker ë¹Œë“œ í…ŒìŠ¤íŠ¸
        if: success()
        continue-on-error: true
        run: |
          echo "=== Docker ë¹Œë“œ ê²€ì¦ ==="
          docker-compose build --no-cache app
          echo "docker_build_completed=true" >> $GITHUB_ENV

      - name: ë³´ì•ˆ ìŠ¤ìº”
        if: success()
        continue-on-error: true
        run: |
          echo "=== ë³´ì•ˆ ì·¨ì•½ì  ìŠ¤ìº” ==="
          pip install safety
          safety check --json || true
          echo "security_scan_completed=true" >> $GITHUB_ENV

      - name: ì²˜ë¦¬ ê²°ê³¼ ì¢…í•© ë¦¬í¬íŠ¸
        if: always()
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const issueNumber = '${{ steps.context.outputs.issue_number }}';
            if (!issueNumber) return;
            
            let report = `## ğŸ¤– Claude Code ìë™í™” ì²˜ë¦¬ ê²°ê³¼\n\n`;
            report += `### ğŸ“Š ì²˜ë¦¬ ìƒíƒœ\n`;
            report += `- â° ì²˜ë¦¬ ì‹œê°„: ${new Date().toLocaleString('ko-KR', { timeZone: 'Asia/Seoul' })}\n`;
            report += `- ğŸ”— [ì›Œí¬í”Œë¡œìš° ë¡œê·¸](${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})\n\n`;
            
            report += `### âœ… ìˆ˜í–‰ëœ ì‘ì—…\n`;
            
            // ê° ë‹¨ê³„ ê²°ê³¼ ì²´í¬
            const steps = [
              { env: 'test_completed', icon: 'ğŸ§ª', text: 'í…ŒìŠ¤íŠ¸ ì‹¤í–‰' },
              { env: 'docker_build_completed', icon: 'ğŸ³', text: 'Docker ë¹Œë“œ ê²€ì¦' },
              { env: 'security_scan_completed', icon: 'ğŸ”’', text: 'ë³´ì•ˆ ìŠ¤ìº”' }
            ];
            
            steps.forEach(step => {
              if (process.env[step.env] === 'true') {
                report += `- ${step.icon} ${step.text} ì™„ë£Œ\n`;
              }
            });
            
            report += `\n### ğŸ¯ ë‹¤ìŒ ë‹¨ê³„\n`;
            report += `- PRì´ ìƒì„±ëœ ê²½ìš° ë¦¬ë·° í›„ ë¨¸ì§€\n`;
            report += `- ì¶”ê°€ ìˆ˜ì •ì´ í•„ìš”í•œ ê²½ìš° \`@claude\` ë©˜ì…˜\n`;
            report += `- ê¸´ê¸‰ ì²˜ë¦¬ê°€ í•„ìš”í•œ ê²½ìš° \`P0-urgent\` ë¼ë²¨ ì¶”ê°€\n`;
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: parseInt(issueNumber),
              body: report
            });

  # PR ìë™ ë¨¸ì§€ (ì¡°ê±´ ì¶©ì¡± ì‹œ)
  auto-merge:
    if: github.event_name == 'pull_request' && startsWith(github.head_ref, 'claude/')
    runs-on: ubuntu-latest
    needs: claude-processor
    
    steps:
      - name: ìë™ ë¨¸ì§€ ì²´í¬
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const pr = context.payload.pull_request;
            
            // ì²´í¬ ì¡°ê±´
            const checks = await github.rest.checks.listForRef({
              owner: context.repo.owner,
              repo: context.repo.repo,
              ref: pr.head.sha
            });
            
            const allChecksPassed = checks.data.check_runs.every(
              check => check.conclusion === 'success' || check.conclusion === 'neutral'
            );
            
            if (allChecksPassed) {
              // ìë™ ë¨¸ì§€
              await github.rest.pulls.merge({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: pr.number,
                merge_method: 'squash'
              });
              
              console.log(`PR #${pr.number} ìë™ ë¨¸ì§€ ì™„ë£Œ`);
            }

  # ì¼ì¼ ì •ê¸° ì ê²€ (ìŠ¤ì¼€ì¤„)
  daily-maintenance:
    if: github.event_name == 'schedule'
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        
      - name: ì˜¤í”ˆ ì´ìŠˆ ìë™ ì²˜ë¦¬
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            // ì˜¤ë˜ëœ ì´ìŠˆ ì°¾ê¸°
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              sort: 'created',
              direction: 'asc'
            });
            
            let report = `## ğŸ“… ì¼ì¼ ìë™ ì ê²€ ë¦¬í¬íŠ¸\n\n`;
            report += `- ê²€ì‚¬ ì‹œê°„: ${new Date().toLocaleString('ko-KR', { timeZone: 'Asia/Seoul' })}\n`;
            report += `- ì˜¤í”ˆ ì´ìŠˆ: ${issues.data.length}ê°œ\n\n`;
            
            // 7ì¼ ì´ìƒ ëœ ì´ìŠˆ ìë™ ì²˜ë¦¬
            const oldIssues = issues.data.filter(issue => {
              const created = new Date(issue.created_at);
              const now = new Date();
              const days = (now - created) / (1000 * 60 * 60 * 24);
              return days > 7;
            });
            
            if (oldIssues.length > 0) {
              report += `### âš ï¸ 7ì¼ ì´ìƒ ëœ ì´ìŠˆ (${oldIssues.length}ê°œ)\n`;
              for (const issue of oldIssues) {
                report += `- #${issue.number}: ${issue.title}\n`;
                
                // Claude ì²˜ë¦¬ íŠ¸ë¦¬ê±°
                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: issue.number,
                  body: `@claude ì´ ì´ìŠˆëŠ” 7ì¼ ì´ìƒ ì²˜ë¦¬ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ìë™ ë¶„ì„ ë° í•´ê²°ì„ ì‹œì‘í•©ë‹ˆë‹¤.`
                });
              }
            }
            
            // ì¼ì¼ ë¦¬í¬íŠ¸ ì´ìŠˆ ìƒì„±
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `ğŸ“Š ì¼ì¼ ìë™í™” ë¦¬í¬íŠ¸ - ${new Date().toLocaleDateString('ko-KR')}`,
              body: report,
              labels: ['auto-report', 'documentation']
            });