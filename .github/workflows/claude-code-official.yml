name: Claude Code - SafeWork 자동화

on:
  issue_comment:
    types: [created]
  pull_request_review_comment:
    types: [created]

permissions:
  contents: write
  issues: write
  pull-requests: write

jobs:
  claude:
    if: |
      (github.event_name == 'issue_comment' && contains(github.event.comment.body, '@claude')) ||
      (github.event_name == 'pull_request_review_comment' && contains(github.event.comment.body, '@claude'))
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Debug Event Information
        run: |
          echo "Event Name: ${{ github.event_name }}"
          echo "Comment Body: ${{ github.event.comment.body }}"
          echo "Issue Number: ${{ github.event.issue.number }}"
          echo "Repository: ${{ github.repository }}"

      - name: SafeWork 이슈 자동 처리
        uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          github_token: ${{ secrets.GITHUB_TOKEN }}
          prompt: |
            SafeWork 프로젝트의 GitHub 이슈를 자동으로 처리해주세요.
            
            ## 프로젝트 컨텍스트
            - Flask 3.0+ 기반 안전보건 관리시스템
            - 001/002 설문 시스템 및 관리자 대시보드
            - MySQL + Redis + Docker 환경
            - 건설업 맞춤 기능 구현 중
            
            ## 현재 이슈 정보
            ${{ github.event_name == 'issues' && format('이슈 #{0}: {1}', github.event.issue.number, github.event.issue.title) || format('댓글 이슈 #{0}', github.event.issue.number) }}
            
            ## 처리 방식 - 사용자 확인 필수
            1. **이슈 분석**: 요구사항 및 기술적 복잡도 파악
            2. **코드 검토**: 관련 파일 (templates/, routes/, models/) 분석
            3. **구현 계획**: 구체적인 구현 방안을 댓글로 제안
            4. **사용자 승인**: @qws941 @seonmin994 확인 및 승인 대기
            5. **승인 후 구현**: 사용자 승인 시에만 실제 코드 변경
            6. **변경사항 상세 보고**: 수정된 파일, 추가된 기능, 테스트 결과 상세 제공
            7. **MCP 스크린샷**: 구현 과정 시각적 증거 제공
            
            ## 우선순위 처리
            - **P0 라벨**: 최우선 즉시 처리
            - **enhancement**: 기능 개선 구현
            - **bug**: 버그 수정 및 검증
            
            ## 코딩 규칙 - 승인 후 진행
            - **사용자 확인 우선**: 코드 변경 전 반드시 사용자 승인 필요
            - CLAUDE.md 가이드라인 준수
            - Flask 모범사례 적용
            - 기존 코드 스타일 유지
            - MCP Serena 도구 활용한 정밀 코드 수정
            - Docker 환경 테스트 필수
            - **변경사항 투명성**: 모든 수정 내역 상세 보고
            - **증거 자료**: MCP 스크린샷으로 구현 과정 문서화
            
            **중요**: 사용자 승인 없이 코드 변경 금지. 계획 제안 후 승인 대기!

      - name: 이슈 처리 결과 알림
        if: always()
        run: |
          echo "🤖 Claude Code 자동 처리 완료"
          echo "📋 이슈: ${{ github.event.issue.title || '댓글 이슈' }}"
          echo "⏰ 처리 시간: $(date)"
          echo "🔗 상세 로그: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"