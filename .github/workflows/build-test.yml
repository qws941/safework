name: 🧪 Build Test

# Simple build test workflow to verify Docker builds work
concurrency:
  group: build-test-${{ github.ref }}
  cancel-in-progress: true

on:
  workflow_dispatch:
    inputs:
      test_service:
        description: 'Service to test (app, postgres, redis, or all)'
        required: false
        default: 'all'
        type: choice
        options:
          - 'all'
          - 'app'
          - 'postgres'
          - 'redis'

permissions:
  contents: read
  packages: write

jobs:
  build-test:
    name: 🔨 Build Test
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    steps:
      - name: 📂 Checkout
        uses: actions/checkout@v4

      - name: 🐳 Setup Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: 🔍 Test PostgreSQL Build
        if: ${{ inputs.test_service == 'all' || inputs.test_service == 'postgres' }}
        run: |
          echo "🔍 Testing PostgreSQL Docker build..."
          docker build ./postgres -t test-postgres:latest
          echo "✅ PostgreSQL build successful"

      - name: 🔍 Test Redis Build
        if: ${{ inputs.test_service == 'all' || inputs.test_service == 'redis' }}
        run: |
          echo "🔍 Testing Redis Docker build..."
          docker build ./redis -t test-redis:latest
          echo "✅ Redis build successful"

      - name: 🔍 Test App Build
        if: ${{ inputs.test_service == 'all' || inputs.test_service == 'app' }}
        run: |
          echo "🔍 Testing Flask App Docker build..."
          docker build ./app -t test-app:latest
          echo "✅ App build successful"

      - name: 📊 Build Test Summary
        run: |
          echo "# 🧪 Build Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ✅ All Docker builds completed successfully" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Test Service:** ${{ inputs.test_service || 'all' }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Status:** Success" >> $GITHUB_STEP_SUMMARY
          echo "- **Time:** $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY