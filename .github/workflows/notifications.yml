name: Notifications
on:
  issues:
    types: [opened, closed, labeled]
  pull_request:
    types: [opened, closed, merged]
  workflow_run:
    workflows: ["Claude", "Deploy"]
    types: [completed]

jobs:
  slack-notify:
    if: contains(github.event.issue.labels.*.name, 'P0-CRITICAL') || github.event.workflow_run.conclusion == 'failure'
    runs-on: ubuntu-latest
    steps:
      - name: Slack Notification
        if: env.SLACK_WEBHOOK_URL != ''
        uses: 8398a7/action-slack@v3
        with:
          status: custom
          webhook_url: ${{ secrets.SLACK_WEBHOOK_URL }}
          custom_payload: |
            {
              "text": "SafeWork 알림",
              "attachments": [
                {
                  "color": "${{ github.event.issue && contains(github.event.issue.labels.*.name, 'P0-CRITICAL') && 'danger' || github.event.workflow_run.conclusion == 'failure' && 'danger' || 'good' }}",
                  "fields": [
                    {
                      "title": "Repository",
                      "value": "${{ github.repository }}",
                      "short": true
                    },
                    {
                      "title": "Event",
                      "value": "${{ github.event_name }}",
                      "short": true
                    },
                    {
                      "title": "Details",
                      "value": "${{ github.event.issue.title || github.event.pull_request.title || github.event.workflow_run.name }}",
                      "short": false
                    },
                    {
                      "title": "Link",
                      "value": "${{ github.event.issue.html_url || github.event.pull_request.html_url || github.event.workflow_run.html_url }}",
                      "short": false
                    }
                  ]
                }
              ]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

  discord-notify:
    if: contains(github.event.issue.labels.*.name, 'P0-CRITICAL')
    runs-on: ubuntu-latest
    steps:
      - name: Discord Notification
        if: env.DISCORD_WEBHOOK_URL != ''
        uses: Ilshidur/action-discord@master
        with:
          args: |
            🚨 **SafeWork 긴급 이슈 발생**
            
            **제목:** ${{ github.event.issue.title }}
            **링크:** ${{ github.event.issue.html_url }}
            **작성자:** ${{ github.event.issue.user.login }}
            
            Claude AI가 자동으로 분석을 시작합니다.
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK_URL }}