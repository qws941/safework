name: SafeWork Smart Notifications
on:
  issues:
    types: [opened, closed, labeled, reopened]
  pull_request:
    types: [opened, closed, merged, ready_for_review]
  workflow_run:
    workflows: ["Claude", "Deploy", "Review"]
    types: [completed]
  schedule:
    - cron: '0 9 * * 1'  # Weekly Monday 9AM KST report

env:
  SAFEWORK_URL: "https://safework.jclee.me"

jobs:
  smart-slack-notify:
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Checkout for Context
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: SafeWork Smart Slack Notification
        uses: actions/github-script@v7
        with:
          script: |
            // @slack/web-api ëª¨ë“ˆì´ GitHub Actionsì—ì„œ ì‚¬ìš©í•  ìˆ˜ ì—†ìœ¼ë¯€ë¡œ fetchë¥¼ ì‚¬ìš©
            
            // ì´ë²¤íŠ¸ íƒ€ì… ê°ì§€
            const eventType = context.eventName;
            const issue = context.payload.issue;
            const pr = context.payload.pull_request;
            const workflowRun = context.payload.workflow_run;
            
            // Slack ë©”ì‹œì§€ êµ¬ì„±
            let notification = {};
            
            if (eventType === 'issues') {
              notification = await buildIssueNotification(issue, context);
            } else if (eventType === 'pull_request') {
              notification = await buildPRNotification(pr, context);
            } else if (eventType === 'workflow_run') {
              notification = await buildWorkflowNotification(workflowRun, context);
            } else if (eventType === 'schedule') {
              notification = await buildWeeklyReport(context);
            }
            
            if (notification.shouldSend) {
              await sendSlackNotification(notification.payload);
            }
            
            // ì´ìŠˆ ì•Œë¦¼ êµ¬ì„±
            async function buildIssueNotification(issue, context) {
              const action = context.payload.action;
              const labels = issue.labels.map(label => label.name);
              const isPriority = labels.some(label => label.startsWith('P0-') || label.startsWith('P1-'));
              const isKorean = labels.includes('lang:korean');
              
              // ìš°ì„ ìˆœìœ„ ì´ìŠˆë§Œ ì•Œë¦¼ (P0, P1)
              if (!isPriority && action === 'opened') return { shouldSend: false };
              
              const priorityLevel = labels.find(label => label.startsWith('P'))?.split('-')[0] || 'P2';
              const component = labels.find(label => label.startsWith('component:'))?.split(':')[1] || 'general';
              
              const emoji = {
                'P0': 'ğŸš¨',
                'P1': 'âš ï¸', 
                'P2': 'â„¹ï¸'
              }[priorityLevel] || 'â„¹ï¸';
              
              const color = {
                'P0': 'danger',
                'P1': 'warning',
                'P2': 'good'
              }[priorityLevel] || 'good';
              
              const componentEmoji = {
                'survey': 'ğŸ“‹',
                'admin': 'ğŸ‘¨â€ğŸ’¼',
                'medical': 'ğŸ¥',
                'api': 'ğŸ”—',
                'deployment': 'ğŸš€',
                'database': 'ğŸ—„ï¸',
                'frontend': 'ğŸ–¥ï¸'
              }[component] || 'âš™ï¸';
              
              return {
                shouldSend: true,
                payload: {
                  channel: '#safework-alerts',
                  text: `${emoji} SafeWork ${priorityLevel} ì´ìŠˆ ${action === 'opened' ? 'ë°œìƒ' : action}`,
                  attachments: [{
                    color: color,
                    title: `${componentEmoji} ${issue.title}`,
                    title_link: issue.html_url,
                    fields: [
                      {
                        title: "ìš°ì„ ìˆœìœ„",
                        value: priorityLevel,
                        short: true
                      },
                      {
                        title: "ì»´í¬ë„ŒíŠ¸", 
                        value: component,
                        short: true
                      },
                      {
                        title: "ì‘ì„±ì",
                        value: issue.user.login,
                        short: true
                      },
                      {
                        title: "ì–¸ì–´",
                        value: isKorean ? "í•œêµ­ì–´ ğŸ‡°ğŸ‡·" : "English ğŸ‡ºğŸ‡¸",
                        short: true
                      },
                      {
                        title: "ë¼ë²¨",
                        value: labels.length > 0 ? labels.join(', ') : 'None',
                        short: false
                      },
                      {
                        title: "SafeWork ì‹œìŠ¤í…œ",
                        value: `<${process.env.SAFEWORK_URL}|SafeWork ì ‘ì†> | <${issue.html_url}|GitHub ì´ìŠˆ>`,
                        short: false
                      }
                    ],
                    footer: "SafeWork AI Monitoring",
                    footer_icon: "https://github.githubassets.com/images/modules/logos_page/GitHub-Mark.png",
                    ts: Math.floor(Date.now() / 1000)
                  }],
                  blocks: priorityLevel === 'P0' ? [{
                    type: "section",
                    text: {
                      type: "mrkdwn", 
                      text: `ğŸš¨ *ê¸´ê¸‰ ëŒ€ì‘ í•„ìš”* ğŸš¨\nâ€¢ Claude AI ìë™ ë¶„ì„ ì‹œì‘\nâ€¢ ë‹´ë‹¹íŒ€ ì¦‰ì‹œ í™•ì¸ ìš”ì²­\nâ€¢ ì‹œìŠ¤í…œ ìƒíƒœ: <${process.env.SAFEWORK_URL}/health|í—¬ìŠ¤ì²´í¬>`
                    }
                  }] : []
                }
              };
            }
            
            // PR ì•Œë¦¼ êµ¬ì„±
            async function buildPRNotification(pr, context) {
              const action = context.payload.action;
              
              // merged, ready_for_reviewë§Œ ì•Œë¦¼
              if (!['merged', 'ready_for_review'].includes(action)) {
                return { shouldSend: false };
              }
              
              const emoji = action === 'merged' ? 'âœ…' : 'ğŸ‘€';
              const color = action === 'merged' ? 'good' : '#36a64f';
              
              return {
                shouldSend: true,
                payload: {
                  channel: '#safework-dev',
                  text: `${emoji} SafeWork PR ${action}`,
                  attachments: [{
                    color: color,
                    title: `ğŸ”„ ${pr.title}`,
                    title_link: pr.html_url,
                    fields: [
                      {
                        title: "ìƒíƒœ",
                        value: action === 'merged' ? 'ë³‘í•© ì™„ë£Œ' : 'ë¦¬ë·° ì¤€ë¹„ë¨',
                        short: true
                      },
                      {
                        title: "ì‘ì„±ì",
                        value: pr.user.login,
                        short: true
                      },
                      {
                        title: "ë³€ê²½ì‚¬í•­",
                        value: `+${pr.additions} -${pr.deletions} (${pr.changed_files} files)`,
                        short: true
                      },
                      {
                        title: "ë¸Œëœì¹˜",
                        value: `${pr.head.ref} â†’ ${pr.base.ref}`,
                        short: true
                      }
                    ]
                  }]
                }
              };
            }
            
            // ì›Œí¬í”Œë¡œìš° ì•Œë¦¼ êµ¬ì„±
            async function buildWorkflowNotification(workflowRun, context) {
              const conclusion = workflowRun.conclusion;
              const workflowName = workflowRun.name;
              
              // ì‹¤íŒ¨í•œ ì›Œí¬í”Œë¡œìš°ë§Œ ì•Œë¦¼
              if (conclusion !== 'failure') return { shouldSend: false };
              
              const emoji = 'âŒ';
              const channel = workflowName === 'Deploy' ? '#safework-alerts' : '#safework-dev';
              
              return {
                shouldSend: true,
                payload: {
                  channel: channel,
                  text: `${emoji} SafeWork ${workflowName} ì›Œí¬í”Œë¡œìš° ì‹¤íŒ¨`,
                  attachments: [{
                    color: 'danger',
                    title: `ğŸ”¥ ${workflowName} ì‹¤íŒ¨`,
                    title_link: workflowRun.html_url,
                    fields: [
                      {
                        title: "ë¸Œëœì¹˜",
                        value: workflowRun.head_branch,
                        short: true
                      },
                      {
                        title: "ì»¤ë°‹",
                        value: workflowRun.head_sha.substring(0, 7),
                        short: true
                      },
                      {
                        title: "íŠ¸ë¦¬ê±°",
                        value: workflowRun.event,
                        short: true
                      },
                      {
                        title: "ì‹¤í–‰ì‹œê°„",
                        value: `${Math.ceil((new Date(workflowRun.updated_at) - new Date(workflowRun.created_at)) / 1000)}ì´ˆ`,
                        short: true
                      }
                    ]
                  }],
                  blocks: workflowName === 'Deploy' ? [{
                    type: "section",
                    text: {
                      type: "mrkdwn",
                      text: `ğŸ”¥ *ë°°í¬ ì‹¤íŒ¨ - ì¦‰ì‹œ ëŒ€ì‘ í•„ìš”*\nâ€¢ ì„œë¹„ìŠ¤ ìƒíƒœ í™•ì¸: <${process.env.SAFEWORK_URL}/health|í—¬ìŠ¤ì²´í¬>\nâ€¢ ë¡œê·¸ í™•ì¸: <${workflowRun.html_url}|GitHub Actions>`
                    }
                  }] : []
                }
              };
            }
            
            // ì£¼ê°„ ë¦¬í¬íŠ¸ êµ¬ì„±
            async function buildWeeklyReport(context) {
              const oneWeekAgo = new Date();
              oneWeekAgo.setDate(oneWeekAgo.getDate() - 7);
              
              // GitHub APIë¡œ ì§€ë‚œ ì£¼ ì´ìŠˆ/PR í†µê³„ ìˆ˜ì§‘
              const { data: issues } = await github.rest.issues.listForRepo({
                owner: context.repo.owner,
                repo: context.repo.repo,
                state: 'all',
                since: oneWeekAgo.toISOString(),
                per_page: 100
              });
              
              const issueStats = {
                total: issues.filter(i => !i.pull_request).length,
                closed: issues.filter(i => !i.pull_request && i.state === 'closed').length,
                p0: issues.filter(i => i.labels.some(l => l.name === 'P0-CRITICAL')).length,
                p1: issues.filter(i => i.labels.some(l => l.name === 'P1-HIGH')).length
              };
              
              const prStats = {
                total: issues.filter(i => i.pull_request).length,
                merged: issues.filter(i => i.pull_request && i.state === 'closed').length
              };
              
              return {
                shouldSend: true,
                payload: {
                  channel: '#safework-weekly',
                  text: `ğŸ“Š SafeWork ì£¼ê°„ ë¦¬í¬íŠ¸ (${new Date().toLocaleDateString('ko-KR')})`,
                  attachments: [{
                    color: '#36a64f',
                    title: 'ğŸ“ˆ ì§€ë‚œ ì£¼ í™œë™ ìš”ì•½',
                    fields: [
                      {
                        title: "ğŸ› ì´ìŠˆ í˜„í™©",
                        value: `ì´ ${issueStats.total}ê°œ (í•´ê²°: ${issueStats.closed}ê°œ)\nâ€¢ P0-ê¸´ê¸‰: ${issueStats.p0}ê°œ\nâ€¢ P1-ë†’ìŒ: ${issueStats.p1}ê°œ`,
                        short: true
                      },
                      {
                        title: "ğŸ”„ PR í˜„í™©", 
                        value: `ì´ ${prStats.total}ê°œ (ë³‘í•©: ${prStats.merged}ê°œ)\nâ€¢ ë³‘í•©ë¥ : ${prStats.total > 0 ? Math.round(prStats.merged/prStats.total*100) : 0}%`,
                        short: true
                      },
                      {
                        title: "ğŸ¯ ì‹œìŠ¤í…œ ìƒíƒœ",
                        value: `<${process.env.SAFEWORK_URL}|SafeWork ì‹œìŠ¤í…œ>\n<${process.env.SAFEWORK_URL}/health|í—¬ìŠ¤ì²´í¬>\n<https://github.com/${context.repo.owner}/${context.repo.repo}/actions|Actions ìƒíƒœ>`,
                        short: false
                      }
                    ]
                  }]
                }
              };
            }
            
            // GitHub Actions fetchë¥¼ ì‚¬ìš©í•˜ì—¬ Slack ë©”ì‹œì§€ ì „ì†¡
            async function sendSlackNotification(payload) {
              const webhookUrl = process.env.SLACK_WEBHOOK_URL;
              if (!webhookUrl) {
                console.log('SLACK_WEBHOOK_URL not configured');
                return;
              }
              
              try {
                const https = require('https');
                const url = require('url');
                
                const parsedUrl = url.parse(webhookUrl);
                const postData = JSON.stringify(payload);
                
                const options = {
                  hostname: parsedUrl.hostname,
                  port: parsedUrl.port || 443,
                  path: parsedUrl.pathname,
                  method: 'POST',
                  headers: {
                    'Content-Type': 'application/json',
                    'Content-Length': Buffer.byteLength(postData)
                  }
                };
                
                const req = https.request(options, (res) => {
                  let data = '';
                  res.on('data', (chunk) => {
                    data += chunk;
                  });
                  res.on('end', () => {
                    if (res.statusCode === 200) {
                      console.log('Slack notification sent successfully');
                    } else {
                      console.error('Failed to send Slack notification:', res.statusCode, data);
                    }
                  });
                });
                
                req.on('error', (error) => {
                  console.error('Error sending Slack notification:', error);
                });
                
                req.write(postData);
                req.end();
                
              } catch (error) {
                console.error('Error sending Slack notification:', error);
              }
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

  teams-notify:
    runs-on: ubuntu-latest
    if: github.event.issue && contains(github.event.issue.labels.*.name, 'P0-CRITICAL')
    steps:
      - name: Microsoft Teams Critical Alert
        uses: skitionek/notify-microsoft-teams@master
        with:
          webhook_url: ${{ secrets.TEAMS_WEBHOOK_URL }}
          overwrite: '{
            "title": "ğŸš¨ SafeWork ê¸´ê¸‰ ì´ìŠˆ",
            "text": "${{ github.event.issue.title }}",
            "summary": "SafeWork P0-CRITICAL ì´ìŠˆ ë°œìƒ",
            "sections": [{
              "activityTitle": "ê¸´ê¸‰ ëŒ€ì‘ í•„ìš”",
              "activitySubtitle": "${{ github.event.issue.user.login }}ë‹˜ì´ ë³´ê³ ",
              "facts": [{
                "name": "ìš°ì„ ìˆœìœ„",
                "value": "P0-CRITICAL"
              }, {
                "name": "ì‹œìŠ¤í…œ",
                "value": "SafeWork ì•ˆì „ë³´ê±´ ê´€ë¦¬ì‹œìŠ¤í…œ"
              }, {
                "name": "ë§í¬",
                "value": "${{ github.event.issue.html_url }}"
              }]
            }],
            "potentialAction": [{
              "@type": "OpenUri",
              "name": "ì´ìŠˆ í™•ì¸",
              "targets": [{
                "os": "default",
                "uri": "${{ github.event.issue.html_url }}"
              }]
            }, {
              "@type": "OpenUri", 
              "name": "SafeWork ì‹œìŠ¤í…œ",
              "targets": [{
                "os": "default",
                "uri": "https://safework.jclee.me"
              }]
            }]
          }'