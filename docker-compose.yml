version: '3.8'

services:
  # MySQL 데이터베이스 (커스텀 이미지 v1.3.1)
  mysql:
    image: registry.jclee.me/safework/mysql:latest
    container_name: safework-mysql
    restart: on-failure:3
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    deploy:
      resources:
        limits:
          memory: 512M
          cpus: '0.5'
        reservations:
          memory: 256M
          cpus: '0.25'
      restart_policy:
        condition: on-failure
        delay: 5s
        max_attempts: 3
        window: 120s
    environment:
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD:-safework2024root}
      MYSQL_DATABASE: ${MYSQL_DATABASE:-safework_db}
      MYSQL_USER: ${MYSQL_USER:-safework}
      MYSQL_PASSWORD: ${MYSQL_PASSWORD:-safework2024}
      MYSQL_CHARACTER_SET_SERVER: utf8mb4
      MYSQL_COLLATION_SERVER: utf8mb4_unicode_ci
      TZ: ${TZ:-Asia/Seoul}
    volumes:
      - mysql_data:/var/lib/mysql
      - mysql_logs:/var/log/mysql
    ports:
      - "3307:3306"
    networks:
      - safework-net
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-u", "root", "-p${MYSQL_ROOT_PASSWORD:-safework2024root}"]
      interval: 15s
      timeout: 5s
      retries: 5
      start_period: 30s

  # Redis 캐시 (커스텀 이미지 v1.3.1)
  redis:
    image: registry.jclee.me/safework/redis:latest
    container_name: safework-redis
    restart: on-failure:3
    logging:
      driver: "json-file"
      options:
        max-size: "5m"
        max-file: "2"
    deploy:
      resources:
        limits:
          memory: 128M
          cpus: '0.25'
        reservations:
          memory: 64M
          cpus: '0.1'
      restart_policy:
        condition: on-failure
        delay: 5s
        max_attempts: 3
        window: 120s
    environment:
      REDIS_REPLICATION_MODE: master
      REDIS_PASSWORD: ${REDIS_PASSWORD:-}
      TZ: ${TZ:-Asia/Seoul}
    volumes:
      - redis_data:/data
    ports:
      - "6380:6379"
    networks:
      - safework-net
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 15s
      timeout: 5s
      retries: 5
      start_period: 10s

  # SafeWork 애플리케이션 (커스텀 이미지 v1.3.1)
  app:
    image: registry.jclee.me/safework/app:latest
    container_name: safework-app
    restart: on-failure:5
    logging:
      driver: "json-file"
      options:
        max-size: "20m"
        max-file: "5"
    deploy:
      resources:
        limits:
          memory: 1G
          cpus: '1.0'
        reservations:
          memory: 512M
          cpus: '0.5'
      restart_policy:
        condition: on-failure
        delay: 10s
        max_attempts: 5
        window: 300s
    depends_on:
      mysql:
        condition: service_healthy
      redis:
        condition: service_healthy
    environment:
      PYTHONUNBUFFERED: 1
      PYTHONDONTWRITEBYTECODE: 1
      FLASK_APP: app.py
      FLASK_CONFIG: ${FLASK_CONFIG:-production}
      SECRET_KEY: ${SECRET_KEY:-safework-production-secret-key-2024}
      MYSQL_HOST: ${MYSQL_HOST:-safework-mysql}
      MYSQL_PORT: ${MYSQL_PORT:-3306}
      MYSQL_USER: ${MYSQL_USER:-safework}
      MYSQL_PASSWORD: ${MYSQL_PASSWORD:-safework2024}
      MYSQL_DATABASE: ${MYSQL_DATABASE:-safework_db}
      REDIS_HOST: ${REDIS_HOST:-safework-redis}
      REDIS_PORT: ${REDIS_PORT:-6379}
      REDIS_PASSWORD: ${REDIS_PASSWORD:-}
      REDIS_DB: ${REDIS_DB:-0}
      ADMIN_USERNAME: ${ADMIN_USERNAME:-safewrork}
      ADMIN_PASSWORD: ${ADMIN_PASSWORD:-123}
      UPLOAD_FOLDER: ${UPLOAD_FOLDER:-/app/uploads}
      APP_PORT: ${APP_PORT:-4545}
      TZ: ${TZ:-Asia/Seoul}
      # CSRF 완전 비활성화 - 설문 테스트용
      WTF_CSRF_ENABLED: "false"
      WTF_CSRF_CHECK_DEFAULT: "false"
    volumes:
      - app_uploads:/app/uploads
    ports:
      - "4545:4545"
    networks:
      - safework-net
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:4545/health')"]
      interval: 20s
      timeout: 10s
      retries: 5
      start_period: 60s
    labels:
      - "com.centurylinklabs.watchtower.enable=true"


volumes:
  mysql_data:
    driver: local
  mysql_logs:
    driver: local
  redis_data:
    driver: local
  app_uploads:
    driver: local

networks:
  safework-net:
    driver: bridge
    name: safework-net