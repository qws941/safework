{% extends "base.html" %}

{% block title %}ì„¤ë¬¸ì¡°ì‚¬ í†µê³„ ë¶„ì„ - {{ app_name }}{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="mb-4">
        <a href="{{ url_for('admin.survey') }}" class="btn btn-secondary">
            <i class="bi bi-arrow-left"></i> ëª©ë¡ìœ¼ë¡œ
        </a>
    </div>

    <h2 class="mb-4">
        <i class="bi bi-bar-chart"></i> ê·¼ê³¨ê²©ê³„ ì¦ìƒì¡°ì‚¬í‘œ ë¶„ì„ ê²°ê³¼
        <small class="text-muted">(ì—‘ì…€ ë¶„ì„ í”„ë¡œê·¸ë¨ê³¼ ë™ì¼)</small>
    </h2>

    <!-- 1. ì „ì²´ í˜„í™© ì¹´ë“œ -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card bg-primary text-white">
                <div class="card-body">
                    <h5 class="card-title">ì „ì²´ ì‘ë‹µì</h5>
                    <h2>{{ total_surveys }}ëª…</h2>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-warning text-white">
                <div class="card-body">
                    <h5 class="card-title">ê·¼ê³¨ê²©ê³„ ì„¤ë¬¸</h5>
                    <h2>{{ musculo_surveys }}ëª…</h2>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-info text-white">
                <div class="card-body">
                    <h5 class="card-title">ì‹ ê·œì…ì‚¬ì ì„¤ë¬¸</h5>
                    <h2>{{ newbie_surveys }}ëª…</h2>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-danger text-white">
                <div class="card-body">
                    <h5 class="card-title">ê´€ë¦¬ëŒ€ìƒì</h5>
                    <h2>{{ dept_stats.values()|sum(attribute='ê´€ë¦¬ëŒ€ìƒì') }}ëª…</h2>
                </div>
            </div>
        </div>
    </div>

    <!-- 2. ë¶€ì„œë³„ í†µê³„ ë¶„ì„ (ì—‘ì…€ê³¼ ë™ì¼í•œ í˜•íƒœ) -->
    <div class="card mb-4">
        <div class="card-header bg-success text-white">
            <h5 class="mb-0">ğŸ“Š ë¶€ì„œë³„ ìê°€ì¦ìƒ ë¶„ì„ ê²°ê³¼</h5>
            <small>â€» ì—‘ì…€ ã€Œê·¼ê³¨ê²©ê³„ë¶€ë‹´ì‘ì—… ìœ í•´ìš”ì¸ì¡°ì‚¬ ì§€ì¹¨ã€ ì–‘ì‹ê³¼ ë™ì¼í•œ ë¶„ì„</small>
        </div>
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-bordered table-hover mb-0" style="font-size: 0.9rem;">
                    <thead class="table-success">
                        <tr>
                            <th rowspan="2" class="text-center align-middle">ë¶€ì„œ</th>
                            <th colspan="2" class="text-center">ì—°ë ¹ ë¶„í¬</th>
                            <th colspan="2" class="text-center">ì„±ë³„ ë¶„í¬</th>
                            <th colspan="2" class="text-center">ê·¼ê³¨ê²©ê³„ ì¦ìƒ</th>
                        </tr>
                        <tr>
                            <th class="text-center">ì‘ë‹µì(ëª…)</th>
                            <th class="text-center">í‰ê· (ì„¸)</th>
                            <th class="text-center">ë‚¨ì„±</th>
                            <th class="text-center">ì—¬ì„±</th>
                            <th class="text-center">í†µì¦í˜¸ì†Œì</th>
                            <th class="text-center bg-warning">ê´€ë¦¬ëŒ€ìƒì</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for dept, stats in dept_stats.items() %}
                        <tr>
                            <td class="fw-bold">{{ dept }}</td>
                            <td class="text-center">{{ stats['ì‘ë‹µììˆ˜'] }}</td>
                            <td class="text-center">{{ stats['í‰ê· ë‚˜ì´'] if stats['í‰ê· ë‚˜ì´'] > 0 else '-' }}</td>
                            <td class="text-center">{{ stats['ë‚¨ì„±'] }}</td>
                            <td class="text-center">{{ stats['ì—¬ì„±'] }}</td>
                            <td class="text-center">
                                <span class="{% if stats['í†µì¦í˜¸ì†Œì'] > 0 %}text-warning fw-bold{% endif %}">
                                    {{ stats['í†µì¦í˜¸ì†Œì'] }}
                                </span>
                            </td>
                            <td class="text-center bg-warning-subtle">
                                <span class="{% if stats['ê´€ë¦¬ëŒ€ìƒì'] > 0 %}text-danger fw-bold{% endif %}">
                                    {{ stats['ê´€ë¦¬ëŒ€ìƒì'] }}
                                </span>
                            </td>
                        </tr>
                        {% endfor %}
                        <!-- ì „ì²´ í•©ê³„ í–‰ -->
                        <tr class="table-secondary fw-bold">
                            <td>ì „ì²´ í•©ê³„</td>
                            <td class="text-center">{{ total_surveys }}</td>
                            <td class="text-center">
                                {% set total_age = namespace(value=0, count=0) %}
                                {% for dept, stats in dept_stats.items() %}
                                    {% if stats['í‰ê· ë‚˜ì´'] > 0 %}
                                        {% set total_age.value = total_age.value + (stats['í‰ê· ë‚˜ì´'] * stats['ì‘ë‹µììˆ˜']) %}
                                        {% set total_age.count = total_age.count + stats['ì‘ë‹µììˆ˜'] %}
                                    {% endif %}
                                {% endfor %}
                                {{ (total_age.value / total_age.count)|round(1) if total_age.count > 0 else '-' }}
                            </td>
                            <td class="text-center">{{ dept_stats.values()|sum(attribute='ë‚¨ì„±') }}</td>
                            <td class="text-center">{{ dept_stats.values()|sum(attribute='ì—¬ì„±') }}</td>
                            <td class="text-center text-warning">{{ dept_stats.values()|sum(attribute='í†µì¦í˜¸ì†Œì') }}</td>
                            <td class="text-center bg-warning text-danger">{{ dept_stats.values()|sum(attribute='ê´€ë¦¬ëŒ€ìƒì') }}</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- 3. ì‹ ì²´ë¶€ìœ„ë³„ ê·¼ê³¨ê²©ê³„ í†µì¦í˜¸ì†Œì ë¶„í¬ -->
    <div class="card mb-4">
        <div class="card-header bg-danger text-white">
            <h5 class="mb-0">ğŸ¥ ì‹ ì²´ë¶€ìœ„ë³„ ê·¼ê³¨ê²©ê³„ í†µì¦í˜¸ì†Œì ë¶„í¬</h5>
            <small>â€» ê´€ë¦¬ëŒ€ìƒì íŒì •ê¸°ì¤€: ì—‘ì…€ ë¶„ì„í”„ë¡œê·¸ë¨ê³¼ ë™ì¼</small>
        </div>
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-bordered table-hover mb-0" style="font-size: 0.85rem;">
                    <thead class="table-danger">
                        <tr>
                            <th class="text-center align-middle">ì‹ ì²´ë¶€ìœ„</th>
                            <th class="text-center">í†µì¦í˜¸ì†Œì</th>
                            <th class="text-center">ì•½í•œ í†µì¦</th>
                            <th class="text-center">ì¤‘ê°„ í†µì¦</th>
                            <th class="text-center">ì‹¬í•œ í†µì¦</th>
                            <th class="text-center">ë§¤ìš° ì‹¬í•œ í†µì¦</th>
                            <th class="text-center bg-warning">ê´€ë¦¬ëŒ€ìƒì</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for part, stats in body_part_stats.items() %}
                        <tr>
                            <td class="fw-bold">{{ part }}</td>
                            <td class="text-center">{{ stats['í†µì¦í˜¸ì†Œì'] }}</td>
                            <td class="text-center text-success">{{ stats['ì•½í•œí†µì¦'] }}</td>
                            <td class="text-center text-warning">{{ stats['ì¤‘ê°„í†µì¦'] }}</td>
                            <td class="text-center text-danger">{{ stats['ì‹¬í•œí†µì¦'] }}</td>
                            <td class="text-center text-danger fw-bold">{{ stats['ë§¤ìš°ì‹¬í•œí†µì¦'] }}</td>
                            <td class="text-center bg-warning-subtle">
                                <span class="{% if stats['ê´€ë¦¬ëŒ€ìƒì'] > 0 %}text-danger fw-bold{% endif %}">
                                    {{ stats['ê´€ë¦¬ëŒ€ìƒì'] }}
                                </span>
                            </td>
                        </tr>
                        {% endfor %}
                        <!-- ì „ì²´ í•©ê³„ -->
                        <tr class="table-secondary fw-bold">
                            <td>ì „ì²´ í•©ê³„</td>
                            <td class="text-center">{{ body_part_stats.values()|sum(attribute='í†µì¦í˜¸ì†Œì') }}</td>
                            <td class="text-center text-success">{{ body_part_stats.values()|sum(attribute='ì•½í•œí†µì¦') }}</td>
                            <td class="text-center text-warning">{{ body_part_stats.values()|sum(attribute='ì¤‘ê°„í†µì¦') }}</td>
                            <td class="text-center text-danger">{{ body_part_stats.values()|sum(attribute='ì‹¬í•œí†µì¦') }}</td>
                            <td class="text-center text-danger">{{ body_part_stats.values()|sum(attribute='ë§¤ìš°ì‹¬í•œí†µì¦') }}</td>
                            <td class="text-center bg-warning text-danger">{{ body_part_stats.values()|sum(attribute='ê´€ë¦¬ëŒ€ìƒì') }}</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- 4. ì‘ì—…ì˜ ìœ¡ì²´ì  ë¶€ë‹´ ì •ë„ ë¶„í¬ -->
    <div class="card mb-4">
        <div class="card-header bg-info text-white">
            <h5 class="mb-0">ğŸ’ª ì‘ì—…ì˜ ìœ¡ì²´ì  ë¶€ë‹´ ì •ë„ ë¶„í¬</h5>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-8">
                    <div class="table-responsive">
                        <table class="table table-bordered">
                            <thead class="table-info">
                                <tr>
                                    <th class="text-center">ë¶€ë‹´ ì •ë„</th>
                                    <th class="text-center">ì‘ë‹µì ìˆ˜</th>
                                    <th class="text-center">ë¹„ìœ¨(%)</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% set total_workload = workload_stats.values()|sum %}
                                {% for level, count in workload_stats.items() %}
                                <tr>
                                    <td>{{ level }}</td>
                                    <td class="text-center">{{ count }}</td>
                                    <td class="text-center">
                                        {{ ((count / total_workload * 100)|round(1) if total_workload > 0 else 0) }}%
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="alert alert-info">
                        <h6><i class="bi bi-info-circle"></i> ë¶„ì„ ê¸°ì¤€</h6>
                        <ul class="mb-0 small">
                            <li><strong>ê´€ë¦¬ëŒ€ìƒì íŒì •:</strong></li>
                            <li>â€¢ 1ì£¼ì¼ ì´ìƒ ì§€ì† OR (1ë‹¬ 1íšŒ ì´ìƒ + ì¤‘ê°„í†µì¦)</li>
                            <li>â€¢ 1ì£¼ì¼ ì´ìƒ ì§€ì† AND 1ë‹¬ 1íšŒ ì´ìƒ AND ì‹¬í•œí†µì¦</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 5. í†µê³„ ìš”ì•½ ì •ë³´ -->
    <div class="card">
        <div class="card-header bg-secondary text-white">
            <h5 class="mb-0">ğŸ“‹ ë¶„ì„ ê²°ê³¼ ìš”ì•½</h5>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-6">
                    <h6><i class="bi bi-people"></i> ì¡°ì‚¬ ê°œìš”</h6>
                    <ul class="list-unstyled">
                        <li>â€¢ ì´ ì‘ë‹µì: <strong>{{ total_surveys }}ëª…</strong></li>
                        <li>â€¢ ê·¼ê³¨ê²©ê³„ ì„¤ë¬¸: <strong>{{ musculo_surveys }}ëª…</strong></li>
                        <li>â€¢ ì‹ ê·œì…ì‚¬ì ì„¤ë¬¸: <strong>{{ newbie_surveys }}ëª…</strong></li>
                        <li>â€¢ ë¶€ì„œ ìˆ˜: <strong>{{ dept_stats|length }}ê°œ</strong></li>
                    </ul>
                </div>
                <div class="col-md-6">
                    <h6><i class="bi bi-exclamation-triangle"></i> ì£¼ìš” ë°œê²¬ì‚¬í•­</h6>
                    <ul class="list-unstyled">
                        <li>â€¢ í†µì¦í˜¸ì†Œì: <strong class="text-warning">{{ dept_stats.values()|sum(attribute='í†µì¦í˜¸ì†Œì') }}ëª…</strong></li>
                        <li>â€¢ ê´€ë¦¬ëŒ€ìƒì: <strong class="text-danger">{{ dept_stats.values()|sum(attribute='ê´€ë¦¬ëŒ€ìƒì') }}ëª…</strong></li>
                        <li>â€¢ ê´€ë¦¬ëŒ€ìƒì ë¹„ìœ¨: <strong class="text-danger">
                            {{ ((dept_stats.values()|sum(attribute='ê´€ë¦¬ëŒ€ìƒì') / total_surveys * 100)|round(1) if total_surveys > 0 else 0) }}%
                        </strong></li>
                    </ul>
                </div>
            </div>

            <hr>
            <div class="text-center">
                <small class="text-muted">
                    â€» ë³¸ í‰ê°€ ê²°ê³¼ëŠ” 'ì˜í•™ì  ê´€ë¦¬'ë‚˜ 'ë²•ë¥ ì  íŒë‹¨' ë“±ì˜ ê¸°ì¤€ ë° ê·¼ê±°ìë£Œë¡œ ì‚¬ìš©ë˜ê¸° í˜ë“¦ì„ ì•Œë ¤ë“œë¦½ë‹ˆë‹¤.<br>
                    â€» ã€Œê·¼ê³¨ê²©ê³„ë¶€ë‹´ì‘ì—… ìœ í•´ìš”ì¸ì¡°ì‚¬ ì§€ì¹¨ã€ ì–‘ì‹ì„ í™œìš©í•œ ë¶„ì„ ê²°ê³¼ì…ë‹ˆë‹¤.
                </small>
            </div>
        </div>
    </div>

    <!-- ë²„íŠ¼ ê·¸ë£¹ -->
    <div class="mt-4 text-center">
        <a href="{{ url_for('admin.survey') }}" class="btn btn-secondary">
            <i class="bi bi-arrow-left"></i> ì„¤ë¬¸ ëª©ë¡ìœ¼ë¡œ
        </a>
        <button onclick="window.print()" class="btn btn-primary">
            <i class="bi bi-printer"></i> ì¸ì‡„í•˜ê¸°
        </button>
        <a href="#" class="btn btn-success" onclick="exportToExcel()">
            <i class="bi bi-file-excel"></i> Excel ë‚´ë³´ë‚´ê¸°
        </a>
    </div>
</div>

<script>
function exportToExcel() {
    // ê°„ë‹¨í•œ Excel ë‚´ë³´ë‚´ê¸° ê¸°ëŠ¥ (ì¶”í›„ êµ¬í˜„ ê°€ëŠ¥)
    alert('Excel ë‚´ë³´ë‚´ê¸° ê¸°ëŠ¥ì€ ê°œë°œ ì˜ˆì •ì…ë‹ˆë‹¤.');
}

// ì¸ì‡„ì‹œ ë²„íŠ¼ ìˆ¨ê¹€
window.addEventListener('beforeprint', function() {
    document.querySelector('.mt-4.text-center').style.display = 'none';
});

window.addEventListener('afterprint', function() {
    document.querySelector('.mt-4.text-center').style.display = 'block';
});
</script>

<style>
/* ì¸ì‡„ìš© ìŠ¤íƒ€ì¼ */
@media print {
    .btn, .mt-4.text-center {
        display: none !important;
    }

    .container-fluid {
        max-width: none !important;
        padding: 0 !important;
    }

    .card {
        border: 1px solid #000 !important;
        box-shadow: none !important;
    }

    .table-bordered {
        border: 1px solid #000 !important;
    }

    .table-bordered th,
    .table-bordered td {
        border: 1px solid #000 !important;
    }
}
</style>
{% endblock %}